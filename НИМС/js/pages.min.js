/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.-tab ';
    const state = {};

    exports.init = () => {
        //exports.content = queryEl(root);
    };

    exports.refresh = () => {

    };
})(this.Template = {});

/*Copyright 2015-2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};

    state.entities = ['characters', 'stories', 'groups', 'players'];

    const root = '.organizer-management-tab ';

    let removePermission, assignPermission;

    exports.init = () => {
        const createUserDialog = UI.createModalDialog(root, createUser, {
            bodySelector: 'create-organizer-body',
            dialogTitle: 'admins-creating-user',
            actionButtonTitle: 'common-create',
        });
        listen(qe(`${root}.create.user`), 'click', () => createUserDialog.showDlg());
        
        const changePasswordDialog = UI.createModalDialog(root, changePassword, {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'admins-enter-new-password',
            actionButtonTitle: 'common-replace',
        });
        listen(qe(`${root}.user.change-password`), 'click', () => {
            qee(changePasswordDialog, '.entity-input').value = '';
            changePasswordDialog.showDlg();
        });
        
        listen(queryEl(`${root}.remove-user-button`), 'click', removeOrganizer);

        listen(queryEl(`${root}.assign-permission-button`), 'click', assignPermission);
        listen(queryEl(`${root}.remove-permission-button`), 'click', removePermission);
        listen(queryEl(`${root}.assign-admin-button`), 'click', assignNewAdmin);
        listen(queryEl(`${root}.remove-editor-button`), 'click', removeEditor);
        listen(queryEl(`${root}.assign-editor-button`), 'click', assignEditor);
        
        state.entities.forEach(type => {
            listen(queryEl(`${root} .entity-filter.${type}`), 'input', filterList(`.entity-list.${type}`));
        });

        queryElEls(queryEl(root), '.adaptationRights').map(listen(R.__, 'click', changeAdaptationRightsMode));
        
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        DBMS.getManagementInfo((err, managementInfo) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.isAdmin((err2, isAdmin) => {
                if (err2) { Utils.handleError(err2); return; }
                PermissionInformer.isEditor((err3, isEditor) => {
                    if (err3) { Utils.handleError(err3); return; }
                    PermissionInformer.getEntityNamesArray('character', false, (err4, characterNames) => {
                        if (err4) { Utils.handleError(err4); return; }
                        PermissionInformer.getEntityNamesArray('story', false, (err5, storyNames) => {
                            if (err5) { Utils.handleError(err5); return; }
                            PermissionInformer.getEntityNamesArray('group', false, (err6, groupNames) => {
                                if (err6) { Utils.handleError(err6); return; }
                                PermissionInformer.getEntityNamesArray('player', false, (err7, playerNames) => {
                                    if (err7) { Utils.handleError(err7); return; }
                                    const names = {
                                        characters: characterNames,
                                        groups: groupNames,
                                        stories: storyNames,
                                        players: playerNames,
                                    };
                                    if (!isAdmin && isEditor) {
                                        R.keys(names).forEach((entity) => {
                                            names[entity] = names[entity].filter(R.prop('isOwner'));
                                        });
                                    }
                                    rebuildInterface(names, managementInfo, isAdmin);
                                    Utils.enable(exports.content, 'adminOnly', isAdmin);
                                    Utils.enable(exports.content, 'editorOrAdmin', isAdmin || isEditor);
                                });
                            });
                        });
                    });
                });
            });
        });
    };

    function rebuildInterface(names, managementInfo, isAdmin) {
        const { usersInfo } = managementInfo;

        const userNames = Object.keys(usersInfo).sort(CommonUtils.charOrdA);

        const selectors = [];
        selectors.push(queryEl(`${root}.change-password-user-select`));
//        selectors.push(queryEl(`${root}.user-permission-select`));
//        selectors.push(queryEl(`${root}.assign-editor-select`));

        const data = arr2Select2(userNames)
        selectors.forEach((selector) => {
            clearEl(selector);
            $(selector).select2(data);
//            Utils.rebuildSelectorArr(selector, userNames);
        });
        
        Utils.rebuildSelectorArr(queryEl(`${root}.user-permission-select`), userNames);

        const clone = userNames.slice(0);
        clone.splice(userNames.indexOf(managementInfo.admin), 1);
//        let selector = queryEl(`${root}.assign-admin-select`);
//        Utils.rebuildSelectorArr(selector, clone);
        
//        const data = getSelect2Data(allGroupNames);
//        clearEl(queryEl(`${root}.save-entity-select`));
//        $(`${root}.save-entity-select`).select2(data);

//        selector = queryEl(`${root}.remove-user-select`);
//        Utils.rebuildSelectorArr(selector, clone);

        state.entities.forEach((entity) => {
            Utils.rebuildSelector(queryEl(`${root}.permission-selector__${entity}`), names[entity]);
        });

        addEl(clearEl(queryEl(`${root}.current-admin-label`)), makeText(managementInfo.admin));

        const span = clearEl(queryEl(`${root}.current-editor-label`));
        if (managementInfo.editor) {
            addEl(span, makeText(managementInfo.editor));
        }

        getEl(`adaptationRights${managementInfo.adaptationRights}`).checked = true;

        state.entities.forEach((entity) => {
//            Utils.rebuildSelector(queryEl(`${root}.permission-selector__${entity}`), names[entity]);
            addEls(
                clearEl(queryEl(`${root} .entity-list.${entity}`)),
                names[entity].map(entity2el(isAdmin, entity))
            );
        });
        
        addEls(
            clearEl(queryEl(`${root} .entity-list.users`)),
            userNames.map(user2el)
        );
        buildPermissionList(names, usersInfo);
    }
    
    const entity2el = R.curry((isAdmin, type, name) => {
        const el = qmte(`.profile-item-tmpl`);
        el.profileName = name.value;
        addEl(qee(el, '.primary-name'), makeText(name.displayName));
        const btn = qee(el, '[role=button]');
        setAttr(btn, 'profile-name', name.value);
        setAttr(btn, 'primary-name', name.displayName);
        setAttr(btn, 'button-type', 'entity');
        setAttr(btn, 'profile-type', type);
        if(name.isOwner || isAdmin){
            listen(btn, 'dragstart', onDragStart);
            listen(btn, 'drop', onDrop);
            listen(btn, 'dragover', allowDrop);
            listen(btn, 'dragenter', handleDragEnter);
            listen(btn, 'dragleave', handleDragLeave);
            listen(btn, 'click', e => toggleClass(btn, 'btn-primary'));
        } else {
            Utils.enableEl(btn, false);
        }
        return el;
    });
    
    const user2el = R.curry((name) => {
        const el = wrapEl('div', qte(`.profile-item-tmpl`));
//        el.profileName = name.value;
        addEl(qee(el, '.primary-name'), makeText(name));
        setAttr(el, 'profile-name', name);
        setAttr(el, 'button-type', 'user');
//        setAttr(el, 'primary-name', name.displayName);
//        setAttr(el, 'profile-type', type);
        listen(el, 'dragstart', onDragStart);
        listen(el, 'drop', onDrop);
        listen(el, 'dragover', allowDrop);
        listen(el, 'dragenter', handleDragEnter);
        listen(el, 'dragleave', handleDragLeave);
        return el;
    });

    // eslint-disable-next-line no-var,vars-on-top
    var onDragStart = function(event) {
        if(getAttr(this, 'button-type') === 'entity'){
            addClass(this, 'btn-primary');
        }
        console.log(`onDragStart ${this.profileName}`);
        event.dataTransfer.setData('data', JSON.stringify({
            name: getAttr(this, 'profile-name'),
            type: getAttr(this, 'profile-type'),
            buttonType: getAttr(this, 'button-type'),
        }));
        event.dataTransfer.effectAllowed = 'move';
    };

    // eslint-disable-next-line no-var,vars-on-top
    var onDrop = function(event) {
        removeClass(this, 'over');
        console.log(`onDrop ${this.profileName}${event.dataTransfer.getData('data')}`);
        if (event.stopPropagation) {
            event.stopPropagation(); // stops the browser from redirecting.
        }
        const thatData = JSON.parse(event.dataTransfer.getData('data'));
        if (thatData.type === getAttr(this, 'profile-type')) {
            return;
        }
        const type1 = getAttr(this, 'button-type');
        const type2 = thatData.buttonType;
        
        if(type1 !== type2){
            const userName = type1 === 'user' ? getAttr(this, 'profile-name') : thatData.name;
//            const entityBtn =  type1 === 'user' ? 
            
//            console.log(user);
            const btns = qes(`${root} .rights-panel .btn-primary[role=button]`);
            const selected = btns.map( btn => ({
                type: getAttr(btn, 'profile-type'),
                name: getAttr(btn, 'profile-name'),
            }));
            const names = R.mapObjIndexed(arr => arr.map(R.prop('name')), R.groupBy(R.prop('type'), selected));
            btns.forEach(btn => removeClass(btn, 'btn-primary'))
            
            DBMS['assignPermission'](userName, names, Utils.processError(exports.refresh));
//            DBMS[action](userName, names, Utils.processError(exports.refresh));
//        };
//    }
//
//    removePermission = permissionAction('removePermission');
//    assignPermission = permissionAction('assignPermission');
        }

//        createBinding([thatData, {
//            name: getAttr(this, 'profile-name'),
//            type: getAttr(this, 'profile-type'),
//        }]);
    };

    // eslint-disable-next-line no-var,vars-on-top
    var allowDrop = function(event) {
        console.log(`allowDrop ${this.profileName}`);
        event.preventDefault();
    };

    function handleDragEnter(event) {
        addClass(this, 'over');
    }

    function handleDragLeave(event) {
        removeClass(this, 'over');
    }

    function buildPermissionList(names, usersInfo) {
        const permissionTable = clearEl(queryEl(`${root}.permission-table`));
        const treeRoot = makeEl('ul');
        addEl(permissionTable, treeRoot);

        R.keys(names).forEach((entity) => {
            names[entity] = names[entity].map(R.prop('value'));
        });

        R.values(usersInfo).forEach((userInfo) => {
            R.keys(userInfo).forEach((entity) => {
                names[entity] = R.difference(names[entity], userInfo[entity]);
            });
        });

        usersInfo[getL10n('admins-have-not-owner')] = names;

        const headers = {
            characters: getL10n('admins-characters'),
            stories: getL10n('admins-stories'),
            groups: getL10n('admins-groups'),
            players: getL10n('admins-players'),
        };

        function liMaker(text) {
            return addEl(makeEl('li'), makeText(text));
        }

        function makeEntityLists(userInfo) {
            return state.entities.reduce((result, entity) => {
                result.push(liMaker(headers[entity]));
                result.push(addEls(makeEl('ol'), userInfo[entity].sort(CommonUtils.charOrdA).map(liMaker)));
                return result;
            }, []);
        }

        const userNames = Object.keys(usersInfo).sort(CommonUtils.charOrdA);
        addEls(treeRoot, userNames.reduce((result, userName) => {
            result.push(liMaker(userName));
            result.push(addEls(makeEl('ol'), makeEntityLists(usersInfo[userName])));
            return result;
        }, []));
    }

    function createUser(dialog) {
        return () => {
            const userNameInput = qee(dialog,`.create-user-name-input`);
            const userPasswordInput = qee(dialog,`.create-user-password-input`);
            DBMS.createOrganizer(userNameInput.value.trim(), userPasswordInput.value, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    userNameInput.value = '';
                    userPasswordInput.value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }
    
    function changePassword(dialog) {
        return () => {
            const toInput = qee(dialog, '.entity-input');
            const newPassword = toInput.value;
            const userName = queryEl(`${root}.change-password-user-select`).value.trim();
            DBMS.changeOrganizerPassword(userName, newPassword, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }


    function changeOrganizerPassword() {
        const userName = queryEl(`${root}.change-password-user-select`).value.trim();
        const passwordInput = queryEl(`${root}.change-password-password-input`);
        DBMS.changeOrganizerPassword(userName, passwordInput.value, Utils.processError(() => {
            queryEl(`${root}.change-password-password-input`).value = '';
            exports.refresh();
        }));
    }

    function removeOrganizer() {
//        const name = queryEl(`${root}.remove-user-select`).value.trim();
        const name = queryEl(`${root}.change-password-user-select`).value.trim();
        Utils.confirm(strFormat(getL10n('admins-confirm-user-remove'), [name]), () => {
            DBMS.removeOrganizer(name, Utils.processError(exports.refresh));
        });
    }

    const getSelectedOptions = sel => nl2array(queryEl(sel).selectedOptions).map(opt => opt.value);

    function permissionAction(action) {
        return () => {
            const userName = queryEl(`${root}.user-permission-select`).value.trim();

            // TODO remove this check
            if (userName === '') {
                Utils.alert(getL10n('admins-user-is-not-selected'));
                return;
            }

            const names = {};
            state.entities.forEach((entity) => {
                names[entity] = getSelectedOptions(`${root}.permission-selector__${entity}`);
            });

            DBMS[action](userName, names, Utils.processError(exports.refresh));
        };
    }

    removePermission = permissionAction('removePermission');
    assignPermission = permissionAction('assignPermission');

    function assignNewAdmin() {
        const userName = queryEl(`${root}.change-password-user-select`).value.trim();
        Utils.confirm(strFormat(getL10n('admins-confirm-admin-assignment'), [userName]), () => {
            DBMS.assignAdmin(userName, Utils.processError(exports.refresh));
        });
    }
    function removeEditor() {
        DBMS.removeEditor(Utils.processError(exports.refresh));
    }
    function assignEditor() {
        const userName = queryEl(`${root}.change-password-user-select`).value.trim();
        Utils.confirm(strFormat(getL10n('admins-confirm-editor-assignment'), [userName]), () => {
            DBMS.assignEditor(userName, Utils.processError(exports.refresh));
        });
    }
    function changeAdaptationRightsMode(event) {
        DBMS.changeAdaptationRightsMode(event.target.value, Utils.processError());
    }
    
    // eslint-disable-next-line no-var,vars-on-top
    var filterList = sel => (event) => {
        const str = event.target.value.toLowerCase();

        const els = queryEls(`${root} ${sel} [primary-name]`);
        els.forEach((el) => {
            const isVisible = getAttr(el, 'primary-name').toLowerCase().indexOf(str) !== -1;
            hideEl(el, !isVisible);
        });
    };
})(this.OrganizerManagement = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};

    const root = '.player-management-tab ';

    exports.init = () => {
        const createUserDialog = UI.createModalDialog(root, createUser, {
            bodySelector: 'create-organizer-body',
            dialogTitle: 'admins-creating-player',
            actionButtonTitle: 'common-create',
        });
        listen(qe(`${root}.create.player`), 'click', () => createUserDialog.showDlg());
        
        const createPlayerAccountDialog = UI.createModalDialog(root, createUserAccount, {
            bodySelector: 'create-player-account-body',
            dialogTitle: 'admins-creating-player-account',
            actionButtonTitle: 'common-create',
        });
        listen(qe(`${root}.create.player-account`), 'click', () => createPlayerAccountDialog.showDlg());
        
        const changePasswordDialog = UI.createModalDialog(root, changePassword, {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'admins-enter-new-password',
            actionButtonTitle: 'common-replace',
        });
        listen(qe(`${root}.user.change-password`), 'click', () => {
            qee(changePasswordDialog, '.entity-input').value = '';
            changePasswordDialog.showDlg();
        });
        
        
//        listen(queryEl(`${root}.create-user-button`), 'click', createUser);
//        listen(queryEl(`${root}.create-login-button`), 'click', createLogin);
//        listen(queryEl(`${root}.change-password-button`), 'click', changePassword);
        listen(queryEl(`${root}.remove-user-button`), 'click', removeUser);
        listen(queryEl(`${root}.welcome-text-area`), 'change', setWelcomeText);
        queryElEls(queryEl(root), '.playerOptions').map(listen(R.__, 'change', setPlayerOption));
        
        $(`${root}.change-password-user-select`).select2().on('change', (event) => {
            const player = event.target.value;
            const yourPlayers = state.playerNames.filter(R.prop('isOwner')).map(R.prop('value'));
            const isPlayerEditable = R.contains(player, yourPlayers);
            Utils.enableEl(qe(`${root}.user.change-password`), isPlayerEditable);
            Utils.enableEl(qe(`${root}.remove-user-button`), isPlayerEditable);
        });


        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        PermissionInformer.getEntityNamesArray('player', false, (err, playerNames) => {
            if (err) { Utils.handleError(err); return; }
            DBMS.getPlayerLoginsArray((err2, playerLogins) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getWelcomeText((err3, text) => {
                    if (err3) { Utils.handleError(err3); return; }
                    DBMS.getPlayersOptions((err4, playersOptions) => {
                        if (err4) { Utils.handleError(err4); return; }
                        PermissionInformer.isAdmin((err5, isAdmin) => {
                            if (err5) { Utils.handleError(err5); return; }
                            // eslint-disable-next-line prefer-destructuring
                            R.toPairs(playersOptions).map(pair => (getEl(pair[0]).checked = pair[1]));
    
                            queryEl(`${root}.welcome-text-area`).value = text;
                            const playerHasLogin = R.compose(R.contains(R.__, playerLogins), R.prop('value'));
                            const hasLoginObj = R.groupBy(playerHasLogin, playerNames);
                            
                            state.playerNames = playerNames;
                            
                            const noAccounts = (hasLoginObj.false || []);
                            noAccounts.sort(Utils.charOrdAObject);
                            $(clearEl(queryEl(`${root}.create-login-name-select`))).select2(getSelect2Data(noAccounts));
    //                        fillSelector(clearEl(queryEl(`${root}.create-login-name-select`)), (hasLoginObj.false || [])
    //                            .sort(Utils.charOrdAObject).map(remapProps4Select));
                            const hasAccounts = (hasLoginObj.true || []);
//                            hasAccounts.sort(Utils.charOrdAObject);
                            $(clearEl(queryEl(`${root}.change-password-user-select`))).select2(getSelect2Data(hasAccounts));
                            
                            Utils.enable(exports.content, 'adminOnly', isAdmin);
                            
                            Utils.enableEl(qe(`${root}.change-password-user-select`), hasAccounts.length > 0);
                            Utils.enableEl(qe(`${root}.user.change-password`), hasAccounts.length > 0);
                            Utils.enableEl(qe(`${root}.remove-user-button`), hasAccounts.length > 0);
    //                        fillSelector(clearEl(queryEl(`${root}.change-password-user-select`)), (hasLoginObj.true || [])
    //                            .sort(Utils.charOrdAObject).map(remapProps4Select));
    //                        fillSelector(clearEl(queryEl(`${root}.remove-user-select`)), (hasLoginObj.true || [])
//                            .sort(Utils.charOrdAObject).map(remapProps4Select));
                        });
                    });
                });
            });
        });
    };

    function createUser(dialog) {
        return () => {
            const userNameInput = qee(dialog,`.create-user-name-input`);
            const userPasswordInput = qee(dialog,`.create-user-password-input`);
            DBMS.createPlayer(userNameInput.value.trim(), userPasswordInput.value, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    PermissionInformer.refresh((err2) => {
                        if (err2) { Utils.handleError(err2); return; }
                        userNameInput.value = '';
                        userPasswordInput.value = '';
                        dialog.hideDlg();
                        exports.refresh();
                    });
                }
            });
        };
    }
    
    function createUserAccount(dialog) {
        return () => {
            const userNameSelect = qee(dialog,`.create-login-name-select`);
            const passwordInput = qee(dialog,`.create-login-password-input`);
            DBMS.createPlayerLogin(userNameSelect.value, passwordInput.value, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    passwordInput.value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function createLogin() {
        const userNameSelect = queryEl(`${root}.create-login-name-select`);
        const passwordInput = queryEl(`${root}.create-login-password-input`);
        DBMS.createPlayerLogin(userNameSelect.value, passwordInput.value, Utils.processError(() => {
            passwordInput.value = '';
            exports.refresh();
        }));
    }

//    function changePassword() {
//        const userNameSelect = queryEl(`${root}.change-password-user-select`);
//        const passwordInput = queryEl(`${root}.change-password-password-input`);
//        DBMS.changePlayerPassword(userNameSelect.value, passwordInput.value, Utils.processError(() => {
//            passwordInput.value = '';
//            exports.refresh();
//        }));
//    }
    
    function changePassword(dialog) {
        return () => {
            const toInput = qee(dialog, '.entity-input');
            const newPassword = toInput.value;
            const userName = queryEl(`${root}.change-password-user-select`).value.trim();
            DBMS.changePlayerPassword(userName, newPassword, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function removeUser() {
        const name = queryEl(`${root}.change-password-user-select`).value.trim();
        Utils.confirm(strFormat(getL10n('admins-confirm-user-account-remove'), [name]), () => {
            DBMS.removePlayerLogin(name, Utils.processError(exports.refresh));
        });
//        const userNameSelect = queryEl(`${root}.change-password-user-select`);
//        DBMS.removePlayerLogin(userNameSelect.value, Utils.processError(exports.refresh));
    }

    function setWelcomeText(event) {
        DBMS.setWelcomeText(event.target.value, Utils.processError());
    }

    function setPlayerOption(event) {
        DBMS.setPlayerOption(event.target.value, event.target.checked, Utils.processError());
    }
})(this.PlayerManagement = {});

/*Copyright 2015, 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */


'use strict';

((exports) => {
    const root = '.adaptations-tab ';

    exports.init = () => {
        listen(getEl('events-storySelector'), 'change', updateAdaptationSelectorDelegate);
        listen(getEl('events-characterSelector'), 'change', showPersonalStoriesByCharacters);
        listen(getEl('events-eventSelector'), 'change', showPersonalStoriesByEvents);
        listen(getEl('finishedStoryCheckbox'), 'change', exports.refresh);
        queryEls('.adaptations-tab input[name=adaptationFilter]').map(listen(R.__, 'change', updateFilter));
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        const selector = clearEl(getEl('events-storySelector'));
        clearEl(getEl('events-characterSelector'));
        clearEl(getEl('events-eventSelector'));
        clearEl(getEl('personalStories'));

        PermissionInformer.getEntityNamesArray('story', false, (err, allStoryNames) => {
            if (err) { Utils.handleError(err); return; }
            DBMS.getFilteredStoryNames(getEl('finishedStoryCheckbox').checked, (err2, storyNames) => {
                if (err2) { Utils.handleError(err2); return; }
                
                showEl(qe(`${root} .alert`), storyNames.length === 0);
                showEl(qe(`${root} .adaptations-content`), storyNames.length !== 0);
                
                if (storyNames.length <= 0) { return; }

                const selectedStoryName = getSelectedStoryName(storyNames);

                const filteredArr = R.indexBy(R.prop('storyName'), storyNames);
                
                const storyNames2 = allStoryNames.filter(story => R.contains(story.value, R.keys(filteredArr))).map( story => {
                    const elem = filteredArr[story.value];
                    elem.displayName = story.displayName;
                    elem.value = story.value;
                    return elem;
                });

                let option;
                storyNames2.forEach((storyName) => {
                    option = addEl(makeEl('option'), (makeText(storyName.displayName)));
                    addClass(option, getIconClass(storyName));
                    setProp(option, 'selected', storyName.value === selectedStoryName);
                    setProp(option, 'storyInfo', storyName.value);
                    addEl(selector, option);
                });
                setAttr(selector, 'size', Math.min(storyNames2.length, 10));
                showPersonalStories(selectedStoryName);
            });
        });
    };

    function updateAdaptationSelectorDelegate(event) {
        clearEl(getEl('personalStories'));
        const storyName = event.target.selectedOptions[0].storyInfo;
        updateSettings('storyName', storyName);
        updateSettings('characterNames', null);
        updateSettings('eventIndexes', null);
        showPersonalStories(storyName);
    }

    function updateAdaptationSelector(story, allCharacters) {
        const characterSelector = clearEl(getEl('events-characterSelector'));
        const eventSelector = clearEl(getEl('events-eventSelector'));

        let characterArray = getStoryCharacterCompleteness(story);
        let eventArray = getStoryEventCompleteness(story);

        const showOnlyUnfinishedStories = getEl('finishedStoryCheckbox').checked;
        if (showOnlyUnfinishedStories) {
            characterArray = characterArray.filter(elem => !elem.isFinished || elem.isEmpty);
            eventArray = eventArray.filter(elem => !elem.isFinished || elem.isEmpty);
        }

        const characterNames = getCharacterNames(characterArray);
        const eventIndexes = getEventIndexes(eventArray);

        const map = CommonUtils.arr2map(allCharacters, 'value');

        characterArray.forEach((elem) => {
            elem.displayName = map[elem.characterName].displayName;
            elem.value = map[elem.characterName].value;
        });

        characterArray.sort(Utils.charOrdAObject);

        let option;
        characterArray.forEach((elem) => {
            option = addEl(makeEl('option'), (makeText(elem.displayName)));
            addClass(option, getIconClass(elem));
            setProp(option, 'selected', characterNames.indexOf(elem.value) !== -1);
            setProp(option, 'storyInfo', story.name);
            setProp(option, 'characterName', elem.value);
            addEl(characterSelector, option);
        });
        setAttr(characterSelector, 'size', characterArray.length);

        eventArray.forEach((elem) => {
            option = addEl(makeEl('option'), (makeText(elem.name)));
            addClass(option, getIconClass(elem));
            setProp(option, 'selected', eventIndexes.indexOf(elem.index) !== -1);
            setProp(option, 'storyInfo', story.name);
            setProp(option, 'eventIndex222', elem.index);
            addEl(eventSelector, option);
        });
        setAttr(eventSelector, 'size', eventArray.length);

        const { selectedFilter } = DBMS.getSettings().Adaptations;
        getEl(selectedFilter).checked = true;
        updateFilter({
            target: {
                id: selectedFilter
            }
        });
    }

    function updateFilter(event) {
        updateSettings('selectedFilter', event.target.id);
        const byCharacter = event.target.id === 'adaptationFilterByCharacter';
        hideEl(getEl('events-characterSelectorDiv'), !byCharacter);
        hideEl(getEl('events-eventSelectorDiv'), byCharacter);
        if (byCharacter) {
            showPersonalStoriesByCharacters();
        } else {
            showPersonalStoriesByEvents();
        }
    }

    function showPersonalStoriesByCharacters() {
        const eventRows = queryElEls(exports.content, '.eventRow-dependent');
        eventRows.map(removeClass(R.__, 'hidden'));
        nl2array(queryElEls(exports.content, 'div[dependent-on-character]')).map(addClass(R.__, 'hidden'));

        const characterNames = nl2array(getEl('events-characterSelector').selectedOptions).map(opt => opt.characterName);
        characterNames.forEach(name => queryElEls(exports.content, `div[dependent-on-character="${name}"]`).map(removeClass(R.__, 'hidden')));
        eventRows.map(row => hideEl(row, R.intersection(row.dependsOnCharacters, characterNames).length === 0));
        
        updateSettings('characterNames', characterNames);
    }

    function showPersonalStoriesByEvents() {
        queryElEls(exports.content, 'div[dependent-on-character]').map(removeClass(R.__, 'hidden'));
        queryElEls(exports.content, '.eventRow-dependent').map(addClass(R.__, 'hidden'));

        const eventIndexes = nl2array(getEl('events-eventSelector').selectedOptions).map(opt => opt.eventIndex222);
        eventIndexes.forEach(index => removeClass(getEls(`${index}-dependent`)[0], 'hidden'));
        updateSettings('eventIndexes', eventIndexes);
    }

    function getStoryCharacterCompleteness(story) {
        return R.keys(story.characters).map(elem => ({
            characterName: elem,
            isFinished: _isStoryFinishedForCharacter(story, elem),
            isEmpty: _isStoryEmptyForCharacter(story, elem)
        }));
    }

    function _isStoryEmptyForCharacter(story, characterName) {
        return story.events.every(event => event.characters[characterName] === undefined);
    }

    function _isStoryFinishedForCharacter(story, characterName) {
        return story.events.filter(event => event.characters[characterName] !== undefined)
            .every(event => event.characters[characterName].ready === true);
    }

    function getStoryEventCompleteness(story) {
        return story.events.map((event, i) => ({
            name: event.name,
            index: i,
            isFinished: _isEventReady(event),
            isEmpty: Object.keys(event.characters).length === 0
        }));
    }

    function _isEventReady(event) {
        return R.values(event.characters).every(character => character.ready);
    }

    function showPersonalStories(storyName) {
        DBMS.getMetaInfo((err, metaInfo) => {
            if (err) { Utils.handleError(err); return; }
            DBMS.getStory(storyName, (err2, story) => {
                if (err2) { Utils.handleError(err2); return; }
                PermissionInformer.isEntityEditable('story', storyName, (err3, isStoryEditable) => {
                    if (err3) { Utils.handleError(err3); return; }
                    PermissionInformer.getEntityNamesArray('character', false, (err4, allCharacters) => {
                        if (err4) { Utils.handleError(err4); return; }

                        const characterNames = R.keys(story.characters);
                        const adaptations = characterNames.map(characterName => ({
                            characterName,
                            storyName
                        }));
                        PermissionInformer.areAdaptationsEditable(adaptations, (err5, areAdaptationsEditable) => {
                            if (err5) { Utils.handleError(err5); return; }
                            story.events.forEach((item, i) => (item.index = i));
                            buildAdaptationInterface(
                                storyName, characterNames, story.events, areAdaptationsEditable,
                                metaInfo
                            );
                            updateAdaptationSelector(story, allCharacters);
                            Utils.enable(exports.content, 'isStoryEditable', isStoryEditable);
                            Utils.enable(exports.content, 'notEditable', false);
                        });
                    });
                });
            });
        });
    }

    function buildAdaptationInterface(storyName, characterNames, events, areAdaptationsEditable, metaInfo) {
        const div = clearEl(getEl('personalStories'));
        if(events.length === 0) {
            const alert = qmte('.alert-block-tmpl');
            addEl(alert, makeText(L10n.get('advices', 'no-events-in-story')));
            addClass(alert, 'margin-bottom-8');
            addEl(div, alert);
        }
        if(characterNames.length === 0) {
            const alert = qmte('.alert-block-tmpl');
            addEl(alert, makeText(L10n.get('advices', 'no-characters-in-story')));
            addClass(alert, 'margin-bottom-8');
            addEl(div, alert);
        }
        const adaptationsNum = R.flatten(events.map(event => R.keys(event.characters))).length;
        if(adaptationsNum === 0) {
            const alert = qmte('.alert-block-tmpl');
            addEl(alert, makeText(L10n.get('advices', 'no-adaptations-in-story')));
            addClass(alert, 'margin-bottom-8');
            addEl(div, alert);
        }
        
        addEls(div, events.map((event) => {
            const row = qmte(`${root} .adaptation-row-tmpl`);
            addClass(row, `${event.index}-dependent`);
            row.dependsOnCharacters = R.keys(event.characters);
            addEl(qee(row, '.eventMainPanelRow-left'), exports.makeOriginCard(event, metaInfo, storyName, {

                showTimeInput: true,
                showTextInput: true,
                cardTitle: event.name
            }));
            addEls(qee(row, '.events-eventsContainer'), characterNames
                .filter(characterName => event.characters[characterName])
                .map((characterName) => {
                    const isEditable = areAdaptationsEditable[`${storyName}-${characterName}`];
                    return exports.makeAdaptationCard(isEditable, event, storyName, characterName, {
                        showFinishedButton: true,
                        showTimeInput: true,
                        showTextInput: true,
                        cardTitle: characterName
                    });
                }));

            return row;
        }));
    }

    exports.makeOriginCard = (event, metaInfo, storyName, opts) => {
        const card = qmte(`${root} .origin-tmpl`);
        addEl(qee(card, '.card-title'), makeText(opts.cardTitle));
        const textInput = qee(card, '.text-input');
        const timeInput = qee(card, '.time-input');
        const lockButton = qee(card, 'button.locked');

        if (opts.showTimeInput === true) {
            UI.makeEventTimePicker2(timeInput, {
                eventTime: event.time,
                index: event.index,
                preGameDate: metaInfo.preGameDate,
                date: metaInfo.date,
                onChangeDateTimeCreator: onChangeDateTimeCreator(storyName)
            });
        } else {
            addClass(timeInput, 'hidden');
        }

        if (opts.showTextInput === true) {
            textInput.value = event.text;
            textInput.dataKey = JSON.stringify([storyName, event.index]);
            listen(textInput, 'change', onChangeOriginText);
        } else {
            addClass(textInput, 'hidden');
        }

        if (opts.showLockButton === true) {
            listen(lockButton, 'click', onOriginLockClick(timeInput, textInput));
            Utils.enableEl(timeInput, false);
            Utils.enableEl(textInput, false);
            L10n.localizeStatic(card);
        } else {
            addClass(lockButton, 'hidden');
        }

        return card;
    };

    function onOriginLockClick(timeInput, textInput) {
        return (event) => {
            const { target } = event;
            const isLocked = hasClass(target, 'btn-primary');
            setClassByCondition(target, 'btn-primary', !isLocked);
            setClassByCondition(target, 'locked', !isLocked);
            setClassByCondition(target, 'unlocked', isLocked);
            Utils.enableEl(timeInput, isLocked);
            Utils.enableEl(textInput, isLocked);
        };
    }

    exports.makeAdaptationCard = R.curry((isEditable, event, storyName, characterName, opts) => {
        const card = qmte(`${root} .adaptation-tmpl`);
        setAttr(card, 'dependent-on-character', characterName);

        addEl(qee(card, '.card-title'), makeText(opts.cardTitle));
        const textInput = qee(card, '.text-input');
        const timeInput = qee(card, '.time-input');
        const finishedButton = qee(card, 'button.finished');
        const id = JSON.stringify([storyName, event.index, characterName]);

        if (opts.showTimeInput === true) {
            UI.populateAdaptationTimeInput(timeInput, storyName, event, characterName, isEditable);
        } else {
            addClass(timeInput, 'hidden');
        }

        if (opts.showTextInput === true) {
            setClassByCondition(textInput, 'notEditable', !isEditable);
            textInput.value = event.characters[characterName].text;
            textInput.dataKey = JSON.stringify([storyName, event.index, characterName]);
            listen(textInput, 'change', onChangeAdaptationText);
        } else {
            addClass(textInput, 'hidden');
        }

        if (opts.showFinishedButton === true) {
            const isFinished = event.characters[characterName].ready;
            setClassByCondition(finishedButton, 'notEditable', !isEditable);
            setClassIf(finishedButton, 'btn-primary', isFinished);
            finishedButton.id = id;
            const enableInputs = (value) => {
                Utils.enableEl(textInput, !value);
                Utils.enableEl(timeInput, !value);
            };
            enableInputs(isFinished);
            listen(finishedButton, 'click', UI.onChangeAdaptationReadyStatus2(enableInputs));
            L10n.localizeStatic(card);
        } else {
            addClass(finishedButton, 'hidden');
        }

        return card;
    });

    // eslint-disable-next-line no-var,vars-on-top
    var onChangeDateTimeCreator = R.curry((storyName, myInput) => (dp, input) => {
        DBMS.setEventOriginProperty(storyName, myInput.eventIndex, 'time', input.val(), Utils.processError());
        removeClass(myInput, 'defaultDate');
    });

    function onChangeOriginText(event) {
        const dataKey = JSON.parse(event.target.dataKey);
        const text = event.target.value;
        DBMS.setEventOriginProperty(dataKey[0], dataKey[1], 'text', text, Utils.processError());
    }

    function onChangeAdaptationText(event) {
        const dataKey = JSON.parse(event.target.dataKey);
        const text = event.target.value;
        DBMS.setEventAdaptationProperty(dataKey[0], dataKey[1], dataKey[2], 'text', text, Utils.processError());
    }

    function getIconClass(object) {
        if (object.isEmpty) return 'fa-icon empty select-icon-padding';
        if (object.isFinished) return 'fa-icon finished select-icon-padding';
        return 'fa-icon finished transparent-icon select-icon-padding';
    }

    function updateSettings(name, value) {
        const settings = DBMS.getSettings();
        settings.Adaptations[name] = value;
    }

    function getSelectedStoryName(storyNames) {
        const storyNamesOnly = storyNames.map(R.prop('storyName'));

        const settings = DBMS.getSettings();
        if (!settings.Adaptations) {
            settings.Adaptations = {
                storyName: storyNamesOnly[0],
                characterNames: null,
                eventIndexes: null,
                selectedFilter: 'adaptationFilterByCharacter'
            };
        }
        let { storyName } = settings.Adaptations;
        if (storyNamesOnly.indexOf(storyName) === -1) {
            // eslint-disable-next-line prefer-destructuring
            settings.Adaptations.storyName = storyNamesOnly[0];
            // eslint-disable-next-line prefer-destructuring
            storyName = storyNamesOnly[0];
        }
        return storyName;
    }

    function getNames(nameObjectArray, nameObjectProperty, settingsProperty) {
        const namesOnly = nameObjectArray.map(R.prop(nameObjectProperty));
        const names = DBMS.getSettings().Adaptations[settingsProperty];
        let existingNames;
        if (names === null) {
            existingNames = namesOnly;
        } else {
            existingNames = names.filter(name => namesOnly.indexOf(name) !== -1);
        }

        updateSettings(settingsProperty, existingNames);
        return existingNames;
    }

    function getCharacterNames(characterArray) {
        return getNames(characterArray, 'characterName', 'characterNames');
    }

    function getEventIndexes(eventArray) {
        return getNames(eventArray, 'index', 'eventIndexes');
    }
})(this.Adaptations = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const root = '.briefing-export-tab ';

    state.templates = {};
    state.customDocxTemplate = null;

    let generateSingleDocx, generateSingleTxt, refreshStorySetSelect, refreshCharacterSetSelect;

    exports.init = () => {
//        listen(getEl('makeDefaultTextBriefings'), 'click', () => {
//            resolveTextTemplate((textTemplate) => {
//                makeTextBriefings('txt', generateSingleTxt(textTemplate));
//            });
//        });

        listen(getEl('makeCustomTextBriefings'), 'click', () => {
            makeTextBriefings(getEl('textTypeSelector').value, generateSingleTxt(getEl('templateArea').value));
        });
        listen(getEl('makeMarkdownBriefings'), 'click', () => {
            makeTextBriefings('html', R.compose(data => markdownit('commonmark').render(data), generateSingleTxt(getEl('templateArea').value)));
        });

        listen(getEl('docxBriefings'), 'change', readTemplateFile);
        listen(getEl('docxBriefings'), 'focus', (e) => {
            e.target.value = '';
            state.customDocxTemplate = null;
        });

        listen(getEl('makeDocxBriefings'), 'click', () => {
            if (state.customDocxTemplate === null) {
                Utils.alert(getL10n('briefings-custom-docx-template-is-missing'));
            } else {
                exportDocxByTemplate(state.customDocxTemplate);
            }
        });


        let els = queryElEls(document, `${root} input[name=exportCharacterSelection]`);
        els.map(listen(R.__, 'change', onCharacterSelectionChange));
        getEl('exportAllCharacters').checked = true;

        els = queryElEls(document, `${root} input[name=exportStorySelection]`);
        els.map(listen(R.__, 'change', onStorySelectionChange));
        getEl('exportAllStories').checked = true;

        const el = getEl('briefingNumberSelector');
        Constants.briefingNumber.forEach(R.compose(addEl(el), makeOpt));
        listen(el, 'change', refreshCharacterRangeSelect);

        state.briefingNumberSelector = el;
        state.briefingIntervalSelector = getEl('briefingIntervalSelector');
        state.characterSetSelector = getEl('characterSetSelector');
        state.storySetSelector = getEl('storySetSelector');

        getEl('makeBriefingsByTime '.trim()).addEventListener('click', makeExport('templateByTime'));
        getEl('makeBriefingsByStory'.trim()).addEventListener('click', makeExport('templateByStory'));
        getEl('makeInventoryList   '.trim()).addEventListener('click', makeExport('inventoryTemplate'));

        UI.initTabPanel('exportModeButton', 'exportContainer');

        listen(getEl('previewTextOutput'), 'click', previewTextOutput);
        getEl('textBriefingPreviewArea').value = '';

        listen(getEl('showRawData'), 'click', previewTextDataAsIs);

        listen(getEl('convertToDocxTemplate'), 'click', convertToDocxTemplate);
        listen(getEl('generateByDocxTemplate'), 'click', generateByDocxTemplate);

        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        resolveTextTemplate((textTemplate) => {
            getEl('templateArea').value = textTemplate;
            refreshCharacterRangeSelect();
            refreshCharacterSetSelect();
            refreshStorySetSelect();
        });
    };

    function resolveTextTemplate(callback) {
        DBMS.getProfileStructure('character', (err, profileSettings) => {
            if (err) { Utils.handleError(err); return; }
            const func = R.compose(R.join(''), R.insert(1, R.__, ['{{profileInfo-', '}}\n']), R.prop('name'));
            const filter = R.compose(R.equals(true), R.prop('doExport'));
            const value = profileSettings.filter(filter).map(func).join('');

            callback(R.replace(/\{0\}/g, value, TEXT_TEMPLATE));
        });
    }

    function onCharacterSelectionChange(event) {
        const exportCharacterRange = event.target.id === 'exportCharacterRange';
        const exportCharacterSet = event.target.id === 'exportCharacterSet';
        hideEl(getEl('characterRangeSelect'), !exportCharacterRange);
        hideEl(getEl('characterSetSelect'), !exportCharacterSet);
    }

    function onStorySelectionChange(event) {
        const exportStorySet = event.target.id === 'exportStorySet';
        hideEl(getEl('storySetSelect'), !exportStorySet);
    }

    function getSelectedUsers() {
        const { id } = getSelectedRadio(qe(root), 'input[name=exportCharacterSelection]');
        switch (id) {
        case 'exportAllCharacters':
            return null;
        case 'exportCharacterRange':
            return JSON.parse(state.briefingIntervalSelector.selectedOptions[0].value);
        case 'exportCharacterSet':
            return nl2array(state.characterSetSelector.selectedOptions).map(opt => opt.value);
        default:
            Utils.alert(`unexpected id: ${id}`);
        }
        return null;
    }

    function getSelectedStories() {
        const { id } = getSelectedRadio(qe(root), 'input[name=exportStorySelection]');
        switch (id) {
        case 'exportAllStories':
            return null;
        case 'exportStorySet':
            return nl2array(state.storySetSelector.selectedOptions).map(opt => opt.value);
        default:
            Utils.alert(`unexpected id: ${id}`);
        }
        return null;
    }

    function refreshCharacterRangeSelect() {
        const selector = clearEl(state.briefingIntervalSelector);
        const num = Number(state.briefingNumberSelector.value);

        let chunks;
        PermissionInformer.getEntityNamesArray('character', false, (err, names) => {
            if (err) { Utils.handleError(err); return; }
            if (names.length > 0) {
                chunks = R.splitEvery(num, names);
                const data = chunks.map(chunk => ({
                    id: JSON.stringify(chunk.map(nameInfo => nameInfo.value)),
                    text: chunk.length === 1 ? chunk[0].displayName :
                        `${chunk[0].displayName} - ${chunk[chunk.length - 1].displayName}`
                }));

                $(`#${state.briefingIntervalSelector.id}`).select2({ data });
            }
        });
    }


    function refreshSetSelect(entityType, selectorName) {
        const multiSel = clearEl(state[selectorName]);
        PermissionInformer.getEntityNamesArray(entityType, false, (err, names) => {
            if (err) { Utils.handleError(err); return; }
            if (names.length > 0) {
                fillSelector(multiSel, names.map(remapProps4Select));
                setAttr(multiSel, 'size', names.length > 15 ? 15 : names.length);
            }
        });
    }

    refreshStorySetSelect = () => refreshSetSelect('story', 'storySetSelector');
    refreshCharacterSetSelect = () => refreshSetSelect('character', 'characterSetSelector');

    function makeExport(type) {
        return () => {
            if (!state.templates[type]) {
                state.templates[type] = atob(templatesArr[type]);
            }
            exportDocxByTemplate(state.templates[type]);
        };
    }

    function postprocessCheckboxes(briefingData, profileStructure, prefix, arrName) {
        const checkboxNames = profileStructure.filter(item => item.type === 'checkbox').map(R.prop('name'));
        briefingData.briefings.forEach((charData) => {
            if (charData[arrName] === undefined) return;
            charData[arrName].forEach((element) => {
                if (checkboxNames.indexOf(element.itemName) !== -1) {
                    element.value = constL10n(Constants[element.value]);
                    element.splittedText = [{ string: element.value }];
                }
            });
            checkboxNames.forEach((name) => {
                charData[prefix + name] = constL10n(Constants[charData[prefix + name]]);
            });
        });
    }

    function getBriefingData(callback) {
        DBMS.getBriefingData(getSelectedUsers(), getSelectedStories(), getEl('exportOnlyFinishedStories').checked, (err, briefingData) => {
            if (err) { Utils.handleError(err); return; }
            // some postprocessing
            DBMS.getProfileStructure('character', (err2, characterProfileStructure) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getProfileStructure('player', (err3, playerProfileStructure) => {
                    if (err3) { Utils.handleError(err3); return; }
                    postprocessCheckboxes(briefingData, characterProfileStructure, 'profileInfo-', 'profileInfoArray');
                    postprocessCheckboxes(briefingData, playerProfileStructure, 'playerInfo-', 'playerInfoArray');
                    callback(null, briefingData);
                });
            });
        });
    }

    function exportDocxByTemplate(template) {
        getBriefingData((err, briefingData) => {
            if (err) { Utils.handleError(err); return; }
            generateBriefings(briefingData, 'docx', generateSingleDocx('blob', template), generateSingleDocx('Uint8Array', template));
        });
    }

    function convertToDocxTemplate() {
        const docxTemplate = makeDocxTemplate('blob');
        Utils.confirm(getL10n('briefings-save-file'), () => {
            saveAs(docxTemplate, FileUtils.makeFileName('template', 'docx'));
        });
    }

    function generateByDocxTemplate() {
        exportDocxByTemplate(makeDocxTemplate('Uint8Array'));
    }

    function makeDocxTemplate(type) {
        let template = getEl('templateArea').value;

        const replaceBrackets = R.pipe(R.replace(/{{{/g, '{'), R.replace(/}}}/g, '}'), R.replace(/{{/g, '{'), R.replace(/}}/g, '}'));
        template = replaceBrackets(template).split('\n').map(string => ({ string }));

        if (!state.templates.genericTemplate) {
            state.templates.genericTemplate = atob(templatesArr.genericTemplate);
        }

        const doc = new window.Docxgen(state.templates.genericTemplate);
        doc.setData({
            splittedText: template
        });
        doc.render();
        return doc.getZip().generate({
            type
        });
    }
    function previewTextDataAsIs() {
        getBriefingData((err, briefingData) => {
            if (err) { Utils.handleError(err); return; }
            getEl('textBriefingPreviewArea').value = JSON.stringify(briefingData, null, '  ');
        });
    }

    function previewTextOutput() {
        getBriefingData((err, data) => {
            if (err) { Utils.handleError(err); return; }
            getEl('textBriefingPreviewArea').value = generateSingleTxt(getEl('templateArea').value, data);
        });
    }

    function makeTextBriefings(fileType, delegate) {
        getBriefingData((err, briefingData) => {
            if (err) { Utils.handleError(err); return; }
            generateBriefings(briefingData, fileType, (data) => {
                const result = delegate(data);
                return new Blob([result], {
                    type: 'text/plain;charset=utf-8'
                });
            }, delegate);
        });
    }

    function readTemplateFile(evt) {
        // Retrieve the first (and only!) File from the FileList object
        const f = evt.target.files[0];

        if (f) {
            const r = new FileReader();
            r.onload = (e) => {
                state.customDocxTemplate = e.target.result;
                Utils.alert(getL10n('briefings-template-is-loaded'));
            };
            r.readAsBinaryString(f);
        } else {
            Utils.alert(getL10n('briefings-error-on-template-uploading'));
        }
    }

    function updateStatus(text) {
        const exportStatus = getEl('exportStatus');
        clearEl(exportStatus);
        exportStatus.appendChild(makeText(text));
    }

    function generateBriefings(briefingData, fileType, oneFileDelegate, separateFileDelegate) {
        const toSeparateFiles = getEl('toSeparateFileCheckbox').checked;

        const fileName = 'characterSheets';

        let out, archive;
        updateStatus(getL10n('briefings-save-preparing'));
        try {
            if (toSeparateFiles) {
                const zip = new JSZip();
                const content = zip.generate();
                updateStatus(getL10n('briefings-start-saving'));

                const res = makeArchiveData(briefingData, separateFileDelegate);
                R.keys(res).forEach((key) => {
                    zip.file(`${key}.${fileType}`, res[key]);
                });

                updateStatus(getL10n('briefings-archiving'));
                archive = zip.generate({ type: 'blob' });
                updateStatus(getL10n('briefings-archive-is-ready'));
                saveFile('briefings-save-archive', archive, fileName, 'zip');
            } else {
                updateStatus(getL10n('briefings-start-saving'));
                out = oneFileDelegate(briefingData);
                updateStatus(getL10n('briefings-file-is-ready'));
                saveFile('briefings-save-file', out, fileName, fileType);
            }
        } catch (err) {
            Utils.alert(getL10n('briefings-error-on-generating-briefings'));
            console.log(err);
        }
    }

    function saveFile(msgKey, out, fileName, extension) {
        Utils.confirm(getL10n(msgKey), () => {
            saveAs(out, FileUtils.makeFileName(fileName, extension));
        });
    }

    function makeArchiveData(briefingData, generateSingleDelegate) {
        const res = {};
        briefingData.briefings.forEach((briefing, i) => {
            const name = briefing.charName + (briefing.playerName ? `_${briefing.playerName}` : '')
            res[name] = generateSingleDelegate({
                gameName: briefingData.gameName,
                briefings: [briefing]
            });
            updateStatus(strFormat(getL10n('briefings-save-status'), [i + 1, briefingData.briefings.length]));
        });
        return res;
    }

    generateSingleDocx = R.curry((type, template, data) => {
        const doc = new window.Docxgen(template);
        doc.setData(data);
        doc.render(); // apply them (replace all occurences of {first_name} by
        // Hipp, ...)
        const out = doc.getZip().generate({
            type
        });
        return out;
    });

    generateSingleTxt = R.curry((template, data) => {
        try {
            return Mustache.render(template, data);
        } catch (err) {
            Utils.alert(strFormat(getL10n('briefings-template-error'), [err.message]));
            throw err;
        }
    });
})(this.BriefingExport = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const root = '#briefingPreviewDiv ';
    const settingsPath = 'BriefingPreview';
    const l10n = L10n.get('briefings');

    exports.init = () => {
        $('#briefingCharacter').select2().on('change', buildContentDelegate);

        let button = getEl('eventGroupingByStoryRadio');
        listen(button, 'change', exports.refresh);
        button.checked = true;

        button = getEl('adaptationsModeRadio');
        listen(button, 'change', exports.refresh);
        button.checked = true;

        listen(getEl('eventGroupingByTimeRadio'), 'change', exports.refresh);
        listen(getEl('proofreadingModeRadio'), 'change', exports.refresh);
        listen(getEl('hideAllPanelsCheckbox'), 'change', exports.refresh);
        listen(getEl('disableHeadersCheckbox'), 'change', exports.refresh);

        getEl('hideAllPanelsCheckbox').checked = true;
        
//        listen(getEl('contentArea'), 'scroll', updateGutterScrollPos);
//        listen(getEl('contentArea'), 'resize', rebuildGutter);
        
        initPanelsArr();

        exports.content = getEl('briefingPreviewDiv');
    };
    
//    function updateGutterScrollPos (){
//        let doc = getEl('contentArea');
//        let position = qe(`${root} .gutter-scroll-position`);
//        position.style.top = (doc.scrollTop)/doc.scrollHeight*100 + '%';
//        position.style.height = (doc.clientHeight)/doc.scrollHeight*100 + '%';
//    }
//    
//    function rebuildGutter() {
//        let doc = getEl('contentArea');
//        const gutter = clearEl(qe(`${root} .gutter`));
//        const scrollPos = addClass(makeEl('div'), 'gutter-scroll-position');
//        addEl(gutter, scrollPos);
//        updateGutterScrollPos();
//        
//        const btn = makeEl('button');
//        btn.style.top = '0%';
////        const title = qee(panel, '.panel-title').innerHTML.trim();
//        setAttr(btn, 'title', l10n('to-page-top'));
//        listen(btn, 'click', () => {
//            doc.scrollTop = 0;
////            panel.scrollIntoView();
//        });
//        addEl(gutter, btn);
//        
//        const panels = qees(doc, '#briefingContent > .panel');
//        addEls(gutter, panels.map(panel => {
//            const btn = makeEl('button');
//            btn.style.top = (panel.offsetTop)/doc.scrollHeight*100 + '%';
//            
//            const panelTitle = qee(panel, '.panel-title');
//            const title = panelTitle.innerText || panelTitle.textContent;
//            setAttr(btn, 'title', title);
//            listen(btn, 'click', () => {
//                doc.scrollTop = panel.offsetTop - 40;
////                panel.scrollIntoView();
//            });
//            return btn;
//        }));
//        
//    }

    exports.refresh = () => {
        clearEl(getEl('briefingCharacter'));
        clearEl(getEl('briefingContent'));

        DBMS.getProfileStructure('character', (err, characterProfileStructure) => {
            if (err) { Utils.handleError(err); return; }
            DBMS.getProfileStructure('player', (err2, playerProfileStructure) => {
                if (err2) { Utils.handleError(err2); return; }
                state.characterProfileStructure = characterProfileStructure;
                state.playerProfileStructure = playerProfileStructure;
                PermissionInformer.getEntityNamesArray('character', false, (err3, names) => {
                    if (err3) { Utils.handleError(err3); return; }
                    
                    showEl(qe(`${root} .alert`), names.length === 0);
                    showEl(qe(`${root} > div > div > .panel`), names.length !== 0);
                    showEl(qe(`${root} #briefingCharacter`), names.length !== 0);
                    
                    if (names.length > 0) {
                        const characterName = UI.checkAndGetEntitySetting(settingsPath, names);
                        const data = getSelect2Data(names);
                        // this call trigger buildContent
                        $('#briefingCharacter').select2(data).val(characterName).trigger('change');
                    }
                });
            });
        });
    };

    function buildContentDelegate(event) {
        buildContent(event.target.value);
    }

    function buildContent(characterName) {
        UI.updateEntitySetting(settingsPath, characterName);
        const content = clearEl(getEl('briefingContent'));
        let index = 0;
        const data = {
            characterName
        };
        function buildContentInner() {
            if (index < state.panels.length) {
                index++;
                state.panels[index - 1].load(data, buildContentInner);
            } else {
                state.panels.map(R.prop('make')).forEach((make) => {
                    make(content, data);
                });
//                rebuildGutter();
            }
        }
        buildContentInner();
    }

    function getFlags() {
        return {
            isAdaptationsMode: getEl('adaptationsModeRadio').checked,
            isGroupingByStory: getEl('eventGroupingByStoryRadio').checked,
            disableHeaders: getEl('disableHeadersCheckbox').checked,
            hideAllPanels: getEl('hideAllPanelsCheckbox').checked
        };
    }

    function initPanelsArr(){
        state.panels = [{
            name: 'storyRights',
            load(data, callback) {
                PermissionInformer.getEntityNamesArray('story', true, (err, userStoryNames) => {
                    if (err) { Utils.handleError(err); return; }
                    data.userStoryNamesMap = R.indexBy(R.prop('value'), userStoryNames);
                    callback();
                });
            },
            make(el, data) {}
        }, {
            name: 'characterProfile',
            load(data, callback) {
                DBMS.getProfile('character', data.characterName, (err, profile) => {
                    if (err) { Utils.handleError(err); return; }
                    data.profile = profile;
                    callback();
                });
            },
            make(el, data) {
                const label = strFormat(getL10n('briefings-character-profile'), [data.characterName]);
                addEl(el, makePanel(
                    makeText(label),
                    UI.makeProfileTable(state.characterProfileStructure, data.profile), getFlags().hideAllPanels
                ));
            }
        }, {
            name: 'playerProfile',
            load(data, callback) {
                DBMS.getProfileBinding('character', data.characterName, (err, binding) => {
                    if (err) { Utils.handleError(err); return; }
                    if (binding[1] === '') {
                        callback();
                    } else {
                        DBMS.getProfile('player', binding[1], (err2, playerProfile) => {
                            if (err2) { Utils.handleError(err2); return; }
                            data.playerProfile = playerProfile;
                            // eslint-disable-next-line prefer-destructuring
                            data.playerName = binding[1];
                            callback();
                        });
                    }
                });
            },
            make(el, data) {
                if (data.playerProfile) {
                    const label = strFormat(getL10n('briefings-player-profile'), [data.playerName]);
                    addEl(el, makePanel(
                        makeText(label),
                        UI.makeProfileTable(state.playerProfileStructure, data.playerProfile), getFlags().hideAllPanels
                    ));
                }
            }
        }, {
            name: 'inventory',
            load(data, callback) {
                DBMS.getAllInventoryLists(data.characterName, (err, allInventoryLists) => {
                    if (err) { Utils.handleError(err); return; }
                    data.allInventoryLists = allInventoryLists.sort(CommonUtils.charOrdAFactory(R.compose(R.toLower, R.prop('storyName'))));
                    callback();
                });
            },
            make(el, data) {
                addEl(el, makePanel(
                        makeText(`${getL10n('briefings-inventory')} (${data.allInventoryLists.length})`),
                        makeInventoryContent(
                                data.allInventoryLists,
                                data.characterName, data.userStoryNamesMap
                        ), getFlags().hideAllPanels
                ));
            }
        }, {
            name: 'groups',
            load(data, callback) {
                DBMS.getCharacterGroupTexts(data.characterName, (err, groupTexts) => {
                    if (err) { Utils.handleError(err); return; }
                    data.groupTexts = groupTexts;
                    callback();
                });
            },
            make(el, data) {
                addEl(el, makePanel(
                        makeText(`${getL10n('header-groups')} (${data.groupTexts.length})`),
                        makeGroupContent(data.groupTexts), getFlags().hideAllPanels
                ));
            }
        }, {
            name: 'relations',
            load: Relations.load,
            make(el, data) {
                const label = `${getL10n('header-relations')} (${data.relationsSummary.relations.length})`;
                const content = RelationsPreview.makeRelationsContent(
                        data, getFlags().isAdaptationsMode,
                        state.characterProfileStructure, exports.refresh
                );
                addEl(el, makePanel(makeText(label), content, getFlags().hideAllPanels));
            }
        }, {
            name: 'stories',
            load(data, callback) {
                callback();
            },
            make(el, data) {
                const flags = getFlags();
                if (flags.isGroupingByStory) {
                    showEventsByStory(el, data.characterName, data.userStoryNamesMap, flags);
                } else {
                    showEventsByTime(el, data.characterName, data.userStoryNamesMap, flags);
                }
            }
        }];
    }

    function onBuildContentFinish() {
        UI.initTextAreas(`${root} #briefingContent textarea`);
        UI.refreshTextAreas(`${root} #briefingContent textarea`);
        Utils.enable(exports.content, 'notEditable', false);
    }


    function makePanel(title, content, hideAllPanels) {
        const panelInfo = UI.makePanelCore(title, content);
        UI.attachPanelToggler(panelInfo.a, panelInfo.contentDiv, (event, togglePanel) => {
            togglePanel();
//            rebuildGutter();
            UI.refreshTextAreas(`${root} #briefingContent textarea`);
        });
        if (hideAllPanels) {
            panelInfo.a.click();
        }
        return panelInfo.panel;
    }

    function makeGroupContent(groupTexts) {
        return addEls(makeEl('div'), groupTexts.map((groupText) => {
            const div = makeEl('div');
            addEl(div, addEl(makeEl('h4'), makeText(groupText.groupName)));
            const span = addEl(makeEl('textarea'), makeText(groupText.text));
            setAttr(span, 'disabled', 'disabled');
            addClasses(span, ['briefingTextSpan', 'form-control']);
            return addEl(div, span);
        }));
    }

    function makeInventoryContent(allInventoryLists, characterName, userStoryNamesMap) {
        const container = qmte('.profile-editor-container-tmpl');
        return addEls(container, allInventoryLists.map((elem) => {
            const input = makeEl('input');
            input.value = elem.inventory;
            input.storyName = elem.storyName;
            input.characterName = characterName;
            addClasses(input, ['inventoryInput', 'form-control']);
            if (!userStoryNamesMap[elem.storyName]) {
                addClass(input, 'notEditable');
            }
            listen(input, 'change', updateCharacterInventory);

            const row = qmte('.profile-editor-row-tmpl');
            addEl(qee(row, '.profile-item-name'), makeText(elem.storyName));
            addEl(qee(row, '.profile-item-input'), input);
            return row;
        }));
    }

    function showEventsByTime(content, characterName, userStoryNamesMap, flags) {
        DBMS.getCharacterEventsByTime(characterName, (err, allEvents) => {
            if (err) { Utils.handleError(err); return; }
            const adaptations = allEvents.map(event => ({
                characterName,
                storyName: event.storyName
            }));

            PermissionInformer.areAdaptationsEditable(adaptations, (err2, areAdaptationsEditable) => {
                if (err2) { Utils.handleError(err2); return; }

                DBMS.getMetaInfo((err3, metaInfo) => {
                    if (err3) { Utils.handleError(err3); return; }

                    const opts = {
                        userStoryNamesMap,
                        areAdaptationsEditable,
                        showStoryName: true,
                        metaInfo
                    };

                    const splitConstant = 5;

                    addEls(content, R.splitEvery(splitConstant, allEvents).map((subPart, i) => {
                        const eventContent = addEls(makeEl('div'), subPart.map((event, j) => {
                            opts.index = (i * splitConstant) + 1 + j;
                            return showEvent(event, characterName, opts, flags);
                        }));

                        let name;
                        if (flags.disableHeaders) {
                            name = makeText(strFormat(getL10n('briefings-events-header'), [(i * splitConstant) + 1, (i * splitConstant) + subPart.length]));
                        } else {
                            name = addEls(makeEl('div'), subPart.map(event => getEventHeaderDiv(event, true)));
                        }
                        return makePanel(name, eventContent, flags.hideAllPanels);
                    }));
                    onBuildContentFinish();
                });
            });
        });
    }

    function getStoryHeader(elem, i, disableHeaders) {
        let name;
        if (disableHeaders) {
            name = strFormat(getL10n('briefings-story-header'), [i + 1]);
        } else {
            name = elem.storyName;
        }
        return makeText(`${name} (${elem.events.length})`);
    }

    function showEventsByStory(content, characterName, userStoryNamesMap, flags) {
        DBMS.getCharacterEventGroupsByStory(characterName, (err, eventGroups) => {
            if (err) { Utils.handleError(err); return; }
            const adaptations = eventGroups.map(elem => ({
                characterName,
                storyName: elem.storyName
            }));
            PermissionInformer.areAdaptationsEditable(adaptations, (err2, areAdaptationsEditable) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getMetaInfo((err3, metaInfo) => {
                    if (err3) { Utils.handleError(err3); return; }
                    const opts = {
                        userStoryNamesMap,
                        areAdaptationsEditable,
                        showStoryName: false,
                        metaInfo
                    };

                    addEls(content, eventGroups.map((elem, i) => {
                        const storyContent = addEls(makeEl('div'), elem.events.map((event, j) => {
                            opts.index = j + 1;
                            return showEvent(event, characterName, opts, flags);
                        }));
                        return makePanel(
                            getStoryHeader(elem, i, flags.disableHeaders), storyContent,
                            flags.hideAllPanels
                        );
                    }));
                    onBuildContentFinish();
                });
            });
        });
    }

    function getEventHeaderDiv(event, showStoryName) {
        const eventName = addEl(makeEl('span'), makeText(strFormat('{0} {1}', [showStoryName ? `${event.storyName}:` : '', event.name])));
        const eventTime = addClass(addEl(makeEl('span'), makeText(event.time)), 'previewEventTime');
        return addEls(makeEl('div'), [eventTime, eventName]);
    }

    function showEvent(event, characterName, opts, flags) {
        const { isAdaptationsMode } = flags;
        const showAll = isAdaptationsMode;
        const storyName = event.storyName;
        const isStoryEditable = opts.userStoryNamesMap[storyName] !== undefined;
        const showAdaptationText = event.characters[characterName].text !== '';
        const showSubjectiveTime = event.characters[characterName].time !== '';

        const eventDiv = qmte('.adaptation-row-tmpl');
        const originCard = Adaptations.makeOriginCard(event, opts.metaInfo, event.storyName, {
            cardTitle: flags.disableHeaders ? L10n.format('briefings', 'event-header', [opts.index]) : event.name,
            showTimeInput: showAll || !showSubjectiveTime,
            showLockButton: true,
            showTextInput: showAll || !showAdaptationText
        });
        if(!isStoryEditable){
            qees(originCard, '.isStoryEditable').forEach(addClass(R.__, 'notEditable'));
        }
        addEl(qee(eventDiv, '.eventMainPanelRow-left'), originCard);
        const isEditable = opts.areAdaptationsEditable[`${event.storyName}-${characterName}`];
        const adaptationsCard = Adaptations.makeAdaptationCard(
            isEditable, event,
            event.storyName, characterName, {
                cardTitle: '',
                showTimeInput: showAll || showSubjectiveTime,
                showFinishedButton: true,
                showTextInput: showAll || showAdaptationText
            }
        );
        addEl(qee(eventDiv, '.eventMainPanelRow-left'), adaptationsCard);
        return eventDiv;
    }

    function updateCharacterInventory(event) {
        const {
            storyName, characterName, value
        } = event.target;
        DBMS.updateCharacterInventory(storyName, characterName, value, Utils.processError());
    }
})(this.BriefingPreview = {});

/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.relations-tab ';
    const state = {};
    const settingsPath = 'Relations';

    exports.init = () => {
        $(`${root} .character-select`).select2().on('change', buildContent);
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        clearEl(queryEl(`${root} .character-select`));
        clearEl(queryEl(`${root} .panel-body`));

        DBMS.getProfileStructure('character', (err, characterProfileStructure) => {
            if (err) { Utils.handleError(err); return; }
            state.characterProfileStructure = characterProfileStructure;
            PermissionInformer.getEntityNamesArray('character', false, (err3, names) => {
                if (err3) { Utils.handleError(err3); return; }
                
                showEl(qe(`${root} .alert`), names.length < 2);
                showEl(qe(`${root} > .panel`), names.length > 1);
                
                if (names.length > 0) {
                    const characterName = UI.checkAndGetEntitySetting(settingsPath, names);
                    const data = getSelect2Data(names);
                    // this call trigger buildContent
                    $(`${root} .character-select`).select2(data).val(characterName).trigger('change');
                }
            });
        });
    };

    function buildContent(event) {
        clearEl(queryEl(`${root} .panel-body`));
        const characterName = event.target.value;
        UI.updateEntitySetting(settingsPath, characterName);
        state.data = {};
        state.data.characterName = characterName;
        exports.load(state.data, buildContentInner);
    }

    function buildContentInner() {
        const content = RelationsPreview.makeRelationsContent(
            state.data, true, state.characterProfileStructure,
            exports.refresh
        );
        addEl(queryEl(`${root} .panel-body`), content);
        UI.initTextAreas(`${root} .panel-body textarea`);
        UI.refreshTextAreas(`${root} .panel-body textarea`);
    }

    exports.load = (data, callback) => {
        DBMS.getAllProfiles('character', (err, profiles) => {
            if (err) { Utils.handleError(err); return; }
            DBMS.getRelationsSummary(data.characterName, (err2, relationsSummary) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getExtendedProfileBindings((err3, profileBindings) => {
                    if (err3) { Utils.handleError(err3); return; }
                    PermissionInformer.getEntityNamesArray('character', false, (err4, characterNamesArray) => {
                        if (err4) { Utils.handleError(err4); return; }
                        data.relationsSummary = relationsSummary;
                        data.characterNamesArray = characterNamesArray;
                        data.profiles = profiles;
                        data.profileBindings = R.fromPairs(profileBindings);
                        callback();
                    });
                });
            });
        });
    };
})(this.Relations = {});

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const relationTableHeader = ['character-name', 'direct-relation', 'relation-origin', 'reverse-relation'];
    const partialTableHeader = ['character-name', 'direct-relation'];

    let makeNewRow;
    const l10n = L10n.get('briefings');

    const findRel = R.curry((fromCharacter, toCharacter, relations) => {
        const findFunc = R.curry((fromCharacter2, toCharacter2, rel) =>
            rel[fromCharacter2] !== undefined && rel[toCharacter2] !== undefined);
        return R.find(findFunc(fromCharacter, toCharacter), relations);
    });

    exports.makeRelationsContent = (data, isAdaptationsMode, profileSettings, externalRefresh) => {
        const {
            characterName, relationsSummary, profiles, profileBindings
        } = data;
        let { characterNamesArray } = data;

        characterNamesArray = characterNamesArray.filter(R.compose(R.not, R.equals(characterName), R.prop('value')));

        const get2ndCharName = ProjectUtils.get2ndRelChar(characterName);
        const showCharacters = relationsSummary.relations.map(get2ndCharName).sort(CommonUtils.charOrdA);
        const noRelsList = characterNamesArray.filter(R.compose(R.not, R.contains(R.__, showCharacters), R.prop('value')));
        const predicate = R.compose(R.contains(R.__, R.keys(relationsSummary.knownCharacters)), R.prop('value'));
        const [knownNoRels, unknownNoRels] = R.partition(predicate, noRelsList);

        const relationTmpl = wrapEl('div', qte('.relation-tmpl'));
        const qe = qee(relationTmpl);
        const content = qe('.relation-content');
        const getProfileItemSelect = () => qe('.profile-item-select');

        makeProfileItemSelector(qe('.profile-item-select'), profileSettings, refreshProfileItem(content, profiles));

        const makeRow = makeNewRow(
            profiles, getProfileItemSelect, isAdaptationsMode, relationsSummary.knownCharacters, profileBindings,
            externalRefresh, characterName
        );

        // filling header - need table body for callbacks
        const makeRowCallback = R.compose(addEl(content), makeRow);
        addEl(qe('.known-characters-label'), makeText(l10n('known-characters')));
        const knownBtn = addEl(qe('.add-known-character-relation'), makeText(getL10n('common-add')));
        addEl(qe('.unknown-characters-label'), makeText(l10n('unknown-characters')));
        const unknownBtn = addEl(qe('.add-unknown-character-relation'), makeText(getL10n('common-add')));
        addEl(qe('.profile-item-label'), makeText(l10n('profile-item')));
        fillCharSelector(qe('.known-characters-select'), knownBtn, knownNoRels, characterName, makeRowCallback);
        fillCharSelector(qe('.unknown-characters-select'), unknownBtn, unknownNoRels, characterName, makeRowCallback);

        // filling table
        const toCharacterFilter = toCharacter => (isAdaptationsMode ? true :
            !R.isEmpty(findRel(characterName, toCharacter, relationsSummary.relations)[characterName]));
        const findRelTmp = findRel(characterName, R.__, relationsSummary.relations);
        addEls(content, showCharacters.filter(toCharacterFilter).map(toChar => makeRow(toChar, findRelTmp(toChar))));
        return relationTmpl;
    };

    function refreshProfileItem(content, profiles) {
        return (event) => {
            const dataArr = queryElEls(content, '[toCharacter]');
            dataArr.forEach((el) => {
                const char = getAttr(el, 'toCharacter');
                const selectedName = event.target.value;
                fillProfileItemContent(el, selectedName, profiles[char][selectedName]);
            });
        };
    }

    function makeProfileItemSelector(select1, profileSettings, refresh) {
        select1 = $(select1);
        const tmpSelect = select1.select2(arr2Select2(profileSettings.map(R.prop('name')).sort()));

        select1.select2({ width: 'style' });
        tmpSelect.on('change', refresh);
        if (profileSettings[0]) {
            tmpSelect.val(profileSettings[0].name).trigger('change');
        }
    }

    makeNewRow = R.curry((
        profiles, getProfileItemSelect, isAdaptationsMode, knownCharacters, profileBindings,
        externalRefresh, fromCharacter, toCharacter, rel
    ) => {
        const stories = knownCharacters[toCharacter];
        const row = qmte('.relation-row-tmpl');
        const qe = qee(row);
        addEl(qe('.to-character-name'), makeText(`${toCharacter}/${profileBindings[toCharacter]}`));
        addEl(qe('.where-meets-label'), makeText(l10n('where-meets')));
        addEl(qe('.where-meets-content'), makeText(stories === undefined ? '' : R.keys(stories).join(', ')));
        setAttr(qe('[toCharacter]'), 'toCharacter', toCharacter);
        fillProfileItemContent(row, getProfileItemSelect().value, profiles[toCharacter][getProfileItemSelect().value]);
        listen(qe('button.remove'), 'click', (event) => {
            Utils.confirm(strFormat(l10n('are-you-sure-about-relation-removing'), [`${`${fromCharacter}-${toCharacter}`}`]), () => {
                DBMS.removeCharacterRelation(fromCharacter, toCharacter, (err) => {
                    if (err) { Utils.handleError(err); return; }
                    externalRefresh();
                });
            });
        });

        const directText = qe('.direct textarea');
        directText.value = rel[fromCharacter];
        setAttr(directText, 'placeholder', L10n.format('briefings', 'relation-from-to', [fromCharacter, toCharacter]));
        listen(directText, 'change', (event) => {
            DBMS.setCharacterRelationText(
                fromCharacter, toCharacter, fromCharacter, event.target.value,
                Utils.processError()
            );
        });

        Constants.relationEssences.forEach((name) => {
            const btn = qe(`.${name}`);
            $(btn).tooltip({
                title: L10n.format('briefings', `${name}`, [fromCharacter, toCharacter]),
                placement: 'top'
            });
            let attrName = name;
            if (rel.starter !== fromCharacter) {
                if (name === 'starterToEnder') attrName = 'enderToStarter';
                if (name === 'enderToStarter') attrName = 'starterToEnder';
            }
            setClassByCondition(btn, 'btn-primary', rel.essence.indexOf(attrName) !== -1);
            listen(btn, 'click', (event) => {
                DBMS.setRelationEssenceStatus(fromCharacter, toCharacter, attrName, !hasClass(event.target, 'btn-primary'), (err) => {
                    if (err) { Utils.handleError(err); return; }
                    toggleClass(event.target, 'btn-primary');
                });
            });
        });

        const originText = qe('.origin textarea');
        originText.value = rel.origin;
        setAttr(originText, 'placeholder', l10n('relation-origin'));
        listen(originText, 'change', (event) => {
            DBMS.setOriginRelationText(fromCharacter, toCharacter, event.target.value, Utils.processError());
        });

        const reverseText = qe('.reverse textarea');
        reverseText.value = rel[toCharacter];
        setAttr(reverseText, 'placeholder', L10n.format('briefings', 'relation-from-to', [toCharacter, fromCharacter]));
        listen(reverseText, 'change', (event) => {
            DBMS.setCharacterRelationText(
                fromCharacter, toCharacter, toCharacter,
                event.target.value, Utils.processError()
            );
        });

        const directChecked = rel.starter === fromCharacter ? rel.starterTextReady : rel.enderTextReady;
        fillFinishedButton(
            qe('.direct .finished'), JSON.stringify([fromCharacter, toCharacter]), fromCharacter,
            toCharacter, fromCharacter, directChecked, directText
        );

        const reverseChecked = rel.starter === toCharacter ? rel.starterTextReady : rel.enderTextReady;
        fillFinishedButton(
            qe('.reverse .finished'), JSON.stringify([toCharacter, fromCharacter]), fromCharacter,
            toCharacter, toCharacter, reverseChecked, reverseText
        );

        if (!isAdaptationsMode) {
            removeClass(qe('.direct'), 'col-xs-3');
            addClass(qe('.direct'), 'col-xs-9');
            addClass(qe('.origin'), 'hidden');
            addClass(qe('.reverse'), 'hidden');
        }
        L10n.localizeStatic(row);

        return row;
    });

    function fillFinishedButton(button, id, fromCharacter, toCharacter, character, checked, textarea) {
        setClassIf(button, 'btn-primary', checked);
        Utils.enableEl(textarea, !checked);
        button.id = id;
        listen(button, 'click', (event) => {
            const newValue = !hasClass(button, 'btn-primary');
            setClassByCondition(button, 'btn-primary', newValue);
            Utils.enableEl(textarea, !newValue);
            DBMS.setRelationReadyStatus(fromCharacter, toCharacter, character, newValue, Utils.processError());
        });
    }

    function fillProfileItemContent(el, profileItemName, profileItemValue) {
        addEl(clearEl(qee(el, '.profile-item-name')), makeText(profileItemName));
        addEl(clearEl(qee(el, '.profile-item-value')), makeText(profileItemValue));
    }

    function fillCharSelector(select1, button, data, fromCharacter, makeRowCallback) {
        select1 = $(select1);
        const tmpSelect = select1.select2(getSelect2Data(data));
        select1.select2({ width: 'style' });
        listen(button, 'click', () => {
            const toCharacter = select1[0].value;
            DBMS.createCharacterRelation(fromCharacter, toCharacter, (err) => {
                if (err) { Utils.handleError(err); return; }
                DBMS.getCharacterRelation(fromCharacter, toCharacter, (err2, rel) => {
                    if (err2) { Utils.handleError(err2); return; }
                    makeRowCallback(select1[0].value, rel);
                    data = data.filter(R.compose(R.not, R.equals(select1[0].value), R.prop('value')));
                    clearEl(select1[0]);
                    select1.select2(getSelect2Data(data));
                });
            });
        });
    }
})(this.RelationsPreview = {});

/*Copyright 2015-2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.gears-tab';
    const state = {};
    const l10n = L10n.get('gears');
    state.nodesDataset = new vis.DataSet();
    state.edgesDataset = new vis.DataSet();
    
    exports.init = () => {
        state.addNodeDialog = UI.createModalDialog(root, updateNode, {
            bodySelector: 'add-or-edit-node-body',
            dialogTitle: 'gears-add-node',
            actionButtonTitle: 'common-save',
            onCancel: onNodeCancel
        });
        
        state.editNodeDialog = UI.createModalDialog(root, updateNode, {
            bodySelector: 'add-or-edit-node-body',
            dialogTitle: 'gears-edit-node',
            actionButtonTitle: 'common-save',
            onCancel: onNodeCancel
        });
        
        state.renameEdgeDialog = UI.createModalDialog(root, renameEdge, {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'gears-rename-edge',
            actionButtonTitle: 'common-save',
        });
        
        const configureNetworkDialog = UI.createModalDialog(root, (dialog) => () => dialog.hideDlg(), {
            bodySelector: 'config-inner-body',
            dialogTitle: 'gears-configure-network',
            actionButtonTitle: 'common-close',
        });
        
        addClass(qee(configureNetworkDialog, '.modal-dialog'), 'gears-config-dialog');
        
        queryEl(`${root} .custom-physics-settings`).value = '';
        
//        document.querySelector('.nodesText').value = charExample;
//        setAttr(document.querySelector('.nodesText'),'rows', charExample.split('\n').length);
//        document.querySelector('.edgesText').value = edgesExample;
//        setAttr(document.querySelector('.edgesText'),'rows', edgesExample.split('\n').length);
        
        listen(qe(`${root} .draw-button`), 'click', exports.refresh);
        listen(qe(`${root} .get-image-button`), 'click', getImage);
        listen(qe(`${root} .download-button`), 'click', downloadCsv);
        listen(qe(`${root} .download-json-button`), 'click', downloadJSON);
        listen(qe(`${root} .download-graphml-button`), 'click', downloadYED);
        listen(qe(`${root} .clear-button`), 'click', clearNetwork);
        
        listen(queryEl(`${root} .physics-settings-button`), 'click', () => configureNetworkDialog.showDlg());
        
        listen(queryEl(`${root} .search-node`), 'change', onNodeFocus);
        
        listen(queryEl(`${root} .custom-physics-settings-button`), 'click', () => {
            const options = queryEl(`${root} .custom-physics-settings`).value;
            if(options.trim() === ''){
                return;
            }
            if(CommonUtils.startsWith(options, 'var options = ')){
                options = options.substring('var options = '.length);
            }
            try{
                options = JSON.parse(options);
            }catch(e){
                console.error(e);
                Utils.alert(l10n('error-on-settings-loading'));
                return;
            }
            state.network.setOptions(options);
        });
        
        queryEl(`${root} .physics-enabled-checkbox`).checked = false;
        listen(queryEl(`${root} .physics-enabled-checkbox`), 'change', (event) => {
            DBMS.setGearsPhysicsEnabled(event.target.checked, (err) => {
                if (err) { Utils.handleError(err); return; }
                state.network.setOptions({
                    "physics": {
                        "enabled": event.target.checked,
                        "minVelocity": 0.75
                    }
                })
            });
        });
        
        queryEl(`${root} .show-notes-checkbox`).checked = false;
        listen(queryEl(`${root} .show-notes-checkbox`), 'change', (event) => {
            DBMS.setGearsShowNotesEnabled(event.target.checked, (err) => {
                if (err) { Utils.handleError(err); return; }
                exports.refresh();
            });
        });
        
        queryEl(`${root} .big-picture-checkbox`).checked = false;
        listen(queryEl(`${root} .big-picture-checkbox`), 'change', (event) => {
            setClassByCondition(queryEl(`${root} .mynetwork > div`),'big-picture',event.target.checked);
        });
        
        state.nodesDataset.on('*', () => {
            fillSearchSelect();
        });
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        DBMS.getAllGearsData((err, data) => {
            if (err) { Utils.handleError(err); return; }
            queryEl(`${root} .show-notes-checkbox`).checked = data.settings.showNotes;
            queryEl(`${root} .physics-enabled-checkbox`).checked = data.settings.physicsEnabled;
            
            data.nodes.forEach(node => {
                node.label = makeLabel(node.name, node.notes);
            });
            state.nodesDataset.clear();
            state.nodesDataset.add(data.nodes);
            state.edgesDataset.clear();
            state.edgesDataset.add(data.edges);
            drawNetwork();
        });
    };
    
    // create a network
    function drawNetwork() {
      const container = qe(`${root} .mynetwork`);
      clearEl(queryEl(`${root} .configInner`));
      const options = {
        locale: L10n.getLocale(),
        locales: Constants.visLocales,
        manipulation: {
            addNode: function (data, callback) {
                data.label = '';
                data.name = '';
                
                qee(state.addNodeDialog, '.node-id').value = data.id;
                qee(state.addNodeDialog, '.node-name').value = data.name;
                qee(state.addNodeDialog, '.node-group').value = '';
                qee(state.addNodeDialog, '.node-notes').value = '';
                
                state.nodeData = data;
                state.nodeCallback = callback;
                
                state.addNodeDialog.showDlg();
            },
            editNode: function (data, callback) {
                qee(state.editNodeDialog, '.node-id').value = data.id;
                qee(state.editNodeDialog, '.node-name').value = data.name;
                qee(state.editNodeDialog, '.node-group').value = data.group;
                qee(state.editNodeDialog, '.node-notes').value = data.notes;
                
                state.nodeData = data;
                state.nodeCallback = function(data) {
                    callback(data);
                }.bind(this);
                
                state.editNodeDialog.showDlg();
            },
            addEdge: function (data, callback) {
                data.arrows ='to';
                data.label ='';
                if (data.from == data.to) {
                    Utils.confirm(l10n('do-you-want-to-connect-node-to-itself'), () => {
                        callback(data);
                    }, () => callback());
                }
                else {
                  callback(data);
                }
            },
            editEdge:function (data, callback) {
                callback(data);
                storeData();
            },
            deleteNode:function (data, callback) {
                callback(data);
                storeData();
            },
            deleteEdge:function (data, callback) {
                callback(data);
                storeData();
            },
        },
        physics: {
          enabled: queryEl(`${root} .physics-enabled-checkbox`).checked,
          stabilization: false
        },
        "edges": {
          "smooth": {
            "type": "discrete",
            "forceDirection": "none"
          }
        },
        configure: {
          filter:function (option, path) {
            if (path.indexOf('physics') !== -1) {
              return true;
            }
            if (path.indexOf('smooth') !== -1 || option === 'smooth') {
              return true;
            }
            return false;
          },
          container: qe(`${root} .configInner`)
        }
      };
      const data = {
        nodes: state.nodesDataset,
        edges: state.edgesDataset
      };
      state.network = new vis.Network(container, data, options);
      state.network.on('selectEdge', showEdgeLabelEditor);
      state.network.on('dragEnd', (params) => storeData());
      state.network.on('stabilized', (params) => storeData());
    }
    
    function storeData(callback){
        DBMS.setGearsData(exportNetwork(), (err) => {
            if (err) { Utils.handleError(err); return; }
            if(callback) callback();
        });
    }
    
    function exportNetwork() {
        state.network.storePositions();
        const nodePositions = state.network.getPositions();
        
        console.log(nodePositions);
        const nodes = R.clone(state.nodesDataset.get());
        const edges = state.edgesDataset.get();
        nodes.forEach(node => delete node.color);
        return {
            nodes,
            edges
        };
    }
    
    function importNetwork(data) {
        const {nodes, edges} = data;
        state.nodesDataset.clear();
        state.edgesDataset.clear();
        state.nodesDataset.update(nodes);
        state.edgesDataset.update(edges);
    }

    function showEdgeLabelEditor(params) {
        if (params.edges.length !== 0 && params.nodes.length === 0) {
            const edge = state.edgesDataset.get(params.edges[0]);
            qee(state.renameEdgeDialog, '.entity-input').value = edge.label || '';
            state.edgeData = edge;
            state.edgeCallback = (edge) => state.edgesDataset.update(edge);
            state.renameEdgeDialog.showDlg();
        }
    }

    function makeLabel(name, notes){
      let label = prepareStr(name); 
      if(queryEl(`${root} .show-notes-checkbox`).checked){
        label += (notes.trim() !== '' ? ('\n\n' + prepareStr(notes)) : '');
      }
      return label;
    }

    function prepareStr(text) {
        const maxStrLength = 30;
        return text.split('\n').map((str, i, strings) => {
            let counter = 0;
            const words = str.split(' ');
            return words.reduce((acc, word) => {
                if((counter + word.length + 1) <=  maxStrLength) {
                    acc += word + ' ';
                    counter += word.length + 1;
                } else {
                    acc += '\n' + word + ' ';
                    counter = 0;
                }
                return acc;
            }, '');
        }).join('\n');
        
        
//        return text.split('\n').map(R.splitEvery(30)).map(R.join('-\n')).join('\n');
    }


    function getImage(event){
      const canvas = document.querySelector("canvas");
      
      const context = canvas.getContext("2d");
      const w = canvas.width;
      const h = canvas.height;
      
      context.globalCompositeOperation = "destination-over";
      context.fillStyle = "#ffffff";
      context.fillRect(0,0,w,h);
      
      setAttr(event.target, 'download', FileUtils.makeFileName('gears','png'));
      
      const img    = canvas.toDataURL("image/png");
      const link = document.querySelector(".link");
      event.target.href = img;
      drawNetwork();
    }

    function clearNetwork(){
        Utils.confirm(l10n('confirm-clearing'), () => {
            state.nodesDataset.clear();
            state.edgesDataset.clear();
            storeData(exports.refresh);
        });
    }

    function updateNodeTextArea(){
      document.querySelector('.nodesText').value = state.nodesDataset.map((node) => [node.name, node.group, node.notes].join('\t')).join('\n');
    }

    function updateEdgeTextArea(){
      document.querySelector('.edgesText').value = state.edgesDataset.map((edge) => [state.nodesDataset.get(edge.from).name, edge.label, 
          state.nodesDataset.get(edge.to).name].join('\t')).join('\n');
    }

    function fillSearchSelect(){
      const arr = state.nodesDataset.map((node) => ({name: node.name, value: node.id}));
      arr.sort(CommonUtils.charOrdAFactory(a => a.name.toLowerCase()));
      fillSelector(clearEl(queryEl('.search-node')), arr);
    }

    function downloadCsv() {
        const arr = state.nodesDataset.map((node) => [node.name, node.group, node.notes]);
        const arr2 = state.edgesDataset.map((edge) => [state.nodesDataset.get(edge.from).name, edge.label, 
          state.nodesDataset.get(edge.to).name]);
          
        FileUtils.arr2d2Csv(arr.concat([['']]).concat(arr2), 'gears');
    }

    function downloadJSON() {
      const arr = state.nodesDataset.map((node) => [node.name, node.group, node.notes]);
      const arr2 = state.edgesDataset.map((edge) => [state.nodesDataset.get(edge.from).name, edge.label, 
        state.nodesDataset.get(edge.to).name]);
        
      const out = new Blob([JSON.stringify({nodes: arr, edges: arr2}, null, '  ')], {
          type: 'application/json;charset=utf-8;'
      });
      saveAs(out, FileUtils.makeFileName('gears', 'json'));
    }

    function downloadYED() {
      const arr = state.nodesDataset.map((node) => [node.name, node.group, node.notes]);
      const arr2 = state.edgesDataset.map((edge) => [state.nodesDataset.get(edge.from).name, edge.label, 
        state.nodesDataset.get(edge.to).name]);
      
      const groups = {};
      let index = 1;
      state.nodesDataset.map(node => {
        if(groups[node.group] === undefined){
          groups[node.group] = index;
          index++;
        }
      });
        
      const nodes = state.nodesDataset.map(node => {
        const colors = Constants.colorPalette[groups[node.group]-1].color;
        return CommonUtils.strFormat(Constants.yedNodeTmpl, [node.id, node.label, colors.background, colors.border]);
      }).join('\n');
      
      const edges = state.edgesDataset.map(edge => {
        return CommonUtils.strFormat(Constants.yedEdgeTmpl, [edge.id, edge.label || '', edge.from, edge.to]);
      }).join('\n');
      const out = new Blob([CommonUtils.strFormat(Constants.yedGmlBase, [nodes, edges])], {
          type: 'text/xml;charset=utf-8;'
      });
      saveAs(out, FileUtils.makeFileName('gears', 'graphml'));
    }

    function onNodeFocus(event) {
        state.network.focus(event.target.value, Constants.snFocusOptions);
    }

    function renameEdge(dialog) {
        return () => {
            if(state.edgeData){
                const toInput = qee(dialog, '.entity-input');
                const label = toInput.value.trim();
                const edge = state.edgeData;
                edge.label = label;
                toInput.value = '';
                state.edgeCallback(edge);
                state.edgeData = null;
                state.edgeCallback = null;
                storeData();
                dialog.hideDlg();
            }
        }
    }
    
    function updateNode(dialog) {
        return () => {
            if( state.nodeData ){
                let data = state.nodeData;
                data.id = qee(dialog, '.node-id').value;
                data.name = qee(dialog, '.node-name').value;
                data.group = qee(dialog, '.node-group').value;
                data.notes = qee(dialog, '.node-notes').value;
                data.label = makeLabel(data.name, data.notes);
                data.shape = 'box';
                
                const extraFields = R.difference(R.keys(data), Constants.gearsNodeRequiredFields);
                data = R.omit(extraFields, data);
                
                state.nodeCallback(data);
                
                state.nodeData = null;
                state.nodeCallback = null;
                storeData(exports.refresh);
                dialog.hideDlg();
            }
        };
    }
    
    function onNodeCancel() {
        if( state.nodeData ){
            state.nodeCallback(null);
            state.nodeData = null;
            state.nodeCallback = null;
        }
    }
})(this.Gears = {});

/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

/* eslint-disable func-names */

'use strict';

function AddFilterConditionDialog(root) {
    this.dialog = UI.createModalDialog(root, this.onAction.bind(this), {
        bodySelector: 'add-filter-condition-body',
        dialogTitle: 'groups-add-filter-condition',
        actionButtonTitle: 'common-ok',
    });
    listen(qee(this.dialog, `.profile-item-selector`), 'change', this.onProfileItemSelect.bind(this));
}

AddFilterConditionDialog.prototype.showDlg = function(groups, callback){
    this.callback = callback;
    this.items = R.indexBy(R.prop('name'), R.unnest(groups.map(R.prop('array'))));
    
    const selector = qee(this.dialog, `.profile-item-selector`);
    UI.fillShowItemSelector2(
        clearEl(selector),
        groups,
        false
    );
    selector.options[0].selected = true;
    
    this.onProfileItemSelect({target: selector});
    
    this.dialog.showDlg();
    // to set dialog title
//    setAttr(qee(el, '.modal-title'), 'l10n-id', opts.dialogTitle);
    
}

AddFilterConditionDialog.prototype.onAction = function (dialog){
    return function () {
        console.log(this.getFilterModelItem());
        this.callback(this.getFilterModelItem());
        dialog.hideDlg();
    }.bind(this);
} 

AddFilterConditionDialog.prototype.getFilterModelItem = function () {
    const opt = qee(this.dialog, `.profile-item-selector`).selectedOptions[0];
    const item = this.items[opt.value];
    
    const filterItem = {
        type: item.type,
        name: item.name
    };
    
    const conditionContainer = (qee(this.dialog, '.condition'));
    const valueContainer = (qee(this.dialog, '.value'));
    
    let arr;
    switch (item.type) {
    case 'enum':
    case 'checkbox':
        arr = nl2array(qee(valueContainer, 'select').selectedOptions).map(R.prop('value'));
        filterItem.selectedOptions = R.zipObj(arr, R.repeat(true, arr.length));
        break;
    case 'number':
        filterItem.condition = qee(conditionContainer, 'select').value;
        filterItem.num = Number(qee(valueContainer, 'input').value);
        
//        if (inputItem.value === 'ignore') { return; }
//        num = Number(state.inputItems[`${inputItem.selfInfo.name}:numberInput`].value);
//        model.push({
//            type, name: inputItemName, num, condition: inputItem.value
//        });
        break;
    case 'multiEnum':
        filterItem.condition = qee(conditionContainer, 'select').value;
        arr = nl2array(qee(valueContainer, 'select').selectedOptions).map(R.prop('value'));
        filterItem.selectedOptions = R.zipObj(arr, R.repeat(true, arr.length));
//        if (inputItem.value === 'ignore') { return; }
//        selectedOptions = {};
//        select2 = state.inputItems[`${inputItem.selfInfo.name}:multiEnumInput`];
//        arr = nl2array(select2.selectedOptions).map(R.prop('value'));
//        model.push({
//            type,
//            name: inputItemName,
//            condition: inputItem.value,
//            selectedOptions: R.zipObj(arr, R.repeat(true, arr.length))
//        });
        break;
    case 'text':
    case 'string':
        filterItem.regexString = qee(valueContainer, 'input').value.toLowerCase();
//        model.push({ type, name: inputItemName, regexString: inputItem.value.toLowerCase() });
        break;
    default:
        throw new Error(`Unexpected type ${type}`);
    }
    return filterItem;
}

AddFilterConditionDialog.prototype.onProfileItemSelect = function (event) {
    const opt = event.target.selectedOptions[0];
    const item = this.items[opt.value];
    console.log(item);
    
    const conditionContainer = clearEl(qee(this.dialog, '.condition'));
    switch (item.type) {
    case 'text':
    case 'string':
        addEl(conditionContainer, qmte('.text-condition-tmpl'));
        break;
    case 'enum':
    case 'checkbox':
        addEl(conditionContainer, qmte('.enum-condition-tmpl'));
        break;
    case 'multiEnum':
        addEl(conditionContainer, qmte('.multienum-condition-tmpl'));
        break;
    case 'number':
        addEl(conditionContainer, qmte('.number-condition-tmpl'));
        break;
    default:
        throw new Error(`Unexpected type ${item.type}`);
    }
    
    const valueContainer = clearEl(qee(this.dialog, '.value'));
    let valueInput, values;
    switch (item.type) {
    case 'text':
    case 'string':
        addEl(valueContainer, qmte('.text-value-tmpl'));
        break;
    case 'checkbox':
        addEl(valueContainer, qmte('.checkbox-value-tmpl'));
        break;
    case 'enum':
    case 'multiEnum':
        valueInput = qmte('.enum-value-tmpl');
        values = item.value.split(',');
        values.sort(CommonUtils.charOrdA);
        values = arr2Select(values);
        valueInput.size = values.length;

        fillSelector(valueInput, values.map((value) => {
            value.selected = true;
            return value;
        }));
        addEl(valueContainer, valueInput);
        break;
    case 'number':
        addEl(valueContainer, qmte('.number-value-tmpl'));
        break;
    default:
        throw new Error(`Unexpected type ${item.type}`);
    }
    L10n.localizeStatic(this.dialog);
//    console.log(item);
}
/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

/* eslint-disable func-names */

'use strict';

function FilterConfiguration(info) {
    this.info = info;
    function populateProfileItems(item) {
        if (!CommonUtils.startsWith(item.name, Constants.CHAR_PREFIX) &&
            !CommonUtils.startsWith(item.name, Constants.PLAYER_PREFIX)) {
            item.displayName = getL10n(item.displayName);
            item.value = '';
        }
    }
    this.groupedProfileFilterItems = CommonUtils.clone(info.groupedProfileFilterItems);
    this.groupedProfileFilterItems.map(R.prop('profileFilterItems')).map(R.map(populateProfileItems));
}

FilterConfiguration.makeFilterConfiguration = function (callback) {
    DBMS.getProfileFilterInfo((err, info) => {
        if (err) { Utils.handleError(err); return; }
        const filterConfiguration = new FilterConfiguration(info);
        callback(null, filterConfiguration);
    });
};

FilterConfiguration.prototype.getProfileFilterItems = function () {
    return R.flatten(this.groupedProfileFilterItems.map(R.prop('profileFilterItems')));
};

FilterConfiguration.prototype.getProfileItemSource = function (name) {
    let source;
    this.groupedProfileFilterItems.forEach( (el) => {
        const arr = el.profileFilterItems.map(R.prop('name'));
        if(R.contains(name, arr)){
            source = el.name;
        }
    });
    return source;
};

FilterConfiguration.prototype.getName2SourceMapping = function () {
    return this.groupedProfileFilterItems.reduce( (acc, group) => {
        group.profileFilterItems.forEach( item => acc[item.name] = group.name);
        return acc;
    }, {});
};

FilterConfiguration.prototype.getName2DisplayNameMapping = function () {
    return this.groupedProfileFilterItems.reduce( (acc, group) => {
        group.profileFilterItems.forEach( item => acc[item.name] = item.displayName);
        return acc;
    }, {});
};

FilterConfiguration.prototype.getGroupedProfileFilterItems = function () {
    return this.groupedProfileFilterItems;
};

FilterConfiguration.prototype.getGroupsForSelect = function() {
    return this.groupedProfileFilterItems.map((group) => ({
        displayName: getL10n(`profile-filter-${group.name}`),
        array: group.profileFilterItems
    }));
}

FilterConfiguration.prototype.getBaseProfileSettings = function () {
    return {
        characters: this.info.characters.profileStructure,
        players: this.info.players.profileStructure
    };
};

FilterConfiguration.prototype.getDataArrays = function (filterModel) {
    return ProjectUtils.getDataArrays(this.info, filterModel);
};

FilterConfiguration.prototype.haveProfiles = function () {
    return R.keys(this.info.characters.profiles).length > 0 || R.keys(this.info.players.profiles).length > 0;
};

FilterConfiguration.prototype.haveProfileStructures = function () {
    return this.info.characters.profileStructure.length > 0 || this.info.players.profileStructure.length > 0;
};

FilterConfiguration.prototype.haveData = function () {
    return this.haveProfiles() && this.haveProfileStructures();
};

FilterConfiguration.prototype.getProfileIds = function (filterModel) {
    const offset = this.groupedProfileFilterItems[0].profileFilterItems.length;
    return this.getDataArrays(filterModel).map(dataArray => `${dataArray[0].value || ''}/${dataArray[offset].value || ''}`).sort();
};

/*Copyright 2016 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const root = '.group-profile-tab ';
    const l10n = L10n.get('groups');
    const settingsPath = 'GroupProfile';

    exports.init = () => {
        const createGroupDialog = UI.createModalDialog(root, exports.createGroup(true, exports.refresh), {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'groups-enter-group-name',
            actionButtonTitle: 'common-create',
        });
        listen(qe(`${root}.create`), 'click', () => createGroupDialog.showDlg());

        state.renameGroupDialog = UI.createModalDialog(root, renameGroup, {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'groups-enter-new-group-name',
            actionButtonTitle: 'common-rename',
        });

        const tbody = clearEl(queryEl(`${root} .entity-profile`));

        state.inputItems = {};

        Constants.groupProfileStructure.forEach((profileSettings) => {
            profileSettings.displayName = getL10n(`groups-${profileSettings.name}`);
            addEl(tbody, makeInput(profileSettings));
        });

        listen(queryEl(`${root} .entity-filter`), 'input', filterOptions);

        exports.content = queryEl(`${root}`);
    };

    exports.refresh = () => {
        PermissionInformer.getEntityNamesArray('group', false, (err, groupNames) => {
            if (err) { Utils.handleError(err); return; }
            
            showEl(qe(`${root} .alert`), groupNames.length === 0);
            showEl(qe(`${root} .col-xs-9`), groupNames.length !== 0);
            Utils.enableEl(qe(`${root} .entity-filter`), groupNames.length !== 0);
            
            addEls(clearEl(queryEl(`${root} .entity-list`)), groupNames.map((name, i, arr) => {
                const el = wrapEl('div', qte('.entity-item-tmpl'));
                addEl(qee(el, '.primary-name'), makeText(name.displayName));
                setAttr(el, 'primary-name', name.displayName);
                setAttr(el, 'profile-name', name.value);
                listen(qee(el, '.select-button'), 'click', showProfileInfoDelegate2(name.value));
                setAttr(qee(el, '.rename'), 'title', l10n('rename-entity'));
                const removeBtn = qee(el, '.remove');
                setAttr(removeBtn, 'title', l10n('remove-entity'));
                if(i+1 < arr.length){
                    removeBtn.nextName = arr[i+1].value;
                }
                if(i > 0){
                    removeBtn.prevName = arr[i-1].value;
                }
                if (name.editable) {
                    listen(qee(el, '.rename'), 'click', () => {
                        qee(state.renameGroupDialog, '.entity-input').value = name.value;
                        state.renameGroupDialog.fromName = name.value;
                        state.renameGroupDialog.showDlg();
                    });
                    listen(removeBtn, 'click', GroupProfile.removeGroup(() => name.value, exports.refresh, removeBtn));
                } else {
                    setAttr(qee(el, '.rename'), 'disabled', 'disabled');
                    setAttr(removeBtn, 'disabled', 'disabled');
                }
                return el;
            }));

            showProfileInfoDelegate2(UI.checkAndGetEntitySetting(settingsPath, groupNames))();
        });
    };

    function makeInput(profileItemConfig) {
        let input;
        switch (profileItemConfig.type) {
        case 'text':
            input = makeEl('textarea');
            addClass(input, 'profileTextInput form-control');
            input.addEventListener('change', updateFieldValue(profileItemConfig.type));
            break;
        case 'checkbox':
            input = makeEl('input');
            input.type = 'checkbox';
            addClass(input, 'form-control');
            input.addEventListener('change', updateFieldValue(profileItemConfig.type));
            break;
        case 'container':
            input = makeEl('div');
            input.type = 'container';
            break;
        default:
            throw new Error(`Unexpected type ${profileItemConfig.type}`);
        }
        input.selfName = profileItemConfig.name;
        addClass(input, 'isGroupEditable');
        state.inputItems[profileItemConfig.name] = input;

        const row = qmte('.profile-editor-row-tmpl');
        addEl(qee(row, '.profile-item-name'), makeText(profileItemConfig.displayName));
        setAttr(qee(row, '.profile-item-name'), 'l10n-id', `groups-${profileItemConfig.name}`);
        addEl(qee(row, '.profile-item-input'), input);
        return row;
    }

    function updateFieldValue(type) {
        return (event) => {
            const fieldName = event.target.selfName;
            const groupName = state.name;

            let value;
            switch (type) {
            case 'text':
                // eslint-disable-next-line prefer-destructuring
                value = event.target.value;
                DBMS.updateGroupField(groupName, fieldName, value, Utils.processError());
                break;
            case 'checkbox':
                value = event.target.checked;
                DBMS.doExportGroup(groupName, value, Utils.processError());
                break;
            default:
                throw new Error(`Unexpected type ${type}`);
            }
        };
    }

    function showProfileInfoDelegate2(name) {
        return () => {
            queryEls(`${root} [profile-name] .select-button`).map(removeClass(R.__, 'btn-primary'));
            if(name !== null){
                UI.updateEntitySetting(settingsPath, name);
                const el = queryEl(`${root} [profile-name="${name}"] .select-button`);
                addClass(el, 'btn-primary');
                
                const parentEl = el.parentElement.parentElement;
                const entityList = queryEl(`${root} .entity-list`);
                UI.scrollTo(entityList, parentEl);
                
                DBMS.getGroup(name, showProfileInfoCallback);
            }
        };
    }

    function showProfileInfoCallback(err, group) {
        if (err) { Utils.handleError(err); return; }
        const { name } = group;
        FilterConfiguration.makeFilterConfiguration((err1, filterConfiguration) => {
            if (err1) { Utils.handleError(err1); return; }

            PermissionInformer.isEntityEditable('group', name, (err2, isGroupEditable) => {
                if (err2) { Utils.handleError(err2); return; }
                updateSettings(name);
                
                const name2DisplayName = filterConfiguration.getName2DisplayNameMapping();
                
                const name2Source = filterConfiguration.getName2SourceMapping();

                state.name = name;
                const { inputItems } = state;
                Object.keys(inputItems).forEach((inputName) => {
                    if (inputItems[inputName].type === 'checkbox') {
                        inputItems[inputName].checked = group[inputName];
                    } else if (inputItems[inputName].type === 'container') {
                        if (inputName === 'filterModel') {
                            const table = qmte(`${root} .group-filter-template`);
                            const datas = group.filterModel.map(exports.makeFilterItemString(name2DisplayName, name2Source));
                            addEls(qee(table, 'tbody'), datas.map(data2row));
                            L10n.localizeStatic(table);
                            addEl(clearEl(inputItems[inputName]), table);
                        } else if (inputName === 'characterList') {
                            const data = filterConfiguration.getProfileIds(group.filterModel);
                            const inputItem = clearEl(inputItems[inputName]);
                            addEls(inputItem, [makeText(data.join(', ')), makeEl('br'), makeText(getL10n('groups-total') + data.length)]);
                        } else {
                            throw new Error(`Unexpected container: ${inputName}`);
                        }
                    } else if (inputItems[inputName].type === 'textarea') {
                        inputItems[inputName].value = group[inputName];
                    } else {
                        throw new Error(`Unexpected input type: ${inputItems[inputName].type}`);
                    }
                    inputItems[inputName].oldValue = group[inputName];
                    Utils.enable(exports.content, 'isGroupEditable', isGroupEditable);
                });
            });
        });
    }

    // eslint-disable-next-line no-var,vars-on-top
    exports.makeFilterItemString = R.curry((name2DisplayName, name2Source, filterItem) => {
        const displayName = name2DisplayName[filterItem.name];
        const source = name2Source[filterItem.name];
        let condition, arr, value;
        switch (filterItem.type) {
        case 'enum':
            condition = getL10n(`groups-one-from`);
            value = Object.keys(filterItem.selectedOptions).join(', ');
            break;
        case 'checkbox':
            arr = [];
            if (filterItem.selectedOptions.true) { arr.push(getL10n('constant-yes')); }
            if (filterItem.selectedOptions.false) { arr.push(getL10n('constant-no')); }
            condition = getL10n(`groups-one-from`);
            value = arr.join(', ');
            break;
        case 'number':
            condition = getL10n(`constant-${filterItem.condition}`);
            value = filterItem.num;
            break;
        case 'multiEnum':
            condition = getL10n(`constant-${filterItem.condition}`);
            value = Object.keys(filterItem.selectedOptions).join(', ');
            break;
        case 'text':
        case 'string':
            condition = getL10n('groups-text-contains');
            value = filterItem.regexString;
            break;
        default:
            throw new Error(`Unexpected type ${filterItem.type}`);
        }
        const title = getL10n(`profile-filter-${source}`) + ', ' + getL10n(`constant-${filterItem.type}`);
        return {displayName, title, condition, value};
    });
    
    function data2row(data){
        const {displayName, title, condition, value} = data;
        const row = qmte(`${root} .group-filter-row-template`);
        addEl(qee(row, '.profile-item'), makeText(displayName));
        setAttr(qee(row, '.profile-item'), 'title', title);
        addEl(qee(row, '.condition'), makeText(condition));
        addEl(qee(row, '.value'), makeText(value));
        return row;
    }

    function updateSettings(name) {
        const settings = DBMS.getSettings();
        settings.GroupProfile.groupName = name;
    }

    function filterOptions(event) {
        const str = event.target.value.toLowerCase();

        const els = queryEls(`${root} [primary-name]`);
        els.forEach((el) => {
            const isVisible = getAttr(el, 'primary-name').toLowerCase().indexOf(str) !== -1;
            hideEl(el, !isVisible);
        });

        if (queryEl(`${root} .hidden[primary-name] .select-button.btn-primary`) !== null ||
            queryEl(`${root} [primary-name] .select-button.btn-primary`) === null) {
            const els2 = queryEls(`${root} [primary-name]`).filter(R.pipe(hasClass(R.__, 'hidden'), R.not));
            showProfileInfoDelegate2(els2.length > 0 ? getAttr(els2[0], 'profile-name') : null)();
        } else {
            //            queryEl(`${root} [primary-name] .select-button.btn-primary`).scrollIntoView();
        }
    }

    exports.createGroup = (updateSettingsFlag, refresh) => dialog => () => {
        const input = qee(dialog, '.entity-input');
        const name = input.value.trim();

        DBMS.createGroup(name, (err) => {
            if (err) {
                setError(dialog, err);
            } else {
                if (updateSettingsFlag) {
                    UI.updateEntitySetting(settingsPath, name);
                }
                PermissionInformer.refresh((err2) => {
                    if (err2) { Utils.handleError(err2); return; }
                    input.value = '';
                    dialog.hideDlg();
                    refresh();
                });
            }
        });
    };

    function renameGroup(dialog) {
        return () => {
            const toInput = qee(dialog, '.entity-input');
            const { fromName } = dialog;
            const toName = toInput.value.trim();

            DBMS.renameGroup(fromName, toName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    UI.updateEntitySetting(settingsPath, toName);
                    toInput.value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    exports.removeGroup = (callback, refresh, btn) => () => {
        const name = callback();

        Utils.confirm(strFormat(getL10n('groups-are-you-sure-about-group-removing'), [name]), () => {
            DBMS.removeGroup(name, (err) => {
                if (err) { Utils.handleError(err); return; }
                PermissionInformer.refresh((err2) => {
                    if (err2) { Utils.handleError(err2); return; }
                    if(btn.nextName !== undefined){
                        UI.updateEntitySetting(settingsPath, btn.nextName);
                    } else if(btn.prevName !== undefined) {
                        UI.updateEntitySetting(settingsPath, btn.prevName);
                    }
                    refresh();
                });
            });
        });
    };
})(this.GroupProfile = {});

/*Copyright 2016-2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const rootTab = '.group-schema-tab';

    exports.init = () => {
        exports.content = queryEl(rootTab);
    };

    exports.refresh = () => {
        DBMS.getGroupSchemas((err, schemas) => {
//            redrawSchema(schemas.theory);
            redrawSchema2(schemas.theory, 'theory');
            redrawSchema2(schemas.practice, 'practice');
        });
    };

    function redrawSchema(graph) {
        const container = queryEl(`${rootTab} .schema-container`);

        if (state.network) {
            state.network.destroy();
        }
        graph.edges = graph.edges.map(edge => R.merge(edge, {
            physics: false,
        }));

        state.network = new vis.Network(container, graph, Constants.groupSchemaOpts);
    }
    
    function redrawSchema2(graphData, className) {
        clearEl(queryEl(`${rootTab} svg.${className}`));
        const svg = d3.select(`${rootTab} svg.${className}`);
        const svgGroup = svg.append('g');
        const root = svgGroup.append('g');

        // define an arrow head
        svg.append('svg:defs')
            .append('svg:marker')
            .attr('id', 'end')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 10)
            .attr('refY', 0)
            .attr('markerWidth', 3) // marker settings
            .attr('markerHeight', 5)
            .attr('orient', 'auto')
            .style('fill', '#999')
            .style('stroke-opacity', 0.6) // arrowhead color
            .append('svg:path')
            .attr('d', 'M0,-5L10,0L0,5');
        
        const nodeDict = graphData.nodes.reduce((dict, node, i) => {
            dict[node.id] = i;
            return dict;
        }, {});

        const nodeWidth = 170;
        const nodeHeight = 20;

        const name2Node = obj => ({
            id: nodeDict[obj.id],
            name: obj.id,
            title: obj.title,
            label: obj.label,
            width: nodeWidth,
            height: nodeHeight
        });

        const pair2Edge = (obj, i) => ({
            id: i + graphData.nodes.length,
            source: nodeDict[obj.to],
            target: nodeDict[obj.from]
        });

        const graph = {
            nodes: graphData.nodes.map(name2Node),
            links: graphData.edges.map(pair2Edge)
        };

        const layouter = klay.d3adapter();
        const width = 960;
        const height = 400;

        layouter
            .nodes(graph.nodes)
            .links(graph.links)
            .size([width, height])
            .transformGroup(root)
            .options({
                edgeRouting: 'ORTHOGONAL',
                "direction": "RIGHT",
                intCoordinates: false
            })
            .defaultPortSize([2, 2])
            .start();

        const link = root.selectAll('.link')
            .data(graph.links)
            .enter()
            .append('path')
            .attr('class', 'link')
            .attr('d', 'M0 0')
            .attr('marker-end', 'url(#end)');

        // we group nodes along with their ports
        const node = root.selectAll('.node')
            .data(graph.nodes)
            .enter()
            .append('g');

        node.append('rect')
            .attr('class', (d) => {
                return 'node valid';
//                const details = checkRes.details[d.name];
//                if (details === undefined || details.length === 0) {
//                    return 'node valid';
//                }
//                return 'node invalid';
            })
            .attr('width', nodeWidth)
            .attr('height', nodeHeight)
            .attr('title', 'link')
            .attr('rx', 5)
            .attr('ry', 5)
            .attr('x', 0)
            .attr('y', 0);
        
        node.append('title').text(d => d.title)

        node.append('text')
            .attr('x', nodeWidth / 2)
            .attr('y', nodeHeight / 2)
            .attr('alignment-baseline', 'middle')
            .attr('text-anchor', 'middle')
//            .text(d => d.name)
            .text(d => d.label)
            .attr('font-size', '4px');

        // ports
        const port = node.selectAll('.port')
            .data(d => d.ports)
            .enter()
            .append('rect')
            .attr('class', 'port')
            .attr('width', 2)
            .attr('height', 2)
            .attr('x', 0)
            .attr('y', 0);

        // apply layout
        layouter.on('finish', (d2) => {
        // apply edge routes
            link.transition().attr('d', (d) => {
                let path = '';
                path += `M${d.sourcePoint.x} ${d.sourcePoint.y} `;
                d.bendPoints.forEach((bp, i) => {
                    path += `L${bp.x} ${bp.y} `;
                });
                path += `L${d.targetPoint.x} ${d.targetPoint.y} `;
                return path;
            });

            // apply node positions
            node.transition()
                .attr('transform', d => `translate(${d.x} ${d.y})`);

            // apply port positions
            port.transition()
                .attr('x', d => d.x)
                .attr('y', d => d.y);
        });

        layouter.start();
    };
})(this.GroupSchema = {});

/*Copyright 2015-2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const root = '.profile-filter-tab ';

    exports.init = () => {
        const createGroupDialog = UI.createModalDialog(root, GroupProfile.createGroup(false, exports.refresh), {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'groups-enter-group-name',
            actionButtonTitle: 'common-create',
        });

        const renameGroupDialog = UI.createModalDialog(root, renameGroup(`${root}.save-entity-select`), {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'groups-enter-new-group-name',
            actionButtonTitle: 'common-rename',
        });
        
//        state.addFilterConditionDialog = new AddFilterConditionDialog(root);
//        listen(qe(`${root}.create.filter-condition`), 'click', onAddFilterCondition);

        listen(queryEl(`${root}#profile-filter-columns .profile-item-selector`), 'change', UI.showSelectedEls3(root, 'dependent', 'dependent-index'));
        
//        Utils.enable(exports.content, 'isGroupEditable', isGroupEditable);
//        listen queryEl(`${root}.save-entity-select`)
        
        $(`${root}.save-entity-select`).select2().on('change', (event) => {
            const group = event.target.value;
            const userGroups = state.userGroupNames.map(R.prop('value'));
            const isGroupEditable = R.contains(group, userGroups);
            Utils.enable(exports.content, 'isGroupEditable', isGroupEditable);
        });

        listen(queryEl(`${root}.show-entity-button`), 'click', loadFilterFromGroup);
        listen(queryEl(`${root}.save-entity-button`), 'click', saveFilterToGroup);
        listen(queryEl(`${root}.download-filter-table`), 'click', downloadFilterTable);

        listen(qe(`${root}.create.group`), 'click', () => createGroupDialog.showDlg());
        listen(qe(`${root}.rename.group`), 'click', () => {
            qee(renameGroupDialog, '.entity-input').value = queryEl(`${root}.save-entity-select`).value;
            renameGroupDialog.showDlg();
        });
        listen(queryEl(`${root}.remove.group`), 'click', GroupProfile.removeGroup(() => 
            queryEl(`${root}.save-entity-select`).value, exports.refresh));

        exports.content = queryEl(root);
    };
    
    exports.refresh = () => {
        state.sortKey = Constants.CHAR_NAME;
        state.sortDir = 'asc';
        state.inputItems = {};
        state.checkboxes = {};
        state.curFilterModel = [];

        const filterSettingsDiv = clearEl(queryEl(`${root}.filter-settings-panel`));
        addEl(filterSettingsDiv, addClass(makeEl('div'), 'separator'));

        groupAreaRefresh();

        FilterConfiguration.makeFilterConfiguration((err, filterConfiguration) => {
            if (err) { Utils.handleError(err); return; }

            state.filterConfiguration = filterConfiguration;
            
            showEl(qe(`${root} .alert.no-characters`), !filterConfiguration.haveProfiles());
            showEl(qe(`${root} .alert.no-players`), !filterConfiguration.haveProfiles());
            showEl(qe(`${root} .alert.no-character-profile`), !filterConfiguration.haveProfileStructures());
            showEl(qe(`${root} .alert.no-player-profile`), !filterConfiguration.haveProfileStructures());
            showEl(qe(`${root} .profile-filter-container .panel`), filterConfiguration.haveData());
            
            const groupedProfileFilterItems = filterConfiguration.getGroupedProfileFilterItems();
            addEls(filterSettingsDiv, R.flatten(groupedProfileFilterItems.map(item => R.concat(item.profileFilterItems.map(makeInput), [addClass(makeEl('div'), 'filterSeparator')]))));

            UI.fillShowItemSelector2(
                clearEl(queryEl(`${root}#profile-filter-columns .profile-item-selector`)),
                filterConfiguration.getGroupsForSelect(),
                true
            );

            addEl(
                clearEl(queryEl(`${root}.filter-head`)),
                makeContentHeader(getHeaderProfileItemNames(filterConfiguration.getProfileFilterItems()))
            );

            rebuildContent();
        });
    };
    
    function onAddFilterCondition() {
        state.addFilterConditionDialog.showDlg(state.filterConfiguration.getGroupsForSelect(), setFilterModelItem);
    }
    
    function setFilterModelItem (filterModelItem) {
        const index = R.findIndex(R.propEq('name', filterModelItem.name), state.curFilterModel);
        if(index === -1){
            state.curFilterModel.push(filterModelItem);
        } else {
            state.curFilterModel[index] = filterModelItem;
        }
    }
    
    function groupAreaRefresh() {
        PermissionInformer.getEntityNamesArray('group', true, Utils.processError((userGroupNames) => {
            PermissionInformer.getEntityNamesArray('group', false, Utils.processError((allGroupNames) => {
                
                Utils.enableEl(qe(`${root}.rename.group`), allGroupNames.length > 0);
                Utils.enableEl(qe(`${root}.remove.group`), allGroupNames.length > 0);
                Utils.enableEl(qe(`${root}.show-entity-button`), allGroupNames.length > 0);
                Utils.enableEl(qe(`${root}.save-entity-button`), allGroupNames.length > 0);
                Utils.enableEl(qe(`${root}.save-entity-select`), allGroupNames.length > 0);
                
                state.userGroupNames = userGroupNames;
                state.allGroupNames = allGroupNames;
                const data = getSelect2Data(allGroupNames);
                clearEl(queryEl(`${root}.save-entity-select`));
                $(`${root}.save-entity-select`).select2(data);
            }));
        }));
    }

    function getHeaderProfileItemNames(profileSettings) {
        return R.map(R.pick(['name', 'displayName', 'type']), profileSettings);
    }

    function makePrintData() {
        const dataArrays = state.filterConfiguration.getDataArrays(makeFilterModel());

        const sortFunc = CommonUtils.charOrdAFactoryBase(state.sortDir, (a, b) => a > b, (a) => {
            const map = CommonUtils.arr2map(a, 'itemName');
            const item = map[state.sortKey];
            let { value } = item;
            if (value === undefined) return value;
            switch (item.type) {
            case 'text':
            case 'string':
            case 'enum':
            case 'multiEnum':
                value = value.toLowerCase();
                break;
            case 'checkbox':
            case 'number':
                break;
            default:
                throw new Error(`Unexpected type ${item.type}`);
            }
            return value;
        });
        return dataArrays.sort(sortFunc);
    }

    function rebuildContent() {
        const dataArrays = makePrintData();
        addEl(clearEl(queryEl(`${root}.filter-result-size`)), makeText(dataArrays.length));
        addEls(clearEl(queryEl(`${root}.filter-content`)), dataArrays.map(makeDataString));
        UI.showSelectedEls3(root, 'dependent', 'dependent-index')({ target: queryEl(`${root}#profile-filter-columns .profile-item-selector`) });
    }

    function saveFilterToGroup() {
        const groupName = queryEl(`${root}.save-entity-select`).value;
        PermissionInformer.isEntityEditable('group', groupName, (err, isGroupEditable) => {
            if (err) { Utils.handleError(err); return; }
            if (!isGroupEditable) {
                Utils.alert(strFormat(getL10n('groups-group-editing-forbidden'), [groupName]));
                return;
            }
            DBMS.saveFilterToGroup(groupName, makeFilterModel(), Utils.processError());
        });
    }

    function loadFilterFromGroup() {
        const groupName = queryEl(`${root}.save-entity-select`).value;
        DBMS.getGroup(groupName, (err, group) => {
            if (err) { Utils.handleError(err); return; }
            const conflictTypes =
                ProjectUtils.isFilterModelCompatibleWithProfiles(
                    state.filterConfiguration.getBaseProfileSettings(),
                    group.filterModel
                );
            if (conflictTypes.length !== 0) {
                Utils.alert(strFormat(getL10n('groups-base-filter-is-incompatible-with-page-profiles'), [conflictTypes.join(',')]));
                return;
            }
            applyFilterModel(group.filterModel);
            rebuildContent();
        });
    }

    function downloadFilterTable() {
        const el = queryEl(`${root}#profile-filter-columns .profile-item-selector`);
        const selected = [];
        for (let i = 0; i < el.options.length; i += 1) {
            selected[i] = el.options[i].selected;
        }

        const dataArrays = makePrintData();
        const cleanArrays = dataArrays.map(dataArray => dataArray.filter((item, index) => selected[index]).map(R.prop('value')));

        FileUtils.arr2d2Csv(cleanArrays, 'profileFilter');
    }

    function applyFilterModel(filterModel) {
        filterModel = CommonUtils.arr2map(filterModel, 'name');

        Object.keys(state.inputItems).forEach((inputItemName) => {
            if (inputItemName.endsWith(':numberInput') || inputItemName.endsWith(':multiEnumInput')) {
                return;
            }

            const inputItem = state.inputItems[inputItemName];
            let selectedOptions, regex, num, i, counter;

            if (state.checkboxes[inputItemName].checked !== (filterModel[inputItemName] !== undefined)) {
                state.checkboxes[inputItemName].click();
            }
            if (!filterModel[inputItemName]) {
                let select;
                switch (inputItem.selfInfo.type) {
                case 'enum':
                case 'checkbox':
                    for (i = 0; i < inputItem.options.length; i += 1) {
                        inputItem.options[i].selected = true;
                    }
                    break;
                case 'number':
                    state.inputItems[`${inputItem.selfInfo.name}:numberInput`].value = 0;
                    inputItem.value = 'ignore';
                    break;
                case 'multiEnum':
                    select = state.inputItems[`${inputItem.selfInfo.name}:multiEnumInput`];
                    for (i = 0; i < select.options.length; i += 1) {
                        select.options[i].selected = true;
                    }
                    inputItem.value = 'ignore';
                    break;
                case 'text':
                case 'string':
                    inputItem.value = '';
                    break;
                default:
                    throw new Error(`Unexpected type ${inputItem.selfInfo.type}`);
                }
            } else {
                const modelItem = filterModel[inputItemName];
                let select;
                switch (inputItem.selfInfo.type) {
                case 'enum':
                    for (i = 0; i < inputItem.options.length; i += 1) {
                        inputItem.options[i].selected = !!modelItem.selectedOptions[inputItem.options[i].value];
                    }
                    break;
                case 'checkbox':
                    inputItem.options[0].selected = modelItem.selectedOptions.true;
                    inputItem.options[1].selected = modelItem.selectedOptions.false;
                    break;
                case 'number':
                    inputItem.value = modelItem.condition;
                    state.inputItems[`${inputItem.selfInfo.name}:numberInput`].value = modelItem.num;
                    break;
                case 'multiEnum':
                    inputItem.value = modelItem.condition;
                    select = state.inputItems[`${inputItem.selfInfo.name}:multiEnumInput`];
                    for (i = 0; i < select.options.length; i += 1) {
                        select.options[i].selected = !!modelItem.selectedOptions[select.options[i].value];
                    }
                    break;
                case 'text':
                case 'string':
                    inputItem.value = modelItem.regexString;
                    break;
                default:
                    throw new Error(`Unexpected type ${inputItem.selfInfo.type}`);
                }
            }
        });
    }

    function makeFilterModel() {
        const model = [];
        Object.keys(state.inputItems).forEach((inputItemName) => {
            if (inputItemName.endsWith(':numberInput') || inputItemName.endsWith(':multiEnumInput')) {
                return;
            }
            if (state.checkboxes[inputItemName].checked === false) {
                return;
            }
            const inputItem = state.inputItems[inputItemName];
            let selectedOptions, regex, num, i, arr;
            const { type } = inputItem.selfInfo;

            let select2;
            switch (type) {
            case 'enum':
                arr = nl2array(inputItem.selectedOptions).map(R.prop('value'));
                model.push({ type, name: inputItemName, selectedOptions: R.zipObj(arr, R.repeat(true, arr.length)) });
                break;
            case 'checkbox':
                selectedOptions = {};
                if (inputItem.options[0].selected) { selectedOptions.true = true; }
                if (inputItem.options[1].selected) { selectedOptions.false = true; }
                model.push({ type, name: inputItemName, selectedOptions });
                break;
            case 'number':
                if (inputItem.value === 'ignore') { return; }
                num = Number(state.inputItems[`${inputItem.selfInfo.name}:numberInput`].value);
                model.push({
                    type, name: inputItemName, num, condition: inputItem.value
                });
                break;
            case 'multiEnum':
                if (inputItem.value === 'ignore') { return; }
                selectedOptions = {};
                select2 = state.inputItems[`${inputItem.selfInfo.name}:multiEnumInput`];
                arr = nl2array(select2.selectedOptions).map(R.prop('value'));
                model.push({
                    type,
                    name: inputItemName,
                    condition: inputItem.value,
                    selectedOptions: R.zipObj(arr, R.repeat(true, arr.length))
                });
                break;
            case 'text':
            case 'string':
                model.push({ type, name: inputItemName, regexString: inputItem.value.toLowerCase() });
                break;
            default:
                throw new Error(`Unexpected type ${type}`);
            }
        });
        return model;
    }

    function makeDataString(dataArray) {
        const { inputItems } = state;
        return addEls(makeEl('tr'), dataArray.map((valueInfo, i) => {
            let regex, pos, displayValue;
            const { value } = valueInfo;
            if (value === undefined) {
                displayValue = constL10n('notAvailable');
            } else if (valueInfo.type === 'checkbox') {
                displayValue = constL10n(Constants[value]);
            } else if (valueInfo.type === 'text') {
                pos = value.toLowerCase().indexOf(inputItems[valueInfo.itemName].value.toLowerCase());
                displayValue = value.substring(pos - 5, pos + 15);
            } else if (R.contains(valueInfo.type, ['number', 'enum', 'multiEnum', 'string'])) {
                displayValue = value;
            } else {
                throw new Error(`Unexpected valueInfo.type: ${valueInfo.type}`);
            }
            const td = addEl(setClassByCondition(makeEl('td'), 'lightGrey', value === undefined), makeText(displayValue));
            addClasses(td, [`dependent-${i}`, 'dependent', valueInfo.type === 'number' ? 'text-align-right' : 'text-align-left']);
            setAttr(td, 'dependent-index', i);
            return td;
        }));
    }

    function makeContentHeader(profileItemNames) {
        return addEls(makeEl('tr'), profileItemNames.map((elem, i) => {
            const td = addEls(makeEl('th'), [makeText(`${elem.displayName} `)]);
            td.info = elem.name;
            addClasses(td, [`dependent-${i}`, 'dependent', 'sorting', elem.type === 'number' ? 'text-align-right' : 'text-align-left']);
            setAttr(td, 'dependent-index', i);
            listen(td, 'click', onSortChange);
            return td;
        }));
    }

    function onSortChange(event) {
        let { target } = event;
        if (target.tagName.toLowerCase() === 'span') {
            target = target.parentElement;
        }

        if (state.sortKey === target.info) {
            state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
            setClassByCondition(target, 'sortDesc', state.sortDir === 'desc');
            setClassByCondition(target, 'sortAsc', state.sortDir === 'asc');
        } else {
            const filterHead = queryEl(`${root}.filter-head`);
            nl2array(filterHead.getElementsByClassName('sortAsc')).forEach(removeClass(R.__, 'sortAsc'));
            nl2array(filterHead.getElementsByClassName('sortDesc')).forEach(removeClass(R.__, 'sortDesc'));

            state.sortKey = target.info;
            state.sortDir = 'asc';
            addClass(target, 'sortAsc');
        }
        rebuildContent();
    }

    function makeInput(profileItemConfig) {
        const el = qmte(`${root} .filter-item-tmpl`);
        const checkbox = qee(el, 'input[type="checkbox"]');
        const id = "filter-item-" + profileItemConfig.displayName;
        checkbox.checked = false;
        checkbox.id = id;
        addEl(qee(el, '.filter-item-name'), makeText(profileItemConfig.displayName));
        setAttr(qee(el, 'label'), 'for', id);
        
        const inputContainer = qee(el, '.filter-item-container');
        listen(checkbox, 'click', toggleContent(el, inputContainer));
        state.checkboxes[profileItemConfig.name] = checkbox;
        
        addEl(inputContainer, makeFilter(profileItemConfig));
        return el;
    }
    
    function toggleContent(itemContainer, inputContainer) {
        return (event) => {
            hideEl(inputContainer, !event.target.checked);
            setClassByCondition(itemContainer, 'flex-front-element', event.target.checked);
            rebuildContent();
        };
    }

    function makeFilter(profileItemConfig) {
        switch (profileItemConfig.type) {
        case 'text':
        case 'string':
            return makeTextFilter(profileItemConfig);
        case 'enum':
            return makeEnumFilter(profileItemConfig);
        case 'multiEnum':
            return makeMultiEnumFilter(profileItemConfig);
        case 'number':
            return makeNumberFilter(profileItemConfig);
        case 'checkbox':
            return makeCheckboxFilter(profileItemConfig);
        default:
            throw new Error(`Unexpected type ${profileItemConfig.type}`);
        }
    }

    function makeTextFilter(profileItemConfig) {
        const input = qmte(`${root} .text-filter-tmpl`);
        input.selfInfo = profileItemConfig;
        input.value = '';
        input.addEventListener('input', rebuildContent);
        state.inputItems[profileItemConfig.name] = input;
        return input;
    }

    function makeCommonEnumFilter(profileItemConfig, values) {
        const selector = qmte(`${root} .common-enum-filter-tmpl`);
        selector.selfInfo = profileItemConfig;
        selector.size = values.length;

        fillSelector(selector, values.map((value) => {
            value.selected = true;
            return value;
        }));
        selector.addEventListener('change', rebuildContent);
        state.inputItems[profileItemConfig.name] = selector;
        return selector;
    }

    function makeEnumFilter(profileItemConfig) {
        const values = arr2Select(profileItemConfig.value.split(','));
        return makeCommonEnumFilter(profileItemConfig, values);
    }

    function makeCheckboxFilter(profileItemConfig) {
        const values = [{
            value: Constants.true,
            name: constL10n(Constants.true)
        }, {
            value: Constants.false,
            name: constL10n(Constants.false)
        }];
        return makeCommonEnumFilter(profileItemConfig, values);
    }

    function makeMultiEnumFilter(profileItemConfig) {
        const filter = qmte(`${root} .multi-enum-filter-tmpl`);
        const selector = qee(filter, '.multi-enum-filter-type');
        selector.selfInfo = profileItemConfig;

        Constants.multiEnumFilter.forEach((value) => {
            const option = makeEl('option');
            option.appendChild(makeText(constL10n(value)));
            option.value = value;
            selector.appendChild(option);
        });
        selector.selectedIndex = 0;
        state.inputItems[profileItemConfig.name] = selector;
        selector.addEventListener('change', rebuildContent);

        const selector2 = qee(filter, '.multi-enum-filter-content');
        const values = arr2Select(profileItemConfig.value.split(','));
        fillSelector(selector2, values.map((value) => {
            value.selected = true;
            return value;
        }));
        selector2.size = values.length;

        state.inputItems[`${profileItemConfig.name}:multiEnumInput`] = selector2;
        selector2.addEventListener('change', rebuildContent);
        return filter;
    }

    function makeNumberFilter(profileItemConfig) {
        const filter = qmte(`${root} .number-filter-tmpl`);
        const selector = qee(filter, 'select');
        selector.selfInfo = profileItemConfig;

        Constants.numberFilter.forEach((value) => {
            const option = makeEl('option');
            option.appendChild(makeText(constL10n(value)));
            option.value = value;
            selector.appendChild(option);
        });
        selector.selectedIndex = 0;
        state.inputItems[profileItemConfig.name] = selector;
        selector.addEventListener('change', rebuildContent);

        const input = qee(filter, 'input');
        input.value = 0;
        state.inputItems[`${profileItemConfig.name}:numberInput`] = input;
        input.addEventListener('input', rebuildContent);
        return filter;
    }

    function renameGroup(selector) {
        return dialog => () => {
            const toInput = qee(dialog, '.entity-input');
            const fromName = queryEl(selector).value;
            const toName = toInput.value.trim();

            DBMS.renameGroup(fromName, toName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    PermissionInformer.refresh((err2) => {
                        if (err2) { Utils.handleError(err2); return; }
                        toInput.value = '';
                        dialog.hideDlg();
                        exports.refresh();
                    });
                }
            });
        };
    }
})(this.ProfileFilter = {});

/*Copyright 2016 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    exports.init = () => {
        exports.content = getEl('aboutDiv');
    };

    exports.refresh = () => {
    };
})(this.About = {});

/*Copyright 2016 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.log-viewer-tab ';

    exports.init = () => {
        const pagination = clearEl(queryEl(`${root}.pagination`));
        addEls(pagination, R.range(0, 20).map((num) => {
            const a = setAttr(makeEl('a'), 'href', '#');
            const li = addEl(makeEl('li'), a);
            li.num = num;
            addEl(a, makeText(num + 1));
            listen(a, 'click', () => {
                getData({ target: { value: num } });
                const prevActive = queryEl(`${root}.pagination li.active`);
                if (prevActive !== null) {
                    removeClass(prevActive, 'active');
                }
                addClass(li, 'active');
            });
            return li;
        }));

        listen(queryEl(`${root}button.clear-filter`), 'click', () => {
            queryEls(`${root}input[filter]`).forEach(el => (el.value = ''));
            exports.refresh();
        });

        queryEls(`${root}input[filter]`).forEach(listen(R.__, 'input', exports.refresh));

        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        queryEls(`${root}.pagination li a`)[0].click();
    };

    function dataRecieved(err, data) {
        if (err) { Utils.handleError(err); return; }
        addEl(clearEl(queryEl(`${root}.result-number`)), makeText(L10n.format('log-viewer', 'total', [data.max])));

        const container = clearEl(queryEl(`${root}.log-data`));
        queryEls(`${root}.pagination li`).forEach(li => hideEl(li, li.num > data.logSize - 1));
        R.ap([addEl(container)], data.requestedLog.map(makeRow));
    }

    function getData(event) {
        const filter = R.fromPairs(queryEls(`${root}input[filter]`).map(el => [getAttr(el, 'filter'), el.value]));
        DBMS.getLog(Number(event.target.value), filter, dataRecieved);
    }

    function makeRow(rowData) {
        const addText = (text) => {
            return addEl(makeEl('td'), addEl(makeEl('span'), makeText(text)));
        };
        return addEls(makeEl('tr'), [
            addText(`${rowData[0]}`),
            addText(new Date(rowData[2]).format('yyyy/mm/dd HH:MM:ss')),
            addText(rowData[1]),
            addText(rowData[3]),
            
            addEls(makeEl('td'), JSON.parse(rowData[4]).map(item => {
                return addEl(addClass(makeEl('div'), 'log-param'), makeText(R.is(Object, item) ? JSON.stringify(item) : item));
            })),
            addEls(makeEl('td'), JSON.parse(rowData[5]).map(item => {
                return addEl(addClass(makeEl('div'), 'log-param'), makeText(R.is(Object, item) ? JSON.stringify(item) : item));
            })),
        ]);
    }
})(this.LogViewer = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, StoryCharacters
 */

'use strict';

((exports) => {
    const state = {};

    exports.init = () => {
        listen(getEl('networkSubsetsSelector'), 'change', onNetworkSubsetsChange);
    };

    exports.refresh = (parent) => {
        state.parent = parent;

        let selector = fillSelector(clearEl(getEl('networkSubsetsSelector')), constArr2Select(Constants.objectSubsets));
        [selector.value] = Constants.objectSubsets;
        onNetworkSubsetsChange({ target: selector });

        selector = fillSelector(
            clearEl(getEl('networkCharacterSelector')),
            state.parent.characterNames.sort(Utils.charOrdAObject).map(remapProps4Select)
        );
        setAttr(selector, 'size', selector.options.length > 15 ? 15 : selector.options.length);
        selector = fillSelector(
            clearEl(getEl('networkStorySelector')),
            state.parent.storyNames.sort(Utils.charOrdAObject).map(remapProps4Select)
        );
        setAttr(selector, 'size', selector.options.length > 15 ? 15 : selector.options.length);
    };

    exports.getStoryNames = () => {
        const { value } = getEl('networkSubsetsSelector');

        if (Constants.objectSubsets[0] === value) { // all objects
            return state.parent.storyNames.map(R.prop('value'));
        } else if (Constants.objectSubsets[1] === value) { // "selected characters"
            const primaryCharacters = nl2array(getEl('networkCharacterSelector').selectedOptions).map(R.prop('value'));
            const isPrimaryCharacter = R.contains(R.__, primaryCharacters);
            return R.values(state.parent.Stories)
                .filter(story => R.keys(story.characters).some(isPrimaryCharacter)).map(R.prop('name'));
        } else if (Constants.objectSubsets[2] === value) { //"selected stories"
            return nl2array(getEl('networkStorySelector').selectedOptions).map(R.prop('value'));
        }
        throw new Error(`Unexpected subsets selector: ${value}`);
    };

    exports.getCharacterNames = () => {
        const { value } = getEl('networkSubsetsSelector');

        if (Constants.objectSubsets[0] === value) { // all objects
            return state.parent.characterNames.map(R.prop('value'));
        } else if (Constants.objectSubsets[1] === value) { // "selected characters"
            // returns character and his neighbours
            const primaryCharacters = nl2array(getEl('networkCharacterSelector').selectedOptions).map(R.prop('value'));
            const isPrimaryCharacter = R.contains(R.__, primaryCharacters);
            const secondaryCharacters = R.values(state.parent.Stories)
                .filter(story => R.keys(story.characters).some(isPrimaryCharacter))
                .map(story => story.events.filter(event => R.keys(event.characters).some(isPrimaryCharacter))
                    .map(event => R.keys(event.characters).filter(name => !isPrimaryCharacter(name))));
            return primaryCharacters.concat(R.uniq(R.flatten(secondaryCharacters)));
        } else if (Constants.objectSubsets[2] === value) { //"selected stories"
            const stories = nl2array(getEl('networkStorySelector').selectedOptions).map(R.prop('value'));
            return R.uniq(R.flatten(stories.map(storyName => R.keys(state.parent.Stories[storyName].characters))));
        }
        throw new Error(`Unexpected subsets selector: ${value}`);
    };

    function onNetworkSubsetsChange(event) {
        const selectedSubset = event.target.value;
        hideEl(getEl('networkCharacterDiv'),  selectedSubset !== Constants.objectSubsets[1]);
        hideEl(getEl('networkStoryDiv'), selectedSubset !== Constants.objectSubsets[2]);
    }
})(this.NetworkSubsetsSelector = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS, StoryCharacters
 */

'use strict';

((exports) => {
    const state = {};

    const STORY_PREFIX = 'St:';
    const CHAR_PREFIX = 'Ch:';
    const PROFILE_GROUP = 'prof-';
    const FILTER_GROUP = 'filter-';

    exports.init = () => {
        NetworkSubsetsSelector.init();

        listen(getEl('networkNodeGroupSelector'), 'change', colorNodes);
        listen(getEl('showPlayerNamesCheckbox'), 'change', updateNodeLabels);
        listen(getEl('drawNetworkButton'), 'click', onDrawNetwork);
        $('#nodeFocusSelector').select2().on('change', onNodeFocus);
        listen(getEl('networkSelector'), 'change', onNetworkSelectorChangeDelegate);

        queryEls('#activityBlock button').forEach(listen(R.__, 'click', event => toggleClass(event.target, 'btn-primary')));
        queryEls('#relationsBlock button').forEach(listen(R.__, 'click', event => toggleClass(event.target, 'btn-primary')));

        //        state.network;
        state.highlightActive = false;

        initWarning();
        L10n.onL10nChange(initWarning);

        //    TimelinedNetwork.init();

        exports.content = getEl('socialNetworkDiv');
    };

    function initWarning() {
        const warning = clearEl(getEl('socialNetworkWarning'));
        const button = addEl(makeEl('button'), makeText(getL10n('social-network-remove-resources-warning')));
        addEls(warning, [makeText(getL10n('social-network-require-resources-warning')), button]);
        listen(button, 'click', () => addClass(warning, 'hidden'));
    }

    const nodeSort = CommonUtils.charOrdAFactory(a => a.label.toLowerCase());

    exports.refresh = () => {
        let selector = fillSelector(clearEl(getEl('networkSelector')), constArr2Select(Constants.networks));
        [selector.value] = Constants.networks;
        onNetworkSelectorChangeDelegate({ target: selector });

        selector = clearEl(getEl('networkNodeGroupSelector'));

        PermissionInformer.getEntityNamesArray('character', false, (err1, characterNames) => { // subset selector
            if (err1) { Utils.handleError(err1); return; }
            PermissionInformer.getEntityNamesArray('story', false, (err2, storyNames) => { // subset selector
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getAllProfiles('character', (err3, profiles) => { // node coloring
                    if (err3) { Utils.handleError(err3); return; }
                    DBMS.getAllStories((err4, stories) => { // contains most part of SN data
                        if (err4) { Utils.handleError(err4); return; }
                        DBMS.getProfileStructure('character', (err5, profileStructure) => { // node coloring
                            if (err5) { Utils.handleError(err5); return; }
                            DBMS.getProfileBindings((err6, profileBindings) => { // node coloring
                                if (err6) { Utils.handleError(err6); return; }
                                DBMS.getGroupCharacterSets((err7, groupCharacterSets) => { // node coloring
                                    if (err7) { Utils.handleError(err7); return; }
                                    DBMS.getMetaInfo((err8, metaInfo) => { // timelined network
                                        if (err8) { Utils.handleError(err8); return; }
                                        DBMS.getRelations((err9, relations) => { // relations
                                            if (err9) { Utils.handleError(err9); return; }

                                            state.Stories = stories;
                                            state.Characters = profiles;
                                            state.profileBindings = profileBindings;
                                            state.groupCharacterSets = groupCharacterSets;
                                            state.metaInfo = metaInfo;
                                            state.relations = relations;

                                            const checkboxes = profileStructure.filter(element =>
                                                R.equals(element.type, 'checkbox'));
                                            R.values(profiles).forEach((profile) => {
                                                checkboxes.map(item => (profile[item.name] =
                                                    constL10n(Constants[profile[item.name]])));
                                            });

                                            const colorGroups = profileStructure.filter(element =>
                                                R.contains(element.type, ['enum', 'checkbox']));
                                            const defaultColorGroup = {
                                                value: Constants.noGroup,
                                                name: constL10n(Constants.noGroup)
                                            };

                                            const profileLabel = strFormat(getL10n('social-network-profile-group'));
                                            const filterLabel = strFormat(getL10n('social-network-filter-group'));

                                            const profileGroups = colorGroups.map(group => group.name).map(name =>
                                                ({ value: PROFILE_GROUP + name, name: profileLabel([name]) }));
                                            const filterGroups = R.keys(groupCharacterSets).map(name =>
                                                ({ value: FILTER_GROUP + name, name: filterLabel([name]) }));
                                            fillSelector(
                                                selector,
                                                [defaultColorGroup].concat(profileGroups).concat(filterGroups)
                                            );

                                            initGroupColors(colorGroups);

                                            NetworkSubsetsSelector.refresh({
                                                characterNames,
                                                storyNames,
                                                Stories: stories
                                            });
                                            //                            onDrawNetwork();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    };

    function initGroupColors(colorGroups) {
        state.groupColors = R.clone(Constants.snFixedColors);
        state.groupLists = {};

        colorGroups.forEach((group) => {
            if (group.type === 'enum') {
                state.groupLists[PROFILE_GROUP + group.name] = group.value.split(',').map((subGroupName, i) => {
                    state.groupColors[`${PROFILE_GROUP + group.name}.${subGroupName.trim()}`] =
                        Constants.colorPalette[i+2];
                    return `${PROFILE_GROUP + group.name}.${subGroupName.trim()}`;
                });
            } else if (group.type === 'checkbox') {
                const trueName = constL10n(Constants.true);
                const falseName = constL10n(Constants.false);
                state.groupColors[`${PROFILE_GROUP + group.name}.${trueName}`] =
                    Constants.colorPalette[group.value ? 0+2 : 1+2];
                state.groupColors[`${PROFILE_GROUP + group.name}.${falseName}`] =
                    Constants.colorPalette[group.value ? 1+2 : 0+2];
                state.groupLists[PROFILE_GROUP + group.name] =
                    [`${PROFILE_GROUP + group.name}.${trueName}`, `${PROFILE_GROUP + group.name}.${falseName}`];
            } else {
                throw new Error(`Unexpected profile item type: ${group.type}`);
            }
        });
    }

    function makeLegendItem(label, color) {
        const colorDiv = addEl(makeEl('div'), makeText(label));
        colorDiv.style.backgroundColor = color.background;
        colorDiv.style.border = `solid 2px ${color.border}`;
        return colorDiv;
    }

    function refreshLegend(groupName) {
        const colorLegend = clearEl(getEl('colorLegend'));
        let els = [];

        if (groupName === 'noGroup') {
            els.push(makeLegendItem(constL10n('noGroup'), Constants.snFixedColors.noGroup.color));
        } else if (CommonUtils.startsWith(groupName, PROFILE_GROUP)) {
            els = els.concat(state.groupLists[groupName].map(value =>
                makeLegendItem(value.substring(PROFILE_GROUP.length), state.groupColors[value].color)));
        } else if (CommonUtils.startsWith(groupName, FILTER_GROUP)) {
            els.push(makeLegendItem(constL10n('noGroup'), Constants.snFixedColors.noGroup.color));
            els.push(makeLegendItem(constL10n('fromGroup'), Constants.snFixedColors.fromGroup.color));
        } else {
            throw new Error(`Unexpected group name/type: ${groupName}`);
        }

        if (['characterPresenceInStory', 'characterActivityInStory'].indexOf(state.selectedNetwork) !== -1) {
            els.push(makeLegendItem(getL10n('social-network-story'), Constants.snFixedColors.storyColor.color));
        }
        addEls(colorLegend, els);
    }

    function colorNodes(event) {
        const groupName = event.target.value;
        refreshLegend(groupName);
        if (state.nodesDataset === undefined) return;

        NetworkSubsetsSelector.getCharacterNames().forEach((characterName) => {
            state.nodesDataset.update({
                id: CHAR_PREFIX + characterName,
                group: getNodeGroup(characterName, groupName)
            });
        });
    }

    function getNodeGroup(characterName, groupName) {
        if (groupName === 'noGroup') {
            return groupName;
        } else if (CommonUtils.startsWith(groupName, PROFILE_GROUP)) {
            const character = state.Characters[characterName];
            return `${groupName}.${character[groupName.substring(PROFILE_GROUP.length)]}`;
        } else if (CommonUtils.startsWith(groupName, FILTER_GROUP)) {
            return state.groupCharacterSets[groupName.substring(FILTER_GROUP.length)][characterName] ? 'fromGroup' : 'noGroup';
        }
        throw new Error(`Unexpected group name: ${groupName}`);
    }

    function updateNodeLabels() {
        if (state.nodesDataset === undefined) return;
        const showPlayer = getEl('showPlayerNamesCheckbox').checked;
        const allNodes = state.nodesDataset.get({
            returnType: 'Object'
        });

        R.values(allNodes).filter(node => node.type === 'character').forEach((node) => {
            const label = makeCharacterNodeLabel(showPlayer, node.originName);
            if (node.label !== undefined) {
                node.label = label;
            } else if (node.hiddenLabel !== undefined) {
                node.hiddenLabel = label;
            } else {
                console.log(`Suspicious node: ${JSON.stringify(node)}`);
            }
        });

        state.nodesDataset.update(R.values(allNodes));
    }

    function onNetworkSelectorChangeDelegate(event) {
        hideEl(getEl('activityBlock'), event.target.value !== 'characterActivityInStory');
        queryEls('#activityBlock button').forEach(el => addClass(el, 'btn-primary'));
        hideEl(getEl('relationsBlock'), event.target.value !== 'characterRelations');
        queryEls('#relationsBlock button').forEach(el => addClass(el, 'btn-primary'));
    }

    function onNodeFocus(event) {
        state.network.focus(event.target.value, Constants.snFocusOptions);
    }

    function onDrawNetwork() {
        onNetworkSelectorChange(getEl('networkSelector').value);
    //    TimelinedNetwork.refresh(state.network, state.nodesDataset,
    //            state.edgesDataset, getEventDetails(), state.metaInfo);
    }

    function onNetworkSelectorChange(selectedNetwork) {
        state.selectedNetwork = selectedNetwork;
        let nodes = [];
        let edges = [];

        switch (selectedNetwork) {
        case 'socialRelations':
            nodes = getCharacterNodes();
            edges = getDetailedEdges();
            break;
        case 'characterPresenceInStory':
            nodes = getCharacterNodes().concat(getStoryNodes());
            edges = getStoryEdges();
            break;
        case 'characterActivityInStory':
            nodes = getCharacterNodes().concat(getStoryNodes());
            edges = getActivityEdges();
            break;
        case 'characterRelations':
            nodes = getCharacterNodes();
            edges = getRelationEdges();
            break;
        default:
            throw new Error(`Unexpected network type: ${selectedNetwork}`);
        }

        refreshLegend(getEl('networkNodeGroupSelector').value);

        clearEl(getEl('nodeFocusSelector'));
        nodes.sort(nodeSort);

        const data = getSelect2DataCommon(remapProps(['id', 'text'], ['id', 'originName']), nodes);
        $('#nodeFocusSelector').select2(data);

        state.nodesDataset = new vis.DataSet(nodes);
        state.edgesDataset = new vis.DataSet(edges);

        redrawAll();
    }

    function makeCharacterNodeLabel(showPlayer, characterName) {
        const label = characterName.split(' ').join('\n');
        if (showPlayer) {
            const player = state.profileBindings[characterName] || '';
            return `${label}/\n${player}`;
        }
        return label;
    }

    function getCharacterNodes() {
        const groupName = getEl('networkNodeGroupSelector').value;
        const showPlayer = getEl('showPlayerNamesCheckbox').checked;
        return NetworkSubsetsSelector.getCharacterNames().map((characterName) => {
            const profile = state.Characters[characterName];
            return {
                id: CHAR_PREFIX + characterName,
                label: makeCharacterNodeLabel(showPlayer, characterName),
                type: 'character',
                originName: characterName,
                group: groupName === 'noGroup' ? constL10n('noGroup') : `${groupName}.${profile[groupName]}`
            };
        });
    }

    function getStoryNodes() {
        const nodes = NetworkSubsetsSelector.getStoryNames().map(name => ({
            id: STORY_PREFIX + name,
            label: name.split(' ').join('\n'),
            value: Object.keys(state.Stories[name].characters).length,
            title: Object.keys(state.Stories[name].characters).length,
            group: 'storyColor',
            type: 'story',
            originName: name,
        }));
        return nodes;
    }

    function getActivityEdges() {
        const selectedActivities = queryEls('#activityBlock button.btn-primary').map(getAttr(R.__, 'data-value'));
        const stories = state.Stories;
        return R.flatten(R.keys(stories).map(name => R.keys(stories[name].characters)
            .map(char1 => R.keys(stories[name].characters[char1].activity).filter(R.contains(R.__, selectedActivities))
                .map(activity => ({
                    from: STORY_PREFIX + name,
                    to: CHAR_PREFIX + char1,
                    color: Constants.snActivityColors[activity],
                    width: 2,
                    hoverWidth: 4
                })))));
    }

    function getRelationEdges() {
        const selectedRelations = queryEls('#relationsBlock button.btn-primary').map(getAttr(R.__, 'data-value'));
        const { relations } = state;
        const checked = R.contains(R.__, selectedRelations);
        return R.flatten(relations.map((rel) => {
            const arr = [];
            const { starter } = rel;
            const { ender } = rel;
            const edgeTmpl = {
                from: CHAR_PREFIX + starter,
                to: CHAR_PREFIX + ender,
                color: Constants.snRelationColors.neutral,
                width: 2,
                hoverWidth: 4
            };
            if (rel.essence.length === 0) {
                if (checked('neutral')) {
                    arr.push(R.merge(edgeTmpl, {
                        color: Constants.snRelationColors.neutral,
                    }));
                }
            } else {
                if (checked('allies') && R.contains('allies', rel.essence)) {
                    arr.push(R.merge(edgeTmpl, {
                        color: Constants.snRelationColors.allies,
                    }));
                }
                if (checked('directional') && R.contains('starterToEnder', rel.essence)) {
                    arr.push(R.merge(edgeTmpl, {
                        color: Constants.snRelationColors.starterToEnder,
                        arrows: 'to'
                    }));
                }
                if (checked('directional') && R.contains('enderToStarter', rel.essence)) {
                    arr.push(R.merge(edgeTmpl, {
                        color: Constants.snRelationColors.enderToStarter,
                        arrows: 'from'
                    }));
                }
            }
            return arr;
        }));
    }

    function getStoryEdges() {
        return R.flatten(R.keys(state.Stories).map(name => R.keys(state.Stories[name].characters).map(char1 => ({
            from: STORY_PREFIX + name,
            to: CHAR_PREFIX + char1,
            color: 'grey'
        }))));
    }

    function getEventDetails() {
        return R.flatten(R.values(state.Stories).map(story => story.events.map(event => ({
            eventName: event.name,
            storyName: story.name,
            time: event.time,
            characters: R.keys(event.characters)
        }))));
    }

    function getDetailedEdges() {
        const edgesCheck = {};
        R.values(state.Stories).forEach((story) => {
            story.events.forEach((event) => {
                const charNames = R.keys(event.characters).sort();
                charNames.forEach((char1, i) => {
                    charNames.forEach((char2, j) => {
                        if (i <= j) {
                            return;
                        }
                        const key = char1 + char2;
                        if (!edgesCheck[key]) {
                            edgesCheck[key] = {
                                from: CHAR_PREFIX + char1,
                                to: CHAR_PREFIX + char2,
                                title: {},
                            };
                        }
                        edgesCheck[key].title[story.name] = true;
                    });
                });
            });
        });

        return R.values(edgesCheck).map((edgeInfo) => {
            const title = R.keys(edgeInfo.title).sort().join(', ');
            const value = R.keys(edgeInfo.title).length;
            return {
                from: edgeInfo.from,
                to: edgeInfo.to,
                title: `${value}: ${title}`,
                value,
                color: 'grey'
            };
        });
    }

    function redrawAll() {
        const container = getEl('socialNetworkContainer');

        const data = {
            nodes: state.nodesDataset,
            edges: state.edgesDataset
        }; // Note: data is coming from ./datasources/WorldCup2014.js

        if (state.network) {
            state.network.destroy();
        }

        const opts = CommonUtils.clone(Constants.socialNetworkOpts);
        opts.groups = state.groupColors;

        state.network = new vis.Network(container, data, opts);

        state.network.on('click', neighbourhoodHighlight);
    }

    function hideLabel(node) {
        if (node.hiddenLabel === undefined) {
            node.hiddenLabel = node.label;
            node.label = undefined;
        }
    }
    function showLabel(node) {
        if (node.hiddenLabel !== undefined) {
            node.label = node.hiddenLabel;
            node.hiddenLabel = undefined;
        }
    }

    function highlightNodes(network, allNodes, zeroDegreeNodes, firstDegreeNodes) {
        // get the second degree nodes
        const secondDegreeNodes = R.uniq(R.flatten(firstDegreeNodes.map(id => network.getConnectedNodes(id))));
        // mark all nodes as hard to read.
        R.values(allNodes).forEach((node) => {
            node.color = 'rgba(200,200,200,0.5)';
            hideLabel(node);
        });
        // all second degree nodes get a different color and their label back
        secondDegreeNodes.map(id => allNodes[id]).forEach((node) => {
            node.color = 'rgba(150,150,150,0.75)';
            showLabel(node);
        });
        // all first degree nodes get their own color and their label back
        firstDegreeNodes.map(id => allNodes[id]).forEach((node) => {
            node.color = undefined;
            showLabel(node);
        });
        // the main node gets its own color and its label back.
        zeroDegreeNodes.map(id => allNodes[id]).forEach((node) => {
            node.color = undefined;
            showLabel(node);
        });
    }

    function neighbourhoodHighlight(params) {
        // get a JSON object
        const allNodes = state.nodesDataset.get({
            returnType: 'Object'
        });

        const { network } = state;
        if (params.nodes.length > 0) {
            state.highlightActive = true;
            const selectedNode = params.nodes[0];
            const zeroDegreeNodes = [selectedNode];
            const firstDegreeNodes = network.getConnectedNodes(selectedNode);
            highlightNodes(network, allNodes, zeroDegreeNodes, firstDegreeNodes);
        } else if (params.edges.length > 0) {
            state.highlightActive = true;
            const selectedEdge = params.edges[0];
            const firstDegreeNodes = network.getConnectedNodes(selectedEdge);
            highlightNodes(network, allNodes, [], firstDegreeNodes);
        } else if (state.highlightActive === true) {
            // reset all nodes
            R.values(allNodes).forEach((node) => {
                node.color = undefined;
                showLabel(node);
            });
            state.highlightActive = false;
        }

        // transform the object into an array
        state.nodesDataset.update(R.values(allNodes));
    }
})(this.SocialNetwork = {});

//"use strict";
//
//(function(exports){
//
////    var cameraInitPos = new THREE.Vector3(-30, 40, 30).multiplyScalar(2.5);
////    var cameraInitPos = new THREE.Vector3(0, 40, 40).multiplyScalar(2.5);
////    var cameraInitPos = new THREE.Vector3(0, 0, 40).multiplyScalar(2.5);
//    var cameraInitPos = new THREE.Vector3(0, 0, 60).multiplyScalar(2.5);
//    var basicZScale = 25;
//    var spotLightInitPos = new THREE.Vector3(0, 0, 50);
//
//    // three.js
//    var camera;
//    var scene;
//    var renderer;
//    var controls;
//    var stats;
//
//    function initStats() {
//        var stats = new Stats();
//        stats.setMode(0); // 0: fps, 1: ms
//        addEl(clearEl(getEl("Stats-output")), stats.domElement);
//        return stats;
//    };
//
//    function init(){
//        // create a render and set the size
//        renderer = new THREE.WebGLRenderer();
//        renderer.setClearColor(new THREE.Color(0xEEEEEE, 1.0));
//        addEl(clearEl(getEl("WebGL-output")), renderer.domElement);
//
//        stats = initStats();
//
//        controls = new function () {
//            this.rotationSpeed = 0.08;
////            this.bouncingSpeed = 0.03;
//            this.zScale = basicZScale;
//            this.planeScale = 10;
//            this.cameraZ = 120;
////            this.cameraRotX = 0;
////            this.cameraRotY = 0;
////            this.cameraRotZ = 0;
//
//            this.outputObjects = function () {
//                console.log(scene.children);
//            }
//        };
//
//
//        var gui = new dat.GUI({ autoPlace: false });
//        gui.add(controls, 'rotationSpeed', 0, 0.5);
////        gui.add(controls, 'bouncingSpeed', 0, 0.5);
//        gui.add(controls, 'zScale', 1, 100);
//        gui.add(controls, 'planeScale', 1, 100);
//        gui.add(controls, 'cameraZ', -500, 500);
////        gui.add(controls, 'cameraRotX', -1, 1);
////        gui.add(controls, 'cameraRotY', -1, 1);
////        gui.add(controls, 'cameraRotZ', -1, 1);
//
//        gui.add(controls, 'outputObjects');
//
//        addEl(getEl('gui-settings-output'), gui.domElement);
//    //    renderer.shadowMapEnabled = true;
//    };
//
//    var isFirstRefresh = true;
//
//    // once everything is loaded, we run our Three.js stuff.
//    function refresh(network, nodes, edges, eventDetails, metaInfo) {
//
//        var lowerTimeBoundary = new Date(metaInfo.preGameDate).getTime();
//        var upperTimeBoundary = new Date(metaInfo.date).getTime();
//        var timeDiff = upperTimeBoundary - lowerTimeBoundary;
//        console.log(lowerTimeBoundary);
//        console.log(upperTimeBoundary);
//        console.log(timeDiff);
//
//        var characterEvents = {};
//        var storyEvents = {};
//        eventDetails.forEach(function(eventInfo){
//            if(eventInfo.time === ''){
//                eventInfo.time = metaInfo.date;
//            }
//            eventInfo.scaledTime = (new Date(eventInfo.time).getTime() - lowerTimeBoundary) / timeDiff;
//            console.log(eventInfo.scaledTime);
//            storyEvents[eventInfo.storyName] = storyEvents[eventInfo.storyName] || {events: []};
//            storyEvents[eventInfo.storyName].events.push(eventInfo);
//            eventInfo.characters.forEach(function(character){
//                characterEvents[character] = characterEvents[character] || {events: []};
//                characterEvents[character].events.push(eventInfo);
//            });
//        });
//        console.log(storyEvents);
//        console.log(characterEvents);
//        function fillMinMax(objInfo){
//            objInfo.minTime = R.reduce(R.min, Infinity, objInfo.events.map(R.prop('scaledTime')));
//            objInfo.maxTime = R.reduce(R.max, -Infinity, objInfo.events.map(R.prop('scaledTime')));
//        }
//        R.values(storyEvents).forEach(fillMinMax);
//        R.values(characterEvents).forEach(fillMinMax);
//        console.log(storyEvents);
//        console.log(characterEvents);
//
//        var sizes = updateRendererSize();
////        if(isFirstRefresh){
//        // create a scene, that will hold all our elements such as objects, cameras and lights.
//        scene = new THREE.Scene();
//
//        // create a camera, which defines where we're looking at.
//        camera = new THREE.PerspectiveCamera(45, sizes.width / sizes.height, 0.1, 1000);
//
////        var orbitControls = new THREE.OrbitControls(camera);
//////        orbitControls.autoRotate = true;
////        var clock = new THREE.Clock();
//
//        // show axes in the screen
//        var axes = new THREE.AxisHelper(20);
//        scene.add(axes);
//
//        // create the ground plane
//        var planeGeometry = new THREE.PlaneGeometry(60, 20, 1, 1);
//        var planeMaterial = new THREE.MeshBasicMaterial({color: 0xffffff, opacity: 0});
//        var plane = new THREE.Mesh(planeGeometry, planeMaterial);
//        //    plane.receiveShadow = true;
//
//        // rotate and position the plane
//        plane.rotation.x = -0.5 * Math.PI;
//        plane.position.x = 15;
//        plane.position.y = 0;
//        plane.position.z = 0;
//
//        // add the plane to the scene
//        scene.add(plane);
//
//        // position and point the camera to the center of the scene
//        camera.position.copy(cameraInitPos);
//        camera.lookAt(new THREE.Vector3(0, 0, 0));
//        camera.position.add(new THREE.Vector3(0, -100, 0));
//        camera.lookAt(new THREE.Vector3(0, 0, 0));
////        camera.rotation.z =  Math.PI;
////        camera.lookAt(scene.position);
//
////        camera.rotateOnAxis(cameraInitPos.normalize() , 0.6);
////        camera.rotation.z = 0.75 * Math.PI;
//
////        camera.position.x = -30;
////        camera.position.y = 40;
////        camera.position.z = 30;
//
//        // add subtle ambient lighting
//        var ambientLight = new THREE.AmbientLight(0x0c0c0c);
//        scene.add(ambientLight);
//
//        // add spotlight for the shadows
//        var spotLight = new THREE.SpotLight(0xffffff);
//        spotLight.position.copy(spotLightInitPos);
//        //    spotLight.castShadow = true;
//        scene.add(spotLight);
////            isFirstRefresh = false;
////        }
//
//        // call the render function
//        var step = 0;
//
//        var isInitialized = false;
////        if(isFirstRefresh){
//            render();
////            isFirstRefresh = false;
////        }
////        network.storePositions();
//
//        function getEventInfo(id){
//            if(id.startsWith('St:')){
//                return storyEvents[id.substring(3)];
//            } else {
//                return characterEvents[id];
//            }
//        };
//
//        function render() {
//            stats.update();
//            network.storePositions();
//            if(!isInitialized){
//                console.log(nodes.get());
//                console.log(edges.get());
//                nodes.get().forEach(function(node){
//                    var eventInfo = getEventInfo(node.id);
//
//                    if(eventInfo){
//                        var height = eventInfo.maxTime - eventInfo.minTime;
//                        var z = (eventInfo.maxTime + eventInfo.minTime)/2;
//                        addCylinder(node.x/10,-node.y/10, z*basicZScale, height, 0.5, String('cyl-' + node.id));
////                        addCylinder(0,0,0, 2, 0.5, String('cyl-' + node.id));
////                        addCylinder(node.x/10,-node.y/10, -5, height, 3, String(node.id + '0'));
//                    }
////                    addCylinder(node.x/10,-node.y/10, 4, String(node.id + '1-top'));
//                });
//
//                isInitialized = true;
//            } else {
//                nodes.get().forEach(function(node){
//                    var cyl = scene.getObjectByName(String('cyl-' + node.id));
//                    if(cyl){
//                        cyl.position.x = node.x/10;
//                        cyl.position.y = -node.y/10;
//                    }
////                    cyl = scene.getObjectByName(String(node.id + '1-top'));
////                    cyl.position.x = node.x/10;
////                    cyl.position.y = -node.y/10;
//                });
//            }
//
//            scene.traverse(function (e) {
//                if (e instanceof THREE.Mesh && e.name.startsWith('cyl-')) {
////                    e.position.y = controls.zScale;
//                    var eventInfo = getEventInfo(e.name.substring(4));
////                    if(eventInfo){
//                        e.position.z = (eventInfo.maxTime + eventInfo.minTime)/2 * controls.zScale;
////                        e.setHeight((eventInfo.maxTime - eventInfo.minTime) * controls.zScale);
////                    } else {
////                        console.log(e.name);
////                    }
//                    e.scale.y = controls.zScale;
//                }
//            });
//
//            var nowTime = Date.now();
//            var multip = 0.005;
//            camera.position.x = 50*Math.sin(nowTime*controls.rotationSpeed*multip);
//            camera.position.y = 50*Math.cos(nowTime*controls.rotationSpeed*multip);
//            camera.position.z = controls.cameraZ;
//            camera.lookAt(new THREE.Vector3(0, 0, 0));
////            scene.traverse(function (e) {
////                if (e instanceof THREE.Mesh && e.name.endsWith('1-top')) {
//////                    e.position.y = controls.zScale;
////                    e.position.z = controls.zScale;
////                }
////            });
//
////            var delta = clock.getDelta();
////            orbitControls.update(delta);
//
////            camera.rotateOnAxis(cameraInitPos.normalize() , controls.cameraRotX);
////            camera.rotateOnAxis(camera.getWorldDirection().normalize() , controls.cameraRotX);
////            camera.rotation.copy(new THREE.Vector3(controls.cameraRotX,
////                controls.cameraRotY, controls.cameraRotZ).multiplyScalar(Math.PI));
////            camera.rotation.x = controls.cameraRotX * Math.PI;
//
//            // render using requestAnimationFrame
//            requestAnimationFrame(render);
//            renderer.render(scene, camera);
//        }
//
//    }
//
//    function updateRendererSize(){
//        var styles = getComputedStyle(getEl('socialNetworkContainer'));
//        var width = styles.width.split('px').join('') * 0.75;
//        var height = styles.height.split('px').join('') * 0.75;
//        renderer.setSize(width, height);
//        return {
//            width: width,
//            height: height,
//        }
//    }
//    function onResize() {
//        if(camera && renderer){
//            var sizes = updateRendererSize();
//            camera.aspect = sizes.width / sizes.height;
//            camera.updateProjectionMatrix();
//        }
//    }
//
//    function addCylinder(x, y, z, height, radius, id) {
//
//        var geometry = new THREE.CylinderGeometry( radius, radius, height, 32 );
//        var material = new THREE.MeshLambertMaterial( {color: 0x7777ff} );
//        var cylinder = new THREE.Mesh( geometry, material );
//        cylinder.name = id;
//
//        cylinder.position.x = x;
//        cylinder.position.y = y;
//        cylinder.position.z = z;
//        cylinder.rotation.x = -0.5 * Math.PI;
////        cylinder.position.y = z;
////        cylinder.position.z = y;
//
//    //    cylinder.position.x = 40;
//
//        scene.add( cylinder );
//
//    };
//
//    exports.init = init;
//    exports.refresh = refresh;
////    window.onload = init;
//
//    // listen to the resize events
//    window.addEventListener('resize', onResize, false);
//
//
//})(this['TimelinedNetwork']={});

/*Copyright 2015-2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 jQuery, DBMS
 */

'use strict';


((exports) => {
    const defaultHists = ['storyEventsHist', 'storyCharactersHist', 'eventCompletenessHist',
        'characterSymbolsHist', 'characterStoriesHist'];
    const entityCharts = ['characterChart', 'playerChart', 'storyChart', 'groupChart'];

    const statisticKeys = [
        'characterNumber',
        'playerNumber',
        'storyNumber',
        'groupNumber',
        'eventsNumber',
        'userNumber',
        'textCharacterNumber',
        'lastEvent',
        'firstEvent',
    ];

    const root = '.overview-tab ';
    const state = {};

    state.Charts = {};

    exports.init = () => {
        state.name = getEl('gameNameInput');
        state.name.addEventListener('change', updateName);

        state.lastSaveTime = getEl('lastSaveTime');

        state.date = getEl('gameDatePicker');

        let opts = {
            lang: L10n.getLang(),
            mask: true,
            onChangeDateTime: updateTime
        };

        jQuery(state.date).datetimepicker(opts);

        state.preDate = getEl('preGameDatePicker');

        opts = {
            lang: L10n.getLang(),
            mask: true,
            onChangeDateTime: updatePreGameDate
        };

        jQuery(state.preDate).datetimepicker(opts);

        L10n.onL10nChange(() => {
            jQuery(state.date).datetimepicker({
                lang: L10n.getLang()
            });
            jQuery(state.preDate).datetimepicker({
                lang: L10n.getLang()
            });
        });

        state.descr = queryEl(`${root}.game-description-area`);
        state.descr.addEventListener('change', updateDescr);
        
        const gearsContainer = qee(queryEl(root), '#gears');
        addEl(gearsContainer, qe('.gears-tab'));
        Gears.init();
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.attributeName === "class") {
                    if(hasClass(gearsContainer, 'active')) {
                        Gears.refresh();
                    }
                }
            });
        });
        observer.observe(gearsContainer, {
            attributes: true
        });
        
        const slidersContainer = qee(queryEl(root), '#sliders');
        addEl(slidersContainer, qe('.sliders-tab'));
        Sliders.init();

        exports.content = queryEl(root);
    };
    
    exports.refresh = () => {
        Gears.refresh();
        Sliders.refresh();
        PermissionInformer.isAdmin((err, isAdmin) => {
            if (err) { Utils.handleError(err); return; }
            Utils.enable(exports.content, 'adminOnly', isAdmin);
        });
        
        Promise.all( [DBMS.getMetaInfoPm(), DBMS.getStatisticsPm()] ).then(updateOverviewTab).catch(Utils.handleError);
    };

    function makeChart(id, canvas, data) {
        if (state.Charts[id]) {
            state.Charts[id].destroy();
        }

        const labels = [];
        const dataset = {
            data: [],
            backgroundColor: [],
            hoverBackgroundColor: []
        };
        data.forEach((item, i) => {
            if (Constants.colorPalette[i]) {
                labels.push(item.label);
                dataset.data.push(item.value);
                dataset.backgroundColor.push(Constants.colorPalette[i].color.background);
                dataset.hoverBackgroundColor.push(Constants.colorPalette[i].color.hover.background);
            }
        });

        const ctx = canvas.getContext('2d');
        state.Charts[id] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [dataset]
            },
            options: {
                animation: {
                    animateRotate: false
                },
                responsive: false,
                legend: {
                    display: false,
                },
                tooltips: {
                    enabled: false,
                    custom: customTooltips
                }
            },
        });
    }

    function makeHistogram(place, data) {
        let max = null;
        data.forEach((barData) => {
            if (barData) {
                if (max === null || barData.value > max) {
                    max = barData.value;
                }
            }
        });
        data.forEach((barData) => {
            if (barData) {
                // barData.normValue = (barData.value - min)/(max-min);
                //      barData.normValue = (barData.value - 0)/(max-0);
                barData.normValue = (((barData.value - 0) / (max - 0)) * 0.9) + 0.1;
            }
        });

        let div;
        data.forEach((barData) => {
            div = barData === null ? makeEl('div') : addEl(makeEl('div'), makeText(barData.value));
            addClass(div, 'bar');
            if (barData) {
                div.style.height = `${barData.normValue * 100}%`;
                $(div).tooltip({
                    title: barData.tip,
                });
            }

            addEl(place, div);
        });
    }

    function updateOverviewTab(results) {
        const [metaInfo, statistics] = results;
        state.name.value = metaInfo.name;
        state.date.value = metaInfo.date;
        state.preDate.value = metaInfo.preGameDate;
        state.descr.value = metaInfo.description;
        addEl(clearEl(state.lastSaveTime), makeText(new Date(metaInfo.saveTime).format('yyyy/mm/dd HH:MM:ss')));
        
        statistics.lastEvent = statistics.lastEvent !== '' ? new Date(statistics.lastEvent).format('yyyy/mm/dd h:MM') : '';
        statistics.firstEvent = statistics.firstEvent !== '' ? new Date(statistics.firstEvent).format('yyyy/mm/dd h:MM') : '';
        
        statisticKeys.forEach((key) => {
            updateStatisticValue(statistics, key);
        });
        
        addEl(clearEl(getEl('generalCompleteness')), makeText(strFormat(getL10n('overview-general-completeness-value'), statistics.generalCompleteness)));
        addEl(clearEl(getEl('storyCompleteness')), makeText(strFormat(getL10n('overview-story-completeness-value'), statistics.storyCompleteness)));
        addEl(clearEl(getEl('relationCompleteness')), makeText(strFormat(getL10n('overview-relation-completeness-value'), statistics.relationCompleteness)));
        
        defaultHists.forEach((histName) => {
            makeHistogram(clearEl(queryEl(`${root}.${histName}`)), statistics[histName]);
        });
        
        entityCharts.forEach((entityChart) => {
            makeChart(entityChart, queryEl(`${root}.${entityChart}`), statistics[entityChart]);
        });
        
        const symbolChartData = R.toPairs(localizeConsts(statistics.textCharactersCount)).map(pair => ({
            value: pair[1],
            label: makeChartLabel(statistics.textCharacterNumber, pair[0], pair[1])
        }));
        makeChart('symbolChart', queryEl(`${root}.symbolChart`), symbolChartData);
        
        const bindingChartData = R.toPairs(localizeConsts(statistics.bindingStats)).map(pair => ({
            value: pair[1],
            label: [pair[0], ': ', pair[1]].join('')
        }));
        makeChart('bindingChart', queryEl(`${root}.bindingChart`), bindingChartData);
        
        let barData, barDiv, bar;
        
        function makeContainer(obj) {
            barDiv = makeEl('div');
            addClass(barDiv, 'col-xs-3');
            addEl(barDiv, addEl(makeEl('h4'), makeText(obj.name)));
            addEl(barDiv, obj.bar);
            return barDiv;
        }
        function buildChart(info) {
            bar = setAttr(setAttr(makeEl('canvas'), 'width', '300'), 'height', '100');
            const data = R.zipObj(['name', 'bar'], [info.name, bar]);
            const container = makeContainer(data);
            makeChart(info.id, bar, info.prepared);
            return container;
        }
        
        function buildHist(info) {
            bar = addClass(makeEl('div'), 'overviewHist');
            const data = R.zipObj(['name', 'bar'], [info.name, bar]);
            const container = makeContainer(data);
            makeHistogram(bar, info.prepared);
            return container;
        }
        
        const innerMakeChart = R.compose(buildChart, prepareChart);
        const innerMakeHist = R.compose(buildHist, prepareHist);
        
        function localizeCheckboxes(info) {
            info.data = R.fromPairs(R.toPairs(info.data).map((val) => {
                val[0] = constL10n(Constants[val[0]]);
                return val;
            }));
            return info;
        }
        
        const makeCheckboxChart = R.compose(innerMakeChart, localizeCheckboxes);
        
        const fn = R.cond([
            [R.compose(R.equals('enum'), R.prop('type')), innerMakeChart],
            [R.compose(R.equals('checkbox'), R.prop('type')), makeCheckboxChart],
            [R.T, innerMakeHist],
            ]);
        
        showEl(qe(`${root} .alert.character`), statistics.profileCharts.characterCharts.length === 0);
        statistics.profileCharts.characterCharts.map(fn)
            .map(addEl(clearEl(queryEl(`${root}.characterProfileDiagrams`))));
        showEl(qe(`${root} .alert.player`), statistics.profileCharts.playerCharts.length === 0);
        statistics.profileCharts.playerCharts.map(fn)
            .map(addEl(clearEl(queryEl(`${root}.playerProfileDiagrams`))));
    }
    
    function localizeConsts(info) {
        info = R.fromPairs(R.toPairs(info).map((val) => {
            val[0] = constL10n(val[0]);
            return val;
        }));
        return info;
    }

    function prepareChart(info) {
        const total = R.sum(R.values(info.data));
        info.prepared = R.keys(info.data).map(key => R.zipObj(['value', 'label'], [info.data[key], makeChartLabel(total, key, info.data[key])]));
        return info;
    }

    function prepareHist(info) {
        info.prepared = [];
        const { step } = info.data;
        info.data = info.data.groups;
        const min = R.apply(Math.min, R.keys(info.data));
        const max = R.apply(Math.max, R.keys(info.data));

        for (let i = min; i < max + 1; i++) {
            if (info.data[i]) {
                info.prepared.push({
                    value: info.data[i],
                    label: `${i * step}-${(i * step) + (step - 1)}`,
                    tip: `${i * step}-${(i * step) + (step - 1)}`
                });
            } else {
                info.prepared.push(null);
            }
        }
        return info;
    }

    // eslint-disable-next-line no-var,vars-on-top
    var makeChartLabel = R.curry((total, key, value) =>
        [key, ': ', ((value / total) * 100).toFixed(0), '% (', value, '/', total, ')'].join(''));

    function updateStatisticValue(statistics, key) {
        addEl(clearEl(getEl(key)), makeText(statistics[key]));
    }

    function updateName(event) {
        DBMS.setMetaInfoStringPm('name', event.target.value).catch(Utils.handleError);
    }
    function updateTime(dp, input) {
        DBMS.setMetaInfoDate('date', input.val(), Utils.processError());
    }
    function updatePreGameDate(dp, input) {
        DBMS.setMetaInfoDate('preGameDate', input.val(), Utils.processError());
    }
    function updateDescr(event) {
        DBMS.setMetaInfoString('description', event.target.value, Utils.processError());
    }

    function customTooltips(tooltip) {
        // Tooltip Element
        let tooltipEl = document.getElementById('chartjs-tooltip');

        if (!tooltipEl) {
            tooltipEl = document.createElement('div');
            tooltipEl.id = 'chartjs-tooltip';
            tooltipEl.innerHTML = '<table></table>';
            document.body.appendChild(tooltipEl);
        }

        // Hide if no tooltip
        if (tooltip.opacity === 0) {
            tooltipEl.style.opacity = 0;
            return;
        }

        // Set caret Position
        tooltipEl.classList.remove('above', 'below', 'no-transform');
        if (tooltip.yAlign) {
            tooltipEl.classList.add(tooltip.yAlign);
        } else {
            tooltipEl.classList.add('no-transform');
        }

        function getBody(bodyItem) {
            return bodyItem.lines;
        }

        // Set Text
        if (tooltip.body) {
            const titleLines = tooltip.title || [];
            const bodyLines = tooltip.body.map(getBody);

            let innerHtml = '<thead>';

            titleLines.forEach((title) => {
                innerHtml += `<tr><th>${title}</th></tr>`;
            });
            innerHtml += '</thead><tbody>';

            bodyLines.forEach((body, i) => {
                const colors = tooltip.labelColors[i];
                let style = `background:${colors.backgroundColor}`;
                style += `; border-color:${colors.borderColor}`;
                style += '; border-width: 2px';
                const span = `<span class="chartjs-tooltip-key" style="${style}"></span>`;
                innerHtml += `<tr><td>${span}${body}</td></tr>`;
            });
            innerHtml += '</tbody>';

            const tableRoot = tooltipEl.querySelector('table');
            tableRoot.innerHTML = innerHtml;
        }

        const position = this._chart.canvas.getBoundingClientRect();

        //        // Display, position, and set styles for font
        tooltipEl.style.opacity = 1;
        tooltipEl.style.left = `${position.left + tooltip.caretX}px`;
        tooltipEl.style.top = `${position.top + tooltip.caretY}px`;
        //        tooltipEl.style.fontFamily = tooltip._fontFamily;
        //        tooltipEl.style.fontSize = tooltip.fontSize;
        //        tooltipEl.style.fontStyle = tooltip._fontStyle;
        tooltipEl.style.padding = `${tooltip.yPadding}px ${tooltip.xPadding}px`;
    }
})(this.Overview = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.profile-binding-tab ';

    exports.init = () => {
        listen(queryEl(`${root}.create-binding-button`), 'click', createBinding);
        listen(queryEl(`${root}.remove-binding-button`), 'click', removeBinding);
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        PermissionInformer.getEntityNamesArray('character', false, (err, characterNames) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.getEntityNamesArray('player', false, (err2, playerNames) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getProfileBindings((err3, profileBindings) => {
                    if (err3) { Utils.handleError(err3); return; }

                    const bondedCharacterList = R.keys(profileBindings);
                    const bondedPlayerList = R.values(profileBindings);
                    const filter = list => R.compose(R.not, R.contains(R.__, list), R.prop('value'));

                    fillSelector(
                        clearEl(queryEl(`${root}.character-selector`)),
                        characterNames.filter(filter(bondedCharacterList)).map(remapProps4Select)
                    );
                    fillSelector(
                        clearEl(queryEl(`${root}.player-selector`)),
                        playerNames.filter(filter(bondedPlayerList)).map(remapProps4Select)
                    );
                    const bindings = R.toPairs(profileBindings).map(binding => ({
                        name: R.join('/', binding),
                        value: JSON.stringify(binding)
                    }));
                    bindings.sort(CommonUtils.charOrdAFactory(R.prop('name')));
                    fillSelector(clearEl(queryEl(`${root}.binding-selector`)), bindings);
                });
            });
        });
    };

    function createBinding() {
        const characterName = queryEl(`${root}.character-selector`).value;
        const playerName = queryEl(`${root}.player-selector`).value;

        if (characterName === '' || playerName === '') {
            Utils.alert(getL10n('binding-character-or-player-not-selected'));
            return;
        }

        DBMS.createBinding(characterName, playerName, Utils.processError(exports.refresh));
    }

    function removeBinding() {
        const bindingVal = queryEl(`${root}.binding-selector`).value;

        if (bindingVal === '') {
            Utils.alert(getL10n('binding-binding-is-not-selected'));
            return;
        }
        const binding = JSON.parse(bindingVal);

        DBMS.removeBinding(binding[0], binding[1], Utils.processError(exports.refresh));
    }
})(this.ProfileBinding = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';


// Character profile already ha field 'name'
// I had some choices:
// 1. remove this field at all
// 2. Add one more object to divide special values (name) and user defined values
// 3. Prohibit to make field - name
// 1. This field is used in many places
// 2. - too complex way
// 3. simple and lesser complexity, I choose this way

((exports) => {
    const tabRoot = '.profile-configurer-tab ';
    const characterPanel = `${tabRoot}.character-profile-panel `;
    const playerPanel = `${tabRoot}.player-profile-panel `;

    exports.init = () => {
        const sel = clearEl(queryEl(`${characterPanel}.create-entity-type-select`));
        const fillMainSel = () => { fillItemTypesSel(clearEl(sel)); };
        fillMainSel();
        L10n.onL10nChange(fillMainSel);
        const sel2 = clearEl(queryEl(`${playerPanel}.create-entity-type-select`));
        const fillMainSel2 = () => { fillItemTypesSel(clearEl(sel2)); };
        fillMainSel2();
        L10n.onL10nChange(fillMainSel2);

        listen(queryEl(`${characterPanel}.create-entity-button`), 'click', createProfileItem('character', characterPanel));
        listen(queryEl(`${characterPanel}.move-entity-button`), 'click', moveProfileItem('character', characterPanel));
        listen(queryEl(`${characterPanel}.remove-entity-button`), 'click', removeProfileItem('character', characterPanel));

        listen(queryEl(`${playerPanel}.create-entity-button`), 'click', createProfileItem('player', playerPanel));
        listen(queryEl(`${playerPanel}.move-entity-button`), 'click', moveProfileItem('player', playerPanel));
        listen(queryEl(`${playerPanel}.remove-entity-button`), 'click', removeProfileItem('player', playerPanel));

        exports.content = queryEl(tabRoot);
    };

    exports.refresh = () => {
        refreshPanel('character', characterPanel);
        refreshPanel('player', playerPanel);
    };

    function refreshPanel(type, root) {
        DBMS.getProfileStructure(type, (err, allProfileSettings) => {
            if (err) { Utils.handleError(err); return; }

            const arr = allProfileSettings.map(R.compose(strFormat(getL10n('common-set-item-before')), R.append(R.__, []), R.prop('name')));
            arr.push(getL10n('common-set-item-as-last'));
            const positionSelectors = [queryEl(`${root}.create-entity-position-select`),
                queryEl(`${root}.move-entity-position-select`)];
            positionSelectors.map(clearEl).map(fillSelector(R.__, arr2Select(arr))).map(setProp(R.__, 'selectedIndex', allProfileSettings.length));

            const table = clearEl(queryEl(`${root}.profile-config-container`));

            try {
                addEls(table, allProfileSettings.map(getInput(type)));
            } catch (err1) {
                Utils.handleError(err1); return;
            }

            PermissionInformer.isAdmin((err2, isAdmin) => {
                if (err2) { Utils.handleError(err2); return; }
                Utils.enable(exports.content, 'adminOnly', isAdmin);
            });

            const selectorArr = [queryEl(`${root}.move-entity-select`), queryEl(`${root}.remove-entity-select`)];
            selectorArr.map(clearEl).map(fillSelector(R.__, arr2Select(allProfileSettings.map(R.prop('name')))));
        });
    }

    function createProfileItem(type, root) {
        return () => {
            const input = queryEl(`${root}.create-entity-input`);
            const name = input.value.trim();
            const itemType = queryEl(`${root}.create-entity-type-select`).value.trim();
            const positionSelector = queryEl(`${root}.create-entity-position-select`);

            DBMS.createProfileItem(type, name, itemType, positionSelector.selectedIndex, Utils.processError(() => {
                input.value = '';
                exports.refresh();
            }));
        };
    }

    function moveProfileItem(type, root) {
        return () => {
            const { index } = queryEl(`${root}.move-entity-select`).selectedOptions[0];
            const newIndex = queryEl(`${root}.move-entity-position-select`).selectedIndex;
            DBMS.moveProfileItem(type, index, newIndex, Utils.processError(exports.refresh));
        };
    }

    function removeProfileItem(type, root) {
        return () => {
            const selector = queryEl(`${root}.remove-entity-select`);
            const index = selector.selectedIndex;
            const name = selector.value;

            Utils.confirm(strFormat(getL10n('profiles-are-you-sure-about-removing-profile-item'), [name]), () => {
                DBMS.removeProfileItem(type, index, name, Utils.processError(exports.refresh));
            });
        };
    }

    // eslint-disable-next-line no-var,vars-on-top
    var fillItemTypesSel = sel => fillSelector(sel, constArr2Select(R.keys(Constants.profileFieldTypes)));
    const fillPlayerAccessSel = sel => fillSelector(sel, constArr2Select(Constants.playerAccessTypes));

    // eslint-disable-next-line no-var,vars-on-top
    var getInput = R.curry((type, profileSettings, index) => { // throws InternalError
        index++;
        const els = [];

        els.push(addEl(makeEl('span'), makeText(index)));

        let input = setProps(makeEl('input'), {
            value: profileSettings.name,
            info: profileSettings.name
        });
        listen(input, 'change', renameProfileItem(type));
        addClass(input, 'itemNameInput');
        els.push(input);

        let sel = makeEl('select');
        fillItemTypesSel(sel);
        setProps(sel, {
            value: profileSettings.type,
            info: profileSettings.name,
            oldType: profileSettings.type
        });
        listen(sel, 'change', changeProfileItemType(type));
        els.push(sel);

        switch (profileSettings.type) {
        case 'text':
        case 'enum':
        case 'multiEnum':
            input = makeEl('textarea');
            input.value = profileSettings.value;
            break;
        case 'string':
            input = makeEl('input');
            input.value = profileSettings.value;
            break;
        case 'number':
            input = makeEl('input');
            input.type = 'number';
            input.value = profileSettings.value;
            break;
        case 'checkbox':
            input = makeEl('input');
            input.type = 'checkbox';
            input.checked = profileSettings.value;
            break;
        default:
            throw new Errors.InternalError('errors-unexpected-switch-argument', [profileSettings.type]);
        }

        setProps(input, {
            info: profileSettings.name,
            infoType: profileSettings.type,
            oldValue: profileSettings.value
        });
        addClass(input, `profile-configurer-${profileSettings.type}`);
        listen(input, 'change', updateDefaultValue(type));
        els.push(input);

        input = setProps(makeEl('input'), {
            checked: profileSettings.doExport,
            info: profileSettings.name,
            type: 'checkbox'
        });
        listen(input, 'change', doExportChange(type));
        els.push(input);

        sel = makeEl('select');
        fillPlayerAccessSel(sel);
        setProps(sel, {
            value: profileSettings.playerAccess,
            info: profileSettings.name,
            oldValue: profileSettings.playerAccess,
        });
        listen(sel, 'change', changeProfileItemPlayerAccess(type));
        els.push(sel);

        input = setProps(makeEl('input'), {
            checked: profileSettings.showInRoleGrid,
            info: profileSettings.name,
            type: 'checkbox'
        });
        listen(input, 'change', showInRoleGridChange(type));
        els.push(input);

        return addEls(makeEl('tr'), els.map(el => addEl(makeEl('td'), addClass(el, 'adminOnly'))));
    });

    function updateDefaultValue(type) {
        return (event) => {
            const name = event.target.info;
            const itemType = event.target.infoType;
            const { oldValue } = event.target;

            const value = itemType === 'checkbox' ? event.target.checked : event.target.value;

            let newOptions, missedValues, newValue, updateEnum;

            switch (itemType) {
            case 'text':
            case 'string':
            case 'checkbox':
                DBMS.updateDefaultValue(type, name, value, Utils.processError());
                break;
            case 'number':
                if (Number.isNaN(value)) {
                    Utils.alert(getL10n('profiles-not-a-number'));
                    event.target.value = oldValue;
                    return;
                }
                DBMS.updateDefaultValue(type, name, Number(value), Utils.processError());
                break;
            case 'multiEnum':
            case 'enum':
                if (value === '' && itemType === 'enum') {
                    Utils.alert(getL10n('profiles-enum-item-cant-be-empty'));
                    event.target.value = oldValue;
                    return;
                }
                newOptions = value.split(',').map(R.trim);
                missedValues = oldValue.trim() === '' ? [] : R.difference(oldValue.split(','), newOptions);

                updateEnum = () => {
                    newValue = newOptions.join(',');
                    event.target.value = newValue;
                    event.target.oldValue = newValue;
                    DBMS.updateDefaultValue(type, name, newValue, Utils.processError());
                };

                if (missedValues.length !== 0) {
                    Utils.confirm(strFormat(getL10n('profiles-new-enum-values-remove-some-old-values'), [missedValues.join(',')]), updateEnum, () => {
                        event.target.value = oldValue;
                    });
                } else {
                    updateEnum();
                }
                break;
            default:
                Utils.handleError(new Errors.InternalError('errors-unexpected-switch-argument', [itemType]));
            }
        };
    }

    function doExportChange(type) {
        return (event) => {
            DBMS.doExportProfileItemChange(type, event.target.info, event.target.checked, Utils.processError());
        };
    }

    function showInRoleGridChange(type) {
        return (event) => {
            DBMS.showInRoleGridProfileItemChange(type, event.target.info, event.target.checked, Utils.processError());
        };
    }

    function renameProfileItem(type) {
        return (event) => {
            const newName = event.target.value.trim();
            const oldName = event.target.info;

            DBMS.renameProfileItem(type, newName, oldName, (err) => {
                if (err) {
                    event.target.value = event.target.info;
                    Utils.handleError(err);
                    return;
                }
                exports.refresh();
            });
        };
    }

    function changeProfileItemType(type) {
        return (event) => {
            Utils.confirm(strFormat(getL10n('profiles-are-you-sure-about-changing-profile-item-type'), [event.target.info]), () => {
                const newType = event.target.value;
                const name = event.target.info;
                DBMS.changeProfileItemType(type, name, newType, Utils.processError(exports.refresh));
            }, () => {
                event.target.value = event.target.oldType;
            });
        };
    }

    function changeProfileItemPlayerAccess(type) {
        return (event) => {
            const playerAccessType = event.target.value;
            const name = event.target.info;
            DBMS.changeProfileItemPlayerAccess(type, name, playerAccessType, (err) => {
                if (err) {
                    event.target.value = event.target.oldValue;
                    Utils.processError()(err);
                }
            });
        };
    }
})(this.ProfileConfigurer = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {
        character: {},
        player: {}
    };
    const root = '.profile-editor-tab ';
    const characterSelector = `${root}.character-profile-selector`;
    const playerSelector = `${root}.player-profile-selector`;
    const characterProfileDiv = `${root}.character-profile-div`;
    const playerProfileDiv = `${root}.player-profile-div`;
    const characterReportDiv = `${root}.character-report-div tbody`;
    let profileEditorCore;

    exports.init = () => {
        $(characterSelector).select2().on('select2:select', showProfileInfoDelegate2('character'));
        $(playerSelector).select2().on('select2:select', showProfileInfoDelegate2('player'));
        profileEditorCore = ProfileEditorCore.makeProfileEditorCore();
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        clearEl(queryEl(characterReportDiv));
        refreshPanel('character', characterSelector, characterProfileDiv, () => {
            refreshPanel('player', playerSelector, playerProfileDiv, () => {
                applySettings('character', characterSelector, characterProfileDiv);
            });
        });
    };

    function refreshPanel(type, selector, profileDiv, callback) {
        PermissionInformer.getEntityNamesArray(type, false, (err, names) => {
            if (err) { Utils.handleError(err); return; }

            names.push({ displayName: '', value: '', editable: false });

            clearEl(queryEl(selector));
            $(selector).select2(getSelect2Data(names));
            state[type].names = names;

            DBMS.getProfileStructure(type, (err2, allProfileSettings) => {
                if (err2) { Utils.handleError(err2); return; }
                profileEditorCore.initProfileStructure(profileDiv, type, allProfileSettings, callback);
            });
        });
    }

    function applySettings(type, selector, profileDiv) {
        const { names } = state[type];
        if (names.length > 0) {
            const name = names[0].value;
            const settings = DBMS.getSettings();
            if (!settings.ProfileEditor) {
                settings.ProfileEditor = {};
                settings.ProfileEditor[type] = name;
            }
            let profileName = settings.ProfileEditor[type];
            if (names.map(nameInfo => nameInfo.value).indexOf(profileName) === -1) {
                settings.ProfileEditor[type] = name;
                profileName = name;
            }
            showProfileInfoDelegate2(type)({ target: { value: profileName } });
        }
    }

    function selectProfiles(charName, playerName) {
        showProfileInfoDelegate('character', characterProfileDiv, charName);
        showProfileInfoDelegate('player', playerProfileDiv, playerName);
        $(characterSelector).select2().val(charName).trigger('change');
        $(playerSelector).select2().val(playerName).trigger('change');
    }

    function showProfileInfoDelegate2(type) {
        return (event) => {
            const name = event.target.value.trim();
            if (name === '') {
                selectProfiles('', '');
                return;
            }
            DBMS.getProfileBinding(type, name, (err, binding) => {
                if (err) { Utils.handleError(err); return; }
                selectProfiles(binding[0], binding[1]);
            });
        };
    }

    function showProfileInfoDelegate(type, profileDiv, name) {
        updateSettings(type, name);
        if (name === '') {
            addClass(queryEl(profileDiv), 'hidden');
            if (type === 'character') {
                addClass(queryEl(characterReportDiv), 'hidden');
            }
            return;
        }
        DBMS.getProfile(type, name, (err, profile) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.isEntityEditable(type, name, (err2, isCharacterEditable) => {
                if (err2) { Utils.handleError(err2); return; }
                profileEditorCore.fillProfileInformation(profileDiv, type, profile, () => isCharacterEditable);

                if (type === 'character') {
                    DBMS.getCharacterReport(name, (err3, characterReport) => {
                        if (err3) { Utils.handleError(err3); return; }
                        removeClass(queryEl(characterReportDiv), 'hidden');
                        addEls(
                            clearEl(queryEl(characterReportDiv)),
                            characterReport.map(CharacterReports.makeStoryReportRow)
                        );
                    });
                }
            });
        });
    }

    function updateSettings(type, name) {
        const settings = DBMS.getSettings();
        settings.ProfileEditor[type] = name;
    }
})(this.ProfileEditor = {});

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

/* eslint-disable func-names */

'use strict';

((exports) => {
    exports.makeProfileEditorCore = () => {
        const innerExports = {};

        const root = '.profile-editor-core-tmpl';

        const state = {
            character: {},
            player: {}
        };

        innerExports.initProfileStructure = (profileDiv, type, profileStructure, callback) => {
            const container = qte(`${root} .profile-editor-container-tmpl`);
            addEl(clearEl(queryEl(profileDiv)), container);
            state[type].inputItems = {};
            state[type].profileStructure = profileStructure;

            if(profileStructure.length === 0){
                const alert = qmte('.alert-block-tmpl');
                addEl(alert, makeText(L10n.get('advices', `empty-${type}-profile-structure`)));
                addEl(queryEl(profileDiv), alert);
                if (callback) callback();
                return;
            }
            try {
                addEls(qee(queryEl(profileDiv), '.insertion-point'), profileStructure.map(appendInput(type)));
            } catch (err) {
                Utils.handleError(err); return;
            }

            if (callback) callback();
        };

        // eslint-disable-next-line no-var,vars-on-top
        var appendInput = R.curry((type, profileItemConfig) => {
            const itemInput = new ProfileItemInput(type, profileItemConfig);
            state[type].inputItems[profileItemConfig.name] = itemInput;
            const row = qte(`${root} .profile-editor-row-tmpl`);
            addEl(qee(row, '.profile-item-name'), makeText(profileItemConfig.name));
            addEl(qee(row, '.profile-item-input'), itemInput.dom);
            return row;
        });

        innerExports.fillProfileInformation = (profileDiv, type, profile, isEditable) => {
            removeClass(queryEl(profileDiv), 'hidden');
            R.values(state[type].inputItems).forEach((itemInput) => {
                if (itemInput.type === 'multiEnum') {
                    itemInput.multiEnumSelect.prop('disabled', !isEditable(itemInput.name, state[type].profileStructure));
                } else {
                    Utils.enableEl(itemInput.dom, isEditable(itemInput.name, state[type].profileStructure));
                }
            });

            state[type].name = profile.name;
            Object.values(state[type].inputItems).forEach((item) => {
                item.showFieldValue(profile);
            });
        };

        function ProfileItemInput(profileType, profileItemConfig) {
            let input, sel;
            switch (profileItemConfig.type) {
            case 'text':
                input = makeEl('textarea');
                addClass(input, 'profileTextInput');
                break;
            case 'string':
                input = makeEl('input');
                addClass(input, 'profileStringInput');
                break;
            case 'enum':
                input = makeEl('select');
                addClass(input, 'profileSelectInput');
                const toNameObj = R.compose(R.zipObj(['name']), R.append(R.__, []));
                fillSelector(input, R.sort(CommonUtils.charOrdA, profileItemConfig.value.split(',')).map(toNameObj));
                break;
            case 'number':
                input = makeEl('input');
                input.type = 'number';
                break;
            case 'checkbox':
                input = makeEl('input');
                input.type = 'checkbox';
                break;
            case 'multiEnum':
                this.multiEnumSelect = $('<select></select>');
                setAttr(this.multiEnumSelect[0], 'style', 'width: 100%;');
                addClass(this.multiEnumSelect[0], 'common-select');
                addClass(this.multiEnumSelect[0], 'profileStringInput');
                [input] = $('<span></span>').append(this.multiEnumSelect);
                setAttr(this.multiEnumSelect[0], 'multiple', 'multiple');

                sel = this.multiEnumSelect.select2(arr2Select2(R.sort(CommonUtils.charOrdA, profileItemConfig.value.split(','))));
                sel.on('change', this.updateFieldValue.bind(this));
                break;
            default:
                throw new Errors.InternalError('errors-unexpected-switch-argument', [profileItemConfig.type]);
            }

            if (profileItemConfig.type !== 'multiEnum') {
                listen(input, 'change', this.updateFieldValue.bind(this));
                addClass(input, 'form-control');
            }

            this.dom = input;
            this.type = profileItemConfig.type;
            this.profileType = profileType;
            this.name = profileItemConfig.name;
        }

        ProfileItemInput.prototype.showFieldValue = function (profile) {
            if (this.type === 'checkbox') {
                this.dom.checked = profile[this.name];
            } else if (this.type === 'multiEnum') {
                this.multiEnumSelect.val(profile[this.name] === '' ? null : profile[this.name].split(',')).trigger('change');
            } else {
                this.dom.value = profile[this.name];
            }
            this.oldValue = profile[this.name];
        };

        ProfileItemInput.prototype.updateFieldValue = function (event) {
            const fieldName = this.name;
            const profileName = state[this.profileType].name;
            if (this.multiEnumSelect && this.multiEnumSelect.prop('disabled')) {
                return; // we need to trigger change event on multiEnumSelect to update selection.
                // It may be disabled so it has false positive call.
            }

            let value, val;
            switch (this.type) {
            case 'text':
            case 'string':
            case 'enum':
                val = this.dom.value;
                value = val;
                break;
            case 'number':
                if (Number.isNaN(this.dom.value)) {
                    Utils.alert(getL10n('profiles-not-a-number'));
                    this.dom.value = this.oldValue;
                    return;
                }
                value = Number(this.dom.value);
                break;
            case 'checkbox':
                value = this.dom.checked;
                break;
            case 'multiEnum':
                value = this.multiEnumSelect.val().join(',');
                break;
            default:
                Utils.handleError(new Errors.InternalError('errors-unexpected-switch-argument', [this.type]));
                return;
            }
            DBMS.updateProfileField(this.profileType, profileName, fieldName, this.type, value, Utils.processError());
        };

        return innerExports;
    };
})(this.ProfileEditorCore = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, ProfileEditor, ProfileConfigurer, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const tabRoot = '.profiles-tab ';
    const characterRoot = `${tabRoot}.character-profile-panel `;
    const playerRoot = `${tabRoot}.player-profile-panel `;

    exports.init = () => {
        state.views = {};
        const nav = `${tabRoot}.sub-tab-navigation`;
        const content = `${tabRoot}.sub-tab-content`;
        const containers = {
            root: state,
            navigation: queryEl(nav),
            content: queryEl(content)
        };
        Utils.addView(containers, 'profile-editor', ProfileEditor, { mainPage: true });
        Utils.addView(containers, 'profile-constructor', ProfileConfigurer);
        Utils.addView(containers, 'profile-binding', ProfileBinding);

        listen(queryEl(`${characterRoot}.create-entity-button`), 'click', createProfile('character', characterRoot));
        listen(queryEl(`${characterRoot}.rename-entity-button`), 'click', renameProfile('character', characterRoot));
        listen(queryEl(`${characterRoot}.remove-entity-button`), 'click', removeProfile('character', characterRoot));

        listen(queryEl(`${playerRoot}.create-entity-button`), 'click', createProfile('player', playerRoot));
        listen(queryEl(`${playerRoot}.rename-entity-button`), 'click', renameProfile('player', playerRoot));
        listen(queryEl(`${playerRoot}.remove-entity-button`), 'click', removeProfile('player', playerRoot));

        exports.content = queryEl(tabRoot);
    };

    exports.refresh = () => {
        PermissionInformer.getEntityNamesArray('character', true, (err, characterNames) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.getEntityNamesArray('player', true, (err2, playerNames) => {
                if (err2) { Utils.handleError(err2); return; }
                rebuildInterface(characterRoot, characterNames);
                rebuildInterface(playerRoot, playerNames);
                state.currentView.refresh();
            });
        });
    };

    function rebuildInterface(root, names) {
        const data = getSelect2Data(names);

        clearEl(queryEl(`${root}.rename-entity-select`));
        $(`${root}.rename-entity-select`).select2(data);

        clearEl(queryEl(`${root}.remove-entity-select`));
        $(`${root}.remove-entity-select`).select2(data);
    }

    function createProfile(type, root) {
        return () => {
            const input = queryEl(`${root}.create-entity-input`);
            const name = input.value.trim();

            DBMS.createProfile(type, name, (err) => {
                if (err) { Utils.handleError(err); return; }
                PermissionInformer.refresh((err2) => {
                    if (err2) { Utils.handleError(err2); return; }
                    if (state.currentView.updateSettings) {
                        state.currentView.updateSettings(name);
                    }
                    input.value = '';
                    exports.refresh();
                });
            });
        };
    }

    function renameProfile(type, root) {
        return () => {
            const toInput = queryEl(`${root}.rename-entity-input`);
            const fromName = queryEl(`${root}.rename-entity-select`).value.trim();
            const toName = toInput.value.trim();

            DBMS.renameProfile(type, fromName, toName, (err) => {
                if (err) { Utils.handleError(err); return; }
                PermissionInformer.refresh((err2) => {
                    if (err2) { Utils.handleError(err2); return; }
                    toInput.value = '';
                    if (state.currentView.updateSettings) {
                        state.currentView.updateSettings(type, toName);
                    }
                    exports.refresh();
                });
            });
        };
    }

    function removeProfile(type, root) {
        return () => {
            const name = queryEl(`${root}.remove-entity-select`).value.trim();

            Utils.confirm(strFormat(getL10n('profiles-are-you-sure-about-character-removing'), [name]), () => {
                DBMS.removeProfile(type, name, (err) => {
                    if (err) { Utils.handleError(err); return; }
                    PermissionInformer.refresh((err2) => {
                        if (err2) { Utils.handleError(err2); return; }
                        exports.refresh();
                    });
                });
            });
        };
    }
})(this.Profiles = {});

/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.character-reports-tmpl';

    exports.makeStoryReportRow = (storyInfo) => {
        const act = storyInfo.activity;
        const completeness = makeCompletenessLabel(storyInfo.finishedAdaptations, storyInfo.totalAdaptations);
        const color = getCompletenessColor(storyInfo.finishedAdaptations, storyInfo.totalAdaptations);
        const row = qte(`${root} .story-report-row-tmpl`);
        const qe = qee(row);
        L10n.localizeStatic(row);
        addEl(qe('.story-name'), makeText(storyInfo.storyName));
        setClassByCondition(qe('.activity-active'), 'active-item-in-report', act.active);
        setClassByCondition(qe('.activity-follower'), 'active-item-in-report', act.follower);
        setClassByCondition(qe('.activity-defensive'), 'active-item-in-report', act.defensive);
        setClassByCondition(qe('.activity-passive'), 'active-item-in-report', act.passive);
        addEl(qe('.completeness'), makeText(completeness));
        setStyle(qe('.completeness'), 'background-color', color);
        addEl(qe('.meets'), makeText(storyInfo.meets.join(', ')));
        addEl(qe('.inventory'), makeText(storyInfo.inventory));
        return row;
    };

    exports.makeRelationReportRow = R.curry((characterName, rel) => {
        const row = qte(`${root} .relation-report-row-tmpl`);
        const qe = qee(row);
        L10n.localizeStatic(row);
        const secondCharacter = ProjectUtils.get2ndRelChar(characterName, rel);
        addEl(qe('.character-name'), makeText(secondCharacter));
        const isStarter = rel.starter === characterName;

        if (isStarter) {
            setAttr(
                qe('.direction-starterToEnder'), 'title',
                L10n.format('briefings', 'starterToEnder', [characterName, secondCharacter])
            );
            setAttr(
                qe('.direction-enderToStarter'), 'title',
                L10n.format('briefings', 'enderToStarter', [secondCharacter, characterName])
            );
        } else {
            setAttr(
                qe('.direction-starterToEnder'), 'title',
                L10n.format('briefings', 'starterToEnder', [secondCharacter, characterName])
            );
            setAttr(
                qe('.direction-enderToStarter'), 'title',
                L10n.format('briefings', 'enderToStarter', [characterName, secondCharacter])
            );
        }

        setClassByCondition(
            qe('.direction-starterToEnder'), 'active-item-in-report',
            R.contains(isStarter ? 'starterToEnder' : 'enderToStarter', rel.essence)
        );
        setClassByCondition(qe('.direction-allies'), 'active-item-in-report', R.contains('allies', rel.essence));
        setClassByCondition(
            qe('.direction-enderToStarter'), 'active-item-in-report',
            R.contains(!isStarter ? 'starterToEnder' : 'enderToStarter', rel.essence)
        );

        const finished = isStarter ? rel.starterTextReady : rel.enderTextReady;

        addEl(qe('.completeness'), makeText(L10n.get('constant', finished ? 'finished' : 'unfinished')));
        setClassByCondition(qe('.completeness'), 'relation-finished', finished);
        setClassByCondition(qe('.completeness'), 'relation-unfinished', !finished);

        addEl(qe('.origin'), makeText(rel.origin));
        return row;
    });

    function makeCompletenessLabel(value, total) {
        return strFormat('{0} ({1}/{2})', [total === 0 ? '-' : `${((value / total) * 100).toFixed(0)}%`, value, total]);
    }

    function getCompletenessColor(value, total) {
        if (total === 0) { return 'transparent'; }
        function calc(b, a, part) {
            return ((a * part) + ((1 - part) * b)).toFixed(0);
        }

        let p = value / total;
        if (p < 0.5) {
            p *= 2;
            return strFormat('rgba({0},{1},{2}, 1)', [calc(251, 255, p), calc(126, 255, p), calc(129, 0, p)]); // red to yellow mapping
        }
        p = (p - 0.5) * 2;
        return strFormat('rgba({0},{1},{2}, 1)', [calc(255, 123, p), calc(255, 225, p), calc(0, 65, p)]); // yellow to green mapping
    }
})(this.CharacterReports = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.profile-binding2-tab ';
    const l10n = L10n.get('binding');

    exports.init = () => {
        listen(queryEl(`${root} .character-filter`), 'input', filterList('.character-list'));
        listen(queryEl(`${root} .player-filter`), 'input', filterList('.player-list'));
        listen(queryEl(`${root} .binding-filter`), 'input', filterList('.binding-list'));

        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        PermissionInformer.getEntityNamesArray('character', false, (err, characterNames) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.getEntityNamesArray('player', false, (err2, playerNames) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getProfileBindings((err3, profileBindings) => {
                    if (err3) { Utils.handleError(err3); return; }
                    rebuildInterface(characterNames, playerNames, profileBindings);
                });
            });
        });
    };

    function rebuildInterface(characterNames, playerNames, profileBindings) {
        const bondedCharacterList = R.keys(profileBindings);
        const bondedPlayerList = R.values(profileBindings);
        const filter = list => R.compose(R.not, R.contains(R.__, list), R.prop('value'));
        
        showEl(queryEl(`${root} .alert.no-character`), characterNames.length === 0);
        Utils.enableEl(queryEl(`${root} .character-filter`), characterNames.length !== 0);
        showEl(queryEl(`${root} .character-list`), characterNames.length !== 0);
        
        showEl(queryEl(`${root} .alert.no-player`), playerNames.length === 0);
        Utils.enableEl(queryEl(`${root} .player-filter`), playerNames.length !== 0);
        showEl(queryEl(`${root} .player-list`), playerNames.length !== 0);
        
        Utils.enableEl(queryEl(`${root} .binding-filter`), R.keys(profileBindings).length !== 0);

        addEls(
            clearEl(queryEl(`${root} .entity-list.character-list`)),
            characterNames.filter(filter(bondedCharacterList)).map(profile2el('character'))
        );

        addEls(
            clearEl(queryEl(`${root} .entity-list.player-list`)),
            playerNames.filter(filter(bondedPlayerList)).map(profile2el('player'))
        );

        const bindings = R.toPairs(profileBindings).map(binding => ({
            name: R.join('/', binding),
            value: binding
        }));
        bindings.sort(CommonUtils.charOrdAFactory(R.prop('name')));

        addEls(clearEl(queryEl(`${root} .entity-list.binding-list`)), bindings.map(binding2el));
    }

    const profile2el = R.curry((type, name) => {
        const el = qmte(`${root} .profile-item-tmpl`);
        el.profileName = name.value;
        const btn = qee(el, '[role=button]');
        addEl(qee(el, '.primary-name'), makeText(name.displayName));
        setAttr(btn, 'profile-name', name.value);
        setAttr(btn, 'primary-name', name.displayName);
        setAttr(btn, 'profile-type', type);
        listen(btn, 'dragstart', onDragStart);
        listen(btn, 'drop', onDrop);
        listen(btn, 'dragover', allowDrop);
        listen(btn, 'dragenter', handleDragEnter);
        listen(btn, 'dragleave', handleDragLeave);
        return el;
    });

    // eslint-disable-next-line no-var,vars-on-top
    var onDragStart = function(event) {
        console.log(`onDragStart ${this.profileName}`);
        event.dataTransfer.setData('data', JSON.stringify({
            name: getAttr(this, 'profile-name'),
            type: getAttr(this, 'profile-type'),
        }));
        event.dataTransfer.effectAllowed = 'move';
    };

    // eslint-disable-next-line no-var,vars-on-top
    var onDrop = function(event) {
        removeClass(this, 'over');
        console.log(`onDrop ${this.profileName}${event.dataTransfer.getData('data')}`);
        if (event.stopPropagation) {
            event.stopPropagation(); // stops the browser from redirecting.
        }
        const thatData = JSON.parse(event.dataTransfer.getData('data'));
        if (thatData.type === getAttr(this, 'profile-type')) {
            return;
        }

        createBinding([thatData, {
            name: getAttr(this, 'profile-name'),
            type: getAttr(this, 'profile-type'),
        }]);
    };

    // eslint-disable-next-line no-var,vars-on-top
    var allowDrop = function(event) {
        console.log(`allowDrop ${this.profileName}`);
        event.preventDefault();
    };

    function handleDragEnter(event) {
        addClass(this, 'over');
    }

    function handleDragLeave(event) {
        removeClass(this, 'over');
    }

    function binding2el(binding) {
        const el = wrapEl('div', qte(`${root} .binding-item-tmpl`));
        addEl(qee(el, '.primary-name'), makeText(binding.name));
        setAttr(el, 'primary-name', binding.name);
        setAttr(qee(el, '.unlink'), 'title', l10n('unlink-binding'));
        listen(qee(el, '.unlink'), 'click', () => removeBinding(binding.value));
        return el;
    }

    // eslint-disable-next-line no-var,vars-on-top
    var filterList = sel => (event) => {
        const str = event.target.value.toLowerCase();

        const els = queryEls(`${root} ${sel} [primary-name]`);
        els.forEach((el) => {
            const isVisible = getAttr(el, 'primary-name').toLowerCase().indexOf(str) !== -1;
            showEl(el, isVisible);
        });
    };

    function createBinding(pair) {
        const characterName = pair[0].type === 'character' ? pair[0].name : pair[1].name;
        const playerName = pair[0].type === 'player' ? pair[0].name : pair[1].name;
        DBMS.createBinding(characterName, playerName, Utils.processError(exports.refresh));
    }

    function removeBinding(binding) {
        DBMS.removeBinding(binding[0], binding[1], Utils.processError(exports.refresh));
    }
})(this.ProfileBinding2 = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';


// Character/Player profiles already have field 'name'
// I had some choices:
// 1. remove this field at all
// 2. Add one more object to divide special values (name) and user defined values
// 3. Prohibit to make field - name
// 1. This field is used in many places
// 2. - too complex way
// 3. simple and lesser complexity, I choose this way

function ProfileConfigurerTmpl(exports, opts) {
    const { tabType } = opts;

    const tmplRoot = '.profile-configurer2-tab-tmpl';
    const tabRoot = `.profile-configurer2-tab.${`${tabType}-type`} `;
    const profilePanel = `${tabRoot}.profile-panel `;
    const l10n = L10n.get('profiles');
    const state = {};

    exports.init = () => {
        const el = queryEl(tmplRoot).cloneNode(true);

        addClasses(el, ['profile-configurer2-tab', `${`${tabType}-type`}`]);
        removeClass(el, 'profile-configurer2-tab-tmpl');
        addEl(queryEl('.tab-container'), el);

        const createProfileItemDialog = UI.createModalDialog(
            `.profile-configurer2-tab.${`${tabType}-type`}`,
            createProfileItem, {
                bodySelector: 'create-profile-item-body',
                dialogTitle: 'profiles-create-profile-item',
                actionButtonTitle: 'common-create',
                initBody: (body) => {
                    const sel = clearEl(qee(body, '.create-entity-type-select'));
                    const fillMainSel = () => { fillItemTypesSel(clearEl(sel)); };
                    fillMainSel();
                    L10n.onL10nChange(fillMainSel);
                }
            }
        );

        state.renameProfileItemDialog = UI.createModalDialog(
            `.profile-configurer2-tab.${`${tabType}-type`}`,
            renameProfileItem, {
                bodySelector: 'modal-prompt-body',
                dialogTitle: 'profiles-enter-new-profile-item-name',
                actionButtonTitle: 'common-rename',
            }
        );

        state.moveProfileItemDialog = UI.createModalDialog(
            `.profile-configurer2-tab.${`${tabType}-type`}`,
            moveProfileItem, {
                bodySelector: 'move-profile-item-body',
                dialogTitle: 'profiles-new-profile-item-position',
                actionButtonTitle: 'common-move',
            }
        );
        
        state.renameEnumItemDialog = UI.createModalDialog(
            `.profile-configurer2-tab.${`${tabType}-type`}`,
            renameEnumValue, {
                bodySelector: 'rename-enum-value-tmpl',
                dialogTitle: 'profiles-rename-enum-item',
                actionButtonTitle: 'common-rename',
                initBody: (body) => {
                    const renameSelect = clearEl(qee(body, '.renamed-value-select'));
                    const renameInput = clearEl(qee(body, '.enum-value-name-input'));
                    listen(renameSelect, 'change', () => {
                        renameInput.value = renameSelect.value;
                    });
                }
            }
        );
        
        state.enumEditorDialog = UI.createModalDialog(
            `.profile-configurer2-tab.${`${tabType}-type`}`,
            updateEnumValues, {
                bodySelector: 'enum-dialog-editor-tmpl',
                dialogTitle: 'profiles-enum-editor',
                actionButtonTitle: 'common-save',
                initBody: (body) => {
                    const addedValuesArea = qee(body, '.new-enum-values');
                    const removedValuesArea = qee(body, '.removed-enum-values');
                    const inputArea = qee(body, '.enum-value-input');
                    const defaultValueSelect = qee(body, '.default-value-select');
                    listen(inputArea, 'input', () => {
                        const newVals = inputArea.value.split(',').map(R.trim).filter(R.pipe(R.equals(''), R.not));
                        const addedValues = R.sort(CommonUtils.charOrdA, R.difference(newVals, inputArea.srcList));
                        addEls(clearEl(addedValuesArea), enumList2Els(addedValues));
                        const removedValues = R.sort(CommonUtils.charOrdA, R.difference(inputArea.srcList, newVals));
                        addEls(clearEl(removedValuesArea), enumList2Els(removedValues));
                        
                        let defaultValue = defaultValueSelect.value;
                        clearEl(defaultValueSelect);
                        
                        if(newVals.length === 0){
                            return;
                        }
                        
                        if(!R.contains(defaultValue, newVals)){
                            defaultValue = newVals[0];
                        }
                        fillSelector(defaultValueSelect, arr2Select(newVals));
                        qee(defaultValueSelect, `[value="${defaultValue}"]`).selected = true;
                    });
                }
            }
        );
        
        state.multiEnumEditorDialog = UI.createModalDialog(
            `.profile-configurer2-tab.${`${tabType}-type`}`,
            updateEnumValues, {
                bodySelector: 'multi-enum-dialog-editor-tmpl',
                dialogTitle: 'profiles-multi-enum-editor',
                actionButtonTitle: 'common-save',
                initBody: (body) => {
                    const addedValuesArea = qee(body, '.new-enum-values');
                    const removedValuesArea = qee(body, '.removed-enum-values');
                    const inputArea = qee(body, '.enum-value-input');
                    listen(inputArea, 'input', () => {
                        const newVals = inputArea.value.split(',').map(R.trim).filter(R.pipe(R.equals(''), R.not));
                        const addedValues = R.sort(CommonUtils.charOrdA, R.difference(newVals, inputArea.srcList));
                        addEls(clearEl(addedValuesArea), enumList2Els(addedValues));
                        const removedValues = R.sort(CommonUtils.charOrdA, R.difference(inputArea.srcList, newVals));
                        addEls(clearEl(removedValuesArea), enumList2Els(removedValues));
                    });
                }
            }
        );

        setAttr(qee(el, '.panel h3'), 'l10n-id', `profiles-${opts.panelName}`);
        setAttr(qee(el, '.alert'), 'l10n-id', `advices-empty-${tabType}-profile-structure`);
        L10n.localizeStatic(el);

        setAttr(qee(el, '.panel a'), 'panel-toggler', `${tabRoot}.profile-panel`);
        UI.initPanelTogglers(el);

        listen(qe(`${tabRoot}.create`), 'click', () => createProfileItemDialog.showDlg());
        exports.content = el;
    };

    exports.refresh = () => {
        refreshPanel(tabType, profilePanel);
    };

    function refreshPanel(type, root) {
        DBMS.getProfileStructure(type, (err, allProfileSettings) => {
            if (err) { Utils.handleError(err); return; }
            
            hideEl(queryEl(`${tabRoot} .alert`), allProfileSettings.length !== 0);
            hideEl(queryEl(`${tabRoot} table`), allProfileSettings.length === 0);

            const arr = allProfileSettings.map(R.compose(strFormat(getL10n('common-set-item-before')), R.append(R.__, []), R.prop('name')));
            arr.push(getL10n('common-set-item-as-last'));

            const positionSelectors = [queryEl(`${tabRoot} .create-entity-position-select`),
                queryEl(`${tabRoot} .move-entity-position-select`)];
            positionSelectors.map(clearEl).map(fillSelector(R.__, arr2Select(arr))).map(setProp(R.__, 'selectedIndex', allProfileSettings.length));

            const table = clearEl(queryEl(`${root}.profile-config-container`));

            try {
                addEls(table, allProfileSettings.map(getInput(type)));
            } catch (err1) {
                Utils.handleError(err1); return;
            }

            PermissionInformer.isAdmin((err2, isAdmin) => {
                if (err2) { Utils.handleError(err2); return; }
                Utils.enable(exports.content, 'adminOnly', isAdmin);
            });
        });
    }

    function createProfileItem(dialog) {
        return () => {
            const input = qee(dialog, '.create-entity-name-input');
            const name = input.value.trim();
            const itemType = qee(dialog, '.create-entity-type-select').value.trim();
            const { selectedIndex } = qee(dialog, '.create-entity-position-select');

            DBMS.createProfileItem(tabType, name, itemType, selectedIndex, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    input.value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    // eslint-disable-next-line no-var,vars-on-top
    var fillItemTypesSel = sel => fillSelector(sel, constArr2Select(R.keys(Constants.profileFieldTypes)));
    const fillPlayerAccessSel = sel => fillSelector(sel, constArr2Select(Constants.playerAccessTypes));

    // eslint-disable-next-line no-var,vars-on-top
    var getInput = R.curry((type, profileSettings, index) => { // throws InternalError
        const row = qte(`${tabRoot} .profile-configurer-row-tmpl`);
        L10n.localizeStatic(row);
        addEl(qee(row, '.item-position'), makeText(index + 1));
        addEl(qee(row, '.item-name'), makeText(profileSettings.name));

        const itemType = qee(row, '.item-type');
        fillItemTypesSel(itemType);
        itemType.value = profileSettings.type;
        itemType.info = profileSettings.name;
        itemType.oldType = profileSettings.type;
        listen(itemType, 'change', changeProfileItemType(type));

        let input, addDefaultListener = true;
        switch (profileSettings.type) {
        case 'text':
            input = makeEl('textarea');
            addClass(input, 'hidden');
            input.value = profileSettings.value;
            break;
        case 'enum':
            input = qmte(`${tabRoot} .enum-value-editor-tmpl`);
            const list = profileSettings.value.split(',');
            const defaultValue = list[0];
            list.sort(CommonUtils.charOrdA);
            
            addEls(qee(input, '.text'), enumList2Els(list, defaultValue));
            
            listen(qee(input, '.btn.add'), 'click', () => {
                addEls(clearEl(qee(state.enumEditorDialog, '.initial-value')), enumList2Els(list, defaultValue));
                const inputArea = qee(state.enumEditorDialog, '.enum-value-input');
                inputArea.value = list.join(',');
                inputArea.srcList = list;
                inputArea.defaultValue = defaultValue;
                
                const defaultValueSelect = clearEl(qee(state.enumEditorDialog, '.default-value-select'));
                fillSelector(defaultValueSelect, arr2Select(list));
                qee(defaultValueSelect, `[value="${defaultValue}"]`).selected = true;
                state.enumEditorDialog.itemName = profileSettings.name;
                state.enumEditorDialog.showDlg();
            });
            
            listen(qee(input, '.btn.rename'), 'click', () => {
                const renameSelect = clearEl(qee(state.renameEnumItemDialog, '.renamed-value-select'));
                fillSelector(renameSelect, arr2Select(list));
                
                if(list.length > 0){
                    qee(state.renameEnumItemDialog, '.enum-value-name-input').value = list[0]; 
                }
                
                state.renameEnumItemDialog.itemName = profileSettings.name;
                state.renameEnumItemDialog.showDlg();
            });
            
            L10n.localizeStatic(input);
            addDefaultListener = false;
            break;
        case 'multiEnum':
            input = qmte(`${tabRoot} .enum-value-editor-tmpl`);
            const list2 = profileSettings.value.split(',');
            list2.sort(CommonUtils.charOrdA);
            
            addEls(qee(input, '.text'), enumList2Els(list2));
            
            listen(qee(input, '.btn.add'), 'click', () => {
                addEls(clearEl(qee(state.multiEnumEditorDialog, '.initial-value')), enumList2Els(list2));
                const inputArea = qee(state.multiEnumEditorDialog, '.enum-value-input');
                inputArea.value = list2.join(',');
                inputArea.srcList = list2;
                state.multiEnumEditorDialog.itemName = profileSettings.name;
                state.multiEnumEditorDialog.showDlg();
            });
            
            listen(qee(input, '.btn.rename'), 'click', () => {
                const renameSelect = clearEl(qee(state.renameEnumItemDialog, '.renamed-value-select'));
                fillSelector(renameSelect, arr2Select(list2));
                
                if(list2.length > 0){
                    qee(state.renameEnumItemDialog, '.enum-value-name-input').value = list2[0]; 
                }
                
                state.renameEnumItemDialog.itemName = profileSettings.name;
                state.renameEnumItemDialog.showDlg();
            });
            
            L10n.localizeStatic(input);
            addDefaultListener = false;
            break;
        case 'string':
            input = makeEl('input');
            addClass(input, 'hidden');
            input.value = profileSettings.value;
            break;
        case 'number':
            input = makeEl('input');
            input.type = 'number';
            addClass(input, 'hidden');
            input.value = profileSettings.value;
            break;
        case 'checkbox':
            input = makeEl('input');
            setAttr(input, 'title', l10n('default-value'));
            input.type = 'checkbox';
            input.checked = profileSettings.value;
            break;
        default:
            throw new Errors.InternalError('errors-unexpected-switch-argument', [profileSettings.type]);
        }

        setProps(input, {
            info: profileSettings.name,
            infoType: profileSettings.type,
            oldValue: profileSettings.value
        });
        if(addDefaultListener){
            addClasses(input, [`profile-configurer-${profileSettings.type}`, 'adminOnly', 'form-control']);
            listen(input, 'change', updateDefaultValue(type));
        }
        addEl(qee(row, '.item-default-value-container'), input);

        setClassIf(qee(row, '.print'), 'btn-primary', profileSettings.doExport);
        listen(qee(row, '.print'), 'click', (e) => {
            DBMS.doExportProfileItemChange(type, profileSettings.name, !hasClass(e.target, 'btn-primary'), (err) => {
                if (err) { Utils.handleError(err); return; }
                toggleClass(e.target, 'btn-primary');
            });
        });

        const playerAccess = qee(row, '.player-access');
        fillPlayerAccessSel(playerAccess);
        playerAccess.value = profileSettings.playerAccess;
        playerAccess.info = profileSettings.name;
        playerAccess.oldValue = profileSettings.playerAccess;
        listen(playerAccess, 'change', changeProfileItemPlayerAccess(type));

        const showInRoleGrid = qee(row, '.show-in-role-grid');
        showInRoleGrid.checked = profileSettings.showInRoleGrid;
        showInRoleGrid.info = profileSettings.name;
        listen(showInRoleGrid, 'change', showInRoleGridChange(type));

        listen(qee(row, '.move'), 'click', () => {
            state.currentIndex = index;
            state.moveProfileItemDialog.showDlg();
        });

        listen(qee(row, '.rename-profile-item'), 'click', () => {
            qee(state.renameProfileItemDialog, '.entity-input').value = profileSettings.name;
            state.renameProfileItemDialog.fromName = profileSettings.name;
            state.renameProfileItemDialog.showDlg();
        });

        listen(qee(row, '.remove'), 'click', () => {
            Utils.confirm(L10n.format('profiles', 'are-you-sure-about-removing-profile-item', [profileSettings.name]), () => {
                DBMS.removeProfileItem(type, index, profileSettings.name, Utils.processError(exports.refresh));
            });
        });

        return row;
    });
    
    function enumList2Els(list, defaultValue){
        return R.splitEvery(4, list.map(val => {
            const span = addEl(makeEl('span'), makeText(val));
            if(defaultValue !== undefined && val === defaultValue){
                addClass(span, 'bold');
                setAttr(span, 'title', l10n('default-value'));
            }
            addClass(span, 'margin-right-16 enum-item');
            return span;
        })).map(arr => addEls(makeEl('div'), arr));
    }

    function updateDefaultValue(type) {
        return (event) => {
            const name = event.target.info;
            const itemType = event.target.infoType;
            const { oldValue } = event.target;

            const value = itemType === 'checkbox' ? event.target.checked : event.target.value;

            let newOptions, missedValues, newValue, updateEnum;

            switch (itemType) {
            case 'text':
            case 'string':
            case 'checkbox':
                DBMS.updateDefaultValue(type, name, value, Utils.processError());
                break;
            case 'number':
                if (Number.isNaN(value)) {
                    Utils.alert(getL10n('profiles-not-a-number'));
                    event.target.value = oldValue;
                    return;
                }
                DBMS.updateDefaultValue(type, name, Number(value), Utils.processError());
                break;
            case 'multiEnum':
            case 'enum':
                if (value === '' && itemType === 'enum') {
                    Utils.alert(getL10n('profiles-enum-item-cant-be-empty'));
                    event.target.value = oldValue;
                    return;
                }
                newOptions = value.split(',').map(R.trim);
                missedValues = oldValue.trim() === '' ? [] : R.difference(oldValue.split(','), newOptions);

                updateEnum = () => {
                    newValue = newOptions.join(',');
                    event.target.value = newValue;
                    event.target.oldValue = newValue;
                    DBMS.updateDefaultValue(type, name, newValue, Utils.processError());
                };

                if (missedValues.length !== 0) {
                    Utils.confirm(strFormat(getL10n('profiles-new-enum-values-remove-some-old-values'), [missedValues.join(',')]), updateEnum, () => {
                        event.target.value = oldValue;
                    });
                } else {
                    updateEnum();
                }
                break;
            default:
                Utils.handleError(new Errors.InternalError('errors-unexpected-switch-argument', [itemType]));
            }
        };
    }

    function showInRoleGridChange(type) {
        return (event) => {
            DBMS.showInRoleGridProfileItemChange(type, event.target.info, event.target.checked, Utils.processError());
        };
    }

    function renameProfileItem(dialog) {
        return () => {
            const toInput = qee(dialog, '.entity-input');
            const oldName = dialog.fromName;
            const newName = toInput.value.trim();

            DBMS.renameProfileItem(tabType, newName, oldName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    toInput.value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function moveProfileItem(dialog) {
        return () => {
            const index = state.currentIndex;
            const newIndex = queryEl(`${tabRoot}.move-entity-position-select`).selectedIndex;
            DBMS.moveProfileItem(tabType, index, newIndex, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }
    
    function updateEnumValues(dialog) {
        return () => {
            const name = dialog.itemName;
            const inputArea = qee(dialog, '.enum-value-input');
            const defaultValueSelect = qee(dialog, '.default-value-select');
            
            if (inputArea.value.trim() === '') {
                Utils.alert(getL10n('profiles-enum-item-cant-be-empty'));
                return;
            }
            let newVals = inputArea.value.split(',').map(R.trim).filter(R.pipe(R.equals(''), R.not));
            if(defaultValueSelect){
                const defaultValue = defaultValueSelect.value;
                newVals = R.without([defaultValue], newVals);
                newVals = R.prepend(defaultValue, newVals);
            }
            
            DBMS.updateDefaultValue(tabType, name, newVals.join(','), (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }
    
    function renameEnumValue(dialog) {
        return () => {
            const name = dialog.itemName;
            const renameSelect = qee(dialog, '.renamed-value-select');
            const renameInput = qee(dialog, '.enum-value-name-input');
            
            DBMS.renameEnumValue(tabType, name, renameSelect.value.trim(), renameInput.value.trim(), (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function changeProfileItemType(type) {
        return (event) => {
            Utils.confirm(strFormat(getL10n('profiles-are-you-sure-about-changing-profile-item-type'), [event.target.info]), () => {
                const newType = event.target.value;
                const name = event.target.info;
                DBMS.changeProfileItemType(type, name, newType, Utils.processError(exports.refresh));
            }, () => {
                event.target.value = event.target.oldType;
            });
        };
    }

    function changeProfileItemPlayerAccess(type) {
        return (event) => {
            const playerAccessType = event.target.value;
            const name = event.target.info;
            DBMS.changeProfileItemPlayerAccess(type, name, playerAccessType, (err) => {
                if (err) {
                    event.target.value = event.target.oldValue;
                    Utils.processError()(err);
                }
            });
        };
    }
}

ProfileConfigurerTmpl(this.CharacterConfigurer = {}, {
    tabType: 'character',
    panelName: 'characters-profile-structure',
});

ProfileConfigurerTmpl(this.PlayerConfigurer = {}, {
    tabType: 'player',
    panelName: 'players-profile-structure',
});

/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

function ProfileEditorTmpl(exports, opts) {
    const { firstType, secondType, settingsPath } = opts;

    const tmplRoot = '.profile-editor2-tab-tmpl';
    const root = `.profile-editor2-tab.${`${firstType}-type`} `;
    const state = {};
    const l10n = L10n.get('profiles');
    let profileEditorCore;
    const profilePanel = `${root}.profile-panel`;
    const reportByStories = `${root}.report-by-stories`;
    const reportByRelations = `${root}.report-by-relations`;
    const profileDiv = `${root}.profile-div`;
    const reportByStoriesDiv = `${root}.report-by-stories-div tbody`;
    const reportByRelationsDiv = `${root}.report-by-relations-div tbody`;
    const alertBlock = `${root}.alert-block`;

    exports.init = () => {
        profileEditorCore = ProfileEditorCore.makeProfileEditorCore();
        const el = queryEl(tmplRoot).cloneNode(true);

        addClasses(el, ['profile-editor2-tab', `${`${firstType}-type`}`]);
        removeClass(el, 'profile-editor2-tab-tmpl');
        addEl(queryEl('.tab-container'), el);

        const createCharacterDialog = UI.createModalDialog(
            `.profile-editor2-tab.${`${firstType}-type`}`,
            createProfile, {
                bodySelector: 'modal-prompt-body',
                dialogTitle: `profiles-${opts.createMsg}`,
                actionButtonTitle: 'common-create',
            }
        );
        listen(queryEl(`${root} .create`), 'click', () => createCharacterDialog.showDlg());
        state.renameCharacterDialog = UI.createModalDialog(`.${`${firstType}-type`}`, renameProfile, {
            bodySelector: 'modal-prompt-body',
            dialogTitle: `profiles-${opts.renameMsg}`,
            actionButtonTitle: 'common-rename',
        });

        hideEl(qee(el, '.report-by-stories'), firstType === 'player');
        hideEl(qee(el, '.report-by-relations'), firstType === 'player');
        setAttr(qee(el, '.entity-filter'), 'l10n-placeholder-id', `profiles-${opts.filterPlaceholder}`);
        setAttr(qee(el, '.profile-panel h3'), 'l10n-id', `profiles-${opts.panelName}`);
        setAttr(qee(el, '.create'), 'l10n-title', `profiles-${opts.createProfile}`);
        setAttr(qee(el, '.alert-block'), 'l10n-id', `advices-no-${firstType}`);
        L10n.localizeStatic(el);

        setAttr(qee(el, '.report-by-stories a'), 'panel-toggler', `${root}.report-by-stories-div`);
        setAttr(qee(el, '.report-by-relations a'), 'panel-toggler', `${root}.report-by-relations-div`);
        setAttr(qee(el, '.profile-panel a'), 'panel-toggler', `${root}.profile-div`);
        UI.initPanelTogglers(el);

        exports.content = el;
        listen(queryEl(`${root} .entity-filter`), 'input', filterOptions);
    };

    exports.refresh = () => {
        PermissionInformer.getEntityNamesArray(firstType, false, (err, primaryNames) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.getEntityNamesArray(secondType, false, (err2, secondaryNames) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getProfileBindings((err3, profileBindings) => {
                    if (err3) { Utils.handleError(err3); return; }
                    profileBindings = opts.processBindings(profileBindings);
                    Utils.enableEl(queryEl(`${root}.entity-filter`), primaryNames.length > 0);
                    rebuildInterface(primaryNames, secondaryNames, profileBindings);
                });
            });
        });
    };

    function rebuildInterface(primaryNames, secondaryNames, profileBindings) {
        const secDict = R.indexBy(R.prop('value'), secondaryNames);
        addEls(clearEl(queryEl(`${root} .entity-list`)), primaryNames.map((name, i, arr) => {
            const el = wrapEl('div', qte(`${root} .entity-item-tmpl`));
            addEl(qee(el, '.primary-name'), makeText(name.displayName));
            setAttr(el, 'primary-name', name.displayName);
            setAttr(el, 'profile-name', name.value);
            if (profileBindings[name.value] !== undefined) {
                const secondaryName = secDict[profileBindings[name.value]].displayName;
                addEl(qee(el, '.secondary-name'), makeText(secondaryName));
                setAttr(el, 'secondary-name', secondaryName);
            }
            listen(qee(el, '.select-button'), 'click', () => selectProfile(name.value));
            setAttr(qee(el, '.rename'), 'title', l10n(opts.renameProfile));
            const removeBtn = qee(el, '.remove');
            setAttr(removeBtn, 'title', l10n(opts.removeProfile));
            if(i+1 < arr.length){
                removeBtn.nextName = arr[i+1].value;
            }
            if(i > 0){
                removeBtn.prevName = arr[i-1].value;
            }
            if (name.editable) {
                listen(qee(el, '.rename'), 'click', () => {
                    qee(state.renameCharacterDialog, '.entity-input').value = name.value;
                    state.renameCharacterDialog.fromName = name.value;
                    state.renameCharacterDialog.showDlg();
                });
                listen(removeBtn, 'click', removeProfile(firstType, name.value, removeBtn));
            } else {
                setAttr(qee(el, '.rename'), 'disabled', 'disabled');
                setAttr(removeBtn, 'disabled', 'disabled');
            }
            return el;
        }));

        const callback = () => {
            selectProfile(UI.checkAndGetEntitySetting(settingsPath, primaryNames));
        };
        DBMS.getProfileStructure(firstType, (err2, allProfileSettings) => {
            if (err2) { Utils.handleError(err2); return; }
            profileEditorCore.initProfileStructure(profileDiv, firstType, allProfileSettings, callback);
        });
    }

    function selectProfile(name) {
        hideEl(queryEl(profilePanel), name === null);
        hideEl(queryEl(reportByStories), name === null || firstType === 'player');
        hideEl(queryEl(reportByRelations), name === null || firstType === 'player');
        hideEl(queryEl(alertBlock), name !== null);
        
        if(name === null){
            return;
        }
        
        UI.updateEntitySetting(settingsPath, name);
        queryEls(`${root} [profile-name] .select-button`).map(removeClass(R.__, 'btn-primary'));
        const el = queryEl(`${root} [profile-name="${name}"] .select-button`);
        addClass(el, 'btn-primary');
        
        const parentEl = el.parentElement.parentElement;
        const entityList = queryEl(`${root} .entity-list`);
        UI.scrollTo(entityList, parentEl);
        
        DBMS.getProfile(firstType, name, (err, profile) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.isEntityEditable(firstType, name, (err2, isProfileEditable) => {
                if (err2) { Utils.handleError(err2); return; }
                removeClass(queryEl(profileDiv), 'hidden');
                profileEditorCore.fillProfileInformation(profileDiv, firstType, profile, () => isProfileEditable);

                if (firstType === 'character') {
                    DBMS.getCharacterReport(name, (err3, characterReport) => {
                        if (err3) { Utils.handleError(err3); return; }
                        DBMS.getRelationsSummary(name, (err4, relationsSummary) => {
                            if (err4) { Utils.handleError(err4); return; }
                            
                            hideEl(queryEl(`${reportByStories} .alert`), characterReport.length !== 0);
                            hideEl(queryEl(`${reportByStories} table`), characterReport.length === 0);
                            
                            if(characterReport.length !== 0){
                                removeClass(queryEl(reportByStoriesDiv), 'hidden');
                                addEls(
                                        clearEl(queryEl(reportByStoriesDiv)),
                                        characterReport.map(CharacterReports.makeStoryReportRow)
                                );
                            }
                            
                            hideEl(queryEl(`${reportByRelations} .alert`), relationsSummary.relations.length !== 0);
                            hideEl(queryEl(`${reportByRelations} table`), relationsSummary.relations.length === 0);
                            
                            if(relationsSummary.relations.length !== 0){
                                removeClass(queryEl(reportByRelationsDiv), 'hidden');
                                relationsSummary.relations.sort(CommonUtils.charOrdAFactory(rel =>
                                        ProjectUtils.get2ndRelChar(name, rel).toLowerCase()));
                                
                                addEls(clearEl(queryEl(reportByRelationsDiv)), relationsSummary.relations
                                        .map(CharacterReports.makeRelationReportRow(name)));
                            }
                        });
                    });
                }
            });
        });
    }

    function filterOptions(event) {
        const str = event.target.value.toLowerCase();

        const els = queryEls(`${root} [primary-name]`);
        els.forEach((el) => {
            let isVisible = getAttr(el, 'primary-name').toLowerCase().indexOf(str) !== -1;
            if (!isVisible && getAttr(el, 'secondary-name') !== null) {
                isVisible = getAttr(el, 'secondary-name').toLowerCase().indexOf(str) !== -1;
            }
            hideEl(el, !isVisible);
        });

        if (queryEl(`${root} .hidden[primary-name] .select-button.btn-primary`) !== null ||
            queryEl(`${root} [primary-name] .select-button.btn-primary`) === null) {
            const els2 = queryEls(`${root} [primary-name]`).filter(R.pipe(hasClass(R.__, 'hidden'), R.not));
            selectProfile(els2.length > 0 ? getAttr(els2[0], 'profile-name') : null);
        } else {
            //            queryEl(`${root} [primary-name] .select-button.btn-primary`).scrollIntoView();
        }
    }

    function createProfile(dialog) {
        return () => {
            const input = qee(dialog, '.entity-input');
            const value = input.value.trim();

            DBMS.createProfile(firstType, value, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    UI.updateEntitySetting(settingsPath, value);
                    PermissionInformer.refresh((err2) => {
                        if (err2) { Utils.handleError(err2); return; }
                        input.value = '';
                        dialog.hideDlg();
                        exports.refresh();
                    });
                }
            });
        };
    }

    function renameProfile(dialog) {
        return () => {
            const toInput = qee(dialog, '.entity-input');
            const { fromName } = dialog;
            const toName = toInput.value.trim();

            DBMS.renameProfile(firstType, fromName, toName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    UI.updateEntitySetting(settingsPath, toName);
                    toInput.value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function removeProfile(type, name, btn) {
        return () => {
            Utils.confirm(strFormat(l10n(opts.removeMsg), [name]), () => {
                DBMS.removeProfile(type, name, (err) => {
                    if (err) { Utils.handleError(err); return; }
                    PermissionInformer.refresh((err2) => {
                        if (err2) { Utils.handleError(err2); return; }
                        if(btn.nextName !== undefined){
                            UI.updateEntitySetting(settingsPath, btn.nextName);
                        } else if(btn.prevName !== undefined) {
                            UI.updateEntitySetting(settingsPath, btn.prevName);
                        }
                        
                        exports.refresh();
                    });
                });
            });
        };
    }
}

ProfileEditorTmpl(this.CharacterEditor = {}, {
    firstType: 'character',
    secondType: 'player',
    settingsPath: 'Characters',
    processBindings: R.identity,
    createMsg: 'enter-character-name',
    renameMsg: 'enter-new-character-name',
    removeMsg: 'are-you-sure-about-character-removing',
    filterPlaceholder: 'find-character',
    panelName: 'character-profile',
    createProfile: 'create-character',
    renameProfile: 'rename-character',
    removeProfile: 'remove-character',
});

ProfileEditorTmpl(this.PlayerEditor = {}, {
    firstType: 'player',
    secondType: 'character',
    settingsPath: 'Players',
    processBindings: R.invertObj,
    createMsg: 'enter-player-name',
    renameMsg: 'enter-new-player-name',
    removeMsg: 'are-you-sure-about-player-removing',
    filterPlaceholder: 'find-player',
    panelName: 'player-profile',
    createProfile: 'create-player',
    renameProfile: 'rename-player',
    removeProfile: 'remove-player',
});

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.role-grid-tab ';
    let groupingOrder;
    let profilesData;
    let buttons;
    const l10n = L10n.get('role-grid');

    exports.init = () => {
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        DBMS.getRoleGridInfo((err, data2) => {
            if (err) { Utils.handleError(err); return; }
            groupingOrder = [];
            buttons = [];
            
            showEl(qe(`${root} .alert.no-character-profile`), data2.characterProfileStructure.length === 0);
            showEl(qe(`${root} .alert.no-characters`), data2.profileData.length === 0);
            
            showEl(qe(`${root} > .container-fluid`), data2.profileData.length !== 0 && data2.characterProfileStructure.length !== 0);

            // hack - dynamically replace checkbox with enum
            const checkboxes = data2.characterProfileStructure.filter(el => el.type === 'checkbox').map(R.prop('name'));
            data2.characterProfileStructure = data2.characterProfileStructure.map((el) => {
                if (el.type === 'checkbox') {
                    return {
                        doExport: el.doExport,
                        name: el.name,
                        playerAccess: el.playerAccess,
                        showInRoleGrid: el.showInRoleGrid,
                        type: 'enum',
                        value: [L10n.get('constant', 'yes'), L10n.get('constant', 'no')].join(','),
                    };
                }
                return el;
            });
            profilesData = data2;
            data2.profileData.forEach((el) => {
                checkboxes.forEach((name) => {
                    el.character[name] = L10n.get('constant', el.character[name] === true ? 'yes' : 'no');
                });
            });

            const sorter = CommonUtils.charOrdAFactory(a => a.toLowerCase());
            const filter = el => el.type === 'enum';
            const groupingItems = profilesData.characterProfileStructure.filter(filter).map(R.prop('name')).sort(sorter);

            addEls(clearEl(queryEl(`${root}.button-container`)), groupingItems.map((item, i) => {
                const button = addEl(makeEl('a'), makeText(item));
                button.item = item;
                setAttr(button, 'draggable', 'true');
                setAttr(button, 'role', 'button');
                setAttr(button, 'href', '#');
                setAttr(button, 'order', i + 1);
                setStyle(button, 'order', i + 1);
                addClasses(button, ['btn', 'btn-default']);
                listen(button, 'dragstart', onDragStart);
                listen(button, 'drop', onDrop);
                listen(button, 'dragover', allowDrop);
                listen(button, 'dragenter', handleDragEnter);
                listen(button, 'dragleave', handleDragLeave);
                listen(button, 'click', () => {
                    toggleClass(button, 'btn-primary');
                    drawList();
                });
                buttons.push(button);
                return button;
            }));

            drawList();
            //            drawPlainPanelList();
        });
    };

    // eslint-disable-next-line no-var,vars-on-top
    var onDragStart = function (event){
        console.log(`onDragStart ${this.item}`);
        event.dataTransfer.setData('data', JSON.stringify({ item: this.item, order: getAttr(this, 'order') }));
        event.dataTransfer.effectAllowed = 'move';
    };

    // eslint-disable-next-line no-var,vars-on-top
    var onDrop = function (event) {
        console.log(`onDrop ${this.item}${event.dataTransfer.getData('data')}`);
        if (event.stopPropagation) {
            event.stopPropagation(); // stops the browser from redirecting.
        }
        updateButtons(JSON.parse(event.dataTransfer.getData('data')), { item: this.item, order: getAttr(this, 'order') });
    };

    // eslint-disable-next-line no-var,vars-on-top
    var allowDrop = function (event) {
        console.log(`allowDrop ${this.item}`);
        event.preventDefault();
    };

    function handleDragEnter(event) {
        addClass(this, 'over');
    }

    function handleDragLeave(event) {
        removeClass(this, 'over');
    }

    // eslint-disable-next-line no-var,vars-on-top
    var updateButtons = (dragStarter, dragReceiver) => {
        const startOrder = Number(dragStarter.order) - 1;
        const receiveOrder = Number(dragReceiver.order) - 1;
        const button = buttons.splice(startOrder, 1)[0];
        buttons = R.insert(receiveOrder, button, buttons);
        buttons.forEach((button2, i) => {
            setAttr(button2, 'order', i + 1);
            setStyle(button2, 'order', i + 1);
        });
        drawList();
    };

    // eslint-disable-next-line no-var,vars-on-top
    var drawList = () => {
        groupingOrder = buttons.filter(hasClass(R.__, 'btn-primary')).map(R.prop('item'));
        drawGroupedList((groupingOrder.length > 0) ? getTreeByUserSelect() : getTreeByAlphabet());
        //        (groupingOrder.length > 0) ? drawGroupedList() : drawPlainPanelList();
    };

    // eslint-disable-next-line no-var,vars-on-top
    var getTreeByAlphabet = () =>
        //        var groups = R.groupBy((profile) => {
        //            return profile.characterName[0];
        //        }, profilesData.profileData);
        //
        //        var structures = R.toPairs(groups).map(pair => ({
        //            key: pair[0],
        //            lastKeyPart: pair[0],
        //            groups: pair[1]
        //        }));
        //
        //        structures.sort(CommonUtils.charOrdAFactory(R.prop('key')));
        //        return structures;
        [{
            key: l10n('all-characters'),
            lastKeyPart: l10n('all-characters'),
            groups: profilesData.profileData
        }];

    // eslint-disable-next-line no-var,vars-on-top
    var getTreeByUserSelect = () => {
        const groups = R.groupBy(profile => groupingOrder.map(name => profile.character[name]).join('/'), profilesData.profileData);

        const groupingItemInfo = R.indexBy(R.prop('name'), profilesData.characterProfileStructure.filter(el => R.contains(el.name, groupingOrder)));

        return [{
            key: l10n('all-characters'),
            lastKeyPart: l10n('all-characters'),
            children: makeGroupTree(groups, groupingItemInfo, 0, [])
        }];
    };

    //            var filter = el => el.type === 'enum' || el.type === 'checkbox';

    // eslint-disable-next-line no-var,vars-on-top
    var drawGroupedList = (structures) => {
        //        structures = [{
        //            "key": l10n('all-characters'),
        //            "lastKeyPart": l10n('all-characters'),
        //            "children": structures
        //        }];
        //        console.log(JSON.stringify(structures));

        structures.forEach(calcSize);

        // addEl(queryEl(root + '.group-content'), addEls(addClasses(makeEl('ul'), ['remove-ul-dots', 'zero-padding']),
        // makeGroupTree(groups, groupingItemInfo, 0, [])));
        addEl(clearEl(queryEl(`${root}.group-content`)), addEls(addClasses(
            makeEl('ul'),
            ['remove-ul-dots', 'zero-padding']
        ), R.flatten(structures.map(renderGroupStructure))));
    };

    const makeHeader = (text, characterNum, playerNum) => {
        const characterBadge = addEl(addClass(makeEl('span'), 'badge'), makeText(`${characterNum} / ${playerNum}`));
        setAttr(characterBadge, 'title', L10n.format('role-grid', 'badge-title', [characterNum, playerNum]));
        //        const playerBadge = addEl(addClass(makeEl('span'), 'badge'), makeText(playerNum));

        const h3 = addEls(addClass(makeEl('h3'), 'panel-title'), [makeText(` ${text} `), characterBadge]);
        const a = setAttr(makeEl('a'), 'href', '#/');
        setAttr(a, 'tree-panel-toggler', '');
        const heading = addEl(addClass(makeEl('div'), 'panel-heading'), addEls(a, [h3]));
        return addEl(addClasses(makeEl('div'), ['panel', 'panel-default', 'inline-panel']), heading);
        // var heading = addEl(addClass(makeEl('div'), 'panel-heading'),
        //      addEl(addClass(makeEl('h3'), 'panel-title'), makeText(text)));
        // return addEl(addClasses(makeEl('div'), ['panel', 'panel-default']), heading);
    };

    // eslint-disable-next-line no-var,vars-on-top
    var calcSize = (el) => {
        if (el.children) {
            el.children.forEach(calcSize);
            el.characterNum = R.sum(el.children.map(R.prop('characterNum')));
            el.playerNum = R.sum(el.children.map(R.prop('playerNum')));
        } else { // groups
            el.characterNum = el.groups.length;
            el.playerNum = el.groups.filter(R.pipe(R.prop('playerName'), R.isNil, R.not)).length;
        }
    };

    // eslint-disable-next-line no-var,vars-on-top
    var renderGroupStructure = (el) => {
        //        return R.flatten(structure.map(el => {
        let domChildren, header;
        if (el.children) {
            domChildren = addEls(addClass(makeEl('ul'), 'remove-ul-dots'), R.flatten(el.children.map(renderGroupStructure)));
            header = makeHeader(el.lastKeyPart, el.characterNum, el.playerNum);
            UI.attachPanelToggler(queryElEl(header, 'a'), domChildren);
            return R.concat([addEl(makeEl('li'), header)], [domChildren]);
        } // groups
        //            var panelList = makePanelList(el.groups).map(addClasses(R.__,['inline-panel']));
        const panelList = makePanelList(el.groups).map(addClasses(R.__, ['inline-panel', 'col-xs-6']));
        //            var panelList = makePanelList(el.groups).map(addClasses(R.__,['inline-panel', 'col-xs-4']));
        const row = addClass(makeEl('div'), 'row');
        const container = addEl(addClass(makeEl('div'), 'list-content-padding container-fluid'), row);
        domChildren = addEls(row, panelList);
        header = makeHeader(el.key, el.characterNum, el.playerNum);
        UI.attachPanelToggler(queryElEl(header, 'a'), container);
        return R.concat([addEl(makeEl('li'), header)], [container]);
        // var container = addClass(makeEl('div'), 'list-content-padding container-fluid');
        // domChildren = addEls(container, panelList);
        // return R.concat([addEl(makeEl('li'), makeHeader(el.key, el.characterNum, el.playerNum))], [domChildren]);


        //        }));
    };

    // eslint-disable-next-line no-var,vars-on-top
    var makeGroupTree = (groups, groupingItemInfo, index, key) => {
        const arr = groupingItemInfo[groupingOrder[index]].value.split(',').map((name) => {
            const nextKey = R.concat(key, [name]);
            //            var nextKey = R.concat(key, [groupingOrder[index] + ': ' + name]);
            const lastKeyPart = `${groupingOrder[index]}: ${name}`;
            //            var domChildren;
            if (groupingOrder.length !== index + 1) {
                const children = makeGroupTree(groups, groupingItemInfo, index + 1, nextKey);
                if (children === null) {
                    return null;
                }
                //                domChildren = [addEls(addClass(makeEl('ul'), 'remove-ul-dots'), children)];
                return {
                    key: nextKey.join(' / '),
                    lastKeyPart,
                    children
                };
            }
            const fullKey = nextKey.join('/');
            if (groups[fullKey] === undefined) {
                return null;
            }
            // domChildren = [addEls(addClass(makeEl('div'), 'list-content-padding'), makePanelList(groups[fullKey]))];
            return {
                key: nextKey.join(' / '),
                lastKeyPart,
                groups: groups[fullKey]
            };

            //            return R.concat([addEl(makeEl('li'), makeHeader(name))], domChildren);
            //            return R.concat([addEl(makeEl('li'), makeHeader(nextKey.join(' / ')))], domChildren);
            //            return {
            //                name: nextKey.join(' / '),
            //                children:
            //            }
        }).filter(el => el !== null);
        return arr.length === 0 ? null : arr;
        //        if(arr.length === 0){
        //            return null;
        //        } else {
        //            return R.flatten(arr);
        //        }
    };

    const drawPlainPanelList = () => {
        addEls(clearEl(queryEl(`${root}.group-content`)), makePanelList(profilesData.profileData));
    };

    // eslint-disable-next-line no-var,vars-on-top
    var makePanelList = profileArray =>
        profileArray.sort(CommonUtils.charOrdAFactory(a => a.characterName.toLowerCase())).map((profileData) => {
            const tables = [UI.makeProfileTable(profilesData.characterProfileStructure, profileData.character)];
            let title = profileData.characterName;
            if (profileData.playerName !== undefined) {
                tables.push(UI.makeProfileTable(profilesData.playerProfileStructure, profileData.player));
                title += `/${profileData.playerName}`;
            }

            const panelInfo = UI.makePanelCore(makeText(title), addEls(makeEl('div'), tables));
            UI.attachPanelToggler(panelInfo.a, panelInfo.contentDiv, (event, togglePanel) => {
                queryEls(`${root}.group-content .expanded[panel-toggler]`).filter(el =>
                    !el.contains(event.target)).forEach(el => el.click());
                togglePanel();
            });
            panelInfo.a.click();

            return panelInfo.panel;
        });
})(this.RoleGrid = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */


'use strict';

((exports) => {
    const root = '.enter-tab ';

    exports.init = () => {
        $(document.forms['login-form']).on('submit', submit);
        exports.content = queryEl(root);
    };

    exports.refresh = () => {

    };

    function submit() {
        const form = $(this);

        $('.error', form).html('');
        //        $(":submit", form).button("loading");

        const request = $.ajax({
            url: '/login',
            method: 'POST',
            data: form.serialize(),
            complete() {
                $(':submit', form).button('reset');
            },
            //             statusCode : {
            //                 200 : function() {
            //                 },
            //                 403 : function(jqXHR) {
            //                     var error = JSON.parse(jqXHR.responseText);
            //                     $('.error', form).html(error.message);
            //                 }
            //             }
        });
        request.done((data) => {
            //             //window.location.href = "/chat";
            //             window.location.href = "/nims.html";
            window.location.href = '/page.html';
        });

        request.fail((errorInfo, textStatus, errorThrown) => {
            let msg;
            try {
                msg = Utils.handleErrorMsg(JSON.parse(errorInfo.responseText));
            } catch (err) {
                msg = Utils.handleErrorMsg(errorInfo.responseText || textStatus || 'error');
            }
            //             var error = JSON.parse(jqXHR.responseText);
            //             $('.error', form).html(error.message);
            //            $('.error', form).html(textStatus);
            $('.error', form).html(msg);
        });

        return false;
    }
})(this.Enter = {});

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.player-tab ';
    const characterProfileDiv = `${root}.character-profile-div`;
    const playerProfileDiv = `${root}.player-profile-div`;
    const playerHeader = `${root}.player-profile-header`;
    const characterHeader = `${root}.character-profile-header`;

    let profileEditorCore;

    exports.init = () => {
        profileEditorCore = ProfileEditorCore.makeProfileEditorCore();
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        DBMS.getWelcomeText((err, text) => {
            if (err) { Utils.handleError(err); return; }
            DBMS.getPlayerProfileInfo((err2, profileInfo) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getPlayersOptions((err3, playersOptions) => {
                    if (err3) { Utils.handleError(err3); return; }
                    buildInterface(text, profileInfo, playersOptions);
                });
            });
        });
    };

    function isEditable(profileName, profileStructure) {
        return R.find(R.propEq('name', profileName), profileStructure).playerAccess === 'write';
    }

    function buildInterface(text, profileInfo, playersOptions) {
        profileEditorCore.initProfileStructure(playerProfileDiv, 'player', profileInfo.player.profileStructure);
        profileEditorCore.fillProfileInformation(playerProfileDiv, 'player', profileInfo.player.profile, isEditable);
        addEl(clearEl(queryEl(playerHeader)), makeText(strFormat(getL10n('briefings-player-profile'), [profileInfo.player.profile.name])));

        if (profileInfo.character === undefined) {
            addEl(clearEl(queryEl(characterHeader)), makeText(strFormat(getL10n('briefings-character-profile'), [''])));
            const el = clearEl(queryEl(characterProfileDiv));
            if (playersOptions.allowCharacterCreation) {
                const label = addEl(makeEl('div'), makeText(getL10n('profiles-player-has-no-character-and-can-create-it')));
                addClass(label, 'margin-bottom-8');
                const input = setAttr(makeEl('input'), 'placeholder', getL10n('profiles-character-name'));
                addClass(input, 'form-control margin-bottom-8');
                const button = addEl(makeEl('button'), makeText(getL10n('common-create')));
                addClass(button, 'btn btn-default');
                listen(button, 'click', () => {
                    DBMS.createCharacterByPlayer(input.value.trim(), Utils.processError(exports.refresh));
                });
                addEls(el, [label, input, button]);
            } else {
                addEl(el, addEl(makeEl('span'), makeText(getL10n('profiles-player-has-no-character-and-cant-create-it'))));
            }
        } else {
            profileEditorCore.initProfileStructure(characterProfileDiv, 'character', profileInfo.character.profileStructure);
            profileEditorCore.fillProfileInformation(characterProfileDiv, 'character', profileInfo.character.profile, isEditable);
            addEl(clearEl(queryEl(characterHeader)), makeText(strFormat(getL10n('briefings-character-profile'), [profileInfo.character.profile.name])));
        }

        queryEl(`${root}.welcome-text-area`).value = text;
    }
})(this.Player = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */


'use strict';

((exports) => {
    const root = '.sign-up-tab ';

    exports.init = () => {
        $(document.forms['sign-up-form']).on('submit', submit);
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
    };

    function submit() {
        const form = $(this);

        $('.error', form).html('');
        $(':submit', form).button('loading');

        const request = $.ajax({
            url: '/signUp',
            method: 'POST',
            data: form.serialize(),
            complete() {
                $(':submit', form).button('reset');
            },
        });
        request.done((data) => {
            form.html(getL10n('entrance-sign-up-success')).addClass('alert-success');
        });

        request.fail((errorInfo, textStatus, errorThrown) => {
            let msg;
            try {
                msg = Utils.handleErrorMsg(JSON.parse(errorInfo.responseText));
            } catch (err) {
                msg = Utils.handleErrorMsg(errorInfo.responseText || textStatus || 'error');
            }
            $('.error', form).html(msg);
        });

        return false;
    }
})(this.SignUp = {});

/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.sliders-tab ';
    const state = {};
    state.sliders = [];
    
    exports.init = () => {
        const createSliderDialog = UI.createModalDialog(root, createSlider, {
            bodySelector: 'create-slider-body',
            dialogTitle: 'sliders-create-slider',
            actionButtonTitle: 'common-create',
        });
        
        state.editSliderDialog = UI.createModalDialog(root, editSlider, {
            bodySelector: 'create-slider-body',
            dialogTitle: 'sliders-edit-slider',
            actionButtonTitle: 'common-save',
        });
        
        state.moveSliderDialog = UI.createModalDialog(root, moveSlider, {
            bodySelector: 'move-slider-body',
            dialogTitle: 'sliders-move-slider',
            actionButtonTitle: 'common-move',
        });
        
        listen(qe(`${root} .create`), 'click', () => createSliderDialog.showDlg());
        
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        DBMS.getSliderDataPm().then(createSliders).catch(Utils.handleError);
    };
    
    function createSliders(model) {
        const positions = model.map( info => {return {name: strFormat(L10n.get('common', 'set-item-before'), [info.name])}});
        positions.push({name: L10n.get('common', 'set-item-as-last')});
        fillSelector(clearEl(qe(`${root} .move-slider-pos-select`)), positions);
        
        addEls(clearEl(queryEl('.mixer-panel .panel-body')), model.map( makeSliderBackbone )) ;
        
        clearEls(state.sliders);
        
        state.sliders = model.map( (sl, i) => {
            const slider = new Slider('.mixer-panel .panel-body input[pos="' + i + '"]', {
                max: 10,
                min: -10,
                orientation: 'vertical',
                reversed: true,
                tooltip: 'always',
                value: sl.value,
                formatter: function(value) {
                    return Math.abs(value);
                },
            });
            slider.on('change', (event) => {
                DBMS.updateSliderValuePm(i, event.newValue).catch(Utils.handleError);
            });
            return slider;
        });
    }
    
    var makeSliderBackbone = (sl, i) => {
        const el = qmte(`${root} .slider-container-tmpl`);
        setAttr(qee(el, 'input'), 'pos', i);
        addEl(qee(el, '.slider-name'), makeText(sl.name));
        addEl(qee(el, '.slider-top'), makeText(sl.top));
        addEl(qee(el, '.slider-bottom'), makeText(sl.bottom));
        
        listen(qee(el, 'button.move'), 'click', () => {
            state.moveSliderDialog.currentIndex = i;
            state.moveSliderDialog.showDlg();
        });
        listen(qee(el, 'button.rename'), 'click', () => {
            qee(state.editSliderDialog, '.slider-name').value = sl.name;
            qee(state.editSliderDialog, '.slider-top').value = sl.top;
            qee(state.editSliderDialog, '.slider-bottom').value = sl.bottom;
            state.editSliderDialog.pos = i;
            state.editSliderDialog.showDlg();
        });
        listen(qee(el, 'button.remove'), 'click', () => {
            Utils.confirm(L10n.format('sliders', 'are-you-sure-about-removing-slider', [sl.name]), () => {
                DBMS.removeSlider(i, Utils.processError(exports.refresh));
            })
        });
        L10n.localizeStatic(el);
        return el;
    };
    
    function createSlider(dialog) {
        return () => {
            const name = qee(dialog, '.slider-name').value.trim();
            const top = qee(dialog, '.slider-top').value.trim();
            const bottom = qee(dialog, '.slider-bottom').value.trim();
            DBMS.createSlider(name, top, bottom, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    qee(dialog, '.slider-name').value = '';
                    qee(dialog, '.slider-top').value = '';
                    qee(dialog, '.slider-bottom').value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }
    
    function editSlider(dialog) {
        return () => {
            const name = qee(dialog, '.slider-name').value.trim();
            const top = qee(dialog, '.slider-top').value.trim();
            const bottom = qee(dialog, '.slider-bottom').value.trim();
            const pos = dialog.pos;
            DBMS.updateSliderNaming(pos, name, top, bottom, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    qee(dialog, '.slider-name').value = '';
                    qee(dialog, '.slider-top').value = '';
                    qee(dialog, '.slider-bottom').value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        }
    }
    
    function moveSlider(dialog) {
        return () => {
            var index = dialog.currentIndex;
            var pos = qee(dialog, '.move-slider-pos-select').selectedIndex;
            
            DBMS.moveSlider(index, pos, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            })
        }
    }
})(this.Sliders = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS, Stories
 */

'use strict';

((exports) => {
    const state = {};
    exports.name = 'EventPresence';
    const root = '#eventPresenceDiv ';

    exports.init = () => {
        listen(getEl('eventPresenceSelector'), 'change', UI.showSelectedEls3(root, 'dependent', 'dependent-index'));
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        const tableHead = getEl('eventPresenceTableHead');
        const table = getEl('eventPresenceTable');
        const characterSelector = getEl('eventPresenceSelector');

        if (Stories.getCurrentStoryName() === undefined) {
            clearEl(tableHead);
            clearEl(table);
            clearEl(characterSelector);
            return;
        }

        PermissionInformer.isEntityEditable('story', Stories.getCurrentStoryName(), (err, isStoryEditable) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.getEntityNamesArray('character', false, (err2, allCharacters) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getStoryCharacterNamesArray(Stories.getCurrentStoryName(), (err3, characterArray) => {
                    if (err3) { Utils.handleError(err3); return; }
                    const map = {};
                    allCharacters.forEach((elem) => {
                        map[elem.value] = elem;
                    });
                    const dataArray = characterArray.map(elem => map[elem]);

                    dataArray.sort(Utils.charOrdAObject);

                    const displayArray = dataArray.map(elem => elem.displayName);
                    characterArray = dataArray.map(elem => elem.value);

                    DBMS.getStoryEvents(Stories.getCurrentStoryName(), (err4, events) => {
                        if (err4) { Utils.handleError(err4); return; }

                        clearEl(tableHead);
                        clearEl(table);
                        
                        showEl(queryEl(`${root} .alert.no-characters`), characterArray.length === 0);
                        showEl(queryEl(`${root} .alert.no-events`), events.length === 0);
                        showEl(queryEl(`${root} .panel-body`), events.length !== 0 && characterArray.length !== 0);
                        
                        UI.fillShowItemSelector(
                            clearEl(characterSelector),
                            displayArray.map(name => ({ name, hidden: false }))
                        );

                        appendTableHeader(tableHead, displayArray);
                        events.forEach((event, i) => {
                            appendTableInput(table, event, i, characterArray);
                            Utils.enable(exports.content, 'isStoryEditable', isStoryEditable);
                        });
                    });
                });
            });
        });
    };

    function appendTableHeader(table, characterArray) {
        const eventName = addEl(makeEl('th'), makeText(getL10n('stories-event')));
        const els = characterArray.map((characterName, i) => {
            const th = addEl(makeEl('th'), makeText(characterName));
            addClass(th, `dependent`);
            setAttr(th, 'dependent-index', i);
            return th;
        });
        addEl(table, addEls(makeEl('tr'), R.concat([eventName], els)));
    }

    function appendTableInput(table, event, i, characterArray) {
        const tr = makeEl('tr');
        let td = makeEl('td');
        td.appendChild(makeText(event.name));
        tr.appendChild(td);

        addEls(tr, characterArray.map((character, j) => {
            const td = qmte(`${root} .event-presence-cell`);
            addClass(td, `dependent`);
            setAttr(td, 'dependent-index', j);
            const input = qee(td, 'input');
            const label = qee(td, 'label');
            if (event.characters[character]) {
                input.checked = true;
            }
            input.eventIndex = i;
            input.eventName = event.name;
            input.characterName = character;
            input.hasText = event.characters[character] !== undefined && event.characters[character].text !== '';
            input.addEventListener('change', onChangeCharacterCheckbox);
            
            const span = qee(td, 'span');
            if(event.characters[character] !== undefined){
                if(event.characters[character].ready){
                    addClass(span, 'finished');
                    setAttr(span, 'title', L10n.get('adaptations', 'adaptation-finished'));
                } else if(input.hasText) {
                    addClass(span, 'in-progress');
                    setAttr(span, 'title', L10n.get('adaptations', 'adaptation-in-progress'));
                }
            }
            
            const id = i + character;
            setAttr(input, 'id', id);
            setAttr(label, 'for', id);
            return td;
        }));

        table.appendChild(tr);
    }

    function onChangeCharacterCheckbox(event) {
        if (event.target.checked) {
            DBMS.addCharacterToEvent(
                Stories.getCurrentStoryName(),
                event.target.eventIndex, event.target.characterName, Utils.processError()
            );
        } else if (!event.target.hasText) {
            DBMS.removeCharacterFromEvent(
                Stories.getCurrentStoryName(),
                event.target.eventIndex, event.target.characterName, Utils.processError()
            );
        } else {
            Utils.confirm(strFormat(
                getL10n('stories-remove-character-from-event-warning'),
                [event.target.characterName, event.target.eventName]
            ), () => {
                DBMS.removeCharacterFromEvent(
                    Stories.getCurrentStoryName(),
                    event.target.eventIndex, event.target.characterName, Utils.processError()
                );
            }, () => {
                event.target.checked = true;
            });
        }
    }
})(this.EventPresence = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS, StoryEvents, StoryCharacters, EventPresence
 */

'use strict';

((exports) => {
    const state = {};
    const root = '.stories-tab ';

    exports.init = () => {
        const createStoryDialog = UI.createModalDialog(root, createStory, {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'stories-enter-story-name',
            actionButtonTitle: 'common-create',
        });

        const renameStoryDialog = UI.createModalDialog(root, renameStory, {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'stories-enter-new-story-name',
            actionButtonTitle: 'common-rename',
        });

        state.left = { views: {} };
        state.right = { views: {} };
        let containers = {
            root: state.left,
            navigation: queryEl('.stories-navigation-container .left-side'),
            content: queryEl('.stories-content-container .left-side')
        };
        Utils.addView(containers, 'writer-story', WriterStory, { mainPage: true, toggle: true });
        Utils.addView(containers, 'story-events', StoryEvents, { toggle: true });
        Utils.addView(containers, 'story-characters', StoryCharacters, { toggle: true });
        Utils.addView(containers, 'event-presence', EventPresence, { toggle: true });
        containers = {
            root: state.right,
            navigation: queryEl('.stories-navigation-container .right-side'),
            content: queryEl('.stories-content-container .right-side')
        };
        Utils.addView(containers, 'writer-story', WriterStory, { toggle: true });
        Utils.addView(containers, 'story-events', StoryEvents, { mainPage: true, toggle: true });
        Utils.addView(containers, 'story-characters', StoryCharacters, { toggle: true });
        Utils.addView(containers, 'event-presence', EventPresence, { toggle: true });

        listen(queryEl(`${root}.remove.story`), 'click', removeStory);

        listen(qe(`${root}.create.story`), 'click', () => createStoryDialog.showDlg());
        listen(qe(`${root}.rename.story`), 'click', () => {
            qee(renameStoryDialog, '.entity-input').value = queryEl(`${root}#storySelector`).value.trim();
            renameStoryDialog.showDlg();
        });

        listen(qe(`${root}.create.event`), 'click', () => StoryEvents.createEventDialog.showDlg());
        listen(qe(`${root}.add.character`), 'click', () => StoryCharacters.addCharacterDialog.showDlg());

        $('#storySelector').select2().on('change', onStorySelectorChangeDelegate);

        exports.content = queryEl(root);
    };

    exports.chainRefresh = () => {
        if ((state.left.currentView && state.left.currentView.name === 'EventPresence') ||
            (state.right.currentView && state.right.currentView.name === 'EventPresence')) {
            EventPresence.refresh();
        }
    };

    exports.refresh = () => {
        const storySelector = clearEl(getEl('storySelector'));

        PermissionInformer.getEntityNamesArray('story', false, (err, allStoryNames) => {
            if (err) { Utils.handleError(err); return; }
            const data = getSelect2Data(allStoryNames);
            
            Utils.enableEl(qe(`${root}.rename.story`), allStoryNames.length > 0);
            Utils.enableEl(qe(`${root}.remove.story`), allStoryNames.length > 0);
            Utils.enableEl(qe(`${root}.create.event`), allStoryNames.length > 0);
            Utils.enableEl(qe(`${root}.add.character`), allStoryNames.length > 0);
            Utils.enableEl(qe(`${root}#storySelector`), allStoryNames.length > 0);
            
            showEl(qe(`${root}.alert`), allStoryNames.length === 0);
            showEl(qe(`${root}.stories-main-container`), allStoryNames.length !== 0);
            
            if (allStoryNames.length > 0) {
                const storyName = getSelectedStoryName(allStoryNames);
                $('#storySelector').select2(data).val(storyName).trigger('change');
                onStorySelectorChange(storyName);
            } else {
                $('#storySelector').select2(data);
                onStorySelectorChange();
            }

            R.values(state.left.views).forEach(view => view.refresh());
            if (state.left.currentView)state.left.currentView.refresh();
            if (state.right.currentView)state.right.currentView.refresh();
        });
    };

    function getSelectedStoryName(storyNames) {
        const settings = DBMS.getSettings();
        if (!settings.Stories) {
            settings.Stories = {
                storyName: storyNames[0].value
            };
        }
        let { storyName } = settings.Stories;
        if (storyNames.map(nameInfo => nameInfo.value).indexOf(storyName) === -1) {
            settings.Stories.storyName = storyNames[0].value;
            storyName = storyNames[0].value;
        }
        return storyName;
    }

    function createStory(dialog) {
        return () => {
            const input = qee(dialog, '.entity-input');
            const storyName = input.value.trim();

            DBMS.createStory(storyName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    updateSettings(storyName);
                    PermissionInformer.refresh((err2) => {
                        if (err2) { Utils.handleError(err2); return; }
                        input.value = '';
                        dialog.hideDlg();
                        exports.refresh();
                    });
                }
            });
        };
    }

    function renameStory(dialog) {
        return () => {
            const toInput = qee(dialog, '.entity-input');
            const fromName = queryEl(`${root}#storySelector`).value.trim();
            const toName = toInput.value.trim();

            DBMS.renameStory(fromName, toName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    updateSettings(toName);
                    PermissionInformer.refresh((err2) => {
                        if (err2) { Utils.handleError(err2); return; }
                        toInput.value = '';
                        dialog.hideDlg();
                        exports.refresh();
                    });
                }
            });
        };
    }

    function removeStory() {
        const name = queryEl(`${root}#storySelector`).value.trim();

        Utils.confirm(strFormat(getL10n('stories-are-you-sure-about-story-removing'), [name]), () => {
            DBMS.removeStory(name, (err) => {
                if (err) { Utils.handleError(err); return; }
                PermissionInformer.refresh((err2) => {
                    if (err2) { Utils.handleError(err2); return; }
                    exports.refresh();
                });
            });
        });
    }

    function onStorySelectorChangeDelegate(event) {
        const storyName = event.target.value;
        onStorySelectorChange(storyName);
    }

    function onStorySelectorChange(storyName) {
        state.CurrentStoryName = storyName;

        if (storyName) {
            updateSettings(storyName);
            PermissionInformer.isEntityEditable('story', storyName, (err, isStoryEditable) => {
                if (err) { Utils.handleError(err); return; }
                if (state.left.currentView)state.left.currentView.refresh();
                if (state.right.currentView)state.right.currentView.refresh();
                Utils.enable(exports.content, 'isStoryEditable', isStoryEditable);
            });
        } else { // when there are no stories at all
            updateSettings(null);
            if (state.left.currentView)state.left.currentView.refresh();
            if (state.right.currentView)state.right.currentView.refresh();
        }
    }

    exports.getCurrentStoryName = () => state.CurrentStoryName;

    function updateSettings(storyName) {
        const settings = DBMS.getSettings();
        settings.Stories.storyName = storyName;
    }
})(this.Stories = {});

/*Copyright 2015-2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const root = '.story-characters-tab ';
    const superRoot = '.stories-tab ';
    let initialized = false;

    exports.init = () => {
        if (initialized) return;
        exports.addCharacterDialog = UI.createModalDialog(superRoot, addCharacter, {
            bodySelector: 'modal-add-character-body',
            dialogTitle: 'stories-add-character-title',
            actionButtonTitle: 'common-add',
        });

        state.switchCharacterDialog = UI.createModalDialog(root, switchCharacters, {
            bodySelector: 'modal-switch-event-body',
            dialogTitle: 'stories-switch-character-title',
            actionButtonTitle: 'common-replace',
        });

        exports.content = queryEl(root);
        initialized = true;
    };

    exports.refresh = () => {
        clearEl(queryEl(`${superRoot}.storyCharactersAddSelector`));
        clearEl(queryEl(`${root}.storyCharactersToSelector`));

        clearEl(queryEl(`${root}.storyCharactersTable`));

        if (!Stories.getCurrentStoryName()) { return; }

        PermissionInformer.isEntityEditable('story', Stories.getCurrentStoryName(), (err, isStoryEditable) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.getEntityNamesArray('character', false, (err2, allCharacters) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getStoryCharacters(Stories.getCurrentStoryName(), (err3, localCharacters) => {
                    if (err3) { Utils.handleError(err3); return; }
                    rebuildInterface(allCharacters, localCharacters);
                    Utils.enable(exports.content, 'isStoryEditable', isStoryEditable);
                    Stories.chainRefresh();
                });
            });
        });
    };

    function rebuildInterface(allCharacters, localCharacters) {
        const addArray = [];
        const removeArray = [];

        allCharacters.filter(nameInfo => !localCharacters[nameInfo.value]).forEach((nameInfo) => {
            addArray.push(nameInfo);
        });

        allCharacters.filter(nameInfo => localCharacters[nameInfo.value]).forEach((nameInfo) => {
            removeArray.push(nameInfo);
        });

        addArray.sort(Utils.charOrdAObject);
        removeArray.sort(Utils.charOrdAObject);

        const addData = getSelect2Data(addArray);
        const removeData = getSelect2Data(removeArray);

        $(queryEl(`${superRoot}.storyCharactersAddSelector`)).select2({
            data: addData.data,
            dropdownParent: $(exports.addCharacterDialog)
        });
        $(queryEl(`${root}.storyCharactersToSelector`)).select2({
            data: addData.data,
            dropdownParent: $(state.switchCharacterDialog)
        });

        const table = clearEl(queryEl(`${root}.storyCharactersTable`));
        
        showEl(qe(`${root} table`), R.keys(localCharacters).length !== 0 );
        showEl(qe(`${root} .alert`), R.keys(localCharacters).length === 0 );
        
        removeArray.forEach((removeValue) => {
            addEl(table, getCharacterInput(removeValue, localCharacters[removeValue.value]));
        });
    }

    function addCharacter(dialog) {
        return () => {
            const characterName = queryEl(`${superRoot}.storyCharactersAddSelector`).value.trim();
            DBMS.addStoryCharacter(Stories.getCurrentStoryName(), characterName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function switchCharacters(dialog) {
        return () => {
            const toName = queryEl(`${root}.storyCharactersToSelector`).value.trim();
            DBMS.switchStoryCharacters(Stories.getCurrentStoryName(), dialog.characterName, toName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function removeCharacter(characterName) {
        return () => {
            Utils.confirm(strFormat(getL10n('stories-remove-character-from-story-warning'), [characterName]), () => {
                DBMS.removeStoryCharacter(
                    Stories.getCurrentStoryName(),
                    characterName, Utils.processError(exports.refresh)
                );
            });
        };
    }

    function getCharacterInput(characterMeta, character) {
        const el = wrapEl('tr', qte(`${root} .story-character-row-tmpl`));
        L10n.localizeStatic(el);
        const qe = qee(el);

        addEl(qe('.character-name'), makeText(characterMeta.displayName));

        let input = qe('.inventoryInput');
        input.value = character.inventory;
        input.characterName = character.name;
        listen(input, 'change', updateCharacterInventory);

        Constants.characterActivityTypes.forEach((activityType) => {
            input = qe(`.${activityType} input`);
            if (character.activity[activityType]) {
                input.checked = true;
            }
            input.characterName = character.name;
            input.activityType = activityType;
            listen(input, 'change', onChangeCharacterActivity);
            setAttr(input, 'id', character.name + activityType);
            setAttr(qe(`.${activityType} label`), 'for', character.name + activityType);
        });

        listen(qe('.replace.character'), 'click', () => {
            state.switchCharacterDialog.characterName = character.name;
            state.switchCharacterDialog.showDlg();
        });
        listen(qe('.remove.character'), 'click', removeCharacter(character.name));
        return el;
    }

    function updateCharacterInventory(event) {
        DBMS.updateCharacterInventory(
            Stories.getCurrentStoryName(),
            event.target.characterName, event.target.value, Utils.processError()
        );
    }

    function onChangeCharacterActivity(event) {
        DBMS.onChangeCharacterActivity(
            Stories.getCurrentStoryName(), event.target.characterName,
            event.target.activityType, event.target.checked, Utils.processError()
        );
    }
})(this.StoryCharacters = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const root = '.story-events-tab ';
    let initialized = false;

    exports.init = () => {
        if (initialized) return;
        exports.createEventDialog = UI.createModalDialog('.stories-tab ', createEvent, {
            bodySelector: 'create-event-body',
            dialogTitle: 'stories-event-creation',
            actionButtonTitle: 'common-create',
        });

        //        listen(qe(`${root}.create.event`), 'click', () => createEventDialog.showDlg());

        state.moveEventDialog = UI.createModalDialog(root, moveEvent, {
            bodySelector: 'move-event-body',
            dialogTitle: 'stories-move-event',
            actionButtonTitle: 'common-move',
        });
        exports.content = qe(root);
        initialized = true;
    };

    exports.refresh = () => {
        clearInterface();
        if (Stories.getCurrentStoryName() === undefined) {
            return;
        }

        PermissionInformer.isEntityEditable('story', Stories.getCurrentStoryName(), (err, isStoryEditable) => {
            if (err) { Utils.handleError(err); return; }
            DBMS.getMetaInfo((err2, metaInfo) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getStoryEvents(Stories.getCurrentStoryName(), (err3, events) => {
                    if (err3) { Utils.handleError(err3); return; }
                    rebuildInterface(events, metaInfo);
                    Utils.enable(exports.content, 'isStoryEditable', isStoryEditable);
                    Stories.chainRefresh();
                });
            });
        });
    };

    function clearInterface() {
        clearEl(getEl('eventBlock'));
        const positionSelectors = nl2array(document.querySelectorAll('.eventPositionSelector'));
        R.ap([clearEl], positionSelectors);
        const selectorArr = nl2array(document.querySelectorAll('.eventEditSelector'));
        R.ap([clearEl], selectorArr);
    }

    function rebuildInterface(events, metaInfo) {
        // event part
        const table = clearEl(getEl('eventBlock'));
        
        showEl(table, events.length !== 0 );
        showEl(qe(`${root} .alert`), events.length === 0 );

        // refresh position selector
        const addOpt = R.curry((sel, text) => {
            addEl(sel, addEl(makeEl('option'), makeText(text)));
        });

        let option, addOptLoc;
        const positionSelectors = nl2array(document.querySelectorAll('.eventPositionSelector'));
        R.ap([clearEl], positionSelectors);
        positionSelectors.forEach((positionSelector) => {
            addOptLoc = addOpt(positionSelector);

            events.forEach((event) => {
                addOptLoc(strFormat(getL10n('common-set-item-before'), [event.name]));
            });

            addOptLoc(getL10n('common-set-item-as-last'));

            positionSelector.selectedIndex = events.length;
        });

        state.eventsLength = events.length;

        R.ap([addEl(table)], events.map((event, i, events2) =>
            appendEventInput(event, i, events2, metaInfo.date, metaInfo.preGameDate)));

        // refresh swap selector
        const selectorArr = nl2array(document.querySelectorAll('.eventEditSelector'));
        R.ap([clearEl], selectorArr);

        events.forEach((event, i) => {
            selectorArr.forEach((selector) => {
                option = makeEl('option');
                option.appendChild(makeText(event.name));
                option.eventIndex = i;
                selector.appendChild(option);
            });
        });
    }

    function createEvent(dialog) {
        return () => {
            const eventNameInput = qee(dialog, '.eventNameInput');
            const eventName = eventNameInput.value.trim();
            const positionSelector = qee(dialog, '.positionSelector');

            DBMS.createEvent(
                Stories.getCurrentStoryName(), eventName, positionSelector.selectedIndex,
                (err) => {
                    if (err) {
                        setError(dialog, err);
                    } else {
                        eventNameInput.value = '';
                        dialog.hideDlg();
                        exports.refresh();
                    }
                }
            );
        };
    }

    function appendEventInput(event, index, events, date, preGameDate) {
        const el = wrapEl('tr', qte(`${root} .event-tmpl`));
        L10n.localizeStatic(el);
        const qe = qee(el);
        addEl(qe('.event-number'), makeText(index + 1));
        const nameInput = qe('.event-name-input');
        nameInput.value = event.name;
        nameInput.eventIndex = index;
        listen(nameInput, 'change', updateEventName);

        const textInput = qe('.event-text');
        textInput.value = event.text;
        textInput.eventIndex = index;
        listen(textInput, 'change', updateEventText);

        UI.makeEventTimePicker2(qe('.event-time'), {
            eventTime: event.time,
            index,
            preGameDate,
            date,
            onChangeDateTimeCreator
        });

        listen(qee(el, '.move'), 'click', () => {
            state.moveEventDialog.index = index;
            state.moveEventDialog.showDlg();
        });

        listen(qee(el, '.clone'), 'click', cloneEvent(index));
        if (state.eventsLength === index + 1) {
            setAttr(qee(el, '.merge'), 'disabled', 'disabled');
        } else {
            listen(qee(el, '.merge'), 'click', mergeEvents(index, event.name, events[index + 1].name));
        }
        listen(qee(el, '.remove'), 'click', removeEvent(event.name, index));

        return el;
    }

    function moveEvent(dialog) {
        return () => {
            const newIndex = queryEl('.movePositionSelector').selectedIndex;

            Utils.processError(exports.refresh);
            DBMS.moveEvent(Stories.getCurrentStoryName(), dialog.index, newIndex, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function cloneEvent(index) {
        return () => {
            DBMS.cloneEvent(Stories.getCurrentStoryName(), index, Utils.processError(exports.refresh));
        };
    }

    function mergeEvents(index, firstName, secondName) {
        return () => {
            if (state.eventsLength === index + 1) {
                Utils.alert(getL10n('stories-cant-merge-last-event'));
                return;
            }

            Utils.confirm(L10n.format('stories', 'confirm-event-merge', [firstName, secondName]), () => {
                DBMS.mergeEvents(Stories.getCurrentStoryName(), index, Utils.processError(exports.refresh));
            });
        };
    }

    function removeEvent(name, index) {
        return () => {
            Utils.confirm(strFormat(getL10n('stories-remove-event-warning'), [name]), () => {
                DBMS.removeEvent(Stories.getCurrentStoryName(), index, Utils.processError(exports.refresh));
            });
        };
    }

    function getEventHeader() {
        const tr = makeEl('tr');
        addEl(tr, addEl(makeEl('th'), makeText('№')));
        addEl(tr, addEl(makeEl('th'), makeText(getL10n('stories-event'))));
        return tr;
    }

    function onChangeDateTimeCreator(myInput) {
        return (dp, input) => {
            DBMS.setEventOriginProperty(Stories.getCurrentStoryName(), myInput.eventIndex, 'time', input.val(), Utils.processError());
            //            StoryEvents.lastDate = input.val();
            removeClass(myInput, 'defaultDate');
        };
    }

    function updateEventName(event) {
        const input = event.target;
        DBMS.setEventOriginProperty(Stories.getCurrentStoryName(), input.eventIndex, 'name', input.value, Utils.processError(exports.refresh));
    }

    function updateEventText(event) {
        const input = event.target;
        DBMS.setEventOriginProperty(Stories.getCurrentStoryName(), input.eventIndex, 'text', input.value, Utils.processError());
    }
})(this.StoryEvents = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};

    exports.init = () => {
        listen(getEl('writerStoryArea'), 'change', updateWriterStory);
        exports.content = getEl('writerStoryDiv2');
    };

    exports.refresh = () => {
        const storyArea = getEl('writerStoryArea');
        const storyName = Stories.getCurrentStoryName();

        if (storyName) {
            DBMS.getWriterStory(storyName, (err, story) => {
                if (err) { Utils.handleError(err); return; }
                storyArea.value = story;
            });
        } else {
            storyArea.value = '';
        }
    };

    function updateWriterStory() {
        const storyArea = getEl('writerStoryArea');
        DBMS.setWriterStory(Stories.getCurrentStoryName(), storyArea.value, Utils.processError());
    }
})(this.WriterStory = {});

/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, BriefingPreview, BriefingExport
 */

'use strict';

function RoutingTabTmpl(exports, opts) {
    const state = {};
    const tmplRoot = '.tab-routing-tmpl';

    exports.init = () => {
        const el = queryEl(tmplRoot).cloneNode(true);
        removeClass(el, 'tab-routing-tmpl');
        addEl(queryEl('.tab-container'), el);
        state.views = {};
        const containers = {
            root: state,
            navigation: qee(el, '.sub-tab-navigation'),
            content: qee(el, '.sub-tab-content')
        };
        const tabs = R.indexBy(R.prop('viewName'), opts.tabs.map(tab => ({
            viewName: tab.viewName,
            viewRes: Utils.addView(containers, tab.btnName, window[tab.viewName])
        })));

        Utils.setFirstTab(containers, tabs[opts.firstTab].viewRes);
        exports.content = el;
    };

    exports.refresh = () => {
        state.currentView.refresh();
    };
}

RoutingTabTmpl(this.Briefings = {}, {
    firstTab: 'BriefingPreview',
    tabs: [{
        btnName: 'briefing-preview',
        viewName: 'BriefingPreview'
    }, {
        btnName: 'briefing-export',
        viewName: 'BriefingExport'
    }]
});

RoutingTabTmpl(this.Characters = {}, {
    firstTab: 'CharacterEditor',
    tabs: [{
        btnName: 'filling-profile',
        viewName: 'CharacterEditor'
    }, {
        btnName: 'changing-profile-structure',
        viewName: 'CharacterConfigurer'
    }, {
        btnName: 'binding-characters-and-players',
        viewName: 'ProfileBinding2'
    }]
});

RoutingTabTmpl(this.Players = {}, {
    firstTab: 'PlayerEditor',
    tabs: [{
        btnName: 'filling-profile',
        viewName: 'PlayerEditor'
    }, {
        btnName: 'changing-profile-structure',
        viewName: 'PlayerConfigurer'
    }, {
        btnName: 'binding-characters-and-players',
        viewName: 'ProfileBinding2'
    }]
});

RoutingTabTmpl(this.LogViewer2 = {}, {
    firstTab: 'LogViewer',
    tabs: [{
        btnName: 'logViewer',
        viewName: 'LogViewer'
    }, {
        btnName: 'group-schema',
        viewName: 'GroupSchema'
    }, {
        btnName: 'about',
        viewName: 'About'
    }]
});

RoutingTabTmpl(this.AccessManager = {}, {
    firstTab: 'OrganizerManagement',
    tabs: [{
        btnName: 'organizerManagement',
        viewName: 'OrganizerManagement'
    }, {
        btnName: 'playerManagement',
        viewName: 'PlayerManagement'
    }]
});

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.text-search-tab ';

    exports.init = () => {
        listen(queryEl(`${root}.text-search-button`), 'click', findTexts);
        listenOnEnter(queryEl(`${root}.text-search-input`), findTexts);
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
    };

    function findTexts() {
        const selectedTextTypes = queryElEls(queryEl(root), `${root}.textSearchTypeRadio`)
            .filter(el => el.checked).map(el => el.value);
        const searchStr = queryEl(`${root}.text-search-input`).value;
        const caseSensitive = getEl('caseSensitiveTextSearch').checked;
        DBMS.getTexts(searchStr, selectedTextTypes, caseSensitive, (err, texts) => {
            if (err) { Utils.handleError(err); return; }
            const text2panel = text =>
                makePanel(
                    makeText(`${getL10n(`text-search-${text.textType}`)} (${text.result.length})`),
                    makePanelContent(text, searchStr, caseSensitive)
                );
            addEls(clearEl(queryEl(`${root}.result-panel`)), texts.map(text2panel));
        });
    }

    function makePanelContent(textsInfo, searchStr, caseSensitive) {
        textsInfo.result.sort(CommonUtils.charOrdAFactory(R.prop('name')));
        return addEls(makeEl('div'), textsInfo.result.map((textInfo) => {
            const head = addEl(makeEl('div'), makeText(textInfo.name));
            const body = addClass(makeEl('div'), textInfo.type === 'text' ? 'text-body' : 'string-body');
            const regex = new RegExp(CommonUtils.escapeRegExp(searchStr), caseSensitive ? 'g' : 'gi');
            body.innerHTML = textInfo.text.replace(regex, '<span>$&</span>');
            return addEls(addClass(makeEl('div'), 'text-card'), [head, body]);
        }));
    }

    function makePanel(title, content) {
        const panelInfo = UI.makePanelCore(title, content);
        UI.attachPanelToggler(panelInfo.a, panelInfo.contentDiv);
        panelInfo.a.click();
        return panelInfo.panel;
    }
})(this.TextSearch = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const root = '.timeline-tab';

    exports.init = () => {
        listen(getEl('timelineStorySelector'), 'change', onStorySelectorChangeDelegate);

        state.TimelineDataset = new vis.DataSet();
        state.TagDataset = new vis.DataSet();

        queryEls(`${root} input[name=timelineFilter]`).map(listen(R.__, 'change', refreshTimeline));
        getEl('timelineFilterByStory').checked = true;

        // specify options
        const options = {
            orientation: 'top',
            showCurrentTime: false,
            //        editable : {
            //            updateTime : true
            //        },
            //        onMove : function (item, callback) {
            //            if (item.storyName) {
            //                DBMS.setEventTime(item.storyName, item.eventIndex, item.start, function(err){
            //                    if(err) {Utils.handleError(err); return;}
            //                    callback(item);
            //                });
            //            }
            //        },
            //        multiselect : true
        };

        const timeline = new vis.Timeline(getEl('timelineContainer'), null, options);
        timeline.setGroups(state.TagDataset);
        timeline.setItems(state.TimelineDataset);
        state.timelineComponent = timeline;

        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        DBMS.getMetaInfo((err, metaInfo) => {
            if (err) { Utils.handleError(err); return; }

            state.postDate = metaInfo.date;
            state.preDate = metaInfo.preGameDate;

            const endDate = new Date(state.postDate);
            const startDate = new Date(state.preDate);
            endDate.setFullYear(endDate.getFullYear() + 1);
            startDate.setFullYear(startDate.getFullYear() - 1);

            state.timelineComponent.setOptions({
                end: endDate,
                start: startDate,
            });

            DBMS.getEventsTimeInfo((err1, eventsTimeInfo) => {
                if (err1) { Utils.handleError(err1); return; }
                state.eventsTimeInfo = eventsTimeInfo;
                state.eventsByStories = R.groupBy(R.prop('storyName'), eventsTimeInfo);
                state.eventsByCharacters = R.uniq(R.flatten(eventsTimeInfo.map(event => event.characters)));
                state.eventsByCharacters = R.zipObj(
                    state.eventsByCharacters,
                    R.ap([R.clone], R.repeat([], state.eventsByCharacters.length))
                );
                eventsTimeInfo.forEach(event => event.characters.forEach(character =>
                    state.eventsByCharacters[character].push(event)));

                PermissionInformer.getEntityNamesArray('story', false, (err2, allStoryNames) => {
                    if (err2) { Utils.handleError(err2); return; }
                    PermissionInformer.getEntityNamesArray('character', false, (err3, allCharacterNames) => {
                        if (err3) { Utils.handleError(err3); return; }
                        suffixy(allStoryNames, state.eventsByStories);
                        state.allStoryNames = allStoryNames;
                        suffixy(allCharacterNames, state.eventsByCharacters);
                        state.allCharacterNames = allCharacterNames;
                        refreshTimeline();
                    });
                });
            });
        });
    };

    function suffixy(entityNames, data) {
        entityNames.forEach((nameInfo) => {
            nameInfo.hasEvents = data[nameInfo.value] !== undefined;
        });
    }

    function refreshTimeline() {
        const selectorValues = getEl('timelineFilterByStory').checked ? state.allStoryNames : state.allCharacterNames;

        const selector = clearEl(getEl('timelineStorySelector'));
        fillSelector(selector, selectorValues.map(obj => ({
            name: obj.displayName,
            value: obj.value,
            className: obj.hasEvents ?
                'fa-icon finished transparent-icon select-icon-padding' :
                'fa-icon empty icon-padding select-icon-padding'
        })));
        setAttr(selector, 'size', selectorValues.length > 15 ? 15 : selectorValues.length);

        if (selectorValues.length !== 0) {
            selector.options[0].selected = true;
            onStorySelectorChange([selectorValues[0].value]);
        }
    }

    function onStorySelectorChangeDelegate(event) {
        onStorySelectorChange(nl2array(event.target.selectedOptions).map(opt => opt.value));
    }

    const prepareLabel = label => `<span class="timeline-label">${label}</span>`;

    function onStorySelectorChange(entityNames) {
        state.TagDataset.clear();
        state.TimelineDataset.clear();

        state.TagDataset.add(entityNames.map(entityName => R.always({ id: entityName, content: entityName })()));

        const byStory = getEl('timelineFilterByStory').checked;
        const data = byStory ? state.eventsByStories : state.eventsByCharacters;
        entityNames = R.intersection(entityNames, R.keys(data));
        const usedData = R.pick(entityNames, data);
        fillTimelines(usedData);
        const events = R.uniq(R.flatten(R.values(usedData))
                .map(event => {
                    event.time = new Date(event.time !== '' ? event.time : state.postDate);
                    event.characters.sort(CommonUtils.charOrdA);
                    return event;
                }));
        
        events.sort(CommonUtils.charOrdAFactory(R.prop('time')));
        
        addEls(clearEl(queryEl(`${root} .timeline-list`)), events.map(event => {
            const row = qmte(`${root} .timeline-event-tmpl`);
            addEl(qee(row, '.time'), makeText(event.time.format('yyyy/mm/dd h:MM')));
            addEl(qee(row, '.story-name'), makeText(event.storyName));
            addEl(qee(row, '.event-name'), makeText(event.name));
            addEl(qee(row, '.characters'), makeText(event.characters.join(', ')));
            return row;
        }));

        if (entityNames[0]) {
            state.TimelineDataset.add({
                content: prepareLabel(L10n.getValue('overview-pre-game-end-date')),
                start: new Date(state.postDate),
                group: entityNames[0],
                className: 'importantItem',
                editable: false
            });
            state.TimelineDataset.add({
                content: prepareLabel(L10n.getValue('overview-pre-game-start-date')),
                start: new Date(state.preDate),
                group: entityNames[0],
                className: 'importantItem',
                editable: false
            });
        }
    }
    
    function fillTimelines(usedData) {
        state.TimelineDataset.add(R.flatten(R.toPairs(usedData).map((pair) => {
            const entityName = pair[0];
            return pair[1].map(event => ({
                content: prepareLabel(event.name),
                start: event.time !== '' ? event.time : state.postDate,
                group: entityName
            }));
        })));
    }
})(this.Timeline = {});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzL3BhZ2VzL3RlbXBsYXRlLmpzIiwianMvcGFnZXMvYWNjZXNzTWFuYWdlci9vcmdhbml6ZXJNYW5hZ2VtZW50LmpzIiwianMvcGFnZXMvYWNjZXNzTWFuYWdlci9wbGF5ZXJNYW5hZ2VtZW50LmpzIiwianMvcGFnZXMvYWRhcHRhdGlvbnMvYWRhcHRhdGlvbnMuanMiLCJqcy9wYWdlcy9icmllZmluZ3MvYnJpZWZpbmdFeHBvcnQuanMiLCJqcy9wYWdlcy9icmllZmluZ3MvYnJpZWZpbmdQcmV2aWV3LmpzIiwianMvcGFnZXMvYnJpZWZpbmdzL3JlbGF0aW9ucy5qcyIsImpzL3BhZ2VzL2JyaWVmaW5ncy9yZWxhdGlvbnNQcmV2aWV3LmpzIiwianMvcGFnZXMvZ2VhcnMvZ2VhcnMuanMiLCJqcy9wYWdlcy9ncm91cHMvQWRkRmlsdGVyQ29uZGl0aW9uRGlhbG9nLmpzIiwianMvcGFnZXMvZ3JvdXBzL0ZpbHRlckNvbmZpZ3VyYXRpb24uanMiLCJqcy9wYWdlcy9ncm91cHMvZ3JvdXBQcm9maWxlLmpzIiwianMvcGFnZXMvZ3JvdXBzL2dyb3VwU2NoZW1hLmpzIiwianMvcGFnZXMvZ3JvdXBzL3Byb2ZpbGVGaWx0ZXIuanMiLCJqcy9wYWdlcy9sb2dzL2Fib3V0LmpzIiwianMvcGFnZXMvbG9ncy9sb2dWaWV3ZXIuanMiLCJqcy9wYWdlcy9uZXR3b3JrL25ldHdvcmtTdWJzZXRzU2VsZWN0b3IuanMiLCJqcy9wYWdlcy9uZXR3b3JrL3NvY2lhbE5ldHdvcmsuanMiLCJqcy9wYWdlcy9uZXR3b3JrL3RpbWVsaW5lZE5ldHdvcmsuanMiLCJqcy9wYWdlcy9vdmVydmlldy9vdmVydmlldy5qcyIsImpzL3BhZ2VzL3Byb2ZpbGVzL3Byb2ZpbGVCaW5kaW5nLmpzIiwianMvcGFnZXMvcHJvZmlsZXMvcHJvZmlsZUNvbmZpZ3VyZXIuanMiLCJqcy9wYWdlcy9wcm9maWxlcy9wcm9maWxlRWRpdG9yLmpzIiwianMvcGFnZXMvcHJvZmlsZXMvcHJvZmlsZUVkaXRvckNvcmUuanMiLCJqcy9wYWdlcy9wcm9maWxlcy9wcm9maWxlcy5qcyIsImpzL3BhZ2VzL3Byb2ZpbGVzMi9jaGFyYWN0ZXJSZXBvcnRzLmpzIiwianMvcGFnZXMvcHJvZmlsZXMyL3Byb2ZpbGVCaW5kaW5nMi5qcyIsImpzL3BhZ2VzL3Byb2ZpbGVzMi9wcm9maWxlQ29uZmlndXJlcjIuanMiLCJqcy9wYWdlcy9wcm9maWxlczIvcHJvZmlsZUVkaXRvcjIuanMiLCJqcy9wYWdlcy9wcm9maWxlczIvcm9sZUdyaWQuanMiLCJqcy9wYWdlcy9zZXJ2ZXJTcGVjaWZpYy9lbnRlci5qcyIsImpzL3BhZ2VzL3NlcnZlclNwZWNpZmljL3BsYXllci5qcyIsImpzL3BhZ2VzL3NlcnZlclNwZWNpZmljL3NpZ24tdXAuanMiLCJqcy9wYWdlcy9zbGlkZXJzL3NsaWRlcnMuanMiLCJqcy9wYWdlcy9zdG9yaWVzL2V2ZW50UHJlc2VuY2UuanMiLCJqcy9wYWdlcy9zdG9yaWVzL3N0b3JpZXMuanMiLCJqcy9wYWdlcy9zdG9yaWVzL3N0b3J5Q2hhcmFjdGVycy5qcyIsImpzL3BhZ2VzL3N0b3JpZXMvc3RvcnlFdmVudHMuanMiLCJqcy9wYWdlcy9zdG9yaWVzL3dyaXRlclN0b3J5LmpzIiwianMvcGFnZXMvdGFiUm91dGluZy90YWJSb3V0aW5nLmpzIiwianMvcGFnZXMvdGV4dFNlYXJjaC90ZXh0U2VhcmNoLmpzIiwianMvcGFnZXMvdGltZWxpbmUvdGltZWxpbmUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDaENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNsYUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzFNQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNqY0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbFlBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcmNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzVGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbE9BO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM3YkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMzS0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDOUdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNwVkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbE1BO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDampCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDNUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN4RkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDekZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdGhCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM5U0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcFpBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcEZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ25VQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDM0lBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdkxBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMvSEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzdHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN2S0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3JqQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcFRBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ25VQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM3RUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2xGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQy9EQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbktBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNuS0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3ROQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM1TEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN0UEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDL0NBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDL0dBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbEVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6InBhZ2VzLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHJvb3QgPSAnLi10YWIgJztcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIC8vZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG5cclxuICAgIH07XHJcbn0pKHRoaXMuVGVtcGxhdGUgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUtMjAxOCBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuXHJcbiAgICBzdGF0ZS5lbnRpdGllcyA9IFsnY2hhcmFjdGVycycsICdzdG9yaWVzJywgJ2dyb3VwcycsICdwbGF5ZXJzJ107XHJcblxyXG4gICAgY29uc3Qgcm9vdCA9ICcub3JnYW5pemVyLW1hbmFnZW1lbnQtdGFiICc7XHJcblxyXG4gICAgbGV0IHJlbW92ZVBlcm1pc3Npb24sIGFzc2lnblBlcm1pc3Npb247XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNyZWF0ZVVzZXJEaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhyb290LCBjcmVhdGVVc2VyLCB7XHJcbiAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ2NyZWF0ZS1vcmdhbml6ZXItYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnYWRtaW5zLWNyZWF0aW5nLXVzZXInLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1jcmVhdGUnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxpc3RlbihxZShgJHtyb290fS5jcmVhdGUudXNlcmApLCAnY2xpY2snLCAoKSA9PiBjcmVhdGVVc2VyRGlhbG9nLnNob3dEbGcoKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgY2hhbmdlUGFzc3dvcmREaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhyb290LCBjaGFuZ2VQYXNzd29yZCwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdtb2RhbC1wcm9tcHQtYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnYWRtaW5zLWVudGVyLW5ldy1wYXNzd29yZCcsXHJcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLXJlcGxhY2UnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxpc3RlbihxZShgJHtyb290fS51c2VyLmNoYW5nZS1wYXNzd29yZGApLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHFlZShjaGFuZ2VQYXNzd29yZERpYWxvZywgJy5lbnRpdHktaW5wdXQnKS52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICBjaGFuZ2VQYXNzd29yZERpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0ucmVtb3ZlLXVzZXItYnV0dG9uYCksICdjbGljaycsIHJlbW92ZU9yZ2FuaXplcik7XHJcblxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LmFzc2lnbi1wZXJtaXNzaW9uLWJ1dHRvbmApLCAnY2xpY2snLCBhc3NpZ25QZXJtaXNzaW9uKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5yZW1vdmUtcGVybWlzc2lvbi1idXR0b25gKSwgJ2NsaWNrJywgcmVtb3ZlUGVybWlzc2lvbik7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0uYXNzaWduLWFkbWluLWJ1dHRvbmApLCAnY2xpY2snLCBhc3NpZ25OZXdBZG1pbik7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0ucmVtb3ZlLWVkaXRvci1idXR0b25gKSwgJ2NsaWNrJywgcmVtb3ZlRWRpdG9yKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5hc3NpZ24tZWRpdG9yLWJ1dHRvbmApLCAnY2xpY2snLCBhc3NpZ25FZGl0b3IpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHN0YXRlLmVudGl0aWVzLmZvckVhY2godHlwZSA9PiB7XHJcbiAgICAgICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9IC5lbnRpdHktZmlsdGVyLiR7dHlwZX1gKSwgJ2lucHV0JywgZmlsdGVyTGlzdChgLmVudGl0eS1saXN0LiR7dHlwZX1gKSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHF1ZXJ5RWxFbHMocXVlcnlFbChyb290KSwgJy5hZGFwdGF0aW9uUmlnaHRzJykubWFwKGxpc3RlbihSLl9fLCAnY2xpY2snLCBjaGFuZ2VBZGFwdGF0aW9uUmlnaHRzTW9kZSkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBEQk1TLmdldE1hbmFnZW1lbnRJbmZvKChlcnIsIG1hbmFnZW1lbnRJbmZvKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5pc0FkbWluKChlcnIyLCBpc0FkbWluKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuaXNFZGl0b3IoKGVycjMsIGlzRWRpdG9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycjMpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMyk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdjaGFyYWN0ZXInLCBmYWxzZSwgKGVycjQsIGNoYXJhY3Rlck5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnI0KSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjQpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ3N0b3J5JywgZmFsc2UsIChlcnI1LCBzdG9yeU5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyNSkgeyBVdGlscy5oYW5kbGVFcnJvcihlcnI1KTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheSgnZ3JvdXAnLCBmYWxzZSwgKGVycjYsIGdyb3VwTmFtZXMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyNikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnI2KTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ3BsYXllcicsIGZhbHNlLCAoZXJyNywgcGxheWVyTmFtZXMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjcpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyNyk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lcyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYXJhY3RlcnM6IGNoYXJhY3Rlck5hbWVzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBzOiBncm91cE5hbWVzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Rvcmllczogc3RvcnlOYW1lcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllcnM6IHBsYXllck5hbWVzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzQWRtaW4gJiYgaXNFZGl0b3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFIua2V5cyhuYW1lcykuZm9yRWFjaCgoZW50aXR5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZXNbZW50aXR5XSA9IG5hbWVzW2VudGl0eV0uZmlsdGVyKFIucHJvcCgnaXNPd25lcicpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYnVpbGRJbnRlcmZhY2UobmFtZXMsIG1hbmFnZW1lbnRJbmZvLCBpc0FkbWluKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlKGV4cG9ydHMuY29udGVudCwgJ2FkbWluT25seScsIGlzQWRtaW4pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBVdGlscy5lbmFibGUoZXhwb3J0cy5jb250ZW50LCAnZWRpdG9yT3JBZG1pbicsIGlzQWRtaW4gfHwgaXNFZGl0b3IpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiByZWJ1aWxkSW50ZXJmYWNlKG5hbWVzLCBtYW5hZ2VtZW50SW5mbywgaXNBZG1pbikge1xyXG4gICAgICAgIGNvbnN0IHsgdXNlcnNJbmZvIH0gPSBtYW5hZ2VtZW50SW5mbztcclxuXHJcbiAgICAgICAgY29uc3QgdXNlck5hbWVzID0gT2JqZWN0LmtleXModXNlcnNJbmZvKS5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc2VsZWN0b3JzID0gW107XHJcbiAgICAgICAgc2VsZWN0b3JzLnB1c2gocXVlcnlFbChgJHtyb290fS5jaGFuZ2UtcGFzc3dvcmQtdXNlci1zZWxlY3RgKSk7XHJcbi8vICAgICAgICBzZWxlY3RvcnMucHVzaChxdWVyeUVsKGAke3Jvb3R9LnVzZXItcGVybWlzc2lvbi1zZWxlY3RgKSk7XHJcbi8vICAgICAgICBzZWxlY3RvcnMucHVzaChxdWVyeUVsKGAke3Jvb3R9LmFzc2lnbi1lZGl0b3Itc2VsZWN0YCkpO1xyXG5cclxuICAgICAgICBjb25zdCBkYXRhID0gYXJyMlNlbGVjdDIodXNlck5hbWVzKVxyXG4gICAgICAgIHNlbGVjdG9ycy5mb3JFYWNoKChzZWxlY3RvcikgPT4ge1xyXG4gICAgICAgICAgICBjbGVhckVsKHNlbGVjdG9yKTtcclxuICAgICAgICAgICAgJChzZWxlY3Rvcikuc2VsZWN0MihkYXRhKTtcclxuLy8gICAgICAgICAgICBVdGlscy5yZWJ1aWxkU2VsZWN0b3JBcnIoc2VsZWN0b3IsIHVzZXJOYW1lcyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgVXRpbHMucmVidWlsZFNlbGVjdG9yQXJyKHF1ZXJ5RWwoYCR7cm9vdH0udXNlci1wZXJtaXNzaW9uLXNlbGVjdGApLCB1c2VyTmFtZXMpO1xyXG5cclxuICAgICAgICBjb25zdCBjbG9uZSA9IHVzZXJOYW1lcy5zbGljZSgwKTtcclxuICAgICAgICBjbG9uZS5zcGxpY2UodXNlck5hbWVzLmluZGV4T2YobWFuYWdlbWVudEluZm8uYWRtaW4pLCAxKTtcclxuLy8gICAgICAgIGxldCBzZWxlY3RvciA9IHF1ZXJ5RWwoYCR7cm9vdH0uYXNzaWduLWFkbWluLXNlbGVjdGApO1xyXG4vLyAgICAgICAgVXRpbHMucmVidWlsZFNlbGVjdG9yQXJyKHNlbGVjdG9yLCBjbG9uZSk7XHJcbiAgICAgICAgXHJcbi8vICAgICAgICBjb25zdCBkYXRhID0gZ2V0U2VsZWN0MkRhdGEoYWxsR3JvdXBOYW1lcyk7XHJcbi8vICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uc2F2ZS1lbnRpdHktc2VsZWN0YCkpO1xyXG4vLyAgICAgICAgJChgJHtyb290fS5zYXZlLWVudGl0eS1zZWxlY3RgKS5zZWxlY3QyKGRhdGEpO1xyXG5cclxuLy8gICAgICAgIHNlbGVjdG9yID0gcXVlcnlFbChgJHtyb290fS5yZW1vdmUtdXNlci1zZWxlY3RgKTtcclxuLy8gICAgICAgIFV0aWxzLnJlYnVpbGRTZWxlY3RvckFycihzZWxlY3RvciwgY2xvbmUpO1xyXG5cclxuICAgICAgICBzdGF0ZS5lbnRpdGllcy5mb3JFYWNoKChlbnRpdHkpID0+IHtcclxuICAgICAgICAgICAgVXRpbHMucmVidWlsZFNlbGVjdG9yKHF1ZXJ5RWwoYCR7cm9vdH0ucGVybWlzc2lvbi1zZWxlY3Rvcl9fJHtlbnRpdHl9YCksIG5hbWVzW2VudGl0eV0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBhZGRFbChjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uY3VycmVudC1hZG1pbi1sYWJlbGApKSwgbWFrZVRleHQobWFuYWdlbWVudEluZm8uYWRtaW4pKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc3BhbiA9IGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5jdXJyZW50LWVkaXRvci1sYWJlbGApKTtcclxuICAgICAgICBpZiAobWFuYWdlbWVudEluZm8uZWRpdG9yKSB7XHJcbiAgICAgICAgICAgIGFkZEVsKHNwYW4sIG1ha2VUZXh0KG1hbmFnZW1lbnRJbmZvLmVkaXRvcikpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZ2V0RWwoYGFkYXB0YXRpb25SaWdodHMke21hbmFnZW1lbnRJbmZvLmFkYXB0YXRpb25SaWdodHN9YCkuY2hlY2tlZCA9IHRydWU7XHJcblxyXG4gICAgICAgIHN0YXRlLmVudGl0aWVzLmZvckVhY2goKGVudGl0eSkgPT4ge1xyXG4vLyAgICAgICAgICAgIFV0aWxzLnJlYnVpbGRTZWxlY3RvcihxdWVyeUVsKGAke3Jvb3R9LnBlcm1pc3Npb24tc2VsZWN0b3JfXyR7ZW50aXR5fWApLCBuYW1lc1tlbnRpdHldKTtcclxuICAgICAgICAgICAgYWRkRWxzKFxyXG4gICAgICAgICAgICAgICAgY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9IC5lbnRpdHktbGlzdC4ke2VudGl0eX1gKSksXHJcbiAgICAgICAgICAgICAgICBuYW1lc1tlbnRpdHldLm1hcChlbnRpdHkyZWwoaXNBZG1pbiwgZW50aXR5KSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBhZGRFbHMoXHJcbiAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChgJHtyb290fSAuZW50aXR5LWxpc3QudXNlcnNgKSksXHJcbiAgICAgICAgICAgIHVzZXJOYW1lcy5tYXAodXNlcjJlbClcclxuICAgICAgICApO1xyXG4gICAgICAgIGJ1aWxkUGVybWlzc2lvbkxpc3QobmFtZXMsIHVzZXJzSW5mbyk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGNvbnN0IGVudGl0eTJlbCA9IFIuY3VycnkoKGlzQWRtaW4sIHR5cGUsIG5hbWUpID0+IHtcclxuICAgICAgICBjb25zdCBlbCA9IHFtdGUoYC5wcm9maWxlLWl0ZW0tdG1wbGApO1xyXG4gICAgICAgIGVsLnByb2ZpbGVOYW1lID0gbmFtZS52YWx1ZTtcclxuICAgICAgICBhZGRFbChxZWUoZWwsICcucHJpbWFyeS1uYW1lJyksIG1ha2VUZXh0KG5hbWUuZGlzcGxheU5hbWUpKTtcclxuICAgICAgICBjb25zdCBidG4gPSBxZWUoZWwsICdbcm9sZT1idXR0b25dJyk7XHJcbiAgICAgICAgc2V0QXR0cihidG4sICdwcm9maWxlLW5hbWUnLCBuYW1lLnZhbHVlKTtcclxuICAgICAgICBzZXRBdHRyKGJ0biwgJ3ByaW1hcnktbmFtZScsIG5hbWUuZGlzcGxheU5hbWUpO1xyXG4gICAgICAgIHNldEF0dHIoYnRuLCAnYnV0dG9uLXR5cGUnLCAnZW50aXR5Jyk7XHJcbiAgICAgICAgc2V0QXR0cihidG4sICdwcm9maWxlLXR5cGUnLCB0eXBlKTtcclxuICAgICAgICBpZihuYW1lLmlzT3duZXIgfHwgaXNBZG1pbil7XHJcbiAgICAgICAgICAgIGxpc3RlbihidG4sICdkcmFnc3RhcnQnLCBvbkRyYWdTdGFydCk7XHJcbiAgICAgICAgICAgIGxpc3RlbihidG4sICdkcm9wJywgb25Ecm9wKTtcclxuICAgICAgICAgICAgbGlzdGVuKGJ0biwgJ2RyYWdvdmVyJywgYWxsb3dEcm9wKTtcclxuICAgICAgICAgICAgbGlzdGVuKGJ0biwgJ2RyYWdlbnRlcicsIGhhbmRsZURyYWdFbnRlcik7XHJcbiAgICAgICAgICAgIGxpc3RlbihidG4sICdkcmFnbGVhdmUnLCBoYW5kbGVEcmFnTGVhdmUpO1xyXG4gICAgICAgICAgICBsaXN0ZW4oYnRuLCAnY2xpY2snLCBlID0+IHRvZ2dsZUNsYXNzKGJ0biwgJ2J0bi1wcmltYXJ5JykpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKGJ0biwgZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZWw7XHJcbiAgICB9KTtcclxuICAgIFxyXG4gICAgY29uc3QgdXNlcjJlbCA9IFIuY3VycnkoKG5hbWUpID0+IHtcclxuICAgICAgICBjb25zdCBlbCA9IHdyYXBFbCgnZGl2JywgcXRlKGAucHJvZmlsZS1pdGVtLXRtcGxgKSk7XHJcbi8vICAgICAgICBlbC5wcm9maWxlTmFtZSA9IG5hbWUudmFsdWU7XHJcbiAgICAgICAgYWRkRWwocWVlKGVsLCAnLnByaW1hcnktbmFtZScpLCBtYWtlVGV4dChuYW1lKSk7XHJcbiAgICAgICAgc2V0QXR0cihlbCwgJ3Byb2ZpbGUtbmFtZScsIG5hbWUpO1xyXG4gICAgICAgIHNldEF0dHIoZWwsICdidXR0b24tdHlwZScsICd1c2VyJyk7XHJcbi8vICAgICAgICBzZXRBdHRyKGVsLCAncHJpbWFyeS1uYW1lJywgbmFtZS5kaXNwbGF5TmFtZSk7XHJcbi8vICAgICAgICBzZXRBdHRyKGVsLCAncHJvZmlsZS10eXBlJywgdHlwZSk7XHJcbiAgICAgICAgbGlzdGVuKGVsLCAnZHJhZ3N0YXJ0Jywgb25EcmFnU3RhcnQpO1xyXG4gICAgICAgIGxpc3RlbihlbCwgJ2Ryb3AnLCBvbkRyb3ApO1xyXG4gICAgICAgIGxpc3RlbihlbCwgJ2RyYWdvdmVyJywgYWxsb3dEcm9wKTtcclxuICAgICAgICBsaXN0ZW4oZWwsICdkcmFnZW50ZXInLCBoYW5kbGVEcmFnRW50ZXIpO1xyXG4gICAgICAgIGxpc3RlbihlbCwgJ2RyYWdsZWF2ZScsIGhhbmRsZURyYWdMZWF2ZSk7XHJcbiAgICAgICAgcmV0dXJuIGVsO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIG9uRHJhZ1N0YXJ0ID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgICAgICBpZihnZXRBdHRyKHRoaXMsICdidXR0b24tdHlwZScpID09PSAnZW50aXR5Jyl7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKHRoaXMsICdidG4tcHJpbWFyeScpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zb2xlLmxvZyhgb25EcmFnU3RhcnQgJHt0aGlzLnByb2ZpbGVOYW1lfWApO1xyXG4gICAgICAgIGV2ZW50LmRhdGFUcmFuc2Zlci5zZXREYXRhKCdkYXRhJywgSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICAgICAgICBuYW1lOiBnZXRBdHRyKHRoaXMsICdwcm9maWxlLW5hbWUnKSxcclxuICAgICAgICAgICAgdHlwZTogZ2V0QXR0cih0aGlzLCAncHJvZmlsZS10eXBlJyksXHJcbiAgICAgICAgICAgIGJ1dHRvblR5cGU6IGdldEF0dHIodGhpcywgJ2J1dHRvbi10eXBlJyksXHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIGV2ZW50LmRhdGFUcmFuc2Zlci5lZmZlY3RBbGxvd2VkID0gJ21vdmUnO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgb25Ecm9wID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgICAgICByZW1vdmVDbGFzcyh0aGlzLCAnb3ZlcicpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGBvbkRyb3AgJHt0aGlzLnByb2ZpbGVOYW1lfSR7ZXZlbnQuZGF0YVRyYW5zZmVyLmdldERhdGEoJ2RhdGEnKX1gKTtcclxuICAgICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSB7XHJcbiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOyAvLyBzdG9wcyB0aGUgYnJvd3NlciBmcm9tIHJlZGlyZWN0aW5nLlxyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB0aGF0RGF0YSA9IEpTT04ucGFyc2UoZXZlbnQuZGF0YVRyYW5zZmVyLmdldERhdGEoJ2RhdGEnKSk7XHJcbiAgICAgICAgaWYgKHRoYXREYXRhLnR5cGUgPT09IGdldEF0dHIodGhpcywgJ3Byb2ZpbGUtdHlwZScpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgdHlwZTEgPSBnZXRBdHRyKHRoaXMsICdidXR0b24tdHlwZScpO1xyXG4gICAgICAgIGNvbnN0IHR5cGUyID0gdGhhdERhdGEuYnV0dG9uVHlwZTtcclxuICAgICAgICBcclxuICAgICAgICBpZih0eXBlMSAhPT0gdHlwZTIpe1xyXG4gICAgICAgICAgICBjb25zdCB1c2VyTmFtZSA9IHR5cGUxID09PSAndXNlcicgPyBnZXRBdHRyKHRoaXMsICdwcm9maWxlLW5hbWUnKSA6IHRoYXREYXRhLm5hbWU7XHJcbi8vICAgICAgICAgICAgY29uc3QgZW50aXR5QnRuID0gIHR5cGUxID09PSAndXNlcicgPyBcclxuICAgICAgICAgICAgXHJcbi8vICAgICAgICAgICAgY29uc29sZS5sb2codXNlcik7XHJcbiAgICAgICAgICAgIGNvbnN0IGJ0bnMgPSBxZXMoYCR7cm9vdH0gLnJpZ2h0cy1wYW5lbCAuYnRuLXByaW1hcnlbcm9sZT1idXR0b25dYCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkID0gYnRucy5tYXAoIGJ0biA9PiAoe1xyXG4gICAgICAgICAgICAgICAgdHlwZTogZ2V0QXR0cihidG4sICdwcm9maWxlLXR5cGUnKSxcclxuICAgICAgICAgICAgICAgIG5hbWU6IGdldEF0dHIoYnRuLCAncHJvZmlsZS1uYW1lJyksXHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgY29uc3QgbmFtZXMgPSBSLm1hcE9iakluZGV4ZWQoYXJyID0+IGFyci5tYXAoUi5wcm9wKCduYW1lJykpLCBSLmdyb3VwQnkoUi5wcm9wKCd0eXBlJyksIHNlbGVjdGVkKSk7XHJcbiAgICAgICAgICAgIGJ0bnMuZm9yRWFjaChidG4gPT4gcmVtb3ZlQ2xhc3MoYnRuLCAnYnRuLXByaW1hcnknKSlcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIERCTVNbJ2Fzc2lnblBlcm1pc3Npb24nXSh1c2VyTmFtZSwgbmFtZXMsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuLy8gICAgICAgICAgICBEQk1TW2FjdGlvbl0odXNlck5hbWUsIG5hbWVzLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbi8vICAgICAgICB9O1xyXG4vLyAgICB9XHJcbi8vXHJcbi8vICAgIHJlbW92ZVBlcm1pc3Npb24gPSBwZXJtaXNzaW9uQWN0aW9uKCdyZW1vdmVQZXJtaXNzaW9uJyk7XHJcbi8vICAgIGFzc2lnblBlcm1pc3Npb24gPSBwZXJtaXNzaW9uQWN0aW9uKCdhc3NpZ25QZXJtaXNzaW9uJyk7XHJcbiAgICAgICAgfVxyXG5cclxuLy8gICAgICAgIGNyZWF0ZUJpbmRpbmcoW3RoYXREYXRhLCB7XHJcbi8vICAgICAgICAgICAgbmFtZTogZ2V0QXR0cih0aGlzLCAncHJvZmlsZS1uYW1lJyksXHJcbi8vICAgICAgICAgICAgdHlwZTogZ2V0QXR0cih0aGlzLCAncHJvZmlsZS10eXBlJyksXHJcbi8vICAgICAgICB9XSk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBhbGxvd0Ryb3AgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGBhbGxvd0Ryb3AgJHt0aGlzLnByb2ZpbGVOYW1lfWApO1xyXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIGhhbmRsZURyYWdFbnRlcihldmVudCkge1xyXG4gICAgICAgIGFkZENsYXNzKHRoaXMsICdvdmVyJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gaGFuZGxlRHJhZ0xlYXZlKGV2ZW50KSB7XHJcbiAgICAgICAgcmVtb3ZlQ2xhc3ModGhpcywgJ292ZXInKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBidWlsZFBlcm1pc3Npb25MaXN0KG5hbWVzLCB1c2Vyc0luZm8pIHtcclxuICAgICAgICBjb25zdCBwZXJtaXNzaW9uVGFibGUgPSBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0ucGVybWlzc2lvbi10YWJsZWApKTtcclxuICAgICAgICBjb25zdCB0cmVlUm9vdCA9IG1ha2VFbCgndWwnKTtcclxuICAgICAgICBhZGRFbChwZXJtaXNzaW9uVGFibGUsIHRyZWVSb290KTtcclxuXHJcbiAgICAgICAgUi5rZXlzKG5hbWVzKS5mb3JFYWNoKChlbnRpdHkpID0+IHtcclxuICAgICAgICAgICAgbmFtZXNbZW50aXR5XSA9IG5hbWVzW2VudGl0eV0ubWFwKFIucHJvcCgndmFsdWUnKSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIFIudmFsdWVzKHVzZXJzSW5mbykuZm9yRWFjaCgodXNlckluZm8pID0+IHtcclxuICAgICAgICAgICAgUi5rZXlzKHVzZXJJbmZvKS5mb3JFYWNoKChlbnRpdHkpID0+IHtcclxuICAgICAgICAgICAgICAgIG5hbWVzW2VudGl0eV0gPSBSLmRpZmZlcmVuY2UobmFtZXNbZW50aXR5XSwgdXNlckluZm9bZW50aXR5XSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB1c2Vyc0luZm9bZ2V0TDEwbignYWRtaW5zLWhhdmUtbm90LW93bmVyJyldID0gbmFtZXM7XHJcblxyXG4gICAgICAgIGNvbnN0IGhlYWRlcnMgPSB7XHJcbiAgICAgICAgICAgIGNoYXJhY3RlcnM6IGdldEwxMG4oJ2FkbWlucy1jaGFyYWN0ZXJzJyksXHJcbiAgICAgICAgICAgIHN0b3JpZXM6IGdldEwxMG4oJ2FkbWlucy1zdG9yaWVzJyksXHJcbiAgICAgICAgICAgIGdyb3VwczogZ2V0TDEwbignYWRtaW5zLWdyb3VwcycpLFxyXG4gICAgICAgICAgICBwbGF5ZXJzOiBnZXRMMTBuKCdhZG1pbnMtcGxheWVycycpLFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIGxpTWFrZXIodGV4dCkge1xyXG4gICAgICAgICAgICByZXR1cm4gYWRkRWwobWFrZUVsKCdsaScpLCBtYWtlVGV4dCh0ZXh0KSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiBtYWtlRW50aXR5TGlzdHModXNlckluZm8pIHtcclxuICAgICAgICAgICAgcmV0dXJuIHN0YXRlLmVudGl0aWVzLnJlZHVjZSgocmVzdWx0LCBlbnRpdHkpID0+IHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGxpTWFrZXIoaGVhZGVyc1tlbnRpdHldKSk7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChhZGRFbHMobWFrZUVsKCdvbCcpLCB1c2VySW5mb1tlbnRpdHldLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEpLm1hcChsaU1ha2VyKSkpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICAgICAgfSwgW10pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgdXNlck5hbWVzID0gT2JqZWN0LmtleXModXNlcnNJbmZvKS5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBKTtcclxuICAgICAgICBhZGRFbHModHJlZVJvb3QsIHVzZXJOYW1lcy5yZWR1Y2UoKHJlc3VsdCwgdXNlck5hbWUpID0+IHtcclxuICAgICAgICAgICAgcmVzdWx0LnB1c2gobGlNYWtlcih1c2VyTmFtZSkpO1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaChhZGRFbHMobWFrZUVsKCdvbCcpLCBtYWtlRW50aXR5TGlzdHModXNlcnNJbmZvW3VzZXJOYW1lXSkpKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9LCBbXSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZVVzZXIoZGlhbG9nKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdXNlck5hbWVJbnB1dCA9IHFlZShkaWFsb2csYC5jcmVhdGUtdXNlci1uYW1lLWlucHV0YCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHVzZXJQYXNzd29yZElucHV0ID0gcWVlKGRpYWxvZyxgLmNyZWF0ZS11c2VyLXBhc3N3b3JkLWlucHV0YCk7XHJcbiAgICAgICAgICAgIERCTVMuY3JlYXRlT3JnYW5pemVyKHVzZXJOYW1lSW5wdXQudmFsdWUudHJpbSgpLCB1c2VyUGFzc3dvcmRJbnB1dC52YWx1ZSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEVycm9yKGRpYWxvZywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXNlck5hbWVJbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIHVzZXJQYXNzd29yZElucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgZnVuY3Rpb24gY2hhbmdlUGFzc3dvcmQoZGlhbG9nKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdG9JbnB1dCA9IHFlZShkaWFsb2csICcuZW50aXR5LWlucHV0Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IG5ld1Bhc3N3b3JkID0gdG9JbnB1dC52YWx1ZTtcclxuICAgICAgICAgICAgY29uc3QgdXNlck5hbWUgPSBxdWVyeUVsKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC11c2VyLXNlbGVjdGApLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICAgICAgREJNUy5jaGFuZ2VPcmdhbml6ZXJQYXNzd29yZCh1c2VyTmFtZSwgbmV3UGFzc3dvcmQsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZy5oaWRlRGxnKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGZ1bmN0aW9uIGNoYW5nZU9yZ2FuaXplclBhc3N3b3JkKCkge1xyXG4gICAgICAgIGNvbnN0IHVzZXJOYW1lID0gcXVlcnlFbChgJHtyb290fS5jaGFuZ2UtcGFzc3dvcmQtdXNlci1zZWxlY3RgKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgY29uc3QgcGFzc3dvcmRJbnB1dCA9IHF1ZXJ5RWwoYCR7cm9vdH0uY2hhbmdlLXBhc3N3b3JkLXBhc3N3b3JkLWlucHV0YCk7XHJcbiAgICAgICAgREJNUy5jaGFuZ2VPcmdhbml6ZXJQYXNzd29yZCh1c2VyTmFtZSwgcGFzc3dvcmRJbnB1dC52YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCgpID0+IHtcclxuICAgICAgICAgICAgcXVlcnlFbChgJHtyb290fS5jaGFuZ2UtcGFzc3dvcmQtcGFzc3dvcmQtaW5wdXRgKS52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVtb3ZlT3JnYW5pemVyKCkge1xyXG4vLyAgICAgICAgY29uc3QgbmFtZSA9IHF1ZXJ5RWwoYCR7cm9vdH0ucmVtb3ZlLXVzZXItc2VsZWN0YCkudmFsdWUudHJpbSgpO1xyXG4gICAgICAgIGNvbnN0IG5hbWUgPSBxdWVyeUVsKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC11c2VyLXNlbGVjdGApLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICBVdGlscy5jb25maXJtKHN0ckZvcm1hdChnZXRMMTBuKCdhZG1pbnMtY29uZmlybS11c2VyLXJlbW92ZScpLCBbbmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMucmVtb3ZlT3JnYW5pemVyKG5hbWUsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBnZXRTZWxlY3RlZE9wdGlvbnMgPSBzZWwgPT4gbmwyYXJyYXkocXVlcnlFbChzZWwpLnNlbGVjdGVkT3B0aW9ucykubWFwKG9wdCA9PiBvcHQudmFsdWUpO1xyXG5cclxuICAgIGZ1bmN0aW9uIHBlcm1pc3Npb25BY3Rpb24oYWN0aW9uKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdXNlck5hbWUgPSBxdWVyeUVsKGAke3Jvb3R9LnVzZXItcGVybWlzc2lvbi1zZWxlY3RgKS52YWx1ZS50cmltKCk7XHJcblxyXG4gICAgICAgICAgICAvLyBUT0RPIHJlbW92ZSB0aGlzIGNoZWNrXHJcbiAgICAgICAgICAgIGlmICh1c2VyTmFtZSA9PT0gJycpIHtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ2FkbWlucy11c2VyLWlzLW5vdC1zZWxlY3RlZCcpKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgbmFtZXMgPSB7fTtcclxuICAgICAgICAgICAgc3RhdGUuZW50aXRpZXMuZm9yRWFjaCgoZW50aXR5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBuYW1lc1tlbnRpdHldID0gZ2V0U2VsZWN0ZWRPcHRpb25zKGAke3Jvb3R9LnBlcm1pc3Npb24tc2VsZWN0b3JfXyR7ZW50aXR5fWApO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIERCTVNbYWN0aW9uXSh1c2VyTmFtZSwgbmFtZXMsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZVBlcm1pc3Npb24gPSBwZXJtaXNzaW9uQWN0aW9uKCdyZW1vdmVQZXJtaXNzaW9uJyk7XHJcbiAgICBhc3NpZ25QZXJtaXNzaW9uID0gcGVybWlzc2lvbkFjdGlvbignYXNzaWduUGVybWlzc2lvbicpO1xyXG5cclxuICAgIGZ1bmN0aW9uIGFzc2lnbk5ld0FkbWluKCkge1xyXG4gICAgICAgIGNvbnN0IHVzZXJOYW1lID0gcXVlcnlFbChgJHtyb290fS5jaGFuZ2UtcGFzc3dvcmQtdXNlci1zZWxlY3RgKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQoZ2V0TDEwbignYWRtaW5zLWNvbmZpcm0tYWRtaW4tYXNzaWdubWVudCcpLCBbdXNlck5hbWVdKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICBEQk1TLmFzc2lnbkFkbWluKHVzZXJOYW1lLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiByZW1vdmVFZGl0b3IoKSB7XHJcbiAgICAgICAgREJNUy5yZW1vdmVFZGl0b3IoVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gYXNzaWduRWRpdG9yKCkge1xyXG4gICAgICAgIGNvbnN0IHVzZXJOYW1lID0gcXVlcnlFbChgJHtyb290fS5jaGFuZ2UtcGFzc3dvcmQtdXNlci1zZWxlY3RgKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQoZ2V0TDEwbignYWRtaW5zLWNvbmZpcm0tZWRpdG9yLWFzc2lnbm1lbnQnKSwgW3VzZXJOYW1lXSksICgpID0+IHtcclxuICAgICAgICAgICAgREJNUy5hc3NpZ25FZGl0b3IodXNlck5hbWUsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIGNoYW5nZUFkYXB0YXRpb25SaWdodHNNb2RlKGV2ZW50KSB7XHJcbiAgICAgICAgREJNUy5jaGFuZ2VBZGFwdGF0aW9uUmlnaHRzTW9kZShldmVudC50YXJnZXQudmFsdWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIGZpbHRlckxpc3QgPSBzZWwgPT4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgY29uc3Qgc3RyID0gZXZlbnQudGFyZ2V0LnZhbHVlLnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGVscyA9IHF1ZXJ5RWxzKGAke3Jvb3R9ICR7c2VsfSBbcHJpbWFyeS1uYW1lXWApO1xyXG4gICAgICAgIGVscy5mb3JFYWNoKChlbCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBpc1Zpc2libGUgPSBnZXRBdHRyKGVsLCAncHJpbWFyeS1uYW1lJykudG9Mb3dlckNhc2UoKS5pbmRleE9mKHN0cikgIT09IC0xO1xyXG4gICAgICAgICAgICBoaWRlRWwoZWwsICFpc1Zpc2libGUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxufSkodGhpcy5Pcmdhbml6ZXJNYW5hZ2VtZW50ID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG5cclxuICAgIGNvbnN0IHJvb3QgPSAnLnBsYXllci1tYW5hZ2VtZW50LXRhYiAnO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBjcmVhdGVVc2VyRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2cocm9vdCwgY3JlYXRlVXNlciwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdjcmVhdGUtb3JnYW5pemVyLWJvZHknLFxyXG4gICAgICAgICAgICBkaWFsb2dUaXRsZTogJ2FkbWlucy1jcmVhdGluZy1wbGF5ZXInLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1jcmVhdGUnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxpc3RlbihxZShgJHtyb290fS5jcmVhdGUucGxheWVyYCksICdjbGljaycsICgpID0+IGNyZWF0ZVVzZXJEaWFsb2cuc2hvd0RsZygpKTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBjcmVhdGVQbGF5ZXJBY2NvdW50RGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2cocm9vdCwgY3JlYXRlVXNlckFjY291bnQsIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnY3JlYXRlLXBsYXllci1hY2NvdW50LWJvZHknLFxyXG4gICAgICAgICAgICBkaWFsb2dUaXRsZTogJ2FkbWlucy1jcmVhdGluZy1wbGF5ZXItYWNjb3VudCcsXHJcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLWNyZWF0ZScsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9LmNyZWF0ZS5wbGF5ZXItYWNjb3VudGApLCAnY2xpY2snLCAoKSA9PiBjcmVhdGVQbGF5ZXJBY2NvdW50RGlhbG9nLnNob3dEbGcoKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgY2hhbmdlUGFzc3dvcmREaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhyb290LCBjaGFuZ2VQYXNzd29yZCwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdtb2RhbC1wcm9tcHQtYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnYWRtaW5zLWVudGVyLW5ldy1wYXNzd29yZCcsXHJcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLXJlcGxhY2UnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxpc3RlbihxZShgJHtyb290fS51c2VyLmNoYW5nZS1wYXNzd29yZGApLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHFlZShjaGFuZ2VQYXNzd29yZERpYWxvZywgJy5lbnRpdHktaW5wdXQnKS52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICBjaGFuZ2VQYXNzd29yZERpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgXHJcbi8vICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5jcmVhdGUtdXNlci1idXR0b25gKSwgJ2NsaWNrJywgY3JlYXRlVXNlcik7XHJcbi8vICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5jcmVhdGUtbG9naW4tYnV0dG9uYCksICdjbGljaycsIGNyZWF0ZUxvZ2luKTtcclxuLy8gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC1idXR0b25gKSwgJ2NsaWNrJywgY2hhbmdlUGFzc3dvcmQpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LnJlbW92ZS11c2VyLWJ1dHRvbmApLCAnY2xpY2snLCByZW1vdmVVc2VyKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS53ZWxjb21lLXRleHQtYXJlYWApLCAnY2hhbmdlJywgc2V0V2VsY29tZVRleHQpO1xyXG4gICAgICAgIHF1ZXJ5RWxFbHMocXVlcnlFbChyb290KSwgJy5wbGF5ZXJPcHRpb25zJykubWFwKGxpc3RlbihSLl9fLCAnY2hhbmdlJywgc2V0UGxheWVyT3B0aW9uKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgJChgJHtyb290fS5jaGFuZ2UtcGFzc3dvcmQtdXNlci1zZWxlY3RgKS5zZWxlY3QyKCkub24oJ2NoYW5nZScsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBwbGF5ZXIgPSBldmVudC50YXJnZXQudmFsdWU7XHJcbiAgICAgICAgICAgIGNvbnN0IHlvdXJQbGF5ZXJzID0gc3RhdGUucGxheWVyTmFtZXMuZmlsdGVyKFIucHJvcCgnaXNPd25lcicpKS5tYXAoUi5wcm9wKCd2YWx1ZScpKTtcclxuICAgICAgICAgICAgY29uc3QgaXNQbGF5ZXJFZGl0YWJsZSA9IFIuY29udGFpbnMocGxheWVyLCB5b3VyUGxheWVycyk7XHJcbiAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKHFlKGAke3Jvb3R9LnVzZXIuY2hhbmdlLXBhc3N3b3JkYCksIGlzUGxheWVyRWRpdGFibGUpO1xyXG4gICAgICAgICAgICBVdGlscy5lbmFibGVFbChxZShgJHtyb290fS5yZW1vdmUtdXNlci1idXR0b25gKSwgaXNQbGF5ZXJFZGl0YWJsZSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG5cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ3BsYXllcicsIGZhbHNlLCAoZXJyLCBwbGF5ZXJOYW1lcykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBEQk1TLmdldFBsYXllckxvZ2luc0FycmF5KChlcnIyLCBwbGF5ZXJMb2dpbnMpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0V2VsY29tZVRleHQoKGVycjMsIHRleHQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgREJNUy5nZXRQbGF5ZXJzT3B0aW9ucygoZXJyNCwgcGxheWVyc09wdGlvbnMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjQpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyNCk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuaXNBZG1pbigoZXJyNSwgaXNBZG1pbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjUpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyNSk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci1kZXN0cnVjdHVyaW5nXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBSLnRvUGFpcnMocGxheWVyc09wdGlvbnMpLm1hcChwYWlyID0+IChnZXRFbChwYWlyWzBdKS5jaGVja2VkID0gcGFpclsxXSkpO1xyXG4gICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVyeUVsKGAke3Jvb3R9LndlbGNvbWUtdGV4dC1hcmVhYCkudmFsdWUgPSB0ZXh0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGxheWVySGFzTG9naW4gPSBSLmNvbXBvc2UoUi5jb250YWlucyhSLl9fLCBwbGF5ZXJMb2dpbnMpLCBSLnByb3AoJ3ZhbHVlJykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzTG9naW5PYmogPSBSLmdyb3VwQnkocGxheWVySGFzTG9naW4sIHBsYXllck5hbWVzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUucGxheWVyTmFtZXMgPSBwbGF5ZXJOYW1lcztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm9BY2NvdW50cyA9IChoYXNMb2dpbk9iai5mYWxzZSB8fCBbXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub0FjY291bnRzLnNvcnQoVXRpbHMuY2hhck9yZEFPYmplY3QpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJChjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uY3JlYXRlLWxvZ2luLW5hbWUtc2VsZWN0YCkpKS5zZWxlY3QyKGdldFNlbGVjdDJEYXRhKG5vQWNjb3VudHMpKTtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgZmlsbFNlbGVjdG9yKGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5jcmVhdGUtbG9naW4tbmFtZS1zZWxlY3RgKSksIChoYXNMb2dpbk9iai5mYWxzZSB8fCBbXSlcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zb3J0KFV0aWxzLmNoYXJPcmRBT2JqZWN0KS5tYXAocmVtYXBQcm9wczRTZWxlY3QpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhc0FjY291bnRzID0gKGhhc0xvZ2luT2JqLnRydWUgfHwgW10pO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNBY2NvdW50cy5zb3J0KFV0aWxzLmNoYXJPcmRBT2JqZWN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC11c2VyLXNlbGVjdGApKSkuc2VsZWN0MihnZXRTZWxlY3QyRGF0YShoYXNBY2NvdW50cykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBVdGlscy5lbmFibGUoZXhwb3J0cy5jb250ZW50LCAnYWRtaW5Pbmx5JywgaXNBZG1pbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKHFlKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC11c2VyLXNlbGVjdGApLCBoYXNBY2NvdW50cy5sZW5ndGggPiAwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKHFlKGAke3Jvb3R9LnVzZXIuY2hhbmdlLXBhc3N3b3JkYCksIGhhc0FjY291bnRzLmxlbmd0aCA+IDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwocWUoYCR7cm9vdH0ucmVtb3ZlLXVzZXItYnV0dG9uYCksIGhhc0FjY291bnRzLmxlbmd0aCA+IDApO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICBmaWxsU2VsZWN0b3IoY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC11c2VyLXNlbGVjdGApKSwgKGhhc0xvZ2luT2JqLnRydWUgfHwgW10pXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc29ydChVdGlscy5jaGFyT3JkQU9iamVjdCkubWFwKHJlbWFwUHJvcHM0U2VsZWN0KSk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgIGZpbGxTZWxlY3RvcihjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0ucmVtb3ZlLXVzZXItc2VsZWN0YCkpLCAoaGFzTG9naW5PYmoudHJ1ZSB8fCBbXSlcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnNvcnQoVXRpbHMuY2hhck9yZEFPYmplY3QpLm1hcChyZW1hcFByb3BzNFNlbGVjdCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gY3JlYXRlVXNlcihkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB1c2VyTmFtZUlucHV0ID0gcWVlKGRpYWxvZyxgLmNyZWF0ZS11c2VyLW5hbWUtaW5wdXRgKTtcclxuICAgICAgICAgICAgY29uc3QgdXNlclBhc3N3b3JkSW5wdXQgPSBxZWUoZGlhbG9nLGAuY3JlYXRlLXVzZXItcGFzc3dvcmQtaW5wdXRgKTtcclxuICAgICAgICAgICAgREJNUy5jcmVhdGVQbGF5ZXIodXNlck5hbWVJbnB1dC52YWx1ZS50cmltKCksIHVzZXJQYXNzd29yZElucHV0LnZhbHVlLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIucmVmcmVzaCgoZXJyMikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJOYW1lSW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlclBhc3N3b3JkSW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIGNyZWF0ZVVzZXJBY2NvdW50KGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHVzZXJOYW1lU2VsZWN0ID0gcWVlKGRpYWxvZyxgLmNyZWF0ZS1sb2dpbi1uYW1lLXNlbGVjdGApO1xyXG4gICAgICAgICAgICBjb25zdCBwYXNzd29yZElucHV0ID0gcWVlKGRpYWxvZyxgLmNyZWF0ZS1sb2dpbi1wYXNzd29yZC1pbnB1dGApO1xyXG4gICAgICAgICAgICBEQk1TLmNyZWF0ZVBsYXllckxvZ2luKHVzZXJOYW1lU2VsZWN0LnZhbHVlLCBwYXNzd29yZElucHV0LnZhbHVlLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBwYXNzd29yZElucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjcmVhdGVMb2dpbigpIHtcclxuICAgICAgICBjb25zdCB1c2VyTmFtZVNlbGVjdCA9IHF1ZXJ5RWwoYCR7cm9vdH0uY3JlYXRlLWxvZ2luLW5hbWUtc2VsZWN0YCk7XHJcbiAgICAgICAgY29uc3QgcGFzc3dvcmRJbnB1dCA9IHF1ZXJ5RWwoYCR7cm9vdH0uY3JlYXRlLWxvZ2luLXBhc3N3b3JkLWlucHV0YCk7XHJcbiAgICAgICAgREJNUy5jcmVhdGVQbGF5ZXJMb2dpbih1c2VyTmFtZVNlbGVjdC52YWx1ZSwgcGFzc3dvcmRJbnB1dC52YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCgpID0+IHtcclxuICAgICAgICAgICAgcGFzc3dvcmRJbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4vLyAgICBmdW5jdGlvbiBjaGFuZ2VQYXNzd29yZCgpIHtcclxuLy8gICAgICAgIGNvbnN0IHVzZXJOYW1lU2VsZWN0ID0gcXVlcnlFbChgJHtyb290fS5jaGFuZ2UtcGFzc3dvcmQtdXNlci1zZWxlY3RgKTtcclxuLy8gICAgICAgIGNvbnN0IHBhc3N3b3JkSW5wdXQgPSBxdWVyeUVsKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC1wYXNzd29yZC1pbnB1dGApO1xyXG4vLyAgICAgICAgREJNUy5jaGFuZ2VQbGF5ZXJQYXNzd29yZCh1c2VyTmFtZVNlbGVjdC52YWx1ZSwgcGFzc3dvcmRJbnB1dC52YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCgpID0+IHtcclxuLy8gICAgICAgICAgICBwYXNzd29yZElucHV0LnZhbHVlID0gJyc7XHJcbi8vICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbi8vICAgICAgICB9KSk7XHJcbi8vICAgIH1cclxuICAgIFxyXG4gICAgZnVuY3Rpb24gY2hhbmdlUGFzc3dvcmQoZGlhbG9nKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdG9JbnB1dCA9IHFlZShkaWFsb2csICcuZW50aXR5LWlucHV0Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IG5ld1Bhc3N3b3JkID0gdG9JbnB1dC52YWx1ZTtcclxuICAgICAgICAgICAgY29uc3QgdXNlck5hbWUgPSBxdWVyeUVsKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC11c2VyLXNlbGVjdGApLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICAgICAgREJNUy5jaGFuZ2VQbGF5ZXJQYXNzd29yZCh1c2VyTmFtZSwgbmV3UGFzc3dvcmQsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZy5oaWRlRGxnKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVtb3ZlVXNlcigpIHtcclxuICAgICAgICBjb25zdCBuYW1lID0gcXVlcnlFbChgJHtyb290fS5jaGFuZ2UtcGFzc3dvcmQtdXNlci1zZWxlY3RgKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQoZ2V0TDEwbignYWRtaW5zLWNvbmZpcm0tdXNlci1hY2NvdW50LXJlbW92ZScpLCBbbmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMucmVtb3ZlUGxheWVyTG9naW4obmFtZSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgIH0pO1xyXG4vLyAgICAgICAgY29uc3QgdXNlck5hbWVTZWxlY3QgPSBxdWVyeUVsKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC11c2VyLXNlbGVjdGApO1xyXG4vLyAgICAgICAgREJNUy5yZW1vdmVQbGF5ZXJMb2dpbih1c2VyTmFtZVNlbGVjdC52YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNldFdlbGNvbWVUZXh0KGV2ZW50KSB7XHJcbiAgICAgICAgREJNUy5zZXRXZWxjb21lVGV4dChldmVudC50YXJnZXQudmFsdWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzZXRQbGF5ZXJPcHRpb24oZXZlbnQpIHtcclxuICAgICAgICBEQk1TLnNldFBsYXllck9wdGlvbihldmVudC50YXJnZXQudmFsdWUsIGV2ZW50LnRhcmdldC5jaGVja2VkLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICB9XHJcbn0pKHRoaXMuUGxheWVyTWFuYWdlbWVudCA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNSwgMjAxOCBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHJvb3QgPSAnLmFkYXB0YXRpb25zLXRhYiAnO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBsaXN0ZW4oZ2V0RWwoJ2V2ZW50cy1zdG9yeVNlbGVjdG9yJyksICdjaGFuZ2UnLCB1cGRhdGVBZGFwdGF0aW9uU2VsZWN0b3JEZWxlZ2F0ZSk7XHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCdldmVudHMtY2hhcmFjdGVyU2VsZWN0b3InKSwgJ2NoYW5nZScsIHNob3dQZXJzb25hbFN0b3JpZXNCeUNoYXJhY3RlcnMpO1xyXG4gICAgICAgIGxpc3RlbihnZXRFbCgnZXZlbnRzLWV2ZW50U2VsZWN0b3InKSwgJ2NoYW5nZScsIHNob3dQZXJzb25hbFN0b3JpZXNCeUV2ZW50cyk7XHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCdmaW5pc2hlZFN0b3J5Q2hlY2tib3gnKSwgJ2NoYW5nZScsIGV4cG9ydHMucmVmcmVzaCk7XHJcbiAgICAgICAgcXVlcnlFbHMoJy5hZGFwdGF0aW9ucy10YWIgaW5wdXRbbmFtZT1hZGFwdGF0aW9uRmlsdGVyXScpLm1hcChsaXN0ZW4oUi5fXywgJ2NoYW5nZScsIHVwZGF0ZUZpbHRlcikpO1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBzZWxlY3RvciA9IGNsZWFyRWwoZ2V0RWwoJ2V2ZW50cy1zdG9yeVNlbGVjdG9yJykpO1xyXG4gICAgICAgIGNsZWFyRWwoZ2V0RWwoJ2V2ZW50cy1jaGFyYWN0ZXJTZWxlY3RvcicpKTtcclxuICAgICAgICBjbGVhckVsKGdldEVsKCdldmVudHMtZXZlbnRTZWxlY3RvcicpKTtcclxuICAgICAgICBjbGVhckVsKGdldEVsKCdwZXJzb25hbFN0b3JpZXMnKSk7XHJcblxyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdzdG9yeScsIGZhbHNlLCAoZXJyLCBhbGxTdG9yeU5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIERCTVMuZ2V0RmlsdGVyZWRTdG9yeU5hbWVzKGdldEVsKCdmaW5pc2hlZFN0b3J5Q2hlY2tib3gnKS5jaGVja2VkLCAoZXJyMiwgc3RvcnlOYW1lcykgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBzaG93RWwocWUoYCR7cm9vdH0gLmFsZXJ0YCksIHN0b3J5TmFtZXMubGVuZ3RoID09PSAwKTtcclxuICAgICAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fSAuYWRhcHRhdGlvbnMtY29udGVudGApLCBzdG9yeU5hbWVzLmxlbmd0aCAhPT0gMCk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGlmIChzdG9yeU5hbWVzLmxlbmd0aCA8PSAwKSB7IHJldHVybjsgfVxyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkU3RvcnlOYW1lID0gZ2V0U2VsZWN0ZWRTdG9yeU5hbWUoc3RvcnlOYW1lcyk7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyZWRBcnIgPSBSLmluZGV4QnkoUi5wcm9wKCdzdG9yeU5hbWUnKSwgc3RvcnlOYW1lcyk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGNvbnN0IHN0b3J5TmFtZXMyID0gYWxsU3RvcnlOYW1lcy5maWx0ZXIoc3RvcnkgPT4gUi5jb250YWlucyhzdG9yeS52YWx1ZSwgUi5rZXlzKGZpbHRlcmVkQXJyKSkpLm1hcCggc3RvcnkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsZW0gPSBmaWx0ZXJlZEFycltzdG9yeS52YWx1ZV07XHJcbiAgICAgICAgICAgICAgICAgICAgZWxlbS5kaXNwbGF5TmFtZSA9IHN0b3J5LmRpc3BsYXlOYW1lO1xyXG4gICAgICAgICAgICAgICAgICAgIGVsZW0udmFsdWUgPSBzdG9yeS52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBvcHRpb247XHJcbiAgICAgICAgICAgICAgICBzdG9yeU5hbWVzMi5mb3JFYWNoKChzdG9yeU5hbWUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBvcHRpb24gPSBhZGRFbChtYWtlRWwoJ29wdGlvbicpLCAobWFrZVRleHQoc3RvcnlOYW1lLmRpc3BsYXlOYW1lKSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZENsYXNzKG9wdGlvbiwgZ2V0SWNvbkNsYXNzKHN0b3J5TmFtZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNldFByb3Aob3B0aW9uLCAnc2VsZWN0ZWQnLCBzdG9yeU5hbWUudmFsdWUgPT09IHNlbGVjdGVkU3RvcnlOYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICBzZXRQcm9wKG9wdGlvbiwgJ3N0b3J5SW5mbycsIHN0b3J5TmFtZS52YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkRWwoc2VsZWN0b3IsIG9wdGlvbik7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIoc2VsZWN0b3IsICdzaXplJywgTWF0aC5taW4oc3RvcnlOYW1lczIubGVuZ3RoLCAxMCkpO1xyXG4gICAgICAgICAgICAgICAgc2hvd1BlcnNvbmFsU3RvcmllcyhzZWxlY3RlZFN0b3J5TmFtZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVBZGFwdGF0aW9uU2VsZWN0b3JEZWxlZ2F0ZShldmVudCkge1xyXG4gICAgICAgIGNsZWFyRWwoZ2V0RWwoJ3BlcnNvbmFsU3RvcmllcycpKTtcclxuICAgICAgICBjb25zdCBzdG9yeU5hbWUgPSBldmVudC50YXJnZXQuc2VsZWN0ZWRPcHRpb25zWzBdLnN0b3J5SW5mbztcclxuICAgICAgICB1cGRhdGVTZXR0aW5ncygnc3RvcnlOYW1lJywgc3RvcnlOYW1lKTtcclxuICAgICAgICB1cGRhdGVTZXR0aW5ncygnY2hhcmFjdGVyTmFtZXMnLCBudWxsKTtcclxuICAgICAgICB1cGRhdGVTZXR0aW5ncygnZXZlbnRJbmRleGVzJywgbnVsbCk7XHJcbiAgICAgICAgc2hvd1BlcnNvbmFsU3RvcmllcyhzdG9yeU5hbWUpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZUFkYXB0YXRpb25TZWxlY3RvcihzdG9yeSwgYWxsQ2hhcmFjdGVycykge1xyXG4gICAgICAgIGNvbnN0IGNoYXJhY3RlclNlbGVjdG9yID0gY2xlYXJFbChnZXRFbCgnZXZlbnRzLWNoYXJhY3RlclNlbGVjdG9yJykpO1xyXG4gICAgICAgIGNvbnN0IGV2ZW50U2VsZWN0b3IgPSBjbGVhckVsKGdldEVsKCdldmVudHMtZXZlbnRTZWxlY3RvcicpKTtcclxuXHJcbiAgICAgICAgbGV0IGNoYXJhY3RlckFycmF5ID0gZ2V0U3RvcnlDaGFyYWN0ZXJDb21wbGV0ZW5lc3Moc3RvcnkpO1xyXG4gICAgICAgIGxldCBldmVudEFycmF5ID0gZ2V0U3RvcnlFdmVudENvbXBsZXRlbmVzcyhzdG9yeSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHNob3dPbmx5VW5maW5pc2hlZFN0b3JpZXMgPSBnZXRFbCgnZmluaXNoZWRTdG9yeUNoZWNrYm94JykuY2hlY2tlZDtcclxuICAgICAgICBpZiAoc2hvd09ubHlVbmZpbmlzaGVkU3Rvcmllcykge1xyXG4gICAgICAgICAgICBjaGFyYWN0ZXJBcnJheSA9IGNoYXJhY3RlckFycmF5LmZpbHRlcihlbGVtID0+ICFlbGVtLmlzRmluaXNoZWQgfHwgZWxlbS5pc0VtcHR5KTtcclxuICAgICAgICAgICAgZXZlbnRBcnJheSA9IGV2ZW50QXJyYXkuZmlsdGVyKGVsZW0gPT4gIWVsZW0uaXNGaW5pc2hlZCB8fCBlbGVtLmlzRW1wdHkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgY2hhcmFjdGVyTmFtZXMgPSBnZXRDaGFyYWN0ZXJOYW1lcyhjaGFyYWN0ZXJBcnJheSk7XHJcbiAgICAgICAgY29uc3QgZXZlbnRJbmRleGVzID0gZ2V0RXZlbnRJbmRleGVzKGV2ZW50QXJyYXkpO1xyXG5cclxuICAgICAgICBjb25zdCBtYXAgPSBDb21tb25VdGlscy5hcnIybWFwKGFsbENoYXJhY3RlcnMsICd2YWx1ZScpO1xyXG5cclxuICAgICAgICBjaGFyYWN0ZXJBcnJheS5mb3JFYWNoKChlbGVtKSA9PiB7XHJcbiAgICAgICAgICAgIGVsZW0uZGlzcGxheU5hbWUgPSBtYXBbZWxlbS5jaGFyYWN0ZXJOYW1lXS5kaXNwbGF5TmFtZTtcclxuICAgICAgICAgICAgZWxlbS52YWx1ZSA9IG1hcFtlbGVtLmNoYXJhY3Rlck5hbWVdLnZhbHVlO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjaGFyYWN0ZXJBcnJheS5zb3J0KFV0aWxzLmNoYXJPcmRBT2JqZWN0KTtcclxuXHJcbiAgICAgICAgbGV0IG9wdGlvbjtcclxuICAgICAgICBjaGFyYWN0ZXJBcnJheS5mb3JFYWNoKChlbGVtKSA9PiB7XHJcbiAgICAgICAgICAgIG9wdGlvbiA9IGFkZEVsKG1ha2VFbCgnb3B0aW9uJyksIChtYWtlVGV4dChlbGVtLmRpc3BsYXlOYW1lKSkpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhvcHRpb24sIGdldEljb25DbGFzcyhlbGVtKSk7XHJcbiAgICAgICAgICAgIHNldFByb3Aob3B0aW9uLCAnc2VsZWN0ZWQnLCBjaGFyYWN0ZXJOYW1lcy5pbmRleE9mKGVsZW0udmFsdWUpICE9PSAtMSk7XHJcbiAgICAgICAgICAgIHNldFByb3Aob3B0aW9uLCAnc3RvcnlJbmZvJywgc3RvcnkubmFtZSk7XHJcbiAgICAgICAgICAgIHNldFByb3Aob3B0aW9uLCAnY2hhcmFjdGVyTmFtZScsIGVsZW0udmFsdWUpO1xyXG4gICAgICAgICAgICBhZGRFbChjaGFyYWN0ZXJTZWxlY3Rvciwgb3B0aW9uKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBzZXRBdHRyKGNoYXJhY3RlclNlbGVjdG9yLCAnc2l6ZScsIGNoYXJhY3RlckFycmF5Lmxlbmd0aCk7XHJcblxyXG4gICAgICAgIGV2ZW50QXJyYXkuZm9yRWFjaCgoZWxlbSkgPT4ge1xyXG4gICAgICAgICAgICBvcHRpb24gPSBhZGRFbChtYWtlRWwoJ29wdGlvbicpLCAobWFrZVRleHQoZWxlbS5uYW1lKSkpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhvcHRpb24sIGdldEljb25DbGFzcyhlbGVtKSk7XHJcbiAgICAgICAgICAgIHNldFByb3Aob3B0aW9uLCAnc2VsZWN0ZWQnLCBldmVudEluZGV4ZXMuaW5kZXhPZihlbGVtLmluZGV4KSAhPT0gLTEpO1xyXG4gICAgICAgICAgICBzZXRQcm9wKG9wdGlvbiwgJ3N0b3J5SW5mbycsIHN0b3J5Lm5hbWUpO1xyXG4gICAgICAgICAgICBzZXRQcm9wKG9wdGlvbiwgJ2V2ZW50SW5kZXgyMjInLCBlbGVtLmluZGV4KTtcclxuICAgICAgICAgICAgYWRkRWwoZXZlbnRTZWxlY3Rvciwgb3B0aW9uKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBzZXRBdHRyKGV2ZW50U2VsZWN0b3IsICdzaXplJywgZXZlbnRBcnJheS5sZW5ndGgpO1xyXG5cclxuICAgICAgICBjb25zdCB7IHNlbGVjdGVkRmlsdGVyIH0gPSBEQk1TLmdldFNldHRpbmdzKCkuQWRhcHRhdGlvbnM7XHJcbiAgICAgICAgZ2V0RWwoc2VsZWN0ZWRGaWx0ZXIpLmNoZWNrZWQgPSB0cnVlO1xyXG4gICAgICAgIHVwZGF0ZUZpbHRlcih7XHJcbiAgICAgICAgICAgIHRhcmdldDoge1xyXG4gICAgICAgICAgICAgICAgaWQ6IHNlbGVjdGVkRmlsdGVyXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVGaWx0ZXIoZXZlbnQpIHtcclxuICAgICAgICB1cGRhdGVTZXR0aW5ncygnc2VsZWN0ZWRGaWx0ZXInLCBldmVudC50YXJnZXQuaWQpO1xyXG4gICAgICAgIGNvbnN0IGJ5Q2hhcmFjdGVyID0gZXZlbnQudGFyZ2V0LmlkID09PSAnYWRhcHRhdGlvbkZpbHRlckJ5Q2hhcmFjdGVyJztcclxuICAgICAgICBoaWRlRWwoZ2V0RWwoJ2V2ZW50cy1jaGFyYWN0ZXJTZWxlY3RvckRpdicpLCAhYnlDaGFyYWN0ZXIpO1xyXG4gICAgICAgIGhpZGVFbChnZXRFbCgnZXZlbnRzLWV2ZW50U2VsZWN0b3JEaXYnKSwgYnlDaGFyYWN0ZXIpO1xyXG4gICAgICAgIGlmIChieUNoYXJhY3Rlcikge1xyXG4gICAgICAgICAgICBzaG93UGVyc29uYWxTdG9yaWVzQnlDaGFyYWN0ZXJzKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc2hvd1BlcnNvbmFsU3Rvcmllc0J5RXZlbnRzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNob3dQZXJzb25hbFN0b3JpZXNCeUNoYXJhY3RlcnMoKSB7XHJcbiAgICAgICAgY29uc3QgZXZlbnRSb3dzID0gcXVlcnlFbEVscyhleHBvcnRzLmNvbnRlbnQsICcuZXZlbnRSb3ctZGVwZW5kZW50Jyk7XHJcbiAgICAgICAgZXZlbnRSb3dzLm1hcChyZW1vdmVDbGFzcyhSLl9fLCAnaGlkZGVuJykpO1xyXG4gICAgICAgIG5sMmFycmF5KHF1ZXJ5RWxFbHMoZXhwb3J0cy5jb250ZW50LCAnZGl2W2RlcGVuZGVudC1vbi1jaGFyYWN0ZXJdJykpLm1hcChhZGRDbGFzcyhSLl9fLCAnaGlkZGVuJykpO1xyXG5cclxuICAgICAgICBjb25zdCBjaGFyYWN0ZXJOYW1lcyA9IG5sMmFycmF5KGdldEVsKCdldmVudHMtY2hhcmFjdGVyU2VsZWN0b3InKS5zZWxlY3RlZE9wdGlvbnMpLm1hcChvcHQgPT4gb3B0LmNoYXJhY3Rlck5hbWUpO1xyXG4gICAgICAgIGNoYXJhY3Rlck5hbWVzLmZvckVhY2gobmFtZSA9PiBxdWVyeUVsRWxzKGV4cG9ydHMuY29udGVudCwgYGRpdltkZXBlbmRlbnQtb24tY2hhcmFjdGVyPVwiJHtuYW1lfVwiXWApLm1hcChyZW1vdmVDbGFzcyhSLl9fLCAnaGlkZGVuJykpKTtcclxuICAgICAgICBldmVudFJvd3MubWFwKHJvdyA9PiBoaWRlRWwocm93LCBSLmludGVyc2VjdGlvbihyb3cuZGVwZW5kc09uQ2hhcmFjdGVycywgY2hhcmFjdGVyTmFtZXMpLmxlbmd0aCA9PT0gMCkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHVwZGF0ZVNldHRpbmdzKCdjaGFyYWN0ZXJOYW1lcycsIGNoYXJhY3Rlck5hbWVzKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzaG93UGVyc29uYWxTdG9yaWVzQnlFdmVudHMoKSB7XHJcbiAgICAgICAgcXVlcnlFbEVscyhleHBvcnRzLmNvbnRlbnQsICdkaXZbZGVwZW5kZW50LW9uLWNoYXJhY3Rlcl0nKS5tYXAocmVtb3ZlQ2xhc3MoUi5fXywgJ2hpZGRlbicpKTtcclxuICAgICAgICBxdWVyeUVsRWxzKGV4cG9ydHMuY29udGVudCwgJy5ldmVudFJvdy1kZXBlbmRlbnQnKS5tYXAoYWRkQ2xhc3MoUi5fXywgJ2hpZGRlbicpKTtcclxuXHJcbiAgICAgICAgY29uc3QgZXZlbnRJbmRleGVzID0gbmwyYXJyYXkoZ2V0RWwoJ2V2ZW50cy1ldmVudFNlbGVjdG9yJykuc2VsZWN0ZWRPcHRpb25zKS5tYXAob3B0ID0+IG9wdC5ldmVudEluZGV4MjIyKTtcclxuICAgICAgICBldmVudEluZGV4ZXMuZm9yRWFjaChpbmRleCA9PiByZW1vdmVDbGFzcyhnZXRFbHMoYCR7aW5kZXh9LWRlcGVuZGVudGApWzBdLCAnaGlkZGVuJykpO1xyXG4gICAgICAgIHVwZGF0ZVNldHRpbmdzKCdldmVudEluZGV4ZXMnLCBldmVudEluZGV4ZXMpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldFN0b3J5Q2hhcmFjdGVyQ29tcGxldGVuZXNzKHN0b3J5KSB7XHJcbiAgICAgICAgcmV0dXJuIFIua2V5cyhzdG9yeS5jaGFyYWN0ZXJzKS5tYXAoZWxlbSA9PiAoe1xyXG4gICAgICAgICAgICBjaGFyYWN0ZXJOYW1lOiBlbGVtLFxyXG4gICAgICAgICAgICBpc0ZpbmlzaGVkOiBfaXNTdG9yeUZpbmlzaGVkRm9yQ2hhcmFjdGVyKHN0b3J5LCBlbGVtKSxcclxuICAgICAgICAgICAgaXNFbXB0eTogX2lzU3RvcnlFbXB0eUZvckNoYXJhY3RlcihzdG9yeSwgZWxlbSlcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gX2lzU3RvcnlFbXB0eUZvckNoYXJhY3RlcihzdG9yeSwgY2hhcmFjdGVyTmFtZSkge1xyXG4gICAgICAgIHJldHVybiBzdG9yeS5ldmVudHMuZXZlcnkoZXZlbnQgPT4gZXZlbnQuY2hhcmFjdGVyc1tjaGFyYWN0ZXJOYW1lXSA9PT0gdW5kZWZpbmVkKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBfaXNTdG9yeUZpbmlzaGVkRm9yQ2hhcmFjdGVyKHN0b3J5LCBjaGFyYWN0ZXJOYW1lKSB7XHJcbiAgICAgICAgcmV0dXJuIHN0b3J5LmV2ZW50cy5maWx0ZXIoZXZlbnQgPT4gZXZlbnQuY2hhcmFjdGVyc1tjaGFyYWN0ZXJOYW1lXSAhPT0gdW5kZWZpbmVkKVxyXG4gICAgICAgICAgICAuZXZlcnkoZXZlbnQgPT4gZXZlbnQuY2hhcmFjdGVyc1tjaGFyYWN0ZXJOYW1lXS5yZWFkeSA9PT0gdHJ1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0U3RvcnlFdmVudENvbXBsZXRlbmVzcyhzdG9yeSkge1xyXG4gICAgICAgIHJldHVybiBzdG9yeS5ldmVudHMubWFwKChldmVudCwgaSkgPT4gKHtcclxuICAgICAgICAgICAgbmFtZTogZXZlbnQubmFtZSxcclxuICAgICAgICAgICAgaW5kZXg6IGksXHJcbiAgICAgICAgICAgIGlzRmluaXNoZWQ6IF9pc0V2ZW50UmVhZHkoZXZlbnQpLFxyXG4gICAgICAgICAgICBpc0VtcHR5OiBPYmplY3Qua2V5cyhldmVudC5jaGFyYWN0ZXJzKS5sZW5ndGggPT09IDBcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gX2lzRXZlbnRSZWFkeShldmVudCkge1xyXG4gICAgICAgIHJldHVybiBSLnZhbHVlcyhldmVudC5jaGFyYWN0ZXJzKS5ldmVyeShjaGFyYWN0ZXIgPT4gY2hhcmFjdGVyLnJlYWR5KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzaG93UGVyc29uYWxTdG9yaWVzKHN0b3J5TmFtZSkge1xyXG4gICAgICAgIERCTVMuZ2V0TWV0YUluZm8oKGVyciwgbWV0YUluZm8pID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgREJNUy5nZXRTdG9yeShzdG9yeU5hbWUsIChlcnIyLCBzdG9yeSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmlzRW50aXR5RWRpdGFibGUoJ3N0b3J5Jywgc3RvcnlOYW1lLCAoZXJyMywgaXNTdG9yeUVkaXRhYmxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycjMpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMyk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdjaGFyYWN0ZXInLCBmYWxzZSwgKGVycjQsIGFsbENoYXJhY3RlcnMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjQpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyNCk7IHJldHVybjsgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hhcmFjdGVyTmFtZXMgPSBSLmtleXMoc3RvcnkuY2hhcmFjdGVycyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFkYXB0YXRpb25zID0gY2hhcmFjdGVyTmFtZXMubWFwKGNoYXJhY3Rlck5hbWUgPT4gKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYXJhY3Rlck5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9yeU5hbWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuYXJlQWRhcHRhdGlvbnNFZGl0YWJsZShhZGFwdGF0aW9ucywgKGVycjUsIGFyZUFkYXB0YXRpb25zRWRpdGFibGUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnI1KSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjUpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3J5LmV2ZW50cy5mb3JFYWNoKChpdGVtLCBpKSA9PiAoaXRlbS5pbmRleCA9IGkpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1aWxkQWRhcHRhdGlvbkludGVyZmFjZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9yeU5hbWUsIGNoYXJhY3Rlck5hbWVzLCBzdG9yeS5ldmVudHMsIGFyZUFkYXB0YXRpb25zRWRpdGFibGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0YUluZm9cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVBZGFwdGF0aW9uU2VsZWN0b3Ioc3RvcnksIGFsbENoYXJhY3RlcnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlKGV4cG9ydHMuY29udGVudCwgJ2lzU3RvcnlFZGl0YWJsZScsIGlzU3RvcnlFZGl0YWJsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBVdGlscy5lbmFibGUoZXhwb3J0cy5jb250ZW50LCAnbm90RWRpdGFibGUnLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGJ1aWxkQWRhcHRhdGlvbkludGVyZmFjZShzdG9yeU5hbWUsIGNoYXJhY3Rlck5hbWVzLCBldmVudHMsIGFyZUFkYXB0YXRpb25zRWRpdGFibGUsIG1ldGFJbmZvKSB7XHJcbiAgICAgICAgY29uc3QgZGl2ID0gY2xlYXJFbChnZXRFbCgncGVyc29uYWxTdG9yaWVzJykpO1xyXG4gICAgICAgIGlmKGV2ZW50cy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgY29uc3QgYWxlcnQgPSBxbXRlKCcuYWxlcnQtYmxvY2stdG1wbCcpO1xyXG4gICAgICAgICAgICBhZGRFbChhbGVydCwgbWFrZVRleHQoTDEwbi5nZXQoJ2FkdmljZXMnLCAnbm8tZXZlbnRzLWluLXN0b3J5JykpKTtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoYWxlcnQsICdtYXJnaW4tYm90dG9tLTgnKTtcclxuICAgICAgICAgICAgYWRkRWwoZGl2LCBhbGVydCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmKGNoYXJhY3Rlck5hbWVzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICBjb25zdCBhbGVydCA9IHFtdGUoJy5hbGVydC1ibG9jay10bXBsJyk7XHJcbiAgICAgICAgICAgIGFkZEVsKGFsZXJ0LCBtYWtlVGV4dChMMTBuLmdldCgnYWR2aWNlcycsICduby1jaGFyYWN0ZXJzLWluLXN0b3J5JykpKTtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoYWxlcnQsICdtYXJnaW4tYm90dG9tLTgnKTtcclxuICAgICAgICAgICAgYWRkRWwoZGl2LCBhbGVydCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGFkYXB0YXRpb25zTnVtID0gUi5mbGF0dGVuKGV2ZW50cy5tYXAoZXZlbnQgPT4gUi5rZXlzKGV2ZW50LmNoYXJhY3RlcnMpKSkubGVuZ3RoO1xyXG4gICAgICAgIGlmKGFkYXB0YXRpb25zTnVtID09PSAwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGFsZXJ0ID0gcW10ZSgnLmFsZXJ0LWJsb2NrLXRtcGwnKTtcclxuICAgICAgICAgICAgYWRkRWwoYWxlcnQsIG1ha2VUZXh0KEwxMG4uZ2V0KCdhZHZpY2VzJywgJ25vLWFkYXB0YXRpb25zLWluLXN0b3J5JykpKTtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoYWxlcnQsICdtYXJnaW4tYm90dG9tLTgnKTtcclxuICAgICAgICAgICAgYWRkRWwoZGl2LCBhbGVydCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGFkZEVscyhkaXYsIGV2ZW50cy5tYXAoKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJvdyA9IHFtdGUoYCR7cm9vdH0gLmFkYXB0YXRpb24tcm93LXRtcGxgKTtcclxuICAgICAgICAgICAgYWRkQ2xhc3Mocm93LCBgJHtldmVudC5pbmRleH0tZGVwZW5kZW50YCk7XHJcbiAgICAgICAgICAgIHJvdy5kZXBlbmRzT25DaGFyYWN0ZXJzID0gUi5rZXlzKGV2ZW50LmNoYXJhY3RlcnMpO1xyXG4gICAgICAgICAgICBhZGRFbChxZWUocm93LCAnLmV2ZW50TWFpblBhbmVsUm93LWxlZnQnKSwgZXhwb3J0cy5tYWtlT3JpZ2luQ2FyZChldmVudCwgbWV0YUluZm8sIHN0b3J5TmFtZSwge1xyXG5cclxuICAgICAgICAgICAgICAgIHNob3dUaW1lSW5wdXQ6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBzaG93VGV4dElucHV0OiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgY2FyZFRpdGxlOiBldmVudC5uYW1lXHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgYWRkRWxzKHFlZShyb3csICcuZXZlbnRzLWV2ZW50c0NvbnRhaW5lcicpLCBjaGFyYWN0ZXJOYW1lc1xyXG4gICAgICAgICAgICAgICAgLmZpbHRlcihjaGFyYWN0ZXJOYW1lID0+IGV2ZW50LmNoYXJhY3RlcnNbY2hhcmFjdGVyTmFtZV0pXHJcbiAgICAgICAgICAgICAgICAubWFwKChjaGFyYWN0ZXJOYW1lKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNFZGl0YWJsZSA9IGFyZUFkYXB0YXRpb25zRWRpdGFibGVbYCR7c3RvcnlOYW1lfS0ke2NoYXJhY3Rlck5hbWV9YF07XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4cG9ydHMubWFrZUFkYXB0YXRpb25DYXJkKGlzRWRpdGFibGUsIGV2ZW50LCBzdG9yeU5hbWUsIGNoYXJhY3Rlck5hbWUsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2hvd0ZpbmlzaGVkQnV0dG9uOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzaG93VGltZUlucHV0OiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzaG93VGV4dElucHV0OiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXJkVGl0bGU6IGNoYXJhY3Rlck5hbWVcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiByb3c7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydHMubWFrZU9yaWdpbkNhcmQgPSAoZXZlbnQsIG1ldGFJbmZvLCBzdG9yeU5hbWUsIG9wdHMpID0+IHtcclxuICAgICAgICBjb25zdCBjYXJkID0gcW10ZShgJHtyb290fSAub3JpZ2luLXRtcGxgKTtcclxuICAgICAgICBhZGRFbChxZWUoY2FyZCwgJy5jYXJkLXRpdGxlJyksIG1ha2VUZXh0KG9wdHMuY2FyZFRpdGxlKSk7XHJcbiAgICAgICAgY29uc3QgdGV4dElucHV0ID0gcWVlKGNhcmQsICcudGV4dC1pbnB1dCcpO1xyXG4gICAgICAgIGNvbnN0IHRpbWVJbnB1dCA9IHFlZShjYXJkLCAnLnRpbWUtaW5wdXQnKTtcclxuICAgICAgICBjb25zdCBsb2NrQnV0dG9uID0gcWVlKGNhcmQsICdidXR0b24ubG9ja2VkJyk7XHJcblxyXG4gICAgICAgIGlmIChvcHRzLnNob3dUaW1lSW5wdXQgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgVUkubWFrZUV2ZW50VGltZVBpY2tlcjIodGltZUlucHV0LCB7XHJcbiAgICAgICAgICAgICAgICBldmVudFRpbWU6IGV2ZW50LnRpbWUsXHJcbiAgICAgICAgICAgICAgICBpbmRleDogZXZlbnQuaW5kZXgsXHJcbiAgICAgICAgICAgICAgICBwcmVHYW1lRGF0ZTogbWV0YUluZm8ucHJlR2FtZURhdGUsXHJcbiAgICAgICAgICAgICAgICBkYXRlOiBtZXRhSW5mby5kYXRlLFxyXG4gICAgICAgICAgICAgICAgb25DaGFuZ2VEYXRlVGltZUNyZWF0b3I6IG9uQ2hhbmdlRGF0ZVRpbWVDcmVhdG9yKHN0b3J5TmFtZSlcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgYWRkQ2xhc3ModGltZUlucHV0LCAnaGlkZGVuJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAob3B0cy5zaG93VGV4dElucHV0ID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgIHRleHRJbnB1dC52YWx1ZSA9IGV2ZW50LnRleHQ7XHJcbiAgICAgICAgICAgIHRleHRJbnB1dC5kYXRhS2V5ID0gSlNPTi5zdHJpbmdpZnkoW3N0b3J5TmFtZSwgZXZlbnQuaW5kZXhdKTtcclxuICAgICAgICAgICAgbGlzdGVuKHRleHRJbnB1dCwgJ2NoYW5nZScsIG9uQ2hhbmdlT3JpZ2luVGV4dCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgYWRkQ2xhc3ModGV4dElucHV0LCAnaGlkZGVuJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAob3B0cy5zaG93TG9ja0J1dHRvbiA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICBsaXN0ZW4obG9ja0J1dHRvbiwgJ2NsaWNrJywgb25PcmlnaW5Mb2NrQ2xpY2sodGltZUlucHV0LCB0ZXh0SW5wdXQpKTtcclxuICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwodGltZUlucHV0LCBmYWxzZSk7XHJcbiAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKHRleHRJbnB1dCwgZmFsc2UpO1xyXG4gICAgICAgICAgICBMMTBuLmxvY2FsaXplU3RhdGljKGNhcmQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKGxvY2tCdXR0b24sICdoaWRkZW4nKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBjYXJkO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBvbk9yaWdpbkxvY2tDbGljayh0aW1lSW5wdXQsIHRleHRJbnB1dCkge1xyXG4gICAgICAgIHJldHVybiAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgeyB0YXJnZXQgfSA9IGV2ZW50O1xyXG4gICAgICAgICAgICBjb25zdCBpc0xvY2tlZCA9IGhhc0NsYXNzKHRhcmdldCwgJ2J0bi1wcmltYXJ5Jyk7XHJcbiAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24odGFyZ2V0LCAnYnRuLXByaW1hcnknLCAhaXNMb2NrZWQpO1xyXG4gICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKHRhcmdldCwgJ2xvY2tlZCcsICFpc0xvY2tlZCk7XHJcbiAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24odGFyZ2V0LCAndW5sb2NrZWQnLCBpc0xvY2tlZCk7XHJcbiAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKHRpbWVJbnB1dCwgaXNMb2NrZWQpO1xyXG4gICAgICAgICAgICBVdGlscy5lbmFibGVFbCh0ZXh0SW5wdXQsIGlzTG9ja2VkKTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydHMubWFrZUFkYXB0YXRpb25DYXJkID0gUi5jdXJyeSgoaXNFZGl0YWJsZSwgZXZlbnQsIHN0b3J5TmFtZSwgY2hhcmFjdGVyTmFtZSwgb3B0cykgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNhcmQgPSBxbXRlKGAke3Jvb3R9IC5hZGFwdGF0aW9uLXRtcGxgKTtcclxuICAgICAgICBzZXRBdHRyKGNhcmQsICdkZXBlbmRlbnQtb24tY2hhcmFjdGVyJywgY2hhcmFjdGVyTmFtZSk7XHJcblxyXG4gICAgICAgIGFkZEVsKHFlZShjYXJkLCAnLmNhcmQtdGl0bGUnKSwgbWFrZVRleHQob3B0cy5jYXJkVGl0bGUpKTtcclxuICAgICAgICBjb25zdCB0ZXh0SW5wdXQgPSBxZWUoY2FyZCwgJy50ZXh0LWlucHV0Jyk7XHJcbiAgICAgICAgY29uc3QgdGltZUlucHV0ID0gcWVlKGNhcmQsICcudGltZS1pbnB1dCcpO1xyXG4gICAgICAgIGNvbnN0IGZpbmlzaGVkQnV0dG9uID0gcWVlKGNhcmQsICdidXR0b24uZmluaXNoZWQnKTtcclxuICAgICAgICBjb25zdCBpZCA9IEpTT04uc3RyaW5naWZ5KFtzdG9yeU5hbWUsIGV2ZW50LmluZGV4LCBjaGFyYWN0ZXJOYW1lXSk7XHJcblxyXG4gICAgICAgIGlmIChvcHRzLnNob3dUaW1lSW5wdXQgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgVUkucG9wdWxhdGVBZGFwdGF0aW9uVGltZUlucHV0KHRpbWVJbnB1dCwgc3RvcnlOYW1lLCBldmVudCwgY2hhcmFjdGVyTmFtZSwgaXNFZGl0YWJsZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgYWRkQ2xhc3ModGltZUlucHV0LCAnaGlkZGVuJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAob3B0cy5zaG93VGV4dElucHV0ID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24odGV4dElucHV0LCAnbm90RWRpdGFibGUnLCAhaXNFZGl0YWJsZSk7XHJcbiAgICAgICAgICAgIHRleHRJbnB1dC52YWx1ZSA9IGV2ZW50LmNoYXJhY3RlcnNbY2hhcmFjdGVyTmFtZV0udGV4dDtcclxuICAgICAgICAgICAgdGV4dElucHV0LmRhdGFLZXkgPSBKU09OLnN0cmluZ2lmeShbc3RvcnlOYW1lLCBldmVudC5pbmRleCwgY2hhcmFjdGVyTmFtZV0pO1xyXG4gICAgICAgICAgICBsaXN0ZW4odGV4dElucHV0LCAnY2hhbmdlJywgb25DaGFuZ2VBZGFwdGF0aW9uVGV4dCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgYWRkQ2xhc3ModGV4dElucHV0LCAnaGlkZGVuJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAob3B0cy5zaG93RmluaXNoZWRCdXR0b24gPT09IHRydWUpIHtcclxuICAgICAgICAgICAgY29uc3QgaXNGaW5pc2hlZCA9IGV2ZW50LmNoYXJhY3RlcnNbY2hhcmFjdGVyTmFtZV0ucmVhZHk7XHJcbiAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24oZmluaXNoZWRCdXR0b24sICdub3RFZGl0YWJsZScsICFpc0VkaXRhYmxlKTtcclxuICAgICAgICAgICAgc2V0Q2xhc3NJZihmaW5pc2hlZEJ1dHRvbiwgJ2J0bi1wcmltYXJ5JywgaXNGaW5pc2hlZCk7XHJcbiAgICAgICAgICAgIGZpbmlzaGVkQnV0dG9uLmlkID0gaWQ7XHJcbiAgICAgICAgICAgIGNvbnN0IGVuYWJsZUlucHV0cyA9ICh2YWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwodGV4dElucHV0LCAhdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwodGltZUlucHV0LCAhdmFsdWUpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBlbmFibGVJbnB1dHMoaXNGaW5pc2hlZCk7XHJcbiAgICAgICAgICAgIGxpc3RlbihmaW5pc2hlZEJ1dHRvbiwgJ2NsaWNrJywgVUkub25DaGFuZ2VBZGFwdGF0aW9uUmVhZHlTdGF0dXMyKGVuYWJsZUlucHV0cykpO1xyXG4gICAgICAgICAgICBMMTBuLmxvY2FsaXplU3RhdGljKGNhcmQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKGZpbmlzaGVkQnV0dG9uLCAnaGlkZGVuJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gY2FyZDtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBvbkNoYW5nZURhdGVUaW1lQ3JlYXRvciA9IFIuY3VycnkoKHN0b3J5TmFtZSwgbXlJbnB1dCkgPT4gKGRwLCBpbnB1dCkgPT4ge1xyXG4gICAgICAgIERCTVMuc2V0RXZlbnRPcmlnaW5Qcm9wZXJ0eShzdG9yeU5hbWUsIG15SW5wdXQuZXZlbnRJbmRleCwgJ3RpbWUnLCBpbnB1dC52YWwoKSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgIHJlbW92ZUNsYXNzKG15SW5wdXQsICdkZWZhdWx0RGF0ZScpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZnVuY3Rpb24gb25DaGFuZ2VPcmlnaW5UZXh0KGV2ZW50KSB7XHJcbiAgICAgICAgY29uc3QgZGF0YUtleSA9IEpTT04ucGFyc2UoZXZlbnQudGFyZ2V0LmRhdGFLZXkpO1xyXG4gICAgICAgIGNvbnN0IHRleHQgPSBldmVudC50YXJnZXQudmFsdWU7XHJcbiAgICAgICAgREJNUy5zZXRFdmVudE9yaWdpblByb3BlcnR5KGRhdGFLZXlbMF0sIGRhdGFLZXlbMV0sICd0ZXh0JywgdGV4dCwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG9uQ2hhbmdlQWRhcHRhdGlvblRleHQoZXZlbnQpIHtcclxuICAgICAgICBjb25zdCBkYXRhS2V5ID0gSlNPTi5wYXJzZShldmVudC50YXJnZXQuZGF0YUtleSk7XHJcbiAgICAgICAgY29uc3QgdGV4dCA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICBEQk1TLnNldEV2ZW50QWRhcHRhdGlvblByb3BlcnR5KGRhdGFLZXlbMF0sIGRhdGFLZXlbMV0sIGRhdGFLZXlbMl0sICd0ZXh0JywgdGV4dCwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldEljb25DbGFzcyhvYmplY3QpIHtcclxuICAgICAgICBpZiAob2JqZWN0LmlzRW1wdHkpIHJldHVybiAnZmEtaWNvbiBlbXB0eSBzZWxlY3QtaWNvbi1wYWRkaW5nJztcclxuICAgICAgICBpZiAob2JqZWN0LmlzRmluaXNoZWQpIHJldHVybiAnZmEtaWNvbiBmaW5pc2hlZCBzZWxlY3QtaWNvbi1wYWRkaW5nJztcclxuICAgICAgICByZXR1cm4gJ2ZhLWljb24gZmluaXNoZWQgdHJhbnNwYXJlbnQtaWNvbiBzZWxlY3QtaWNvbi1wYWRkaW5nJztcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVTZXR0aW5ncyhuYW1lLCB2YWx1ZSkge1xyXG4gICAgICAgIGNvbnN0IHNldHRpbmdzID0gREJNUy5nZXRTZXR0aW5ncygpO1xyXG4gICAgICAgIHNldHRpbmdzLkFkYXB0YXRpb25zW25hbWVdID0gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0U2VsZWN0ZWRTdG9yeU5hbWUoc3RvcnlOYW1lcykge1xyXG4gICAgICAgIGNvbnN0IHN0b3J5TmFtZXNPbmx5ID0gc3RvcnlOYW1lcy5tYXAoUi5wcm9wKCdzdG9yeU5hbWUnKSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHNldHRpbmdzID0gREJNUy5nZXRTZXR0aW5ncygpO1xyXG4gICAgICAgIGlmICghc2V0dGluZ3MuQWRhcHRhdGlvbnMpIHtcclxuICAgICAgICAgICAgc2V0dGluZ3MuQWRhcHRhdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICBzdG9yeU5hbWU6IHN0b3J5TmFtZXNPbmx5WzBdLFxyXG4gICAgICAgICAgICAgICAgY2hhcmFjdGVyTmFtZXM6IG51bGwsXHJcbiAgICAgICAgICAgICAgICBldmVudEluZGV4ZXM6IG51bGwsXHJcbiAgICAgICAgICAgICAgICBzZWxlY3RlZEZpbHRlcjogJ2FkYXB0YXRpb25GaWx0ZXJCeUNoYXJhY3RlcidcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHsgc3RvcnlOYW1lIH0gPSBzZXR0aW5ncy5BZGFwdGF0aW9ucztcclxuICAgICAgICBpZiAoc3RvcnlOYW1lc09ubHkuaW5kZXhPZihzdG9yeU5hbWUpID09PSAtMSkge1xyXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLWRlc3RydWN0dXJpbmdcclxuICAgICAgICAgICAgc2V0dGluZ3MuQWRhcHRhdGlvbnMuc3RvcnlOYW1lID0gc3RvcnlOYW1lc09ubHlbMF07XHJcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBwcmVmZXItZGVzdHJ1Y3R1cmluZ1xyXG4gICAgICAgICAgICBzdG9yeU5hbWUgPSBzdG9yeU5hbWVzT25seVswXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHN0b3J5TmFtZTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXROYW1lcyhuYW1lT2JqZWN0QXJyYXksIG5hbWVPYmplY3RQcm9wZXJ0eSwgc2V0dGluZ3NQcm9wZXJ0eSkge1xyXG4gICAgICAgIGNvbnN0IG5hbWVzT25seSA9IG5hbWVPYmplY3RBcnJheS5tYXAoUi5wcm9wKG5hbWVPYmplY3RQcm9wZXJ0eSkpO1xyXG4gICAgICAgIGNvbnN0IG5hbWVzID0gREJNUy5nZXRTZXR0aW5ncygpLkFkYXB0YXRpb25zW3NldHRpbmdzUHJvcGVydHldO1xyXG4gICAgICAgIGxldCBleGlzdGluZ05hbWVzO1xyXG4gICAgICAgIGlmIChuYW1lcyA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICBleGlzdGluZ05hbWVzID0gbmFtZXNPbmx5O1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGV4aXN0aW5nTmFtZXMgPSBuYW1lcy5maWx0ZXIobmFtZSA9PiBuYW1lc09ubHkuaW5kZXhPZihuYW1lKSAhPT0gLTEpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdXBkYXRlU2V0dGluZ3Moc2V0dGluZ3NQcm9wZXJ0eSwgZXhpc3RpbmdOYW1lcyk7XHJcbiAgICAgICAgcmV0dXJuIGV4aXN0aW5nTmFtZXM7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0Q2hhcmFjdGVyTmFtZXMoY2hhcmFjdGVyQXJyYXkpIHtcclxuICAgICAgICByZXR1cm4gZ2V0TmFtZXMoY2hhcmFjdGVyQXJyYXksICdjaGFyYWN0ZXJOYW1lJywgJ2NoYXJhY3Rlck5hbWVzJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0RXZlbnRJbmRleGVzKGV2ZW50QXJyYXkpIHtcclxuICAgICAgICByZXR1cm4gZ2V0TmFtZXMoZXZlbnRBcnJheSwgJ2luZGV4JywgJ2V2ZW50SW5kZXhlcycpO1xyXG4gICAgfVxyXG59KSh0aGlzLkFkYXB0YXRpb25zID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG4gICAgY29uc3Qgcm9vdCA9ICcuYnJpZWZpbmctZXhwb3J0LXRhYiAnO1xyXG5cclxuICAgIHN0YXRlLnRlbXBsYXRlcyA9IHt9O1xyXG4gICAgc3RhdGUuY3VzdG9tRG9jeFRlbXBsYXRlID0gbnVsbDtcclxuXHJcbiAgICBsZXQgZ2VuZXJhdGVTaW5nbGVEb2N4LCBnZW5lcmF0ZVNpbmdsZVR4dCwgcmVmcmVzaFN0b3J5U2V0U2VsZWN0LCByZWZyZXNoQ2hhcmFjdGVyU2V0U2VsZWN0O1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuLy8gICAgICAgIGxpc3RlbihnZXRFbCgnbWFrZURlZmF1bHRUZXh0QnJpZWZpbmdzJyksICdjbGljaycsICgpID0+IHtcclxuLy8gICAgICAgICAgICByZXNvbHZlVGV4dFRlbXBsYXRlKCh0ZXh0VGVtcGxhdGUpID0+IHtcclxuLy8gICAgICAgICAgICAgICAgbWFrZVRleHRCcmllZmluZ3MoJ3R4dCcsIGdlbmVyYXRlU2luZ2xlVHh0KHRleHRUZW1wbGF0ZSkpO1xyXG4vLyAgICAgICAgICAgIH0pO1xyXG4vLyAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihnZXRFbCgnbWFrZUN1c3RvbVRleHRCcmllZmluZ3MnKSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBtYWtlVGV4dEJyaWVmaW5ncyhnZXRFbCgndGV4dFR5cGVTZWxlY3RvcicpLnZhbHVlLCBnZW5lcmF0ZVNpbmdsZVR4dChnZXRFbCgndGVtcGxhdGVBcmVhJykudmFsdWUpKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBsaXN0ZW4oZ2V0RWwoJ21ha2VNYXJrZG93bkJyaWVmaW5ncycpLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIG1ha2VUZXh0QnJpZWZpbmdzKCdodG1sJywgUi5jb21wb3NlKGRhdGEgPT4gbWFya2Rvd25pdCgnY29tbW9ubWFyaycpLnJlbmRlcihkYXRhKSwgZ2VuZXJhdGVTaW5nbGVUeHQoZ2V0RWwoJ3RlbXBsYXRlQXJlYScpLnZhbHVlKSkpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBsaXN0ZW4oZ2V0RWwoJ2RvY3hCcmllZmluZ3MnKSwgJ2NoYW5nZScsIHJlYWRUZW1wbGF0ZUZpbGUpO1xyXG4gICAgICAgIGxpc3RlbihnZXRFbCgnZG9jeEJyaWVmaW5ncycpLCAnZm9jdXMnLCAoZSkgPT4ge1xyXG4gICAgICAgICAgICBlLnRhcmdldC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICBzdGF0ZS5jdXN0b21Eb2N4VGVtcGxhdGUgPSBudWxsO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBsaXN0ZW4oZ2V0RWwoJ21ha2VEb2N4QnJpZWZpbmdzJyksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgaWYgKHN0YXRlLmN1c3RvbURvY3hUZW1wbGF0ZSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbignYnJpZWZpbmdzLWN1c3RvbS1kb2N4LXRlbXBsYXRlLWlzLW1pc3NpbmcnKSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBleHBvcnREb2N4QnlUZW1wbGF0ZShzdGF0ZS5jdXN0b21Eb2N4VGVtcGxhdGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG5cclxuICAgICAgICBsZXQgZWxzID0gcXVlcnlFbEVscyhkb2N1bWVudCwgYCR7cm9vdH0gaW5wdXRbbmFtZT1leHBvcnRDaGFyYWN0ZXJTZWxlY3Rpb25dYCk7XHJcbiAgICAgICAgZWxzLm1hcChsaXN0ZW4oUi5fXywgJ2NoYW5nZScsIG9uQ2hhcmFjdGVyU2VsZWN0aW9uQ2hhbmdlKSk7XHJcbiAgICAgICAgZ2V0RWwoJ2V4cG9ydEFsbENoYXJhY3RlcnMnKS5jaGVja2VkID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgZWxzID0gcXVlcnlFbEVscyhkb2N1bWVudCwgYCR7cm9vdH0gaW5wdXRbbmFtZT1leHBvcnRTdG9yeVNlbGVjdGlvbl1gKTtcclxuICAgICAgICBlbHMubWFwKGxpc3RlbihSLl9fLCAnY2hhbmdlJywgb25TdG9yeVNlbGVjdGlvbkNoYW5nZSkpO1xyXG4gICAgICAgIGdldEVsKCdleHBvcnRBbGxTdG9yaWVzJykuY2hlY2tlZCA9IHRydWU7XHJcblxyXG4gICAgICAgIGNvbnN0IGVsID0gZ2V0RWwoJ2JyaWVmaW5nTnVtYmVyU2VsZWN0b3InKTtcclxuICAgICAgICBDb25zdGFudHMuYnJpZWZpbmdOdW1iZXIuZm9yRWFjaChSLmNvbXBvc2UoYWRkRWwoZWwpLCBtYWtlT3B0KSk7XHJcbiAgICAgICAgbGlzdGVuKGVsLCAnY2hhbmdlJywgcmVmcmVzaENoYXJhY3RlclJhbmdlU2VsZWN0KTtcclxuXHJcbiAgICAgICAgc3RhdGUuYnJpZWZpbmdOdW1iZXJTZWxlY3RvciA9IGVsO1xyXG4gICAgICAgIHN0YXRlLmJyaWVmaW5nSW50ZXJ2YWxTZWxlY3RvciA9IGdldEVsKCdicmllZmluZ0ludGVydmFsU2VsZWN0b3InKTtcclxuICAgICAgICBzdGF0ZS5jaGFyYWN0ZXJTZXRTZWxlY3RvciA9IGdldEVsKCdjaGFyYWN0ZXJTZXRTZWxlY3RvcicpO1xyXG4gICAgICAgIHN0YXRlLnN0b3J5U2V0U2VsZWN0b3IgPSBnZXRFbCgnc3RvcnlTZXRTZWxlY3RvcicpO1xyXG5cclxuICAgICAgICBnZXRFbCgnbWFrZUJyaWVmaW5nc0J5VGltZSAnLnRyaW0oKSkuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBtYWtlRXhwb3J0KCd0ZW1wbGF0ZUJ5VGltZScpKTtcclxuICAgICAgICBnZXRFbCgnbWFrZUJyaWVmaW5nc0J5U3RvcnknLnRyaW0oKSkuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBtYWtlRXhwb3J0KCd0ZW1wbGF0ZUJ5U3RvcnknKSk7XHJcbiAgICAgICAgZ2V0RWwoJ21ha2VJbnZlbnRvcnlMaXN0ICAgJy50cmltKCkpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgbWFrZUV4cG9ydCgnaW52ZW50b3J5VGVtcGxhdGUnKSk7XHJcblxyXG4gICAgICAgIFVJLmluaXRUYWJQYW5lbCgnZXhwb3J0TW9kZUJ1dHRvbicsICdleHBvcnRDb250YWluZXInKTtcclxuXHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCdwcmV2aWV3VGV4dE91dHB1dCcpLCAnY2xpY2snLCBwcmV2aWV3VGV4dE91dHB1dCk7XHJcbiAgICAgICAgZ2V0RWwoJ3RleHRCcmllZmluZ1ByZXZpZXdBcmVhJykudmFsdWUgPSAnJztcclxuXHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCdzaG93UmF3RGF0YScpLCAnY2xpY2snLCBwcmV2aWV3VGV4dERhdGFBc0lzKTtcclxuXHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCdjb252ZXJ0VG9Eb2N4VGVtcGxhdGUnKSwgJ2NsaWNrJywgY29udmVydFRvRG9jeFRlbXBsYXRlKTtcclxuICAgICAgICBsaXN0ZW4oZ2V0RWwoJ2dlbmVyYXRlQnlEb2N4VGVtcGxhdGUnKSwgJ2NsaWNrJywgZ2VuZXJhdGVCeURvY3hUZW1wbGF0ZSk7XHJcblxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICByZXNvbHZlVGV4dFRlbXBsYXRlKCh0ZXh0VGVtcGxhdGUpID0+IHtcclxuICAgICAgICAgICAgZ2V0RWwoJ3RlbXBsYXRlQXJlYScpLnZhbHVlID0gdGV4dFRlbXBsYXRlO1xyXG4gICAgICAgICAgICByZWZyZXNoQ2hhcmFjdGVyUmFuZ2VTZWxlY3QoKTtcclxuICAgICAgICAgICAgcmVmcmVzaENoYXJhY3RlclNldFNlbGVjdCgpO1xyXG4gICAgICAgICAgICByZWZyZXNoU3RvcnlTZXRTZWxlY3QoKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gcmVzb2x2ZVRleHRUZW1wbGF0ZShjYWxsYmFjaykge1xyXG4gICAgICAgIERCTVMuZ2V0UHJvZmlsZVN0cnVjdHVyZSgnY2hhcmFjdGVyJywgKGVyciwgcHJvZmlsZVNldHRpbmdzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIGNvbnN0IGZ1bmMgPSBSLmNvbXBvc2UoUi5qb2luKCcnKSwgUi5pbnNlcnQoMSwgUi5fXywgWyd7e3Byb2ZpbGVJbmZvLScsICd9fVxcbiddKSwgUi5wcm9wKCduYW1lJykpO1xyXG4gICAgICAgICAgICBjb25zdCBmaWx0ZXIgPSBSLmNvbXBvc2UoUi5lcXVhbHModHJ1ZSksIFIucHJvcCgnZG9FeHBvcnQnKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gcHJvZmlsZVNldHRpbmdzLmZpbHRlcihmaWx0ZXIpLm1hcChmdW5jKS5qb2luKCcnKTtcclxuXHJcbiAgICAgICAgICAgIGNhbGxiYWNrKFIucmVwbGFjZSgvXFx7MFxcfS9nLCB2YWx1ZSwgVEVYVF9URU1QTEFURSkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG9uQ2hhcmFjdGVyU2VsZWN0aW9uQ2hhbmdlKGV2ZW50KSB7XHJcbiAgICAgICAgY29uc3QgZXhwb3J0Q2hhcmFjdGVyUmFuZ2UgPSBldmVudC50YXJnZXQuaWQgPT09ICdleHBvcnRDaGFyYWN0ZXJSYW5nZSc7XHJcbiAgICAgICAgY29uc3QgZXhwb3J0Q2hhcmFjdGVyU2V0ID0gZXZlbnQudGFyZ2V0LmlkID09PSAnZXhwb3J0Q2hhcmFjdGVyU2V0JztcclxuICAgICAgICBoaWRlRWwoZ2V0RWwoJ2NoYXJhY3RlclJhbmdlU2VsZWN0JyksICFleHBvcnRDaGFyYWN0ZXJSYW5nZSk7XHJcbiAgICAgICAgaGlkZUVsKGdldEVsKCdjaGFyYWN0ZXJTZXRTZWxlY3QnKSwgIWV4cG9ydENoYXJhY3RlclNldCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25TdG9yeVNlbGVjdGlvbkNoYW5nZShldmVudCkge1xyXG4gICAgICAgIGNvbnN0IGV4cG9ydFN0b3J5U2V0ID0gZXZlbnQudGFyZ2V0LmlkID09PSAnZXhwb3J0U3RvcnlTZXQnO1xyXG4gICAgICAgIGhpZGVFbChnZXRFbCgnc3RvcnlTZXRTZWxlY3QnKSwgIWV4cG9ydFN0b3J5U2V0KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRTZWxlY3RlZFVzZXJzKCkge1xyXG4gICAgICAgIGNvbnN0IHsgaWQgfSA9IGdldFNlbGVjdGVkUmFkaW8ocWUocm9vdCksICdpbnB1dFtuYW1lPWV4cG9ydENoYXJhY3RlclNlbGVjdGlvbl0nKTtcclxuICAgICAgICBzd2l0Y2ggKGlkKSB7XHJcbiAgICAgICAgY2FzZSAnZXhwb3J0QWxsQ2hhcmFjdGVycyc6XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIGNhc2UgJ2V4cG9ydENoYXJhY3RlclJhbmdlJzpcclxuICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2Uoc3RhdGUuYnJpZWZpbmdJbnRlcnZhbFNlbGVjdG9yLnNlbGVjdGVkT3B0aW9uc1swXS52YWx1ZSk7XHJcbiAgICAgICAgY2FzZSAnZXhwb3J0Q2hhcmFjdGVyU2V0JzpcclxuICAgICAgICAgICAgcmV0dXJuIG5sMmFycmF5KHN0YXRlLmNoYXJhY3RlclNldFNlbGVjdG9yLnNlbGVjdGVkT3B0aW9ucykubWFwKG9wdCA9PiBvcHQudmFsdWUpO1xyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGB1bmV4cGVjdGVkIGlkOiAke2lkfWApO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRTZWxlY3RlZFN0b3JpZXMoKSB7XHJcbiAgICAgICAgY29uc3QgeyBpZCB9ID0gZ2V0U2VsZWN0ZWRSYWRpbyhxZShyb290KSwgJ2lucHV0W25hbWU9ZXhwb3J0U3RvcnlTZWxlY3Rpb25dJyk7XHJcbiAgICAgICAgc3dpdGNoIChpZCkge1xyXG4gICAgICAgIGNhc2UgJ2V4cG9ydEFsbFN0b3JpZXMnOlxyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICBjYXNlICdleHBvcnRTdG9yeVNldCc6XHJcbiAgICAgICAgICAgIHJldHVybiBubDJhcnJheShzdGF0ZS5zdG9yeVNldFNlbGVjdG9yLnNlbGVjdGVkT3B0aW9ucykubWFwKG9wdCA9PiBvcHQudmFsdWUpO1xyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGB1bmV4cGVjdGVkIGlkOiAke2lkfWApO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZWZyZXNoQ2hhcmFjdGVyUmFuZ2VTZWxlY3QoKSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZWN0b3IgPSBjbGVhckVsKHN0YXRlLmJyaWVmaW5nSW50ZXJ2YWxTZWxlY3Rvcik7XHJcbiAgICAgICAgY29uc3QgbnVtID0gTnVtYmVyKHN0YXRlLmJyaWVmaW5nTnVtYmVyU2VsZWN0b3IudmFsdWUpO1xyXG5cclxuICAgICAgICBsZXQgY2h1bmtzO1xyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdjaGFyYWN0ZXInLCBmYWxzZSwgKGVyciwgbmFtZXMpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgaWYgKG5hbWVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGNodW5rcyA9IFIuc3BsaXRFdmVyeShudW0sIG5hbWVzKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBjaHVua3MubWFwKGNodW5rID0+ICh7XHJcbiAgICAgICAgICAgICAgICAgICAgaWQ6IEpTT04uc3RyaW5naWZ5KGNodW5rLm1hcChuYW1lSW5mbyA9PiBuYW1lSW5mby52YWx1ZSkpLFxyXG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IGNodW5rLmxlbmd0aCA9PT0gMSA/IGNodW5rWzBdLmRpc3BsYXlOYW1lIDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgYCR7Y2h1bmtbMF0uZGlzcGxheU5hbWV9IC0gJHtjaHVua1tjaHVuay5sZW5ndGggLSAxXS5kaXNwbGF5TmFtZX1gXHJcbiAgICAgICAgICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgICAgICAgICAgJChgIyR7c3RhdGUuYnJpZWZpbmdJbnRlcnZhbFNlbGVjdG9yLmlkfWApLnNlbGVjdDIoeyBkYXRhIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGZ1bmN0aW9uIHJlZnJlc2hTZXRTZWxlY3QoZW50aXR5VHlwZSwgc2VsZWN0b3JOYW1lKSB7XHJcbiAgICAgICAgY29uc3QgbXVsdGlTZWwgPSBjbGVhckVsKHN0YXRlW3NlbGVjdG9yTmFtZV0pO1xyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KGVudGl0eVR5cGUsIGZhbHNlLCAoZXJyLCBuYW1lcykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBpZiAobmFtZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgZmlsbFNlbGVjdG9yKG11bHRpU2VsLCBuYW1lcy5tYXAocmVtYXBQcm9wczRTZWxlY3QpKTtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIobXVsdGlTZWwsICdzaXplJywgbmFtZXMubGVuZ3RoID4gMTUgPyAxNSA6IG5hbWVzLmxlbmd0aCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICByZWZyZXNoU3RvcnlTZXRTZWxlY3QgPSAoKSA9PiByZWZyZXNoU2V0U2VsZWN0KCdzdG9yeScsICdzdG9yeVNldFNlbGVjdG9yJyk7XHJcbiAgICByZWZyZXNoQ2hhcmFjdGVyU2V0U2VsZWN0ID0gKCkgPT4gcmVmcmVzaFNldFNlbGVjdCgnY2hhcmFjdGVyJywgJ2NoYXJhY3RlclNldFNlbGVjdG9yJyk7XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUV4cG9ydCh0eXBlKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgaWYgKCFzdGF0ZS50ZW1wbGF0ZXNbdHlwZV0pIHtcclxuICAgICAgICAgICAgICAgIHN0YXRlLnRlbXBsYXRlc1t0eXBlXSA9IGF0b2IodGVtcGxhdGVzQXJyW3R5cGVdKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBleHBvcnREb2N4QnlUZW1wbGF0ZShzdGF0ZS50ZW1wbGF0ZXNbdHlwZV0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcG9zdHByb2Nlc3NDaGVja2JveGVzKGJyaWVmaW5nRGF0YSwgcHJvZmlsZVN0cnVjdHVyZSwgcHJlZml4LCBhcnJOYW1lKSB7XHJcbiAgICAgICAgY29uc3QgY2hlY2tib3hOYW1lcyA9IHByb2ZpbGVTdHJ1Y3R1cmUuZmlsdGVyKGl0ZW0gPT4gaXRlbS50eXBlID09PSAnY2hlY2tib3gnKS5tYXAoUi5wcm9wKCduYW1lJykpO1xyXG4gICAgICAgIGJyaWVmaW5nRGF0YS5icmllZmluZ3MuZm9yRWFjaCgoY2hhckRhdGEpID0+IHtcclxuICAgICAgICAgICAgaWYgKGNoYXJEYXRhW2Fyck5hbWVdID09PSB1bmRlZmluZWQpIHJldHVybjtcclxuICAgICAgICAgICAgY2hhckRhdGFbYXJyTmFtZV0uZm9yRWFjaCgoZWxlbWVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNoZWNrYm94TmFtZXMuaW5kZXhPZihlbGVtZW50Lml0ZW1OYW1lKSAhPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gY29uc3RMMTBuKENvbnN0YW50c1tlbGVtZW50LnZhbHVlXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zcGxpdHRlZFRleHQgPSBbeyBzdHJpbmc6IGVsZW1lbnQudmFsdWUgfV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBjaGVja2JveE5hbWVzLmZvckVhY2goKG5hbWUpID0+IHtcclxuICAgICAgICAgICAgICAgIGNoYXJEYXRhW3ByZWZpeCArIG5hbWVdID0gY29uc3RMMTBuKENvbnN0YW50c1tjaGFyRGF0YVtwcmVmaXggKyBuYW1lXV0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRCcmllZmluZ0RhdGEoY2FsbGJhY2spIHtcclxuICAgICAgICBEQk1TLmdldEJyaWVmaW5nRGF0YShnZXRTZWxlY3RlZFVzZXJzKCksIGdldFNlbGVjdGVkU3RvcmllcygpLCBnZXRFbCgnZXhwb3J0T25seUZpbmlzaGVkU3RvcmllcycpLmNoZWNrZWQsIChlcnIsIGJyaWVmaW5nRGF0YSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAvLyBzb21lIHBvc3Rwcm9jZXNzaW5nXHJcbiAgICAgICAgICAgIERCTVMuZ2V0UHJvZmlsZVN0cnVjdHVyZSgnY2hhcmFjdGVyJywgKGVycjIsIGNoYXJhY3RlclByb2ZpbGVTdHJ1Y3R1cmUpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0UHJvZmlsZVN0cnVjdHVyZSgncGxheWVyJywgKGVycjMsIHBsYXllclByb2ZpbGVTdHJ1Y3R1cmUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgcG9zdHByb2Nlc3NDaGVja2JveGVzKGJyaWVmaW5nRGF0YSwgY2hhcmFjdGVyUHJvZmlsZVN0cnVjdHVyZSwgJ3Byb2ZpbGVJbmZvLScsICdwcm9maWxlSW5mb0FycmF5Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcG9zdHByb2Nlc3NDaGVja2JveGVzKGJyaWVmaW5nRGF0YSwgcGxheWVyUHJvZmlsZVN0cnVjdHVyZSwgJ3BsYXllckluZm8tJywgJ3BsYXllckluZm9BcnJheScpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGJyaWVmaW5nRGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZXhwb3J0RG9jeEJ5VGVtcGxhdGUodGVtcGxhdGUpIHtcclxuICAgICAgICBnZXRCcmllZmluZ0RhdGEoKGVyciwgYnJpZWZpbmdEYXRhKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIGdlbmVyYXRlQnJpZWZpbmdzKGJyaWVmaW5nRGF0YSwgJ2RvY3gnLCBnZW5lcmF0ZVNpbmdsZURvY3goJ2Jsb2InLCB0ZW1wbGF0ZSksIGdlbmVyYXRlU2luZ2xlRG9jeCgnVWludDhBcnJheScsIHRlbXBsYXRlKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY29udmVydFRvRG9jeFRlbXBsYXRlKCkge1xyXG4gICAgICAgIGNvbnN0IGRvY3hUZW1wbGF0ZSA9IG1ha2VEb2N4VGVtcGxhdGUoJ2Jsb2InKTtcclxuICAgICAgICBVdGlscy5jb25maXJtKGdldEwxMG4oJ2JyaWVmaW5ncy1zYXZlLWZpbGUnKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICBzYXZlQXMoZG9jeFRlbXBsYXRlLCBGaWxlVXRpbHMubWFrZUZpbGVOYW1lKCd0ZW1wbGF0ZScsICdkb2N4JykpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdlbmVyYXRlQnlEb2N4VGVtcGxhdGUoKSB7XHJcbiAgICAgICAgZXhwb3J0RG9jeEJ5VGVtcGxhdGUobWFrZURvY3hUZW1wbGF0ZSgnVWludDhBcnJheScpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlRG9jeFRlbXBsYXRlKHR5cGUpIHtcclxuICAgICAgICBsZXQgdGVtcGxhdGUgPSBnZXRFbCgndGVtcGxhdGVBcmVhJykudmFsdWU7XHJcblxyXG4gICAgICAgIGNvbnN0IHJlcGxhY2VCcmFja2V0cyA9IFIucGlwZShSLnJlcGxhY2UoL3t7ey9nLCAneycpLCBSLnJlcGxhY2UoL319fS9nLCAnfScpLCBSLnJlcGxhY2UoL3t7L2csICd7JyksIFIucmVwbGFjZSgvfX0vZywgJ30nKSk7XHJcbiAgICAgICAgdGVtcGxhdGUgPSByZXBsYWNlQnJhY2tldHModGVtcGxhdGUpLnNwbGl0KCdcXG4nKS5tYXAoc3RyaW5nID0+ICh7IHN0cmluZyB9KSk7XHJcblxyXG4gICAgICAgIGlmICghc3RhdGUudGVtcGxhdGVzLmdlbmVyaWNUZW1wbGF0ZSkge1xyXG4gICAgICAgICAgICBzdGF0ZS50ZW1wbGF0ZXMuZ2VuZXJpY1RlbXBsYXRlID0gYXRvYih0ZW1wbGF0ZXNBcnIuZ2VuZXJpY1RlbXBsYXRlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGRvYyA9IG5ldyB3aW5kb3cuRG9jeGdlbihzdGF0ZS50ZW1wbGF0ZXMuZ2VuZXJpY1RlbXBsYXRlKTtcclxuICAgICAgICBkb2Muc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIHNwbGl0dGVkVGV4dDogdGVtcGxhdGVcclxuICAgICAgICB9KTtcclxuICAgICAgICBkb2MucmVuZGVyKCk7XHJcbiAgICAgICAgcmV0dXJuIGRvYy5nZXRaaXAoKS5nZW5lcmF0ZSh7XHJcbiAgICAgICAgICAgIHR5cGVcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIHByZXZpZXdUZXh0RGF0YUFzSXMoKSB7XHJcbiAgICAgICAgZ2V0QnJpZWZpbmdEYXRhKChlcnIsIGJyaWVmaW5nRGF0YSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBnZXRFbCgndGV4dEJyaWVmaW5nUHJldmlld0FyZWEnKS52YWx1ZSA9IEpTT04uc3RyaW5naWZ5KGJyaWVmaW5nRGF0YSwgbnVsbCwgJyAgJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcHJldmlld1RleHRPdXRwdXQoKSB7XHJcbiAgICAgICAgZ2V0QnJpZWZpbmdEYXRhKChlcnIsIGRhdGEpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgZ2V0RWwoJ3RleHRCcmllZmluZ1ByZXZpZXdBcmVhJykudmFsdWUgPSBnZW5lcmF0ZVNpbmdsZVR4dChnZXRFbCgndGVtcGxhdGVBcmVhJykudmFsdWUsIGRhdGEpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VUZXh0QnJpZWZpbmdzKGZpbGVUeXBlLCBkZWxlZ2F0ZSkge1xyXG4gICAgICAgIGdldEJyaWVmaW5nRGF0YSgoZXJyLCBicmllZmluZ0RhdGEpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgZ2VuZXJhdGVCcmllZmluZ3MoYnJpZWZpbmdEYXRhLCBmaWxlVHlwZSwgKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGRlbGVnYXRlKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBCbG9iKFtyZXN1bHRdLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3RleHQvcGxhaW47Y2hhcnNldD11dGYtOCdcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9LCBkZWxlZ2F0ZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVhZFRlbXBsYXRlRmlsZShldnQpIHtcclxuICAgICAgICAvLyBSZXRyaWV2ZSB0aGUgZmlyc3QgKGFuZCBvbmx5ISkgRmlsZSBmcm9tIHRoZSBGaWxlTGlzdCBvYmplY3RcclxuICAgICAgICBjb25zdCBmID0gZXZ0LnRhcmdldC5maWxlc1swXTtcclxuXHJcbiAgICAgICAgaWYgKGYpIHtcclxuICAgICAgICAgICAgY29uc3QgciA9IG5ldyBGaWxlUmVhZGVyKCk7XHJcbiAgICAgICAgICAgIHIub25sb2FkID0gKGUpID0+IHtcclxuICAgICAgICAgICAgICAgIHN0YXRlLmN1c3RvbURvY3hUZW1wbGF0ZSA9IGUudGFyZ2V0LnJlc3VsdDtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ2JyaWVmaW5ncy10ZW1wbGF0ZS1pcy1sb2FkZWQnKSk7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHIucmVhZEFzQmluYXJ5U3RyaW5nKGYpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ2JyaWVmaW5ncy1lcnJvci1vbi10ZW1wbGF0ZS11cGxvYWRpbmcnKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZVN0YXR1cyh0ZXh0KSB7XHJcbiAgICAgICAgY29uc3QgZXhwb3J0U3RhdHVzID0gZ2V0RWwoJ2V4cG9ydFN0YXR1cycpO1xyXG4gICAgICAgIGNsZWFyRWwoZXhwb3J0U3RhdHVzKTtcclxuICAgICAgICBleHBvcnRTdGF0dXMuYXBwZW5kQ2hpbGQobWFrZVRleHQodGV4dCkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdlbmVyYXRlQnJpZWZpbmdzKGJyaWVmaW5nRGF0YSwgZmlsZVR5cGUsIG9uZUZpbGVEZWxlZ2F0ZSwgc2VwYXJhdGVGaWxlRGVsZWdhdGUpIHtcclxuICAgICAgICBjb25zdCB0b1NlcGFyYXRlRmlsZXMgPSBnZXRFbCgndG9TZXBhcmF0ZUZpbGVDaGVja2JveCcpLmNoZWNrZWQ7XHJcblxyXG4gICAgICAgIGNvbnN0IGZpbGVOYW1lID0gJ2NoYXJhY3RlclNoZWV0cyc7XHJcblxyXG4gICAgICAgIGxldCBvdXQsIGFyY2hpdmU7XHJcbiAgICAgICAgdXBkYXRlU3RhdHVzKGdldEwxMG4oJ2JyaWVmaW5ncy1zYXZlLXByZXBhcmluZycpKTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBpZiAodG9TZXBhcmF0ZUZpbGVzKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB6aXAgPSBuZXcgSlNaaXAoKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSB6aXAuZ2VuZXJhdGUoKTtcclxuICAgICAgICAgICAgICAgIHVwZGF0ZVN0YXR1cyhnZXRMMTBuKCdicmllZmluZ3Mtc3RhcnQtc2F2aW5nJykpO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlcyA9IG1ha2VBcmNoaXZlRGF0YShicmllZmluZ0RhdGEsIHNlcGFyYXRlRmlsZURlbGVnYXRlKTtcclxuICAgICAgICAgICAgICAgIFIua2V5cyhyZXMpLmZvckVhY2goKGtleSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHppcC5maWxlKGAke2tleX0uJHtmaWxlVHlwZX1gLCByZXNba2V5XSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICB1cGRhdGVTdGF0dXMoZ2V0TDEwbignYnJpZWZpbmdzLWFyY2hpdmluZycpKTtcclxuICAgICAgICAgICAgICAgIGFyY2hpdmUgPSB6aXAuZ2VuZXJhdGUoeyB0eXBlOiAnYmxvYicgfSk7XHJcbiAgICAgICAgICAgICAgICB1cGRhdGVTdGF0dXMoZ2V0TDEwbignYnJpZWZpbmdzLWFyY2hpdmUtaXMtcmVhZHknKSk7XHJcbiAgICAgICAgICAgICAgICBzYXZlRmlsZSgnYnJpZWZpbmdzLXNhdmUtYXJjaGl2ZScsIGFyY2hpdmUsIGZpbGVOYW1lLCAnemlwJyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB1cGRhdGVTdGF0dXMoZ2V0TDEwbignYnJpZWZpbmdzLXN0YXJ0LXNhdmluZycpKTtcclxuICAgICAgICAgICAgICAgIG91dCA9IG9uZUZpbGVEZWxlZ2F0ZShicmllZmluZ0RhdGEpO1xyXG4gICAgICAgICAgICAgICAgdXBkYXRlU3RhdHVzKGdldEwxMG4oJ2JyaWVmaW5ncy1maWxlLWlzLXJlYWR5JykpO1xyXG4gICAgICAgICAgICAgICAgc2F2ZUZpbGUoJ2JyaWVmaW5ncy1zYXZlLWZpbGUnLCBvdXQsIGZpbGVOYW1lLCBmaWxlVHlwZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbignYnJpZWZpbmdzLWVycm9yLW9uLWdlbmVyYXRpbmctYnJpZWZpbmdzJykpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzYXZlRmlsZShtc2dLZXksIG91dCwgZmlsZU5hbWUsIGV4dGVuc2lvbikge1xyXG4gICAgICAgIFV0aWxzLmNvbmZpcm0oZ2V0TDEwbihtc2dLZXkpLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHNhdmVBcyhvdXQsIEZpbGVVdGlscy5tYWtlRmlsZU5hbWUoZmlsZU5hbWUsIGV4dGVuc2lvbikpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VBcmNoaXZlRGF0YShicmllZmluZ0RhdGEsIGdlbmVyYXRlU2luZ2xlRGVsZWdhdGUpIHtcclxuICAgICAgICBjb25zdCByZXMgPSB7fTtcclxuICAgICAgICBicmllZmluZ0RhdGEuYnJpZWZpbmdzLmZvckVhY2goKGJyaWVmaW5nLCBpKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBicmllZmluZy5jaGFyTmFtZSArIChicmllZmluZy5wbGF5ZXJOYW1lID8gYF8ke2JyaWVmaW5nLnBsYXllck5hbWV9YCA6ICcnKVxyXG4gICAgICAgICAgICByZXNbbmFtZV0gPSBnZW5lcmF0ZVNpbmdsZURlbGVnYXRlKHtcclxuICAgICAgICAgICAgICAgIGdhbWVOYW1lOiBicmllZmluZ0RhdGEuZ2FtZU5hbWUsXHJcbiAgICAgICAgICAgICAgICBicmllZmluZ3M6IFticmllZmluZ11cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHVwZGF0ZVN0YXR1cyhzdHJGb3JtYXQoZ2V0TDEwbignYnJpZWZpbmdzLXNhdmUtc3RhdHVzJyksIFtpICsgMSwgYnJpZWZpbmdEYXRhLmJyaWVmaW5ncy5sZW5ndGhdKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHJlcztcclxuICAgIH1cclxuXHJcbiAgICBnZW5lcmF0ZVNpbmdsZURvY3ggPSBSLmN1cnJ5KCh0eXBlLCB0ZW1wbGF0ZSwgZGF0YSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRvYyA9IG5ldyB3aW5kb3cuRG9jeGdlbih0ZW1wbGF0ZSk7XHJcbiAgICAgICAgZG9jLnNldERhdGEoZGF0YSk7XHJcbiAgICAgICAgZG9jLnJlbmRlcigpOyAvLyBhcHBseSB0aGVtIChyZXBsYWNlIGFsbCBvY2N1cmVuY2VzIG9mIHtmaXJzdF9uYW1lfSBieVxyXG4gICAgICAgIC8vIEhpcHAsIC4uLilcclxuICAgICAgICBjb25zdCBvdXQgPSBkb2MuZ2V0WmlwKCkuZ2VuZXJhdGUoe1xyXG4gICAgICAgICAgICB0eXBlXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIG91dDtcclxuICAgIH0pO1xyXG5cclxuICAgIGdlbmVyYXRlU2luZ2xlVHh0ID0gUi5jdXJyeSgodGVtcGxhdGUsIGRhdGEpID0+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICByZXR1cm4gTXVzdGFjaGUucmVuZGVyKHRlbXBsYXRlLCBkYXRhKTtcclxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgVXRpbHMuYWxlcnQoc3RyRm9ybWF0KGdldEwxMG4oJ2JyaWVmaW5ncy10ZW1wbGF0ZS1lcnJvcicpLCBbZXJyLm1lc3NhZ2VdKSk7XHJcbiAgICAgICAgICAgIHRocm93IGVycjtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufSkodGhpcy5CcmllZmluZ0V4cG9ydCA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuICAgIGNvbnN0IHJvb3QgPSAnI2JyaWVmaW5nUHJldmlld0RpdiAnO1xyXG4gICAgY29uc3Qgc2V0dGluZ3NQYXRoID0gJ0JyaWVmaW5nUHJldmlldyc7XHJcbiAgICBjb25zdCBsMTBuID0gTDEwbi5nZXQoJ2JyaWVmaW5ncycpO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICAkKCcjYnJpZWZpbmdDaGFyYWN0ZXInKS5zZWxlY3QyKCkub24oJ2NoYW5nZScsIGJ1aWxkQ29udGVudERlbGVnYXRlKTtcclxuXHJcbiAgICAgICAgbGV0IGJ1dHRvbiA9IGdldEVsKCdldmVudEdyb3VwaW5nQnlTdG9yeVJhZGlvJyk7XHJcbiAgICAgICAgbGlzdGVuKGJ1dHRvbiwgJ2NoYW5nZScsIGV4cG9ydHMucmVmcmVzaCk7XHJcbiAgICAgICAgYnV0dG9uLmNoZWNrZWQgPSB0cnVlO1xyXG5cclxuICAgICAgICBidXR0b24gPSBnZXRFbCgnYWRhcHRhdGlvbnNNb2RlUmFkaW8nKTtcclxuICAgICAgICBsaXN0ZW4oYnV0dG9uLCAnY2hhbmdlJywgZXhwb3J0cy5yZWZyZXNoKTtcclxuICAgICAgICBidXR0b24uY2hlY2tlZCA9IHRydWU7XHJcblxyXG4gICAgICAgIGxpc3RlbihnZXRFbCgnZXZlbnRHcm91cGluZ0J5VGltZVJhZGlvJyksICdjaGFuZ2UnLCBleHBvcnRzLnJlZnJlc2gpO1xyXG4gICAgICAgIGxpc3RlbihnZXRFbCgncHJvb2ZyZWFkaW5nTW9kZVJhZGlvJyksICdjaGFuZ2UnLCBleHBvcnRzLnJlZnJlc2gpO1xyXG4gICAgICAgIGxpc3RlbihnZXRFbCgnaGlkZUFsbFBhbmVsc0NoZWNrYm94JyksICdjaGFuZ2UnLCBleHBvcnRzLnJlZnJlc2gpO1xyXG4gICAgICAgIGxpc3RlbihnZXRFbCgnZGlzYWJsZUhlYWRlcnNDaGVja2JveCcpLCAnY2hhbmdlJywgZXhwb3J0cy5yZWZyZXNoKTtcclxuXHJcbiAgICAgICAgZ2V0RWwoJ2hpZGVBbGxQYW5lbHNDaGVja2JveCcpLmNoZWNrZWQgPSB0cnVlO1xyXG4gICAgICAgIFxyXG4vLyAgICAgICAgbGlzdGVuKGdldEVsKCdjb250ZW50QXJlYScpLCAnc2Nyb2xsJywgdXBkYXRlR3V0dGVyU2Nyb2xsUG9zKTtcclxuLy8gICAgICAgIGxpc3RlbihnZXRFbCgnY29udGVudEFyZWEnKSwgJ3Jlc2l6ZScsIHJlYnVpbGRHdXR0ZXIpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGluaXRQYW5lbHNBcnIoKTtcclxuXHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gZ2V0RWwoJ2JyaWVmaW5nUHJldmlld0RpdicpO1xyXG4gICAgfTtcclxuICAgIFxyXG4vLyAgICBmdW5jdGlvbiB1cGRhdGVHdXR0ZXJTY3JvbGxQb3MgKCl7XHJcbi8vICAgICAgICBsZXQgZG9jID0gZ2V0RWwoJ2NvbnRlbnRBcmVhJyk7XHJcbi8vICAgICAgICBsZXQgcG9zaXRpb24gPSBxZShgJHtyb290fSAuZ3V0dGVyLXNjcm9sbC1wb3NpdGlvbmApO1xyXG4vLyAgICAgICAgcG9zaXRpb24uc3R5bGUudG9wID0gKGRvYy5zY3JvbGxUb3ApL2RvYy5zY3JvbGxIZWlnaHQqMTAwICsgJyUnO1xyXG4vLyAgICAgICAgcG9zaXRpb24uc3R5bGUuaGVpZ2h0ID0gKGRvYy5jbGllbnRIZWlnaHQpL2RvYy5zY3JvbGxIZWlnaHQqMTAwICsgJyUnO1xyXG4vLyAgICB9XHJcbi8vICAgIFxyXG4vLyAgICBmdW5jdGlvbiByZWJ1aWxkR3V0dGVyKCkge1xyXG4vLyAgICAgICAgbGV0IGRvYyA9IGdldEVsKCdjb250ZW50QXJlYScpO1xyXG4vLyAgICAgICAgY29uc3QgZ3V0dGVyID0gY2xlYXJFbChxZShgJHtyb290fSAuZ3V0dGVyYCkpO1xyXG4vLyAgICAgICAgY29uc3Qgc2Nyb2xsUG9zID0gYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ2d1dHRlci1zY3JvbGwtcG9zaXRpb24nKTtcclxuLy8gICAgICAgIGFkZEVsKGd1dHRlciwgc2Nyb2xsUG9zKTtcclxuLy8gICAgICAgIHVwZGF0ZUd1dHRlclNjcm9sbFBvcygpO1xyXG4vLyAgICAgICAgXHJcbi8vICAgICAgICBjb25zdCBidG4gPSBtYWtlRWwoJ2J1dHRvbicpO1xyXG4vLyAgICAgICAgYnRuLnN0eWxlLnRvcCA9ICcwJSc7XHJcbi8vLy8gICAgICAgIGNvbnN0IHRpdGxlID0gcWVlKHBhbmVsLCAnLnBhbmVsLXRpdGxlJykuaW5uZXJIVE1MLnRyaW0oKTtcclxuLy8gICAgICAgIHNldEF0dHIoYnRuLCAndGl0bGUnLCBsMTBuKCd0by1wYWdlLXRvcCcpKTtcclxuLy8gICAgICAgIGxpc3RlbihidG4sICdjbGljaycsICgpID0+IHtcclxuLy8gICAgICAgICAgICBkb2Muc2Nyb2xsVG9wID0gMDtcclxuLy8vLyAgICAgICAgICAgIHBhbmVsLnNjcm9sbEludG9WaWV3KCk7XHJcbi8vICAgICAgICB9KTtcclxuLy8gICAgICAgIGFkZEVsKGd1dHRlciwgYnRuKTtcclxuLy8gICAgICAgIFxyXG4vLyAgICAgICAgY29uc3QgcGFuZWxzID0gcWVlcyhkb2MsICcjYnJpZWZpbmdDb250ZW50ID4gLnBhbmVsJyk7XHJcbi8vICAgICAgICBhZGRFbHMoZ3V0dGVyLCBwYW5lbHMubWFwKHBhbmVsID0+IHtcclxuLy8gICAgICAgICAgICBjb25zdCBidG4gPSBtYWtlRWwoJ2J1dHRvbicpO1xyXG4vLyAgICAgICAgICAgIGJ0bi5zdHlsZS50b3AgPSAocGFuZWwub2Zmc2V0VG9wKS9kb2Muc2Nyb2xsSGVpZ2h0KjEwMCArICclJztcclxuLy8gICAgICAgICAgICBcclxuLy8gICAgICAgICAgICBjb25zdCBwYW5lbFRpdGxlID0gcWVlKHBhbmVsLCAnLnBhbmVsLXRpdGxlJyk7XHJcbi8vICAgICAgICAgICAgY29uc3QgdGl0bGUgPSBwYW5lbFRpdGxlLmlubmVyVGV4dCB8fCBwYW5lbFRpdGxlLnRleHRDb250ZW50O1xyXG4vLyAgICAgICAgICAgIHNldEF0dHIoYnRuLCAndGl0bGUnLCB0aXRsZSk7XHJcbi8vICAgICAgICAgICAgbGlzdGVuKGJ0biwgJ2NsaWNrJywgKCkgPT4ge1xyXG4vLyAgICAgICAgICAgICAgICBkb2Muc2Nyb2xsVG9wID0gcGFuZWwub2Zmc2V0VG9wIC0gNDA7XHJcbi8vLy8gICAgICAgICAgICAgICAgcGFuZWwuc2Nyb2xsSW50b1ZpZXcoKTtcclxuLy8gICAgICAgICAgICB9KTtcclxuLy8gICAgICAgICAgICByZXR1cm4gYnRuO1xyXG4vLyAgICAgICAgfSkpO1xyXG4vLyAgICAgICAgXHJcbi8vICAgIH1cclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgY2xlYXJFbChnZXRFbCgnYnJpZWZpbmdDaGFyYWN0ZXInKSk7XHJcbiAgICAgICAgY2xlYXJFbChnZXRFbCgnYnJpZWZpbmdDb250ZW50JykpO1xyXG5cclxuICAgICAgICBEQk1TLmdldFByb2ZpbGVTdHJ1Y3R1cmUoJ2NoYXJhY3RlcicsIChlcnIsIGNoYXJhY3RlclByb2ZpbGVTdHJ1Y3R1cmUpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgREJNUy5nZXRQcm9maWxlU3RydWN0dXJlKCdwbGF5ZXInLCAoZXJyMiwgcGxheWVyUHJvZmlsZVN0cnVjdHVyZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgc3RhdGUuY2hhcmFjdGVyUHJvZmlsZVN0cnVjdHVyZSA9IGNoYXJhY3RlclByb2ZpbGVTdHJ1Y3R1cmU7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5wbGF5ZXJQcm9maWxlU3RydWN0dXJlID0gcGxheWVyUHJvZmlsZVN0cnVjdHVyZTtcclxuICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdjaGFyYWN0ZXInLCBmYWxzZSwgKGVycjMsIG5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycjMpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMyk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fSAuYWxlcnRgKSwgbmFtZXMubGVuZ3RoID09PSAwKTtcclxuICAgICAgICAgICAgICAgICAgICBzaG93RWwocWUoYCR7cm9vdH0gPiBkaXYgPiBkaXYgPiAucGFuZWxgKSwgbmFtZXMubGVuZ3RoICE9PSAwKTtcclxuICAgICAgICAgICAgICAgICAgICBzaG93RWwocWUoYCR7cm9vdH0gI2JyaWVmaW5nQ2hhcmFjdGVyYCksIG5hbWVzLmxlbmd0aCAhPT0gMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5hbWVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hhcmFjdGVyTmFtZSA9IFVJLmNoZWNrQW5kR2V0RW50aXR5U2V0dGluZyhzZXR0aW5nc1BhdGgsIG5hbWVzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IGdldFNlbGVjdDJEYXRhKG5hbWVzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBjYWxsIHRyaWdnZXIgYnVpbGRDb250ZW50XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNicmllZmluZ0NoYXJhY3RlcicpLnNlbGVjdDIoZGF0YSkudmFsKGNoYXJhY3Rlck5hbWUpLnRyaWdnZXIoJ2NoYW5nZScpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gYnVpbGRDb250ZW50RGVsZWdhdGUoZXZlbnQpIHtcclxuICAgICAgICBidWlsZENvbnRlbnQoZXZlbnQudGFyZ2V0LnZhbHVlKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBidWlsZENvbnRlbnQoY2hhcmFjdGVyTmFtZSkge1xyXG4gICAgICAgIFVJLnVwZGF0ZUVudGl0eVNldHRpbmcoc2V0dGluZ3NQYXRoLCBjaGFyYWN0ZXJOYW1lKTtcclxuICAgICAgICBjb25zdCBjb250ZW50ID0gY2xlYXJFbChnZXRFbCgnYnJpZWZpbmdDb250ZW50JykpO1xyXG4gICAgICAgIGxldCBpbmRleCA9IDA7XHJcbiAgICAgICAgY29uc3QgZGF0YSA9IHtcclxuICAgICAgICAgICAgY2hhcmFjdGVyTmFtZVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgZnVuY3Rpb24gYnVpbGRDb250ZW50SW5uZXIoKSB7XHJcbiAgICAgICAgICAgIGlmIChpbmRleCA8IHN0YXRlLnBhbmVscy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGluZGV4Kys7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5wYW5lbHNbaW5kZXggLSAxXS5sb2FkKGRhdGEsIGJ1aWxkQ29udGVudElubmVyKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHN0YXRlLnBhbmVscy5tYXAoUi5wcm9wKCdtYWtlJykpLmZvckVhY2goKG1ha2UpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBtYWtlKGNvbnRlbnQsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbi8vICAgICAgICAgICAgICAgIHJlYnVpbGRHdXR0ZXIoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBidWlsZENvbnRlbnRJbm5lcigpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldEZsYWdzKCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGlzQWRhcHRhdGlvbnNNb2RlOiBnZXRFbCgnYWRhcHRhdGlvbnNNb2RlUmFkaW8nKS5jaGVja2VkLFxyXG4gICAgICAgICAgICBpc0dyb3VwaW5nQnlTdG9yeTogZ2V0RWwoJ2V2ZW50R3JvdXBpbmdCeVN0b3J5UmFkaW8nKS5jaGVja2VkLFxyXG4gICAgICAgICAgICBkaXNhYmxlSGVhZGVyczogZ2V0RWwoJ2Rpc2FibGVIZWFkZXJzQ2hlY2tib3gnKS5jaGVja2VkLFxyXG4gICAgICAgICAgICBoaWRlQWxsUGFuZWxzOiBnZXRFbCgnaGlkZUFsbFBhbmVsc0NoZWNrYm94JykuY2hlY2tlZFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gaW5pdFBhbmVsc0Fycigpe1xyXG4gICAgICAgIHN0YXRlLnBhbmVscyA9IFt7XHJcbiAgICAgICAgICAgIG5hbWU6ICdzdG9yeVJpZ2h0cycsXHJcbiAgICAgICAgICAgIGxvYWQoZGF0YSwgY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdzdG9yeScsIHRydWUsIChlcnIsIHVzZXJTdG9yeU5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICBkYXRhLnVzZXJTdG9yeU5hbWVzTWFwID0gUi5pbmRleEJ5KFIucHJvcCgndmFsdWUnKSwgdXNlclN0b3J5TmFtZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgbWFrZShlbCwgZGF0YSkge31cclxuICAgICAgICB9LCB7XHJcbiAgICAgICAgICAgIG5hbWU6ICdjaGFyYWN0ZXJQcm9maWxlJyxcclxuICAgICAgICAgICAgbG9hZChkYXRhLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgREJNUy5nZXRQcm9maWxlKCdjaGFyYWN0ZXInLCBkYXRhLmNoYXJhY3Rlck5hbWUsIChlcnIsIHByb2ZpbGUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEucHJvZmlsZSA9IHByb2ZpbGU7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBtYWtlKGVsLCBkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IHN0ckZvcm1hdChnZXRMMTBuKCdicmllZmluZ3MtY2hhcmFjdGVyLXByb2ZpbGUnKSwgW2RhdGEuY2hhcmFjdGVyTmFtZV0pO1xyXG4gICAgICAgICAgICAgICAgYWRkRWwoZWwsIG1ha2VQYW5lbChcclxuICAgICAgICAgICAgICAgICAgICBtYWtlVGV4dChsYWJlbCksXHJcbiAgICAgICAgICAgICAgICAgICAgVUkubWFrZVByb2ZpbGVUYWJsZShzdGF0ZS5jaGFyYWN0ZXJQcm9maWxlU3RydWN0dXJlLCBkYXRhLnByb2ZpbGUpLCBnZXRGbGFncygpLmhpZGVBbGxQYW5lbHNcclxuICAgICAgICAgICAgICAgICkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSwge1xyXG4gICAgICAgICAgICBuYW1lOiAncGxheWVyUHJvZmlsZScsXHJcbiAgICAgICAgICAgIGxvYWQoZGF0YSwgY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0UHJvZmlsZUJpbmRpbmcoJ2NoYXJhY3RlcicsIGRhdGEuY2hhcmFjdGVyTmFtZSwgKGVyciwgYmluZGluZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbMV0gPT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgREJNUy5nZXRQcm9maWxlKCdwbGF5ZXInLCBiaW5kaW5nWzFdLCAoZXJyMiwgcGxheWVyUHJvZmlsZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wbGF5ZXJQcm9maWxlID0gcGxheWVyUHJvZmlsZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBwcmVmZXItZGVzdHJ1Y3R1cmluZ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wbGF5ZXJOYW1lID0gYmluZGluZ1sxXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBtYWtlKGVsLCBkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGF0YS5wbGF5ZXJQcm9maWxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFiZWwgPSBzdHJGb3JtYXQoZ2V0TDEwbignYnJpZWZpbmdzLXBsYXllci1wcm9maWxlJyksIFtkYXRhLnBsYXllck5hbWVdKTtcclxuICAgICAgICAgICAgICAgICAgICBhZGRFbChlbCwgbWFrZVBhbmVsKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYWtlVGV4dChsYWJlbCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFVJLm1ha2VQcm9maWxlVGFibGUoc3RhdGUucGxheWVyUHJvZmlsZVN0cnVjdHVyZSwgZGF0YS5wbGF5ZXJQcm9maWxlKSwgZ2V0RmxhZ3MoKS5oaWRlQWxsUGFuZWxzXHJcbiAgICAgICAgICAgICAgICAgICAgKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LCB7XHJcbiAgICAgICAgICAgIG5hbWU6ICdpbnZlbnRvcnknLFxyXG4gICAgICAgICAgICBsb2FkKGRhdGEsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLmdldEFsbEludmVudG9yeUxpc3RzKGRhdGEuY2hhcmFjdGVyTmFtZSwgKGVyciwgYWxsSW52ZW50b3J5TGlzdHMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEuYWxsSW52ZW50b3J5TGlzdHMgPSBhbGxJbnZlbnRvcnlMaXN0cy5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBRmFjdG9yeShSLmNvbXBvc2UoUi50b0xvd2VyLCBSLnByb3AoJ3N0b3J5TmFtZScpKSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgbWFrZShlbCwgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgYWRkRWwoZWwsIG1ha2VQYW5lbChcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFrZVRleHQoYCR7Z2V0TDEwbignYnJpZWZpbmdzLWludmVudG9yeScpfSAoJHtkYXRhLmFsbEludmVudG9yeUxpc3RzLmxlbmd0aH0pYCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ha2VJbnZlbnRvcnlDb250ZW50KFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuYWxsSW52ZW50b3J5TGlzdHMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5jaGFyYWN0ZXJOYW1lLCBkYXRhLnVzZXJTdG9yeU5hbWVzTWFwXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICksIGdldEZsYWdzKCkuaGlkZUFsbFBhbmVsc1xyXG4gICAgICAgICAgICAgICAgKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LCB7XHJcbiAgICAgICAgICAgIG5hbWU6ICdncm91cHMnLFxyXG4gICAgICAgICAgICBsb2FkKGRhdGEsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLmdldENoYXJhY3Rlckdyb3VwVGV4dHMoZGF0YS5jaGFyYWN0ZXJOYW1lLCAoZXJyLCBncm91cFRleHRzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICBkYXRhLmdyb3VwVGV4dHMgPSBncm91cFRleHRzO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgbWFrZShlbCwgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgYWRkRWwoZWwsIG1ha2VQYW5lbChcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFrZVRleHQoYCR7Z2V0TDEwbignaGVhZGVyLWdyb3VwcycpfSAoJHtkYXRhLmdyb3VwVGV4dHMubGVuZ3RofSlgKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFrZUdyb3VwQ29udGVudChkYXRhLmdyb3VwVGV4dHMpLCBnZXRGbGFncygpLmhpZGVBbGxQYW5lbHNcclxuICAgICAgICAgICAgICAgICkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSwge1xyXG4gICAgICAgICAgICBuYW1lOiAncmVsYXRpb25zJyxcclxuICAgICAgICAgICAgbG9hZDogUmVsYXRpb25zLmxvYWQsXHJcbiAgICAgICAgICAgIG1ha2UoZWwsIGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gYCR7Z2V0TDEwbignaGVhZGVyLXJlbGF0aW9ucycpfSAoJHtkYXRhLnJlbGF0aW9uc1N1bW1hcnkucmVsYXRpb25zLmxlbmd0aH0pYDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBSZWxhdGlvbnNQcmV2aWV3Lm1ha2VSZWxhdGlvbnNDb250ZW50KFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLCBnZXRGbGFncygpLmlzQWRhcHRhdGlvbnNNb2RlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5jaGFyYWN0ZXJQcm9maWxlU3RydWN0dXJlLCBleHBvcnRzLnJlZnJlc2hcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICBhZGRFbChlbCwgbWFrZVBhbmVsKG1ha2VUZXh0KGxhYmVsKSwgY29udGVudCwgZ2V0RmxhZ3MoKS5oaWRlQWxsUGFuZWxzKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LCB7XHJcbiAgICAgICAgICAgIG5hbWU6ICdzdG9yaWVzJyxcclxuICAgICAgICAgICAgbG9hZChkYXRhLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgbWFrZShlbCwgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZmxhZ3MgPSBnZXRGbGFncygpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGZsYWdzLmlzR3JvdXBpbmdCeVN0b3J5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2hvd0V2ZW50c0J5U3RvcnkoZWwsIGRhdGEuY2hhcmFjdGVyTmFtZSwgZGF0YS51c2VyU3RvcnlOYW1lc01hcCwgZmxhZ3MpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBzaG93RXZlbnRzQnlUaW1lKGVsLCBkYXRhLmNoYXJhY3Rlck5hbWUsIGRhdGEudXNlclN0b3J5TmFtZXNNYXAsIGZsYWdzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1dO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG9uQnVpbGRDb250ZW50RmluaXNoKCkge1xyXG4gICAgICAgIFVJLmluaXRUZXh0QXJlYXMoYCR7cm9vdH0gI2JyaWVmaW5nQ29udGVudCB0ZXh0YXJlYWApO1xyXG4gICAgICAgIFVJLnJlZnJlc2hUZXh0QXJlYXMoYCR7cm9vdH0gI2JyaWVmaW5nQ29udGVudCB0ZXh0YXJlYWApO1xyXG4gICAgICAgIFV0aWxzLmVuYWJsZShleHBvcnRzLmNvbnRlbnQsICdub3RFZGl0YWJsZScsIGZhbHNlKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZVBhbmVsKHRpdGxlLCBjb250ZW50LCBoaWRlQWxsUGFuZWxzKSB7XHJcbiAgICAgICAgY29uc3QgcGFuZWxJbmZvID0gVUkubWFrZVBhbmVsQ29yZSh0aXRsZSwgY29udGVudCk7XHJcbiAgICAgICAgVUkuYXR0YWNoUGFuZWxUb2dnbGVyKHBhbmVsSW5mby5hLCBwYW5lbEluZm8uY29udGVudERpdiwgKGV2ZW50LCB0b2dnbGVQYW5lbCkgPT4ge1xyXG4gICAgICAgICAgICB0b2dnbGVQYW5lbCgpO1xyXG4vLyAgICAgICAgICAgIHJlYnVpbGRHdXR0ZXIoKTtcclxuICAgICAgICAgICAgVUkucmVmcmVzaFRleHRBcmVhcyhgJHtyb290fSAjYnJpZWZpbmdDb250ZW50IHRleHRhcmVhYCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKGhpZGVBbGxQYW5lbHMpIHtcclxuICAgICAgICAgICAgcGFuZWxJbmZvLmEuY2xpY2soKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHBhbmVsSW5mby5wYW5lbDtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlR3JvdXBDb250ZW50KGdyb3VwVGV4dHMpIHtcclxuICAgICAgICByZXR1cm4gYWRkRWxzKG1ha2VFbCgnZGl2JyksIGdyb3VwVGV4dHMubWFwKChncm91cFRleHQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZGl2ID0gbWFrZUVsKCdkaXYnKTtcclxuICAgICAgICAgICAgYWRkRWwoZGl2LCBhZGRFbChtYWtlRWwoJ2g0JyksIG1ha2VUZXh0KGdyb3VwVGV4dC5ncm91cE5hbWUpKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHNwYW4gPSBhZGRFbChtYWtlRWwoJ3RleHRhcmVhJyksIG1ha2VUZXh0KGdyb3VwVGV4dC50ZXh0KSk7XHJcbiAgICAgICAgICAgIHNldEF0dHIoc3BhbiwgJ2Rpc2FibGVkJywgJ2Rpc2FibGVkJyk7XHJcbiAgICAgICAgICAgIGFkZENsYXNzZXMoc3BhbiwgWydicmllZmluZ1RleHRTcGFuJywgJ2Zvcm0tY29udHJvbCddKTtcclxuICAgICAgICAgICAgcmV0dXJuIGFkZEVsKGRpdiwgc3Bhbik7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VJbnZlbnRvcnlDb250ZW50KGFsbEludmVudG9yeUxpc3RzLCBjaGFyYWN0ZXJOYW1lLCB1c2VyU3RvcnlOYW1lc01hcCkge1xyXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHFtdGUoJy5wcm9maWxlLWVkaXRvci1jb250YWluZXItdG1wbCcpO1xyXG4gICAgICAgIHJldHVybiBhZGRFbHMoY29udGFpbmVyLCBhbGxJbnZlbnRvcnlMaXN0cy5tYXAoKGVsZW0pID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaW5wdXQgPSBtYWtlRWwoJ2lucHV0Jyk7XHJcbiAgICAgICAgICAgIGlucHV0LnZhbHVlID0gZWxlbS5pbnZlbnRvcnk7XHJcbiAgICAgICAgICAgIGlucHV0LnN0b3J5TmFtZSA9IGVsZW0uc3RvcnlOYW1lO1xyXG4gICAgICAgICAgICBpbnB1dC5jaGFyYWN0ZXJOYW1lID0gY2hhcmFjdGVyTmFtZTtcclxuICAgICAgICAgICAgYWRkQ2xhc3NlcyhpbnB1dCwgWydpbnZlbnRvcnlJbnB1dCcsICdmb3JtLWNvbnRyb2wnXSk7XHJcbiAgICAgICAgICAgIGlmICghdXNlclN0b3J5TmFtZXNNYXBbZWxlbS5zdG9yeU5hbWVdKSB7XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ25vdEVkaXRhYmxlJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGlzdGVuKGlucHV0LCAnY2hhbmdlJywgdXBkYXRlQ2hhcmFjdGVySW52ZW50b3J5KTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHJvdyA9IHFtdGUoJy5wcm9maWxlLWVkaXRvci1yb3ctdG1wbCcpO1xyXG4gICAgICAgICAgICBhZGRFbChxZWUocm93LCAnLnByb2ZpbGUtaXRlbS1uYW1lJyksIG1ha2VUZXh0KGVsZW0uc3RvcnlOYW1lKSk7XHJcbiAgICAgICAgICAgIGFkZEVsKHFlZShyb3csICcucHJvZmlsZS1pdGVtLWlucHV0JyksIGlucHV0KTtcclxuICAgICAgICAgICAgcmV0dXJuIHJvdztcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2hvd0V2ZW50c0J5VGltZShjb250ZW50LCBjaGFyYWN0ZXJOYW1lLCB1c2VyU3RvcnlOYW1lc01hcCwgZmxhZ3MpIHtcclxuICAgICAgICBEQk1TLmdldENoYXJhY3RlckV2ZW50c0J5VGltZShjaGFyYWN0ZXJOYW1lLCAoZXJyLCBhbGxFdmVudHMpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgY29uc3QgYWRhcHRhdGlvbnMgPSBhbGxFdmVudHMubWFwKGV2ZW50ID0+ICh7XHJcbiAgICAgICAgICAgICAgICBjaGFyYWN0ZXJOYW1lLFxyXG4gICAgICAgICAgICAgICAgc3RvcnlOYW1lOiBldmVudC5zdG9yeU5hbWVcclxuICAgICAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmFyZUFkYXB0YXRpb25zRWRpdGFibGUoYWRhcHRhdGlvbnMsIChlcnIyLCBhcmVBZGFwdGF0aW9uc0VkaXRhYmxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcblxyXG4gICAgICAgICAgICAgICAgREJNUy5nZXRNZXRhSW5mbygoZXJyMywgbWV0YUluZm8pID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG9wdHMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJTdG9yeU5hbWVzTWFwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcmVBZGFwdGF0aW9uc0VkaXRhYmxlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzaG93U3RvcnlOYW1lOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRhSW5mb1xyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwbGl0Q29uc3RhbnQgPSA1O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBhZGRFbHMoY29udGVudCwgUi5zcGxpdEV2ZXJ5KHNwbGl0Q29uc3RhbnQsIGFsbEV2ZW50cykubWFwKChzdWJQYXJ0LCBpKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGV2ZW50Q29udGVudCA9IGFkZEVscyhtYWtlRWwoJ2RpdicpLCBzdWJQYXJ0Lm1hcCgoZXZlbnQsIGopID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdHMuaW5kZXggPSAoaSAqIHNwbGl0Q29uc3RhbnQpICsgMSArIGo7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2hvd0V2ZW50KGV2ZW50LCBjaGFyYWN0ZXJOYW1lLCBvcHRzLCBmbGFncyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBuYW1lO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmxhZ3MuZGlzYWJsZUhlYWRlcnMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBtYWtlVGV4dChzdHJGb3JtYXQoZ2V0TDEwbignYnJpZWZpbmdzLWV2ZW50cy1oZWFkZXInKSwgWyhpICogc3BsaXRDb25zdGFudCkgKyAxLCAoaSAqIHNwbGl0Q29uc3RhbnQpICsgc3ViUGFydC5sZW5ndGhdKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lID0gYWRkRWxzKG1ha2VFbCgnZGl2JyksIHN1YlBhcnQubWFwKGV2ZW50ID0+IGdldEV2ZW50SGVhZGVyRGl2KGV2ZW50LCB0cnVlKSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtYWtlUGFuZWwobmFtZSwgZXZlbnRDb250ZW50LCBmbGFncy5oaWRlQWxsUGFuZWxzKTtcclxuICAgICAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgb25CdWlsZENvbnRlbnRGaW5pc2goKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRTdG9yeUhlYWRlcihlbGVtLCBpLCBkaXNhYmxlSGVhZGVycykge1xyXG4gICAgICAgIGxldCBuYW1lO1xyXG4gICAgICAgIGlmIChkaXNhYmxlSGVhZGVycykge1xyXG4gICAgICAgICAgICBuYW1lID0gc3RyRm9ybWF0KGdldEwxMG4oJ2JyaWVmaW5ncy1zdG9yeS1oZWFkZXInKSwgW2kgKyAxXSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbmFtZSA9IGVsZW0uc3RvcnlOYW1lO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbWFrZVRleHQoYCR7bmFtZX0gKCR7ZWxlbS5ldmVudHMubGVuZ3RofSlgKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzaG93RXZlbnRzQnlTdG9yeShjb250ZW50LCBjaGFyYWN0ZXJOYW1lLCB1c2VyU3RvcnlOYW1lc01hcCwgZmxhZ3MpIHtcclxuICAgICAgICBEQk1TLmdldENoYXJhY3RlckV2ZW50R3JvdXBzQnlTdG9yeShjaGFyYWN0ZXJOYW1lLCAoZXJyLCBldmVudEdyb3VwcykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBjb25zdCBhZGFwdGF0aW9ucyA9IGV2ZW50R3JvdXBzLm1hcChlbGVtID0+ICh7XHJcbiAgICAgICAgICAgICAgICBjaGFyYWN0ZXJOYW1lLFxyXG4gICAgICAgICAgICAgICAgc3RvcnlOYW1lOiBlbGVtLnN0b3J5TmFtZVxyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5hcmVBZGFwdGF0aW9uc0VkaXRhYmxlKGFkYXB0YXRpb25zLCAoZXJyMiwgYXJlQWRhcHRhdGlvbnNFZGl0YWJsZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgREJNUy5nZXRNZXRhSW5mbygoZXJyMywgbWV0YUluZm8pID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3B0cyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlclN0b3J5TmFtZXNNYXAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyZUFkYXB0YXRpb25zRWRpdGFibGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dTdG9yeU5hbWU6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRhSW5mb1xyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGFkZEVscyhjb250ZW50LCBldmVudEdyb3Vwcy5tYXAoKGVsZW0sIGkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RvcnlDb250ZW50ID0gYWRkRWxzKG1ha2VFbCgnZGl2JyksIGVsZW0uZXZlbnRzLm1hcCgoZXZlbnQsIGopID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdHMuaW5kZXggPSBqICsgMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzaG93RXZlbnQoZXZlbnQsIGNoYXJhY3Rlck5hbWUsIG9wdHMsIGZsYWdzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWFrZVBhbmVsKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0U3RvcnlIZWFkZXIoZWxlbSwgaSwgZmxhZ3MuZGlzYWJsZUhlYWRlcnMpLCBzdG9yeUNvbnRlbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGFncy5oaWRlQWxsUGFuZWxzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIG9uQnVpbGRDb250ZW50RmluaXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0RXZlbnRIZWFkZXJEaXYoZXZlbnQsIHNob3dTdG9yeU5hbWUpIHtcclxuICAgICAgICBjb25zdCBldmVudE5hbWUgPSBhZGRFbChtYWtlRWwoJ3NwYW4nKSwgbWFrZVRleHQoc3RyRm9ybWF0KCd7MH0gezF9JywgW3Nob3dTdG9yeU5hbWUgPyBgJHtldmVudC5zdG9yeU5hbWV9OmAgOiAnJywgZXZlbnQubmFtZV0pKSk7XHJcbiAgICAgICAgY29uc3QgZXZlbnRUaW1lID0gYWRkQ2xhc3MoYWRkRWwobWFrZUVsKCdzcGFuJyksIG1ha2VUZXh0KGV2ZW50LnRpbWUpKSwgJ3ByZXZpZXdFdmVudFRpbWUnKTtcclxuICAgICAgICByZXR1cm4gYWRkRWxzKG1ha2VFbCgnZGl2JyksIFtldmVudFRpbWUsIGV2ZW50TmFtZV0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNob3dFdmVudChldmVudCwgY2hhcmFjdGVyTmFtZSwgb3B0cywgZmxhZ3MpIHtcclxuICAgICAgICBjb25zdCB7IGlzQWRhcHRhdGlvbnNNb2RlIH0gPSBmbGFncztcclxuICAgICAgICBjb25zdCBzaG93QWxsID0gaXNBZGFwdGF0aW9uc01vZGU7XHJcbiAgICAgICAgY29uc3Qgc3RvcnlOYW1lID0gZXZlbnQuc3RvcnlOYW1lO1xyXG4gICAgICAgIGNvbnN0IGlzU3RvcnlFZGl0YWJsZSA9IG9wdHMudXNlclN0b3J5TmFtZXNNYXBbc3RvcnlOYW1lXSAhPT0gdW5kZWZpbmVkO1xyXG4gICAgICAgIGNvbnN0IHNob3dBZGFwdGF0aW9uVGV4dCA9IGV2ZW50LmNoYXJhY3RlcnNbY2hhcmFjdGVyTmFtZV0udGV4dCAhPT0gJyc7XHJcbiAgICAgICAgY29uc3Qgc2hvd1N1YmplY3RpdmVUaW1lID0gZXZlbnQuY2hhcmFjdGVyc1tjaGFyYWN0ZXJOYW1lXS50aW1lICE9PSAnJztcclxuXHJcbiAgICAgICAgY29uc3QgZXZlbnREaXYgPSBxbXRlKCcuYWRhcHRhdGlvbi1yb3ctdG1wbCcpO1xyXG4gICAgICAgIGNvbnN0IG9yaWdpbkNhcmQgPSBBZGFwdGF0aW9ucy5tYWtlT3JpZ2luQ2FyZChldmVudCwgb3B0cy5tZXRhSW5mbywgZXZlbnQuc3RvcnlOYW1lLCB7XHJcbiAgICAgICAgICAgIGNhcmRUaXRsZTogZmxhZ3MuZGlzYWJsZUhlYWRlcnMgPyBMMTBuLmZvcm1hdCgnYnJpZWZpbmdzJywgJ2V2ZW50LWhlYWRlcicsIFtvcHRzLmluZGV4XSkgOiBldmVudC5uYW1lLFxyXG4gICAgICAgICAgICBzaG93VGltZUlucHV0OiBzaG93QWxsIHx8ICFzaG93U3ViamVjdGl2ZVRpbWUsXHJcbiAgICAgICAgICAgIHNob3dMb2NrQnV0dG9uOiB0cnVlLFxyXG4gICAgICAgICAgICBzaG93VGV4dElucHV0OiBzaG93QWxsIHx8ICFzaG93QWRhcHRhdGlvblRleHRcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZighaXNTdG9yeUVkaXRhYmxlKXtcclxuICAgICAgICAgICAgcWVlcyhvcmlnaW5DYXJkLCAnLmlzU3RvcnlFZGl0YWJsZScpLmZvckVhY2goYWRkQ2xhc3MoUi5fXywgJ25vdEVkaXRhYmxlJykpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBhZGRFbChxZWUoZXZlbnREaXYsICcuZXZlbnRNYWluUGFuZWxSb3ctbGVmdCcpLCBvcmlnaW5DYXJkKTtcclxuICAgICAgICBjb25zdCBpc0VkaXRhYmxlID0gb3B0cy5hcmVBZGFwdGF0aW9uc0VkaXRhYmxlW2Ake2V2ZW50LnN0b3J5TmFtZX0tJHtjaGFyYWN0ZXJOYW1lfWBdO1xyXG4gICAgICAgIGNvbnN0IGFkYXB0YXRpb25zQ2FyZCA9IEFkYXB0YXRpb25zLm1ha2VBZGFwdGF0aW9uQ2FyZChcclxuICAgICAgICAgICAgaXNFZGl0YWJsZSwgZXZlbnQsXHJcbiAgICAgICAgICAgIGV2ZW50LnN0b3J5TmFtZSwgY2hhcmFjdGVyTmFtZSwge1xyXG4gICAgICAgICAgICAgICAgY2FyZFRpdGxlOiAnJyxcclxuICAgICAgICAgICAgICAgIHNob3dUaW1lSW5wdXQ6IHNob3dBbGwgfHwgc2hvd1N1YmplY3RpdmVUaW1lLFxyXG4gICAgICAgICAgICAgICAgc2hvd0ZpbmlzaGVkQnV0dG9uOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgc2hvd1RleHRJbnB1dDogc2hvd0FsbCB8fCBzaG93QWRhcHRhdGlvblRleHRcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgYWRkRWwocWVlKGV2ZW50RGl2LCAnLmV2ZW50TWFpblBhbmVsUm93LWxlZnQnKSwgYWRhcHRhdGlvbnNDYXJkKTtcclxuICAgICAgICByZXR1cm4gZXZlbnREaXY7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlQ2hhcmFjdGVySW52ZW50b3J5KGV2ZW50KSB7XHJcbiAgICAgICAgY29uc3Qge1xyXG4gICAgICAgICAgICBzdG9yeU5hbWUsIGNoYXJhY3Rlck5hbWUsIHZhbHVlXHJcbiAgICAgICAgfSA9IGV2ZW50LnRhcmdldDtcclxuICAgICAgICBEQk1TLnVwZGF0ZUNoYXJhY3RlckludmVudG9yeShzdG9yeU5hbWUsIGNoYXJhY3Rlck5hbWUsIHZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICB9XHJcbn0pKHRoaXMuQnJpZWZpbmdQcmV2aWV3ID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE4IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCByb290ID0gJy5yZWxhdGlvbnMtdGFiICc7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG4gICAgY29uc3Qgc2V0dGluZ3NQYXRoID0gJ1JlbGF0aW9ucyc7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgICQoYCR7cm9vdH0gLmNoYXJhY3Rlci1zZWxlY3RgKS5zZWxlY3QyKCkub24oJ2NoYW5nZScsIGJ1aWxkQ29udGVudCk7XHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgICAgIGNsZWFyRWwocXVlcnlFbChgJHtyb290fSAuY2hhcmFjdGVyLXNlbGVjdGApKTtcclxuICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0gLnBhbmVsLWJvZHlgKSk7XHJcblxyXG4gICAgICAgIERCTVMuZ2V0UHJvZmlsZVN0cnVjdHVyZSgnY2hhcmFjdGVyJywgKGVyciwgY2hhcmFjdGVyUHJvZmlsZVN0cnVjdHVyZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBzdGF0ZS5jaGFyYWN0ZXJQcm9maWxlU3RydWN0dXJlID0gY2hhcmFjdGVyUHJvZmlsZVN0cnVjdHVyZTtcclxuICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2NoYXJhY3RlcicsIGZhbHNlLCAoZXJyMywgbmFtZXMpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIzKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjMpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgc2hvd0VsKHFlKGAke3Jvb3R9IC5hbGVydGApLCBuYW1lcy5sZW5ndGggPCAyKTtcclxuICAgICAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fSA+IC5wYW5lbGApLCBuYW1lcy5sZW5ndGggPiAxKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgaWYgKG5hbWVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFyYWN0ZXJOYW1lID0gVUkuY2hlY2tBbmRHZXRFbnRpdHlTZXR0aW5nKHNldHRpbmdzUGF0aCwgbmFtZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBnZXRTZWxlY3QyRGF0YShuYW1lcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBjYWxsIHRyaWdnZXIgYnVpbGRDb250ZW50XHJcbiAgICAgICAgICAgICAgICAgICAgJChgJHtyb290fSAuY2hhcmFjdGVyLXNlbGVjdGApLnNlbGVjdDIoZGF0YSkudmFsKGNoYXJhY3Rlck5hbWUpLnRyaWdnZXIoJ2NoYW5nZScpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gYnVpbGRDb250ZW50KGV2ZW50KSB7XHJcbiAgICAgICAgY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9IC5wYW5lbC1ib2R5YCkpO1xyXG4gICAgICAgIGNvbnN0IGNoYXJhY3Rlck5hbWUgPSBldmVudC50YXJnZXQudmFsdWU7XHJcbiAgICAgICAgVUkudXBkYXRlRW50aXR5U2V0dGluZyhzZXR0aW5nc1BhdGgsIGNoYXJhY3Rlck5hbWUpO1xyXG4gICAgICAgIHN0YXRlLmRhdGEgPSB7fTtcclxuICAgICAgICBzdGF0ZS5kYXRhLmNoYXJhY3Rlck5hbWUgPSBjaGFyYWN0ZXJOYW1lO1xyXG4gICAgICAgIGV4cG9ydHMubG9hZChzdGF0ZS5kYXRhLCBidWlsZENvbnRlbnRJbm5lcik7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gYnVpbGRDb250ZW50SW5uZXIoKSB7XHJcbiAgICAgICAgY29uc3QgY29udGVudCA9IFJlbGF0aW9uc1ByZXZpZXcubWFrZVJlbGF0aW9uc0NvbnRlbnQoXHJcbiAgICAgICAgICAgIHN0YXRlLmRhdGEsIHRydWUsIHN0YXRlLmNoYXJhY3RlclByb2ZpbGVTdHJ1Y3R1cmUsXHJcbiAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaFxyXG4gICAgICAgICk7XHJcbiAgICAgICAgYWRkRWwocXVlcnlFbChgJHtyb290fSAucGFuZWwtYm9keWApLCBjb250ZW50KTtcclxuICAgICAgICBVSS5pbml0VGV4dEFyZWFzKGAke3Jvb3R9IC5wYW5lbC1ib2R5IHRleHRhcmVhYCk7XHJcbiAgICAgICAgVUkucmVmcmVzaFRleHRBcmVhcyhgJHtyb290fSAucGFuZWwtYm9keSB0ZXh0YXJlYWApO1xyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydHMubG9hZCA9IChkYXRhLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgICAgIERCTVMuZ2V0QWxsUHJvZmlsZXMoJ2NoYXJhY3RlcicsIChlcnIsIHByb2ZpbGVzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIERCTVMuZ2V0UmVsYXRpb25zU3VtbWFyeShkYXRhLmNoYXJhY3Rlck5hbWUsIChlcnIyLCByZWxhdGlvbnNTdW1tYXJ5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBEQk1TLmdldEV4dGVuZGVkUHJvZmlsZUJpbmRpbmdzKChlcnIzLCBwcm9maWxlQmluZGluZ3MpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2NoYXJhY3RlcicsIGZhbHNlLCAoZXJyNCwgY2hhcmFjdGVyTmFtZXNBcnJheSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyNCkgeyBVdGlscy5oYW5kbGVFcnJvcihlcnI0KTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucmVsYXRpb25zU3VtbWFyeSA9IHJlbGF0aW9uc1N1bW1hcnk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuY2hhcmFjdGVyTmFtZXNBcnJheSA9IGNoYXJhY3Rlck5hbWVzQXJyYXk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHJvZmlsZXMgPSBwcm9maWxlcztcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wcm9maWxlQmluZGluZ3MgPSBSLmZyb21QYWlycyhwcm9maWxlQmluZGluZ3MpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxufSkodGhpcy5SZWxhdGlvbnMgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHJlbGF0aW9uVGFibGVIZWFkZXIgPSBbJ2NoYXJhY3Rlci1uYW1lJywgJ2RpcmVjdC1yZWxhdGlvbicsICdyZWxhdGlvbi1vcmlnaW4nLCAncmV2ZXJzZS1yZWxhdGlvbiddO1xyXG4gICAgY29uc3QgcGFydGlhbFRhYmxlSGVhZGVyID0gWydjaGFyYWN0ZXItbmFtZScsICdkaXJlY3QtcmVsYXRpb24nXTtcclxuXHJcbiAgICBsZXQgbWFrZU5ld1JvdztcclxuICAgIGNvbnN0IGwxMG4gPSBMMTBuLmdldCgnYnJpZWZpbmdzJyk7XHJcblxyXG4gICAgY29uc3QgZmluZFJlbCA9IFIuY3VycnkoKGZyb21DaGFyYWN0ZXIsIHRvQ2hhcmFjdGVyLCByZWxhdGlvbnMpID0+IHtcclxuICAgICAgICBjb25zdCBmaW5kRnVuYyA9IFIuY3VycnkoKGZyb21DaGFyYWN0ZXIyLCB0b0NoYXJhY3RlcjIsIHJlbCkgPT5cclxuICAgICAgICAgICAgcmVsW2Zyb21DaGFyYWN0ZXIyXSAhPT0gdW5kZWZpbmVkICYmIHJlbFt0b0NoYXJhY3RlcjJdICE9PSB1bmRlZmluZWQpO1xyXG4gICAgICAgIHJldHVybiBSLmZpbmQoZmluZEZ1bmMoZnJvbUNoYXJhY3RlciwgdG9DaGFyYWN0ZXIpLCByZWxhdGlvbnMpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlUmVsYXRpb25zQ29udGVudCA9IChkYXRhLCBpc0FkYXB0YXRpb25zTW9kZSwgcHJvZmlsZVNldHRpbmdzLCBleHRlcm5hbFJlZnJlc2gpID0+IHtcclxuICAgICAgICBjb25zdCB7XHJcbiAgICAgICAgICAgIGNoYXJhY3Rlck5hbWUsIHJlbGF0aW9uc1N1bW1hcnksIHByb2ZpbGVzLCBwcm9maWxlQmluZGluZ3NcclxuICAgICAgICB9ID0gZGF0YTtcclxuICAgICAgICBsZXQgeyBjaGFyYWN0ZXJOYW1lc0FycmF5IH0gPSBkYXRhO1xyXG5cclxuICAgICAgICBjaGFyYWN0ZXJOYW1lc0FycmF5ID0gY2hhcmFjdGVyTmFtZXNBcnJheS5maWx0ZXIoUi5jb21wb3NlKFIubm90LCBSLmVxdWFscyhjaGFyYWN0ZXJOYW1lKSwgUi5wcm9wKCd2YWx1ZScpKSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGdldDJuZENoYXJOYW1lID0gUHJvamVjdFV0aWxzLmdldDJuZFJlbENoYXIoY2hhcmFjdGVyTmFtZSk7XHJcbiAgICAgICAgY29uc3Qgc2hvd0NoYXJhY3RlcnMgPSByZWxhdGlvbnNTdW1tYXJ5LnJlbGF0aW9ucy5tYXAoZ2V0Mm5kQ2hhck5hbWUpLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEpO1xyXG4gICAgICAgIGNvbnN0IG5vUmVsc0xpc3QgPSBjaGFyYWN0ZXJOYW1lc0FycmF5LmZpbHRlcihSLmNvbXBvc2UoUi5ub3QsIFIuY29udGFpbnMoUi5fXywgc2hvd0NoYXJhY3RlcnMpLCBSLnByb3AoJ3ZhbHVlJykpKTtcclxuICAgICAgICBjb25zdCBwcmVkaWNhdGUgPSBSLmNvbXBvc2UoUi5jb250YWlucyhSLl9fLCBSLmtleXMocmVsYXRpb25zU3VtbWFyeS5rbm93bkNoYXJhY3RlcnMpKSwgUi5wcm9wKCd2YWx1ZScpKTtcclxuICAgICAgICBjb25zdCBba25vd25Ob1JlbHMsIHVua25vd25Ob1JlbHNdID0gUi5wYXJ0aXRpb24ocHJlZGljYXRlLCBub1JlbHNMaXN0KTtcclxuXHJcbiAgICAgICAgY29uc3QgcmVsYXRpb25UbXBsID0gd3JhcEVsKCdkaXYnLCBxdGUoJy5yZWxhdGlvbi10bXBsJykpO1xyXG4gICAgICAgIGNvbnN0IHFlID0gcWVlKHJlbGF0aW9uVG1wbCk7XHJcbiAgICAgICAgY29uc3QgY29udGVudCA9IHFlKCcucmVsYXRpb24tY29udGVudCcpO1xyXG4gICAgICAgIGNvbnN0IGdldFByb2ZpbGVJdGVtU2VsZWN0ID0gKCkgPT4gcWUoJy5wcm9maWxlLWl0ZW0tc2VsZWN0Jyk7XHJcblxyXG4gICAgICAgIG1ha2VQcm9maWxlSXRlbVNlbGVjdG9yKHFlKCcucHJvZmlsZS1pdGVtLXNlbGVjdCcpLCBwcm9maWxlU2V0dGluZ3MsIHJlZnJlc2hQcm9maWxlSXRlbShjb250ZW50LCBwcm9maWxlcykpO1xyXG5cclxuICAgICAgICBjb25zdCBtYWtlUm93ID0gbWFrZU5ld1JvdyhcclxuICAgICAgICAgICAgcHJvZmlsZXMsIGdldFByb2ZpbGVJdGVtU2VsZWN0LCBpc0FkYXB0YXRpb25zTW9kZSwgcmVsYXRpb25zU3VtbWFyeS5rbm93bkNoYXJhY3RlcnMsIHByb2ZpbGVCaW5kaW5ncyxcclxuICAgICAgICAgICAgZXh0ZXJuYWxSZWZyZXNoLCBjaGFyYWN0ZXJOYW1lXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgLy8gZmlsbGluZyBoZWFkZXIgLSBuZWVkIHRhYmxlIGJvZHkgZm9yIGNhbGxiYWNrc1xyXG4gICAgICAgIGNvbnN0IG1ha2VSb3dDYWxsYmFjayA9IFIuY29tcG9zZShhZGRFbChjb250ZW50KSwgbWFrZVJvdyk7XHJcbiAgICAgICAgYWRkRWwocWUoJy5rbm93bi1jaGFyYWN0ZXJzLWxhYmVsJyksIG1ha2VUZXh0KGwxMG4oJ2tub3duLWNoYXJhY3RlcnMnKSkpO1xyXG4gICAgICAgIGNvbnN0IGtub3duQnRuID0gYWRkRWwocWUoJy5hZGQta25vd24tY2hhcmFjdGVyLXJlbGF0aW9uJyksIG1ha2VUZXh0KGdldEwxMG4oJ2NvbW1vbi1hZGQnKSkpO1xyXG4gICAgICAgIGFkZEVsKHFlKCcudW5rbm93bi1jaGFyYWN0ZXJzLWxhYmVsJyksIG1ha2VUZXh0KGwxMG4oJ3Vua25vd24tY2hhcmFjdGVycycpKSk7XHJcbiAgICAgICAgY29uc3QgdW5rbm93bkJ0biA9IGFkZEVsKHFlKCcuYWRkLXVua25vd24tY2hhcmFjdGVyLXJlbGF0aW9uJyksIG1ha2VUZXh0KGdldEwxMG4oJ2NvbW1vbi1hZGQnKSkpO1xyXG4gICAgICAgIGFkZEVsKHFlKCcucHJvZmlsZS1pdGVtLWxhYmVsJyksIG1ha2VUZXh0KGwxMG4oJ3Byb2ZpbGUtaXRlbScpKSk7XHJcbiAgICAgICAgZmlsbENoYXJTZWxlY3RvcihxZSgnLmtub3duLWNoYXJhY3RlcnMtc2VsZWN0JyksIGtub3duQnRuLCBrbm93bk5vUmVscywgY2hhcmFjdGVyTmFtZSwgbWFrZVJvd0NhbGxiYWNrKTtcclxuICAgICAgICBmaWxsQ2hhclNlbGVjdG9yKHFlKCcudW5rbm93bi1jaGFyYWN0ZXJzLXNlbGVjdCcpLCB1bmtub3duQnRuLCB1bmtub3duTm9SZWxzLCBjaGFyYWN0ZXJOYW1lLCBtYWtlUm93Q2FsbGJhY2spO1xyXG5cclxuICAgICAgICAvLyBmaWxsaW5nIHRhYmxlXHJcbiAgICAgICAgY29uc3QgdG9DaGFyYWN0ZXJGaWx0ZXIgPSB0b0NoYXJhY3RlciA9PiAoaXNBZGFwdGF0aW9uc01vZGUgPyB0cnVlIDpcclxuICAgICAgICAgICAgIVIuaXNFbXB0eShmaW5kUmVsKGNoYXJhY3Rlck5hbWUsIHRvQ2hhcmFjdGVyLCByZWxhdGlvbnNTdW1tYXJ5LnJlbGF0aW9ucylbY2hhcmFjdGVyTmFtZV0pKTtcclxuICAgICAgICBjb25zdCBmaW5kUmVsVG1wID0gZmluZFJlbChjaGFyYWN0ZXJOYW1lLCBSLl9fLCByZWxhdGlvbnNTdW1tYXJ5LnJlbGF0aW9ucyk7XHJcbiAgICAgICAgYWRkRWxzKGNvbnRlbnQsIHNob3dDaGFyYWN0ZXJzLmZpbHRlcih0b0NoYXJhY3RlckZpbHRlcikubWFwKHRvQ2hhciA9PiBtYWtlUm93KHRvQ2hhciwgZmluZFJlbFRtcCh0b0NoYXIpKSkpO1xyXG4gICAgICAgIHJldHVybiByZWxhdGlvblRtcGw7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIHJlZnJlc2hQcm9maWxlSXRlbShjb250ZW50LCBwcm9maWxlcykge1xyXG4gICAgICAgIHJldHVybiAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZGF0YUFyciA9IHF1ZXJ5RWxFbHMoY29udGVudCwgJ1t0b0NoYXJhY3Rlcl0nKTtcclxuICAgICAgICAgICAgZGF0YUFyci5mb3JFYWNoKChlbCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY2hhciA9IGdldEF0dHIoZWwsICd0b0NoYXJhY3RlcicpO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWROYW1lID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgZmlsbFByb2ZpbGVJdGVtQ29udGVudChlbCwgc2VsZWN0ZWROYW1lLCBwcm9maWxlc1tjaGFyXVtzZWxlY3RlZE5hbWVdKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlUHJvZmlsZUl0ZW1TZWxlY3RvcihzZWxlY3QxLCBwcm9maWxlU2V0dGluZ3MsIHJlZnJlc2gpIHtcclxuICAgICAgICBzZWxlY3QxID0gJChzZWxlY3QxKTtcclxuICAgICAgICBjb25zdCB0bXBTZWxlY3QgPSBzZWxlY3QxLnNlbGVjdDIoYXJyMlNlbGVjdDIocHJvZmlsZVNldHRpbmdzLm1hcChSLnByb3AoJ25hbWUnKSkuc29ydCgpKSk7XHJcblxyXG4gICAgICAgIHNlbGVjdDEuc2VsZWN0Mih7IHdpZHRoOiAnc3R5bGUnIH0pO1xyXG4gICAgICAgIHRtcFNlbGVjdC5vbignY2hhbmdlJywgcmVmcmVzaCk7XHJcbiAgICAgICAgaWYgKHByb2ZpbGVTZXR0aW5nc1swXSkge1xyXG4gICAgICAgICAgICB0bXBTZWxlY3QudmFsKHByb2ZpbGVTZXR0aW5nc1swXS5uYW1lKS50cmlnZ2VyKCdjaGFuZ2UnKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbWFrZU5ld1JvdyA9IFIuY3VycnkoKFxyXG4gICAgICAgIHByb2ZpbGVzLCBnZXRQcm9maWxlSXRlbVNlbGVjdCwgaXNBZGFwdGF0aW9uc01vZGUsIGtub3duQ2hhcmFjdGVycywgcHJvZmlsZUJpbmRpbmdzLFxyXG4gICAgICAgIGV4dGVybmFsUmVmcmVzaCwgZnJvbUNoYXJhY3RlciwgdG9DaGFyYWN0ZXIsIHJlbFxyXG4gICAgKSA9PiB7XHJcbiAgICAgICAgY29uc3Qgc3RvcmllcyA9IGtub3duQ2hhcmFjdGVyc1t0b0NoYXJhY3Rlcl07XHJcbiAgICAgICAgY29uc3Qgcm93ID0gcW10ZSgnLnJlbGF0aW9uLXJvdy10bXBsJyk7XHJcbiAgICAgICAgY29uc3QgcWUgPSBxZWUocm93KTtcclxuICAgICAgICBhZGRFbChxZSgnLnRvLWNoYXJhY3Rlci1uYW1lJyksIG1ha2VUZXh0KGAke3RvQ2hhcmFjdGVyfS8ke3Byb2ZpbGVCaW5kaW5nc1t0b0NoYXJhY3Rlcl19YCkpO1xyXG4gICAgICAgIGFkZEVsKHFlKCcud2hlcmUtbWVldHMtbGFiZWwnKSwgbWFrZVRleHQobDEwbignd2hlcmUtbWVldHMnKSkpO1xyXG4gICAgICAgIGFkZEVsKHFlKCcud2hlcmUtbWVldHMtY29udGVudCcpLCBtYWtlVGV4dChzdG9yaWVzID09PSB1bmRlZmluZWQgPyAnJyA6IFIua2V5cyhzdG9yaWVzKS5qb2luKCcsICcpKSk7XHJcbiAgICAgICAgc2V0QXR0cihxZSgnW3RvQ2hhcmFjdGVyXScpLCAndG9DaGFyYWN0ZXInLCB0b0NoYXJhY3Rlcik7XHJcbiAgICAgICAgZmlsbFByb2ZpbGVJdGVtQ29udGVudChyb3csIGdldFByb2ZpbGVJdGVtU2VsZWN0KCkudmFsdWUsIHByb2ZpbGVzW3RvQ2hhcmFjdGVyXVtnZXRQcm9maWxlSXRlbVNlbGVjdCgpLnZhbHVlXSk7XHJcbiAgICAgICAgbGlzdGVuKHFlKCdidXR0b24ucmVtb3ZlJyksICdjbGljaycsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBVdGlscy5jb25maXJtKHN0ckZvcm1hdChsMTBuKCdhcmUteW91LXN1cmUtYWJvdXQtcmVsYXRpb24tcmVtb3ZpbmcnKSwgW2Ake2Ake2Zyb21DaGFyYWN0ZXJ9LSR7dG9DaGFyYWN0ZXJ9YH1gXSksICgpID0+IHtcclxuICAgICAgICAgICAgICAgIERCTVMucmVtb3ZlQ2hhcmFjdGVyUmVsYXRpb24oZnJvbUNoYXJhY3RlciwgdG9DaGFyYWN0ZXIsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGV4dGVybmFsUmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCBkaXJlY3RUZXh0ID0gcWUoJy5kaXJlY3QgdGV4dGFyZWEnKTtcclxuICAgICAgICBkaXJlY3RUZXh0LnZhbHVlID0gcmVsW2Zyb21DaGFyYWN0ZXJdO1xyXG4gICAgICAgIHNldEF0dHIoZGlyZWN0VGV4dCwgJ3BsYWNlaG9sZGVyJywgTDEwbi5mb3JtYXQoJ2JyaWVmaW5ncycsICdyZWxhdGlvbi1mcm9tLXRvJywgW2Zyb21DaGFyYWN0ZXIsIHRvQ2hhcmFjdGVyXSkpO1xyXG4gICAgICAgIGxpc3RlbihkaXJlY3RUZXh0LCAnY2hhbmdlJywgKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMuc2V0Q2hhcmFjdGVyUmVsYXRpb25UZXh0KFxyXG4gICAgICAgICAgICAgICAgZnJvbUNoYXJhY3RlciwgdG9DaGFyYWN0ZXIsIGZyb21DaGFyYWN0ZXIsIGV2ZW50LnRhcmdldC52YWx1ZSxcclxuICAgICAgICAgICAgICAgIFV0aWxzLnByb2Nlc3NFcnJvcigpXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIENvbnN0YW50cy5yZWxhdGlvbkVzc2VuY2VzLmZvckVhY2goKG5hbWUpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgYnRuID0gcWUoYC4ke25hbWV9YCk7XHJcbiAgICAgICAgICAgICQoYnRuKS50b29sdGlwKHtcclxuICAgICAgICAgICAgICAgIHRpdGxlOiBMMTBuLmZvcm1hdCgnYnJpZWZpbmdzJywgYCR7bmFtZX1gLCBbZnJvbUNoYXJhY3RlciwgdG9DaGFyYWN0ZXJdKSxcclxuICAgICAgICAgICAgICAgIHBsYWNlbWVudDogJ3RvcCdcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGxldCBhdHRyTmFtZSA9IG5hbWU7XHJcbiAgICAgICAgICAgIGlmIChyZWwuc3RhcnRlciAhPT0gZnJvbUNoYXJhY3Rlcikge1xyXG4gICAgICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdzdGFydGVyVG9FbmRlcicpIGF0dHJOYW1lID0gJ2VuZGVyVG9TdGFydGVyJztcclxuICAgICAgICAgICAgICAgIGlmIChuYW1lID09PSAnZW5kZXJUb1N0YXJ0ZXInKSBhdHRyTmFtZSA9ICdzdGFydGVyVG9FbmRlcic7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihidG4sICdidG4tcHJpbWFyeScsIHJlbC5lc3NlbmNlLmluZGV4T2YoYXR0ck5hbWUpICE9PSAtMSk7XHJcbiAgICAgICAgICAgIGxpc3RlbihidG4sICdjbGljaycsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgREJNUy5zZXRSZWxhdGlvbkVzc2VuY2VTdGF0dXMoZnJvbUNoYXJhY3RlciwgdG9DaGFyYWN0ZXIsIGF0dHJOYW1lLCAhaGFzQ2xhc3MoZXZlbnQudGFyZ2V0LCAnYnRuLXByaW1hcnknKSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgdG9nZ2xlQ2xhc3MoZXZlbnQudGFyZ2V0LCAnYnRuLXByaW1hcnknKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3Qgb3JpZ2luVGV4dCA9IHFlKCcub3JpZ2luIHRleHRhcmVhJyk7XHJcbiAgICAgICAgb3JpZ2luVGV4dC52YWx1ZSA9IHJlbC5vcmlnaW47XHJcbiAgICAgICAgc2V0QXR0cihvcmlnaW5UZXh0LCAncGxhY2Vob2xkZXInLCBsMTBuKCdyZWxhdGlvbi1vcmlnaW4nKSk7XHJcbiAgICAgICAgbGlzdGVuKG9yaWdpblRleHQsICdjaGFuZ2UnLCAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgREJNUy5zZXRPcmlnaW5SZWxhdGlvblRleHQoZnJvbUNoYXJhY3RlciwgdG9DaGFyYWN0ZXIsIGV2ZW50LnRhcmdldC52YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCByZXZlcnNlVGV4dCA9IHFlKCcucmV2ZXJzZSB0ZXh0YXJlYScpO1xyXG4gICAgICAgIHJldmVyc2VUZXh0LnZhbHVlID0gcmVsW3RvQ2hhcmFjdGVyXTtcclxuICAgICAgICBzZXRBdHRyKHJldmVyc2VUZXh0LCAncGxhY2Vob2xkZXInLCBMMTBuLmZvcm1hdCgnYnJpZWZpbmdzJywgJ3JlbGF0aW9uLWZyb20tdG8nLCBbdG9DaGFyYWN0ZXIsIGZyb21DaGFyYWN0ZXJdKSk7XHJcbiAgICAgICAgbGlzdGVuKHJldmVyc2VUZXh0LCAnY2hhbmdlJywgKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMuc2V0Q2hhcmFjdGVyUmVsYXRpb25UZXh0KFxyXG4gICAgICAgICAgICAgICAgZnJvbUNoYXJhY3RlciwgdG9DaGFyYWN0ZXIsIHRvQ2hhcmFjdGVyLFxyXG4gICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LnZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCBkaXJlY3RDaGVja2VkID0gcmVsLnN0YXJ0ZXIgPT09IGZyb21DaGFyYWN0ZXIgPyByZWwuc3RhcnRlclRleHRSZWFkeSA6IHJlbC5lbmRlclRleHRSZWFkeTtcclxuICAgICAgICBmaWxsRmluaXNoZWRCdXR0b24oXHJcbiAgICAgICAgICAgIHFlKCcuZGlyZWN0IC5maW5pc2hlZCcpLCBKU09OLnN0cmluZ2lmeShbZnJvbUNoYXJhY3RlciwgdG9DaGFyYWN0ZXJdKSwgZnJvbUNoYXJhY3RlcixcclxuICAgICAgICAgICAgdG9DaGFyYWN0ZXIsIGZyb21DaGFyYWN0ZXIsIGRpcmVjdENoZWNrZWQsIGRpcmVjdFRleHRcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICBjb25zdCByZXZlcnNlQ2hlY2tlZCA9IHJlbC5zdGFydGVyID09PSB0b0NoYXJhY3RlciA/IHJlbC5zdGFydGVyVGV4dFJlYWR5IDogcmVsLmVuZGVyVGV4dFJlYWR5O1xyXG4gICAgICAgIGZpbGxGaW5pc2hlZEJ1dHRvbihcclxuICAgICAgICAgICAgcWUoJy5yZXZlcnNlIC5maW5pc2hlZCcpLCBKU09OLnN0cmluZ2lmeShbdG9DaGFyYWN0ZXIsIGZyb21DaGFyYWN0ZXJdKSwgZnJvbUNoYXJhY3RlcixcclxuICAgICAgICAgICAgdG9DaGFyYWN0ZXIsIHRvQ2hhcmFjdGVyLCByZXZlcnNlQ2hlY2tlZCwgcmV2ZXJzZVRleHRcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICBpZiAoIWlzQWRhcHRhdGlvbnNNb2RlKSB7XHJcbiAgICAgICAgICAgIHJlbW92ZUNsYXNzKHFlKCcuZGlyZWN0JyksICdjb2wteHMtMycpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhxZSgnLmRpcmVjdCcpLCAnY29sLXhzLTknKTtcclxuICAgICAgICAgICAgYWRkQ2xhc3MocWUoJy5vcmlnaW4nKSwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhxZSgnLnJldmVyc2UnKSwgJ2hpZGRlbicpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBMMTBuLmxvY2FsaXplU3RhdGljKHJvdyk7XHJcblxyXG4gICAgICAgIHJldHVybiByb3c7XHJcbiAgICB9KTtcclxuXHJcbiAgICBmdW5jdGlvbiBmaWxsRmluaXNoZWRCdXR0b24oYnV0dG9uLCBpZCwgZnJvbUNoYXJhY3RlciwgdG9DaGFyYWN0ZXIsIGNoYXJhY3RlciwgY2hlY2tlZCwgdGV4dGFyZWEpIHtcclxuICAgICAgICBzZXRDbGFzc0lmKGJ1dHRvbiwgJ2J0bi1wcmltYXJ5JywgY2hlY2tlZCk7XHJcbiAgICAgICAgVXRpbHMuZW5hYmxlRWwodGV4dGFyZWEsICFjaGVja2VkKTtcclxuICAgICAgICBidXR0b24uaWQgPSBpZDtcclxuICAgICAgICBsaXN0ZW4oYnV0dG9uLCAnY2xpY2snLCAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSAhaGFzQ2xhc3MoYnV0dG9uLCAnYnRuLXByaW1hcnknKTtcclxuICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihidXR0b24sICdidG4tcHJpbWFyeScsIG5ld1ZhbHVlKTtcclxuICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwodGV4dGFyZWEsICFuZXdWYWx1ZSk7XHJcbiAgICAgICAgICAgIERCTVMuc2V0UmVsYXRpb25SZWFkeVN0YXR1cyhmcm9tQ2hhcmFjdGVyLCB0b0NoYXJhY3RlciwgY2hhcmFjdGVyLCBuZXdWYWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGZpbGxQcm9maWxlSXRlbUNvbnRlbnQoZWwsIHByb2ZpbGVJdGVtTmFtZSwgcHJvZmlsZUl0ZW1WYWx1ZSkge1xyXG4gICAgICAgIGFkZEVsKGNsZWFyRWwocWVlKGVsLCAnLnByb2ZpbGUtaXRlbS1uYW1lJykpLCBtYWtlVGV4dChwcm9maWxlSXRlbU5hbWUpKTtcclxuICAgICAgICBhZGRFbChjbGVhckVsKHFlZShlbCwgJy5wcm9maWxlLWl0ZW0tdmFsdWUnKSksIG1ha2VUZXh0KHByb2ZpbGVJdGVtVmFsdWUpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBmaWxsQ2hhclNlbGVjdG9yKHNlbGVjdDEsIGJ1dHRvbiwgZGF0YSwgZnJvbUNoYXJhY3RlciwgbWFrZVJvd0NhbGxiYWNrKSB7XHJcbiAgICAgICAgc2VsZWN0MSA9ICQoc2VsZWN0MSk7XHJcbiAgICAgICAgY29uc3QgdG1wU2VsZWN0ID0gc2VsZWN0MS5zZWxlY3QyKGdldFNlbGVjdDJEYXRhKGRhdGEpKTtcclxuICAgICAgICBzZWxlY3QxLnNlbGVjdDIoeyB3aWR0aDogJ3N0eWxlJyB9KTtcclxuICAgICAgICBsaXN0ZW4oYnV0dG9uLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRvQ2hhcmFjdGVyID0gc2VsZWN0MVswXS52YWx1ZTtcclxuICAgICAgICAgICAgREJNUy5jcmVhdGVDaGFyYWN0ZXJSZWxhdGlvbihmcm9tQ2hhcmFjdGVyLCB0b0NoYXJhY3RlciwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0Q2hhcmFjdGVyUmVsYXRpb24oZnJvbUNoYXJhY3RlciwgdG9DaGFyYWN0ZXIsIChlcnIyLCByZWwpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgbWFrZVJvd0NhbGxiYWNrKHNlbGVjdDFbMF0udmFsdWUsIHJlbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEuZmlsdGVyKFIuY29tcG9zZShSLm5vdCwgUi5lcXVhbHMoc2VsZWN0MVswXS52YWx1ZSksIFIucHJvcCgndmFsdWUnKSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNsZWFyRWwoc2VsZWN0MVswXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0MS5zZWxlY3QyKGdldFNlbGVjdDJEYXRhKGRhdGEpKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufSkodGhpcy5SZWxhdGlvbnNQcmV2aWV3ID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1LTIwMTggVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHJvb3QgPSAnLmdlYXJzLXRhYic7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG4gICAgY29uc3QgbDEwbiA9IEwxMG4uZ2V0KCdnZWFycycpO1xyXG4gICAgc3RhdGUubm9kZXNEYXRhc2V0ID0gbmV3IHZpcy5EYXRhU2V0KCk7XHJcbiAgICBzdGF0ZS5lZGdlc0RhdGFzZXQgPSBuZXcgdmlzLkRhdGFTZXQoKTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIHN0YXRlLmFkZE5vZGVEaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhyb290LCB1cGRhdGVOb2RlLCB7XHJcbiAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ2FkZC1vci1lZGl0LW5vZGUtYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnZ2VhcnMtYWRkLW5vZGUnLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1zYXZlJyxcclxuICAgICAgICAgICAgb25DYW5jZWw6IG9uTm9kZUNhbmNlbFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHN0YXRlLmVkaXROb2RlRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2cocm9vdCwgdXBkYXRlTm9kZSwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdhZGQtb3ItZWRpdC1ub2RlLWJvZHknLFxyXG4gICAgICAgICAgICBkaWFsb2dUaXRsZTogJ2dlYXJzLWVkaXQtbm9kZScsXHJcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLXNhdmUnLFxyXG4gICAgICAgICAgICBvbkNhbmNlbDogb25Ob2RlQ2FuY2VsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgc3RhdGUucmVuYW1lRWRnZURpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHJvb3QsIHJlbmFtZUVkZ2UsIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnbW9kYWwtcHJvbXB0LWJvZHknLFxyXG4gICAgICAgICAgICBkaWFsb2dUaXRsZTogJ2dlYXJzLXJlbmFtZS1lZGdlJyxcclxuICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tc2F2ZScsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgY29uZmlndXJlTmV0d29ya0RpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHJvb3QsIChkaWFsb2cpID0+ICgpID0+IGRpYWxvZy5oaWRlRGxnKCksIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnY29uZmlnLWlubmVyLWJvZHknLFxyXG4gICAgICAgICAgICBkaWFsb2dUaXRsZTogJ2dlYXJzLWNvbmZpZ3VyZS1uZXR3b3JrJyxcclxuICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tY2xvc2UnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGFkZENsYXNzKHFlZShjb25maWd1cmVOZXR3b3JrRGlhbG9nLCAnLm1vZGFsLWRpYWxvZycpLCAnZ2VhcnMtY29uZmlnLWRpYWxvZycpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHF1ZXJ5RWwoYCR7cm9vdH0gLmN1c3RvbS1waHlzaWNzLXNldHRpbmdzYCkudmFsdWUgPSAnJztcclxuICAgICAgICBcclxuLy8gICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5ub2Rlc1RleHQnKS52YWx1ZSA9IGNoYXJFeGFtcGxlO1xyXG4vLyAgICAgICAgc2V0QXR0cihkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcubm9kZXNUZXh0JyksJ3Jvd3MnLCBjaGFyRXhhbXBsZS5zcGxpdCgnXFxuJykubGVuZ3RoKTtcclxuLy8gICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5lZGdlc1RleHQnKS52YWx1ZSA9IGVkZ2VzRXhhbXBsZTtcclxuLy8gICAgICAgIHNldEF0dHIoZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmVkZ2VzVGV4dCcpLCdyb3dzJywgZWRnZXNFeGFtcGxlLnNwbGl0KCdcXG4nKS5sZW5ndGgpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxpc3RlbihxZShgJHtyb290fSAuZHJhdy1idXR0b25gKSwgJ2NsaWNrJywgZXhwb3J0cy5yZWZyZXNoKTtcclxuICAgICAgICBsaXN0ZW4ocWUoYCR7cm9vdH0gLmdldC1pbWFnZS1idXR0b25gKSwgJ2NsaWNrJywgZ2V0SW1hZ2UpO1xyXG4gICAgICAgIGxpc3RlbihxZShgJHtyb290fSAuZG93bmxvYWQtYnV0dG9uYCksICdjbGljaycsIGRvd25sb2FkQ3N2KTtcclxuICAgICAgICBsaXN0ZW4ocWUoYCR7cm9vdH0gLmRvd25sb2FkLWpzb24tYnV0dG9uYCksICdjbGljaycsIGRvd25sb2FkSlNPTik7XHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9IC5kb3dubG9hZC1ncmFwaG1sLWJ1dHRvbmApLCAnY2xpY2snLCBkb3dubG9hZFlFRCk7XHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9IC5jbGVhci1idXR0b25gKSwgJ2NsaWNrJywgY2xlYXJOZXR3b3JrKTtcclxuICAgICAgICBcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fSAucGh5c2ljcy1zZXR0aW5ncy1idXR0b25gKSwgJ2NsaWNrJywgKCkgPT4gY29uZmlndXJlTmV0d29ya0RpYWxvZy5zaG93RGxnKCkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9IC5zZWFyY2gtbm9kZWApLCAnY2hhbmdlJywgb25Ob2RlRm9jdXMpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9IC5jdXN0b20tcGh5c2ljcy1zZXR0aW5ncy1idXR0b25gKSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBvcHRpb25zID0gcXVlcnlFbChgJHtyb290fSAuY3VzdG9tLXBoeXNpY3Mtc2V0dGluZ3NgKS52YWx1ZTtcclxuICAgICAgICAgICAgaWYob3B0aW9ucy50cmltKCkgPT09ICcnKXtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZihDb21tb25VdGlscy5zdGFydHNXaXRoKG9wdGlvbnMsICd2YXIgb3B0aW9ucyA9ICcpKXtcclxuICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zLnN1YnN0cmluZygndmFyIG9wdGlvbnMgPSAnLmxlbmd0aCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdHJ5e1xyXG4gICAgICAgICAgICAgICAgb3B0aW9ucyA9IEpTT04ucGFyc2Uob3B0aW9ucyk7XHJcbiAgICAgICAgICAgIH1jYXRjaChlKXtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hbGVydChsMTBuKCdlcnJvci1vbi1zZXR0aW5ncy1sb2FkaW5nJykpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHN0YXRlLm5ldHdvcmsuc2V0T3B0aW9ucyhvcHRpb25zKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBxdWVyeUVsKGAke3Jvb3R9IC5waHlzaWNzLWVuYWJsZWQtY2hlY2tib3hgKS5jaGVja2VkID0gZmFsc2U7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0gLnBoeXNpY3MtZW5hYmxlZC1jaGVja2JveGApLCAnY2hhbmdlJywgKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMuc2V0R2VhcnNQaHlzaWNzRW5hYmxlZChldmVudC50YXJnZXQuY2hlY2tlZCwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIHN0YXRlLm5ldHdvcmsuc2V0T3B0aW9ucyh7XHJcbiAgICAgICAgICAgICAgICAgICAgXCJwaHlzaWNzXCI6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXCJlbmFibGVkXCI6IGV2ZW50LnRhcmdldC5jaGVja2VkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBcIm1pblZlbG9jaXR5XCI6IDAuNzVcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBxdWVyeUVsKGAke3Jvb3R9IC5zaG93LW5vdGVzLWNoZWNrYm94YCkuY2hlY2tlZCA9IGZhbHNlO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9IC5zaG93LW5vdGVzLWNoZWNrYm94YCksICdjaGFuZ2UnLCAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgREJNUy5zZXRHZWFyc1Nob3dOb3Rlc0VuYWJsZWQoZXZlbnQudGFyZ2V0LmNoZWNrZWQsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcXVlcnlFbChgJHtyb290fSAuYmlnLXBpY3R1cmUtY2hlY2tib3hgKS5jaGVja2VkID0gZmFsc2U7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0gLmJpZy1waWN0dXJlLWNoZWNrYm94YCksICdjaGFuZ2UnLCAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihxdWVyeUVsKGAke3Jvb3R9IC5teW5ldHdvcmsgPiBkaXZgKSwnYmlnLXBpY3R1cmUnLGV2ZW50LnRhcmdldC5jaGVja2VkKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBzdGF0ZS5ub2Rlc0RhdGFzZXQub24oJyonLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGZpbGxTZWFyY2hTZWxlY3QoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgREJNUy5nZXRBbGxHZWFyc0RhdGEoKGVyciwgZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBxdWVyeUVsKGAke3Jvb3R9IC5zaG93LW5vdGVzLWNoZWNrYm94YCkuY2hlY2tlZCA9IGRhdGEuc2V0dGluZ3Muc2hvd05vdGVzO1xyXG4gICAgICAgICAgICBxdWVyeUVsKGAke3Jvb3R9IC5waHlzaWNzLWVuYWJsZWQtY2hlY2tib3hgKS5jaGVja2VkID0gZGF0YS5zZXR0aW5ncy5waHlzaWNzRW5hYmxlZDtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGRhdGEubm9kZXMuZm9yRWFjaChub2RlID0+IHtcclxuICAgICAgICAgICAgICAgIG5vZGUubGFiZWwgPSBtYWtlTGFiZWwobm9kZS5uYW1lLCBub2RlLm5vdGVzKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHN0YXRlLm5vZGVzRGF0YXNldC5jbGVhcigpO1xyXG4gICAgICAgICAgICBzdGF0ZS5ub2Rlc0RhdGFzZXQuYWRkKGRhdGEubm9kZXMpO1xyXG4gICAgICAgICAgICBzdGF0ZS5lZGdlc0RhdGFzZXQuY2xlYXIoKTtcclxuICAgICAgICAgICAgc3RhdGUuZWRnZXNEYXRhc2V0LmFkZChkYXRhLmVkZ2VzKTtcclxuICAgICAgICAgICAgZHJhd05ldHdvcmsoKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIC8vIGNyZWF0ZSBhIG5ldHdvcmtcclxuICAgIGZ1bmN0aW9uIGRyYXdOZXR3b3JrKCkge1xyXG4gICAgICBjb25zdCBjb250YWluZXIgPSBxZShgJHtyb290fSAubXluZXR3b3JrYCk7XHJcbiAgICAgIGNsZWFyRWwocXVlcnlFbChgJHtyb290fSAuY29uZmlnSW5uZXJgKSk7XHJcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgICAgbG9jYWxlOiBMMTBuLmdldExvY2FsZSgpLFxyXG4gICAgICAgIGxvY2FsZXM6IENvbnN0YW50cy52aXNMb2NhbGVzLFxyXG4gICAgICAgIG1hbmlwdWxhdGlvbjoge1xyXG4gICAgICAgICAgICBhZGROb2RlOiBmdW5jdGlvbiAoZGF0YSwgY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgIGRhdGEubGFiZWwgPSAnJztcclxuICAgICAgICAgICAgICAgIGRhdGEubmFtZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBxZWUoc3RhdGUuYWRkTm9kZURpYWxvZywgJy5ub2RlLWlkJykudmFsdWUgPSBkYXRhLmlkO1xyXG4gICAgICAgICAgICAgICAgcWVlKHN0YXRlLmFkZE5vZGVEaWFsb2csICcubm9kZS1uYW1lJykudmFsdWUgPSBkYXRhLm5hbWU7XHJcbiAgICAgICAgICAgICAgICBxZWUoc3RhdGUuYWRkTm9kZURpYWxvZywgJy5ub2RlLWdyb3VwJykudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgIHFlZShzdGF0ZS5hZGROb2RlRGlhbG9nLCAnLm5vZGUtbm90ZXMnKS52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5ub2RlRGF0YSA9IGRhdGE7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5ub2RlQ2FsbGJhY2sgPSBjYWxsYmFjaztcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgc3RhdGUuYWRkTm9kZURpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGVkaXROb2RlOiBmdW5jdGlvbiAoZGF0YSwgY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgIHFlZShzdGF0ZS5lZGl0Tm9kZURpYWxvZywgJy5ub2RlLWlkJykudmFsdWUgPSBkYXRhLmlkO1xyXG4gICAgICAgICAgICAgICAgcWVlKHN0YXRlLmVkaXROb2RlRGlhbG9nLCAnLm5vZGUtbmFtZScpLnZhbHVlID0gZGF0YS5uYW1lO1xyXG4gICAgICAgICAgICAgICAgcWVlKHN0YXRlLmVkaXROb2RlRGlhbG9nLCAnLm5vZGUtZ3JvdXAnKS52YWx1ZSA9IGRhdGEuZ3JvdXA7XHJcbiAgICAgICAgICAgICAgICBxZWUoc3RhdGUuZWRpdE5vZGVEaWFsb2csICcubm9kZS1ub3RlcycpLnZhbHVlID0gZGF0YS5ub3RlcztcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgc3RhdGUubm9kZURhdGEgPSBkYXRhO1xyXG4gICAgICAgICAgICAgICAgc3RhdGUubm9kZUNhbGxiYWNrID0gZnVuY3Rpb24oZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfS5iaW5kKHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5lZGl0Tm9kZURpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGFkZEVkZ2U6IGZ1bmN0aW9uIChkYXRhLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgZGF0YS5hcnJvd3MgPSd0byc7XHJcbiAgICAgICAgICAgICAgICBkYXRhLmxhYmVsID0nJztcclxuICAgICAgICAgICAgICAgIGlmIChkYXRhLmZyb20gPT0gZGF0YS50bykge1xyXG4gICAgICAgICAgICAgICAgICAgIFV0aWxzLmNvbmZpcm0obDEwbignZG8teW91LXdhbnQtdG8tY29ubmVjdC1ub2RlLXRvLWl0c2VsZicpLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sICgpID0+IGNhbGxiYWNrKCkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBlZGl0RWRnZTpmdW5jdGlvbiAoZGF0YSwgY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgc3RvcmVEYXRhKCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGRlbGV0ZU5vZGU6ZnVuY3Rpb24gKGRhdGEsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhkYXRhKTtcclxuICAgICAgICAgICAgICAgIHN0b3JlRGF0YSgpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBkZWxldGVFZGdlOmZ1bmN0aW9uIChkYXRhLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2soZGF0YSk7XHJcbiAgICAgICAgICAgICAgICBzdG9yZURhdGEoKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIHBoeXNpY3M6IHtcclxuICAgICAgICAgIGVuYWJsZWQ6IHF1ZXJ5RWwoYCR7cm9vdH0gLnBoeXNpY3MtZW5hYmxlZC1jaGVja2JveGApLmNoZWNrZWQsXHJcbiAgICAgICAgICBzdGFiaWxpemF0aW9uOiBmYWxzZVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgXCJlZGdlc1wiOiB7XHJcbiAgICAgICAgICBcInNtb290aFwiOiB7XHJcbiAgICAgICAgICAgIFwidHlwZVwiOiBcImRpc2NyZXRlXCIsXHJcbiAgICAgICAgICAgIFwiZm9yY2VEaXJlY3Rpb25cIjogXCJub25lXCJcclxuICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGNvbmZpZ3VyZToge1xyXG4gICAgICAgICAgZmlsdGVyOmZ1bmN0aW9uIChvcHRpb24sIHBhdGgpIHtcclxuICAgICAgICAgICAgaWYgKHBhdGguaW5kZXhPZigncGh5c2ljcycpICE9PSAtMSkge1xyXG4gICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChwYXRoLmluZGV4T2YoJ3Ntb290aCcpICE9PSAtMSB8fCBvcHRpb24gPT09ICdzbW9vdGgnKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIGNvbnRhaW5lcjogcWUoYCR7cm9vdH0gLmNvbmZpZ0lubmVyYClcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIGNvbnN0IGRhdGEgPSB7XHJcbiAgICAgICAgbm9kZXM6IHN0YXRlLm5vZGVzRGF0YXNldCxcclxuICAgICAgICBlZGdlczogc3RhdGUuZWRnZXNEYXRhc2V0XHJcbiAgICAgIH07XHJcbiAgICAgIHN0YXRlLm5ldHdvcmsgPSBuZXcgdmlzLk5ldHdvcmsoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zKTtcclxuICAgICAgc3RhdGUubmV0d29yay5vbignc2VsZWN0RWRnZScsIHNob3dFZGdlTGFiZWxFZGl0b3IpO1xyXG4gICAgICBzdGF0ZS5uZXR3b3JrLm9uKCdkcmFnRW5kJywgKHBhcmFtcykgPT4gc3RvcmVEYXRhKCkpO1xyXG4gICAgICBzdGF0ZS5uZXR3b3JrLm9uKCdzdGFiaWxpemVkJywgKHBhcmFtcykgPT4gc3RvcmVEYXRhKCkpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBzdG9yZURhdGEoY2FsbGJhY2spe1xyXG4gICAgICAgIERCTVMuc2V0R2VhcnNEYXRhKGV4cG9ydE5ldHdvcmsoKSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBpZihjYWxsYmFjaykgY2FsbGJhY2soKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgZnVuY3Rpb24gZXhwb3J0TmV0d29yaygpIHtcclxuICAgICAgICBzdGF0ZS5uZXR3b3JrLnN0b3JlUG9zaXRpb25zKCk7XHJcbiAgICAgICAgY29uc3Qgbm9kZVBvc2l0aW9ucyA9IHN0YXRlLm5ldHdvcmsuZ2V0UG9zaXRpb25zKCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc29sZS5sb2cobm9kZVBvc2l0aW9ucyk7XHJcbiAgICAgICAgY29uc3Qgbm9kZXMgPSBSLmNsb25lKHN0YXRlLm5vZGVzRGF0YXNldC5nZXQoKSk7XHJcbiAgICAgICAgY29uc3QgZWRnZXMgPSBzdGF0ZS5lZGdlc0RhdGFzZXQuZ2V0KCk7XHJcbiAgICAgICAgbm9kZXMuZm9yRWFjaChub2RlID0+IGRlbGV0ZSBub2RlLmNvbG9yKTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBub2RlcyxcclxuICAgICAgICAgICAgZWRnZXNcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBpbXBvcnROZXR3b3JrKGRhdGEpIHtcclxuICAgICAgICBjb25zdCB7bm9kZXMsIGVkZ2VzfSA9IGRhdGE7XHJcbiAgICAgICAgc3RhdGUubm9kZXNEYXRhc2V0LmNsZWFyKCk7XHJcbiAgICAgICAgc3RhdGUuZWRnZXNEYXRhc2V0LmNsZWFyKCk7XHJcbiAgICAgICAgc3RhdGUubm9kZXNEYXRhc2V0LnVwZGF0ZShub2Rlcyk7XHJcbiAgICAgICAgc3RhdGUuZWRnZXNEYXRhc2V0LnVwZGF0ZShlZGdlcyk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2hvd0VkZ2VMYWJlbEVkaXRvcihwYXJhbXMpIHtcclxuICAgICAgICBpZiAocGFyYW1zLmVkZ2VzLmxlbmd0aCAhPT0gMCAmJiBwYXJhbXMubm9kZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVkZ2UgPSBzdGF0ZS5lZGdlc0RhdGFzZXQuZ2V0KHBhcmFtcy5lZGdlc1swXSk7XHJcbiAgICAgICAgICAgIHFlZShzdGF0ZS5yZW5hbWVFZGdlRGlhbG9nLCAnLmVudGl0eS1pbnB1dCcpLnZhbHVlID0gZWRnZS5sYWJlbCB8fCAnJztcclxuICAgICAgICAgICAgc3RhdGUuZWRnZURhdGEgPSBlZGdlO1xyXG4gICAgICAgICAgICBzdGF0ZS5lZGdlQ2FsbGJhY2sgPSAoZWRnZSkgPT4gc3RhdGUuZWRnZXNEYXRhc2V0LnVwZGF0ZShlZGdlKTtcclxuICAgICAgICAgICAgc3RhdGUucmVuYW1lRWRnZURpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VMYWJlbChuYW1lLCBub3Rlcyl7XHJcbiAgICAgIGxldCBsYWJlbCA9IHByZXBhcmVTdHIobmFtZSk7IFxyXG4gICAgICBpZihxdWVyeUVsKGAke3Jvb3R9IC5zaG93LW5vdGVzLWNoZWNrYm94YCkuY2hlY2tlZCl7XHJcbiAgICAgICAgbGFiZWwgKz0gKG5vdGVzLnRyaW0oKSAhPT0gJycgPyAoJ1xcblxcbicgKyBwcmVwYXJlU3RyKG5vdGVzKSkgOiAnJyk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGxhYmVsO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHByZXBhcmVTdHIodGV4dCkge1xyXG4gICAgICAgIGNvbnN0IG1heFN0ckxlbmd0aCA9IDMwO1xyXG4gICAgICAgIHJldHVybiB0ZXh0LnNwbGl0KCdcXG4nKS5tYXAoKHN0ciwgaSwgc3RyaW5ncykgPT4ge1xyXG4gICAgICAgICAgICBsZXQgY291bnRlciA9IDA7XHJcbiAgICAgICAgICAgIGNvbnN0IHdvcmRzID0gc3RyLnNwbGl0KCcgJyk7XHJcbiAgICAgICAgICAgIHJldHVybiB3b3Jkcy5yZWR1Y2UoKGFjYywgd29yZCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYoKGNvdW50ZXIgKyB3b3JkLmxlbmd0aCArIDEpIDw9ICBtYXhTdHJMZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBhY2MgKz0gd29yZCArICcgJztcclxuICAgICAgICAgICAgICAgICAgICBjb3VudGVyICs9IHdvcmQubGVuZ3RoICsgMTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWNjICs9ICdcXG4nICsgd29yZCArICcgJztcclxuICAgICAgICAgICAgICAgICAgICBjb3VudGVyID0gMDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBhY2M7XHJcbiAgICAgICAgICAgIH0sICcnKTtcclxuICAgICAgICB9KS5qb2luKCdcXG4nKTtcclxuICAgICAgICBcclxuICAgICAgICBcclxuLy8gICAgICAgIHJldHVybiB0ZXh0LnNwbGl0KCdcXG4nKS5tYXAoUi5zcGxpdEV2ZXJ5KDMwKSkubWFwKFIuam9pbignLVxcbicpKS5qb2luKCdcXG4nKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0SW1hZ2UoZXZlbnQpe1xyXG4gICAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiY2FudmFzXCIpO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgY29udGV4dCA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIik7XHJcbiAgICAgIGNvbnN0IHcgPSBjYW52YXMud2lkdGg7XHJcbiAgICAgIGNvbnN0IGggPSBjYW52YXMuaGVpZ2h0O1xyXG4gICAgICBcclxuICAgICAgY29udGV4dC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb24gPSBcImRlc3RpbmF0aW9uLW92ZXJcIjtcclxuICAgICAgY29udGV4dC5maWxsU3R5bGUgPSBcIiNmZmZmZmZcIjtcclxuICAgICAgY29udGV4dC5maWxsUmVjdCgwLDAsdyxoKTtcclxuICAgICAgXHJcbiAgICAgIHNldEF0dHIoZXZlbnQudGFyZ2V0LCAnZG93bmxvYWQnLCBGaWxlVXRpbHMubWFrZUZpbGVOYW1lKCdnZWFycycsJ3BuZycpKTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IGltZyAgICA9IGNhbnZhcy50b0RhdGFVUkwoXCJpbWFnZS9wbmdcIik7XHJcbiAgICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLmxpbmtcIik7XHJcbiAgICAgIGV2ZW50LnRhcmdldC5ocmVmID0gaW1nO1xyXG4gICAgICBkcmF3TmV0d29yaygpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNsZWFyTmV0d29yaygpe1xyXG4gICAgICAgIFV0aWxzLmNvbmZpcm0obDEwbignY29uZmlybS1jbGVhcmluZycpLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHN0YXRlLm5vZGVzRGF0YXNldC5jbGVhcigpO1xyXG4gICAgICAgICAgICBzdGF0ZS5lZGdlc0RhdGFzZXQuY2xlYXIoKTtcclxuICAgICAgICAgICAgc3RvcmVEYXRhKGV4cG9ydHMucmVmcmVzaCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlTm9kZVRleHRBcmVhKCl7XHJcbiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5ub2Rlc1RleHQnKS52YWx1ZSA9IHN0YXRlLm5vZGVzRGF0YXNldC5tYXAoKG5vZGUpID0+IFtub2RlLm5hbWUsIG5vZGUuZ3JvdXAsIG5vZGUubm90ZXNdLmpvaW4oJ1xcdCcpKS5qb2luKCdcXG4nKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVFZGdlVGV4dEFyZWEoKXtcclxuICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmVkZ2VzVGV4dCcpLnZhbHVlID0gc3RhdGUuZWRnZXNEYXRhc2V0Lm1hcCgoZWRnZSkgPT4gW3N0YXRlLm5vZGVzRGF0YXNldC5nZXQoZWRnZS5mcm9tKS5uYW1lLCBlZGdlLmxhYmVsLCBcclxuICAgICAgICAgIHN0YXRlLm5vZGVzRGF0YXNldC5nZXQoZWRnZS50bykubmFtZV0uam9pbignXFx0JykpLmpvaW4oJ1xcbicpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGZpbGxTZWFyY2hTZWxlY3QoKXtcclxuICAgICAgY29uc3QgYXJyID0gc3RhdGUubm9kZXNEYXRhc2V0Lm1hcCgobm9kZSkgPT4gKHtuYW1lOiBub2RlLm5hbWUsIHZhbHVlOiBub2RlLmlkfSkpO1xyXG4gICAgICBhcnIuc29ydChDb21tb25VdGlscy5jaGFyT3JkQUZhY3RvcnkoYSA9PiBhLm5hbWUudG9Mb3dlckNhc2UoKSkpO1xyXG4gICAgICBmaWxsU2VsZWN0b3IoY2xlYXJFbChxdWVyeUVsKCcuc2VhcmNoLW5vZGUnKSksIGFycik7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZG93bmxvYWRDc3YoKSB7XHJcbiAgICAgICAgY29uc3QgYXJyID0gc3RhdGUubm9kZXNEYXRhc2V0Lm1hcCgobm9kZSkgPT4gW25vZGUubmFtZSwgbm9kZS5ncm91cCwgbm9kZS5ub3Rlc10pO1xyXG4gICAgICAgIGNvbnN0IGFycjIgPSBzdGF0ZS5lZGdlc0RhdGFzZXQubWFwKChlZGdlKSA9PiBbc3RhdGUubm9kZXNEYXRhc2V0LmdldChlZGdlLmZyb20pLm5hbWUsIGVkZ2UubGFiZWwsIFxyXG4gICAgICAgICAgc3RhdGUubm9kZXNEYXRhc2V0LmdldChlZGdlLnRvKS5uYW1lXSk7XHJcbiAgICAgICAgICBcclxuICAgICAgICBGaWxlVXRpbHMuYXJyMmQyQ3N2KGFyci5jb25jYXQoW1snJ11dKS5jb25jYXQoYXJyMiksICdnZWFycycpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGRvd25sb2FkSlNPTigpIHtcclxuICAgICAgY29uc3QgYXJyID0gc3RhdGUubm9kZXNEYXRhc2V0Lm1hcCgobm9kZSkgPT4gW25vZGUubmFtZSwgbm9kZS5ncm91cCwgbm9kZS5ub3Rlc10pO1xyXG4gICAgICBjb25zdCBhcnIyID0gc3RhdGUuZWRnZXNEYXRhc2V0Lm1hcCgoZWRnZSkgPT4gW3N0YXRlLm5vZGVzRGF0YXNldC5nZXQoZWRnZS5mcm9tKS5uYW1lLCBlZGdlLmxhYmVsLCBcclxuICAgICAgICBzdGF0ZS5ub2Rlc0RhdGFzZXQuZ2V0KGVkZ2UudG8pLm5hbWVdKTtcclxuICAgICAgICBcclxuICAgICAgY29uc3Qgb3V0ID0gbmV3IEJsb2IoW0pTT04uc3RyaW5naWZ5KHtub2RlczogYXJyLCBlZGdlczogYXJyMn0sIG51bGwsICcgICcpXSwge1xyXG4gICAgICAgICAgdHlwZTogJ2FwcGxpY2F0aW9uL2pzb247Y2hhcnNldD11dGYtODsnXHJcbiAgICAgIH0pO1xyXG4gICAgICBzYXZlQXMob3V0LCBGaWxlVXRpbHMubWFrZUZpbGVOYW1lKCdnZWFycycsICdqc29uJykpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGRvd25sb2FkWUVEKCkge1xyXG4gICAgICBjb25zdCBhcnIgPSBzdGF0ZS5ub2Rlc0RhdGFzZXQubWFwKChub2RlKSA9PiBbbm9kZS5uYW1lLCBub2RlLmdyb3VwLCBub2RlLm5vdGVzXSk7XHJcbiAgICAgIGNvbnN0IGFycjIgPSBzdGF0ZS5lZGdlc0RhdGFzZXQubWFwKChlZGdlKSA9PiBbc3RhdGUubm9kZXNEYXRhc2V0LmdldChlZGdlLmZyb20pLm5hbWUsIGVkZ2UubGFiZWwsIFxyXG4gICAgICAgIHN0YXRlLm5vZGVzRGF0YXNldC5nZXQoZWRnZS50bykubmFtZV0pO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgZ3JvdXBzID0ge307XHJcbiAgICAgIGxldCBpbmRleCA9IDE7XHJcbiAgICAgIHN0YXRlLm5vZGVzRGF0YXNldC5tYXAobm9kZSA9PiB7XHJcbiAgICAgICAgaWYoZ3JvdXBzW25vZGUuZ3JvdXBdID09PSB1bmRlZmluZWQpe1xyXG4gICAgICAgICAgZ3JvdXBzW25vZGUuZ3JvdXBdID0gaW5kZXg7XHJcbiAgICAgICAgICBpbmRleCsrO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgIGNvbnN0IG5vZGVzID0gc3RhdGUubm9kZXNEYXRhc2V0Lm1hcChub2RlID0+IHtcclxuICAgICAgICBjb25zdCBjb2xvcnMgPSBDb25zdGFudHMuY29sb3JQYWxldHRlW2dyb3Vwc1tub2RlLmdyb3VwXS0xXS5jb2xvcjtcclxuICAgICAgICByZXR1cm4gQ29tbW9uVXRpbHMuc3RyRm9ybWF0KENvbnN0YW50cy55ZWROb2RlVG1wbCwgW25vZGUuaWQsIG5vZGUubGFiZWwsIGNvbG9ycy5iYWNrZ3JvdW5kLCBjb2xvcnMuYm9yZGVyXSk7XHJcbiAgICAgIH0pLmpvaW4oJ1xcbicpO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgZWRnZXMgPSBzdGF0ZS5lZGdlc0RhdGFzZXQubWFwKGVkZ2UgPT4ge1xyXG4gICAgICAgIHJldHVybiBDb21tb25VdGlscy5zdHJGb3JtYXQoQ29uc3RhbnRzLnllZEVkZ2VUbXBsLCBbZWRnZS5pZCwgZWRnZS5sYWJlbCB8fCAnJywgZWRnZS5mcm9tLCBlZGdlLnRvXSk7XHJcbiAgICAgIH0pLmpvaW4oJ1xcbicpO1xyXG4gICAgICBjb25zdCBvdXQgPSBuZXcgQmxvYihbQ29tbW9uVXRpbHMuc3RyRm9ybWF0KENvbnN0YW50cy55ZWRHbWxCYXNlLCBbbm9kZXMsIGVkZ2VzXSldLCB7XHJcbiAgICAgICAgICB0eXBlOiAndGV4dC94bWw7Y2hhcnNldD11dGYtODsnXHJcbiAgICAgIH0pO1xyXG4gICAgICBzYXZlQXMob3V0LCBGaWxlVXRpbHMubWFrZUZpbGVOYW1lKCdnZWFycycsICdncmFwaG1sJykpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG9uTm9kZUZvY3VzKGV2ZW50KSB7XHJcbiAgICAgICAgc3RhdGUubmV0d29yay5mb2N1cyhldmVudC50YXJnZXQudmFsdWUsIENvbnN0YW50cy5zbkZvY3VzT3B0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVuYW1lRWRnZShkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBpZihzdGF0ZS5lZGdlRGF0YSl7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0b0lucHV0ID0gcWVlKGRpYWxvZywgJy5lbnRpdHktaW5wdXQnKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gdG9JbnB1dC52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBlZGdlID0gc3RhdGUuZWRnZURhdGE7XHJcbiAgICAgICAgICAgICAgICBlZGdlLmxhYmVsID0gbGFiZWw7XHJcbiAgICAgICAgICAgICAgICB0b0lucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5lZGdlQ2FsbGJhY2soZWRnZSk7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5lZGdlRGF0YSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5lZGdlQ2FsbGJhY2sgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgc3RvcmVEYXRhKCk7XHJcbiAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVOb2RlKGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmKCBzdGF0ZS5ub2RlRGF0YSApe1xyXG4gICAgICAgICAgICAgICAgbGV0IGRhdGEgPSBzdGF0ZS5ub2RlRGF0YTtcclxuICAgICAgICAgICAgICAgIGRhdGEuaWQgPSBxZWUoZGlhbG9nLCAnLm5vZGUtaWQnKS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGRhdGEubmFtZSA9IHFlZShkaWFsb2csICcubm9kZS1uYW1lJykudmFsdWU7XHJcbiAgICAgICAgICAgICAgICBkYXRhLmdyb3VwID0gcWVlKGRpYWxvZywgJy5ub2RlLWdyb3VwJykudmFsdWU7XHJcbiAgICAgICAgICAgICAgICBkYXRhLm5vdGVzID0gcWVlKGRpYWxvZywgJy5ub2RlLW5vdGVzJykudmFsdWU7XHJcbiAgICAgICAgICAgICAgICBkYXRhLmxhYmVsID0gbWFrZUxhYmVsKGRhdGEubmFtZSwgZGF0YS5ub3Rlcyk7XHJcbiAgICAgICAgICAgICAgICBkYXRhLnNoYXBlID0gJ2JveCc7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGNvbnN0IGV4dHJhRmllbGRzID0gUi5kaWZmZXJlbmNlKFIua2V5cyhkYXRhKSwgQ29uc3RhbnRzLmdlYXJzTm9kZVJlcXVpcmVkRmllbGRzKTtcclxuICAgICAgICAgICAgICAgIGRhdGEgPSBSLm9taXQoZXh0cmFGaWVsZHMsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5ub2RlQ2FsbGJhY2soZGF0YSk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHN0YXRlLm5vZGVEYXRhID0gbnVsbDtcclxuICAgICAgICAgICAgICAgIHN0YXRlLm5vZGVDYWxsYmFjayA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBzdG9yZURhdGEoZXhwb3J0cy5yZWZyZXNoKTtcclxuICAgICAgICAgICAgICAgIGRpYWxvZy5oaWRlRGxnKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBvbk5vZGVDYW5jZWwoKSB7XHJcbiAgICAgICAgaWYoIHN0YXRlLm5vZGVEYXRhICl7XHJcbiAgICAgICAgICAgIHN0YXRlLm5vZGVDYWxsYmFjayhudWxsKTtcclxuICAgICAgICAgICAgc3RhdGUubm9kZURhdGEgPSBudWxsO1xyXG4gICAgICAgICAgICBzdGF0ZS5ub2RlQ2FsbGJhY2sgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufSkodGhpcy5HZWFycyA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxOCBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbi8qIGVzbGludC1kaXNhYmxlIGZ1bmMtbmFtZXMgKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbmZ1bmN0aW9uIEFkZEZpbHRlckNvbmRpdGlvbkRpYWxvZyhyb290KSB7XHJcbiAgICB0aGlzLmRpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHJvb3QsIHRoaXMub25BY3Rpb24uYmluZCh0aGlzKSwge1xyXG4gICAgICAgIGJvZHlTZWxlY3RvcjogJ2FkZC1maWx0ZXItY29uZGl0aW9uLWJvZHknLFxyXG4gICAgICAgIGRpYWxvZ1RpdGxlOiAnZ3JvdXBzLWFkZC1maWx0ZXItY29uZGl0aW9uJyxcclxuICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1vaycsXHJcbiAgICB9KTtcclxuICAgIGxpc3RlbihxZWUodGhpcy5kaWFsb2csIGAucHJvZmlsZS1pdGVtLXNlbGVjdG9yYCksICdjaGFuZ2UnLCB0aGlzLm9uUHJvZmlsZUl0ZW1TZWxlY3QuYmluZCh0aGlzKSk7XHJcbn1cclxuXHJcbkFkZEZpbHRlckNvbmRpdGlvbkRpYWxvZy5wcm90b3R5cGUuc2hvd0RsZyA9IGZ1bmN0aW9uKGdyb3VwcywgY2FsbGJhY2spe1xyXG4gICAgdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrO1xyXG4gICAgdGhpcy5pdGVtcyA9IFIuaW5kZXhCeShSLnByb3AoJ25hbWUnKSwgUi51bm5lc3QoZ3JvdXBzLm1hcChSLnByb3AoJ2FycmF5JykpKSk7XHJcbiAgICBcclxuICAgIGNvbnN0IHNlbGVjdG9yID0gcWVlKHRoaXMuZGlhbG9nLCBgLnByb2ZpbGUtaXRlbS1zZWxlY3RvcmApO1xyXG4gICAgVUkuZmlsbFNob3dJdGVtU2VsZWN0b3IyKFxyXG4gICAgICAgIGNsZWFyRWwoc2VsZWN0b3IpLFxyXG4gICAgICAgIGdyb3VwcyxcclxuICAgICAgICBmYWxzZVxyXG4gICAgKTtcclxuICAgIHNlbGVjdG9yLm9wdGlvbnNbMF0uc2VsZWN0ZWQgPSB0cnVlO1xyXG4gICAgXHJcbiAgICB0aGlzLm9uUHJvZmlsZUl0ZW1TZWxlY3Qoe3RhcmdldDogc2VsZWN0b3J9KTtcclxuICAgIFxyXG4gICAgdGhpcy5kaWFsb2cuc2hvd0RsZygpO1xyXG4gICAgLy8gdG8gc2V0IGRpYWxvZyB0aXRsZVxyXG4vLyAgICBzZXRBdHRyKHFlZShlbCwgJy5tb2RhbC10aXRsZScpLCAnbDEwbi1pZCcsIG9wdHMuZGlhbG9nVGl0bGUpO1xyXG4gICAgXHJcbn1cclxuXHJcbkFkZEZpbHRlckNvbmRpdGlvbkRpYWxvZy5wcm90b3R5cGUub25BY3Rpb24gPSBmdW5jdGlvbiAoZGlhbG9nKXtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2codGhpcy5nZXRGaWx0ZXJNb2RlbEl0ZW0oKSk7XHJcbiAgICAgICAgdGhpcy5jYWxsYmFjayh0aGlzLmdldEZpbHRlck1vZGVsSXRlbSgpKTtcclxuICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgfS5iaW5kKHRoaXMpO1xyXG59IFxyXG5cclxuQWRkRmlsdGVyQ29uZGl0aW9uRGlhbG9nLnByb3RvdHlwZS5nZXRGaWx0ZXJNb2RlbEl0ZW0gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICBjb25zdCBvcHQgPSBxZWUodGhpcy5kaWFsb2csIGAucHJvZmlsZS1pdGVtLXNlbGVjdG9yYCkuc2VsZWN0ZWRPcHRpb25zWzBdO1xyXG4gICAgY29uc3QgaXRlbSA9IHRoaXMuaXRlbXNbb3B0LnZhbHVlXTtcclxuICAgIFxyXG4gICAgY29uc3QgZmlsdGVySXRlbSA9IHtcclxuICAgICAgICB0eXBlOiBpdGVtLnR5cGUsXHJcbiAgICAgICAgbmFtZTogaXRlbS5uYW1lXHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBjb25zdCBjb25kaXRpb25Db250YWluZXIgPSAocWVlKHRoaXMuZGlhbG9nLCAnLmNvbmRpdGlvbicpKTtcclxuICAgIGNvbnN0IHZhbHVlQ29udGFpbmVyID0gKHFlZSh0aGlzLmRpYWxvZywgJy52YWx1ZScpKTtcclxuICAgIFxyXG4gICAgbGV0IGFycjtcclxuICAgIHN3aXRjaCAoaXRlbS50eXBlKSB7XHJcbiAgICBjYXNlICdlbnVtJzpcclxuICAgIGNhc2UgJ2NoZWNrYm94JzpcclxuICAgICAgICBhcnIgPSBubDJhcnJheShxZWUodmFsdWVDb250YWluZXIsICdzZWxlY3QnKS5zZWxlY3RlZE9wdGlvbnMpLm1hcChSLnByb3AoJ3ZhbHVlJykpO1xyXG4gICAgICAgIGZpbHRlckl0ZW0uc2VsZWN0ZWRPcHRpb25zID0gUi56aXBPYmooYXJyLCBSLnJlcGVhdCh0cnVlLCBhcnIubGVuZ3RoKSk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgIGZpbHRlckl0ZW0uY29uZGl0aW9uID0gcWVlKGNvbmRpdGlvbkNvbnRhaW5lciwgJ3NlbGVjdCcpLnZhbHVlO1xyXG4gICAgICAgIGZpbHRlckl0ZW0ubnVtID0gTnVtYmVyKHFlZSh2YWx1ZUNvbnRhaW5lciwgJ2lucHV0JykudmFsdWUpO1xyXG4gICAgICAgIFxyXG4vLyAgICAgICAgaWYgKGlucHV0SXRlbS52YWx1ZSA9PT0gJ2lnbm9yZScpIHsgcmV0dXJuOyB9XHJcbi8vICAgICAgICBudW0gPSBOdW1iZXIoc3RhdGUuaW5wdXRJdGVtc1tgJHtpbnB1dEl0ZW0uc2VsZkluZm8ubmFtZX06bnVtYmVySW5wdXRgXS52YWx1ZSk7XHJcbi8vICAgICAgICBtb2RlbC5wdXNoKHtcclxuLy8gICAgICAgICAgICB0eXBlLCBuYW1lOiBpbnB1dEl0ZW1OYW1lLCBudW0sIGNvbmRpdGlvbjogaW5wdXRJdGVtLnZhbHVlXHJcbi8vICAgICAgICB9KTtcclxuICAgICAgICBicmVhaztcclxuICAgIGNhc2UgJ211bHRpRW51bSc6XHJcbiAgICAgICAgZmlsdGVySXRlbS5jb25kaXRpb24gPSBxZWUoY29uZGl0aW9uQ29udGFpbmVyLCAnc2VsZWN0JykudmFsdWU7XHJcbiAgICAgICAgYXJyID0gbmwyYXJyYXkocWVlKHZhbHVlQ29udGFpbmVyLCAnc2VsZWN0Jykuc2VsZWN0ZWRPcHRpb25zKS5tYXAoUi5wcm9wKCd2YWx1ZScpKTtcclxuICAgICAgICBmaWx0ZXJJdGVtLnNlbGVjdGVkT3B0aW9ucyA9IFIuemlwT2JqKGFyciwgUi5yZXBlYXQodHJ1ZSwgYXJyLmxlbmd0aCkpO1xyXG4vLyAgICAgICAgaWYgKGlucHV0SXRlbS52YWx1ZSA9PT0gJ2lnbm9yZScpIHsgcmV0dXJuOyB9XHJcbi8vICAgICAgICBzZWxlY3RlZE9wdGlvbnMgPSB7fTtcclxuLy8gICAgICAgIHNlbGVjdDIgPSBzdGF0ZS5pbnB1dEl0ZW1zW2Ake2lucHV0SXRlbS5zZWxmSW5mby5uYW1lfTptdWx0aUVudW1JbnB1dGBdO1xyXG4vLyAgICAgICAgYXJyID0gbmwyYXJyYXkoc2VsZWN0Mi5zZWxlY3RlZE9wdGlvbnMpLm1hcChSLnByb3AoJ3ZhbHVlJykpO1xyXG4vLyAgICAgICAgbW9kZWwucHVzaCh7XHJcbi8vICAgICAgICAgICAgdHlwZSxcclxuLy8gICAgICAgICAgICBuYW1lOiBpbnB1dEl0ZW1OYW1lLFxyXG4vLyAgICAgICAgICAgIGNvbmRpdGlvbjogaW5wdXRJdGVtLnZhbHVlLFxyXG4vLyAgICAgICAgICAgIHNlbGVjdGVkT3B0aW9uczogUi56aXBPYmooYXJyLCBSLnJlcGVhdCh0cnVlLCBhcnIubGVuZ3RoKSlcclxuLy8gICAgICAgIH0pO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgY2FzZSAndGV4dCc6XHJcbiAgICBjYXNlICdzdHJpbmcnOlxyXG4gICAgICAgIGZpbHRlckl0ZW0ucmVnZXhTdHJpbmcgPSBxZWUodmFsdWVDb250YWluZXIsICdpbnB1dCcpLnZhbHVlLnRvTG93ZXJDYXNlKCk7XHJcbi8vICAgICAgICBtb2RlbC5wdXNoKHsgdHlwZSwgbmFtZTogaW5wdXRJdGVtTmFtZSwgcmVnZXhTdHJpbmc6IGlucHV0SXRlbS52YWx1ZS50b0xvd2VyQ2FzZSgpIH0pO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgZGVmYXVsdDpcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgdHlwZSAke3R5cGV9YCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmlsdGVySXRlbTtcclxufVxyXG5cclxuQWRkRmlsdGVyQ29uZGl0aW9uRGlhbG9nLnByb3RvdHlwZS5vblByb2ZpbGVJdGVtU2VsZWN0ID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBjb25zdCBvcHQgPSBldmVudC50YXJnZXQuc2VsZWN0ZWRPcHRpb25zWzBdO1xyXG4gICAgY29uc3QgaXRlbSA9IHRoaXMuaXRlbXNbb3B0LnZhbHVlXTtcclxuICAgIGNvbnNvbGUubG9nKGl0ZW0pO1xyXG4gICAgXHJcbiAgICBjb25zdCBjb25kaXRpb25Db250YWluZXIgPSBjbGVhckVsKHFlZSh0aGlzLmRpYWxvZywgJy5jb25kaXRpb24nKSk7XHJcbiAgICBzd2l0Y2ggKGl0ZW0udHlwZSkge1xyXG4gICAgY2FzZSAndGV4dCc6XHJcbiAgICBjYXNlICdzdHJpbmcnOlxyXG4gICAgICAgIGFkZEVsKGNvbmRpdGlvbkNvbnRhaW5lciwgcW10ZSgnLnRleHQtY29uZGl0aW9uLXRtcGwnKSk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICBjYXNlICdlbnVtJzpcclxuICAgIGNhc2UgJ2NoZWNrYm94JzpcclxuICAgICAgICBhZGRFbChjb25kaXRpb25Db250YWluZXIsIHFtdGUoJy5lbnVtLWNvbmRpdGlvbi10bXBsJykpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgY2FzZSAnbXVsdGlFbnVtJzpcclxuICAgICAgICBhZGRFbChjb25kaXRpb25Db250YWluZXIsIHFtdGUoJy5tdWx0aWVudW0tY29uZGl0aW9uLXRtcGwnKSk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgIGFkZEVsKGNvbmRpdGlvbkNvbnRhaW5lciwgcW10ZSgnLm51bWJlci1jb25kaXRpb24tdG1wbCcpKTtcclxuICAgICAgICBicmVhaztcclxuICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR5cGUgJHtpdGVtLnR5cGV9YCk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGNvbnN0IHZhbHVlQ29udGFpbmVyID0gY2xlYXJFbChxZWUodGhpcy5kaWFsb2csICcudmFsdWUnKSk7XHJcbiAgICBsZXQgdmFsdWVJbnB1dCwgdmFsdWVzO1xyXG4gICAgc3dpdGNoIChpdGVtLnR5cGUpIHtcclxuICAgIGNhc2UgJ3RleHQnOlxyXG4gICAgY2FzZSAnc3RyaW5nJzpcclxuICAgICAgICBhZGRFbCh2YWx1ZUNvbnRhaW5lciwgcW10ZSgnLnRleHQtdmFsdWUtdG1wbCcpKTtcclxuICAgICAgICBicmVhaztcclxuICAgIGNhc2UgJ2NoZWNrYm94JzpcclxuICAgICAgICBhZGRFbCh2YWx1ZUNvbnRhaW5lciwgcW10ZSgnLmNoZWNrYm94LXZhbHVlLXRtcGwnKSk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICBjYXNlICdlbnVtJzpcclxuICAgIGNhc2UgJ211bHRpRW51bSc6XHJcbiAgICAgICAgdmFsdWVJbnB1dCA9IHFtdGUoJy5lbnVtLXZhbHVlLXRtcGwnKTtcclxuICAgICAgICB2YWx1ZXMgPSBpdGVtLnZhbHVlLnNwbGl0KCcsJyk7XHJcbiAgICAgICAgdmFsdWVzLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEpO1xyXG4gICAgICAgIHZhbHVlcyA9IGFycjJTZWxlY3QodmFsdWVzKTtcclxuICAgICAgICB2YWx1ZUlucHV0LnNpemUgPSB2YWx1ZXMubGVuZ3RoO1xyXG5cclxuICAgICAgICBmaWxsU2VsZWN0b3IodmFsdWVJbnB1dCwgdmFsdWVzLm1hcCgodmFsdWUpID0+IHtcclxuICAgICAgICAgICAgdmFsdWUuc2VsZWN0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIGFkZEVsKHZhbHVlQ29udGFpbmVyLCB2YWx1ZUlucHV0KTtcclxuICAgICAgICBicmVhaztcclxuICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgYWRkRWwodmFsdWVDb250YWluZXIsIHFtdGUoJy5udW1iZXItdmFsdWUtdG1wbCcpKTtcclxuICAgICAgICBicmVhaztcclxuICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR5cGUgJHtpdGVtLnR5cGV9YCk7XHJcbiAgICB9XHJcbiAgICBMMTBuLmxvY2FsaXplU3RhdGljKHRoaXMuZGlhbG9nKTtcclxuLy8gICAgY29uc29sZS5sb2coaXRlbSk7XHJcbn0iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuLyogZXNsaW50LWRpc2FibGUgZnVuYy1uYW1lcyAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuZnVuY3Rpb24gRmlsdGVyQ29uZmlndXJhdGlvbihpbmZvKSB7XHJcbiAgICB0aGlzLmluZm8gPSBpbmZvO1xyXG4gICAgZnVuY3Rpb24gcG9wdWxhdGVQcm9maWxlSXRlbXMoaXRlbSkge1xyXG4gICAgICAgIGlmICghQ29tbW9uVXRpbHMuc3RhcnRzV2l0aChpdGVtLm5hbWUsIENvbnN0YW50cy5DSEFSX1BSRUZJWCkgJiZcclxuICAgICAgICAgICAgIUNvbW1vblV0aWxzLnN0YXJ0c1dpdGgoaXRlbS5uYW1lLCBDb25zdGFudHMuUExBWUVSX1BSRUZJWCkpIHtcclxuICAgICAgICAgICAgaXRlbS5kaXNwbGF5TmFtZSA9IGdldEwxMG4oaXRlbS5kaXNwbGF5TmFtZSk7XHJcbiAgICAgICAgICAgIGl0ZW0udmFsdWUgPSAnJztcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICB0aGlzLmdyb3VwZWRQcm9maWxlRmlsdGVySXRlbXMgPSBDb21tb25VdGlscy5jbG9uZShpbmZvLmdyb3VwZWRQcm9maWxlRmlsdGVySXRlbXMpO1xyXG4gICAgdGhpcy5ncm91cGVkUHJvZmlsZUZpbHRlckl0ZW1zLm1hcChSLnByb3AoJ3Byb2ZpbGVGaWx0ZXJJdGVtcycpKS5tYXAoUi5tYXAocG9wdWxhdGVQcm9maWxlSXRlbXMpKTtcclxufVxyXG5cclxuRmlsdGVyQ29uZmlndXJhdGlvbi5tYWtlRmlsdGVyQ29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uIChjYWxsYmFjaykge1xyXG4gICAgREJNUy5nZXRQcm9maWxlRmlsdGVySW5mbygoZXJyLCBpbmZvKSA9PiB7XHJcbiAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICBjb25zdCBmaWx0ZXJDb25maWd1cmF0aW9uID0gbmV3IEZpbHRlckNvbmZpZ3VyYXRpb24oaW5mbyk7XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgZmlsdGVyQ29uZmlndXJhdGlvbik7XHJcbiAgICB9KTtcclxufTtcclxuXHJcbkZpbHRlckNvbmZpZ3VyYXRpb24ucHJvdG90eXBlLmdldFByb2ZpbGVGaWx0ZXJJdGVtcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiBSLmZsYXR0ZW4odGhpcy5ncm91cGVkUHJvZmlsZUZpbHRlckl0ZW1zLm1hcChSLnByb3AoJ3Byb2ZpbGVGaWx0ZXJJdGVtcycpKSk7XHJcbn07XHJcblxyXG5GaWx0ZXJDb25maWd1cmF0aW9uLnByb3RvdHlwZS5nZXRQcm9maWxlSXRlbVNvdXJjZSA9IGZ1bmN0aW9uIChuYW1lKSB7XHJcbiAgICBsZXQgc291cmNlO1xyXG4gICAgdGhpcy5ncm91cGVkUHJvZmlsZUZpbHRlckl0ZW1zLmZvckVhY2goIChlbCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGFyciA9IGVsLnByb2ZpbGVGaWx0ZXJJdGVtcy5tYXAoUi5wcm9wKCduYW1lJykpO1xyXG4gICAgICAgIGlmKFIuY29udGFpbnMobmFtZSwgYXJyKSl7XHJcbiAgICAgICAgICAgIHNvdXJjZSA9IGVsLm5hbWU7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gc291cmNlO1xyXG59O1xyXG5cclxuRmlsdGVyQ29uZmlndXJhdGlvbi5wcm90b3R5cGUuZ2V0TmFtZTJTb3VyY2VNYXBwaW5nID0gZnVuY3Rpb24gKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZ3JvdXBlZFByb2ZpbGVGaWx0ZXJJdGVtcy5yZWR1Y2UoIChhY2MsIGdyb3VwKSA9PiB7XHJcbiAgICAgICAgZ3JvdXAucHJvZmlsZUZpbHRlckl0ZW1zLmZvckVhY2goIGl0ZW0gPT4gYWNjW2l0ZW0ubmFtZV0gPSBncm91cC5uYW1lKTtcclxuICAgICAgICByZXR1cm4gYWNjO1xyXG4gICAgfSwge30pO1xyXG59O1xyXG5cclxuRmlsdGVyQ29uZmlndXJhdGlvbi5wcm90b3R5cGUuZ2V0TmFtZTJEaXNwbGF5TmFtZU1hcHBpbmcgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5ncm91cGVkUHJvZmlsZUZpbHRlckl0ZW1zLnJlZHVjZSggKGFjYywgZ3JvdXApID0+IHtcclxuICAgICAgICBncm91cC5wcm9maWxlRmlsdGVySXRlbXMuZm9yRWFjaCggaXRlbSA9PiBhY2NbaXRlbS5uYW1lXSA9IGl0ZW0uZGlzcGxheU5hbWUpO1xyXG4gICAgICAgIHJldHVybiBhY2M7XHJcbiAgICB9LCB7fSk7XHJcbn07XHJcblxyXG5GaWx0ZXJDb25maWd1cmF0aW9uLnByb3RvdHlwZS5nZXRHcm91cGVkUHJvZmlsZUZpbHRlckl0ZW1zID0gZnVuY3Rpb24gKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZ3JvdXBlZFByb2ZpbGVGaWx0ZXJJdGVtcztcclxufTtcclxuXHJcbkZpbHRlckNvbmZpZ3VyYXRpb24ucHJvdG90eXBlLmdldEdyb3Vwc0ZvclNlbGVjdCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZ3JvdXBlZFByb2ZpbGVGaWx0ZXJJdGVtcy5tYXAoKGdyb3VwKSA9PiAoe1xyXG4gICAgICAgIGRpc3BsYXlOYW1lOiBnZXRMMTBuKGBwcm9maWxlLWZpbHRlci0ke2dyb3VwLm5hbWV9YCksXHJcbiAgICAgICAgYXJyYXk6IGdyb3VwLnByb2ZpbGVGaWx0ZXJJdGVtc1xyXG4gICAgfSkpO1xyXG59XHJcblxyXG5GaWx0ZXJDb25maWd1cmF0aW9uLnByb3RvdHlwZS5nZXRCYXNlUHJvZmlsZVNldHRpbmdzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBjaGFyYWN0ZXJzOiB0aGlzLmluZm8uY2hhcmFjdGVycy5wcm9maWxlU3RydWN0dXJlLFxyXG4gICAgICAgIHBsYXllcnM6IHRoaXMuaW5mby5wbGF5ZXJzLnByb2ZpbGVTdHJ1Y3R1cmVcclxuICAgIH07XHJcbn07XHJcblxyXG5GaWx0ZXJDb25maWd1cmF0aW9uLnByb3RvdHlwZS5nZXREYXRhQXJyYXlzID0gZnVuY3Rpb24gKGZpbHRlck1vZGVsKSB7XHJcbiAgICByZXR1cm4gUHJvamVjdFV0aWxzLmdldERhdGFBcnJheXModGhpcy5pbmZvLCBmaWx0ZXJNb2RlbCk7XHJcbn07XHJcblxyXG5GaWx0ZXJDb25maWd1cmF0aW9uLnByb3RvdHlwZS5oYXZlUHJvZmlsZXMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gUi5rZXlzKHRoaXMuaW5mby5jaGFyYWN0ZXJzLnByb2ZpbGVzKS5sZW5ndGggPiAwIHx8IFIua2V5cyh0aGlzLmluZm8ucGxheWVycy5wcm9maWxlcykubGVuZ3RoID4gMDtcclxufTtcclxuXHJcbkZpbHRlckNvbmZpZ3VyYXRpb24ucHJvdG90eXBlLmhhdmVQcm9maWxlU3RydWN0dXJlcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiB0aGlzLmluZm8uY2hhcmFjdGVycy5wcm9maWxlU3RydWN0dXJlLmxlbmd0aCA+IDAgfHwgdGhpcy5pbmZvLnBsYXllcnMucHJvZmlsZVN0cnVjdHVyZS5sZW5ndGggPiAwO1xyXG59O1xyXG5cclxuRmlsdGVyQ29uZmlndXJhdGlvbi5wcm90b3R5cGUuaGF2ZURhdGEgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5oYXZlUHJvZmlsZXMoKSAmJiB0aGlzLmhhdmVQcm9maWxlU3RydWN0dXJlcygpO1xyXG59O1xyXG5cclxuRmlsdGVyQ29uZmlndXJhdGlvbi5wcm90b3R5cGUuZ2V0UHJvZmlsZUlkcyA9IGZ1bmN0aW9uIChmaWx0ZXJNb2RlbCkge1xyXG4gICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy5ncm91cGVkUHJvZmlsZUZpbHRlckl0ZW1zWzBdLnByb2ZpbGVGaWx0ZXJJdGVtcy5sZW5ndGg7XHJcbiAgICByZXR1cm4gdGhpcy5nZXREYXRhQXJyYXlzKGZpbHRlck1vZGVsKS5tYXAoZGF0YUFycmF5ID0+IGAke2RhdGFBcnJheVswXS52YWx1ZSB8fCAnJ30vJHtkYXRhQXJyYXlbb2Zmc2V0XS52YWx1ZSB8fCAnJ31gKS5zb3J0KCk7XHJcbn07XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTYgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcbiAgICBjb25zdCByb290ID0gJy5ncm91cC1wcm9maWxlLXRhYiAnO1xyXG4gICAgY29uc3QgbDEwbiA9IEwxMG4uZ2V0KCdncm91cHMnKTtcclxuICAgIGNvbnN0IHNldHRpbmdzUGF0aCA9ICdHcm91cFByb2ZpbGUnO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBjcmVhdGVHcm91cERpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHJvb3QsIGV4cG9ydHMuY3JlYXRlR3JvdXAodHJ1ZSwgZXhwb3J0cy5yZWZyZXNoKSwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdtb2RhbC1wcm9tcHQtYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnZ3JvdXBzLWVudGVyLWdyb3VwLW5hbWUnLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1jcmVhdGUnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxpc3RlbihxZShgJHtyb290fS5jcmVhdGVgKSwgJ2NsaWNrJywgKCkgPT4gY3JlYXRlR3JvdXBEaWFsb2cuc2hvd0RsZygpKTtcclxuXHJcbiAgICAgICAgc3RhdGUucmVuYW1lR3JvdXBEaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhyb290LCByZW5hbWVHcm91cCwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdtb2RhbC1wcm9tcHQtYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnZ3JvdXBzLWVudGVyLW5ldy1ncm91cC1uYW1lJyxcclxuICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tcmVuYW1lJyxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgdGJvZHkgPSBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0gLmVudGl0eS1wcm9maWxlYCkpO1xyXG5cclxuICAgICAgICBzdGF0ZS5pbnB1dEl0ZW1zID0ge307XHJcblxyXG4gICAgICAgIENvbnN0YW50cy5ncm91cFByb2ZpbGVTdHJ1Y3R1cmUuZm9yRWFjaCgocHJvZmlsZVNldHRpbmdzKSA9PiB7XHJcbiAgICAgICAgICAgIHByb2ZpbGVTZXR0aW5ncy5kaXNwbGF5TmFtZSA9IGdldEwxMG4oYGdyb3Vwcy0ke3Byb2ZpbGVTZXR0aW5ncy5uYW1lfWApO1xyXG4gICAgICAgICAgICBhZGRFbCh0Ym9keSwgbWFrZUlucHV0KHByb2ZpbGVTZXR0aW5ncykpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fSAuZW50aXR5LWZpbHRlcmApLCAnaW5wdXQnLCBmaWx0ZXJPcHRpb25zKTtcclxuXHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChgJHtyb290fWApO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2dyb3VwJywgZmFsc2UsIChlcnIsIGdyb3VwTmFtZXMpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fSAuYWxlcnRgKSwgZ3JvdXBOYW1lcy5sZW5ndGggPT09IDApO1xyXG4gICAgICAgICAgICBzaG93RWwocWUoYCR7cm9vdH0gLmNvbC14cy05YCksIGdyb3VwTmFtZXMubGVuZ3RoICE9PSAwKTtcclxuICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwocWUoYCR7cm9vdH0gLmVudGl0eS1maWx0ZXJgKSwgZ3JvdXBOYW1lcy5sZW5ndGggIT09IDApO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgYWRkRWxzKGNsZWFyRWwocXVlcnlFbChgJHtyb290fSAuZW50aXR5LWxpc3RgKSksIGdyb3VwTmFtZXMubWFwKChuYW1lLCBpLCBhcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gd3JhcEVsKCdkaXYnLCBxdGUoJy5lbnRpdHktaXRlbS10bXBsJykpO1xyXG4gICAgICAgICAgICAgICAgYWRkRWwocWVlKGVsLCAnLnByaW1hcnktbmFtZScpLCBtYWtlVGV4dChuYW1lLmRpc3BsYXlOYW1lKSk7XHJcbiAgICAgICAgICAgICAgICBzZXRBdHRyKGVsLCAncHJpbWFyeS1uYW1lJywgbmFtZS5kaXNwbGF5TmFtZSk7XHJcbiAgICAgICAgICAgICAgICBzZXRBdHRyKGVsLCAncHJvZmlsZS1uYW1lJywgbmFtZS52YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICBsaXN0ZW4ocWVlKGVsLCAnLnNlbGVjdC1idXR0b24nKSwgJ2NsaWNrJywgc2hvd1Byb2ZpbGVJbmZvRGVsZWdhdGUyKG5hbWUudmFsdWUpKTtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIocWVlKGVsLCAnLnJlbmFtZScpLCAndGl0bGUnLCBsMTBuKCdyZW5hbWUtZW50aXR5JykpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVtb3ZlQnRuID0gcWVlKGVsLCAnLnJlbW92ZScpO1xyXG4gICAgICAgICAgICAgICAgc2V0QXR0cihyZW1vdmVCdG4sICd0aXRsZScsIGwxMG4oJ3JlbW92ZS1lbnRpdHknKSk7XHJcbiAgICAgICAgICAgICAgICBpZihpKzEgPCBhcnIubGVuZ3RoKXtcclxuICAgICAgICAgICAgICAgICAgICByZW1vdmVCdG4ubmV4dE5hbWUgPSBhcnJbaSsxXS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmKGkgPiAwKXtcclxuICAgICAgICAgICAgICAgICAgICByZW1vdmVCdG4ucHJldk5hbWUgPSBhcnJbaS0xXS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChuYW1lLmVkaXRhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGlzdGVuKHFlZShlbCwgJy5yZW5hbWUnKSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBxZWUoc3RhdGUucmVuYW1lR3JvdXBEaWFsb2csICcuZW50aXR5LWlucHV0JykudmFsdWUgPSBuYW1lLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5yZW5hbWVHcm91cERpYWxvZy5mcm9tTmFtZSA9IG5hbWUudmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnJlbmFtZUdyb3VwRGlhbG9nLnNob3dEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBsaXN0ZW4ocmVtb3ZlQnRuLCAnY2xpY2snLCBHcm91cFByb2ZpbGUucmVtb3ZlR3JvdXAoKCkgPT4gbmFtZS52YWx1ZSwgZXhwb3J0cy5yZWZyZXNoLCByZW1vdmVCdG4pKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0QXR0cihxZWUoZWwsICcucmVuYW1lJyksICdkaXNhYmxlZCcsICdkaXNhYmxlZCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEF0dHIocmVtb3ZlQnRuLCAnZGlzYWJsZWQnLCAnZGlzYWJsZWQnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBlbDtcclxuICAgICAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICAgICAgc2hvd1Byb2ZpbGVJbmZvRGVsZWdhdGUyKFVJLmNoZWNrQW5kR2V0RW50aXR5U2V0dGluZyhzZXR0aW5nc1BhdGgsIGdyb3VwTmFtZXMpKSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlSW5wdXQocHJvZmlsZUl0ZW1Db25maWcpIHtcclxuICAgICAgICBsZXQgaW5wdXQ7XHJcbiAgICAgICAgc3dpdGNoIChwcm9maWxlSXRlbUNvbmZpZy50eXBlKSB7XHJcbiAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKCd0ZXh0YXJlYScpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ3Byb2ZpbGVUZXh0SW5wdXQgZm9ybS1jb250cm9sJyk7XHJcbiAgICAgICAgICAgIGlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIHVwZGF0ZUZpZWxkVmFsdWUocHJvZmlsZUl0ZW1Db25maWcudHlwZSkpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdjaGVja2JveCc6XHJcbiAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKCdpbnB1dCcpO1xyXG4gICAgICAgICAgICBpbnB1dC50eXBlID0gJ2NoZWNrYm94JztcclxuICAgICAgICAgICAgYWRkQ2xhc3MoaW5wdXQsICdmb3JtLWNvbnRyb2wnKTtcclxuICAgICAgICAgICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgdXBkYXRlRmllbGRWYWx1ZShwcm9maWxlSXRlbUNvbmZpZy50eXBlKSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ2NvbnRhaW5lcic6XHJcbiAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKCdkaXYnKTtcclxuICAgICAgICAgICAgaW5wdXQudHlwZSA9ICdjb250YWluZXInO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgdHlwZSAke3Byb2ZpbGVJdGVtQ29uZmlnLnR5cGV9YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlucHV0LnNlbGZOYW1lID0gcHJvZmlsZUl0ZW1Db25maWcubmFtZTtcclxuICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ2lzR3JvdXBFZGl0YWJsZScpO1xyXG4gICAgICAgIHN0YXRlLmlucHV0SXRlbXNbcHJvZmlsZUl0ZW1Db25maWcubmFtZV0gPSBpbnB1dDtcclxuXHJcbiAgICAgICAgY29uc3Qgcm93ID0gcW10ZSgnLnByb2ZpbGUtZWRpdG9yLXJvdy10bXBsJyk7XHJcbiAgICAgICAgYWRkRWwocWVlKHJvdywgJy5wcm9maWxlLWl0ZW0tbmFtZScpLCBtYWtlVGV4dChwcm9maWxlSXRlbUNvbmZpZy5kaXNwbGF5TmFtZSkpO1xyXG4gICAgICAgIHNldEF0dHIocWVlKHJvdywgJy5wcm9maWxlLWl0ZW0tbmFtZScpLCAnbDEwbi1pZCcsIGBncm91cHMtJHtwcm9maWxlSXRlbUNvbmZpZy5uYW1lfWApO1xyXG4gICAgICAgIGFkZEVsKHFlZShyb3csICcucHJvZmlsZS1pdGVtLWlucHV0JyksIGlucHV0KTtcclxuICAgICAgICByZXR1cm4gcm93O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZUZpZWxkVmFsdWUodHlwZSkge1xyXG4gICAgICAgIHJldHVybiAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZmllbGROYW1lID0gZXZlbnQudGFyZ2V0LnNlbGZOYW1lO1xyXG4gICAgICAgICAgICBjb25zdCBncm91cE5hbWUgPSBzdGF0ZS5uYW1lO1xyXG5cclxuICAgICAgICAgICAgbGV0IHZhbHVlO1xyXG4gICAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLWRlc3RydWN0dXJpbmdcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgREJNUy51cGRhdGVHcm91cEZpZWxkKGdyb3VwTmFtZSwgZmllbGROYW1lLCB2YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2NoZWNrYm94JzpcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gZXZlbnQudGFyZ2V0LmNoZWNrZWQ7XHJcbiAgICAgICAgICAgICAgICBEQk1TLmRvRXhwb3J0R3JvdXAoZ3JvdXBOYW1lLCB2YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgdHlwZSAke3R5cGV9YCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNob3dQcm9maWxlSW5mb0RlbGVnYXRlMihuYW1lKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgcXVlcnlFbHMoYCR7cm9vdH0gW3Byb2ZpbGUtbmFtZV0gLnNlbGVjdC1idXR0b25gKS5tYXAocmVtb3ZlQ2xhc3MoUi5fXywgJ2J0bi1wcmltYXJ5JykpO1xyXG4gICAgICAgICAgICBpZihuYW1lICE9PSBudWxsKXtcclxuICAgICAgICAgICAgICAgIFVJLnVwZGF0ZUVudGl0eVNldHRpbmcoc2V0dGluZ3NQYXRoLCBuYW1lKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gcXVlcnlFbChgJHtyb290fSBbcHJvZmlsZS1uYW1lPVwiJHtuYW1lfVwiXSAuc2VsZWN0LWJ1dHRvbmApO1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3MoZWwsICdidG4tcHJpbWFyeScpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnRFbCA9IGVsLnBhcmVudEVsZW1lbnQucGFyZW50RWxlbWVudDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVudGl0eUxpc3QgPSBxdWVyeUVsKGAke3Jvb3R9IC5lbnRpdHktbGlzdGApO1xyXG4gICAgICAgICAgICAgICAgVUkuc2Nyb2xsVG8oZW50aXR5TGlzdCwgcGFyZW50RWwpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBEQk1TLmdldEdyb3VwKG5hbWUsIHNob3dQcm9maWxlSW5mb0NhbGxiYWNrKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2hvd1Byb2ZpbGVJbmZvQ2FsbGJhY2soZXJyLCBncm91cCkge1xyXG4gICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgY29uc3QgeyBuYW1lIH0gPSBncm91cDtcclxuICAgICAgICBGaWx0ZXJDb25maWd1cmF0aW9uLm1ha2VGaWx0ZXJDb25maWd1cmF0aW9uKChlcnIxLCBmaWx0ZXJDb25maWd1cmF0aW9uKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIxKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjEpOyByZXR1cm47IH1cclxuXHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5pc0VudGl0eUVkaXRhYmxlKCdncm91cCcsIG5hbWUsIChlcnIyLCBpc0dyb3VwRWRpdGFibGUpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIHVwZGF0ZVNldHRpbmdzKG5hbWUpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBjb25zdCBuYW1lMkRpc3BsYXlOYW1lID0gZmlsdGVyQ29uZmlndXJhdGlvbi5nZXROYW1lMkRpc3BsYXlOYW1lTWFwcGluZygpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBjb25zdCBuYW1lMlNvdXJjZSA9IGZpbHRlckNvbmZpZ3VyYXRpb24uZ2V0TmFtZTJTb3VyY2VNYXBwaW5nKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgc3RhdGUubmFtZSA9IG5hbWU7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB7IGlucHV0SXRlbXMgfSA9IHN0YXRlO1xyXG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXMoaW5wdXRJdGVtcykuZm9yRWFjaCgoaW5wdXROYW1lKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlucHV0SXRlbXNbaW5wdXROYW1lXS50eXBlID09PSAnY2hlY2tib3gnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0SXRlbXNbaW5wdXROYW1lXS5jaGVja2VkID0gZ3JvdXBbaW5wdXROYW1lXTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlucHV0SXRlbXNbaW5wdXROYW1lXS50eXBlID09PSAnY29udGFpbmVyJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5wdXROYW1lID09PSAnZmlsdGVyTW9kZWwnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0YWJsZSA9IHFtdGUoYCR7cm9vdH0gLmdyb3VwLWZpbHRlci10ZW1wbGF0ZWApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YXMgPSBncm91cC5maWx0ZXJNb2RlbC5tYXAoZXhwb3J0cy5tYWtlRmlsdGVySXRlbVN0cmluZyhuYW1lMkRpc3BsYXlOYW1lLCBuYW1lMlNvdXJjZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRWxzKHFlZSh0YWJsZSwgJ3Rib2R5JyksIGRhdGFzLm1hcChkYXRhMnJvdykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgTDEwbi5sb2NhbGl6ZVN0YXRpYyh0YWJsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFbChjbGVhckVsKGlucHV0SXRlbXNbaW5wdXROYW1lXSksIHRhYmxlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnB1dE5hbWUgPT09ICdjaGFyYWN0ZXJMaXN0Jykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IGZpbHRlckNvbmZpZ3VyYXRpb24uZ2V0UHJvZmlsZUlkcyhncm91cC5maWx0ZXJNb2RlbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnB1dEl0ZW0gPSBjbGVhckVsKGlucHV0SXRlbXNbaW5wdXROYW1lXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFbHMoaW5wdXRJdGVtLCBbbWFrZVRleHQoZGF0YS5qb2luKCcsICcpKSwgbWFrZUVsKCdicicpLCBtYWtlVGV4dChnZXRMMTBuKCdncm91cHMtdG90YWwnKSArIGRhdGEubGVuZ3RoKV0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGNvbnRhaW5lcjogJHtpbnB1dE5hbWV9YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlucHV0SXRlbXNbaW5wdXROYW1lXS50eXBlID09PSAndGV4dGFyZWEnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0SXRlbXNbaW5wdXROYW1lXS52YWx1ZSA9IGdyb3VwW2lucHV0TmFtZV07XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGlucHV0IHR5cGU6ICR7aW5wdXRJdGVtc1tpbnB1dE5hbWVdLnR5cGV9YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlucHV0SXRlbXNbaW5wdXROYW1lXS5vbGRWYWx1ZSA9IGdyb3VwW2lucHV0TmFtZV07XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlKGV4cG9ydHMuY29udGVudCwgJ2lzR3JvdXBFZGl0YWJsZScsIGlzR3JvdXBFZGl0YWJsZSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgZXhwb3J0cy5tYWtlRmlsdGVySXRlbVN0cmluZyA9IFIuY3VycnkoKG5hbWUyRGlzcGxheU5hbWUsIG5hbWUyU291cmNlLCBmaWx0ZXJJdGVtKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZGlzcGxheU5hbWUgPSBuYW1lMkRpc3BsYXlOYW1lW2ZpbHRlckl0ZW0ubmFtZV07XHJcbiAgICAgICAgY29uc3Qgc291cmNlID0gbmFtZTJTb3VyY2VbZmlsdGVySXRlbS5uYW1lXTtcclxuICAgICAgICBsZXQgY29uZGl0aW9uLCBhcnIsIHZhbHVlO1xyXG4gICAgICAgIHN3aXRjaCAoZmlsdGVySXRlbS50eXBlKSB7XHJcbiAgICAgICAgY2FzZSAnZW51bSc6XHJcbiAgICAgICAgICAgIGNvbmRpdGlvbiA9IGdldEwxMG4oYGdyb3Vwcy1vbmUtZnJvbWApO1xyXG4gICAgICAgICAgICB2YWx1ZSA9IE9iamVjdC5rZXlzKGZpbHRlckl0ZW0uc2VsZWN0ZWRPcHRpb25zKS5qb2luKCcsICcpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdjaGVja2JveCc6XHJcbiAgICAgICAgICAgIGFyciA9IFtdO1xyXG4gICAgICAgICAgICBpZiAoZmlsdGVySXRlbS5zZWxlY3RlZE9wdGlvbnMudHJ1ZSkgeyBhcnIucHVzaChnZXRMMTBuKCdjb25zdGFudC15ZXMnKSk7IH1cclxuICAgICAgICAgICAgaWYgKGZpbHRlckl0ZW0uc2VsZWN0ZWRPcHRpb25zLmZhbHNlKSB7IGFyci5wdXNoKGdldEwxMG4oJ2NvbnN0YW50LW5vJykpOyB9XHJcbiAgICAgICAgICAgIGNvbmRpdGlvbiA9IGdldEwxMG4oYGdyb3Vwcy1vbmUtZnJvbWApO1xyXG4gICAgICAgICAgICB2YWx1ZSA9IGFyci5qb2luKCcsICcpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgICAgICBjb25kaXRpb24gPSBnZXRMMTBuKGBjb25zdGFudC0ke2ZpbHRlckl0ZW0uY29uZGl0aW9ufWApO1xyXG4gICAgICAgICAgICB2YWx1ZSA9IGZpbHRlckl0ZW0ubnVtO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdtdWx0aUVudW0nOlxyXG4gICAgICAgICAgICBjb25kaXRpb24gPSBnZXRMMTBuKGBjb25zdGFudC0ke2ZpbHRlckl0ZW0uY29uZGl0aW9ufWApO1xyXG4gICAgICAgICAgICB2YWx1ZSA9IE9iamVjdC5rZXlzKGZpbHRlckl0ZW0uc2VsZWN0ZWRPcHRpb25zKS5qb2luKCcsICcpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICd0ZXh0JzpcclxuICAgICAgICBjYXNlICdzdHJpbmcnOlxyXG4gICAgICAgICAgICBjb25kaXRpb24gPSBnZXRMMTBuKCdncm91cHMtdGV4dC1jb250YWlucycpO1xyXG4gICAgICAgICAgICB2YWx1ZSA9IGZpbHRlckl0ZW0ucmVnZXhTdHJpbmc7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCB0eXBlICR7ZmlsdGVySXRlbS50eXBlfWApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB0aXRsZSA9IGdldEwxMG4oYHByb2ZpbGUtZmlsdGVyLSR7c291cmNlfWApICsgJywgJyArIGdldEwxMG4oYGNvbnN0YW50LSR7ZmlsdGVySXRlbS50eXBlfWApO1xyXG4gICAgICAgIHJldHVybiB7ZGlzcGxheU5hbWUsIHRpdGxlLCBjb25kaXRpb24sIHZhbHVlfTtcclxuICAgIH0pO1xyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBkYXRhMnJvdyhkYXRhKXtcclxuICAgICAgICBjb25zdCB7ZGlzcGxheU5hbWUsIHRpdGxlLCBjb25kaXRpb24sIHZhbHVlfSA9IGRhdGE7XHJcbiAgICAgICAgY29uc3Qgcm93ID0gcW10ZShgJHtyb290fSAuZ3JvdXAtZmlsdGVyLXJvdy10ZW1wbGF0ZWApO1xyXG4gICAgICAgIGFkZEVsKHFlZShyb3csICcucHJvZmlsZS1pdGVtJyksIG1ha2VUZXh0KGRpc3BsYXlOYW1lKSk7XHJcbiAgICAgICAgc2V0QXR0cihxZWUocm93LCAnLnByb2ZpbGUtaXRlbScpLCAndGl0bGUnLCB0aXRsZSk7XHJcbiAgICAgICAgYWRkRWwocWVlKHJvdywgJy5jb25kaXRpb24nKSwgbWFrZVRleHQoY29uZGl0aW9uKSk7XHJcbiAgICAgICAgYWRkRWwocWVlKHJvdywgJy52YWx1ZScpLCBtYWtlVGV4dCh2YWx1ZSkpO1xyXG4gICAgICAgIHJldHVybiByb3c7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlU2V0dGluZ3MobmFtZSkge1xyXG4gICAgICAgIGNvbnN0IHNldHRpbmdzID0gREJNUy5nZXRTZXR0aW5ncygpO1xyXG4gICAgICAgIHNldHRpbmdzLkdyb3VwUHJvZmlsZS5ncm91cE5hbWUgPSBuYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGZpbHRlck9wdGlvbnMoZXZlbnQpIHtcclxuICAgICAgICBjb25zdCBzdHIgPSBldmVudC50YXJnZXQudmFsdWUudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICAgICAgY29uc3QgZWxzID0gcXVlcnlFbHMoYCR7cm9vdH0gW3ByaW1hcnktbmFtZV1gKTtcclxuICAgICAgICBlbHMuZm9yRWFjaCgoZWwpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaXNWaXNpYmxlID0gZ2V0QXR0cihlbCwgJ3ByaW1hcnktbmFtZScpLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihzdHIpICE9PSAtMTtcclxuICAgICAgICAgICAgaGlkZUVsKGVsLCAhaXNWaXNpYmxlKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaWYgKHF1ZXJ5RWwoYCR7cm9vdH0gLmhpZGRlbltwcmltYXJ5LW5hbWVdIC5zZWxlY3QtYnV0dG9uLmJ0bi1wcmltYXJ5YCkgIT09IG51bGwgfHxcclxuICAgICAgICAgICAgcXVlcnlFbChgJHtyb290fSBbcHJpbWFyeS1uYW1lXSAuc2VsZWN0LWJ1dHRvbi5idG4tcHJpbWFyeWApID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVsczIgPSBxdWVyeUVscyhgJHtyb290fSBbcHJpbWFyeS1uYW1lXWApLmZpbHRlcihSLnBpcGUoaGFzQ2xhc3MoUi5fXywgJ2hpZGRlbicpLCBSLm5vdCkpO1xyXG4gICAgICAgICAgICBzaG93UHJvZmlsZUluZm9EZWxlZ2F0ZTIoZWxzMi5sZW5ndGggPiAwID8gZ2V0QXR0cihlbHMyWzBdLCAncHJvZmlsZS1uYW1lJykgOiBudWxsKSgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgcXVlcnlFbChgJHtyb290fSBbcHJpbWFyeS1uYW1lXSAuc2VsZWN0LWJ1dHRvbi5idG4tcHJpbWFyeWApLnNjcm9sbEludG9WaWV3KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydHMuY3JlYXRlR3JvdXAgPSAodXBkYXRlU2V0dGluZ3NGbGFnLCByZWZyZXNoKSA9PiBkaWFsb2cgPT4gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGlucHV0ID0gcWVlKGRpYWxvZywgJy5lbnRpdHktaW5wdXQnKTtcclxuICAgICAgICBjb25zdCBuYW1lID0gaW5wdXQudmFsdWUudHJpbSgpO1xyXG5cclxuICAgICAgICBEQk1TLmNyZWF0ZUdyb3VwKG5hbWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVNldHRpbmdzRmxhZykge1xyXG4gICAgICAgICAgICAgICAgICAgIFVJLnVwZGF0ZUVudGl0eVNldHRpbmcoc2V0dGluZ3NQYXRoLCBuYW1lKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5yZWZyZXNoKChlcnIyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICByZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiByZW5hbWVHcm91cChkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0b0lucHV0ID0gcWVlKGRpYWxvZywgJy5lbnRpdHktaW5wdXQnKTtcclxuICAgICAgICAgICAgY29uc3QgeyBmcm9tTmFtZSB9ID0gZGlhbG9nO1xyXG4gICAgICAgICAgICBjb25zdCB0b05hbWUgPSB0b0lucHV0LnZhbHVlLnRyaW0oKTtcclxuXHJcbiAgICAgICAgICAgIERCTVMucmVuYW1lR3JvdXAoZnJvbU5hbWUsIHRvTmFtZSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEVycm9yKGRpYWxvZywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgVUkudXBkYXRlRW50aXR5U2V0dGluZyhzZXR0aW5nc1BhdGgsIHRvTmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdG9JbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZy5oaWRlRGxnKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0cy5yZW1vdmVHcm91cCA9IChjYWxsYmFjaywgcmVmcmVzaCwgYnRuKSA9PiAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbmFtZSA9IGNhbGxiYWNrKCk7XHJcblxyXG4gICAgICAgIFV0aWxzLmNvbmZpcm0oc3RyRm9ybWF0KGdldEwxMG4oJ2dyb3Vwcy1hcmUteW91LXN1cmUtYWJvdXQtZ3JvdXAtcmVtb3ZpbmcnKSwgW25hbWVdKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICBEQk1TLnJlbW92ZUdyb3VwKG5hbWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIucmVmcmVzaCgoZXJyMikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICBpZihidG4ubmV4dE5hbWUgIT09IHVuZGVmaW5lZCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFVJLnVwZGF0ZUVudGl0eVNldHRpbmcoc2V0dGluZ3NQYXRoLCBidG4ubmV4dE5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihidG4ucHJldk5hbWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBVSS51cGRhdGVFbnRpdHlTZXR0aW5nKHNldHRpbmdzUGF0aCwgYnRuLnByZXZOYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxufSkodGhpcy5Hcm91cFByb2ZpbGUgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTYtMjAxOCBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuICAgIGNvbnN0IHJvb3RUYWIgPSAnLmdyb3VwLXNjaGVtYS10YWInO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3RUYWIpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgREJNUy5nZXRHcm91cFNjaGVtYXMoKGVyciwgc2NoZW1hcykgPT4ge1xyXG4vLyAgICAgICAgICAgIHJlZHJhd1NjaGVtYShzY2hlbWFzLnRoZW9yeSk7XHJcbiAgICAgICAgICAgIHJlZHJhd1NjaGVtYTIoc2NoZW1hcy50aGVvcnksICd0aGVvcnknKTtcclxuICAgICAgICAgICAgcmVkcmF3U2NoZW1hMihzY2hlbWFzLnByYWN0aWNlLCAncHJhY3RpY2UnKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gcmVkcmF3U2NoZW1hKGdyYXBoKSB7XHJcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gcXVlcnlFbChgJHtyb290VGFifSAuc2NoZW1hLWNvbnRhaW5lcmApO1xyXG5cclxuICAgICAgICBpZiAoc3RhdGUubmV0d29yaykge1xyXG4gICAgICAgICAgICBzdGF0ZS5uZXR3b3JrLmRlc3Ryb3koKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZ3JhcGguZWRnZXMgPSBncmFwaC5lZGdlcy5tYXAoZWRnZSA9PiBSLm1lcmdlKGVkZ2UsIHtcclxuICAgICAgICAgICAgcGh5c2ljczogZmFsc2UsXHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICBzdGF0ZS5uZXR3b3JrID0gbmV3IHZpcy5OZXR3b3JrKGNvbnRhaW5lciwgZ3JhcGgsIENvbnN0YW50cy5ncm91cFNjaGVtYU9wdHMpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiByZWRyYXdTY2hlbWEyKGdyYXBoRGF0YSwgY2xhc3NOYW1lKSB7XHJcbiAgICAgICAgY2xlYXJFbChxdWVyeUVsKGAke3Jvb3RUYWJ9IHN2Zy4ke2NsYXNzTmFtZX1gKSk7XHJcbiAgICAgICAgY29uc3Qgc3ZnID0gZDMuc2VsZWN0KGAke3Jvb3RUYWJ9IHN2Zy4ke2NsYXNzTmFtZX1gKTtcclxuICAgICAgICBjb25zdCBzdmdHcm91cCA9IHN2Zy5hcHBlbmQoJ2cnKTtcclxuICAgICAgICBjb25zdCByb290ID0gc3ZnR3JvdXAuYXBwZW5kKCdnJyk7XHJcblxyXG4gICAgICAgIC8vIGRlZmluZSBhbiBhcnJvdyBoZWFkXHJcbiAgICAgICAgc3ZnLmFwcGVuZCgnc3ZnOmRlZnMnKVxyXG4gICAgICAgICAgICAuYXBwZW5kKCdzdmc6bWFya2VyJylcclxuICAgICAgICAgICAgLmF0dHIoJ2lkJywgJ2VuZCcpXHJcbiAgICAgICAgICAgIC5hdHRyKCd2aWV3Qm94JywgJzAgLTUgMTAgMTAnKVxyXG4gICAgICAgICAgICAuYXR0cigncmVmWCcsIDEwKVxyXG4gICAgICAgICAgICAuYXR0cigncmVmWScsIDApXHJcbiAgICAgICAgICAgIC5hdHRyKCdtYXJrZXJXaWR0aCcsIDMpIC8vIG1hcmtlciBzZXR0aW5nc1xyXG4gICAgICAgICAgICAuYXR0cignbWFya2VySGVpZ2h0JywgNSlcclxuICAgICAgICAgICAgLmF0dHIoJ29yaWVudCcsICdhdXRvJylcclxuICAgICAgICAgICAgLnN0eWxlKCdmaWxsJywgJyM5OTknKVxyXG4gICAgICAgICAgICAuc3R5bGUoJ3N0cm9rZS1vcGFjaXR5JywgMC42KSAvLyBhcnJvd2hlYWQgY29sb3JcclxuICAgICAgICAgICAgLmFwcGVuZCgnc3ZnOnBhdGgnKVxyXG4gICAgICAgICAgICAuYXR0cignZCcsICdNMCwtNUwxMCwwTDAsNScpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IG5vZGVEaWN0ID0gZ3JhcGhEYXRhLm5vZGVzLnJlZHVjZSgoZGljdCwgbm9kZSwgaSkgPT4ge1xyXG4gICAgICAgICAgICBkaWN0W25vZGUuaWRdID0gaTtcclxuICAgICAgICAgICAgcmV0dXJuIGRpY3Q7XHJcbiAgICAgICAgfSwge30pO1xyXG5cclxuICAgICAgICBjb25zdCBub2RlV2lkdGggPSAxNzA7XHJcbiAgICAgICAgY29uc3Qgbm9kZUhlaWdodCA9IDIwO1xyXG5cclxuICAgICAgICBjb25zdCBuYW1lMk5vZGUgPSBvYmogPT4gKHtcclxuICAgICAgICAgICAgaWQ6IG5vZGVEaWN0W29iai5pZF0sXHJcbiAgICAgICAgICAgIG5hbWU6IG9iai5pZCxcclxuICAgICAgICAgICAgdGl0bGU6IG9iai50aXRsZSxcclxuICAgICAgICAgICAgbGFiZWw6IG9iai5sYWJlbCxcclxuICAgICAgICAgICAgd2lkdGg6IG5vZGVXaWR0aCxcclxuICAgICAgICAgICAgaGVpZ2h0OiBub2RlSGVpZ2h0XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHBhaXIyRWRnZSA9IChvYmosIGkpID0+ICh7XHJcbiAgICAgICAgICAgIGlkOiBpICsgZ3JhcGhEYXRhLm5vZGVzLmxlbmd0aCxcclxuICAgICAgICAgICAgc291cmNlOiBub2RlRGljdFtvYmoudG9dLFxyXG4gICAgICAgICAgICB0YXJnZXQ6IG5vZGVEaWN0W29iai5mcm9tXVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCBncmFwaCA9IHtcclxuICAgICAgICAgICAgbm9kZXM6IGdyYXBoRGF0YS5ub2Rlcy5tYXAobmFtZTJOb2RlKSxcclxuICAgICAgICAgICAgbGlua3M6IGdyYXBoRGF0YS5lZGdlcy5tYXAocGFpcjJFZGdlKVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGNvbnN0IGxheW91dGVyID0ga2xheS5kM2FkYXB0ZXIoKTtcclxuICAgICAgICBjb25zdCB3aWR0aCA9IDk2MDtcclxuICAgICAgICBjb25zdCBoZWlnaHQgPSA0MDA7XHJcblxyXG4gICAgICAgIGxheW91dGVyXHJcbiAgICAgICAgICAgIC5ub2RlcyhncmFwaC5ub2RlcylcclxuICAgICAgICAgICAgLmxpbmtzKGdyYXBoLmxpbmtzKVxyXG4gICAgICAgICAgICAuc2l6ZShbd2lkdGgsIGhlaWdodF0pXHJcbiAgICAgICAgICAgIC50cmFuc2Zvcm1Hcm91cChyb290KVxyXG4gICAgICAgICAgICAub3B0aW9ucyh7XHJcbiAgICAgICAgICAgICAgICBlZGdlUm91dGluZzogJ09SVEhPR09OQUwnLFxyXG4gICAgICAgICAgICAgICAgXCJkaXJlY3Rpb25cIjogXCJSSUdIVFwiLFxyXG4gICAgICAgICAgICAgICAgaW50Q29vcmRpbmF0ZXM6IGZhbHNlXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5kZWZhdWx0UG9ydFNpemUoWzIsIDJdKVxyXG4gICAgICAgICAgICAuc3RhcnQoKTtcclxuXHJcbiAgICAgICAgY29uc3QgbGluayA9IHJvb3Quc2VsZWN0QWxsKCcubGluaycpXHJcbiAgICAgICAgICAgIC5kYXRhKGdyYXBoLmxpbmtzKVxyXG4gICAgICAgICAgICAuZW50ZXIoKVxyXG4gICAgICAgICAgICAuYXBwZW5kKCdwYXRoJylcclxuICAgICAgICAgICAgLmF0dHIoJ2NsYXNzJywgJ2xpbmsnKVxyXG4gICAgICAgICAgICAuYXR0cignZCcsICdNMCAwJylcclxuICAgICAgICAgICAgLmF0dHIoJ21hcmtlci1lbmQnLCAndXJsKCNlbmQpJyk7XHJcblxyXG4gICAgICAgIC8vIHdlIGdyb3VwIG5vZGVzIGFsb25nIHdpdGggdGhlaXIgcG9ydHNcclxuICAgICAgICBjb25zdCBub2RlID0gcm9vdC5zZWxlY3RBbGwoJy5ub2RlJylcclxuICAgICAgICAgICAgLmRhdGEoZ3JhcGgubm9kZXMpXHJcbiAgICAgICAgICAgIC5lbnRlcigpXHJcbiAgICAgICAgICAgIC5hcHBlbmQoJ2cnKTtcclxuXHJcbiAgICAgICAgbm9kZS5hcHBlbmQoJ3JlY3QnKVxyXG4gICAgICAgICAgICAuYXR0cignY2xhc3MnLCAoZCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICdub2RlIHZhbGlkJztcclxuLy8gICAgICAgICAgICAgICAgY29uc3QgZGV0YWlscyA9IGNoZWNrUmVzLmRldGFpbHNbZC5uYW1lXTtcclxuLy8gICAgICAgICAgICAgICAgaWYgKGRldGFpbHMgPT09IHVuZGVmaW5lZCB8fCBkZXRhaWxzLmxlbmd0aCA9PT0gMCkge1xyXG4vLyAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdub2RlIHZhbGlkJztcclxuLy8gICAgICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgICAgICAgICByZXR1cm4gJ25vZGUgaW52YWxpZCc7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5hdHRyKCd3aWR0aCcsIG5vZGVXaWR0aClcclxuICAgICAgICAgICAgLmF0dHIoJ2hlaWdodCcsIG5vZGVIZWlnaHQpXHJcbiAgICAgICAgICAgIC5hdHRyKCd0aXRsZScsICdsaW5rJylcclxuICAgICAgICAgICAgLmF0dHIoJ3J4JywgNSlcclxuICAgICAgICAgICAgLmF0dHIoJ3J5JywgNSlcclxuICAgICAgICAgICAgLmF0dHIoJ3gnLCAwKVxyXG4gICAgICAgICAgICAuYXR0cigneScsIDApO1xyXG4gICAgICAgIFxyXG4gICAgICAgIG5vZGUuYXBwZW5kKCd0aXRsZScpLnRleHQoZCA9PiBkLnRpdGxlKVxyXG5cclxuICAgICAgICBub2RlLmFwcGVuZCgndGV4dCcpXHJcbiAgICAgICAgICAgIC5hdHRyKCd4Jywgbm9kZVdpZHRoIC8gMilcclxuICAgICAgICAgICAgLmF0dHIoJ3knLCBub2RlSGVpZ2h0IC8gMilcclxuICAgICAgICAgICAgLmF0dHIoJ2FsaWdubWVudC1iYXNlbGluZScsICdtaWRkbGUnKVxyXG4gICAgICAgICAgICAuYXR0cigndGV4dC1hbmNob3InLCAnbWlkZGxlJylcclxuLy8gICAgICAgICAgICAudGV4dChkID0+IGQubmFtZSlcclxuICAgICAgICAgICAgLnRleHQoZCA9PiBkLmxhYmVsKVxyXG4gICAgICAgICAgICAuYXR0cignZm9udC1zaXplJywgJzRweCcpO1xyXG5cclxuICAgICAgICAvLyBwb3J0c1xyXG4gICAgICAgIGNvbnN0IHBvcnQgPSBub2RlLnNlbGVjdEFsbCgnLnBvcnQnKVxyXG4gICAgICAgICAgICAuZGF0YShkID0+IGQucG9ydHMpXHJcbiAgICAgICAgICAgIC5lbnRlcigpXHJcbiAgICAgICAgICAgIC5hcHBlbmQoJ3JlY3QnKVxyXG4gICAgICAgICAgICAuYXR0cignY2xhc3MnLCAncG9ydCcpXHJcbiAgICAgICAgICAgIC5hdHRyKCd3aWR0aCcsIDIpXHJcbiAgICAgICAgICAgIC5hdHRyKCdoZWlnaHQnLCAyKVxyXG4gICAgICAgICAgICAuYXR0cigneCcsIDApXHJcbiAgICAgICAgICAgIC5hdHRyKCd5JywgMCk7XHJcblxyXG4gICAgICAgIC8vIGFwcGx5IGxheW91dFxyXG4gICAgICAgIGxheW91dGVyLm9uKCdmaW5pc2gnLCAoZDIpID0+IHtcclxuICAgICAgICAvLyBhcHBseSBlZGdlIHJvdXRlc1xyXG4gICAgICAgICAgICBsaW5rLnRyYW5zaXRpb24oKS5hdHRyKCdkJywgKGQpID0+IHtcclxuICAgICAgICAgICAgICAgIGxldCBwYXRoID0gJyc7XHJcbiAgICAgICAgICAgICAgICBwYXRoICs9IGBNJHtkLnNvdXJjZVBvaW50Lnh9ICR7ZC5zb3VyY2VQb2ludC55fSBgO1xyXG4gICAgICAgICAgICAgICAgZC5iZW5kUG9pbnRzLmZvckVhY2goKGJwLCBpKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGF0aCArPSBgTCR7YnAueH0gJHticC55fSBgO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBwYXRoICs9IGBMJHtkLnRhcmdldFBvaW50Lnh9ICR7ZC50YXJnZXRQb2ludC55fSBgO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHBhdGg7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8gYXBwbHkgbm9kZSBwb3NpdGlvbnNcclxuICAgICAgICAgICAgbm9kZS50cmFuc2l0aW9uKClcclxuICAgICAgICAgICAgICAgIC5hdHRyKCd0cmFuc2Zvcm0nLCBkID0+IGB0cmFuc2xhdGUoJHtkLnh9ICR7ZC55fSlgKTtcclxuXHJcbiAgICAgICAgICAgIC8vIGFwcGx5IHBvcnQgcG9zaXRpb25zXHJcbiAgICAgICAgICAgIHBvcnQudHJhbnNpdGlvbigpXHJcbiAgICAgICAgICAgICAgICAuYXR0cigneCcsIGQgPT4gZC54KVxyXG4gICAgICAgICAgICAgICAgLmF0dHIoJ3knLCBkID0+IGQueSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxheW91dGVyLnN0YXJ0KCk7XHJcbiAgICB9O1xyXG59KSh0aGlzLkdyb3VwU2NoZW1hID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1LTIwMTggVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcbiAgICBjb25zdCByb290ID0gJy5wcm9maWxlLWZpbHRlci10YWIgJztcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgY3JlYXRlR3JvdXBEaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhyb290LCBHcm91cFByb2ZpbGUuY3JlYXRlR3JvdXAoZmFsc2UsIGV4cG9ydHMucmVmcmVzaCksIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnbW9kYWwtcHJvbXB0LWJvZHknLFxyXG4gICAgICAgICAgICBkaWFsb2dUaXRsZTogJ2dyb3Vwcy1lbnRlci1ncm91cC1uYW1lJyxcclxuICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tY3JlYXRlJyxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgcmVuYW1lR3JvdXBEaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhyb290LCByZW5hbWVHcm91cChgJHtyb290fS5zYXZlLWVudGl0eS1zZWxlY3RgKSwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdtb2RhbC1wcm9tcHQtYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnZ3JvdXBzLWVudGVyLW5ldy1ncm91cC1uYW1lJyxcclxuICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tcmVuYW1lJyxcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuLy8gICAgICAgIHN0YXRlLmFkZEZpbHRlckNvbmRpdGlvbkRpYWxvZyA9IG5ldyBBZGRGaWx0ZXJDb25kaXRpb25EaWFsb2cocm9vdCk7XHJcbi8vICAgICAgICBsaXN0ZW4ocWUoYCR7cm9vdH0uY3JlYXRlLmZpbHRlci1jb25kaXRpb25gKSwgJ2NsaWNrJywgb25BZGRGaWx0ZXJDb25kaXRpb24pO1xyXG5cclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fSNwcm9maWxlLWZpbHRlci1jb2x1bW5zIC5wcm9maWxlLWl0ZW0tc2VsZWN0b3JgKSwgJ2NoYW5nZScsIFVJLnNob3dTZWxlY3RlZEVsczMocm9vdCwgJ2RlcGVuZGVudCcsICdkZXBlbmRlbnQtaW5kZXgnKSk7XHJcbiAgICAgICAgXHJcbi8vICAgICAgICBVdGlscy5lbmFibGUoZXhwb3J0cy5jb250ZW50LCAnaXNHcm91cEVkaXRhYmxlJywgaXNHcm91cEVkaXRhYmxlKTtcclxuLy8gICAgICAgIGxpc3RlbiBxdWVyeUVsKGAke3Jvb3R9LnNhdmUtZW50aXR5LXNlbGVjdGApXHJcbiAgICAgICAgXHJcbiAgICAgICAgJChgJHtyb290fS5zYXZlLWVudGl0eS1zZWxlY3RgKS5zZWxlY3QyKCkub24oJ2NoYW5nZScsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBncm91cCA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICAgICAgY29uc3QgdXNlckdyb3VwcyA9IHN0YXRlLnVzZXJHcm91cE5hbWVzLm1hcChSLnByb3AoJ3ZhbHVlJykpO1xyXG4gICAgICAgICAgICBjb25zdCBpc0dyb3VwRWRpdGFibGUgPSBSLmNvbnRhaW5zKGdyb3VwLCB1c2VyR3JvdXBzKTtcclxuICAgICAgICAgICAgVXRpbHMuZW5hYmxlKGV4cG9ydHMuY29udGVudCwgJ2lzR3JvdXBFZGl0YWJsZScsIGlzR3JvdXBFZGl0YWJsZSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LnNob3ctZW50aXR5LWJ1dHRvbmApLCAnY2xpY2snLCBsb2FkRmlsdGVyRnJvbUdyb3VwKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5zYXZlLWVudGl0eS1idXR0b25gKSwgJ2NsaWNrJywgc2F2ZUZpbHRlclRvR3JvdXApO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LmRvd25sb2FkLWZpbHRlci10YWJsZWApLCAnY2xpY2snLCBkb3dubG9hZEZpbHRlclRhYmxlKTtcclxuXHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9LmNyZWF0ZS5ncm91cGApLCAnY2xpY2snLCAoKSA9PiBjcmVhdGVHcm91cERpYWxvZy5zaG93RGxnKCkpO1xyXG4gICAgICAgIGxpc3RlbihxZShgJHtyb290fS5yZW5hbWUuZ3JvdXBgKSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBxZWUocmVuYW1lR3JvdXBEaWFsb2csICcuZW50aXR5LWlucHV0JykudmFsdWUgPSBxdWVyeUVsKGAke3Jvb3R9LnNhdmUtZW50aXR5LXNlbGVjdGApLnZhbHVlO1xyXG4gICAgICAgICAgICByZW5hbWVHcm91cERpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0ucmVtb3ZlLmdyb3VwYCksICdjbGljaycsIEdyb3VwUHJvZmlsZS5yZW1vdmVHcm91cCgoKSA9PiBcclxuICAgICAgICAgICAgcXVlcnlFbChgJHtyb290fS5zYXZlLWVudGl0eS1zZWxlY3RgKS52YWx1ZSwgZXhwb3J0cy5yZWZyZXNoKSk7XHJcblxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgc3RhdGUuc29ydEtleSA9IENvbnN0YW50cy5DSEFSX05BTUU7XHJcbiAgICAgICAgc3RhdGUuc29ydERpciA9ICdhc2MnO1xyXG4gICAgICAgIHN0YXRlLmlucHV0SXRlbXMgPSB7fTtcclxuICAgICAgICBzdGF0ZS5jaGVja2JveGVzID0ge307XHJcbiAgICAgICAgc3RhdGUuY3VyRmlsdGVyTW9kZWwgPSBbXTtcclxuXHJcbiAgICAgICAgY29uc3QgZmlsdGVyU2V0dGluZ3NEaXYgPSBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uZmlsdGVyLXNldHRpbmdzLXBhbmVsYCkpO1xyXG4gICAgICAgIGFkZEVsKGZpbHRlclNldHRpbmdzRGl2LCBhZGRDbGFzcyhtYWtlRWwoJ2RpdicpLCAnc2VwYXJhdG9yJykpO1xyXG5cclxuICAgICAgICBncm91cEFyZWFSZWZyZXNoKCk7XHJcblxyXG4gICAgICAgIEZpbHRlckNvbmZpZ3VyYXRpb24ubWFrZUZpbHRlckNvbmZpZ3VyYXRpb24oKGVyciwgZmlsdGVyQ29uZmlndXJhdGlvbikgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG5cclxuICAgICAgICAgICAgc3RhdGUuZmlsdGVyQ29uZmlndXJhdGlvbiA9IGZpbHRlckNvbmZpZ3VyYXRpb247XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBzaG93RWwocWUoYCR7cm9vdH0gLmFsZXJ0Lm5vLWNoYXJhY3RlcnNgKSwgIWZpbHRlckNvbmZpZ3VyYXRpb24uaGF2ZVByb2ZpbGVzKCkpO1xyXG4gICAgICAgICAgICBzaG93RWwocWUoYCR7cm9vdH0gLmFsZXJ0Lm5vLXBsYXllcnNgKSwgIWZpbHRlckNvbmZpZ3VyYXRpb24uaGF2ZVByb2ZpbGVzKCkpO1xyXG4gICAgICAgICAgICBzaG93RWwocWUoYCR7cm9vdH0gLmFsZXJ0Lm5vLWNoYXJhY3Rlci1wcm9maWxlYCksICFmaWx0ZXJDb25maWd1cmF0aW9uLmhhdmVQcm9maWxlU3RydWN0dXJlcygpKTtcclxuICAgICAgICAgICAgc2hvd0VsKHFlKGAke3Jvb3R9IC5hbGVydC5uby1wbGF5ZXItcHJvZmlsZWApLCAhZmlsdGVyQ29uZmlndXJhdGlvbi5oYXZlUHJvZmlsZVN0cnVjdHVyZXMoKSk7XHJcbiAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fSAucHJvZmlsZS1maWx0ZXItY29udGFpbmVyIC5wYW5lbGApLCBmaWx0ZXJDb25maWd1cmF0aW9uLmhhdmVEYXRhKCkpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc3QgZ3JvdXBlZFByb2ZpbGVGaWx0ZXJJdGVtcyA9IGZpbHRlckNvbmZpZ3VyYXRpb24uZ2V0R3JvdXBlZFByb2ZpbGVGaWx0ZXJJdGVtcygpO1xyXG4gICAgICAgICAgICBhZGRFbHMoZmlsdGVyU2V0dGluZ3NEaXYsIFIuZmxhdHRlbihncm91cGVkUHJvZmlsZUZpbHRlckl0ZW1zLm1hcChpdGVtID0+IFIuY29uY2F0KGl0ZW0ucHJvZmlsZUZpbHRlckl0ZW1zLm1hcChtYWtlSW5wdXQpLCBbYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ2ZpbHRlclNlcGFyYXRvcicpXSkpKSk7XHJcblxyXG4gICAgICAgICAgICBVSS5maWxsU2hvd0l0ZW1TZWxlY3RvcjIoXHJcbiAgICAgICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0jcHJvZmlsZS1maWx0ZXItY29sdW1ucyAucHJvZmlsZS1pdGVtLXNlbGVjdG9yYCkpLFxyXG4gICAgICAgICAgICAgICAgZmlsdGVyQ29uZmlndXJhdGlvbi5nZXRHcm91cHNGb3JTZWxlY3QoKSxcclxuICAgICAgICAgICAgICAgIHRydWVcclxuICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgIGFkZEVsKFxyXG4gICAgICAgICAgICAgICAgY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LmZpbHRlci1oZWFkYCkpLFxyXG4gICAgICAgICAgICAgICAgbWFrZUNvbnRlbnRIZWFkZXIoZ2V0SGVhZGVyUHJvZmlsZUl0ZW1OYW1lcyhmaWx0ZXJDb25maWd1cmF0aW9uLmdldFByb2ZpbGVGaWx0ZXJJdGVtcygpKSlcclxuICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgIHJlYnVpbGRDb250ZW50KCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBvbkFkZEZpbHRlckNvbmRpdGlvbigpIHtcclxuICAgICAgICBzdGF0ZS5hZGRGaWx0ZXJDb25kaXRpb25EaWFsb2cuc2hvd0RsZyhzdGF0ZS5maWx0ZXJDb25maWd1cmF0aW9uLmdldEdyb3Vwc0ZvclNlbGVjdCgpLCBzZXRGaWx0ZXJNb2RlbEl0ZW0pO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBzZXRGaWx0ZXJNb2RlbEl0ZW0gKGZpbHRlck1vZGVsSXRlbSkge1xyXG4gICAgICAgIGNvbnN0IGluZGV4ID0gUi5maW5kSW5kZXgoUi5wcm9wRXEoJ25hbWUnLCBmaWx0ZXJNb2RlbEl0ZW0ubmFtZSksIHN0YXRlLmN1ckZpbHRlck1vZGVsKTtcclxuICAgICAgICBpZihpbmRleCA9PT0gLTEpe1xyXG4gICAgICAgICAgICBzdGF0ZS5jdXJGaWx0ZXJNb2RlbC5wdXNoKGZpbHRlck1vZGVsSXRlbSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc3RhdGUuY3VyRmlsdGVyTW9kZWxbaW5kZXhdID0gZmlsdGVyTW9kZWxJdGVtO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgZnVuY3Rpb24gZ3JvdXBBcmVhUmVmcmVzaCgpIHtcclxuICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheSgnZ3JvdXAnLCB0cnVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKHVzZXJHcm91cE5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdncm91cCcsIGZhbHNlLCBVdGlscy5wcm9jZXNzRXJyb3IoKGFsbEdyb3VwTmFtZXMpID0+IHtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwocWUoYCR7cm9vdH0ucmVuYW1lLmdyb3VwYCksIGFsbEdyb3VwTmFtZXMubGVuZ3RoID4gMCk7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5lbmFibGVFbChxZShgJHtyb290fS5yZW1vdmUuZ3JvdXBgKSwgYWxsR3JvdXBOYW1lcy5sZW5ndGggPiAwKTtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKHFlKGAke3Jvb3R9LnNob3ctZW50aXR5LWJ1dHRvbmApLCBhbGxHcm91cE5hbWVzLmxlbmd0aCA+IDApO1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwocWUoYCR7cm9vdH0uc2F2ZS1lbnRpdHktYnV0dG9uYCksIGFsbEdyb3VwTmFtZXMubGVuZ3RoID4gMCk7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5lbmFibGVFbChxZShgJHtyb290fS5zYXZlLWVudGl0eS1zZWxlY3RgKSwgYWxsR3JvdXBOYW1lcy5sZW5ndGggPiAwKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgc3RhdGUudXNlckdyb3VwTmFtZXMgPSB1c2VyR3JvdXBOYW1lcztcclxuICAgICAgICAgICAgICAgIHN0YXRlLmFsbEdyb3VwTmFtZXMgPSBhbGxHcm91cE5hbWVzO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IGdldFNlbGVjdDJEYXRhKGFsbEdyb3VwTmFtZXMpO1xyXG4gICAgICAgICAgICAgICAgY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LnNhdmUtZW50aXR5LXNlbGVjdGApKTtcclxuICAgICAgICAgICAgICAgICQoYCR7cm9vdH0uc2F2ZS1lbnRpdHktc2VsZWN0YCkuc2VsZWN0MihkYXRhKTtcclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRIZWFkZXJQcm9maWxlSXRlbU5hbWVzKHByb2ZpbGVTZXR0aW5ncykge1xyXG4gICAgICAgIHJldHVybiBSLm1hcChSLnBpY2soWyduYW1lJywgJ2Rpc3BsYXlOYW1lJywgJ3R5cGUnXSksIHByb2ZpbGVTZXR0aW5ncyk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZVByaW50RGF0YSgpIHtcclxuICAgICAgICBjb25zdCBkYXRhQXJyYXlzID0gc3RhdGUuZmlsdGVyQ29uZmlndXJhdGlvbi5nZXREYXRhQXJyYXlzKG1ha2VGaWx0ZXJNb2RlbCgpKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc29ydEZ1bmMgPSBDb21tb25VdGlscy5jaGFyT3JkQUZhY3RvcnlCYXNlKHN0YXRlLnNvcnREaXIsIChhLCBiKSA9PiBhID4gYiwgKGEpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbWFwID0gQ29tbW9uVXRpbHMuYXJyMm1hcChhLCAnaXRlbU5hbWUnKTtcclxuICAgICAgICAgICAgY29uc3QgaXRlbSA9IG1hcFtzdGF0ZS5zb3J0S2V5XTtcclxuICAgICAgICAgICAgbGV0IHsgdmFsdWUgfSA9IGl0ZW07XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgICAgIHN3aXRjaCAoaXRlbS50eXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgJ3RleHQnOlxyXG4gICAgICAgICAgICBjYXNlICdzdHJpbmcnOlxyXG4gICAgICAgICAgICBjYXNlICdlbnVtJzpcclxuICAgICAgICAgICAgY2FzZSAnbXVsdGlFbnVtJzpcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdjaGVja2JveCc6XHJcbiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCB0eXBlICR7aXRlbS50eXBlfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gZGF0YUFycmF5cy5zb3J0KHNvcnRGdW5jKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZWJ1aWxkQ29udGVudCgpIHtcclxuICAgICAgICBjb25zdCBkYXRhQXJyYXlzID0gbWFrZVByaW50RGF0YSgpO1xyXG4gICAgICAgIGFkZEVsKGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5maWx0ZXItcmVzdWx0LXNpemVgKSksIG1ha2VUZXh0KGRhdGFBcnJheXMubGVuZ3RoKSk7XHJcbiAgICAgICAgYWRkRWxzKGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5maWx0ZXItY29udGVudGApKSwgZGF0YUFycmF5cy5tYXAobWFrZURhdGFTdHJpbmcpKTtcclxuICAgICAgICBVSS5zaG93U2VsZWN0ZWRFbHMzKHJvb3QsICdkZXBlbmRlbnQnLCAnZGVwZW5kZW50LWluZGV4JykoeyB0YXJnZXQ6IHF1ZXJ5RWwoYCR7cm9vdH0jcHJvZmlsZS1maWx0ZXItY29sdW1ucyAucHJvZmlsZS1pdGVtLXNlbGVjdG9yYCkgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2F2ZUZpbHRlclRvR3JvdXAoKSB7XHJcbiAgICAgICAgY29uc3QgZ3JvdXBOYW1lID0gcXVlcnlFbChgJHtyb290fS5zYXZlLWVudGl0eS1zZWxlY3RgKS52YWx1ZTtcclxuICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuaXNFbnRpdHlFZGl0YWJsZSgnZ3JvdXAnLCBncm91cE5hbWUsIChlcnIsIGlzR3JvdXBFZGl0YWJsZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBpZiAoIWlzR3JvdXBFZGl0YWJsZSkge1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWxlcnQoc3RyRm9ybWF0KGdldEwxMG4oJ2dyb3Vwcy1ncm91cC1lZGl0aW5nLWZvcmJpZGRlbicpLCBbZ3JvdXBOYW1lXSkpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIERCTVMuc2F2ZUZpbHRlclRvR3JvdXAoZ3JvdXBOYW1lLCBtYWtlRmlsdGVyTW9kZWwoKSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGxvYWRGaWx0ZXJGcm9tR3JvdXAoKSB7XHJcbiAgICAgICAgY29uc3QgZ3JvdXBOYW1lID0gcXVlcnlFbChgJHtyb290fS5zYXZlLWVudGl0eS1zZWxlY3RgKS52YWx1ZTtcclxuICAgICAgICBEQk1TLmdldEdyb3VwKGdyb3VwTmFtZSwgKGVyciwgZ3JvdXApID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgY29uc3QgY29uZmxpY3RUeXBlcyA9XHJcbiAgICAgICAgICAgICAgICBQcm9qZWN0VXRpbHMuaXNGaWx0ZXJNb2RlbENvbXBhdGlibGVXaXRoUHJvZmlsZXMoXHJcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUuZmlsdGVyQ29uZmlndXJhdGlvbi5nZXRCYXNlUHJvZmlsZVNldHRpbmdzKCksXHJcbiAgICAgICAgICAgICAgICAgICAgZ3JvdXAuZmlsdGVyTW9kZWxcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIGlmIChjb25mbGljdFR5cGVzLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWxlcnQoc3RyRm9ybWF0KGdldEwxMG4oJ2dyb3Vwcy1iYXNlLWZpbHRlci1pcy1pbmNvbXBhdGlibGUtd2l0aC1wYWdlLXByb2ZpbGVzJyksIFtjb25mbGljdFR5cGVzLmpvaW4oJywnKV0pKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBhcHBseUZpbHRlck1vZGVsKGdyb3VwLmZpbHRlck1vZGVsKTtcclxuICAgICAgICAgICAgcmVidWlsZENvbnRlbnQoKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBkb3dubG9hZEZpbHRlclRhYmxlKCkge1xyXG4gICAgICAgIGNvbnN0IGVsID0gcXVlcnlFbChgJHtyb290fSNwcm9maWxlLWZpbHRlci1jb2x1bW5zIC5wcm9maWxlLWl0ZW0tc2VsZWN0b3JgKTtcclxuICAgICAgICBjb25zdCBzZWxlY3RlZCA9IFtdO1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZWwub3B0aW9ucy5sZW5ndGg7IGkgKz0gMSkge1xyXG4gICAgICAgICAgICBzZWxlY3RlZFtpXSA9IGVsLm9wdGlvbnNbaV0uc2VsZWN0ZWQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBkYXRhQXJyYXlzID0gbWFrZVByaW50RGF0YSgpO1xyXG4gICAgICAgIGNvbnN0IGNsZWFuQXJyYXlzID0gZGF0YUFycmF5cy5tYXAoZGF0YUFycmF5ID0+IGRhdGFBcnJheS5maWx0ZXIoKGl0ZW0sIGluZGV4KSA9PiBzZWxlY3RlZFtpbmRleF0pLm1hcChSLnByb3AoJ3ZhbHVlJykpKTtcclxuXHJcbiAgICAgICAgRmlsZVV0aWxzLmFycjJkMkNzdihjbGVhbkFycmF5cywgJ3Byb2ZpbGVGaWx0ZXInKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBhcHBseUZpbHRlck1vZGVsKGZpbHRlck1vZGVsKSB7XHJcbiAgICAgICAgZmlsdGVyTW9kZWwgPSBDb21tb25VdGlscy5hcnIybWFwKGZpbHRlck1vZGVsLCAnbmFtZScpO1xyXG5cclxuICAgICAgICBPYmplY3Qua2V5cyhzdGF0ZS5pbnB1dEl0ZW1zKS5mb3JFYWNoKChpbnB1dEl0ZW1OYW1lKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChpbnB1dEl0ZW1OYW1lLmVuZHNXaXRoKCc6bnVtYmVySW5wdXQnKSB8fCBpbnB1dEl0ZW1OYW1lLmVuZHNXaXRoKCc6bXVsdGlFbnVtSW5wdXQnKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBpbnB1dEl0ZW0gPSBzdGF0ZS5pbnB1dEl0ZW1zW2lucHV0SXRlbU5hbWVdO1xyXG4gICAgICAgICAgICBsZXQgc2VsZWN0ZWRPcHRpb25zLCByZWdleCwgbnVtLCBpLCBjb3VudGVyO1xyXG5cclxuICAgICAgICAgICAgaWYgKHN0YXRlLmNoZWNrYm94ZXNbaW5wdXRJdGVtTmFtZV0uY2hlY2tlZCAhPT0gKGZpbHRlck1vZGVsW2lucHV0SXRlbU5hbWVdICE9PSB1bmRlZmluZWQpKSB7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5jaGVja2JveGVzW2lucHV0SXRlbU5hbWVdLmNsaWNrKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCFmaWx0ZXJNb2RlbFtpbnB1dEl0ZW1OYW1lXSkge1xyXG4gICAgICAgICAgICAgICAgbGV0IHNlbGVjdDtcclxuICAgICAgICAgICAgICAgIHN3aXRjaCAoaW5wdXRJdGVtLnNlbGZJbmZvLnR5cGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnOlxyXG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBpbnB1dEl0ZW0ub3B0aW9ucy5sZW5ndGg7IGkgKz0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnB1dEl0ZW0ub3B0aW9uc1tpXS5zZWxlY3RlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzpcclxuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5pbnB1dEl0ZW1zW2Ake2lucHV0SXRlbS5zZWxmSW5mby5uYW1lfTpudW1iZXJJbnB1dGBdLnZhbHVlID0gMDtcclxuICAgICAgICAgICAgICAgICAgICBpbnB1dEl0ZW0udmFsdWUgPSAnaWdub3JlJztcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ211bHRpRW51bSc6XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ID0gc3RhdGUuaW5wdXRJdGVtc1tgJHtpbnB1dEl0ZW0uc2VsZkluZm8ubmFtZX06bXVsdGlFbnVtSW5wdXRgXTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2VsZWN0Lm9wdGlvbnMubGVuZ3RoOyBpICs9IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Lm9wdGlvbnNbaV0uc2VsZWN0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpbnB1dEl0ZW0udmFsdWUgPSAnaWdub3JlJztcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3RleHQnOlxyXG4gICAgICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzpcclxuICAgICAgICAgICAgICAgICAgICBpbnB1dEl0ZW0udmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR5cGUgJHtpbnB1dEl0ZW0uc2VsZkluZm8udHlwZX1gKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG1vZGVsSXRlbSA9IGZpbHRlck1vZGVsW2lucHV0SXRlbU5hbWVdO1xyXG4gICAgICAgICAgICAgICAgbGV0IHNlbGVjdDtcclxuICAgICAgICAgICAgICAgIHN3aXRjaCAoaW5wdXRJdGVtLnNlbGZJbmZvLnR5cGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBpbnB1dEl0ZW0ub3B0aW9ucy5sZW5ndGg7IGkgKz0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnB1dEl0ZW0ub3B0aW9uc1tpXS5zZWxlY3RlZCA9ICEhbW9kZWxJdGVtLnNlbGVjdGVkT3B0aW9uc1tpbnB1dEl0ZW0ub3B0aW9uc1tpXS52YWx1ZV07XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnOlxyXG4gICAgICAgICAgICAgICAgICAgIGlucHV0SXRlbS5vcHRpb25zWzBdLnNlbGVjdGVkID0gbW9kZWxJdGVtLnNlbGVjdGVkT3B0aW9ucy50cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGlucHV0SXRlbS5vcHRpb25zWzFdLnNlbGVjdGVkID0gbW9kZWxJdGVtLnNlbGVjdGVkT3B0aW9ucy5mYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgICAgICAgICAgaW5wdXRJdGVtLnZhbHVlID0gbW9kZWxJdGVtLmNvbmRpdGlvbjtcclxuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5pbnB1dEl0ZW1zW2Ake2lucHV0SXRlbS5zZWxmSW5mby5uYW1lfTpudW1iZXJJbnB1dGBdLnZhbHVlID0gbW9kZWxJdGVtLm51bTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ211bHRpRW51bSc6XHJcbiAgICAgICAgICAgICAgICAgICAgaW5wdXRJdGVtLnZhbHVlID0gbW9kZWxJdGVtLmNvbmRpdGlvbjtcclxuICAgICAgICAgICAgICAgICAgICBzZWxlY3QgPSBzdGF0ZS5pbnB1dEl0ZW1zW2Ake2lucHV0SXRlbS5zZWxmSW5mby5uYW1lfTptdWx0aUVudW1JbnB1dGBdO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZWxlY3Qub3B0aW9ucy5sZW5ndGg7IGkgKz0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Qub3B0aW9uc1tpXS5zZWxlY3RlZCA9ICEhbW9kZWxJdGVtLnNlbGVjdGVkT3B0aW9uc1tzZWxlY3Qub3B0aW9uc1tpXS52YWx1ZV07XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgICAgICAgICBjYXNlICdzdHJpbmcnOlxyXG4gICAgICAgICAgICAgICAgICAgIGlucHV0SXRlbS52YWx1ZSA9IG1vZGVsSXRlbS5yZWdleFN0cmluZztcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR5cGUgJHtpbnB1dEl0ZW0uc2VsZkluZm8udHlwZX1gKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VGaWx0ZXJNb2RlbCgpIHtcclxuICAgICAgICBjb25zdCBtb2RlbCA9IFtdO1xyXG4gICAgICAgIE9iamVjdC5rZXlzKHN0YXRlLmlucHV0SXRlbXMpLmZvckVhY2goKGlucHV0SXRlbU5hbWUpID0+IHtcclxuICAgICAgICAgICAgaWYgKGlucHV0SXRlbU5hbWUuZW5kc1dpdGgoJzpudW1iZXJJbnB1dCcpIHx8IGlucHV0SXRlbU5hbWUuZW5kc1dpdGgoJzptdWx0aUVudW1JbnB1dCcpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHN0YXRlLmNoZWNrYm94ZXNbaW5wdXRJdGVtTmFtZV0uY2hlY2tlZCA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBpbnB1dEl0ZW0gPSBzdGF0ZS5pbnB1dEl0ZW1zW2lucHV0SXRlbU5hbWVdO1xyXG4gICAgICAgICAgICBsZXQgc2VsZWN0ZWRPcHRpb25zLCByZWdleCwgbnVtLCBpLCBhcnI7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgdHlwZSB9ID0gaW5wdXRJdGVtLnNlbGZJbmZvO1xyXG5cclxuICAgICAgICAgICAgbGV0IHNlbGVjdDI7XHJcbiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlICdlbnVtJzpcclxuICAgICAgICAgICAgICAgIGFyciA9IG5sMmFycmF5KGlucHV0SXRlbS5zZWxlY3RlZE9wdGlvbnMpLm1hcChSLnByb3AoJ3ZhbHVlJykpO1xyXG4gICAgICAgICAgICAgICAgbW9kZWwucHVzaCh7IHR5cGUsIG5hbWU6IGlucHV0SXRlbU5hbWUsIHNlbGVjdGVkT3B0aW9uczogUi56aXBPYmooYXJyLCBSLnJlcGVhdCh0cnVlLCBhcnIubGVuZ3RoKSkgfSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnOlxyXG4gICAgICAgICAgICAgICAgc2VsZWN0ZWRPcHRpb25zID0ge307XHJcbiAgICAgICAgICAgICAgICBpZiAoaW5wdXRJdGVtLm9wdGlvbnNbMF0uc2VsZWN0ZWQpIHsgc2VsZWN0ZWRPcHRpb25zLnRydWUgPSB0cnVlOyB9XHJcbiAgICAgICAgICAgICAgICBpZiAoaW5wdXRJdGVtLm9wdGlvbnNbMV0uc2VsZWN0ZWQpIHsgc2VsZWN0ZWRPcHRpb25zLmZhbHNlID0gdHJ1ZTsgfVxyXG4gICAgICAgICAgICAgICAgbW9kZWwucHVzaCh7IHR5cGUsIG5hbWU6IGlucHV0SXRlbU5hbWUsIHNlbGVjdGVkT3B0aW9ucyB9KTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgICAgICAgICAgaWYgKGlucHV0SXRlbS52YWx1ZSA9PT0gJ2lnbm9yZScpIHsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBudW0gPSBOdW1iZXIoc3RhdGUuaW5wdXRJdGVtc1tgJHtpbnB1dEl0ZW0uc2VsZkluZm8ubmFtZX06bnVtYmVySW5wdXRgXS52YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICBtb2RlbC5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlLCBuYW1lOiBpbnB1dEl0ZW1OYW1lLCBudW0sIGNvbmRpdGlvbjogaW5wdXRJdGVtLnZhbHVlXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdtdWx0aUVudW0nOlxyXG4gICAgICAgICAgICAgICAgaWYgKGlucHV0SXRlbS52YWx1ZSA9PT0gJ2lnbm9yZScpIHsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBzZWxlY3RlZE9wdGlvbnMgPSB7fTtcclxuICAgICAgICAgICAgICAgIHNlbGVjdDIgPSBzdGF0ZS5pbnB1dEl0ZW1zW2Ake2lucHV0SXRlbS5zZWxmSW5mby5uYW1lfTptdWx0aUVudW1JbnB1dGBdO1xyXG4gICAgICAgICAgICAgICAgYXJyID0gbmwyYXJyYXkoc2VsZWN0Mi5zZWxlY3RlZE9wdGlvbnMpLm1hcChSLnByb3AoJ3ZhbHVlJykpO1xyXG4gICAgICAgICAgICAgICAgbW9kZWwucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZSxcclxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBpbnB1dEl0ZW1OYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbjogaW5wdXRJdGVtLnZhbHVlLFxyXG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkT3B0aW9uczogUi56aXBPYmooYXJyLCBSLnJlcGVhdCh0cnVlLCBhcnIubGVuZ3RoKSlcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ3RleHQnOlxyXG4gICAgICAgICAgICBjYXNlICdzdHJpbmcnOlxyXG4gICAgICAgICAgICAgICAgbW9kZWwucHVzaCh7IHR5cGUsIG5hbWU6IGlucHV0SXRlbU5hbWUsIHJlZ2V4U3RyaW5nOiBpbnB1dEl0ZW0udmFsdWUudG9Mb3dlckNhc2UoKSB9KTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR5cGUgJHt0eXBlfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIG1vZGVsO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VEYXRhU3RyaW5nKGRhdGFBcnJheSkge1xyXG4gICAgICAgIGNvbnN0IHsgaW5wdXRJdGVtcyB9ID0gc3RhdGU7XHJcbiAgICAgICAgcmV0dXJuIGFkZEVscyhtYWtlRWwoJ3RyJyksIGRhdGFBcnJheS5tYXAoKHZhbHVlSW5mbywgaSkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgcmVnZXgsIHBvcywgZGlzcGxheVZhbHVlO1xyXG4gICAgICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSB2YWx1ZUluZm87XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBkaXNwbGF5VmFsdWUgPSBjb25zdEwxMG4oJ25vdEF2YWlsYWJsZScpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlSW5mby50eXBlID09PSAnY2hlY2tib3gnKSB7XHJcbiAgICAgICAgICAgICAgICBkaXNwbGF5VmFsdWUgPSBjb25zdEwxMG4oQ29uc3RhbnRzW3ZhbHVlXSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWVJbmZvLnR5cGUgPT09ICd0ZXh0Jykge1xyXG4gICAgICAgICAgICAgICAgcG9zID0gdmFsdWUudG9Mb3dlckNhc2UoKS5pbmRleE9mKGlucHV0SXRlbXNbdmFsdWVJbmZvLml0ZW1OYW1lXS52YWx1ZS50b0xvd2VyQ2FzZSgpKTtcclxuICAgICAgICAgICAgICAgIGRpc3BsYXlWYWx1ZSA9IHZhbHVlLnN1YnN0cmluZyhwb3MgLSA1LCBwb3MgKyAxNSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoUi5jb250YWlucyh2YWx1ZUluZm8udHlwZSwgWydudW1iZXInLCAnZW51bScsICdtdWx0aUVudW0nLCAnc3RyaW5nJ10pKSB7XHJcbiAgICAgICAgICAgICAgICBkaXNwbGF5VmFsdWUgPSB2YWx1ZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCB2YWx1ZUluZm8udHlwZTogJHt2YWx1ZUluZm8udHlwZX1gKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCB0ZCA9IGFkZEVsKHNldENsYXNzQnlDb25kaXRpb24obWFrZUVsKCd0ZCcpLCAnbGlnaHRHcmV5JywgdmFsdWUgPT09IHVuZGVmaW5lZCksIG1ha2VUZXh0KGRpc3BsYXlWYWx1ZSkpO1xyXG4gICAgICAgICAgICBhZGRDbGFzc2VzKHRkLCBbYGRlcGVuZGVudC0ke2l9YCwgJ2RlcGVuZGVudCcsIHZhbHVlSW5mby50eXBlID09PSAnbnVtYmVyJyA/ICd0ZXh0LWFsaWduLXJpZ2h0JyA6ICd0ZXh0LWFsaWduLWxlZnQnXSk7XHJcbiAgICAgICAgICAgIHNldEF0dHIodGQsICdkZXBlbmRlbnQtaW5kZXgnLCBpKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRkO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlQ29udGVudEhlYWRlcihwcm9maWxlSXRlbU5hbWVzKSB7XHJcbiAgICAgICAgcmV0dXJuIGFkZEVscyhtYWtlRWwoJ3RyJyksIHByb2ZpbGVJdGVtTmFtZXMubWFwKChlbGVtLCBpKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRkID0gYWRkRWxzKG1ha2VFbCgndGgnKSwgW21ha2VUZXh0KGAke2VsZW0uZGlzcGxheU5hbWV9IGApXSk7XHJcbiAgICAgICAgICAgIHRkLmluZm8gPSBlbGVtLm5hbWU7XHJcbiAgICAgICAgICAgIGFkZENsYXNzZXModGQsIFtgZGVwZW5kZW50LSR7aX1gLCAnZGVwZW5kZW50JywgJ3NvcnRpbmcnLCBlbGVtLnR5cGUgPT09ICdudW1iZXInID8gJ3RleHQtYWxpZ24tcmlnaHQnIDogJ3RleHQtYWxpZ24tbGVmdCddKTtcclxuICAgICAgICAgICAgc2V0QXR0cih0ZCwgJ2RlcGVuZGVudC1pbmRleCcsIGkpO1xyXG4gICAgICAgICAgICBsaXN0ZW4odGQsICdjbGljaycsIG9uU29ydENoYW5nZSk7XHJcbiAgICAgICAgICAgIHJldHVybiB0ZDtcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25Tb3J0Q2hhbmdlKGV2ZW50KSB7XHJcbiAgICAgICAgbGV0IHsgdGFyZ2V0IH0gPSBldmVudDtcclxuICAgICAgICBpZiAodGFyZ2V0LnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ3NwYW4nKSB7XHJcbiAgICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnRFbGVtZW50O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHN0YXRlLnNvcnRLZXkgPT09IHRhcmdldC5pbmZvKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLnNvcnREaXIgPSBzdGF0ZS5zb3J0RGlyID09PSAnYXNjJyA/ICdkZXNjJyA6ICdhc2MnO1xyXG4gICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKHRhcmdldCwgJ3NvcnREZXNjJywgc3RhdGUuc29ydERpciA9PT0gJ2Rlc2MnKTtcclxuICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbih0YXJnZXQsICdzb3J0QXNjJywgc3RhdGUuc29ydERpciA9PT0gJ2FzYycpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpbHRlckhlYWQgPSBxdWVyeUVsKGAke3Jvb3R9LmZpbHRlci1oZWFkYCk7XHJcbiAgICAgICAgICAgIG5sMmFycmF5KGZpbHRlckhlYWQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnc29ydEFzYycpKS5mb3JFYWNoKHJlbW92ZUNsYXNzKFIuX18sICdzb3J0QXNjJykpO1xyXG4gICAgICAgICAgICBubDJhcnJheShmaWx0ZXJIZWFkLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ3NvcnREZXNjJykpLmZvckVhY2gocmVtb3ZlQ2xhc3MoUi5fXywgJ3NvcnREZXNjJykpO1xyXG5cclxuICAgICAgICAgICAgc3RhdGUuc29ydEtleSA9IHRhcmdldC5pbmZvO1xyXG4gICAgICAgICAgICBzdGF0ZS5zb3J0RGlyID0gJ2FzYyc7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKHRhcmdldCwgJ3NvcnRBc2MnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVidWlsZENvbnRlbnQoKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlSW5wdXQocHJvZmlsZUl0ZW1Db25maWcpIHtcclxuICAgICAgICBjb25zdCBlbCA9IHFtdGUoYCR7cm9vdH0gLmZpbHRlci1pdGVtLXRtcGxgKTtcclxuICAgICAgICBjb25zdCBjaGVja2JveCA9IHFlZShlbCwgJ2lucHV0W3R5cGU9XCJjaGVja2JveFwiXScpO1xyXG4gICAgICAgIGNvbnN0IGlkID0gXCJmaWx0ZXItaXRlbS1cIiArIHByb2ZpbGVJdGVtQ29uZmlnLmRpc3BsYXlOYW1lO1xyXG4gICAgICAgIGNoZWNrYm94LmNoZWNrZWQgPSBmYWxzZTtcclxuICAgICAgICBjaGVja2JveC5pZCA9IGlkO1xyXG4gICAgICAgIGFkZEVsKHFlZShlbCwgJy5maWx0ZXItaXRlbS1uYW1lJyksIG1ha2VUZXh0KHByb2ZpbGVJdGVtQ29uZmlnLmRpc3BsYXlOYW1lKSk7XHJcbiAgICAgICAgc2V0QXR0cihxZWUoZWwsICdsYWJlbCcpLCAnZm9yJywgaWQpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IGlucHV0Q29udGFpbmVyID0gcWVlKGVsLCAnLmZpbHRlci1pdGVtLWNvbnRhaW5lcicpO1xyXG4gICAgICAgIGxpc3RlbihjaGVja2JveCwgJ2NsaWNrJywgdG9nZ2xlQ29udGVudChlbCwgaW5wdXRDb250YWluZXIpKTtcclxuICAgICAgICBzdGF0ZS5jaGVja2JveGVzW3Byb2ZpbGVJdGVtQ29uZmlnLm5hbWVdID0gY2hlY2tib3g7XHJcbiAgICAgICAgXHJcbiAgICAgICAgYWRkRWwoaW5wdXRDb250YWluZXIsIG1ha2VGaWx0ZXIocHJvZmlsZUl0ZW1Db25maWcpKTtcclxuICAgICAgICByZXR1cm4gZWw7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIHRvZ2dsZUNvbnRlbnQoaXRlbUNvbnRhaW5lciwgaW5wdXRDb250YWluZXIpIHtcclxuICAgICAgICByZXR1cm4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGhpZGVFbChpbnB1dENvbnRhaW5lciwgIWV2ZW50LnRhcmdldC5jaGVja2VkKTtcclxuICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihpdGVtQ29udGFpbmVyLCAnZmxleC1mcm9udC1lbGVtZW50JywgZXZlbnQudGFyZ2V0LmNoZWNrZWQpO1xyXG4gICAgICAgICAgICByZWJ1aWxkQ29udGVudCgpO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUZpbHRlcihwcm9maWxlSXRlbUNvbmZpZykge1xyXG4gICAgICAgIHN3aXRjaCAocHJvZmlsZUl0ZW1Db25maWcudHlwZSkge1xyXG4gICAgICAgIGNhc2UgJ3RleHQnOlxyXG4gICAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgICAgIHJldHVybiBtYWtlVGV4dEZpbHRlcihwcm9maWxlSXRlbUNvbmZpZyk7XHJcbiAgICAgICAgY2FzZSAnZW51bSc6XHJcbiAgICAgICAgICAgIHJldHVybiBtYWtlRW51bUZpbHRlcihwcm9maWxlSXRlbUNvbmZpZyk7XHJcbiAgICAgICAgY2FzZSAnbXVsdGlFbnVtJzpcclxuICAgICAgICAgICAgcmV0dXJuIG1ha2VNdWx0aUVudW1GaWx0ZXIocHJvZmlsZUl0ZW1Db25maWcpO1xyXG4gICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgIHJldHVybiBtYWtlTnVtYmVyRmlsdGVyKHByb2ZpbGVJdGVtQ29uZmlnKTtcclxuICAgICAgICBjYXNlICdjaGVja2JveCc6XHJcbiAgICAgICAgICAgIHJldHVybiBtYWtlQ2hlY2tib3hGaWx0ZXIocHJvZmlsZUl0ZW1Db25maWcpO1xyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCB0eXBlICR7cHJvZmlsZUl0ZW1Db25maWcudHlwZX1gKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZVRleHRGaWx0ZXIocHJvZmlsZUl0ZW1Db25maWcpIHtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IHFtdGUoYCR7cm9vdH0gLnRleHQtZmlsdGVyLXRtcGxgKTtcclxuICAgICAgICBpbnB1dC5zZWxmSW5mbyA9IHByb2ZpbGVJdGVtQ29uZmlnO1xyXG4gICAgICAgIGlucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCByZWJ1aWxkQ29udGVudCk7XHJcbiAgICAgICAgc3RhdGUuaW5wdXRJdGVtc1twcm9maWxlSXRlbUNvbmZpZy5uYW1lXSA9IGlucHV0O1xyXG4gICAgICAgIHJldHVybiBpbnB1dDtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlQ29tbW9uRW51bUZpbHRlcihwcm9maWxlSXRlbUNvbmZpZywgdmFsdWVzKSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZWN0b3IgPSBxbXRlKGAke3Jvb3R9IC5jb21tb24tZW51bS1maWx0ZXItdG1wbGApO1xyXG4gICAgICAgIHNlbGVjdG9yLnNlbGZJbmZvID0gcHJvZmlsZUl0ZW1Db25maWc7XHJcbiAgICAgICAgc2VsZWN0b3Iuc2l6ZSA9IHZhbHVlcy5sZW5ndGg7XHJcblxyXG4gICAgICAgIGZpbGxTZWxlY3RvcihzZWxlY3RvciwgdmFsdWVzLm1hcCgodmFsdWUpID0+IHtcclxuICAgICAgICAgICAgdmFsdWUuc2VsZWN0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHNlbGVjdG9yLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIHJlYnVpbGRDb250ZW50KTtcclxuICAgICAgICBzdGF0ZS5pbnB1dEl0ZW1zW3Byb2ZpbGVJdGVtQ29uZmlnLm5hbWVdID0gc2VsZWN0b3I7XHJcbiAgICAgICAgcmV0dXJuIHNlbGVjdG9yO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VFbnVtRmlsdGVyKHByb2ZpbGVJdGVtQ29uZmlnKSB7XHJcbiAgICAgICAgY29uc3QgdmFsdWVzID0gYXJyMlNlbGVjdChwcm9maWxlSXRlbUNvbmZpZy52YWx1ZS5zcGxpdCgnLCcpKTtcclxuICAgICAgICByZXR1cm4gbWFrZUNvbW1vbkVudW1GaWx0ZXIocHJvZmlsZUl0ZW1Db25maWcsIHZhbHVlcyk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUNoZWNrYm94RmlsdGVyKHByb2ZpbGVJdGVtQ29uZmlnKSB7XHJcbiAgICAgICAgY29uc3QgdmFsdWVzID0gW3tcclxuICAgICAgICAgICAgdmFsdWU6IENvbnN0YW50cy50cnVlLFxyXG4gICAgICAgICAgICBuYW1lOiBjb25zdEwxMG4oQ29uc3RhbnRzLnRydWUpXHJcbiAgICAgICAgfSwge1xyXG4gICAgICAgICAgICB2YWx1ZTogQ29uc3RhbnRzLmZhbHNlLFxyXG4gICAgICAgICAgICBuYW1lOiBjb25zdEwxMG4oQ29uc3RhbnRzLmZhbHNlKVxyXG4gICAgICAgIH1dO1xyXG4gICAgICAgIHJldHVybiBtYWtlQ29tbW9uRW51bUZpbHRlcihwcm9maWxlSXRlbUNvbmZpZywgdmFsdWVzKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlTXVsdGlFbnVtRmlsdGVyKHByb2ZpbGVJdGVtQ29uZmlnKSB7XHJcbiAgICAgICAgY29uc3QgZmlsdGVyID0gcW10ZShgJHtyb290fSAubXVsdGktZW51bS1maWx0ZXItdG1wbGApO1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdG9yID0gcWVlKGZpbHRlciwgJy5tdWx0aS1lbnVtLWZpbHRlci10eXBlJyk7XHJcbiAgICAgICAgc2VsZWN0b3Iuc2VsZkluZm8gPSBwcm9maWxlSXRlbUNvbmZpZztcclxuXHJcbiAgICAgICAgQ29uc3RhbnRzLm11bHRpRW51bUZpbHRlci5mb3JFYWNoKCh2YWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBvcHRpb24gPSBtYWtlRWwoJ29wdGlvbicpO1xyXG4gICAgICAgICAgICBvcHRpb24uYXBwZW5kQ2hpbGQobWFrZVRleHQoY29uc3RMMTBuKHZhbHVlKSkpO1xyXG4gICAgICAgICAgICBvcHRpb24udmFsdWUgPSB2YWx1ZTtcclxuICAgICAgICAgICAgc2VsZWN0b3IuYXBwZW5kQ2hpbGQob3B0aW9uKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBzZWxlY3Rvci5zZWxlY3RlZEluZGV4ID0gMDtcclxuICAgICAgICBzdGF0ZS5pbnB1dEl0ZW1zW3Byb2ZpbGVJdGVtQ29uZmlnLm5hbWVdID0gc2VsZWN0b3I7XHJcbiAgICAgICAgc2VsZWN0b3IuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgcmVidWlsZENvbnRlbnQpO1xyXG5cclxuICAgICAgICBjb25zdCBzZWxlY3RvcjIgPSBxZWUoZmlsdGVyLCAnLm11bHRpLWVudW0tZmlsdGVyLWNvbnRlbnQnKTtcclxuICAgICAgICBjb25zdCB2YWx1ZXMgPSBhcnIyU2VsZWN0KHByb2ZpbGVJdGVtQ29uZmlnLnZhbHVlLnNwbGl0KCcsJykpO1xyXG4gICAgICAgIGZpbGxTZWxlY3RvcihzZWxlY3RvcjIsIHZhbHVlcy5tYXAoKHZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgIHZhbHVlLnNlbGVjdGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgIH0pKTtcclxuICAgICAgICBzZWxlY3RvcjIuc2l6ZSA9IHZhbHVlcy5sZW5ndGg7XHJcblxyXG4gICAgICAgIHN0YXRlLmlucHV0SXRlbXNbYCR7cHJvZmlsZUl0ZW1Db25maWcubmFtZX06bXVsdGlFbnVtSW5wdXRgXSA9IHNlbGVjdG9yMjtcclxuICAgICAgICBzZWxlY3RvcjIuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgcmVidWlsZENvbnRlbnQpO1xyXG4gICAgICAgIHJldHVybiBmaWx0ZXI7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZU51bWJlckZpbHRlcihwcm9maWxlSXRlbUNvbmZpZykge1xyXG4gICAgICAgIGNvbnN0IGZpbHRlciA9IHFtdGUoYCR7cm9vdH0gLm51bWJlci1maWx0ZXItdG1wbGApO1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdG9yID0gcWVlKGZpbHRlciwgJ3NlbGVjdCcpO1xyXG4gICAgICAgIHNlbGVjdG9yLnNlbGZJbmZvID0gcHJvZmlsZUl0ZW1Db25maWc7XHJcblxyXG4gICAgICAgIENvbnN0YW50cy5udW1iZXJGaWx0ZXIuZm9yRWFjaCgodmFsdWUpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgb3B0aW9uID0gbWFrZUVsKCdvcHRpb24nKTtcclxuICAgICAgICAgICAgb3B0aW9uLmFwcGVuZENoaWxkKG1ha2VUZXh0KGNvbnN0TDEwbih2YWx1ZSkpKTtcclxuICAgICAgICAgICAgb3B0aW9uLnZhbHVlID0gdmFsdWU7XHJcbiAgICAgICAgICAgIHNlbGVjdG9yLmFwcGVuZENoaWxkKG9wdGlvbik7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgc2VsZWN0b3Iuc2VsZWN0ZWRJbmRleCA9IDA7XHJcbiAgICAgICAgc3RhdGUuaW5wdXRJdGVtc1twcm9maWxlSXRlbUNvbmZpZy5uYW1lXSA9IHNlbGVjdG9yO1xyXG4gICAgICAgIHNlbGVjdG9yLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIHJlYnVpbGRDb250ZW50KTtcclxuXHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSBxZWUoZmlsdGVyLCAnaW5wdXQnKTtcclxuICAgICAgICBpbnB1dC52YWx1ZSA9IDA7XHJcbiAgICAgICAgc3RhdGUuaW5wdXRJdGVtc1tgJHtwcm9maWxlSXRlbUNvbmZpZy5uYW1lfTpudW1iZXJJbnB1dGBdID0gaW5wdXQ7XHJcbiAgICAgICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCByZWJ1aWxkQ29udGVudCk7XHJcbiAgICAgICAgcmV0dXJuIGZpbHRlcjtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZW5hbWVHcm91cChzZWxlY3Rvcikge1xyXG4gICAgICAgIHJldHVybiBkaWFsb2cgPT4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0b0lucHV0ID0gcWVlKGRpYWxvZywgJy5lbnRpdHktaW5wdXQnKTtcclxuICAgICAgICAgICAgY29uc3QgZnJvbU5hbWUgPSBxdWVyeUVsKHNlbGVjdG9yKS52YWx1ZTtcclxuICAgICAgICAgICAgY29uc3QgdG9OYW1lID0gdG9JbnB1dC52YWx1ZS50cmltKCk7XHJcblxyXG4gICAgICAgICAgICBEQk1TLnJlbmFtZUdyb3VwKGZyb21OYW1lLCB0b05hbWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5yZWZyZXNoKChlcnIyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgdG9JbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxufSkodGhpcy5Qcm9maWxlRmlsdGVyID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE2IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gZ2V0RWwoJ2Fib3V0RGl2Jyk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgIH07XHJcbn0pKHRoaXMuQWJvdXQgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTYgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHJvb3QgPSAnLmxvZy12aWV3ZXItdGFiICc7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBhZ2luYXRpb24gPSBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0ucGFnaW5hdGlvbmApKTtcclxuICAgICAgICBhZGRFbHMocGFnaW5hdGlvbiwgUi5yYW5nZSgwLCAyMCkubWFwKChudW0pID0+IHtcclxuICAgICAgICAgICAgY29uc3QgYSA9IHNldEF0dHIobWFrZUVsKCdhJyksICdocmVmJywgJyMnKTtcclxuICAgICAgICAgICAgY29uc3QgbGkgPSBhZGRFbChtYWtlRWwoJ2xpJyksIGEpO1xyXG4gICAgICAgICAgICBsaS5udW0gPSBudW07XHJcbiAgICAgICAgICAgIGFkZEVsKGEsIG1ha2VUZXh0KG51bSArIDEpKTtcclxuICAgICAgICAgICAgbGlzdGVuKGEsICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGdldERhdGEoeyB0YXJnZXQ6IHsgdmFsdWU6IG51bSB9IH0pO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcHJldkFjdGl2ZSA9IHF1ZXJ5RWwoYCR7cm9vdH0ucGFnaW5hdGlvbiBsaS5hY3RpdmVgKTtcclxuICAgICAgICAgICAgICAgIGlmIChwcmV2QWN0aXZlICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3MocHJldkFjdGl2ZSwgJ2FjdGl2ZScpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3MobGksICdhY3RpdmUnKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBsaTtcclxuICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9YnV0dG9uLmNsZWFyLWZpbHRlcmApLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHF1ZXJ5RWxzKGAke3Jvb3R9aW5wdXRbZmlsdGVyXWApLmZvckVhY2goZWwgPT4gKGVsLnZhbHVlID0gJycpKTtcclxuICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHF1ZXJ5RWxzKGAke3Jvb3R9aW5wdXRbZmlsdGVyXWApLmZvckVhY2gobGlzdGVuKFIuX18sICdpbnB1dCcsIGV4cG9ydHMucmVmcmVzaCkpO1xyXG5cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgcXVlcnlFbHMoYCR7cm9vdH0ucGFnaW5hdGlvbiBsaSBhYClbMF0uY2xpY2soKTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gZGF0YVJlY2lldmVkKGVyciwgZGF0YSkge1xyXG4gICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgYWRkRWwoY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LnJlc3VsdC1udW1iZXJgKSksIG1ha2VUZXh0KEwxMG4uZm9ybWF0KCdsb2ctdmlld2VyJywgJ3RvdGFsJywgW2RhdGEubWF4XSkpKTtcclxuXHJcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LmxvZy1kYXRhYCkpO1xyXG4gICAgICAgIHF1ZXJ5RWxzKGAke3Jvb3R9LnBhZ2luYXRpb24gbGlgKS5mb3JFYWNoKGxpID0+IGhpZGVFbChsaSwgbGkubnVtID4gZGF0YS5sb2dTaXplIC0gMSkpO1xyXG4gICAgICAgIFIuYXAoW2FkZEVsKGNvbnRhaW5lcildLCBkYXRhLnJlcXVlc3RlZExvZy5tYXAobWFrZVJvdykpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldERhdGEoZXZlbnQpIHtcclxuICAgICAgICBjb25zdCBmaWx0ZXIgPSBSLmZyb21QYWlycyhxdWVyeUVscyhgJHtyb290fWlucHV0W2ZpbHRlcl1gKS5tYXAoZWwgPT4gW2dldEF0dHIoZWwsICdmaWx0ZXInKSwgZWwudmFsdWVdKSk7XHJcbiAgICAgICAgREJNUy5nZXRMb2coTnVtYmVyKGV2ZW50LnRhcmdldC52YWx1ZSksIGZpbHRlciwgZGF0YVJlY2lldmVkKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlUm93KHJvd0RhdGEpIHtcclxuICAgICAgICBjb25zdCBhZGRUZXh0ID0gKHRleHQpID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGFkZEVsKG1ha2VFbCgndGQnKSwgYWRkRWwobWFrZUVsKCdzcGFuJyksIG1ha2VUZXh0KHRleHQpKSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICByZXR1cm4gYWRkRWxzKG1ha2VFbCgndHInKSwgW1xyXG4gICAgICAgICAgICBhZGRUZXh0KGAke3Jvd0RhdGFbMF19YCksXHJcbiAgICAgICAgICAgIGFkZFRleHQobmV3IERhdGUocm93RGF0YVsyXSkuZm9ybWF0KCd5eXl5L21tL2RkIEhIOk1NOnNzJykpLFxyXG4gICAgICAgICAgICBhZGRUZXh0KHJvd0RhdGFbMV0pLFxyXG4gICAgICAgICAgICBhZGRUZXh0KHJvd0RhdGFbM10pLFxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgYWRkRWxzKG1ha2VFbCgndGQnKSwgSlNPTi5wYXJzZShyb3dEYXRhWzRdKS5tYXAoaXRlbSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYWRkRWwoYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ2xvZy1wYXJhbScpLCBtYWtlVGV4dChSLmlzKE9iamVjdCwgaXRlbSkgPyBKU09OLnN0cmluZ2lmeShpdGVtKSA6IGl0ZW0pKTtcclxuICAgICAgICAgICAgfSkpLFxyXG4gICAgICAgICAgICBhZGRFbHMobWFrZUVsKCd0ZCcpLCBKU09OLnBhcnNlKHJvd0RhdGFbNV0pLm1hcChpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhZGRFbChhZGRDbGFzcyhtYWtlRWwoJ2RpdicpLCAnbG9nLXBhcmFtJyksIG1ha2VUZXh0KFIuaXMoT2JqZWN0LCBpdGVtKSA/IEpTT04uc3RyaW5naWZ5KGl0ZW0pIDogaXRlbSkpO1xyXG4gICAgICAgICAgICB9KSksXHJcbiAgICAgICAgXSk7XHJcbiAgICB9XHJcbn0pKHRoaXMuTG9nVmlld2VyID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBTdG9yeUNoYXJhY3RlcnNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGxpc3RlbihnZXRFbCgnbmV0d29ya1N1YnNldHNTZWxlY3RvcicpLCAnY2hhbmdlJywgb25OZXR3b3JrU3Vic2V0c0NoYW5nZSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9IChwYXJlbnQpID0+IHtcclxuICAgICAgICBzdGF0ZS5wYXJlbnQgPSBwYXJlbnQ7XHJcblxyXG4gICAgICAgIGxldCBzZWxlY3RvciA9IGZpbGxTZWxlY3RvcihjbGVhckVsKGdldEVsKCduZXR3b3JrU3Vic2V0c1NlbGVjdG9yJykpLCBjb25zdEFycjJTZWxlY3QoQ29uc3RhbnRzLm9iamVjdFN1YnNldHMpKTtcclxuICAgICAgICBbc2VsZWN0b3IudmFsdWVdID0gQ29uc3RhbnRzLm9iamVjdFN1YnNldHM7XHJcbiAgICAgICAgb25OZXR3b3JrU3Vic2V0c0NoYW5nZSh7IHRhcmdldDogc2VsZWN0b3IgfSk7XHJcblxyXG4gICAgICAgIHNlbGVjdG9yID0gZmlsbFNlbGVjdG9yKFxyXG4gICAgICAgICAgICBjbGVhckVsKGdldEVsKCduZXR3b3JrQ2hhcmFjdGVyU2VsZWN0b3InKSksXHJcbiAgICAgICAgICAgIHN0YXRlLnBhcmVudC5jaGFyYWN0ZXJOYW1lcy5zb3J0KFV0aWxzLmNoYXJPcmRBT2JqZWN0KS5tYXAocmVtYXBQcm9wczRTZWxlY3QpXHJcbiAgICAgICAgKTtcclxuICAgICAgICBzZXRBdHRyKHNlbGVjdG9yLCAnc2l6ZScsIHNlbGVjdG9yLm9wdGlvbnMubGVuZ3RoID4gMTUgPyAxNSA6IHNlbGVjdG9yLm9wdGlvbnMubGVuZ3RoKTtcclxuICAgICAgICBzZWxlY3RvciA9IGZpbGxTZWxlY3RvcihcclxuICAgICAgICAgICAgY2xlYXJFbChnZXRFbCgnbmV0d29ya1N0b3J5U2VsZWN0b3InKSksXHJcbiAgICAgICAgICAgIHN0YXRlLnBhcmVudC5zdG9yeU5hbWVzLnNvcnQoVXRpbHMuY2hhck9yZEFPYmplY3QpLm1hcChyZW1hcFByb3BzNFNlbGVjdClcclxuICAgICAgICApO1xyXG4gICAgICAgIHNldEF0dHIoc2VsZWN0b3IsICdzaXplJywgc2VsZWN0b3Iub3B0aW9ucy5sZW5ndGggPiAxNSA/IDE1IDogc2VsZWN0b3Iub3B0aW9ucy5sZW5ndGgpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLmdldFN0b3J5TmFtZXMgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gZ2V0RWwoJ25ldHdvcmtTdWJzZXRzU2VsZWN0b3InKTtcclxuXHJcbiAgICAgICAgaWYgKENvbnN0YW50cy5vYmplY3RTdWJzZXRzWzBdID09PSB2YWx1ZSkgeyAvLyBhbGwgb2JqZWN0c1xyXG4gICAgICAgICAgICByZXR1cm4gc3RhdGUucGFyZW50LnN0b3J5TmFtZXMubWFwKFIucHJvcCgndmFsdWUnKSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChDb25zdGFudHMub2JqZWN0U3Vic2V0c1sxXSA9PT0gdmFsdWUpIHsgLy8gXCJzZWxlY3RlZCBjaGFyYWN0ZXJzXCJcclxuICAgICAgICAgICAgY29uc3QgcHJpbWFyeUNoYXJhY3RlcnMgPSBubDJhcnJheShnZXRFbCgnbmV0d29ya0NoYXJhY3RlclNlbGVjdG9yJykuc2VsZWN0ZWRPcHRpb25zKS5tYXAoUi5wcm9wKCd2YWx1ZScpKTtcclxuICAgICAgICAgICAgY29uc3QgaXNQcmltYXJ5Q2hhcmFjdGVyID0gUi5jb250YWlucyhSLl9fLCBwcmltYXJ5Q2hhcmFjdGVycyk7XHJcbiAgICAgICAgICAgIHJldHVybiBSLnZhbHVlcyhzdGF0ZS5wYXJlbnQuU3RvcmllcylcclxuICAgICAgICAgICAgICAgIC5maWx0ZXIoc3RvcnkgPT4gUi5rZXlzKHN0b3J5LmNoYXJhY3RlcnMpLnNvbWUoaXNQcmltYXJ5Q2hhcmFjdGVyKSkubWFwKFIucHJvcCgnbmFtZScpKTtcclxuICAgICAgICB9IGVsc2UgaWYgKENvbnN0YW50cy5vYmplY3RTdWJzZXRzWzJdID09PSB2YWx1ZSkgeyAvL1wic2VsZWN0ZWQgc3Rvcmllc1wiXHJcbiAgICAgICAgICAgIHJldHVybiBubDJhcnJheShnZXRFbCgnbmV0d29ya1N0b3J5U2VsZWN0b3InKS5zZWxlY3RlZE9wdGlvbnMpLm1hcChSLnByb3AoJ3ZhbHVlJykpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgc3Vic2V0cyBzZWxlY3RvcjogJHt2YWx1ZX1gKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5nZXRDaGFyYWN0ZXJOYW1lcyA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSBnZXRFbCgnbmV0d29ya1N1YnNldHNTZWxlY3RvcicpO1xyXG5cclxuICAgICAgICBpZiAoQ29uc3RhbnRzLm9iamVjdFN1YnNldHNbMF0gPT09IHZhbHVlKSB7IC8vIGFsbCBvYmplY3RzXHJcbiAgICAgICAgICAgIHJldHVybiBzdGF0ZS5wYXJlbnQuY2hhcmFjdGVyTmFtZXMubWFwKFIucHJvcCgndmFsdWUnKSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChDb25zdGFudHMub2JqZWN0U3Vic2V0c1sxXSA9PT0gdmFsdWUpIHsgLy8gXCJzZWxlY3RlZCBjaGFyYWN0ZXJzXCJcclxuICAgICAgICAgICAgLy8gcmV0dXJucyBjaGFyYWN0ZXIgYW5kIGhpcyBuZWlnaGJvdXJzXHJcbiAgICAgICAgICAgIGNvbnN0IHByaW1hcnlDaGFyYWN0ZXJzID0gbmwyYXJyYXkoZ2V0RWwoJ25ldHdvcmtDaGFyYWN0ZXJTZWxlY3RvcicpLnNlbGVjdGVkT3B0aW9ucykubWFwKFIucHJvcCgndmFsdWUnKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzUHJpbWFyeUNoYXJhY3RlciA9IFIuY29udGFpbnMoUi5fXywgcHJpbWFyeUNoYXJhY3RlcnMpO1xyXG4gICAgICAgICAgICBjb25zdCBzZWNvbmRhcnlDaGFyYWN0ZXJzID0gUi52YWx1ZXMoc3RhdGUucGFyZW50LlN0b3JpZXMpXHJcbiAgICAgICAgICAgICAgICAuZmlsdGVyKHN0b3J5ID0+IFIua2V5cyhzdG9yeS5jaGFyYWN0ZXJzKS5zb21lKGlzUHJpbWFyeUNoYXJhY3RlcikpXHJcbiAgICAgICAgICAgICAgICAubWFwKHN0b3J5ID0+IHN0b3J5LmV2ZW50cy5maWx0ZXIoZXZlbnQgPT4gUi5rZXlzKGV2ZW50LmNoYXJhY3RlcnMpLnNvbWUoaXNQcmltYXJ5Q2hhcmFjdGVyKSlcclxuICAgICAgICAgICAgICAgICAgICAubWFwKGV2ZW50ID0+IFIua2V5cyhldmVudC5jaGFyYWN0ZXJzKS5maWx0ZXIobmFtZSA9PiAhaXNQcmltYXJ5Q2hhcmFjdGVyKG5hbWUpKSkpO1xyXG4gICAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoYXJhY3RlcnMuY29uY2F0KFIudW5pcShSLmZsYXR0ZW4oc2Vjb25kYXJ5Q2hhcmFjdGVycykpKTtcclxuICAgICAgICB9IGVsc2UgaWYgKENvbnN0YW50cy5vYmplY3RTdWJzZXRzWzJdID09PSB2YWx1ZSkgeyAvL1wic2VsZWN0ZWQgc3Rvcmllc1wiXHJcbiAgICAgICAgICAgIGNvbnN0IHN0b3JpZXMgPSBubDJhcnJheShnZXRFbCgnbmV0d29ya1N0b3J5U2VsZWN0b3InKS5zZWxlY3RlZE9wdGlvbnMpLm1hcChSLnByb3AoJ3ZhbHVlJykpO1xyXG4gICAgICAgICAgICByZXR1cm4gUi51bmlxKFIuZmxhdHRlbihzdG9yaWVzLm1hcChzdG9yeU5hbWUgPT4gUi5rZXlzKHN0YXRlLnBhcmVudC5TdG9yaWVzW3N0b3J5TmFtZV0uY2hhcmFjdGVycykpKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBzdWJzZXRzIHNlbGVjdG9yOiAke3ZhbHVlfWApO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBvbk5ldHdvcmtTdWJzZXRzQ2hhbmdlKGV2ZW50KSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRTdWJzZXQgPSBldmVudC50YXJnZXQudmFsdWU7XHJcbiAgICAgICAgaGlkZUVsKGdldEVsKCduZXR3b3JrQ2hhcmFjdGVyRGl2JyksICBzZWxlY3RlZFN1YnNldCAhPT0gQ29uc3RhbnRzLm9iamVjdFN1YnNldHNbMV0pO1xyXG4gICAgICAgIGhpZGVFbChnZXRFbCgnbmV0d29ya1N0b3J5RGl2JyksIHNlbGVjdGVkU3Vic2V0ICE9PSBDb25zdGFudHMub2JqZWN0U3Vic2V0c1syXSk7XHJcbiAgICB9XHJcbn0pKHRoaXMuTmV0d29ya1N1YnNldHNTZWxlY3RvciA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNUywgU3RvcnlDaGFyYWN0ZXJzXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG5cclxuICAgIGNvbnN0IFNUT1JZX1BSRUZJWCA9ICdTdDonO1xyXG4gICAgY29uc3QgQ0hBUl9QUkVGSVggPSAnQ2g6JztcclxuICAgIGNvbnN0IFBST0ZJTEVfR1JPVVAgPSAncHJvZi0nO1xyXG4gICAgY29uc3QgRklMVEVSX0dST1VQID0gJ2ZpbHRlci0nO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBOZXR3b3JrU3Vic2V0c1NlbGVjdG9yLmluaXQoKTtcclxuXHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCduZXR3b3JrTm9kZUdyb3VwU2VsZWN0b3InKSwgJ2NoYW5nZScsIGNvbG9yTm9kZXMpO1xyXG4gICAgICAgIGxpc3RlbihnZXRFbCgnc2hvd1BsYXllck5hbWVzQ2hlY2tib3gnKSwgJ2NoYW5nZScsIHVwZGF0ZU5vZGVMYWJlbHMpO1xyXG4gICAgICAgIGxpc3RlbihnZXRFbCgnZHJhd05ldHdvcmtCdXR0b24nKSwgJ2NsaWNrJywgb25EcmF3TmV0d29yayk7XHJcbiAgICAgICAgJCgnI25vZGVGb2N1c1NlbGVjdG9yJykuc2VsZWN0MigpLm9uKCdjaGFuZ2UnLCBvbk5vZGVGb2N1cyk7XHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCduZXR3b3JrU2VsZWN0b3InKSwgJ2NoYW5nZScsIG9uTmV0d29ya1NlbGVjdG9yQ2hhbmdlRGVsZWdhdGUpO1xyXG5cclxuICAgICAgICBxdWVyeUVscygnI2FjdGl2aXR5QmxvY2sgYnV0dG9uJykuZm9yRWFjaChsaXN0ZW4oUi5fXywgJ2NsaWNrJywgZXZlbnQgPT4gdG9nZ2xlQ2xhc3MoZXZlbnQudGFyZ2V0LCAnYnRuLXByaW1hcnknKSkpO1xyXG4gICAgICAgIHF1ZXJ5RWxzKCcjcmVsYXRpb25zQmxvY2sgYnV0dG9uJykuZm9yRWFjaChsaXN0ZW4oUi5fXywgJ2NsaWNrJywgZXZlbnQgPT4gdG9nZ2xlQ2xhc3MoZXZlbnQudGFyZ2V0LCAnYnRuLXByaW1hcnknKSkpO1xyXG5cclxuICAgICAgICAvLyAgICAgICAgc3RhdGUubmV0d29yaztcclxuICAgICAgICBzdGF0ZS5oaWdobGlnaHRBY3RpdmUgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgaW5pdFdhcm5pbmcoKTtcclxuICAgICAgICBMMTBuLm9uTDEwbkNoYW5nZShpbml0V2FybmluZyk7XHJcblxyXG4gICAgICAgIC8vICAgIFRpbWVsaW5lZE5ldHdvcmsuaW5pdCgpO1xyXG5cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBnZXRFbCgnc29jaWFsTmV0d29ya0RpdicpO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBpbml0V2FybmluZygpIHtcclxuICAgICAgICBjb25zdCB3YXJuaW5nID0gY2xlYXJFbChnZXRFbCgnc29jaWFsTmV0d29ya1dhcm5pbmcnKSk7XHJcbiAgICAgICAgY29uc3QgYnV0dG9uID0gYWRkRWwobWFrZUVsKCdidXR0b24nKSwgbWFrZVRleHQoZ2V0TDEwbignc29jaWFsLW5ldHdvcmstcmVtb3ZlLXJlc291cmNlcy13YXJuaW5nJykpKTtcclxuICAgICAgICBhZGRFbHMod2FybmluZywgW21ha2VUZXh0KGdldEwxMG4oJ3NvY2lhbC1uZXR3b3JrLXJlcXVpcmUtcmVzb3VyY2VzLXdhcm5pbmcnKSksIGJ1dHRvbl0pO1xyXG4gICAgICAgIGxpc3RlbihidXR0b24sICdjbGljaycsICgpID0+IGFkZENsYXNzKHdhcm5pbmcsICdoaWRkZW4nKSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgbm9kZVNvcnQgPSBDb21tb25VdGlscy5jaGFyT3JkQUZhY3RvcnkoYSA9PiBhLmxhYmVsLnRvTG93ZXJDYXNlKCkpO1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBsZXQgc2VsZWN0b3IgPSBmaWxsU2VsZWN0b3IoY2xlYXJFbChnZXRFbCgnbmV0d29ya1NlbGVjdG9yJykpLCBjb25zdEFycjJTZWxlY3QoQ29uc3RhbnRzLm5ldHdvcmtzKSk7XHJcbiAgICAgICAgW3NlbGVjdG9yLnZhbHVlXSA9IENvbnN0YW50cy5uZXR3b3JrcztcclxuICAgICAgICBvbk5ldHdvcmtTZWxlY3RvckNoYW5nZURlbGVnYXRlKHsgdGFyZ2V0OiBzZWxlY3RvciB9KTtcclxuXHJcbiAgICAgICAgc2VsZWN0b3IgPSBjbGVhckVsKGdldEVsKCduZXR3b3JrTm9kZUdyb3VwU2VsZWN0b3InKSk7XHJcblxyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdjaGFyYWN0ZXInLCBmYWxzZSwgKGVycjEsIGNoYXJhY3Rlck5hbWVzKSA9PiB7IC8vIHN1YnNldCBzZWxlY3RvclxyXG4gICAgICAgICAgICBpZiAoZXJyMSkgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIxKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdzdG9yeScsIGZhbHNlLCAoZXJyMiwgc3RvcnlOYW1lcykgPT4geyAvLyBzdWJzZXQgc2VsZWN0b3JcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0QWxsUHJvZmlsZXMoJ2NoYXJhY3RlcicsIChlcnIzLCBwcm9maWxlcykgPT4geyAvLyBub2RlIGNvbG9yaW5nXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycjMpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMyk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIERCTVMuZ2V0QWxsU3RvcmllcygoZXJyNCwgc3RvcmllcykgPT4geyAvLyBjb250YWlucyBtb3N0IHBhcnQgb2YgU04gZGF0YVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyNCkgeyBVdGlscy5oYW5kbGVFcnJvcihlcnI0KTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIERCTVMuZ2V0UHJvZmlsZVN0cnVjdHVyZSgnY2hhcmFjdGVyJywgKGVycjUsIHByb2ZpbGVTdHJ1Y3R1cmUpID0+IHsgLy8gbm9kZSBjb2xvcmluZ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjUpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyNSk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgREJNUy5nZXRQcm9maWxlQmluZGluZ3MoKGVycjYsIHByb2ZpbGVCaW5kaW5ncykgPT4geyAvLyBub2RlIGNvbG9yaW5nXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjYpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyNik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIERCTVMuZ2V0R3JvdXBDaGFyYWN0ZXJTZXRzKChlcnI3LCBncm91cENoYXJhY3RlclNldHMpID0+IHsgLy8gbm9kZSBjb2xvcmluZ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyNykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnI3KTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIERCTVMuZ2V0TWV0YUluZm8oKGVycjgsIG1ldGFJbmZvKSA9PiB7IC8vIHRpbWVsaW5lZCBuZXR3b3JrXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyOCkgeyBVdGlscy5oYW5kbGVFcnJvcihlcnI4KTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBEQk1TLmdldFJlbGF0aW9ucygoZXJyOSwgcmVsYXRpb25zKSA9PiB7IC8vIHJlbGF0aW9uc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnI5KSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjkpOyByZXR1cm47IH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuU3RvcmllcyA9IHN0b3JpZXM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuQ2hhcmFjdGVycyA9IHByb2ZpbGVzO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnByb2ZpbGVCaW5kaW5ncyA9IHByb2ZpbGVCaW5kaW5ncztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5ncm91cENoYXJhY3RlclNldHMgPSBncm91cENoYXJhY3RlclNldHM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUubWV0YUluZm8gPSBtZXRhSW5mbztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5yZWxhdGlvbnMgPSByZWxhdGlvbnM7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoZWNrYm94ZXMgPSBwcm9maWxlU3RydWN0dXJlLmZpbHRlcihlbGVtZW50ID0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFIuZXF1YWxzKGVsZW1lbnQudHlwZSwgJ2NoZWNrYm94JykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFIudmFsdWVzKHByb2ZpbGVzKS5mb3JFYWNoKChwcm9maWxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrYm94ZXMubWFwKGl0ZW0gPT4gKHByb2ZpbGVbaXRlbS5uYW1lXSA9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdEwxMG4oQ29uc3RhbnRzW3Byb2ZpbGVbaXRlbS5uYW1lXV0pKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbG9yR3JvdXBzID0gcHJvZmlsZVN0cnVjdHVyZS5maWx0ZXIoZWxlbWVudCA9PlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBSLmNvbnRhaW5zKGVsZW1lbnQudHlwZSwgWydlbnVtJywgJ2NoZWNrYm94J10pKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWZhdWx0Q29sb3JHcm91cCA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IENvbnN0YW50cy5ub0dyb3VwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBjb25zdEwxMG4oQ29uc3RhbnRzLm5vR3JvdXApXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvZmlsZUxhYmVsID0gc3RyRm9ybWF0KGdldEwxMG4oJ3NvY2lhbC1uZXR3b3JrLXByb2ZpbGUtZ3JvdXAnKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyTGFiZWwgPSBzdHJGb3JtYXQoZ2V0TDEwbignc29jaWFsLW5ldHdvcmstZmlsdGVyLWdyb3VwJykpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9maWxlR3JvdXBzID0gY29sb3JHcm91cHMubWFwKGdyb3VwID0+IGdyb3VwLm5hbWUpLm1hcChuYW1lID0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh7IHZhbHVlOiBQUk9GSUxFX0dST1VQICsgbmFtZSwgbmFtZTogcHJvZmlsZUxhYmVsKFtuYW1lXSkgfSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbHRlckdyb3VwcyA9IFIua2V5cyhncm91cENoYXJhY3RlclNldHMpLm1hcChuYW1lID0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh7IHZhbHVlOiBGSUxURVJfR1JPVVAgKyBuYW1lLCBuYW1lOiBmaWx0ZXJMYWJlbChbbmFtZV0pIH0pKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxsU2VsZWN0b3IoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdG9yLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbZGVmYXVsdENvbG9yR3JvdXBdLmNvbmNhdChwcm9maWxlR3JvdXBzKS5jb25jYXQoZmlsdGVyR3JvdXBzKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluaXRHcm91cENvbG9ycyhjb2xvckdyb3Vwcyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE5ldHdvcmtTdWJzZXRzU2VsZWN0b3IucmVmcmVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYXJhY3Rlck5hbWVzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9yeU5hbWVzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTdG9yaWVzOiBzdG9yaWVzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25EcmF3TmV0d29yaygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBpbml0R3JvdXBDb2xvcnMoY29sb3JHcm91cHMpIHtcclxuICAgICAgICBzdGF0ZS5ncm91cENvbG9ycyA9IFIuY2xvbmUoQ29uc3RhbnRzLnNuRml4ZWRDb2xvcnMpO1xyXG4gICAgICAgIHN0YXRlLmdyb3VwTGlzdHMgPSB7fTtcclxuXHJcbiAgICAgICAgY29sb3JHcm91cHMuZm9yRWFjaCgoZ3JvdXApID0+IHtcclxuICAgICAgICAgICAgaWYgKGdyb3VwLnR5cGUgPT09ICdlbnVtJykge1xyXG4gICAgICAgICAgICAgICAgc3RhdGUuZ3JvdXBMaXN0c1tQUk9GSUxFX0dST1VQICsgZ3JvdXAubmFtZV0gPSBncm91cC52YWx1ZS5zcGxpdCgnLCcpLm1hcCgoc3ViR3JvdXBOYW1lLCBpKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUuZ3JvdXBDb2xvcnNbYCR7UFJPRklMRV9HUk9VUCArIGdyb3VwLm5hbWV9LiR7c3ViR3JvdXBOYW1lLnRyaW0oKX1gXSA9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIENvbnN0YW50cy5jb2xvclBhbGV0dGVbaSsyXTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYCR7UFJPRklMRV9HUk9VUCArIGdyb3VwLm5hbWV9LiR7c3ViR3JvdXBOYW1lLnRyaW0oKX1gO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZ3JvdXAudHlwZSA9PT0gJ2NoZWNrYm94Jykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdHJ1ZU5hbWUgPSBjb25zdEwxMG4oQ29uc3RhbnRzLnRydWUpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZmFsc2VOYW1lID0gY29uc3RMMTBuKENvbnN0YW50cy5mYWxzZSk7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5ncm91cENvbG9yc1tgJHtQUk9GSUxFX0dST1VQICsgZ3JvdXAubmFtZX0uJHt0cnVlTmFtZX1gXSA9XHJcbiAgICAgICAgICAgICAgICAgICAgQ29uc3RhbnRzLmNvbG9yUGFsZXR0ZVtncm91cC52YWx1ZSA/IDArMiA6IDErMl07XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5ncm91cENvbG9yc1tgJHtQUk9GSUxFX0dST1VQICsgZ3JvdXAubmFtZX0uJHtmYWxzZU5hbWV9YF0gPVxyXG4gICAgICAgICAgICAgICAgICAgIENvbnN0YW50cy5jb2xvclBhbGV0dGVbZ3JvdXAudmFsdWUgPyAxKzIgOiAwKzJdO1xyXG4gICAgICAgICAgICAgICAgc3RhdGUuZ3JvdXBMaXN0c1tQUk9GSUxFX0dST1VQICsgZ3JvdXAubmFtZV0gPVxyXG4gICAgICAgICAgICAgICAgICAgIFtgJHtQUk9GSUxFX0dST1VQICsgZ3JvdXAubmFtZX0uJHt0cnVlTmFtZX1gLCBgJHtQUk9GSUxFX0dST1VQICsgZ3JvdXAubmFtZX0uJHtmYWxzZU5hbWV9YF07XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgcHJvZmlsZSBpdGVtIHR5cGU6ICR7Z3JvdXAudHlwZX1gKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VMZWdlbmRJdGVtKGxhYmVsLCBjb2xvcikge1xyXG4gICAgICAgIGNvbnN0IGNvbG9yRGl2ID0gYWRkRWwobWFrZUVsKCdkaXYnKSwgbWFrZVRleHQobGFiZWwpKTtcclxuICAgICAgICBjb2xvckRpdi5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBjb2xvci5iYWNrZ3JvdW5kO1xyXG4gICAgICAgIGNvbG9yRGl2LnN0eWxlLmJvcmRlciA9IGBzb2xpZCAycHggJHtjb2xvci5ib3JkZXJ9YDtcclxuICAgICAgICByZXR1cm4gY29sb3JEaXY7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVmcmVzaExlZ2VuZChncm91cE5hbWUpIHtcclxuICAgICAgICBjb25zdCBjb2xvckxlZ2VuZCA9IGNsZWFyRWwoZ2V0RWwoJ2NvbG9yTGVnZW5kJykpO1xyXG4gICAgICAgIGxldCBlbHMgPSBbXTtcclxuXHJcbiAgICAgICAgaWYgKGdyb3VwTmFtZSA9PT0gJ25vR3JvdXAnKSB7XHJcbiAgICAgICAgICAgIGVscy5wdXNoKG1ha2VMZWdlbmRJdGVtKGNvbnN0TDEwbignbm9Hcm91cCcpLCBDb25zdGFudHMuc25GaXhlZENvbG9ycy5ub0dyb3VwLmNvbG9yKSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChDb21tb25VdGlscy5zdGFydHNXaXRoKGdyb3VwTmFtZSwgUFJPRklMRV9HUk9VUCkpIHtcclxuICAgICAgICAgICAgZWxzID0gZWxzLmNvbmNhdChzdGF0ZS5ncm91cExpc3RzW2dyb3VwTmFtZV0ubWFwKHZhbHVlID0+XHJcbiAgICAgICAgICAgICAgICBtYWtlTGVnZW5kSXRlbSh2YWx1ZS5zdWJzdHJpbmcoUFJPRklMRV9HUk9VUC5sZW5ndGgpLCBzdGF0ZS5ncm91cENvbG9yc1t2YWx1ZV0uY29sb3IpKSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChDb21tb25VdGlscy5zdGFydHNXaXRoKGdyb3VwTmFtZSwgRklMVEVSX0dST1VQKSkge1xyXG4gICAgICAgICAgICBlbHMucHVzaChtYWtlTGVnZW5kSXRlbShjb25zdEwxMG4oJ25vR3JvdXAnKSwgQ29uc3RhbnRzLnNuRml4ZWRDb2xvcnMubm9Hcm91cC5jb2xvcikpO1xyXG4gICAgICAgICAgICBlbHMucHVzaChtYWtlTGVnZW5kSXRlbShjb25zdEwxMG4oJ2Zyb21Hcm91cCcpLCBDb25zdGFudHMuc25GaXhlZENvbG9ycy5mcm9tR3JvdXAuY29sb3IpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgZ3JvdXAgbmFtZS90eXBlOiAke2dyb3VwTmFtZX1gKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChbJ2NoYXJhY3RlclByZXNlbmNlSW5TdG9yeScsICdjaGFyYWN0ZXJBY3Rpdml0eUluU3RvcnknXS5pbmRleE9mKHN0YXRlLnNlbGVjdGVkTmV0d29yaykgIT09IC0xKSB7XHJcbiAgICAgICAgICAgIGVscy5wdXNoKG1ha2VMZWdlbmRJdGVtKGdldEwxMG4oJ3NvY2lhbC1uZXR3b3JrLXN0b3J5JyksIENvbnN0YW50cy5zbkZpeGVkQ29sb3JzLnN0b3J5Q29sb3IuY29sb3IpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYWRkRWxzKGNvbG9yTGVnZW5kLCBlbHMpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNvbG9yTm9kZXMoZXZlbnQpIHtcclxuICAgICAgICBjb25zdCBncm91cE5hbWUgPSBldmVudC50YXJnZXQudmFsdWU7XHJcbiAgICAgICAgcmVmcmVzaExlZ2VuZChncm91cE5hbWUpO1xyXG4gICAgICAgIGlmIChzdGF0ZS5ub2Rlc0RhdGFzZXQgPT09IHVuZGVmaW5lZCkgcmV0dXJuO1xyXG5cclxuICAgICAgICBOZXR3b3JrU3Vic2V0c1NlbGVjdG9yLmdldENoYXJhY3Rlck5hbWVzKCkuZm9yRWFjaCgoY2hhcmFjdGVyTmFtZSkgPT4ge1xyXG4gICAgICAgICAgICBzdGF0ZS5ub2Rlc0RhdGFzZXQudXBkYXRlKHtcclxuICAgICAgICAgICAgICAgIGlkOiBDSEFSX1BSRUZJWCArIGNoYXJhY3Rlck5hbWUsXHJcbiAgICAgICAgICAgICAgICBncm91cDogZ2V0Tm9kZUdyb3VwKGNoYXJhY3Rlck5hbWUsIGdyb3VwTmFtZSlcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0Tm9kZUdyb3VwKGNoYXJhY3Rlck5hbWUsIGdyb3VwTmFtZSkge1xyXG4gICAgICAgIGlmIChncm91cE5hbWUgPT09ICdub0dyb3VwJykge1xyXG4gICAgICAgICAgICByZXR1cm4gZ3JvdXBOYW1lO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoQ29tbW9uVXRpbHMuc3RhcnRzV2l0aChncm91cE5hbWUsIFBST0ZJTEVfR1JPVVApKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNoYXJhY3RlciA9IHN0YXRlLkNoYXJhY3RlcnNbY2hhcmFjdGVyTmFtZV07XHJcbiAgICAgICAgICAgIHJldHVybiBgJHtncm91cE5hbWV9LiR7Y2hhcmFjdGVyW2dyb3VwTmFtZS5zdWJzdHJpbmcoUFJPRklMRV9HUk9VUC5sZW5ndGgpXX1gO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoQ29tbW9uVXRpbHMuc3RhcnRzV2l0aChncm91cE5hbWUsIEZJTFRFUl9HUk9VUCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHN0YXRlLmdyb3VwQ2hhcmFjdGVyU2V0c1tncm91cE5hbWUuc3Vic3RyaW5nKEZJTFRFUl9HUk9VUC5sZW5ndGgpXVtjaGFyYWN0ZXJOYW1lXSA/ICdmcm9tR3JvdXAnIDogJ25vR3JvdXAnO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgZ3JvdXAgbmFtZTogJHtncm91cE5hbWV9YCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlTm9kZUxhYmVscygpIHtcclxuICAgICAgICBpZiAoc3RhdGUubm9kZXNEYXRhc2V0ID09PSB1bmRlZmluZWQpIHJldHVybjtcclxuICAgICAgICBjb25zdCBzaG93UGxheWVyID0gZ2V0RWwoJ3Nob3dQbGF5ZXJOYW1lc0NoZWNrYm94JykuY2hlY2tlZDtcclxuICAgICAgICBjb25zdCBhbGxOb2RlcyA9IHN0YXRlLm5vZGVzRGF0YXNldC5nZXQoe1xyXG4gICAgICAgICAgICByZXR1cm5UeXBlOiAnT2JqZWN0J1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBSLnZhbHVlcyhhbGxOb2RlcykuZmlsdGVyKG5vZGUgPT4gbm9kZS50eXBlID09PSAnY2hhcmFjdGVyJykuZm9yRWFjaCgobm9kZSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBsYWJlbCA9IG1ha2VDaGFyYWN0ZXJOb2RlTGFiZWwoc2hvd1BsYXllciwgbm9kZS5vcmlnaW5OYW1lKTtcclxuICAgICAgICAgICAgaWYgKG5vZGUubGFiZWwgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgbm9kZS5sYWJlbCA9IGxhYmVsO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuaGlkZGVuTGFiZWwgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgbm9kZS5oaWRkZW5MYWJlbCA9IGxhYmVsO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFN1c3BpY2lvdXMgbm9kZTogJHtKU09OLnN0cmluZ2lmeShub2RlKX1gKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBzdGF0ZS5ub2Rlc0RhdGFzZXQudXBkYXRlKFIudmFsdWVzKGFsbE5vZGVzKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25OZXR3b3JrU2VsZWN0b3JDaGFuZ2VEZWxlZ2F0ZShldmVudCkge1xyXG4gICAgICAgIGhpZGVFbChnZXRFbCgnYWN0aXZpdHlCbG9jaycpLCBldmVudC50YXJnZXQudmFsdWUgIT09ICdjaGFyYWN0ZXJBY3Rpdml0eUluU3RvcnknKTtcclxuICAgICAgICBxdWVyeUVscygnI2FjdGl2aXR5QmxvY2sgYnV0dG9uJykuZm9yRWFjaChlbCA9PiBhZGRDbGFzcyhlbCwgJ2J0bi1wcmltYXJ5JykpO1xyXG4gICAgICAgIGhpZGVFbChnZXRFbCgncmVsYXRpb25zQmxvY2snKSwgZXZlbnQudGFyZ2V0LnZhbHVlICE9PSAnY2hhcmFjdGVyUmVsYXRpb25zJyk7XHJcbiAgICAgICAgcXVlcnlFbHMoJyNyZWxhdGlvbnNCbG9jayBidXR0b24nKS5mb3JFYWNoKGVsID0+IGFkZENsYXNzKGVsLCAnYnRuLXByaW1hcnknKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25Ob2RlRm9jdXMoZXZlbnQpIHtcclxuICAgICAgICBzdGF0ZS5uZXR3b3JrLmZvY3VzKGV2ZW50LnRhcmdldC52YWx1ZSwgQ29uc3RhbnRzLnNuRm9jdXNPcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBvbkRyYXdOZXR3b3JrKCkge1xyXG4gICAgICAgIG9uTmV0d29ya1NlbGVjdG9yQ2hhbmdlKGdldEVsKCduZXR3b3JrU2VsZWN0b3InKS52YWx1ZSk7XHJcbiAgICAvLyAgICBUaW1lbGluZWROZXR3b3JrLnJlZnJlc2goc3RhdGUubmV0d29yaywgc3RhdGUubm9kZXNEYXRhc2V0LFxyXG4gICAgLy8gICAgICAgICAgICBzdGF0ZS5lZGdlc0RhdGFzZXQsIGdldEV2ZW50RGV0YWlscygpLCBzdGF0ZS5tZXRhSW5mbyk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25OZXR3b3JrU2VsZWN0b3JDaGFuZ2Uoc2VsZWN0ZWROZXR3b3JrKSB7XHJcbiAgICAgICAgc3RhdGUuc2VsZWN0ZWROZXR3b3JrID0gc2VsZWN0ZWROZXR3b3JrO1xyXG4gICAgICAgIGxldCBub2RlcyA9IFtdO1xyXG4gICAgICAgIGxldCBlZGdlcyA9IFtdO1xyXG5cclxuICAgICAgICBzd2l0Y2ggKHNlbGVjdGVkTmV0d29yaykge1xyXG4gICAgICAgIGNhc2UgJ3NvY2lhbFJlbGF0aW9ucyc6XHJcbiAgICAgICAgICAgIG5vZGVzID0gZ2V0Q2hhcmFjdGVyTm9kZXMoKTtcclxuICAgICAgICAgICAgZWRnZXMgPSBnZXREZXRhaWxlZEVkZ2VzKCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ2NoYXJhY3RlclByZXNlbmNlSW5TdG9yeSc6XHJcbiAgICAgICAgICAgIG5vZGVzID0gZ2V0Q2hhcmFjdGVyTm9kZXMoKS5jb25jYXQoZ2V0U3RvcnlOb2RlcygpKTtcclxuICAgICAgICAgICAgZWRnZXMgPSBnZXRTdG9yeUVkZ2VzKCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ2NoYXJhY3RlckFjdGl2aXR5SW5TdG9yeSc6XHJcbiAgICAgICAgICAgIG5vZGVzID0gZ2V0Q2hhcmFjdGVyTm9kZXMoKS5jb25jYXQoZ2V0U3RvcnlOb2RlcygpKTtcclxuICAgICAgICAgICAgZWRnZXMgPSBnZXRBY3Rpdml0eUVkZ2VzKCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ2NoYXJhY3RlclJlbGF0aW9ucyc6XHJcbiAgICAgICAgICAgIG5vZGVzID0gZ2V0Q2hhcmFjdGVyTm9kZXMoKTtcclxuICAgICAgICAgICAgZWRnZXMgPSBnZXRSZWxhdGlvbkVkZ2VzKCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBuZXR3b3JrIHR5cGU6ICR7c2VsZWN0ZWROZXR3b3JrfWApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmVmcmVzaExlZ2VuZChnZXRFbCgnbmV0d29ya05vZGVHcm91cFNlbGVjdG9yJykudmFsdWUpO1xyXG5cclxuICAgICAgICBjbGVhckVsKGdldEVsKCdub2RlRm9jdXNTZWxlY3RvcicpKTtcclxuICAgICAgICBub2Rlcy5zb3J0KG5vZGVTb3J0KTtcclxuXHJcbiAgICAgICAgY29uc3QgZGF0YSA9IGdldFNlbGVjdDJEYXRhQ29tbW9uKHJlbWFwUHJvcHMoWydpZCcsICd0ZXh0J10sIFsnaWQnLCAnb3JpZ2luTmFtZSddKSwgbm9kZXMpO1xyXG4gICAgICAgICQoJyNub2RlRm9jdXNTZWxlY3RvcicpLnNlbGVjdDIoZGF0YSk7XHJcblxyXG4gICAgICAgIHN0YXRlLm5vZGVzRGF0YXNldCA9IG5ldyB2aXMuRGF0YVNldChub2Rlcyk7XHJcbiAgICAgICAgc3RhdGUuZWRnZXNEYXRhc2V0ID0gbmV3IHZpcy5EYXRhU2V0KGVkZ2VzKTtcclxuXHJcbiAgICAgICAgcmVkcmF3QWxsKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUNoYXJhY3Rlck5vZGVMYWJlbChzaG93UGxheWVyLCBjaGFyYWN0ZXJOYW1lKSB7XHJcbiAgICAgICAgY29uc3QgbGFiZWwgPSBjaGFyYWN0ZXJOYW1lLnNwbGl0KCcgJykuam9pbignXFxuJyk7XHJcbiAgICAgICAgaWYgKHNob3dQbGF5ZXIpIHtcclxuICAgICAgICAgICAgY29uc3QgcGxheWVyID0gc3RhdGUucHJvZmlsZUJpbmRpbmdzW2NoYXJhY3Rlck5hbWVdIHx8ICcnO1xyXG4gICAgICAgICAgICByZXR1cm4gYCR7bGFiZWx9L1xcbiR7cGxheWVyfWA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBsYWJlbDtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRDaGFyYWN0ZXJOb2RlcygpIHtcclxuICAgICAgICBjb25zdCBncm91cE5hbWUgPSBnZXRFbCgnbmV0d29ya05vZGVHcm91cFNlbGVjdG9yJykudmFsdWU7XHJcbiAgICAgICAgY29uc3Qgc2hvd1BsYXllciA9IGdldEVsKCdzaG93UGxheWVyTmFtZXNDaGVja2JveCcpLmNoZWNrZWQ7XHJcbiAgICAgICAgcmV0dXJuIE5ldHdvcmtTdWJzZXRzU2VsZWN0b3IuZ2V0Q2hhcmFjdGVyTmFtZXMoKS5tYXAoKGNoYXJhY3Rlck5hbWUpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgcHJvZmlsZSA9IHN0YXRlLkNoYXJhY3RlcnNbY2hhcmFjdGVyTmFtZV07XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBpZDogQ0hBUl9QUkVGSVggKyBjaGFyYWN0ZXJOYW1lLFxyXG4gICAgICAgICAgICAgICAgbGFiZWw6IG1ha2VDaGFyYWN0ZXJOb2RlTGFiZWwoc2hvd1BsYXllciwgY2hhcmFjdGVyTmFtZSksXHJcbiAgICAgICAgICAgICAgICB0eXBlOiAnY2hhcmFjdGVyJyxcclxuICAgICAgICAgICAgICAgIG9yaWdpbk5hbWU6IGNoYXJhY3Rlck5hbWUsXHJcbiAgICAgICAgICAgICAgICBncm91cDogZ3JvdXBOYW1lID09PSAnbm9Hcm91cCcgPyBjb25zdEwxMG4oJ25vR3JvdXAnKSA6IGAke2dyb3VwTmFtZX0uJHtwcm9maWxlW2dyb3VwTmFtZV19YFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldFN0b3J5Tm9kZXMoKSB7XHJcbiAgICAgICAgY29uc3Qgbm9kZXMgPSBOZXR3b3JrU3Vic2V0c1NlbGVjdG9yLmdldFN0b3J5TmFtZXMoKS5tYXAobmFtZSA9PiAoe1xyXG4gICAgICAgICAgICBpZDogU1RPUllfUFJFRklYICsgbmFtZSxcclxuICAgICAgICAgICAgbGFiZWw6IG5hbWUuc3BsaXQoJyAnKS5qb2luKCdcXG4nKSxcclxuICAgICAgICAgICAgdmFsdWU6IE9iamVjdC5rZXlzKHN0YXRlLlN0b3JpZXNbbmFtZV0uY2hhcmFjdGVycykubGVuZ3RoLFxyXG4gICAgICAgICAgICB0aXRsZTogT2JqZWN0LmtleXMoc3RhdGUuU3Rvcmllc1tuYW1lXS5jaGFyYWN0ZXJzKS5sZW5ndGgsXHJcbiAgICAgICAgICAgIGdyb3VwOiAnc3RvcnlDb2xvcicsXHJcbiAgICAgICAgICAgIHR5cGU6ICdzdG9yeScsXHJcbiAgICAgICAgICAgIG9yaWdpbk5hbWU6IG5hbWUsXHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHJldHVybiBub2RlcztcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRBY3Rpdml0eUVkZ2VzKCkge1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdGVkQWN0aXZpdGllcyA9IHF1ZXJ5RWxzKCcjYWN0aXZpdHlCbG9jayBidXR0b24uYnRuLXByaW1hcnknKS5tYXAoZ2V0QXR0cihSLl9fLCAnZGF0YS12YWx1ZScpKTtcclxuICAgICAgICBjb25zdCBzdG9yaWVzID0gc3RhdGUuU3RvcmllcztcclxuICAgICAgICByZXR1cm4gUi5mbGF0dGVuKFIua2V5cyhzdG9yaWVzKS5tYXAobmFtZSA9PiBSLmtleXMoc3Rvcmllc1tuYW1lXS5jaGFyYWN0ZXJzKVxyXG4gICAgICAgICAgICAubWFwKGNoYXIxID0+IFIua2V5cyhzdG9yaWVzW25hbWVdLmNoYXJhY3RlcnNbY2hhcjFdLmFjdGl2aXR5KS5maWx0ZXIoUi5jb250YWlucyhSLl9fLCBzZWxlY3RlZEFjdGl2aXRpZXMpKVxyXG4gICAgICAgICAgICAgICAgLm1hcChhY3Rpdml0eSA9PiAoe1xyXG4gICAgICAgICAgICAgICAgICAgIGZyb206IFNUT1JZX1BSRUZJWCArIG5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgdG86IENIQVJfUFJFRklYICsgY2hhcjEsXHJcbiAgICAgICAgICAgICAgICAgICAgY29sb3I6IENvbnN0YW50cy5zbkFjdGl2aXR5Q29sb3JzW2FjdGl2aXR5XSxcclxuICAgICAgICAgICAgICAgICAgICB3aWR0aDogMixcclxuICAgICAgICAgICAgICAgICAgICBob3ZlcldpZHRoOiA0XHJcbiAgICAgICAgICAgICAgICB9KSkpKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0UmVsYXRpb25FZGdlcygpIHtcclxuICAgICAgICBjb25zdCBzZWxlY3RlZFJlbGF0aW9ucyA9IHF1ZXJ5RWxzKCcjcmVsYXRpb25zQmxvY2sgYnV0dG9uLmJ0bi1wcmltYXJ5JykubWFwKGdldEF0dHIoUi5fXywgJ2RhdGEtdmFsdWUnKSk7XHJcbiAgICAgICAgY29uc3QgeyByZWxhdGlvbnMgfSA9IHN0YXRlO1xyXG4gICAgICAgIGNvbnN0IGNoZWNrZWQgPSBSLmNvbnRhaW5zKFIuX18sIHNlbGVjdGVkUmVsYXRpb25zKTtcclxuICAgICAgICByZXR1cm4gUi5mbGF0dGVuKHJlbGF0aW9ucy5tYXAoKHJlbCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBhcnIgPSBbXTtcclxuICAgICAgICAgICAgY29uc3QgeyBzdGFydGVyIH0gPSByZWw7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgZW5kZXIgfSA9IHJlbDtcclxuICAgICAgICAgICAgY29uc3QgZWRnZVRtcGwgPSB7XHJcbiAgICAgICAgICAgICAgICBmcm9tOiBDSEFSX1BSRUZJWCArIHN0YXJ0ZXIsXHJcbiAgICAgICAgICAgICAgICB0bzogQ0hBUl9QUkVGSVggKyBlbmRlcixcclxuICAgICAgICAgICAgICAgIGNvbG9yOiBDb25zdGFudHMuc25SZWxhdGlvbkNvbG9ycy5uZXV0cmFsLFxyXG4gICAgICAgICAgICAgICAgd2lkdGg6IDIsXHJcbiAgICAgICAgICAgICAgICBob3ZlcldpZHRoOiA0XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGlmIChyZWwuZXNzZW5jZS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgIGlmIChjaGVja2VkKCduZXV0cmFsJykpIHtcclxuICAgICAgICAgICAgICAgICAgICBhcnIucHVzaChSLm1lcmdlKGVkZ2VUbXBsLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBDb25zdGFudHMuc25SZWxhdGlvbkNvbG9ycy5uZXV0cmFsLFxyXG4gICAgICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChjaGVja2VkKCdhbGxpZXMnKSAmJiBSLmNvbnRhaW5zKCdhbGxpZXMnLCByZWwuZXNzZW5jZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBhcnIucHVzaChSLm1lcmdlKGVkZ2VUbXBsLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBDb25zdGFudHMuc25SZWxhdGlvbkNvbG9ycy5hbGxpZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGNoZWNrZWQoJ2RpcmVjdGlvbmFsJykgJiYgUi5jb250YWlucygnc3RhcnRlclRvRW5kZXInLCByZWwuZXNzZW5jZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBhcnIucHVzaChSLm1lcmdlKGVkZ2VUbXBsLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBDb25zdGFudHMuc25SZWxhdGlvbkNvbG9ycy5zdGFydGVyVG9FbmRlcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJyb3dzOiAndG8nXHJcbiAgICAgICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGNoZWNrZWQoJ2RpcmVjdGlvbmFsJykgJiYgUi5jb250YWlucygnZW5kZXJUb1N0YXJ0ZXInLCByZWwuZXNzZW5jZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBhcnIucHVzaChSLm1lcmdlKGVkZ2VUbXBsLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBDb25zdGFudHMuc25SZWxhdGlvbkNvbG9ycy5lbmRlclRvU3RhcnRlcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJyb3dzOiAnZnJvbSdcclxuICAgICAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGFycjtcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0U3RvcnlFZGdlcygpIHtcclxuICAgICAgICByZXR1cm4gUi5mbGF0dGVuKFIua2V5cyhzdGF0ZS5TdG9yaWVzKS5tYXAobmFtZSA9PiBSLmtleXMoc3RhdGUuU3Rvcmllc1tuYW1lXS5jaGFyYWN0ZXJzKS5tYXAoY2hhcjEgPT4gKHtcclxuICAgICAgICAgICAgZnJvbTogU1RPUllfUFJFRklYICsgbmFtZSxcclxuICAgICAgICAgICAgdG86IENIQVJfUFJFRklYICsgY2hhcjEsXHJcbiAgICAgICAgICAgIGNvbG9yOiAnZ3JleSdcclxuICAgICAgICB9KSkpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRFdmVudERldGFpbHMoKSB7XHJcbiAgICAgICAgcmV0dXJuIFIuZmxhdHRlbihSLnZhbHVlcyhzdGF0ZS5TdG9yaWVzKS5tYXAoc3RvcnkgPT4gc3RvcnkuZXZlbnRzLm1hcChldmVudCA9PiAoe1xyXG4gICAgICAgICAgICBldmVudE5hbWU6IGV2ZW50Lm5hbWUsXHJcbiAgICAgICAgICAgIHN0b3J5TmFtZTogc3RvcnkubmFtZSxcclxuICAgICAgICAgICAgdGltZTogZXZlbnQudGltZSxcclxuICAgICAgICAgICAgY2hhcmFjdGVyczogUi5rZXlzKGV2ZW50LmNoYXJhY3RlcnMpXHJcbiAgICAgICAgfSkpKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0RGV0YWlsZWRFZGdlcygpIHtcclxuICAgICAgICBjb25zdCBlZGdlc0NoZWNrID0ge307XHJcbiAgICAgICAgUi52YWx1ZXMoc3RhdGUuU3RvcmllcykuZm9yRWFjaCgoc3RvcnkpID0+IHtcclxuICAgICAgICAgICAgc3RvcnkuZXZlbnRzLmZvckVhY2goKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjaGFyTmFtZXMgPSBSLmtleXMoZXZlbnQuY2hhcmFjdGVycykuc29ydCgpO1xyXG4gICAgICAgICAgICAgICAgY2hhck5hbWVzLmZvckVhY2goKGNoYXIxLCBpKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2hhck5hbWVzLmZvckVhY2goKGNoYXIyLCBqKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpIDw9IGopIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBjaGFyMSArIGNoYXIyO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVkZ2VzQ2hlY2tba2V5XSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWRnZXNDaGVja1trZXldID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IENIQVJfUFJFRklYICsgY2hhcjEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG86IENIQVJfUFJFRklYICsgY2hhcjIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6IHt9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlZGdlc0NoZWNrW2tleV0udGl0bGVbc3RvcnkubmFtZV0gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gUi52YWx1ZXMoZWRnZXNDaGVjaykubWFwKChlZGdlSW5mbykgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0aXRsZSA9IFIua2V5cyhlZGdlSW5mby50aXRsZSkuc29ydCgpLmpvaW4oJywgJyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gUi5rZXlzKGVkZ2VJbmZvLnRpdGxlKS5sZW5ndGg7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBmcm9tOiBlZGdlSW5mby5mcm9tLFxyXG4gICAgICAgICAgICAgICAgdG86IGVkZ2VJbmZvLnRvLFxyXG4gICAgICAgICAgICAgICAgdGl0bGU6IGAke3ZhbHVlfTogJHt0aXRsZX1gLFxyXG4gICAgICAgICAgICAgICAgdmFsdWUsXHJcbiAgICAgICAgICAgICAgICBjb2xvcjogJ2dyZXknXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVkcmF3QWxsKCkge1xyXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGdldEVsKCdzb2NpYWxOZXR3b3JrQ29udGFpbmVyJyk7XHJcblxyXG4gICAgICAgIGNvbnN0IGRhdGEgPSB7XHJcbiAgICAgICAgICAgIG5vZGVzOiBzdGF0ZS5ub2Rlc0RhdGFzZXQsXHJcbiAgICAgICAgICAgIGVkZ2VzOiBzdGF0ZS5lZGdlc0RhdGFzZXRcclxuICAgICAgICB9OyAvLyBOb3RlOiBkYXRhIGlzIGNvbWluZyBmcm9tIC4vZGF0YXNvdXJjZXMvV29ybGRDdXAyMDE0LmpzXHJcblxyXG4gICAgICAgIGlmIChzdGF0ZS5uZXR3b3JrKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLm5ldHdvcmsuZGVzdHJveSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3Qgb3B0cyA9IENvbW1vblV0aWxzLmNsb25lKENvbnN0YW50cy5zb2NpYWxOZXR3b3JrT3B0cyk7XHJcbiAgICAgICAgb3B0cy5ncm91cHMgPSBzdGF0ZS5ncm91cENvbG9ycztcclxuXHJcbiAgICAgICAgc3RhdGUubmV0d29yayA9IG5ldyB2aXMuTmV0d29yayhjb250YWluZXIsIGRhdGEsIG9wdHMpO1xyXG5cclxuICAgICAgICBzdGF0ZS5uZXR3b3JrLm9uKCdjbGljaycsIG5laWdoYm91cmhvb2RIaWdobGlnaHQpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGhpZGVMYWJlbChub2RlKSB7XHJcbiAgICAgICAgaWYgKG5vZGUuaGlkZGVuTGFiZWwgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBub2RlLmhpZGRlbkxhYmVsID0gbm9kZS5sYWJlbDtcclxuICAgICAgICAgICAgbm9kZS5sYWJlbCA9IHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiBzaG93TGFiZWwobm9kZSkge1xyXG4gICAgICAgIGlmIChub2RlLmhpZGRlbkxhYmVsICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgbm9kZS5sYWJlbCA9IG5vZGUuaGlkZGVuTGFiZWw7XHJcbiAgICAgICAgICAgIG5vZGUuaGlkZGVuTGFiZWwgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGhpZ2hsaWdodE5vZGVzKG5ldHdvcmssIGFsbE5vZGVzLCB6ZXJvRGVncmVlTm9kZXMsIGZpcnN0RGVncmVlTm9kZXMpIHtcclxuICAgICAgICAvLyBnZXQgdGhlIHNlY29uZCBkZWdyZWUgbm9kZXNcclxuICAgICAgICBjb25zdCBzZWNvbmREZWdyZWVOb2RlcyA9IFIudW5pcShSLmZsYXR0ZW4oZmlyc3REZWdyZWVOb2Rlcy5tYXAoaWQgPT4gbmV0d29yay5nZXRDb25uZWN0ZWROb2RlcyhpZCkpKSk7XHJcbiAgICAgICAgLy8gbWFyayBhbGwgbm9kZXMgYXMgaGFyZCB0byByZWFkLlxyXG4gICAgICAgIFIudmFsdWVzKGFsbE5vZGVzKS5mb3JFYWNoKChub2RlKSA9PiB7XHJcbiAgICAgICAgICAgIG5vZGUuY29sb3IgPSAncmdiYSgyMDAsMjAwLDIwMCwwLjUpJztcclxuICAgICAgICAgICAgaGlkZUxhYmVsKG5vZGUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIGFsbCBzZWNvbmQgZGVncmVlIG5vZGVzIGdldCBhIGRpZmZlcmVudCBjb2xvciBhbmQgdGhlaXIgbGFiZWwgYmFja1xyXG4gICAgICAgIHNlY29uZERlZ3JlZU5vZGVzLm1hcChpZCA9PiBhbGxOb2Rlc1tpZF0pLmZvckVhY2goKG5vZGUpID0+IHtcclxuICAgICAgICAgICAgbm9kZS5jb2xvciA9ICdyZ2JhKDE1MCwxNTAsMTUwLDAuNzUpJztcclxuICAgICAgICAgICAgc2hvd0xhYmVsKG5vZGUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIGFsbCBmaXJzdCBkZWdyZWUgbm9kZXMgZ2V0IHRoZWlyIG93biBjb2xvciBhbmQgdGhlaXIgbGFiZWwgYmFja1xyXG4gICAgICAgIGZpcnN0RGVncmVlTm9kZXMubWFwKGlkID0+IGFsbE5vZGVzW2lkXSkuZm9yRWFjaCgobm9kZSkgPT4ge1xyXG4gICAgICAgICAgICBub2RlLmNvbG9yID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICBzaG93TGFiZWwobm9kZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8gdGhlIG1haW4gbm9kZSBnZXRzIGl0cyBvd24gY29sb3IgYW5kIGl0cyBsYWJlbCBiYWNrLlxyXG4gICAgICAgIHplcm9EZWdyZWVOb2Rlcy5tYXAoaWQgPT4gYWxsTm9kZXNbaWRdKS5mb3JFYWNoKChub2RlKSA9PiB7XHJcbiAgICAgICAgICAgIG5vZGUuY29sb3IgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIHNob3dMYWJlbChub2RlKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBuZWlnaGJvdXJob29kSGlnaGxpZ2h0KHBhcmFtcykge1xyXG4gICAgICAgIC8vIGdldCBhIEpTT04gb2JqZWN0XHJcbiAgICAgICAgY29uc3QgYWxsTm9kZXMgPSBzdGF0ZS5ub2Rlc0RhdGFzZXQuZ2V0KHtcclxuICAgICAgICAgICAgcmV0dXJuVHlwZTogJ09iamVjdCdcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgeyBuZXR3b3JrIH0gPSBzdGF0ZTtcclxuICAgICAgICBpZiAocGFyYW1zLm5vZGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgc3RhdGUuaGlnaGxpZ2h0QWN0aXZlID0gdHJ1ZTtcclxuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWROb2RlID0gcGFyYW1zLm5vZGVzWzBdO1xyXG4gICAgICAgICAgICBjb25zdCB6ZXJvRGVncmVlTm9kZXMgPSBbc2VsZWN0ZWROb2RlXTtcclxuICAgICAgICAgICAgY29uc3QgZmlyc3REZWdyZWVOb2RlcyA9IG5ldHdvcmsuZ2V0Q29ubmVjdGVkTm9kZXMoc2VsZWN0ZWROb2RlKTtcclxuICAgICAgICAgICAgaGlnaGxpZ2h0Tm9kZXMobmV0d29yaywgYWxsTm9kZXMsIHplcm9EZWdyZWVOb2RlcywgZmlyc3REZWdyZWVOb2Rlcyk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChwYXJhbXMuZWRnZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBzdGF0ZS5oaWdobGlnaHRBY3RpdmUgPSB0cnVlO1xyXG4gICAgICAgICAgICBjb25zdCBzZWxlY3RlZEVkZ2UgPSBwYXJhbXMuZWRnZXNbMF07XHJcbiAgICAgICAgICAgIGNvbnN0IGZpcnN0RGVncmVlTm9kZXMgPSBuZXR3b3JrLmdldENvbm5lY3RlZE5vZGVzKHNlbGVjdGVkRWRnZSk7XHJcbiAgICAgICAgICAgIGhpZ2hsaWdodE5vZGVzKG5ldHdvcmssIGFsbE5vZGVzLCBbXSwgZmlyc3REZWdyZWVOb2Rlcyk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS5oaWdobGlnaHRBY3RpdmUgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgLy8gcmVzZXQgYWxsIG5vZGVzXHJcbiAgICAgICAgICAgIFIudmFsdWVzKGFsbE5vZGVzKS5mb3JFYWNoKChub2RlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBub2RlLmNvbG9yID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgc2hvd0xhYmVsKG5vZGUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgc3RhdGUuaGlnaGxpZ2h0QWN0aXZlID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyB0cmFuc2Zvcm0gdGhlIG9iamVjdCBpbnRvIGFuIGFycmF5XHJcbiAgICAgICAgc3RhdGUubm9kZXNEYXRhc2V0LnVwZGF0ZShSLnZhbHVlcyhhbGxOb2RlcykpO1xyXG4gICAgfVxyXG59KSh0aGlzLlNvY2lhbE5ldHdvcmsgPSB7fSk7XHJcbiIsIi8vXCJ1c2Ugc3RyaWN0XCI7XHJcbi8vXHJcbi8vKGZ1bmN0aW9uKGV4cG9ydHMpe1xyXG4vL1xyXG4vLy8vICAgIHZhciBjYW1lcmFJbml0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoLTMwLCA0MCwgMzApLm11bHRpcGx5U2NhbGFyKDIuNSk7XHJcbi8vLy8gICAgdmFyIGNhbWVyYUluaXRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCA0MCwgNDApLm11bHRpcGx5U2NhbGFyKDIuNSk7XHJcbi8vLy8gICAgdmFyIGNhbWVyYUluaXRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCA0MCkubXVsdGlwbHlTY2FsYXIoMi41KTtcclxuLy8gICAgdmFyIGNhbWVyYUluaXRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCA2MCkubXVsdGlwbHlTY2FsYXIoMi41KTtcclxuLy8gICAgdmFyIGJhc2ljWlNjYWxlID0gMjU7XHJcbi8vICAgIHZhciBzcG90TGlnaHRJbml0UG9zID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgNTApO1xyXG4vL1xyXG4vLyAgICAvLyB0aHJlZS5qc1xyXG4vLyAgICB2YXIgY2FtZXJhO1xyXG4vLyAgICB2YXIgc2NlbmU7XHJcbi8vICAgIHZhciByZW5kZXJlcjtcclxuLy8gICAgdmFyIGNvbnRyb2xzO1xyXG4vLyAgICB2YXIgc3RhdHM7XHJcbi8vXHJcbi8vICAgIGZ1bmN0aW9uIGluaXRTdGF0cygpIHtcclxuLy8gICAgICAgIHZhciBzdGF0cyA9IG5ldyBTdGF0cygpO1xyXG4vLyAgICAgICAgc3RhdHMuc2V0TW9kZSgwKTsgLy8gMDogZnBzLCAxOiBtc1xyXG4vLyAgICAgICAgYWRkRWwoY2xlYXJFbChnZXRFbChcIlN0YXRzLW91dHB1dFwiKSksIHN0YXRzLmRvbUVsZW1lbnQpO1xyXG4vLyAgICAgICAgcmV0dXJuIHN0YXRzO1xyXG4vLyAgICB9O1xyXG4vL1xyXG4vLyAgICBmdW5jdGlvbiBpbml0KCl7XHJcbi8vICAgICAgICAvLyBjcmVhdGUgYSByZW5kZXIgYW5kIHNldCB0aGUgc2l6ZVxyXG4vLyAgICAgICAgcmVuZGVyZXIgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJlcigpO1xyXG4vLyAgICAgICAgcmVuZGVyZXIuc2V0Q2xlYXJDb2xvcihuZXcgVEhSRUUuQ29sb3IoMHhFRUVFRUUsIDEuMCkpO1xyXG4vLyAgICAgICAgYWRkRWwoY2xlYXJFbChnZXRFbChcIldlYkdMLW91dHB1dFwiKSksIHJlbmRlcmVyLmRvbUVsZW1lbnQpO1xyXG4vL1xyXG4vLyAgICAgICAgc3RhdHMgPSBpbml0U3RhdHMoKTtcclxuLy9cclxuLy8gICAgICAgIGNvbnRyb2xzID0gbmV3IGZ1bmN0aW9uICgpIHtcclxuLy8gICAgICAgICAgICB0aGlzLnJvdGF0aW9uU3BlZWQgPSAwLjA4O1xyXG4vLy8vICAgICAgICAgICAgdGhpcy5ib3VuY2luZ1NwZWVkID0gMC4wMztcclxuLy8gICAgICAgICAgICB0aGlzLnpTY2FsZSA9IGJhc2ljWlNjYWxlO1xyXG4vLyAgICAgICAgICAgIHRoaXMucGxhbmVTY2FsZSA9IDEwO1xyXG4vLyAgICAgICAgICAgIHRoaXMuY2FtZXJhWiA9IDEyMDtcclxuLy8vLyAgICAgICAgICAgIHRoaXMuY2FtZXJhUm90WCA9IDA7XHJcbi8vLy8gICAgICAgICAgICB0aGlzLmNhbWVyYVJvdFkgPSAwO1xyXG4vLy8vICAgICAgICAgICAgdGhpcy5jYW1lcmFSb3RaID0gMDtcclxuLy9cclxuLy8gICAgICAgICAgICB0aGlzLm91dHB1dE9iamVjdHMgPSBmdW5jdGlvbiAoKSB7XHJcbi8vICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHNjZW5lLmNoaWxkcmVuKTtcclxuLy8gICAgICAgICAgICB9XHJcbi8vICAgICAgICB9O1xyXG4vL1xyXG4vL1xyXG4vLyAgICAgICAgdmFyIGd1aSA9IG5ldyBkYXQuR1VJKHsgYXV0b1BsYWNlOiBmYWxzZSB9KTtcclxuLy8gICAgICAgIGd1aS5hZGQoY29udHJvbHMsICdyb3RhdGlvblNwZWVkJywgMCwgMC41KTtcclxuLy8vLyAgICAgICAgZ3VpLmFkZChjb250cm9scywgJ2JvdW5jaW5nU3BlZWQnLCAwLCAwLjUpO1xyXG4vLyAgICAgICAgZ3VpLmFkZChjb250cm9scywgJ3pTY2FsZScsIDEsIDEwMCk7XHJcbi8vICAgICAgICBndWkuYWRkKGNvbnRyb2xzLCAncGxhbmVTY2FsZScsIDEsIDEwMCk7XHJcbi8vICAgICAgICBndWkuYWRkKGNvbnRyb2xzLCAnY2FtZXJhWicsIC01MDAsIDUwMCk7XHJcbi8vLy8gICAgICAgIGd1aS5hZGQoY29udHJvbHMsICdjYW1lcmFSb3RYJywgLTEsIDEpO1xyXG4vLy8vICAgICAgICBndWkuYWRkKGNvbnRyb2xzLCAnY2FtZXJhUm90WScsIC0xLCAxKTtcclxuLy8vLyAgICAgICAgZ3VpLmFkZChjb250cm9scywgJ2NhbWVyYVJvdFonLCAtMSwgMSk7XHJcbi8vXHJcbi8vICAgICAgICBndWkuYWRkKGNvbnRyb2xzLCAnb3V0cHV0T2JqZWN0cycpO1xyXG4vL1xyXG4vLyAgICAgICAgYWRkRWwoZ2V0RWwoJ2d1aS1zZXR0aW5ncy1vdXRwdXQnKSwgZ3VpLmRvbUVsZW1lbnQpO1xyXG4vLyAgICAvLyAgICByZW5kZXJlci5zaGFkb3dNYXBFbmFibGVkID0gdHJ1ZTtcclxuLy8gICAgfTtcclxuLy9cclxuLy8gICAgdmFyIGlzRmlyc3RSZWZyZXNoID0gdHJ1ZTtcclxuLy9cclxuLy8gICAgLy8gb25jZSBldmVyeXRoaW5nIGlzIGxvYWRlZCwgd2UgcnVuIG91ciBUaHJlZS5qcyBzdHVmZi5cclxuLy8gICAgZnVuY3Rpb24gcmVmcmVzaChuZXR3b3JrLCBub2RlcywgZWRnZXMsIGV2ZW50RGV0YWlscywgbWV0YUluZm8pIHtcclxuLy9cclxuLy8gICAgICAgIHZhciBsb3dlclRpbWVCb3VuZGFyeSA9IG5ldyBEYXRlKG1ldGFJbmZvLnByZUdhbWVEYXRlKS5nZXRUaW1lKCk7XHJcbi8vICAgICAgICB2YXIgdXBwZXJUaW1lQm91bmRhcnkgPSBuZXcgRGF0ZShtZXRhSW5mby5kYXRlKS5nZXRUaW1lKCk7XHJcbi8vICAgICAgICB2YXIgdGltZURpZmYgPSB1cHBlclRpbWVCb3VuZGFyeSAtIGxvd2VyVGltZUJvdW5kYXJ5O1xyXG4vLyAgICAgICAgY29uc29sZS5sb2cobG93ZXJUaW1lQm91bmRhcnkpO1xyXG4vLyAgICAgICAgY29uc29sZS5sb2codXBwZXJUaW1lQm91bmRhcnkpO1xyXG4vLyAgICAgICAgY29uc29sZS5sb2codGltZURpZmYpO1xyXG4vL1xyXG4vLyAgICAgICAgdmFyIGNoYXJhY3RlckV2ZW50cyA9IHt9O1xyXG4vLyAgICAgICAgdmFyIHN0b3J5RXZlbnRzID0ge307XHJcbi8vICAgICAgICBldmVudERldGFpbHMuZm9yRWFjaChmdW5jdGlvbihldmVudEluZm8pe1xyXG4vLyAgICAgICAgICAgIGlmKGV2ZW50SW5mby50aW1lID09PSAnJyl7XHJcbi8vICAgICAgICAgICAgICAgIGV2ZW50SW5mby50aW1lID0gbWV0YUluZm8uZGF0ZTtcclxuLy8gICAgICAgICAgICB9XHJcbi8vICAgICAgICAgICAgZXZlbnRJbmZvLnNjYWxlZFRpbWUgPSAobmV3IERhdGUoZXZlbnRJbmZvLnRpbWUpLmdldFRpbWUoKSAtIGxvd2VyVGltZUJvdW5kYXJ5KSAvIHRpbWVEaWZmO1xyXG4vLyAgICAgICAgICAgIGNvbnNvbGUubG9nKGV2ZW50SW5mby5zY2FsZWRUaW1lKTtcclxuLy8gICAgICAgICAgICBzdG9yeUV2ZW50c1tldmVudEluZm8uc3RvcnlOYW1lXSA9IHN0b3J5RXZlbnRzW2V2ZW50SW5mby5zdG9yeU5hbWVdIHx8IHtldmVudHM6IFtdfTtcclxuLy8gICAgICAgICAgICBzdG9yeUV2ZW50c1tldmVudEluZm8uc3RvcnlOYW1lXS5ldmVudHMucHVzaChldmVudEluZm8pO1xyXG4vLyAgICAgICAgICAgIGV2ZW50SW5mby5jaGFyYWN0ZXJzLmZvckVhY2goZnVuY3Rpb24oY2hhcmFjdGVyKXtcclxuLy8gICAgICAgICAgICAgICAgY2hhcmFjdGVyRXZlbnRzW2NoYXJhY3Rlcl0gPSBjaGFyYWN0ZXJFdmVudHNbY2hhcmFjdGVyXSB8fCB7ZXZlbnRzOiBbXX07XHJcbi8vICAgICAgICAgICAgICAgIGNoYXJhY3RlckV2ZW50c1tjaGFyYWN0ZXJdLmV2ZW50cy5wdXNoKGV2ZW50SW5mbyk7XHJcbi8vICAgICAgICAgICAgfSk7XHJcbi8vICAgICAgICB9KTtcclxuLy8gICAgICAgIGNvbnNvbGUubG9nKHN0b3J5RXZlbnRzKTtcclxuLy8gICAgICAgIGNvbnNvbGUubG9nKGNoYXJhY3RlckV2ZW50cyk7XHJcbi8vICAgICAgICBmdW5jdGlvbiBmaWxsTWluTWF4KG9iakluZm8pe1xyXG4vLyAgICAgICAgICAgIG9iakluZm8ubWluVGltZSA9IFIucmVkdWNlKFIubWluLCBJbmZpbml0eSwgb2JqSW5mby5ldmVudHMubWFwKFIucHJvcCgnc2NhbGVkVGltZScpKSk7XHJcbi8vICAgICAgICAgICAgb2JqSW5mby5tYXhUaW1lID0gUi5yZWR1Y2UoUi5tYXgsIC1JbmZpbml0eSwgb2JqSW5mby5ldmVudHMubWFwKFIucHJvcCgnc2NhbGVkVGltZScpKSk7XHJcbi8vICAgICAgICB9XHJcbi8vICAgICAgICBSLnZhbHVlcyhzdG9yeUV2ZW50cykuZm9yRWFjaChmaWxsTWluTWF4KTtcclxuLy8gICAgICAgIFIudmFsdWVzKGNoYXJhY3RlckV2ZW50cykuZm9yRWFjaChmaWxsTWluTWF4KTtcclxuLy8gICAgICAgIGNvbnNvbGUubG9nKHN0b3J5RXZlbnRzKTtcclxuLy8gICAgICAgIGNvbnNvbGUubG9nKGNoYXJhY3RlckV2ZW50cyk7XHJcbi8vXHJcbi8vICAgICAgICB2YXIgc2l6ZXMgPSB1cGRhdGVSZW5kZXJlclNpemUoKTtcclxuLy8vLyAgICAgICAgaWYoaXNGaXJzdFJlZnJlc2gpe1xyXG4vLyAgICAgICAgLy8gY3JlYXRlIGEgc2NlbmUsIHRoYXQgd2lsbCBob2xkIGFsbCBvdXIgZWxlbWVudHMgc3VjaCBhcyBvYmplY3RzLCBjYW1lcmFzIGFuZCBsaWdodHMuXHJcbi8vICAgICAgICBzY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpO1xyXG4vL1xyXG4vLyAgICAgICAgLy8gY3JlYXRlIGEgY2FtZXJhLCB3aGljaCBkZWZpbmVzIHdoZXJlIHdlJ3JlIGxvb2tpbmcgYXQuXHJcbi8vICAgICAgICBjYW1lcmEgPSBuZXcgVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmEoNDUsIHNpemVzLndpZHRoIC8gc2l6ZXMuaGVpZ2h0LCAwLjEsIDEwMDApO1xyXG4vL1xyXG4vLy8vICAgICAgICB2YXIgb3JiaXRDb250cm9scyA9IG5ldyBUSFJFRS5PcmJpdENvbnRyb2xzKGNhbWVyYSk7XHJcbi8vLy8vLyAgICAgICAgb3JiaXRDb250cm9scy5hdXRvUm90YXRlID0gdHJ1ZTtcclxuLy8vLyAgICAgICAgdmFyIGNsb2NrID0gbmV3IFRIUkVFLkNsb2NrKCk7XHJcbi8vXHJcbi8vICAgICAgICAvLyBzaG93IGF4ZXMgaW4gdGhlIHNjcmVlblxyXG4vLyAgICAgICAgdmFyIGF4ZXMgPSBuZXcgVEhSRUUuQXhpc0hlbHBlcigyMCk7XHJcbi8vICAgICAgICBzY2VuZS5hZGQoYXhlcyk7XHJcbi8vXHJcbi8vICAgICAgICAvLyBjcmVhdGUgdGhlIGdyb3VuZCBwbGFuZVxyXG4vLyAgICAgICAgdmFyIHBsYW5lR2VvbWV0cnkgPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeSg2MCwgMjAsIDEsIDEpO1xyXG4vLyAgICAgICAgdmFyIHBsYW5lTWF0ZXJpYWwgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoe2NvbG9yOiAweGZmZmZmZiwgb3BhY2l0eTogMH0pO1xyXG4vLyAgICAgICAgdmFyIHBsYW5lID0gbmV3IFRIUkVFLk1lc2gocGxhbmVHZW9tZXRyeSwgcGxhbmVNYXRlcmlhbCk7XHJcbi8vICAgICAgICAvLyAgICBwbGFuZS5yZWNlaXZlU2hhZG93ID0gdHJ1ZTtcclxuLy9cclxuLy8gICAgICAgIC8vIHJvdGF0ZSBhbmQgcG9zaXRpb24gdGhlIHBsYW5lXHJcbi8vICAgICAgICBwbGFuZS5yb3RhdGlvbi54ID0gLTAuNSAqIE1hdGguUEk7XHJcbi8vICAgICAgICBwbGFuZS5wb3NpdGlvbi54ID0gMTU7XHJcbi8vICAgICAgICBwbGFuZS5wb3NpdGlvbi55ID0gMDtcclxuLy8gICAgICAgIHBsYW5lLnBvc2l0aW9uLnogPSAwO1xyXG4vL1xyXG4vLyAgICAgICAgLy8gYWRkIHRoZSBwbGFuZSB0byB0aGUgc2NlbmVcclxuLy8gICAgICAgIHNjZW5lLmFkZChwbGFuZSk7XHJcbi8vXHJcbi8vICAgICAgICAvLyBwb3NpdGlvbiBhbmQgcG9pbnQgdGhlIGNhbWVyYSB0byB0aGUgY2VudGVyIG9mIHRoZSBzY2VuZVxyXG4vLyAgICAgICAgY2FtZXJhLnBvc2l0aW9uLmNvcHkoY2FtZXJhSW5pdFBvcyk7XHJcbi8vICAgICAgICBjYW1lcmEubG9va0F0KG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApKTtcclxuLy8gICAgICAgIGNhbWVyYS5wb3NpdGlvbi5hZGQobmV3IFRIUkVFLlZlY3RvcjMoMCwgLTEwMCwgMCkpO1xyXG4vLyAgICAgICAgY2FtZXJhLmxvb2tBdChuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKSk7XHJcbi8vLy8gICAgICAgIGNhbWVyYS5yb3RhdGlvbi56ID0gIE1hdGguUEk7XHJcbi8vLy8gICAgICAgIGNhbWVyYS5sb29rQXQoc2NlbmUucG9zaXRpb24pO1xyXG4vL1xyXG4vLy8vICAgICAgICBjYW1lcmEucm90YXRlT25BeGlzKGNhbWVyYUluaXRQb3Mubm9ybWFsaXplKCkgLCAwLjYpO1xyXG4vLy8vICAgICAgICBjYW1lcmEucm90YXRpb24ueiA9IDAuNzUgKiBNYXRoLlBJO1xyXG4vL1xyXG4vLy8vICAgICAgICBjYW1lcmEucG9zaXRpb24ueCA9IC0zMDtcclxuLy8vLyAgICAgICAgY2FtZXJhLnBvc2l0aW9uLnkgPSA0MDtcclxuLy8vLyAgICAgICAgY2FtZXJhLnBvc2l0aW9uLnogPSAzMDtcclxuLy9cclxuLy8gICAgICAgIC8vIGFkZCBzdWJ0bGUgYW1iaWVudCBsaWdodGluZ1xyXG4vLyAgICAgICAgdmFyIGFtYmllbnRMaWdodCA9IG5ldyBUSFJFRS5BbWJpZW50TGlnaHQoMHgwYzBjMGMpO1xyXG4vLyAgICAgICAgc2NlbmUuYWRkKGFtYmllbnRMaWdodCk7XHJcbi8vXHJcbi8vICAgICAgICAvLyBhZGQgc3BvdGxpZ2h0IGZvciB0aGUgc2hhZG93c1xyXG4vLyAgICAgICAgdmFyIHNwb3RMaWdodCA9IG5ldyBUSFJFRS5TcG90TGlnaHQoMHhmZmZmZmYpO1xyXG4vLyAgICAgICAgc3BvdExpZ2h0LnBvc2l0aW9uLmNvcHkoc3BvdExpZ2h0SW5pdFBvcyk7XHJcbi8vICAgICAgICAvLyAgICBzcG90TGlnaHQuY2FzdFNoYWRvdyA9IHRydWU7XHJcbi8vICAgICAgICBzY2VuZS5hZGQoc3BvdExpZ2h0KTtcclxuLy8vLyAgICAgICAgICAgIGlzRmlyc3RSZWZyZXNoID0gZmFsc2U7XHJcbi8vLy8gICAgICAgIH1cclxuLy9cclxuLy8gICAgICAgIC8vIGNhbGwgdGhlIHJlbmRlciBmdW5jdGlvblxyXG4vLyAgICAgICAgdmFyIHN0ZXAgPSAwO1xyXG4vL1xyXG4vLyAgICAgICAgdmFyIGlzSW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuLy8vLyAgICAgICAgaWYoaXNGaXJzdFJlZnJlc2gpe1xyXG4vLyAgICAgICAgICAgIHJlbmRlcigpO1xyXG4vLy8vICAgICAgICAgICAgaXNGaXJzdFJlZnJlc2ggPSBmYWxzZTtcclxuLy8vLyAgICAgICAgfVxyXG4vLy8vICAgICAgICBuZXR3b3JrLnN0b3JlUG9zaXRpb25zKCk7XHJcbi8vXHJcbi8vICAgICAgICBmdW5jdGlvbiBnZXRFdmVudEluZm8oaWQpe1xyXG4vLyAgICAgICAgICAgIGlmKGlkLnN0YXJ0c1dpdGgoJ1N0OicpKXtcclxuLy8gICAgICAgICAgICAgICAgcmV0dXJuIHN0b3J5RXZlbnRzW2lkLnN1YnN0cmluZygzKV07XHJcbi8vICAgICAgICAgICAgfSBlbHNlIHtcclxuLy8gICAgICAgICAgICAgICAgcmV0dXJuIGNoYXJhY3RlckV2ZW50c1tpZF07XHJcbi8vICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgfTtcclxuLy9cclxuLy8gICAgICAgIGZ1bmN0aW9uIHJlbmRlcigpIHtcclxuLy8gICAgICAgICAgICBzdGF0cy51cGRhdGUoKTtcclxuLy8gICAgICAgICAgICBuZXR3b3JrLnN0b3JlUG9zaXRpb25zKCk7XHJcbi8vICAgICAgICAgICAgaWYoIWlzSW5pdGlhbGl6ZWQpe1xyXG4vLyAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhub2Rlcy5nZXQoKSk7XHJcbi8vICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVkZ2VzLmdldCgpKTtcclxuLy8gICAgICAgICAgICAgICAgbm9kZXMuZ2V0KCkuZm9yRWFjaChmdW5jdGlvbihub2RlKXtcclxuLy8gICAgICAgICAgICAgICAgICAgIHZhciBldmVudEluZm8gPSBnZXRFdmVudEluZm8obm9kZS5pZCk7XHJcbi8vXHJcbi8vICAgICAgICAgICAgICAgICAgICBpZihldmVudEluZm8pe1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoZWlnaHQgPSBldmVudEluZm8ubWF4VGltZSAtIGV2ZW50SW5mby5taW5UaW1lO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgIHZhciB6ID0gKGV2ZW50SW5mby5tYXhUaW1lICsgZXZlbnRJbmZvLm1pblRpbWUpLzI7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgYWRkQ3lsaW5kZXIobm9kZS54LzEwLC1ub2RlLnkvMTAsIHoqYmFzaWNaU2NhbGUsIGhlaWdodCwgMC41LCBTdHJpbmcoJ2N5bC0nICsgbm9kZS5pZCkpO1xyXG4vLy8vICAgICAgICAgICAgICAgICAgICAgICAgYWRkQ3lsaW5kZXIoMCwwLDAsIDIsIDAuNSwgU3RyaW5nKCdjeWwtJyArIG5vZGUuaWQpKTtcclxuLy8vLyAgICAgICAgICAgICAgICAgICAgICAgIGFkZEN5bGluZGVyKG5vZGUueC8xMCwtbm9kZS55LzEwLCAtNSwgaGVpZ2h0LCAzLCBTdHJpbmcobm9kZS5pZCArICcwJykpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgfVxyXG4vLy8vICAgICAgICAgICAgICAgICAgICBhZGRDeWxpbmRlcihub2RlLngvMTAsLW5vZGUueS8xMCwgNCwgU3RyaW5nKG5vZGUuaWQgKyAnMS10b3AnKSk7XHJcbi8vICAgICAgICAgICAgICAgIH0pO1xyXG4vL1xyXG4vLyAgICAgICAgICAgICAgICBpc0luaXRpYWxpemVkID0gdHJ1ZTtcclxuLy8gICAgICAgICAgICB9IGVsc2Uge1xyXG4vLyAgICAgICAgICAgICAgICBub2Rlcy5nZXQoKS5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpe1xyXG4vLyAgICAgICAgICAgICAgICAgICAgdmFyIGN5bCA9IHNjZW5lLmdldE9iamVjdEJ5TmFtZShTdHJpbmcoJ2N5bC0nICsgbm9kZS5pZCkpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgaWYoY3lsKXtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBjeWwucG9zaXRpb24ueCA9IG5vZGUueC8xMDtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBjeWwucG9zaXRpb24ueSA9IC1ub2RlLnkvMTA7XHJcbi8vICAgICAgICAgICAgICAgICAgICB9XHJcbi8vLy8gICAgICAgICAgICAgICAgICAgIGN5bCA9IHNjZW5lLmdldE9iamVjdEJ5TmFtZShTdHJpbmcobm9kZS5pZCArICcxLXRvcCcpKTtcclxuLy8vLyAgICAgICAgICAgICAgICAgICAgY3lsLnBvc2l0aW9uLnggPSBub2RlLngvMTA7XHJcbi8vLy8gICAgICAgICAgICAgICAgICAgIGN5bC5wb3NpdGlvbi55ID0gLW5vZGUueS8xMDtcclxuLy8gICAgICAgICAgICAgICAgfSk7XHJcbi8vICAgICAgICAgICAgfVxyXG4vL1xyXG4vLyAgICAgICAgICAgIHNjZW5lLnRyYXZlcnNlKGZ1bmN0aW9uIChlKSB7XHJcbi8vICAgICAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2YgVEhSRUUuTWVzaCAmJiBlLm5hbWUuc3RhcnRzV2l0aCgnY3lsLScpKSB7XHJcbi8vLy8gICAgICAgICAgICAgICAgICAgIGUucG9zaXRpb24ueSA9IGNvbnRyb2xzLnpTY2FsZTtcclxuLy8gICAgICAgICAgICAgICAgICAgIHZhciBldmVudEluZm8gPSBnZXRFdmVudEluZm8oZS5uYW1lLnN1YnN0cmluZyg0KSk7XHJcbi8vLy8gICAgICAgICAgICAgICAgICAgIGlmKGV2ZW50SW5mbyl7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgZS5wb3NpdGlvbi56ID0gKGV2ZW50SW5mby5tYXhUaW1lICsgZXZlbnRJbmZvLm1pblRpbWUpLzIgKiBjb250cm9scy56U2NhbGU7XHJcbi8vLy8gICAgICAgICAgICAgICAgICAgICAgICBlLnNldEhlaWdodCgoZXZlbnRJbmZvLm1heFRpbWUgLSBldmVudEluZm8ubWluVGltZSkgKiBjb250cm9scy56U2NhbGUpO1xyXG4vLy8vICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4vLy8vICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZS5uYW1lKTtcclxuLy8vLyAgICAgICAgICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgICAgICAgICAgICAgZS5zY2FsZS55ID0gY29udHJvbHMuelNjYWxlO1xyXG4vLyAgICAgICAgICAgICAgICB9XHJcbi8vICAgICAgICAgICAgfSk7XHJcbi8vXHJcbi8vICAgICAgICAgICAgdmFyIG5vd1RpbWUgPSBEYXRlLm5vdygpO1xyXG4vLyAgICAgICAgICAgIHZhciBtdWx0aXAgPSAwLjAwNTtcclxuLy8gICAgICAgICAgICBjYW1lcmEucG9zaXRpb24ueCA9IDUwKk1hdGguc2luKG5vd1RpbWUqY29udHJvbHMucm90YXRpb25TcGVlZCptdWx0aXApO1xyXG4vLyAgICAgICAgICAgIGNhbWVyYS5wb3NpdGlvbi55ID0gNTAqTWF0aC5jb3Mobm93VGltZSpjb250cm9scy5yb3RhdGlvblNwZWVkKm11bHRpcCk7XHJcbi8vICAgICAgICAgICAgY2FtZXJhLnBvc2l0aW9uLnogPSBjb250cm9scy5jYW1lcmFaO1xyXG4vLyAgICAgICAgICAgIGNhbWVyYS5sb29rQXQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCkpO1xyXG4vLy8vICAgICAgICAgICAgc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24gKGUpIHtcclxuLy8vLyAgICAgICAgICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIFRIUkVFLk1lc2ggJiYgZS5uYW1lLmVuZHNXaXRoKCcxLXRvcCcpKSB7XHJcbi8vLy8vLyAgICAgICAgICAgICAgICAgICAgZS5wb3NpdGlvbi55ID0gY29udHJvbHMuelNjYWxlO1xyXG4vLy8vICAgICAgICAgICAgICAgICAgICBlLnBvc2l0aW9uLnogPSBjb250cm9scy56U2NhbGU7XHJcbi8vLy8gICAgICAgICAgICAgICAgfVxyXG4vLy8vICAgICAgICAgICAgfSk7XHJcbi8vXHJcbi8vLy8gICAgICAgICAgICB2YXIgZGVsdGEgPSBjbG9jay5nZXREZWx0YSgpO1xyXG4vLy8vICAgICAgICAgICAgb3JiaXRDb250cm9scy51cGRhdGUoZGVsdGEpO1xyXG4vL1xyXG4vLy8vICAgICAgICAgICAgY2FtZXJhLnJvdGF0ZU9uQXhpcyhjYW1lcmFJbml0UG9zLm5vcm1hbGl6ZSgpICwgY29udHJvbHMuY2FtZXJhUm90WCk7XHJcbi8vLy8gICAgICAgICAgICBjYW1lcmEucm90YXRlT25BeGlzKGNhbWVyYS5nZXRXb3JsZERpcmVjdGlvbigpLm5vcm1hbGl6ZSgpICwgY29udHJvbHMuY2FtZXJhUm90WCk7XHJcbi8vLy8gICAgICAgICAgICBjYW1lcmEucm90YXRpb24uY29weShuZXcgVEhSRUUuVmVjdG9yMyhjb250cm9scy5jYW1lcmFSb3RYLFxyXG4vLy8vICAgICAgICAgICAgICAgIGNvbnRyb2xzLmNhbWVyYVJvdFksIGNvbnRyb2xzLmNhbWVyYVJvdFopLm11bHRpcGx5U2NhbGFyKE1hdGguUEkpKTtcclxuLy8vLyAgICAgICAgICAgIGNhbWVyYS5yb3RhdGlvbi54ID0gY29udHJvbHMuY2FtZXJhUm90WCAqIE1hdGguUEk7XHJcbi8vXHJcbi8vICAgICAgICAgICAgLy8gcmVuZGVyIHVzaW5nIHJlcXVlc3RBbmltYXRpb25GcmFtZVxyXG4vLyAgICAgICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShyZW5kZXIpO1xyXG4vLyAgICAgICAgICAgIHJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTtcclxuLy8gICAgICAgIH1cclxuLy9cclxuLy8gICAgfVxyXG4vL1xyXG4vLyAgICBmdW5jdGlvbiB1cGRhdGVSZW5kZXJlclNpemUoKXtcclxuLy8gICAgICAgIHZhciBzdHlsZXMgPSBnZXRDb21wdXRlZFN0eWxlKGdldEVsKCdzb2NpYWxOZXR3b3JrQ29udGFpbmVyJykpO1xyXG4vLyAgICAgICAgdmFyIHdpZHRoID0gc3R5bGVzLndpZHRoLnNwbGl0KCdweCcpLmpvaW4oJycpICogMC43NTtcclxuLy8gICAgICAgIHZhciBoZWlnaHQgPSBzdHlsZXMuaGVpZ2h0LnNwbGl0KCdweCcpLmpvaW4oJycpICogMC43NTtcclxuLy8gICAgICAgIHJlbmRlcmVyLnNldFNpemUod2lkdGgsIGhlaWdodCk7XHJcbi8vICAgICAgICByZXR1cm4ge1xyXG4vLyAgICAgICAgICAgIHdpZHRoOiB3aWR0aCxcclxuLy8gICAgICAgICAgICBoZWlnaHQ6IGhlaWdodCxcclxuLy8gICAgICAgIH1cclxuLy8gICAgfVxyXG4vLyAgICBmdW5jdGlvbiBvblJlc2l6ZSgpIHtcclxuLy8gICAgICAgIGlmKGNhbWVyYSAmJiByZW5kZXJlcil7XHJcbi8vICAgICAgICAgICAgdmFyIHNpemVzID0gdXBkYXRlUmVuZGVyZXJTaXplKCk7XHJcbi8vICAgICAgICAgICAgY2FtZXJhLmFzcGVjdCA9IHNpemVzLndpZHRoIC8gc2l6ZXMuaGVpZ2h0O1xyXG4vLyAgICAgICAgICAgIGNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7XHJcbi8vICAgICAgICB9XHJcbi8vICAgIH1cclxuLy9cclxuLy8gICAgZnVuY3Rpb24gYWRkQ3lsaW5kZXIoeCwgeSwgeiwgaGVpZ2h0LCByYWRpdXMsIGlkKSB7XHJcbi8vXHJcbi8vICAgICAgICB2YXIgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSggcmFkaXVzLCByYWRpdXMsIGhlaWdodCwgMzIgKTtcclxuLy8gICAgICAgIHZhciBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoTGFtYmVydE1hdGVyaWFsKCB7Y29sb3I6IDB4Nzc3N2ZmfSApO1xyXG4vLyAgICAgICAgdmFyIGN5bGluZGVyID0gbmV3IFRIUkVFLk1lc2goIGdlb21ldHJ5LCBtYXRlcmlhbCApO1xyXG4vLyAgICAgICAgY3lsaW5kZXIubmFtZSA9IGlkO1xyXG4vL1xyXG4vLyAgICAgICAgY3lsaW5kZXIucG9zaXRpb24ueCA9IHg7XHJcbi8vICAgICAgICBjeWxpbmRlci5wb3NpdGlvbi55ID0geTtcclxuLy8gICAgICAgIGN5bGluZGVyLnBvc2l0aW9uLnogPSB6O1xyXG4vLyAgICAgICAgY3lsaW5kZXIucm90YXRpb24ueCA9IC0wLjUgKiBNYXRoLlBJO1xyXG4vLy8vICAgICAgICBjeWxpbmRlci5wb3NpdGlvbi55ID0gejtcclxuLy8vLyAgICAgICAgY3lsaW5kZXIucG9zaXRpb24ueiA9IHk7XHJcbi8vXHJcbi8vICAgIC8vICAgIGN5bGluZGVyLnBvc2l0aW9uLnggPSA0MDtcclxuLy9cclxuLy8gICAgICAgIHNjZW5lLmFkZCggY3lsaW5kZXIgKTtcclxuLy9cclxuLy8gICAgfTtcclxuLy9cclxuLy8gICAgZXhwb3J0cy5pbml0ID0gaW5pdDtcclxuLy8gICAgZXhwb3J0cy5yZWZyZXNoID0gcmVmcmVzaDtcclxuLy8vLyAgICB3aW5kb3cub25sb2FkID0gaW5pdDtcclxuLy9cclxuLy8gICAgLy8gbGlzdGVuIHRvIHRoZSByZXNpemUgZXZlbnRzXHJcbi8vICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCBvblJlc2l6ZSwgZmFsc2UpO1xyXG4vL1xyXG4vL1xyXG4vL30pKHRoaXNbJ1RpbWVsaW5lZE5ldHdvcmsnXT17fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUtMjAxOCBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBqUXVlcnksIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCBkZWZhdWx0SGlzdHMgPSBbJ3N0b3J5RXZlbnRzSGlzdCcsICdzdG9yeUNoYXJhY3RlcnNIaXN0JywgJ2V2ZW50Q29tcGxldGVuZXNzSGlzdCcsXHJcbiAgICAgICAgJ2NoYXJhY3RlclN5bWJvbHNIaXN0JywgJ2NoYXJhY3RlclN0b3JpZXNIaXN0J107XHJcbiAgICBjb25zdCBlbnRpdHlDaGFydHMgPSBbJ2NoYXJhY3RlckNoYXJ0JywgJ3BsYXllckNoYXJ0JywgJ3N0b3J5Q2hhcnQnLCAnZ3JvdXBDaGFydCddO1xyXG5cclxuICAgIGNvbnN0IHN0YXRpc3RpY0tleXMgPSBbXHJcbiAgICAgICAgJ2NoYXJhY3Rlck51bWJlcicsXHJcbiAgICAgICAgJ3BsYXllck51bWJlcicsXHJcbiAgICAgICAgJ3N0b3J5TnVtYmVyJyxcclxuICAgICAgICAnZ3JvdXBOdW1iZXInLFxyXG4gICAgICAgICdldmVudHNOdW1iZXInLFxyXG4gICAgICAgICd1c2VyTnVtYmVyJyxcclxuICAgICAgICAndGV4dENoYXJhY3Rlck51bWJlcicsXHJcbiAgICAgICAgJ2xhc3RFdmVudCcsXHJcbiAgICAgICAgJ2ZpcnN0RXZlbnQnLFxyXG4gICAgXTtcclxuXHJcbiAgICBjb25zdCByb290ID0gJy5vdmVydmlldy10YWIgJztcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcblxyXG4gICAgc3RhdGUuQ2hhcnRzID0ge307XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIHN0YXRlLm5hbWUgPSBnZXRFbCgnZ2FtZU5hbWVJbnB1dCcpO1xyXG4gICAgICAgIHN0YXRlLm5hbWUuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgdXBkYXRlTmFtZSk7XHJcblxyXG4gICAgICAgIHN0YXRlLmxhc3RTYXZlVGltZSA9IGdldEVsKCdsYXN0U2F2ZVRpbWUnKTtcclxuXHJcbiAgICAgICAgc3RhdGUuZGF0ZSA9IGdldEVsKCdnYW1lRGF0ZVBpY2tlcicpO1xyXG5cclxuICAgICAgICBsZXQgb3B0cyA9IHtcclxuICAgICAgICAgICAgbGFuZzogTDEwbi5nZXRMYW5nKCksXHJcbiAgICAgICAgICAgIG1hc2s6IHRydWUsXHJcbiAgICAgICAgICAgIG9uQ2hhbmdlRGF0ZVRpbWU6IHVwZGF0ZVRpbWVcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBqUXVlcnkoc3RhdGUuZGF0ZSkuZGF0ZXRpbWVwaWNrZXIob3B0cyk7XHJcblxyXG4gICAgICAgIHN0YXRlLnByZURhdGUgPSBnZXRFbCgncHJlR2FtZURhdGVQaWNrZXInKTtcclxuXHJcbiAgICAgICAgb3B0cyA9IHtcclxuICAgICAgICAgICAgbGFuZzogTDEwbi5nZXRMYW5nKCksXHJcbiAgICAgICAgICAgIG1hc2s6IHRydWUsXHJcbiAgICAgICAgICAgIG9uQ2hhbmdlRGF0ZVRpbWU6IHVwZGF0ZVByZUdhbWVEYXRlXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgalF1ZXJ5KHN0YXRlLnByZURhdGUpLmRhdGV0aW1lcGlja2VyKG9wdHMpO1xyXG5cclxuICAgICAgICBMMTBuLm9uTDEwbkNoYW5nZSgoKSA9PiB7XHJcbiAgICAgICAgICAgIGpRdWVyeShzdGF0ZS5kYXRlKS5kYXRldGltZXBpY2tlcih7XHJcbiAgICAgICAgICAgICAgICBsYW5nOiBMMTBuLmdldExhbmcoKVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgalF1ZXJ5KHN0YXRlLnByZURhdGUpLmRhdGV0aW1lcGlja2VyKHtcclxuICAgICAgICAgICAgICAgIGxhbmc6IEwxMG4uZ2V0TGFuZygpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBzdGF0ZS5kZXNjciA9IHF1ZXJ5RWwoYCR7cm9vdH0uZ2FtZS1kZXNjcmlwdGlvbi1hcmVhYCk7XHJcbiAgICAgICAgc3RhdGUuZGVzY3IuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgdXBkYXRlRGVzY3IpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IGdlYXJzQ29udGFpbmVyID0gcWVlKHF1ZXJ5RWwocm9vdCksICcjZ2VhcnMnKTtcclxuICAgICAgICBhZGRFbChnZWFyc0NvbnRhaW5lciwgcWUoJy5nZWFycy10YWInKSk7XHJcbiAgICAgICAgR2VhcnMuaW5pdCgpO1xyXG4gICAgICAgIHZhciBvYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGZ1bmN0aW9uKG11dGF0aW9ucykge1xyXG4gICAgICAgICAgICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihtdXRhdGlvbikge1xyXG4gICAgICAgICAgICAgICAgaWYgKG11dGF0aW9uLmF0dHJpYnV0ZU5hbWUgPT09IFwiY2xhc3NcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGhhc0NsYXNzKGdlYXJzQ29udGFpbmVyLCAnYWN0aXZlJykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgR2VhcnMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgb2JzZXJ2ZXIub2JzZXJ2ZShnZWFyc0NvbnRhaW5lciwge1xyXG4gICAgICAgICAgICBhdHRyaWJ1dGVzOiB0cnVlXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3Qgc2xpZGVyc0NvbnRhaW5lciA9IHFlZShxdWVyeUVsKHJvb3QpLCAnI3NsaWRlcnMnKTtcclxuICAgICAgICBhZGRFbChzbGlkZXJzQ29udGFpbmVyLCBxZSgnLnNsaWRlcnMtdGFiJykpO1xyXG4gICAgICAgIFNsaWRlcnMuaW5pdCgpO1xyXG5cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgICAgIEdlYXJzLnJlZnJlc2goKTtcclxuICAgICAgICBTbGlkZXJzLnJlZnJlc2goKTtcclxuICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuaXNBZG1pbigoZXJyLCBpc0FkbWluKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIFV0aWxzLmVuYWJsZShleHBvcnRzLmNvbnRlbnQsICdhZG1pbk9ubHknLCBpc0FkbWluKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBQcm9taXNlLmFsbCggW0RCTVMuZ2V0TWV0YUluZm9QbSgpLCBEQk1TLmdldFN0YXRpc3RpY3NQbSgpXSApLnRoZW4odXBkYXRlT3ZlcnZpZXdUYWIpLmNhdGNoKFV0aWxzLmhhbmRsZUVycm9yKTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUNoYXJ0KGlkLCBjYW52YXMsIGRhdGEpIHtcclxuICAgICAgICBpZiAoc3RhdGUuQ2hhcnRzW2lkXSkge1xyXG4gICAgICAgICAgICBzdGF0ZS5DaGFydHNbaWRdLmRlc3Ryb3koKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGxhYmVscyA9IFtdO1xyXG4gICAgICAgIGNvbnN0IGRhdGFzZXQgPSB7XHJcbiAgICAgICAgICAgIGRhdGE6IFtdLFxyXG4gICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IFtdLFxyXG4gICAgICAgICAgICBob3ZlckJhY2tncm91bmRDb2xvcjogW11cclxuICAgICAgICB9O1xyXG4gICAgICAgIGRhdGEuZm9yRWFjaCgoaXRlbSwgaSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoQ29uc3RhbnRzLmNvbG9yUGFsZXR0ZVtpXSkge1xyXG4gICAgICAgICAgICAgICAgbGFiZWxzLnB1c2goaXRlbS5sYWJlbCk7XHJcbiAgICAgICAgICAgICAgICBkYXRhc2V0LmRhdGEucHVzaChpdGVtLnZhbHVlKTtcclxuICAgICAgICAgICAgICAgIGRhdGFzZXQuYmFja2dyb3VuZENvbG9yLnB1c2goQ29uc3RhbnRzLmNvbG9yUGFsZXR0ZVtpXS5jb2xvci5iYWNrZ3JvdW5kKTtcclxuICAgICAgICAgICAgICAgIGRhdGFzZXQuaG92ZXJCYWNrZ3JvdW5kQ29sb3IucHVzaChDb25zdGFudHMuY29sb3JQYWxldHRlW2ldLmNvbG9yLmhvdmVyLmJhY2tncm91bmQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xyXG4gICAgICAgIHN0YXRlLkNoYXJ0c1tpZF0gPSBuZXcgQ2hhcnQoY3R4LCB7XHJcbiAgICAgICAgICAgIHR5cGU6ICdkb3VnaG51dCcsXHJcbiAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgIGxhYmVscyxcclxuICAgICAgICAgICAgICAgIGRhdGFzZXRzOiBbZGF0YXNldF1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgb3B0aW9uczoge1xyXG4gICAgICAgICAgICAgICAgYW5pbWF0aW9uOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgYW5pbWF0ZVJvdGF0ZTogZmFsc2VcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICByZXNwb25zaXZlOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGxlZ2VuZDoge1xyXG4gICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHRvb2x0aXBzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZW5hYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tOiBjdXN0b21Ub29sdGlwc1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VIaXN0b2dyYW0ocGxhY2UsIGRhdGEpIHtcclxuICAgICAgICBsZXQgbWF4ID0gbnVsbDtcclxuICAgICAgICBkYXRhLmZvckVhY2goKGJhckRhdGEpID0+IHtcclxuICAgICAgICAgICAgaWYgKGJhckRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGlmIChtYXggPT09IG51bGwgfHwgYmFyRGF0YS52YWx1ZSA+IG1heCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG1heCA9IGJhckRhdGEudmFsdWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBkYXRhLmZvckVhY2goKGJhckRhdGEpID0+IHtcclxuICAgICAgICAgICAgaWYgKGJhckRhdGEpIHtcclxuICAgICAgICAgICAgICAgIC8vIGJhckRhdGEubm9ybVZhbHVlID0gKGJhckRhdGEudmFsdWUgLSBtaW4pLyhtYXgtbWluKTtcclxuICAgICAgICAgICAgICAgIC8vICAgICAgYmFyRGF0YS5ub3JtVmFsdWUgPSAoYmFyRGF0YS52YWx1ZSAtIDApLyhtYXgtMCk7XHJcbiAgICAgICAgICAgICAgICBiYXJEYXRhLm5vcm1WYWx1ZSA9ICgoKGJhckRhdGEudmFsdWUgLSAwKSAvIChtYXggLSAwKSkgKiAwLjkpICsgMC4xO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxldCBkaXY7XHJcbiAgICAgICAgZGF0YS5mb3JFYWNoKChiYXJEYXRhKSA9PiB7XHJcbiAgICAgICAgICAgIGRpdiA9IGJhckRhdGEgPT09IG51bGwgPyBtYWtlRWwoJ2RpdicpIDogYWRkRWwobWFrZUVsKCdkaXYnKSwgbWFrZVRleHQoYmFyRGF0YS52YWx1ZSkpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhkaXYsICdiYXInKTtcclxuICAgICAgICAgICAgaWYgKGJhckRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGRpdi5zdHlsZS5oZWlnaHQgPSBgJHtiYXJEYXRhLm5vcm1WYWx1ZSAqIDEwMH0lYDtcclxuICAgICAgICAgICAgICAgICQoZGl2KS50b29sdGlwKHtcclxuICAgICAgICAgICAgICAgICAgICB0aXRsZTogYmFyRGF0YS50aXAsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgYWRkRWwocGxhY2UsIGRpdik7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlT3ZlcnZpZXdUYWIocmVzdWx0cykge1xyXG4gICAgICAgIGNvbnN0IFttZXRhSW5mbywgc3RhdGlzdGljc10gPSByZXN1bHRzO1xyXG4gICAgICAgIHN0YXRlLm5hbWUudmFsdWUgPSBtZXRhSW5mby5uYW1lO1xyXG4gICAgICAgIHN0YXRlLmRhdGUudmFsdWUgPSBtZXRhSW5mby5kYXRlO1xyXG4gICAgICAgIHN0YXRlLnByZURhdGUudmFsdWUgPSBtZXRhSW5mby5wcmVHYW1lRGF0ZTtcclxuICAgICAgICBzdGF0ZS5kZXNjci52YWx1ZSA9IG1ldGFJbmZvLmRlc2NyaXB0aW9uO1xyXG4gICAgICAgIGFkZEVsKGNsZWFyRWwoc3RhdGUubGFzdFNhdmVUaW1lKSwgbWFrZVRleHQobmV3IERhdGUobWV0YUluZm8uc2F2ZVRpbWUpLmZvcm1hdCgneXl5eS9tbS9kZCBISDpNTTpzcycpKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgc3RhdGlzdGljcy5sYXN0RXZlbnQgPSBzdGF0aXN0aWNzLmxhc3RFdmVudCAhPT0gJycgPyBuZXcgRGF0ZShzdGF0aXN0aWNzLmxhc3RFdmVudCkuZm9ybWF0KCd5eXl5L21tL2RkIGg6TU0nKSA6ICcnO1xyXG4gICAgICAgIHN0YXRpc3RpY3MuZmlyc3RFdmVudCA9IHN0YXRpc3RpY3MuZmlyc3RFdmVudCAhPT0gJycgPyBuZXcgRGF0ZShzdGF0aXN0aWNzLmZpcnN0RXZlbnQpLmZvcm1hdCgneXl5eS9tbS9kZCBoOk1NJykgOiAnJztcclxuICAgICAgICBcclxuICAgICAgICBzdGF0aXN0aWNLZXlzLmZvckVhY2goKGtleSkgPT4ge1xyXG4gICAgICAgICAgICB1cGRhdGVTdGF0aXN0aWNWYWx1ZShzdGF0aXN0aWNzLCBrZXkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGFkZEVsKGNsZWFyRWwoZ2V0RWwoJ2dlbmVyYWxDb21wbGV0ZW5lc3MnKSksIG1ha2VUZXh0KHN0ckZvcm1hdChnZXRMMTBuKCdvdmVydmlldy1nZW5lcmFsLWNvbXBsZXRlbmVzcy12YWx1ZScpLCBzdGF0aXN0aWNzLmdlbmVyYWxDb21wbGV0ZW5lc3MpKSk7XHJcbiAgICAgICAgYWRkRWwoY2xlYXJFbChnZXRFbCgnc3RvcnlDb21wbGV0ZW5lc3MnKSksIG1ha2VUZXh0KHN0ckZvcm1hdChnZXRMMTBuKCdvdmVydmlldy1zdG9yeS1jb21wbGV0ZW5lc3MtdmFsdWUnKSwgc3RhdGlzdGljcy5zdG9yeUNvbXBsZXRlbmVzcykpKTtcclxuICAgICAgICBhZGRFbChjbGVhckVsKGdldEVsKCdyZWxhdGlvbkNvbXBsZXRlbmVzcycpKSwgbWFrZVRleHQoc3RyRm9ybWF0KGdldEwxMG4oJ292ZXJ2aWV3LXJlbGF0aW9uLWNvbXBsZXRlbmVzcy12YWx1ZScpLCBzdGF0aXN0aWNzLnJlbGF0aW9uQ29tcGxldGVuZXNzKSkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGRlZmF1bHRIaXN0cy5mb3JFYWNoKChoaXN0TmFtZSkgPT4ge1xyXG4gICAgICAgICAgICBtYWtlSGlzdG9ncmFtKGNsZWFyRWwocXVlcnlFbChgJHtyb290fS4ke2hpc3ROYW1lfWApKSwgc3RhdGlzdGljc1toaXN0TmFtZV0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGVudGl0eUNoYXJ0cy5mb3JFYWNoKChlbnRpdHlDaGFydCkgPT4ge1xyXG4gICAgICAgICAgICBtYWtlQ2hhcnQoZW50aXR5Q2hhcnQsIHF1ZXJ5RWwoYCR7cm9vdH0uJHtlbnRpdHlDaGFydH1gKSwgc3RhdGlzdGljc1tlbnRpdHlDaGFydF0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IHN5bWJvbENoYXJ0RGF0YSA9IFIudG9QYWlycyhsb2NhbGl6ZUNvbnN0cyhzdGF0aXN0aWNzLnRleHRDaGFyYWN0ZXJzQ291bnQpKS5tYXAocGFpciA9PiAoe1xyXG4gICAgICAgICAgICB2YWx1ZTogcGFpclsxXSxcclxuICAgICAgICAgICAgbGFiZWw6IG1ha2VDaGFydExhYmVsKHN0YXRpc3RpY3MudGV4dENoYXJhY3Rlck51bWJlciwgcGFpclswXSwgcGFpclsxXSlcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgbWFrZUNoYXJ0KCdzeW1ib2xDaGFydCcsIHF1ZXJ5RWwoYCR7cm9vdH0uc3ltYm9sQ2hhcnRgKSwgc3ltYm9sQ2hhcnREYXRhKTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBiaW5kaW5nQ2hhcnREYXRhID0gUi50b1BhaXJzKGxvY2FsaXplQ29uc3RzKHN0YXRpc3RpY3MuYmluZGluZ1N0YXRzKSkubWFwKHBhaXIgPT4gKHtcclxuICAgICAgICAgICAgdmFsdWU6IHBhaXJbMV0sXHJcbiAgICAgICAgICAgIGxhYmVsOiBbcGFpclswXSwgJzogJywgcGFpclsxXV0uam9pbignJylcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgbWFrZUNoYXJ0KCdiaW5kaW5nQ2hhcnQnLCBxdWVyeUVsKGAke3Jvb3R9LmJpbmRpbmdDaGFydGApLCBiaW5kaW5nQ2hhcnREYXRhKTtcclxuICAgICAgICBcclxuICAgICAgICBsZXQgYmFyRGF0YSwgYmFyRGl2LCBiYXI7XHJcbiAgICAgICAgXHJcbiAgICAgICAgZnVuY3Rpb24gbWFrZUNvbnRhaW5lcihvYmopIHtcclxuICAgICAgICAgICAgYmFyRGl2ID0gbWFrZUVsKCdkaXYnKTtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoYmFyRGl2LCAnY29sLXhzLTMnKTtcclxuICAgICAgICAgICAgYWRkRWwoYmFyRGl2LCBhZGRFbChtYWtlRWwoJ2g0JyksIG1ha2VUZXh0KG9iai5uYW1lKSkpO1xyXG4gICAgICAgICAgICBhZGRFbChiYXJEaXYsIG9iai5iYXIpO1xyXG4gICAgICAgICAgICByZXR1cm4gYmFyRGl2O1xyXG4gICAgICAgIH1cclxuICAgICAgICBmdW5jdGlvbiBidWlsZENoYXJ0KGluZm8pIHtcclxuICAgICAgICAgICAgYmFyID0gc2V0QXR0cihzZXRBdHRyKG1ha2VFbCgnY2FudmFzJyksICd3aWR0aCcsICczMDAnKSwgJ2hlaWdodCcsICcxMDAnKTtcclxuICAgICAgICAgICAgY29uc3QgZGF0YSA9IFIuemlwT2JqKFsnbmFtZScsICdiYXInXSwgW2luZm8ubmFtZSwgYmFyXSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IG1ha2VDb250YWluZXIoZGF0YSk7XHJcbiAgICAgICAgICAgIG1ha2VDaGFydChpbmZvLmlkLCBiYXIsIGluZm8ucHJlcGFyZWQpO1xyXG4gICAgICAgICAgICByZXR1cm4gY29udGFpbmVyO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBmdW5jdGlvbiBidWlsZEhpc3QoaW5mbykge1xyXG4gICAgICAgICAgICBiYXIgPSBhZGRDbGFzcyhtYWtlRWwoJ2RpdicpLCAnb3ZlcnZpZXdIaXN0Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBSLnppcE9iaihbJ25hbWUnLCAnYmFyJ10sIFtpbmZvLm5hbWUsIGJhcl0pO1xyXG4gICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBtYWtlQ29udGFpbmVyKGRhdGEpO1xyXG4gICAgICAgICAgICBtYWtlSGlzdG9ncmFtKGJhciwgaW5mby5wcmVwYXJlZCk7XHJcbiAgICAgICAgICAgIHJldHVybiBjb250YWluZXI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IGlubmVyTWFrZUNoYXJ0ID0gUi5jb21wb3NlKGJ1aWxkQ2hhcnQsIHByZXBhcmVDaGFydCk7XHJcbiAgICAgICAgY29uc3QgaW5uZXJNYWtlSGlzdCA9IFIuY29tcG9zZShidWlsZEhpc3QsIHByZXBhcmVIaXN0KTtcclxuICAgICAgICBcclxuICAgICAgICBmdW5jdGlvbiBsb2NhbGl6ZUNoZWNrYm94ZXMoaW5mbykge1xyXG4gICAgICAgICAgICBpbmZvLmRhdGEgPSBSLmZyb21QYWlycyhSLnRvUGFpcnMoaW5mby5kYXRhKS5tYXAoKHZhbCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdmFsWzBdID0gY29uc3RMMTBuKENvbnN0YW50c1t2YWxbMF1dKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWw7XHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgcmV0dXJuIGluZm87XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IG1ha2VDaGVja2JveENoYXJ0ID0gUi5jb21wb3NlKGlubmVyTWFrZUNoYXJ0LCBsb2NhbGl6ZUNoZWNrYm94ZXMpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IGZuID0gUi5jb25kKFtcclxuICAgICAgICAgICAgW1IuY29tcG9zZShSLmVxdWFscygnZW51bScpLCBSLnByb3AoJ3R5cGUnKSksIGlubmVyTWFrZUNoYXJ0XSxcclxuICAgICAgICAgICAgW1IuY29tcG9zZShSLmVxdWFscygnY2hlY2tib3gnKSwgUi5wcm9wKCd0eXBlJykpLCBtYWtlQ2hlY2tib3hDaGFydF0sXHJcbiAgICAgICAgICAgIFtSLlQsIGlubmVyTWFrZUhpc3RdLFxyXG4gICAgICAgICAgICBdKTtcclxuICAgICAgICBcclxuICAgICAgICBzaG93RWwocWUoYCR7cm9vdH0gLmFsZXJ0LmNoYXJhY3RlcmApLCBzdGF0aXN0aWNzLnByb2ZpbGVDaGFydHMuY2hhcmFjdGVyQ2hhcnRzLmxlbmd0aCA9PT0gMCk7XHJcbiAgICAgICAgc3RhdGlzdGljcy5wcm9maWxlQ2hhcnRzLmNoYXJhY3RlckNoYXJ0cy5tYXAoZm4pXHJcbiAgICAgICAgICAgIC5tYXAoYWRkRWwoY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LmNoYXJhY3RlclByb2ZpbGVEaWFncmFtc2ApKSkpO1xyXG4gICAgICAgIHNob3dFbChxZShgJHtyb290fSAuYWxlcnQucGxheWVyYCksIHN0YXRpc3RpY3MucHJvZmlsZUNoYXJ0cy5wbGF5ZXJDaGFydHMubGVuZ3RoID09PSAwKTtcclxuICAgICAgICBzdGF0aXN0aWNzLnByb2ZpbGVDaGFydHMucGxheWVyQ2hhcnRzLm1hcChmbilcclxuICAgICAgICAgICAgLm1hcChhZGRFbChjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0ucGxheWVyUHJvZmlsZURpYWdyYW1zYCkpKSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIGxvY2FsaXplQ29uc3RzKGluZm8pIHtcclxuICAgICAgICBpbmZvID0gUi5mcm9tUGFpcnMoUi50b1BhaXJzKGluZm8pLm1hcCgodmFsKSA9PiB7XHJcbiAgICAgICAgICAgIHZhbFswXSA9IGNvbnN0TDEwbih2YWxbMF0pO1xyXG4gICAgICAgICAgICByZXR1cm4gdmFsO1xyXG4gICAgICAgIH0pKTtcclxuICAgICAgICByZXR1cm4gaW5mbztcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBwcmVwYXJlQ2hhcnQoaW5mbykge1xyXG4gICAgICAgIGNvbnN0IHRvdGFsID0gUi5zdW0oUi52YWx1ZXMoaW5mby5kYXRhKSk7XHJcbiAgICAgICAgaW5mby5wcmVwYXJlZCA9IFIua2V5cyhpbmZvLmRhdGEpLm1hcChrZXkgPT4gUi56aXBPYmooWyd2YWx1ZScsICdsYWJlbCddLCBbaW5mby5kYXRhW2tleV0sIG1ha2VDaGFydExhYmVsKHRvdGFsLCBrZXksIGluZm8uZGF0YVtrZXldKV0pKTtcclxuICAgICAgICByZXR1cm4gaW5mbztcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBwcmVwYXJlSGlzdChpbmZvKSB7XHJcbiAgICAgICAgaW5mby5wcmVwYXJlZCA9IFtdO1xyXG4gICAgICAgIGNvbnN0IHsgc3RlcCB9ID0gaW5mby5kYXRhO1xyXG4gICAgICAgIGluZm8uZGF0YSA9IGluZm8uZGF0YS5ncm91cHM7XHJcbiAgICAgICAgY29uc3QgbWluID0gUi5hcHBseShNYXRoLm1pbiwgUi5rZXlzKGluZm8uZGF0YSkpO1xyXG4gICAgICAgIGNvbnN0IG1heCA9IFIuYXBwbHkoTWF0aC5tYXgsIFIua2V5cyhpbmZvLmRhdGEpKTtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IG1pbjsgaSA8IG1heCArIDE7IGkrKykge1xyXG4gICAgICAgICAgICBpZiAoaW5mby5kYXRhW2ldKSB7XHJcbiAgICAgICAgICAgICAgICBpbmZvLnByZXBhcmVkLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpbmZvLmRhdGFbaV0sXHJcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGAke2kgKiBzdGVwfS0keyhpICogc3RlcCkgKyAoc3RlcCAtIDEpfWAsXHJcbiAgICAgICAgICAgICAgICAgICAgdGlwOiBgJHtpICogc3RlcH0tJHsoaSAqIHN0ZXApICsgKHN0ZXAgLSAxKX1gXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGluZm8ucHJlcGFyZWQucHVzaChudWxsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gaW5mbztcclxuICAgIH1cclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgbWFrZUNoYXJ0TGFiZWwgPSBSLmN1cnJ5KCh0b3RhbCwga2V5LCB2YWx1ZSkgPT5cclxuICAgICAgICBba2V5LCAnOiAnLCAoKHZhbHVlIC8gdG90YWwpICogMTAwKS50b0ZpeGVkKDApLCAnJSAoJywgdmFsdWUsICcvJywgdG90YWwsICcpJ10uam9pbignJykpO1xyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZVN0YXRpc3RpY1ZhbHVlKHN0YXRpc3RpY3MsIGtleSkge1xyXG4gICAgICAgIGFkZEVsKGNsZWFyRWwoZ2V0RWwoa2V5KSksIG1ha2VUZXh0KHN0YXRpc3RpY3Nba2V5XSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZU5hbWUoZXZlbnQpIHtcclxuICAgICAgICBEQk1TLnNldE1ldGFJbmZvU3RyaW5nUG0oJ25hbWUnLCBldmVudC50YXJnZXQudmFsdWUpLmNhdGNoKFV0aWxzLmhhbmRsZUVycm9yKTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZVRpbWUoZHAsIGlucHV0KSB7XHJcbiAgICAgICAgREJNUy5zZXRNZXRhSW5mb0RhdGUoJ2RhdGUnLCBpbnB1dC52YWwoKSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gdXBkYXRlUHJlR2FtZURhdGUoZHAsIGlucHV0KSB7XHJcbiAgICAgICAgREJNUy5zZXRNZXRhSW5mb0RhdGUoJ3ByZUdhbWVEYXRlJywgaW5wdXQudmFsKCksIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZURlc2NyKGV2ZW50KSB7XHJcbiAgICAgICAgREJNUy5zZXRNZXRhSW5mb1N0cmluZygnZGVzY3JpcHRpb24nLCBldmVudC50YXJnZXQudmFsdWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjdXN0b21Ub29sdGlwcyh0b29sdGlwKSB7XHJcbiAgICAgICAgLy8gVG9vbHRpcCBFbGVtZW50XHJcbiAgICAgICAgbGV0IHRvb2x0aXBFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFydGpzLXRvb2x0aXAnKTtcclxuXHJcbiAgICAgICAgaWYgKCF0b29sdGlwRWwpIHtcclxuICAgICAgICAgICAgdG9vbHRpcEVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgICAgIHRvb2x0aXBFbC5pZCA9ICdjaGFydGpzLXRvb2x0aXAnO1xyXG4gICAgICAgICAgICB0b29sdGlwRWwuaW5uZXJIVE1MID0gJzx0YWJsZT48L3RhYmxlPic7XHJcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodG9vbHRpcEVsKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEhpZGUgaWYgbm8gdG9vbHRpcFxyXG4gICAgICAgIGlmICh0b29sdGlwLm9wYWNpdHkgPT09IDApIHtcclxuICAgICAgICAgICAgdG9vbHRpcEVsLnN0eWxlLm9wYWNpdHkgPSAwO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBTZXQgY2FyZXQgUG9zaXRpb25cclxuICAgICAgICB0b29sdGlwRWwuY2xhc3NMaXN0LnJlbW92ZSgnYWJvdmUnLCAnYmVsb3cnLCAnbm8tdHJhbnNmb3JtJyk7XHJcbiAgICAgICAgaWYgKHRvb2x0aXAueUFsaWduKSB7XHJcbiAgICAgICAgICAgIHRvb2x0aXBFbC5jbGFzc0xpc3QuYWRkKHRvb2x0aXAueUFsaWduKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0b29sdGlwRWwuY2xhc3NMaXN0LmFkZCgnbm8tdHJhbnNmb3JtJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiBnZXRCb2R5KGJvZHlJdGVtKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBib2R5SXRlbS5saW5lcztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIFNldCBUZXh0XHJcbiAgICAgICAgaWYgKHRvb2x0aXAuYm9keSkge1xyXG4gICAgICAgICAgICBjb25zdCB0aXRsZUxpbmVzID0gdG9vbHRpcC50aXRsZSB8fCBbXTtcclxuICAgICAgICAgICAgY29uc3QgYm9keUxpbmVzID0gdG9vbHRpcC5ib2R5Lm1hcChnZXRCb2R5KTtcclxuXHJcbiAgICAgICAgICAgIGxldCBpbm5lckh0bWwgPSAnPHRoZWFkPic7XHJcblxyXG4gICAgICAgICAgICB0aXRsZUxpbmVzLmZvckVhY2goKHRpdGxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpbm5lckh0bWwgKz0gYDx0cj48dGg+JHt0aXRsZX08L3RoPjwvdHI+YDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGlubmVySHRtbCArPSAnPC90aGVhZD48dGJvZHk+JztcclxuXHJcbiAgICAgICAgICAgIGJvZHlMaW5lcy5mb3JFYWNoKChib2R5LCBpKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb2xvcnMgPSB0b29sdGlwLmxhYmVsQ29sb3JzW2ldO1xyXG4gICAgICAgICAgICAgICAgbGV0IHN0eWxlID0gYGJhY2tncm91bmQ6JHtjb2xvcnMuYmFja2dyb3VuZENvbG9yfWA7XHJcbiAgICAgICAgICAgICAgICBzdHlsZSArPSBgOyBib3JkZXItY29sb3I6JHtjb2xvcnMuYm9yZGVyQ29sb3J9YDtcclxuICAgICAgICAgICAgICAgIHN0eWxlICs9ICc7IGJvcmRlci13aWR0aDogMnB4JztcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNwYW4gPSBgPHNwYW4gY2xhc3M9XCJjaGFydGpzLXRvb2x0aXAta2V5XCIgc3R5bGU9XCIke3N0eWxlfVwiPjwvc3Bhbj5gO1xyXG4gICAgICAgICAgICAgICAgaW5uZXJIdG1sICs9IGA8dHI+PHRkPiR7c3Bhbn0ke2JvZHl9PC90ZD48L3RyPmA7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBpbm5lckh0bWwgKz0gJzwvdGJvZHk+JztcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHRhYmxlUm9vdCA9IHRvb2x0aXBFbC5xdWVyeVNlbGVjdG9yKCd0YWJsZScpO1xyXG4gICAgICAgICAgICB0YWJsZVJvb3QuaW5uZXJIVE1MID0gaW5uZXJIdG1sO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcG9zaXRpb24gPSB0aGlzLl9jaGFydC5jYW52YXMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcblxyXG4gICAgICAgIC8vICAgICAgICAvLyBEaXNwbGF5LCBwb3NpdGlvbiwgYW5kIHNldCBzdHlsZXMgZm9yIGZvbnRcclxuICAgICAgICB0b29sdGlwRWwuc3R5bGUub3BhY2l0eSA9IDE7XHJcbiAgICAgICAgdG9vbHRpcEVsLnN0eWxlLmxlZnQgPSBgJHtwb3NpdGlvbi5sZWZ0ICsgdG9vbHRpcC5jYXJldFh9cHhgO1xyXG4gICAgICAgIHRvb2x0aXBFbC5zdHlsZS50b3AgPSBgJHtwb3NpdGlvbi50b3AgKyB0b29sdGlwLmNhcmV0WX1weGA7XHJcbiAgICAgICAgLy8gICAgICAgIHRvb2x0aXBFbC5zdHlsZS5mb250RmFtaWx5ID0gdG9vbHRpcC5fZm9udEZhbWlseTtcclxuICAgICAgICAvLyAgICAgICAgdG9vbHRpcEVsLnN0eWxlLmZvbnRTaXplID0gdG9vbHRpcC5mb250U2l6ZTtcclxuICAgICAgICAvLyAgICAgICAgdG9vbHRpcEVsLnN0eWxlLmZvbnRTdHlsZSA9IHRvb2x0aXAuX2ZvbnRTdHlsZTtcclxuICAgICAgICB0b29sdGlwRWwuc3R5bGUucGFkZGluZyA9IGAke3Rvb2x0aXAueVBhZGRpbmd9cHggJHt0b29sdGlwLnhQYWRkaW5nfXB4YDtcclxuICAgIH1cclxufSkodGhpcy5PdmVydmlldyA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgcm9vdCA9ICcucHJvZmlsZS1iaW5kaW5nLXRhYiAnO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5jcmVhdGUtYmluZGluZy1idXR0b25gKSwgJ2NsaWNrJywgY3JlYXRlQmluZGluZyk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0ucmVtb3ZlLWJpbmRpbmctYnV0dG9uYCksICdjbGljaycsIHJlbW92ZUJpbmRpbmcpO1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheSgnY2hhcmFjdGVyJywgZmFsc2UsIChlcnIsIGNoYXJhY3Rlck5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdwbGF5ZXInLCBmYWxzZSwgKGVycjIsIHBsYXllck5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBEQk1TLmdldFByb2ZpbGVCaW5kaW5ncygoZXJyMywgcHJvZmlsZUJpbmRpbmdzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycjMpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMyk7IHJldHVybjsgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBib25kZWRDaGFyYWN0ZXJMaXN0ID0gUi5rZXlzKHByb2ZpbGVCaW5kaW5ncyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYm9uZGVkUGxheWVyTGlzdCA9IFIudmFsdWVzKHByb2ZpbGVCaW5kaW5ncyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyID0gbGlzdCA9PiBSLmNvbXBvc2UoUi5ub3QsIFIuY29udGFpbnMoUi5fXywgbGlzdCksIFIucHJvcCgndmFsdWUnKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGZpbGxTZWxlY3RvcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LmNoYXJhY3Rlci1zZWxlY3RvcmApKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2hhcmFjdGVyTmFtZXMuZmlsdGVyKGZpbHRlcihib25kZWRDaGFyYWN0ZXJMaXN0KSkubWFwKHJlbWFwUHJvcHM0U2VsZWN0KVxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgZmlsbFNlbGVjdG9yKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0ucGxheWVyLXNlbGVjdG9yYCkpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXJOYW1lcy5maWx0ZXIoZmlsdGVyKGJvbmRlZFBsYXllckxpc3QpKS5tYXAocmVtYXBQcm9wczRTZWxlY3QpXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBiaW5kaW5ncyA9IFIudG9QYWlycyhwcm9maWxlQmluZGluZ3MpLm1hcChiaW5kaW5nID0+ICh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IFIuam9pbignLycsIGJpbmRpbmcpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogSlNPTi5zdHJpbmdpZnkoYmluZGluZylcclxuICAgICAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYmluZGluZ3Muc29ydChDb21tb25VdGlscy5jaGFyT3JkQUZhY3RvcnkoUi5wcm9wKCduYW1lJykpKTtcclxuICAgICAgICAgICAgICAgICAgICBmaWxsU2VsZWN0b3IoY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LmJpbmRpbmctc2VsZWN0b3JgKSksIGJpbmRpbmdzKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZygpIHtcclxuICAgICAgICBjb25zdCBjaGFyYWN0ZXJOYW1lID0gcXVlcnlFbChgJHtyb290fS5jaGFyYWN0ZXItc2VsZWN0b3JgKS52YWx1ZTtcclxuICAgICAgICBjb25zdCBwbGF5ZXJOYW1lID0gcXVlcnlFbChgJHtyb290fS5wbGF5ZXItc2VsZWN0b3JgKS52YWx1ZTtcclxuXHJcbiAgICAgICAgaWYgKGNoYXJhY3Rlck5hbWUgPT09ICcnIHx8IHBsYXllck5hbWUgPT09ICcnKSB7XHJcbiAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ2JpbmRpbmctY2hhcmFjdGVyLW9yLXBsYXllci1ub3Qtc2VsZWN0ZWQnKSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIERCTVMuY3JlYXRlQmluZGluZyhjaGFyYWN0ZXJOYW1lLCBwbGF5ZXJOYW1lLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVtb3ZlQmluZGluZygpIHtcclxuICAgICAgICBjb25zdCBiaW5kaW5nVmFsID0gcXVlcnlFbChgJHtyb290fS5iaW5kaW5nLXNlbGVjdG9yYCkudmFsdWU7XHJcblxyXG4gICAgICAgIGlmIChiaW5kaW5nVmFsID09PSAnJykge1xyXG4gICAgICAgICAgICBVdGlscy5hbGVydChnZXRMMTBuKCdiaW5kaW5nLWJpbmRpbmctaXMtbm90LXNlbGVjdGVkJykpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGJpbmRpbmcgPSBKU09OLnBhcnNlKGJpbmRpbmdWYWwpO1xyXG5cclxuICAgICAgICBEQk1TLnJlbW92ZUJpbmRpbmcoYmluZGluZ1swXSwgYmluZGluZ1sxXSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgfVxyXG59KSh0aGlzLlByb2ZpbGVCaW5kaW5nID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuXHJcbi8vIENoYXJhY3RlciBwcm9maWxlIGFscmVhZHkgaGEgZmllbGQgJ25hbWUnXHJcbi8vIEkgaGFkIHNvbWUgY2hvaWNlczpcclxuLy8gMS4gcmVtb3ZlIHRoaXMgZmllbGQgYXQgYWxsXHJcbi8vIDIuIEFkZCBvbmUgbW9yZSBvYmplY3QgdG8gZGl2aWRlIHNwZWNpYWwgdmFsdWVzIChuYW1lKSBhbmQgdXNlciBkZWZpbmVkIHZhbHVlc1xyXG4vLyAzLiBQcm9oaWJpdCB0byBtYWtlIGZpZWxkIC0gbmFtZVxyXG4vLyAxLiBUaGlzIGZpZWxkIGlzIHVzZWQgaW4gbWFueSBwbGFjZXNcclxuLy8gMi4gLSB0b28gY29tcGxleCB3YXlcclxuLy8gMy4gc2ltcGxlIGFuZCBsZXNzZXIgY29tcGxleGl0eSwgSSBjaG9vc2UgdGhpcyB3YXlcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3QgdGFiUm9vdCA9ICcucHJvZmlsZS1jb25maWd1cmVyLXRhYiAnO1xyXG4gICAgY29uc3QgY2hhcmFjdGVyUGFuZWwgPSBgJHt0YWJSb290fS5jaGFyYWN0ZXItcHJvZmlsZS1wYW5lbCBgO1xyXG4gICAgY29uc3QgcGxheWVyUGFuZWwgPSBgJHt0YWJSb290fS5wbGF5ZXItcHJvZmlsZS1wYW5lbCBgO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBzZWwgPSBjbGVhckVsKHF1ZXJ5RWwoYCR7Y2hhcmFjdGVyUGFuZWx9LmNyZWF0ZS1lbnRpdHktdHlwZS1zZWxlY3RgKSk7XHJcbiAgICAgICAgY29uc3QgZmlsbE1haW5TZWwgPSAoKSA9PiB7IGZpbGxJdGVtVHlwZXNTZWwoY2xlYXJFbChzZWwpKTsgfTtcclxuICAgICAgICBmaWxsTWFpblNlbCgpO1xyXG4gICAgICAgIEwxMG4ub25MMTBuQ2hhbmdlKGZpbGxNYWluU2VsKTtcclxuICAgICAgICBjb25zdCBzZWwyID0gY2xlYXJFbChxdWVyeUVsKGAke3BsYXllclBhbmVsfS5jcmVhdGUtZW50aXR5LXR5cGUtc2VsZWN0YCkpO1xyXG4gICAgICAgIGNvbnN0IGZpbGxNYWluU2VsMiA9ICgpID0+IHsgZmlsbEl0ZW1UeXBlc1NlbChjbGVhckVsKHNlbDIpKTsgfTtcclxuICAgICAgICBmaWxsTWFpblNlbDIoKTtcclxuICAgICAgICBMMTBuLm9uTDEwbkNoYW5nZShmaWxsTWFpblNlbDIpO1xyXG5cclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtjaGFyYWN0ZXJQYW5lbH0uY3JlYXRlLWVudGl0eS1idXR0b25gKSwgJ2NsaWNrJywgY3JlYXRlUHJvZmlsZUl0ZW0oJ2NoYXJhY3RlcicsIGNoYXJhY3RlclBhbmVsKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7Y2hhcmFjdGVyUGFuZWx9Lm1vdmUtZW50aXR5LWJ1dHRvbmApLCAnY2xpY2snLCBtb3ZlUHJvZmlsZUl0ZW0oJ2NoYXJhY3RlcicsIGNoYXJhY3RlclBhbmVsKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7Y2hhcmFjdGVyUGFuZWx9LnJlbW92ZS1lbnRpdHktYnV0dG9uYCksICdjbGljaycsIHJlbW92ZVByb2ZpbGVJdGVtKCdjaGFyYWN0ZXInLCBjaGFyYWN0ZXJQYW5lbCkpO1xyXG5cclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtwbGF5ZXJQYW5lbH0uY3JlYXRlLWVudGl0eS1idXR0b25gKSwgJ2NsaWNrJywgY3JlYXRlUHJvZmlsZUl0ZW0oJ3BsYXllcicsIHBsYXllclBhbmVsKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cGxheWVyUGFuZWx9Lm1vdmUtZW50aXR5LWJ1dHRvbmApLCAnY2xpY2snLCBtb3ZlUHJvZmlsZUl0ZW0oJ3BsYXllcicsIHBsYXllclBhbmVsKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cGxheWVyUGFuZWx9LnJlbW92ZS1lbnRpdHktYnV0dG9uYCksICdjbGljaycsIHJlbW92ZVByb2ZpbGVJdGVtKCdwbGF5ZXInLCBwbGF5ZXJQYW5lbCkpO1xyXG5cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHRhYlJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgcmVmcmVzaFBhbmVsKCdjaGFyYWN0ZXInLCBjaGFyYWN0ZXJQYW5lbCk7XHJcbiAgICAgICAgcmVmcmVzaFBhbmVsKCdwbGF5ZXInLCBwbGF5ZXJQYW5lbCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIHJlZnJlc2hQYW5lbCh0eXBlLCByb290KSB7XHJcbiAgICAgICAgREJNUy5nZXRQcm9maWxlU3RydWN0dXJlKHR5cGUsIChlcnIsIGFsbFByb2ZpbGVTZXR0aW5ncykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgYXJyID0gYWxsUHJvZmlsZVNldHRpbmdzLm1hcChSLmNvbXBvc2Uoc3RyRm9ybWF0KGdldEwxMG4oJ2NvbW1vbi1zZXQtaXRlbS1iZWZvcmUnKSksIFIuYXBwZW5kKFIuX18sIFtdKSwgUi5wcm9wKCduYW1lJykpKTtcclxuICAgICAgICAgICAgYXJyLnB1c2goZ2V0TDEwbignY29tbW9uLXNldC1pdGVtLWFzLWxhc3QnKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uU2VsZWN0b3JzID0gW3F1ZXJ5RWwoYCR7cm9vdH0uY3JlYXRlLWVudGl0eS1wb3NpdGlvbi1zZWxlY3RgKSxcclxuICAgICAgICAgICAgICAgIHF1ZXJ5RWwoYCR7cm9vdH0ubW92ZS1lbnRpdHktcG9zaXRpb24tc2VsZWN0YCldO1xyXG4gICAgICAgICAgICBwb3NpdGlvblNlbGVjdG9ycy5tYXAoY2xlYXJFbCkubWFwKGZpbGxTZWxlY3RvcihSLl9fLCBhcnIyU2VsZWN0KGFycikpKS5tYXAoc2V0UHJvcChSLl9fLCAnc2VsZWN0ZWRJbmRleCcsIGFsbFByb2ZpbGVTZXR0aW5ncy5sZW5ndGgpKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHRhYmxlID0gY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LnByb2ZpbGUtY29uZmlnLWNvbnRhaW5lcmApKTtcclxuXHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBhZGRFbHModGFibGUsIGFsbFByb2ZpbGVTZXR0aW5ncy5tYXAoZ2V0SW5wdXQodHlwZSkpKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyMSkge1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMSk7IHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmlzQWRtaW4oKGVycjIsIGlzQWRtaW4pID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIFV0aWxzLmVuYWJsZShleHBvcnRzLmNvbnRlbnQsICdhZG1pbk9ubHknLCBpc0FkbWluKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBzZWxlY3RvckFyciA9IFtxdWVyeUVsKGAke3Jvb3R9Lm1vdmUtZW50aXR5LXNlbGVjdGApLCBxdWVyeUVsKGAke3Jvb3R9LnJlbW92ZS1lbnRpdHktc2VsZWN0YCldO1xyXG4gICAgICAgICAgICBzZWxlY3RvckFyci5tYXAoY2xlYXJFbCkubWFwKGZpbGxTZWxlY3RvcihSLl9fLCBhcnIyU2VsZWN0KGFsbFByb2ZpbGVTZXR0aW5ncy5tYXAoUi5wcm9wKCduYW1lJykpKSkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZVByb2ZpbGVJdGVtKHR5cGUsIHJvb3QpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBpbnB1dCA9IHF1ZXJ5RWwoYCR7cm9vdH0uY3JlYXRlLWVudGl0eS1pbnB1dGApO1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lID0gaW5wdXQudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICBjb25zdCBpdGVtVHlwZSA9IHF1ZXJ5RWwoYCR7cm9vdH0uY3JlYXRlLWVudGl0eS10eXBlLXNlbGVjdGApLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICAgICAgY29uc3QgcG9zaXRpb25TZWxlY3RvciA9IHF1ZXJ5RWwoYCR7cm9vdH0uY3JlYXRlLWVudGl0eS1wb3NpdGlvbi1zZWxlY3RgKTtcclxuXHJcbiAgICAgICAgICAgIERCTVMuY3JlYXRlUHJvZmlsZUl0ZW0odHlwZSwgbmFtZSwgaXRlbVR5cGUsIHBvc2l0aW9uU2VsZWN0b3Iuc2VsZWN0ZWRJbmRleCwgVXRpbHMucHJvY2Vzc0Vycm9yKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbW92ZVByb2ZpbGVJdGVtKHR5cGUsIHJvb3QpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB7IGluZGV4IH0gPSBxdWVyeUVsKGAke3Jvb3R9Lm1vdmUtZW50aXR5LXNlbGVjdGApLnNlbGVjdGVkT3B0aW9uc1swXTtcclxuICAgICAgICAgICAgY29uc3QgbmV3SW5kZXggPSBxdWVyeUVsKGAke3Jvb3R9Lm1vdmUtZW50aXR5LXBvc2l0aW9uLXNlbGVjdGApLnNlbGVjdGVkSW5kZXg7XHJcbiAgICAgICAgICAgIERCTVMubW92ZVByb2ZpbGVJdGVtKHR5cGUsIGluZGV4LCBuZXdJbmRleCwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVtb3ZlUHJvZmlsZUl0ZW0odHlwZSwgcm9vdCkge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdG9yID0gcXVlcnlFbChgJHtyb290fS5yZW1vdmUtZW50aXR5LXNlbGVjdGApO1xyXG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IHNlbGVjdG9yLnNlbGVjdGVkSW5kZXg7XHJcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBzZWxlY3Rvci52YWx1ZTtcclxuXHJcbiAgICAgICAgICAgIFV0aWxzLmNvbmZpcm0oc3RyRm9ybWF0KGdldEwxMG4oJ3Byb2ZpbGVzLWFyZS15b3Utc3VyZS1hYm91dC1yZW1vdmluZy1wcm9maWxlLWl0ZW0nKSwgW25hbWVdKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgREJNUy5yZW1vdmVQcm9maWxlSXRlbSh0eXBlLCBpbmRleCwgbmFtZSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBmaWxsSXRlbVR5cGVzU2VsID0gc2VsID0+IGZpbGxTZWxlY3RvcihzZWwsIGNvbnN0QXJyMlNlbGVjdChSLmtleXMoQ29uc3RhbnRzLnByb2ZpbGVGaWVsZFR5cGVzKSkpO1xyXG4gICAgY29uc3QgZmlsbFBsYXllckFjY2Vzc1NlbCA9IHNlbCA9PiBmaWxsU2VsZWN0b3Ioc2VsLCBjb25zdEFycjJTZWxlY3QoQ29uc3RhbnRzLnBsYXllckFjY2Vzc1R5cGVzKSk7XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIGdldElucHV0ID0gUi5jdXJyeSgodHlwZSwgcHJvZmlsZVNldHRpbmdzLCBpbmRleCkgPT4geyAvLyB0aHJvd3MgSW50ZXJuYWxFcnJvclxyXG4gICAgICAgIGluZGV4Kys7XHJcbiAgICAgICAgY29uc3QgZWxzID0gW107XHJcblxyXG4gICAgICAgIGVscy5wdXNoKGFkZEVsKG1ha2VFbCgnc3BhbicpLCBtYWtlVGV4dChpbmRleCkpKTtcclxuXHJcbiAgICAgICAgbGV0IGlucHV0ID0gc2V0UHJvcHMobWFrZUVsKCdpbnB1dCcpLCB7XHJcbiAgICAgICAgICAgIHZhbHVlOiBwcm9maWxlU2V0dGluZ3MubmFtZSxcclxuICAgICAgICAgICAgaW5mbzogcHJvZmlsZVNldHRpbmdzLm5hbWVcclxuICAgICAgICB9KTtcclxuICAgICAgICBsaXN0ZW4oaW5wdXQsICdjaGFuZ2UnLCByZW5hbWVQcm9maWxlSXRlbSh0eXBlKSk7XHJcbiAgICAgICAgYWRkQ2xhc3MoaW5wdXQsICdpdGVtTmFtZUlucHV0Jyk7XHJcbiAgICAgICAgZWxzLnB1c2goaW5wdXQpO1xyXG5cclxuICAgICAgICBsZXQgc2VsID0gbWFrZUVsKCdzZWxlY3QnKTtcclxuICAgICAgICBmaWxsSXRlbVR5cGVzU2VsKHNlbCk7XHJcbiAgICAgICAgc2V0UHJvcHMoc2VsLCB7XHJcbiAgICAgICAgICAgIHZhbHVlOiBwcm9maWxlU2V0dGluZ3MudHlwZSxcclxuICAgICAgICAgICAgaW5mbzogcHJvZmlsZVNldHRpbmdzLm5hbWUsXHJcbiAgICAgICAgICAgIG9sZFR5cGU6IHByb2ZpbGVTZXR0aW5ncy50eXBlXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGlzdGVuKHNlbCwgJ2NoYW5nZScsIGNoYW5nZVByb2ZpbGVJdGVtVHlwZSh0eXBlKSk7XHJcbiAgICAgICAgZWxzLnB1c2goc2VsKTtcclxuXHJcbiAgICAgICAgc3dpdGNoIChwcm9maWxlU2V0dGluZ3MudHlwZSkge1xyXG4gICAgICAgIGNhc2UgJ3RleHQnOlxyXG4gICAgICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgICAgIGNhc2UgJ211bHRpRW51bSc6XHJcbiAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKCd0ZXh0YXJlYScpO1xyXG4gICAgICAgICAgICBpbnB1dC52YWx1ZSA9IHByb2ZpbGVTZXR0aW5ncy52YWx1ZTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnc3RyaW5nJzpcclxuICAgICAgICAgICAgaW5wdXQgPSBtYWtlRWwoJ2lucHV0Jyk7XHJcbiAgICAgICAgICAgIGlucHV0LnZhbHVlID0gcHJvZmlsZVNldHRpbmdzLnZhbHVlO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgICAgICBpbnB1dCA9IG1ha2VFbCgnaW5wdXQnKTtcclxuICAgICAgICAgICAgaW5wdXQudHlwZSA9ICdudW1iZXInO1xyXG4gICAgICAgICAgICBpbnB1dC52YWx1ZSA9IHByb2ZpbGVTZXR0aW5ncy52YWx1ZTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnY2hlY2tib3gnOlxyXG4gICAgICAgICAgICBpbnB1dCA9IG1ha2VFbCgnaW5wdXQnKTtcclxuICAgICAgICAgICAgaW5wdXQudHlwZSA9ICdjaGVja2JveCc7XHJcbiAgICAgICAgICAgIGlucHV0LmNoZWNrZWQgPSBwcm9maWxlU2V0dGluZ3MudmFsdWU7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcnMuSW50ZXJuYWxFcnJvcignZXJyb3JzLXVuZXhwZWN0ZWQtc3dpdGNoLWFyZ3VtZW50JywgW3Byb2ZpbGVTZXR0aW5ncy50eXBlXSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBzZXRQcm9wcyhpbnB1dCwge1xyXG4gICAgICAgICAgICBpbmZvOiBwcm9maWxlU2V0dGluZ3MubmFtZSxcclxuICAgICAgICAgICAgaW5mb1R5cGU6IHByb2ZpbGVTZXR0aW5ncy50eXBlLFxyXG4gICAgICAgICAgICBvbGRWYWx1ZTogcHJvZmlsZVNldHRpbmdzLnZhbHVlXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgYWRkQ2xhc3MoaW5wdXQsIGBwcm9maWxlLWNvbmZpZ3VyZXItJHtwcm9maWxlU2V0dGluZ3MudHlwZX1gKTtcclxuICAgICAgICBsaXN0ZW4oaW5wdXQsICdjaGFuZ2UnLCB1cGRhdGVEZWZhdWx0VmFsdWUodHlwZSkpO1xyXG4gICAgICAgIGVscy5wdXNoKGlucHV0KTtcclxuXHJcbiAgICAgICAgaW5wdXQgPSBzZXRQcm9wcyhtYWtlRWwoJ2lucHV0JyksIHtcclxuICAgICAgICAgICAgY2hlY2tlZDogcHJvZmlsZVNldHRpbmdzLmRvRXhwb3J0LFxyXG4gICAgICAgICAgICBpbmZvOiBwcm9maWxlU2V0dGluZ3MubmFtZSxcclxuICAgICAgICAgICAgdHlwZTogJ2NoZWNrYm94J1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxpc3RlbihpbnB1dCwgJ2NoYW5nZScsIGRvRXhwb3J0Q2hhbmdlKHR5cGUpKTtcclxuICAgICAgICBlbHMucHVzaChpbnB1dCk7XHJcblxyXG4gICAgICAgIHNlbCA9IG1ha2VFbCgnc2VsZWN0Jyk7XHJcbiAgICAgICAgZmlsbFBsYXllckFjY2Vzc1NlbChzZWwpO1xyXG4gICAgICAgIHNldFByb3BzKHNlbCwge1xyXG4gICAgICAgICAgICB2YWx1ZTogcHJvZmlsZVNldHRpbmdzLnBsYXllckFjY2VzcyxcclxuICAgICAgICAgICAgaW5mbzogcHJvZmlsZVNldHRpbmdzLm5hbWUsXHJcbiAgICAgICAgICAgIG9sZFZhbHVlOiBwcm9maWxlU2V0dGluZ3MucGxheWVyQWNjZXNzLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxpc3RlbihzZWwsICdjaGFuZ2UnLCBjaGFuZ2VQcm9maWxlSXRlbVBsYXllckFjY2Vzcyh0eXBlKSk7XHJcbiAgICAgICAgZWxzLnB1c2goc2VsKTtcclxuXHJcbiAgICAgICAgaW5wdXQgPSBzZXRQcm9wcyhtYWtlRWwoJ2lucHV0JyksIHtcclxuICAgICAgICAgICAgY2hlY2tlZDogcHJvZmlsZVNldHRpbmdzLnNob3dJblJvbGVHcmlkLFxyXG4gICAgICAgICAgICBpbmZvOiBwcm9maWxlU2V0dGluZ3MubmFtZSxcclxuICAgICAgICAgICAgdHlwZTogJ2NoZWNrYm94J1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxpc3RlbihpbnB1dCwgJ2NoYW5nZScsIHNob3dJblJvbGVHcmlkQ2hhbmdlKHR5cGUpKTtcclxuICAgICAgICBlbHMucHVzaChpbnB1dCk7XHJcblxyXG4gICAgICAgIHJldHVybiBhZGRFbHMobWFrZUVsKCd0cicpLCBlbHMubWFwKGVsID0+IGFkZEVsKG1ha2VFbCgndGQnKSwgYWRkQ2xhc3MoZWwsICdhZG1pbk9ubHknKSkpKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZURlZmF1bHRWYWx1ZSh0eXBlKSB7XHJcbiAgICAgICAgcmV0dXJuIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lID0gZXZlbnQudGFyZ2V0LmluZm87XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1UeXBlID0gZXZlbnQudGFyZ2V0LmluZm9UeXBlO1xyXG4gICAgICAgICAgICBjb25zdCB7IG9sZFZhbHVlIH0gPSBldmVudC50YXJnZXQ7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGl0ZW1UeXBlID09PSAnY2hlY2tib3gnID8gZXZlbnQudGFyZ2V0LmNoZWNrZWQgOiBldmVudC50YXJnZXQudmFsdWU7XHJcblxyXG4gICAgICAgICAgICBsZXQgbmV3T3B0aW9ucywgbWlzc2VkVmFsdWVzLCBuZXdWYWx1ZSwgdXBkYXRlRW51bTtcclxuXHJcbiAgICAgICAgICAgIHN3aXRjaCAoaXRlbVR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgICAgIGNhc2UgJ2NoZWNrYm94JzpcclxuICAgICAgICAgICAgICAgIERCTVMudXBkYXRlRGVmYXVsdFZhbHVlKHR5cGUsIG5hbWUsIHZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzpcclxuICAgICAgICAgICAgICAgIGlmIChOdW1iZXIuaXNOYU4odmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbigncHJvZmlsZXMtbm90LWEtbnVtYmVyJykpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC52YWx1ZSA9IG9sZFZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIERCTVMudXBkYXRlRGVmYXVsdFZhbHVlKHR5cGUsIG5hbWUsIE51bWJlcih2YWx1ZSksIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdtdWx0aUVudW0nOlxyXG4gICAgICAgICAgICBjYXNlICdlbnVtJzpcclxuICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gJycgJiYgaXRlbVR5cGUgPT09ICdlbnVtJykge1xyXG4gICAgICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ3Byb2ZpbGVzLWVudW0taXRlbS1jYW50LWJlLWVtcHR5JykpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC52YWx1ZSA9IG9sZFZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIG5ld09wdGlvbnMgPSB2YWx1ZS5zcGxpdCgnLCcpLm1hcChSLnRyaW0pO1xyXG4gICAgICAgICAgICAgICAgbWlzc2VkVmFsdWVzID0gb2xkVmFsdWUudHJpbSgpID09PSAnJyA/IFtdIDogUi5kaWZmZXJlbmNlKG9sZFZhbHVlLnNwbGl0KCcsJyksIG5ld09wdGlvbnMpO1xyXG5cclxuICAgICAgICAgICAgICAgIHVwZGF0ZUVudW0gPSAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3VmFsdWUgPSBuZXdPcHRpb25zLmpvaW4oJywnKTtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC50YXJnZXQudmFsdWUgPSBuZXdWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC50YXJnZXQub2xkVmFsdWUgPSBuZXdWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBEQk1TLnVwZGF0ZURlZmF1bHRWYWx1ZSh0eXBlLCBuYW1lLCBuZXdWYWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAobWlzc2VkVmFsdWVzLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIFV0aWxzLmNvbmZpcm0oc3RyRm9ybWF0KGdldEwxMG4oJ3Byb2ZpbGVzLW5ldy1lbnVtLXZhbHVlcy1yZW1vdmUtc29tZS1vbGQtdmFsdWVzJyksIFttaXNzZWRWYWx1ZXMuam9pbignLCcpXSksIHVwZGF0ZUVudW0sICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LnZhbHVlID0gb2xkVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZUVudW0oKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgVXRpbHMuaGFuZGxlRXJyb3IobmV3IEVycm9ycy5JbnRlcm5hbEVycm9yKCdlcnJvcnMtdW5leHBlY3RlZC1zd2l0Y2gtYXJndW1lbnQnLCBbaXRlbVR5cGVdKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGRvRXhwb3J0Q2hhbmdlKHR5cGUpIHtcclxuICAgICAgICByZXR1cm4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMuZG9FeHBvcnRQcm9maWxlSXRlbUNoYW5nZSh0eXBlLCBldmVudC50YXJnZXQuaW5mbywgZXZlbnQudGFyZ2V0LmNoZWNrZWQsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNob3dJblJvbGVHcmlkQ2hhbmdlKHR5cGUpIHtcclxuICAgICAgICByZXR1cm4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMuc2hvd0luUm9sZUdyaWRQcm9maWxlSXRlbUNoYW5nZSh0eXBlLCBldmVudC50YXJnZXQuaW5mbywgZXZlbnQudGFyZ2V0LmNoZWNrZWQsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlbmFtZVByb2ZpbGVJdGVtKHR5cGUpIHtcclxuICAgICAgICByZXR1cm4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5ld05hbWUgPSBldmVudC50YXJnZXQudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICBjb25zdCBvbGROYW1lID0gZXZlbnQudGFyZ2V0LmluZm87XHJcblxyXG4gICAgICAgICAgICBEQk1TLnJlbmFtZVByb2ZpbGVJdGVtKHR5cGUsIG5ld05hbWUsIG9sZE5hbWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC50YXJnZXQudmFsdWUgPSBldmVudC50YXJnZXQuaW5mbztcclxuICAgICAgICAgICAgICAgICAgICBVdGlscy5oYW5kbGVFcnJvcihlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNoYW5nZVByb2ZpbGVJdGVtVHlwZSh0eXBlKSB7XHJcbiAgICAgICAgcmV0dXJuIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBVdGlscy5jb25maXJtKHN0ckZvcm1hdChnZXRMMTBuKCdwcm9maWxlcy1hcmUteW91LXN1cmUtYWJvdXQtY2hhbmdpbmctcHJvZmlsZS1pdGVtLXR5cGUnKSwgW2V2ZW50LnRhcmdldC5pbmZvXSksICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5ld1R5cGUgPSBldmVudC50YXJnZXQudmFsdWU7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gZXZlbnQudGFyZ2V0LmluZm87XHJcbiAgICAgICAgICAgICAgICBEQk1TLmNoYW5nZVByb2ZpbGVJdGVtVHlwZSh0eXBlLCBuYW1lLCBuZXdUeXBlLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICAgICAgICAgIH0sICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC52YWx1ZSA9IGV2ZW50LnRhcmdldC5vbGRUeXBlO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNoYW5nZVByb2ZpbGVJdGVtUGxheWVyQWNjZXNzKHR5cGUpIHtcclxuICAgICAgICByZXR1cm4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBsYXllckFjY2Vzc1R5cGUgPSBldmVudC50YXJnZXQudmFsdWU7XHJcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBldmVudC50YXJnZXQuaW5mbztcclxuICAgICAgICAgICAgREJNUy5jaGFuZ2VQcm9maWxlSXRlbVBsYXllckFjY2Vzcyh0eXBlLCBuYW1lLCBwbGF5ZXJBY2Nlc3NUeXBlLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LnZhbHVlID0gZXZlbnQudGFyZ2V0Lm9sZFZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIFV0aWxzLnByb2Nlc3NFcnJvcigpKGVycik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbn0pKHRoaXMuUHJvZmlsZUNvbmZpZ3VyZXIgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge1xyXG4gICAgICAgIGNoYXJhY3Rlcjoge30sXHJcbiAgICAgICAgcGxheWVyOiB7fVxyXG4gICAgfTtcclxuICAgIGNvbnN0IHJvb3QgPSAnLnByb2ZpbGUtZWRpdG9yLXRhYiAnO1xyXG4gICAgY29uc3QgY2hhcmFjdGVyU2VsZWN0b3IgPSBgJHtyb290fS5jaGFyYWN0ZXItcHJvZmlsZS1zZWxlY3RvcmA7XHJcbiAgICBjb25zdCBwbGF5ZXJTZWxlY3RvciA9IGAke3Jvb3R9LnBsYXllci1wcm9maWxlLXNlbGVjdG9yYDtcclxuICAgIGNvbnN0IGNoYXJhY3RlclByb2ZpbGVEaXYgPSBgJHtyb290fS5jaGFyYWN0ZXItcHJvZmlsZS1kaXZgO1xyXG4gICAgY29uc3QgcGxheWVyUHJvZmlsZURpdiA9IGAke3Jvb3R9LnBsYXllci1wcm9maWxlLWRpdmA7XHJcbiAgICBjb25zdCBjaGFyYWN0ZXJSZXBvcnREaXYgPSBgJHtyb290fS5jaGFyYWN0ZXItcmVwb3J0LWRpdiB0Ym9keWA7XHJcbiAgICBsZXQgcHJvZmlsZUVkaXRvckNvcmU7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgICQoY2hhcmFjdGVyU2VsZWN0b3IpLnNlbGVjdDIoKS5vbignc2VsZWN0MjpzZWxlY3QnLCBzaG93UHJvZmlsZUluZm9EZWxlZ2F0ZTIoJ2NoYXJhY3RlcicpKTtcclxuICAgICAgICAkKHBsYXllclNlbGVjdG9yKS5zZWxlY3QyKCkub24oJ3NlbGVjdDI6c2VsZWN0Jywgc2hvd1Byb2ZpbGVJbmZvRGVsZWdhdGUyKCdwbGF5ZXInKSk7XHJcbiAgICAgICAgcHJvZmlsZUVkaXRvckNvcmUgPSBQcm9maWxlRWRpdG9yQ29yZS5tYWtlUHJvZmlsZUVkaXRvckNvcmUoKTtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgY2xlYXJFbChxdWVyeUVsKGNoYXJhY3RlclJlcG9ydERpdikpO1xyXG4gICAgICAgIHJlZnJlc2hQYW5lbCgnY2hhcmFjdGVyJywgY2hhcmFjdGVyU2VsZWN0b3IsIGNoYXJhY3RlclByb2ZpbGVEaXYsICgpID0+IHtcclxuICAgICAgICAgICAgcmVmcmVzaFBhbmVsKCdwbGF5ZXInLCBwbGF5ZXJTZWxlY3RvciwgcGxheWVyUHJvZmlsZURpdiwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgYXBwbHlTZXR0aW5ncygnY2hhcmFjdGVyJywgY2hhcmFjdGVyU2VsZWN0b3IsIGNoYXJhY3RlclByb2ZpbGVEaXYpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gcmVmcmVzaFBhbmVsKHR5cGUsIHNlbGVjdG9yLCBwcm9maWxlRGl2LCBjYWxsYmFjaykge1xyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KHR5cGUsIGZhbHNlLCAoZXJyLCBuYW1lcykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG5cclxuICAgICAgICAgICAgbmFtZXMucHVzaCh7IGRpc3BsYXlOYW1lOiAnJywgdmFsdWU6ICcnLCBlZGl0YWJsZTogZmFsc2UgfSk7XHJcblxyXG4gICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoc2VsZWN0b3IpKTtcclxuICAgICAgICAgICAgJChzZWxlY3Rvcikuc2VsZWN0MihnZXRTZWxlY3QyRGF0YShuYW1lcykpO1xyXG4gICAgICAgICAgICBzdGF0ZVt0eXBlXS5uYW1lcyA9IG5hbWVzO1xyXG5cclxuICAgICAgICAgICAgREJNUy5nZXRQcm9maWxlU3RydWN0dXJlKHR5cGUsIChlcnIyLCBhbGxQcm9maWxlU2V0dGluZ3MpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIHByb2ZpbGVFZGl0b3JDb3JlLmluaXRQcm9maWxlU3RydWN0dXJlKHByb2ZpbGVEaXYsIHR5cGUsIGFsbFByb2ZpbGVTZXR0aW5ncywgY2FsbGJhY2spO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBhcHBseVNldHRpbmdzKHR5cGUsIHNlbGVjdG9yLCBwcm9maWxlRGl2KSB7XHJcbiAgICAgICAgY29uc3QgeyBuYW1lcyB9ID0gc3RhdGVbdHlwZV07XHJcbiAgICAgICAgaWYgKG5hbWVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgY29uc3QgbmFtZSA9IG5hbWVzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICBjb25zdCBzZXR0aW5ncyA9IERCTVMuZ2V0U2V0dGluZ3MoKTtcclxuICAgICAgICAgICAgaWYgKCFzZXR0aW5ncy5Qcm9maWxlRWRpdG9yKSB7XHJcbiAgICAgICAgICAgICAgICBzZXR0aW5ncy5Qcm9maWxlRWRpdG9yID0ge307XHJcbiAgICAgICAgICAgICAgICBzZXR0aW5ncy5Qcm9maWxlRWRpdG9yW3R5cGVdID0gbmFtZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgcHJvZmlsZU5hbWUgPSBzZXR0aW5ncy5Qcm9maWxlRWRpdG9yW3R5cGVdO1xyXG4gICAgICAgICAgICBpZiAobmFtZXMubWFwKG5hbWVJbmZvID0+IG5hbWVJbmZvLnZhbHVlKS5pbmRleE9mKHByb2ZpbGVOYW1lKSA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIHNldHRpbmdzLlByb2ZpbGVFZGl0b3JbdHlwZV0gPSBuYW1lO1xyXG4gICAgICAgICAgICAgICAgcHJvZmlsZU5hbWUgPSBuYW1lO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHNob3dQcm9maWxlSW5mb0RlbGVnYXRlMih0eXBlKSh7IHRhcmdldDogeyB2YWx1ZTogcHJvZmlsZU5hbWUgfSB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2VsZWN0UHJvZmlsZXMoY2hhck5hbWUsIHBsYXllck5hbWUpIHtcclxuICAgICAgICBzaG93UHJvZmlsZUluZm9EZWxlZ2F0ZSgnY2hhcmFjdGVyJywgY2hhcmFjdGVyUHJvZmlsZURpdiwgY2hhck5hbWUpO1xyXG4gICAgICAgIHNob3dQcm9maWxlSW5mb0RlbGVnYXRlKCdwbGF5ZXInLCBwbGF5ZXJQcm9maWxlRGl2LCBwbGF5ZXJOYW1lKTtcclxuICAgICAgICAkKGNoYXJhY3RlclNlbGVjdG9yKS5zZWxlY3QyKCkudmFsKGNoYXJOYW1lKS50cmlnZ2VyKCdjaGFuZ2UnKTtcclxuICAgICAgICAkKHBsYXllclNlbGVjdG9yKS5zZWxlY3QyKCkudmFsKHBsYXllck5hbWUpLnRyaWdnZXIoJ2NoYW5nZScpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNob3dQcm9maWxlSW5mb0RlbGVnYXRlMih0eXBlKSB7XHJcbiAgICAgICAgcmV0dXJuIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lID0gZXZlbnQudGFyZ2V0LnZhbHVlLnRyaW0oKTtcclxuICAgICAgICAgICAgaWYgKG5hbWUgPT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxlY3RQcm9maWxlcygnJywgJycpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIERCTVMuZ2V0UHJvZmlsZUJpbmRpbmcodHlwZSwgbmFtZSwgKGVyciwgYmluZGluZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIHNlbGVjdFByb2ZpbGVzKGJpbmRpbmdbMF0sIGJpbmRpbmdbMV0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNob3dQcm9maWxlSW5mb0RlbGVnYXRlKHR5cGUsIHByb2ZpbGVEaXYsIG5hbWUpIHtcclxuICAgICAgICB1cGRhdGVTZXR0aW5ncyh0eXBlLCBuYW1lKTtcclxuICAgICAgICBpZiAobmFtZSA9PT0gJycpIHtcclxuICAgICAgICAgICAgYWRkQ2xhc3MocXVlcnlFbChwcm9maWxlRGl2KSwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2NoYXJhY3RlcicpIHtcclxuICAgICAgICAgICAgICAgIGFkZENsYXNzKHF1ZXJ5RWwoY2hhcmFjdGVyUmVwb3J0RGl2KSwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgREJNUy5nZXRQcm9maWxlKHR5cGUsIG5hbWUsIChlcnIsIHByb2ZpbGUpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmlzRW50aXR5RWRpdGFibGUodHlwZSwgbmFtZSwgKGVycjIsIGlzQ2hhcmFjdGVyRWRpdGFibGUpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIHByb2ZpbGVFZGl0b3JDb3JlLmZpbGxQcm9maWxlSW5mb3JtYXRpb24ocHJvZmlsZURpdiwgdHlwZSwgcHJvZmlsZSwgKCkgPT4gaXNDaGFyYWN0ZXJFZGl0YWJsZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdjaGFyYWN0ZXInKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgREJNUy5nZXRDaGFyYWN0ZXJSZXBvcnQobmFtZSwgKGVycjMsIGNoYXJhY3RlclJlcG9ydCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKHF1ZXJ5RWwoY2hhcmFjdGVyUmVwb3J0RGl2KSwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhZGRFbHMoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoY2hhcmFjdGVyUmVwb3J0RGl2KSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFyYWN0ZXJSZXBvcnQubWFwKENoYXJhY3RlclJlcG9ydHMubWFrZVN0b3J5UmVwb3J0Um93KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVTZXR0aW5ncyh0eXBlLCBuYW1lKSB7XHJcbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSBEQk1TLmdldFNldHRpbmdzKCk7XHJcbiAgICAgICAgc2V0dGluZ3MuUHJvZmlsZUVkaXRvclt0eXBlXSA9IG5hbWU7XHJcbiAgICB9XHJcbn0pKHRoaXMuUHJvZmlsZUVkaXRvciA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbi8qIGVzbGludC1kaXNhYmxlIGZ1bmMtbmFtZXMgKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgZXhwb3J0cy5tYWtlUHJvZmlsZUVkaXRvckNvcmUgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgaW5uZXJFeHBvcnRzID0ge307XHJcblxyXG4gICAgICAgIGNvbnN0IHJvb3QgPSAnLnByb2ZpbGUtZWRpdG9yLWNvcmUtdG1wbCc7XHJcblxyXG4gICAgICAgIGNvbnN0IHN0YXRlID0ge1xyXG4gICAgICAgICAgICBjaGFyYWN0ZXI6IHt9LFxyXG4gICAgICAgICAgICBwbGF5ZXI6IHt9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaW5uZXJFeHBvcnRzLmluaXRQcm9maWxlU3RydWN0dXJlID0gKHByb2ZpbGVEaXYsIHR5cGUsIHByb2ZpbGVTdHJ1Y3R1cmUsIGNhbGxiYWNrKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHF0ZShgJHtyb290fSAucHJvZmlsZS1lZGl0b3ItY29udGFpbmVyLXRtcGxgKTtcclxuICAgICAgICAgICAgYWRkRWwoY2xlYXJFbChxdWVyeUVsKHByb2ZpbGVEaXYpKSwgY29udGFpbmVyKTtcclxuICAgICAgICAgICAgc3RhdGVbdHlwZV0uaW5wdXRJdGVtcyA9IHt9O1xyXG4gICAgICAgICAgICBzdGF0ZVt0eXBlXS5wcm9maWxlU3RydWN0dXJlID0gcHJvZmlsZVN0cnVjdHVyZTtcclxuXHJcbiAgICAgICAgICAgIGlmKHByb2ZpbGVTdHJ1Y3R1cmUubGVuZ3RoID09PSAwKXtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFsZXJ0ID0gcW10ZSgnLmFsZXJ0LWJsb2NrLXRtcGwnKTtcclxuICAgICAgICAgICAgICAgIGFkZEVsKGFsZXJ0LCBtYWtlVGV4dChMMTBuLmdldCgnYWR2aWNlcycsIGBlbXB0eS0ke3R5cGV9LXByb2ZpbGUtc3RydWN0dXJlYCkpKTtcclxuICAgICAgICAgICAgICAgIGFkZEVsKHF1ZXJ5RWwocHJvZmlsZURpdiksIGFsZXJ0KTtcclxuICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgYWRkRWxzKHFlZShxdWVyeUVsKHByb2ZpbGVEaXYpLCAnLmluc2VydGlvbi1wb2ludCcpLCBwcm9maWxlU3RydWN0dXJlLm1hcChhcHBlbmRJbnB1dCh0eXBlKSkpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjaygpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgICAgICB2YXIgYXBwZW5kSW5wdXQgPSBSLmN1cnJ5KCh0eXBlLCBwcm9maWxlSXRlbUNvbmZpZykgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBpdGVtSW5wdXQgPSBuZXcgUHJvZmlsZUl0ZW1JbnB1dCh0eXBlLCBwcm9maWxlSXRlbUNvbmZpZyk7XHJcbiAgICAgICAgICAgIHN0YXRlW3R5cGVdLmlucHV0SXRlbXNbcHJvZmlsZUl0ZW1Db25maWcubmFtZV0gPSBpdGVtSW5wdXQ7XHJcbiAgICAgICAgICAgIGNvbnN0IHJvdyA9IHF0ZShgJHtyb290fSAucHJvZmlsZS1lZGl0b3Itcm93LXRtcGxgKTtcclxuICAgICAgICAgICAgYWRkRWwocWVlKHJvdywgJy5wcm9maWxlLWl0ZW0tbmFtZScpLCBtYWtlVGV4dChwcm9maWxlSXRlbUNvbmZpZy5uYW1lKSk7XHJcbiAgICAgICAgICAgIGFkZEVsKHFlZShyb3csICcucHJvZmlsZS1pdGVtLWlucHV0JyksIGl0ZW1JbnB1dC5kb20pO1xyXG4gICAgICAgICAgICByZXR1cm4gcm93O1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpbm5lckV4cG9ydHMuZmlsbFByb2ZpbGVJbmZvcm1hdGlvbiA9IChwcm9maWxlRGl2LCB0eXBlLCBwcm9maWxlLCBpc0VkaXRhYmxlKSA9PiB7XHJcbiAgICAgICAgICAgIHJlbW92ZUNsYXNzKHF1ZXJ5RWwocHJvZmlsZURpdiksICdoaWRkZW4nKTtcclxuICAgICAgICAgICAgUi52YWx1ZXMoc3RhdGVbdHlwZV0uaW5wdXRJdGVtcykuZm9yRWFjaCgoaXRlbUlucHV0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXRlbUlucHV0LnR5cGUgPT09ICdtdWx0aUVudW0nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaXRlbUlucHV0Lm11bHRpRW51bVNlbGVjdC5wcm9wKCdkaXNhYmxlZCcsICFpc0VkaXRhYmxlKGl0ZW1JbnB1dC5uYW1lLCBzdGF0ZVt0eXBlXS5wcm9maWxlU3RydWN0dXJlKSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKGl0ZW1JbnB1dC5kb20sIGlzRWRpdGFibGUoaXRlbUlucHV0Lm5hbWUsIHN0YXRlW3R5cGVdLnByb2ZpbGVTdHJ1Y3R1cmUpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBzdGF0ZVt0eXBlXS5uYW1lID0gcHJvZmlsZS5uYW1lO1xyXG4gICAgICAgICAgICBPYmplY3QudmFsdWVzKHN0YXRlW3R5cGVdLmlucHV0SXRlbXMpLmZvckVhY2goKGl0ZW0pID0+IHtcclxuICAgICAgICAgICAgICAgIGl0ZW0uc2hvd0ZpZWxkVmFsdWUocHJvZmlsZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIFByb2ZpbGVJdGVtSW5wdXQocHJvZmlsZVR5cGUsIHByb2ZpbGVJdGVtQ29uZmlnKSB7XHJcbiAgICAgICAgICAgIGxldCBpbnB1dCwgc2VsO1xyXG4gICAgICAgICAgICBzd2l0Y2ggKHByb2ZpbGVJdGVtQ29uZmlnLnR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgICAgICAgICBpbnB1dCA9IG1ha2VFbCgndGV4dGFyZWEnKTtcclxuICAgICAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCAncHJvZmlsZVRleHRJbnB1dCcpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgICAgICAgICBpbnB1dCA9IG1ha2VFbCgnaW5wdXQnKTtcclxuICAgICAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCAncHJvZmlsZVN0cmluZ0lucHV0Jyk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnZW51bSc6XHJcbiAgICAgICAgICAgICAgICBpbnB1dCA9IG1ha2VFbCgnc2VsZWN0Jyk7XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ3Byb2ZpbGVTZWxlY3RJbnB1dCcpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdG9OYW1lT2JqID0gUi5jb21wb3NlKFIuemlwT2JqKFsnbmFtZSddKSwgUi5hcHBlbmQoUi5fXywgW10pKTtcclxuICAgICAgICAgICAgICAgIGZpbGxTZWxlY3RvcihpbnB1dCwgUi5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBLCBwcm9maWxlSXRlbUNvbmZpZy52YWx1ZS5zcGxpdCgnLCcpKS5tYXAodG9OYW1lT2JqKSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzpcclxuICAgICAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKCdpbnB1dCcpO1xyXG4gICAgICAgICAgICAgICAgaW5wdXQudHlwZSA9ICdudW1iZXInO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2NoZWNrYm94JzpcclxuICAgICAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKCdpbnB1dCcpO1xyXG4gICAgICAgICAgICAgICAgaW5wdXQudHlwZSA9ICdjaGVja2JveCc7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnbXVsdGlFbnVtJzpcclxuICAgICAgICAgICAgICAgIHRoaXMubXVsdGlFbnVtU2VsZWN0ID0gJCgnPHNlbGVjdD48L3NlbGVjdD4nKTtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIodGhpcy5tdWx0aUVudW1TZWxlY3RbMF0sICdzdHlsZScsICd3aWR0aDogMTAwJTsnKTtcclxuICAgICAgICAgICAgICAgIGFkZENsYXNzKHRoaXMubXVsdGlFbnVtU2VsZWN0WzBdLCAnY29tbW9uLXNlbGVjdCcpO1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3ModGhpcy5tdWx0aUVudW1TZWxlY3RbMF0sICdwcm9maWxlU3RyaW5nSW5wdXQnKTtcclxuICAgICAgICAgICAgICAgIFtpbnB1dF0gPSAkKCc8c3Bhbj48L3NwYW4+JykuYXBwZW5kKHRoaXMubXVsdGlFbnVtU2VsZWN0KTtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIodGhpcy5tdWx0aUVudW1TZWxlY3RbMF0sICdtdWx0aXBsZScsICdtdWx0aXBsZScpO1xyXG5cclxuICAgICAgICAgICAgICAgIHNlbCA9IHRoaXMubXVsdGlFbnVtU2VsZWN0LnNlbGVjdDIoYXJyMlNlbGVjdDIoUi5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBLCBwcm9maWxlSXRlbUNvbmZpZy52YWx1ZS5zcGxpdCgnLCcpKSkpO1xyXG4gICAgICAgICAgICAgICAgc2VsLm9uKCdjaGFuZ2UnLCB0aGlzLnVwZGF0ZUZpZWxkVmFsdWUuYmluZCh0aGlzKSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcnMuSW50ZXJuYWxFcnJvcignZXJyb3JzLXVuZXhwZWN0ZWQtc3dpdGNoLWFyZ3VtZW50JywgW3Byb2ZpbGVJdGVtQ29uZmlnLnR5cGVdKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHByb2ZpbGVJdGVtQ29uZmlnLnR5cGUgIT09ICdtdWx0aUVudW0nKSB7XHJcbiAgICAgICAgICAgICAgICBsaXN0ZW4oaW5wdXQsICdjaGFuZ2UnLCB0aGlzLnVwZGF0ZUZpZWxkVmFsdWUuYmluZCh0aGlzKSk7XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ2Zvcm0tY29udHJvbCcpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRvbSA9IGlucHV0O1xyXG4gICAgICAgICAgICB0aGlzLnR5cGUgPSBwcm9maWxlSXRlbUNvbmZpZy50eXBlO1xyXG4gICAgICAgICAgICB0aGlzLnByb2ZpbGVUeXBlID0gcHJvZmlsZVR5cGU7XHJcbiAgICAgICAgICAgIHRoaXMubmFtZSA9IHByb2ZpbGVJdGVtQ29uZmlnLm5hbWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBQcm9maWxlSXRlbUlucHV0LnByb3RvdHlwZS5zaG93RmllbGRWYWx1ZSA9IGZ1bmN0aW9uIChwcm9maWxlKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnR5cGUgPT09ICdjaGVja2JveCcpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZG9tLmNoZWNrZWQgPSBwcm9maWxlW3RoaXMubmFtZV07XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50eXBlID09PSAnbXVsdGlFbnVtJykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tdWx0aUVudW1TZWxlY3QudmFsKHByb2ZpbGVbdGhpcy5uYW1lXSA9PT0gJycgPyBudWxsIDogcHJvZmlsZVt0aGlzLm5hbWVdLnNwbGl0KCcsJykpLnRyaWdnZXIoJ2NoYW5nZScpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kb20udmFsdWUgPSBwcm9maWxlW3RoaXMubmFtZV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5vbGRWYWx1ZSA9IHByb2ZpbGVbdGhpcy5uYW1lXTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBQcm9maWxlSXRlbUlucHV0LnByb3RvdHlwZS51cGRhdGVGaWVsZFZhbHVlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpZWxkTmFtZSA9IHRoaXMubmFtZTtcclxuICAgICAgICAgICAgY29uc3QgcHJvZmlsZU5hbWUgPSBzdGF0ZVt0aGlzLnByb2ZpbGVUeXBlXS5uYW1lO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5tdWx0aUVudW1TZWxlY3QgJiYgdGhpcy5tdWx0aUVudW1TZWxlY3QucHJvcCgnZGlzYWJsZWQnKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuOyAvLyB3ZSBuZWVkIHRvIHRyaWdnZXIgY2hhbmdlIGV2ZW50IG9uIG11bHRpRW51bVNlbGVjdCB0byB1cGRhdGUgc2VsZWN0aW9uLlxyXG4gICAgICAgICAgICAgICAgLy8gSXQgbWF5IGJlIGRpc2FibGVkIHNvIGl0IGhhcyBmYWxzZSBwb3NpdGl2ZSBjYWxsLlxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgdmFsdWUsIHZhbDtcclxuICAgICAgICAgICAgc3dpdGNoICh0aGlzLnR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgICAgICAgICAgICAgdmFsID0gdGhpcy5kb20udmFsdWU7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbDtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgICAgICAgICAgaWYgKE51bWJlci5pc05hTih0aGlzLmRvbS52YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBVdGlscy5hbGVydChnZXRMMTBuKCdwcm9maWxlcy1ub3QtYS1udW1iZXInKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kb20udmFsdWUgPSB0aGlzLm9sZFZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHZhbHVlID0gTnVtYmVyKHRoaXMuZG9tLnZhbHVlKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdjaGVja2JveCc6XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHRoaXMuZG9tLmNoZWNrZWQ7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnbXVsdGlFbnVtJzpcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gdGhpcy5tdWx0aUVudW1TZWxlY3QudmFsKCkuam9pbignLCcpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICBVdGlscy5oYW5kbGVFcnJvcihuZXcgRXJyb3JzLkludGVybmFsRXJyb3IoJ2Vycm9ycy11bmV4cGVjdGVkLXN3aXRjaC1hcmd1bWVudCcsIFt0aGlzLnR5cGVdKSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgREJNUy51cGRhdGVQcm9maWxlRmllbGQodGhpcy5wcm9maWxlVHlwZSwgcHJvZmlsZU5hbWUsIGZpZWxkTmFtZSwgdGhpcy50eXBlLCB2YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHJldHVybiBpbm5lckV4cG9ydHM7XHJcbiAgICB9O1xyXG59KSh0aGlzLlByb2ZpbGVFZGl0b3JDb3JlID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBQcm9maWxlRWRpdG9yLCBQcm9maWxlQ29uZmlndXJlciwgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuICAgIGNvbnN0IHRhYlJvb3QgPSAnLnByb2ZpbGVzLXRhYiAnO1xyXG4gICAgY29uc3QgY2hhcmFjdGVyUm9vdCA9IGAke3RhYlJvb3R9LmNoYXJhY3Rlci1wcm9maWxlLXBhbmVsIGA7XHJcbiAgICBjb25zdCBwbGF5ZXJSb290ID0gYCR7dGFiUm9vdH0ucGxheWVyLXByb2ZpbGUtcGFuZWwgYDtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgc3RhdGUudmlld3MgPSB7fTtcclxuICAgICAgICBjb25zdCBuYXYgPSBgJHt0YWJSb290fS5zdWItdGFiLW5hdmlnYXRpb25gO1xyXG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPSBgJHt0YWJSb290fS5zdWItdGFiLWNvbnRlbnRgO1xyXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lcnMgPSB7XHJcbiAgICAgICAgICAgIHJvb3Q6IHN0YXRlLFxyXG4gICAgICAgICAgICBuYXZpZ2F0aW9uOiBxdWVyeUVsKG5hdiksXHJcbiAgICAgICAgICAgIGNvbnRlbnQ6IHF1ZXJ5RWwoY29udGVudClcclxuICAgICAgICB9O1xyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgJ3Byb2ZpbGUtZWRpdG9yJywgUHJvZmlsZUVkaXRvciwgeyBtYWluUGFnZTogdHJ1ZSB9KTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsICdwcm9maWxlLWNvbnN0cnVjdG9yJywgUHJvZmlsZUNvbmZpZ3VyZXIpO1xyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgJ3Byb2ZpbGUtYmluZGluZycsIFByb2ZpbGVCaW5kaW5nKTtcclxuXHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7Y2hhcmFjdGVyUm9vdH0uY3JlYXRlLWVudGl0eS1idXR0b25gKSwgJ2NsaWNrJywgY3JlYXRlUHJvZmlsZSgnY2hhcmFjdGVyJywgY2hhcmFjdGVyUm9vdCkpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke2NoYXJhY3RlclJvb3R9LnJlbmFtZS1lbnRpdHktYnV0dG9uYCksICdjbGljaycsIHJlbmFtZVByb2ZpbGUoJ2NoYXJhY3RlcicsIGNoYXJhY3RlclJvb3QpKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtjaGFyYWN0ZXJSb290fS5yZW1vdmUtZW50aXR5LWJ1dHRvbmApLCAnY2xpY2snLCByZW1vdmVQcm9maWxlKCdjaGFyYWN0ZXInLCBjaGFyYWN0ZXJSb290KSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3BsYXllclJvb3R9LmNyZWF0ZS1lbnRpdHktYnV0dG9uYCksICdjbGljaycsIGNyZWF0ZVByb2ZpbGUoJ3BsYXllcicsIHBsYXllclJvb3QpKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtwbGF5ZXJSb290fS5yZW5hbWUtZW50aXR5LWJ1dHRvbmApLCAnY2xpY2snLCByZW5hbWVQcm9maWxlKCdwbGF5ZXInLCBwbGF5ZXJSb290KSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cGxheWVyUm9vdH0ucmVtb3ZlLWVudGl0eS1idXR0b25gKSwgJ2NsaWNrJywgcmVtb3ZlUHJvZmlsZSgncGxheWVyJywgcGxheWVyUm9vdCkpO1xyXG5cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHRhYlJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2NoYXJhY3RlcicsIHRydWUsIChlcnIsIGNoYXJhY3Rlck5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdwbGF5ZXInLCB0cnVlLCAoZXJyMiwgcGxheWVyTmFtZXMpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIHJlYnVpbGRJbnRlcmZhY2UoY2hhcmFjdGVyUm9vdCwgY2hhcmFjdGVyTmFtZXMpO1xyXG4gICAgICAgICAgICAgICAgcmVidWlsZEludGVyZmFjZShwbGF5ZXJSb290LCBwbGF5ZXJOYW1lcyk7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiByZWJ1aWxkSW50ZXJmYWNlKHJvb3QsIG5hbWVzKSB7XHJcbiAgICAgICAgY29uc3QgZGF0YSA9IGdldFNlbGVjdDJEYXRhKG5hbWVzKTtcclxuXHJcbiAgICAgICAgY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LnJlbmFtZS1lbnRpdHktc2VsZWN0YCkpO1xyXG4gICAgICAgICQoYCR7cm9vdH0ucmVuYW1lLWVudGl0eS1zZWxlY3RgKS5zZWxlY3QyKGRhdGEpO1xyXG5cclxuICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0ucmVtb3ZlLWVudGl0eS1zZWxlY3RgKSk7XHJcbiAgICAgICAgJChgJHtyb290fS5yZW1vdmUtZW50aXR5LXNlbGVjdGApLnNlbGVjdDIoZGF0YSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY3JlYXRlUHJvZmlsZSh0eXBlLCByb290KSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaW5wdXQgPSBxdWVyeUVsKGAke3Jvb3R9LmNyZWF0ZS1lbnRpdHktaW5wdXRgKTtcclxuICAgICAgICAgICAgY29uc3QgbmFtZSA9IGlucHV0LnZhbHVlLnRyaW0oKTtcclxuXHJcbiAgICAgICAgICAgIERCTVMuY3JlYXRlUHJvZmlsZSh0eXBlLCBuYW1lLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLnJlZnJlc2goKGVycjIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmN1cnJlbnRWaWV3LnVwZGF0ZVNldHRpbmdzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmN1cnJlbnRWaWV3LnVwZGF0ZVNldHRpbmdzKG5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVuYW1lUHJvZmlsZSh0eXBlLCByb290KSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdG9JbnB1dCA9IHF1ZXJ5RWwoYCR7cm9vdH0ucmVuYW1lLWVudGl0eS1pbnB1dGApO1xyXG4gICAgICAgICAgICBjb25zdCBmcm9tTmFtZSA9IHF1ZXJ5RWwoYCR7cm9vdH0ucmVuYW1lLWVudGl0eS1zZWxlY3RgKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHRvTmFtZSA9IHRvSW5wdXQudmFsdWUudHJpbSgpO1xyXG5cclxuICAgICAgICAgICAgREJNUy5yZW5hbWVQcm9maWxlKHR5cGUsIGZyb21OYW1lLCB0b05hbWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIucmVmcmVzaCgoZXJyMikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICB0b0lucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmN1cnJlbnRWaWV3LnVwZGF0ZVNldHRpbmdzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmN1cnJlbnRWaWV3LnVwZGF0ZVNldHRpbmdzKHR5cGUsIHRvTmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVtb3ZlUHJvZmlsZSh0eXBlLCByb290KSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbmFtZSA9IHF1ZXJ5RWwoYCR7cm9vdH0ucmVtb3ZlLWVudGl0eS1zZWxlY3RgKS52YWx1ZS50cmltKCk7XHJcblxyXG4gICAgICAgICAgICBVdGlscy5jb25maXJtKHN0ckZvcm1hdChnZXRMMTBuKCdwcm9maWxlcy1hcmUteW91LXN1cmUtYWJvdXQtY2hhcmFjdGVyLXJlbW92aW5nJyksIFtuYW1lXSksICgpID0+IHtcclxuICAgICAgICAgICAgICAgIERCTVMucmVtb3ZlUHJvZmlsZSh0eXBlLCBuYW1lLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIucmVmcmVzaCgoZXJyMikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbn0pKHRoaXMuUHJvZmlsZXMgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTggVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHJvb3QgPSAnLmNoYXJhY3Rlci1yZXBvcnRzLXRtcGwnO1xyXG5cclxuICAgIGV4cG9ydHMubWFrZVN0b3J5UmVwb3J0Um93ID0gKHN0b3J5SW5mbykgPT4ge1xyXG4gICAgICAgIGNvbnN0IGFjdCA9IHN0b3J5SW5mby5hY3Rpdml0eTtcclxuICAgICAgICBjb25zdCBjb21wbGV0ZW5lc3MgPSBtYWtlQ29tcGxldGVuZXNzTGFiZWwoc3RvcnlJbmZvLmZpbmlzaGVkQWRhcHRhdGlvbnMsIHN0b3J5SW5mby50b3RhbEFkYXB0YXRpb25zKTtcclxuICAgICAgICBjb25zdCBjb2xvciA9IGdldENvbXBsZXRlbmVzc0NvbG9yKHN0b3J5SW5mby5maW5pc2hlZEFkYXB0YXRpb25zLCBzdG9yeUluZm8udG90YWxBZGFwdGF0aW9ucyk7XHJcbiAgICAgICAgY29uc3Qgcm93ID0gcXRlKGAke3Jvb3R9IC5zdG9yeS1yZXBvcnQtcm93LXRtcGxgKTtcclxuICAgICAgICBjb25zdCBxZSA9IHFlZShyb3cpO1xyXG4gICAgICAgIEwxMG4ubG9jYWxpemVTdGF0aWMocm93KTtcclxuICAgICAgICBhZGRFbChxZSgnLnN0b3J5LW5hbWUnKSwgbWFrZVRleHQoc3RvcnlJbmZvLnN0b3J5TmFtZSkpO1xyXG4gICAgICAgIHNldENsYXNzQnlDb25kaXRpb24ocWUoJy5hY3Rpdml0eS1hY3RpdmUnKSwgJ2FjdGl2ZS1pdGVtLWluLXJlcG9ydCcsIGFjdC5hY3RpdmUpO1xyXG4gICAgICAgIHNldENsYXNzQnlDb25kaXRpb24ocWUoJy5hY3Rpdml0eS1mb2xsb3dlcicpLCAnYWN0aXZlLWl0ZW0taW4tcmVwb3J0JywgYWN0LmZvbGxvd2VyKTtcclxuICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKHFlKCcuYWN0aXZpdHktZGVmZW5zaXZlJyksICdhY3RpdmUtaXRlbS1pbi1yZXBvcnQnLCBhY3QuZGVmZW5zaXZlKTtcclxuICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKHFlKCcuYWN0aXZpdHktcGFzc2l2ZScpLCAnYWN0aXZlLWl0ZW0taW4tcmVwb3J0JywgYWN0LnBhc3NpdmUpO1xyXG4gICAgICAgIGFkZEVsKHFlKCcuY29tcGxldGVuZXNzJyksIG1ha2VUZXh0KGNvbXBsZXRlbmVzcykpO1xyXG4gICAgICAgIHNldFN0eWxlKHFlKCcuY29tcGxldGVuZXNzJyksICdiYWNrZ3JvdW5kLWNvbG9yJywgY29sb3IpO1xyXG4gICAgICAgIGFkZEVsKHFlKCcubWVldHMnKSwgbWFrZVRleHQoc3RvcnlJbmZvLm1lZXRzLmpvaW4oJywgJykpKTtcclxuICAgICAgICBhZGRFbChxZSgnLmludmVudG9yeScpLCBtYWtlVGV4dChzdG9yeUluZm8uaW52ZW50b3J5KSk7XHJcbiAgICAgICAgcmV0dXJuIHJvdztcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlUmVsYXRpb25SZXBvcnRSb3cgPSBSLmN1cnJ5KChjaGFyYWN0ZXJOYW1lLCByZWwpID0+IHtcclxuICAgICAgICBjb25zdCByb3cgPSBxdGUoYCR7cm9vdH0gLnJlbGF0aW9uLXJlcG9ydC1yb3ctdG1wbGApO1xyXG4gICAgICAgIGNvbnN0IHFlID0gcWVlKHJvdyk7XHJcbiAgICAgICAgTDEwbi5sb2NhbGl6ZVN0YXRpYyhyb3cpO1xyXG4gICAgICAgIGNvbnN0IHNlY29uZENoYXJhY3RlciA9IFByb2plY3RVdGlscy5nZXQybmRSZWxDaGFyKGNoYXJhY3Rlck5hbWUsIHJlbCk7XHJcbiAgICAgICAgYWRkRWwocWUoJy5jaGFyYWN0ZXItbmFtZScpLCBtYWtlVGV4dChzZWNvbmRDaGFyYWN0ZXIpKTtcclxuICAgICAgICBjb25zdCBpc1N0YXJ0ZXIgPSByZWwuc3RhcnRlciA9PT0gY2hhcmFjdGVyTmFtZTtcclxuXHJcbiAgICAgICAgaWYgKGlzU3RhcnRlcikge1xyXG4gICAgICAgICAgICBzZXRBdHRyKFxyXG4gICAgICAgICAgICAgICAgcWUoJy5kaXJlY3Rpb24tc3RhcnRlclRvRW5kZXInKSwgJ3RpdGxlJyxcclxuICAgICAgICAgICAgICAgIEwxMG4uZm9ybWF0KCdicmllZmluZ3MnLCAnc3RhcnRlclRvRW5kZXInLCBbY2hhcmFjdGVyTmFtZSwgc2Vjb25kQ2hhcmFjdGVyXSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgc2V0QXR0cihcclxuICAgICAgICAgICAgICAgIHFlKCcuZGlyZWN0aW9uLWVuZGVyVG9TdGFydGVyJyksICd0aXRsZScsXHJcbiAgICAgICAgICAgICAgICBMMTBuLmZvcm1hdCgnYnJpZWZpbmdzJywgJ2VuZGVyVG9TdGFydGVyJywgW3NlY29uZENoYXJhY3RlciwgY2hhcmFjdGVyTmFtZV0pXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc2V0QXR0cihcclxuICAgICAgICAgICAgICAgIHFlKCcuZGlyZWN0aW9uLXN0YXJ0ZXJUb0VuZGVyJyksICd0aXRsZScsXHJcbiAgICAgICAgICAgICAgICBMMTBuLmZvcm1hdCgnYnJpZWZpbmdzJywgJ3N0YXJ0ZXJUb0VuZGVyJywgW3NlY29uZENoYXJhY3RlciwgY2hhcmFjdGVyTmFtZV0pXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIHNldEF0dHIoXHJcbiAgICAgICAgICAgICAgICBxZSgnLmRpcmVjdGlvbi1lbmRlclRvU3RhcnRlcicpLCAndGl0bGUnLFxyXG4gICAgICAgICAgICAgICAgTDEwbi5mb3JtYXQoJ2JyaWVmaW5ncycsICdlbmRlclRvU3RhcnRlcicsIFtjaGFyYWN0ZXJOYW1lLCBzZWNvbmRDaGFyYWN0ZXJdKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihcclxuICAgICAgICAgICAgcWUoJy5kaXJlY3Rpb24tc3RhcnRlclRvRW5kZXInKSwgJ2FjdGl2ZS1pdGVtLWluLXJlcG9ydCcsXHJcbiAgICAgICAgICAgIFIuY29udGFpbnMoaXNTdGFydGVyID8gJ3N0YXJ0ZXJUb0VuZGVyJyA6ICdlbmRlclRvU3RhcnRlcicsIHJlbC5lc3NlbmNlKVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihxZSgnLmRpcmVjdGlvbi1hbGxpZXMnKSwgJ2FjdGl2ZS1pdGVtLWluLXJlcG9ydCcsIFIuY29udGFpbnMoJ2FsbGllcycsIHJlbC5lc3NlbmNlKSk7XHJcbiAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihcclxuICAgICAgICAgICAgcWUoJy5kaXJlY3Rpb24tZW5kZXJUb1N0YXJ0ZXInKSwgJ2FjdGl2ZS1pdGVtLWluLXJlcG9ydCcsXHJcbiAgICAgICAgICAgIFIuY29udGFpbnMoIWlzU3RhcnRlciA/ICdzdGFydGVyVG9FbmRlcicgOiAnZW5kZXJUb1N0YXJ0ZXInLCByZWwuZXNzZW5jZSlcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICBjb25zdCBmaW5pc2hlZCA9IGlzU3RhcnRlciA/IHJlbC5zdGFydGVyVGV4dFJlYWR5IDogcmVsLmVuZGVyVGV4dFJlYWR5O1xyXG5cclxuICAgICAgICBhZGRFbChxZSgnLmNvbXBsZXRlbmVzcycpLCBtYWtlVGV4dChMMTBuLmdldCgnY29uc3RhbnQnLCBmaW5pc2hlZCA/ICdmaW5pc2hlZCcgOiAndW5maW5pc2hlZCcpKSk7XHJcbiAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihxZSgnLmNvbXBsZXRlbmVzcycpLCAncmVsYXRpb24tZmluaXNoZWQnLCBmaW5pc2hlZCk7XHJcbiAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihxZSgnLmNvbXBsZXRlbmVzcycpLCAncmVsYXRpb24tdW5maW5pc2hlZCcsICFmaW5pc2hlZCk7XHJcblxyXG4gICAgICAgIGFkZEVsKHFlKCcub3JpZ2luJyksIG1ha2VUZXh0KHJlbC5vcmlnaW4pKTtcclxuICAgICAgICByZXR1cm4gcm93O1xyXG4gICAgfSk7XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUNvbXBsZXRlbmVzc0xhYmVsKHZhbHVlLCB0b3RhbCkge1xyXG4gICAgICAgIHJldHVybiBzdHJGb3JtYXQoJ3swfSAoezF9L3syfSknLCBbdG90YWwgPT09IDAgPyAnLScgOiBgJHsoKHZhbHVlIC8gdG90YWwpICogMTAwKS50b0ZpeGVkKDApfSVgLCB2YWx1ZSwgdG90YWxdKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRDb21wbGV0ZW5lc3NDb2xvcih2YWx1ZSwgdG90YWwpIHtcclxuICAgICAgICBpZiAodG90YWwgPT09IDApIHsgcmV0dXJuICd0cmFuc3BhcmVudCc7IH1cclxuICAgICAgICBmdW5jdGlvbiBjYWxjKGIsIGEsIHBhcnQpIHtcclxuICAgICAgICAgICAgcmV0dXJuICgoYSAqIHBhcnQpICsgKCgxIC0gcGFydCkgKiBiKSkudG9GaXhlZCgwKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBwID0gdmFsdWUgLyB0b3RhbDtcclxuICAgICAgICBpZiAocCA8IDAuNSkge1xyXG4gICAgICAgICAgICBwICo9IDI7XHJcbiAgICAgICAgICAgIHJldHVybiBzdHJGb3JtYXQoJ3JnYmEoezB9LHsxfSx7Mn0sIDEpJywgW2NhbGMoMjUxLCAyNTUsIHApLCBjYWxjKDEyNiwgMjU1LCBwKSwgY2FsYygxMjksIDAsIHApXSk7IC8vIHJlZCB0byB5ZWxsb3cgbWFwcGluZ1xyXG4gICAgICAgIH1cclxuICAgICAgICBwID0gKHAgLSAwLjUpICogMjtcclxuICAgICAgICByZXR1cm4gc3RyRm9ybWF0KCdyZ2JhKHswfSx7MX0sezJ9LCAxKScsIFtjYWxjKDI1NSwgMTIzLCBwKSwgY2FsYygyNTUsIDIyNSwgcCksIGNhbGMoMCwgNjUsIHApXSk7IC8vIHllbGxvdyB0byBncmVlbiBtYXBwaW5nXHJcbiAgICB9XHJcbn0pKHRoaXMuQ2hhcmFjdGVyUmVwb3J0cyA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgcm9vdCA9ICcucHJvZmlsZS1iaW5kaW5nMi10YWIgJztcclxuICAgIGNvbnN0IGwxMG4gPSBMMTBuLmdldCgnYmluZGluZycpO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fSAuY2hhcmFjdGVyLWZpbHRlcmApLCAnaW5wdXQnLCBmaWx0ZXJMaXN0KCcuY2hhcmFjdGVyLWxpc3QnKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0gLnBsYXllci1maWx0ZXJgKSwgJ2lucHV0JywgZmlsdGVyTGlzdCgnLnBsYXllci1saXN0JykpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9IC5iaW5kaW5nLWZpbHRlcmApLCAnaW5wdXQnLCBmaWx0ZXJMaXN0KCcuYmluZGluZy1saXN0JykpO1xyXG5cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2NoYXJhY3RlcicsIGZhbHNlLCAoZXJyLCBjaGFyYWN0ZXJOYW1lcykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheSgncGxheWVyJywgZmFsc2UsIChlcnIyLCBwbGF5ZXJOYW1lcykgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgREJNUy5nZXRQcm9maWxlQmluZGluZ3MoKGVycjMsIHByb2ZpbGVCaW5kaW5ncykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIzKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjMpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICByZWJ1aWxkSW50ZXJmYWNlKGNoYXJhY3Rlck5hbWVzLCBwbGF5ZXJOYW1lcywgcHJvZmlsZUJpbmRpbmdzKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gcmVidWlsZEludGVyZmFjZShjaGFyYWN0ZXJOYW1lcywgcGxheWVyTmFtZXMsIHByb2ZpbGVCaW5kaW5ncykge1xyXG4gICAgICAgIGNvbnN0IGJvbmRlZENoYXJhY3Rlckxpc3QgPSBSLmtleXMocHJvZmlsZUJpbmRpbmdzKTtcclxuICAgICAgICBjb25zdCBib25kZWRQbGF5ZXJMaXN0ID0gUi52YWx1ZXMocHJvZmlsZUJpbmRpbmdzKTtcclxuICAgICAgICBjb25zdCBmaWx0ZXIgPSBsaXN0ID0+IFIuY29tcG9zZShSLm5vdCwgUi5jb250YWlucyhSLl9fLCBsaXN0KSwgUi5wcm9wKCd2YWx1ZScpKTtcclxuICAgICAgICBcclxuICAgICAgICBzaG93RWwocXVlcnlFbChgJHtyb290fSAuYWxlcnQubm8tY2hhcmFjdGVyYCksIGNoYXJhY3Rlck5hbWVzLmxlbmd0aCA9PT0gMCk7XHJcbiAgICAgICAgVXRpbHMuZW5hYmxlRWwocXVlcnlFbChgJHtyb290fSAuY2hhcmFjdGVyLWZpbHRlcmApLCBjaGFyYWN0ZXJOYW1lcy5sZW5ndGggIT09IDApO1xyXG4gICAgICAgIHNob3dFbChxdWVyeUVsKGAke3Jvb3R9IC5jaGFyYWN0ZXItbGlzdGApLCBjaGFyYWN0ZXJOYW1lcy5sZW5ndGggIT09IDApO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHNob3dFbChxdWVyeUVsKGAke3Jvb3R9IC5hbGVydC5uby1wbGF5ZXJgKSwgcGxheWVyTmFtZXMubGVuZ3RoID09PSAwKTtcclxuICAgICAgICBVdGlscy5lbmFibGVFbChxdWVyeUVsKGAke3Jvb3R9IC5wbGF5ZXItZmlsdGVyYCksIHBsYXllck5hbWVzLmxlbmd0aCAhPT0gMCk7XHJcbiAgICAgICAgc2hvd0VsKHF1ZXJ5RWwoYCR7cm9vdH0gLnBsYXllci1saXN0YCksIHBsYXllck5hbWVzLmxlbmd0aCAhPT0gMCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgVXRpbHMuZW5hYmxlRWwocXVlcnlFbChgJHtyb290fSAuYmluZGluZy1maWx0ZXJgKSwgUi5rZXlzKHByb2ZpbGVCaW5kaW5ncykubGVuZ3RoICE9PSAwKTtcclxuXHJcbiAgICAgICAgYWRkRWxzKFxyXG4gICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0gLmVudGl0eS1saXN0LmNoYXJhY3Rlci1saXN0YCkpLFxyXG4gICAgICAgICAgICBjaGFyYWN0ZXJOYW1lcy5maWx0ZXIoZmlsdGVyKGJvbmRlZENoYXJhY3Rlckxpc3QpKS5tYXAocHJvZmlsZTJlbCgnY2hhcmFjdGVyJykpXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgYWRkRWxzKFxyXG4gICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0gLmVudGl0eS1saXN0LnBsYXllci1saXN0YCkpLFxyXG4gICAgICAgICAgICBwbGF5ZXJOYW1lcy5maWx0ZXIoZmlsdGVyKGJvbmRlZFBsYXllckxpc3QpKS5tYXAocHJvZmlsZTJlbCgncGxheWVyJykpXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgY29uc3QgYmluZGluZ3MgPSBSLnRvUGFpcnMocHJvZmlsZUJpbmRpbmdzKS5tYXAoYmluZGluZyA9PiAoe1xyXG4gICAgICAgICAgICBuYW1lOiBSLmpvaW4oJy8nLCBiaW5kaW5nKSxcclxuICAgICAgICAgICAgdmFsdWU6IGJpbmRpbmdcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgYmluZGluZ3Muc29ydChDb21tb25VdGlscy5jaGFyT3JkQUZhY3RvcnkoUi5wcm9wKCduYW1lJykpKTtcclxuXHJcbiAgICAgICAgYWRkRWxzKGNsZWFyRWwocXVlcnlFbChgJHtyb290fSAuZW50aXR5LWxpc3QuYmluZGluZy1saXN0YCkpLCBiaW5kaW5ncy5tYXAoYmluZGluZzJlbCkpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHByb2ZpbGUyZWwgPSBSLmN1cnJ5KCh0eXBlLCBuYW1lKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZWwgPSBxbXRlKGAke3Jvb3R9IC5wcm9maWxlLWl0ZW0tdG1wbGApO1xyXG4gICAgICAgIGVsLnByb2ZpbGVOYW1lID0gbmFtZS52YWx1ZTtcclxuICAgICAgICBjb25zdCBidG4gPSBxZWUoZWwsICdbcm9sZT1idXR0b25dJyk7XHJcbiAgICAgICAgYWRkRWwocWVlKGVsLCAnLnByaW1hcnktbmFtZScpLCBtYWtlVGV4dChuYW1lLmRpc3BsYXlOYW1lKSk7XHJcbiAgICAgICAgc2V0QXR0cihidG4sICdwcm9maWxlLW5hbWUnLCBuYW1lLnZhbHVlKTtcclxuICAgICAgICBzZXRBdHRyKGJ0biwgJ3ByaW1hcnktbmFtZScsIG5hbWUuZGlzcGxheU5hbWUpO1xyXG4gICAgICAgIHNldEF0dHIoYnRuLCAncHJvZmlsZS10eXBlJywgdHlwZSk7XHJcbiAgICAgICAgbGlzdGVuKGJ0biwgJ2RyYWdzdGFydCcsIG9uRHJhZ1N0YXJ0KTtcclxuICAgICAgICBsaXN0ZW4oYnRuLCAnZHJvcCcsIG9uRHJvcCk7XHJcbiAgICAgICAgbGlzdGVuKGJ0biwgJ2RyYWdvdmVyJywgYWxsb3dEcm9wKTtcclxuICAgICAgICBsaXN0ZW4oYnRuLCAnZHJhZ2VudGVyJywgaGFuZGxlRHJhZ0VudGVyKTtcclxuICAgICAgICBsaXN0ZW4oYnRuLCAnZHJhZ2xlYXZlJywgaGFuZGxlRHJhZ0xlYXZlKTtcclxuICAgICAgICByZXR1cm4gZWw7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgb25EcmFnU3RhcnQgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGBvbkRyYWdTdGFydCAke3RoaXMucHJvZmlsZU5hbWV9YCk7XHJcbiAgICAgICAgZXZlbnQuZGF0YVRyYW5zZmVyLnNldERhdGEoJ2RhdGEnLCBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICAgIG5hbWU6IGdldEF0dHIodGhpcywgJ3Byb2ZpbGUtbmFtZScpLFxyXG4gICAgICAgICAgICB0eXBlOiBnZXRBdHRyKHRoaXMsICdwcm9maWxlLXR5cGUnKSxcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgZXZlbnQuZGF0YVRyYW5zZmVyLmVmZmVjdEFsbG93ZWQgPSAnbW92ZSc7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBvbkRyb3AgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgIHJlbW92ZUNsYXNzKHRoaXMsICdvdmVyJyk7XHJcbiAgICAgICAgY29uc29sZS5sb2coYG9uRHJvcCAke3RoaXMucHJvZmlsZU5hbWV9JHtldmVudC5kYXRhVHJhbnNmZXIuZ2V0RGF0YSgnZGF0YScpfWApO1xyXG4gICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pIHtcclxuICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIHN0b3BzIHRoZSBicm93c2VyIGZyb20gcmVkaXJlY3RpbmcuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHRoYXREYXRhID0gSlNPTi5wYXJzZShldmVudC5kYXRhVHJhbnNmZXIuZ2V0RGF0YSgnZGF0YScpKTtcclxuICAgICAgICBpZiAodGhhdERhdGEudHlwZSA9PT0gZ2V0QXR0cih0aGlzLCAncHJvZmlsZS10eXBlJykpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY3JlYXRlQmluZGluZyhbdGhhdERhdGEsIHtcclxuICAgICAgICAgICAgbmFtZTogZ2V0QXR0cih0aGlzLCAncHJvZmlsZS1uYW1lJyksXHJcbiAgICAgICAgICAgIHR5cGU6IGdldEF0dHIodGhpcywgJ3Byb2ZpbGUtdHlwZScpLFxyXG4gICAgICAgIH1dKTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIGFsbG93RHJvcCA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYGFsbG93RHJvcCAke3RoaXMucHJvZmlsZU5hbWV9YCk7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gaGFuZGxlRHJhZ0VudGVyKGV2ZW50KSB7XHJcbiAgICAgICAgYWRkQ2xhc3ModGhpcywgJ292ZXInKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBoYW5kbGVEcmFnTGVhdmUoZXZlbnQpIHtcclxuICAgICAgICByZW1vdmVDbGFzcyh0aGlzLCAnb3ZlcicpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGJpbmRpbmcyZWwoYmluZGluZykge1xyXG4gICAgICAgIGNvbnN0IGVsID0gd3JhcEVsKCdkaXYnLCBxdGUoYCR7cm9vdH0gLmJpbmRpbmctaXRlbS10bXBsYCkpO1xyXG4gICAgICAgIGFkZEVsKHFlZShlbCwgJy5wcmltYXJ5LW5hbWUnKSwgbWFrZVRleHQoYmluZGluZy5uYW1lKSk7XHJcbiAgICAgICAgc2V0QXR0cihlbCwgJ3ByaW1hcnktbmFtZScsIGJpbmRpbmcubmFtZSk7XHJcbiAgICAgICAgc2V0QXR0cihxZWUoZWwsICcudW5saW5rJyksICd0aXRsZScsIGwxMG4oJ3VubGluay1iaW5kaW5nJykpO1xyXG4gICAgICAgIGxpc3RlbihxZWUoZWwsICcudW5saW5rJyksICdjbGljaycsICgpID0+IHJlbW92ZUJpbmRpbmcoYmluZGluZy52YWx1ZSkpO1xyXG4gICAgICAgIHJldHVybiBlbDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgZmlsdGVyTGlzdCA9IHNlbCA9PiAoZXZlbnQpID0+IHtcclxuICAgICAgICBjb25zdCBzdHIgPSBldmVudC50YXJnZXQudmFsdWUudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICAgICAgY29uc3QgZWxzID0gcXVlcnlFbHMoYCR7cm9vdH0gJHtzZWx9IFtwcmltYXJ5LW5hbWVdYCk7XHJcbiAgICAgICAgZWxzLmZvckVhY2goKGVsKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzVmlzaWJsZSA9IGdldEF0dHIoZWwsICdwcmltYXJ5LW5hbWUnKS50b0xvd2VyQ2FzZSgpLmluZGV4T2Yoc3RyKSAhPT0gLTE7XHJcbiAgICAgICAgICAgIHNob3dFbChlbCwgaXNWaXNpYmxlKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZyhwYWlyKSB7XHJcbiAgICAgICAgY29uc3QgY2hhcmFjdGVyTmFtZSA9IHBhaXJbMF0udHlwZSA9PT0gJ2NoYXJhY3RlcicgPyBwYWlyWzBdLm5hbWUgOiBwYWlyWzFdLm5hbWU7XHJcbiAgICAgICAgY29uc3QgcGxheWVyTmFtZSA9IHBhaXJbMF0udHlwZSA9PT0gJ3BsYXllcicgPyBwYWlyWzBdLm5hbWUgOiBwYWlyWzFdLm5hbWU7XHJcbiAgICAgICAgREJNUy5jcmVhdGVCaW5kaW5nKGNoYXJhY3Rlck5hbWUsIHBsYXllck5hbWUsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZW1vdmVCaW5kaW5nKGJpbmRpbmcpIHtcclxuICAgICAgICBEQk1TLnJlbW92ZUJpbmRpbmcoYmluZGluZ1swXSwgYmluZGluZ1sxXSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgfVxyXG59KSh0aGlzLlByb2ZpbGVCaW5kaW5nMiA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcblxyXG4vLyBDaGFyYWN0ZXIvUGxheWVyIHByb2ZpbGVzIGFscmVhZHkgaGF2ZSBmaWVsZCAnbmFtZSdcclxuLy8gSSBoYWQgc29tZSBjaG9pY2VzOlxyXG4vLyAxLiByZW1vdmUgdGhpcyBmaWVsZCBhdCBhbGxcclxuLy8gMi4gQWRkIG9uZSBtb3JlIG9iamVjdCB0byBkaXZpZGUgc3BlY2lhbCB2YWx1ZXMgKG5hbWUpIGFuZCB1c2VyIGRlZmluZWQgdmFsdWVzXHJcbi8vIDMuIFByb2hpYml0IHRvIG1ha2UgZmllbGQgLSBuYW1lXHJcbi8vIDEuIFRoaXMgZmllbGQgaXMgdXNlZCBpbiBtYW55IHBsYWNlc1xyXG4vLyAyLiAtIHRvbyBjb21wbGV4IHdheVxyXG4vLyAzLiBzaW1wbGUgYW5kIGxlc3NlciBjb21wbGV4aXR5LCBJIGNob29zZSB0aGlzIHdheVxyXG5cclxuZnVuY3Rpb24gUHJvZmlsZUNvbmZpZ3VyZXJUbXBsKGV4cG9ydHMsIG9wdHMpIHtcclxuICAgIGNvbnN0IHsgdGFiVHlwZSB9ID0gb3B0cztcclxuXHJcbiAgICBjb25zdCB0bXBsUm9vdCA9ICcucHJvZmlsZS1jb25maWd1cmVyMi10YWItdG1wbCc7XHJcbiAgICBjb25zdCB0YWJSb290ID0gYC5wcm9maWxlLWNvbmZpZ3VyZXIyLXRhYi4ke2Ake3RhYlR5cGV9LXR5cGVgfSBgO1xyXG4gICAgY29uc3QgcHJvZmlsZVBhbmVsID0gYCR7dGFiUm9vdH0ucHJvZmlsZS1wYW5lbCBgO1xyXG4gICAgY29uc3QgbDEwbiA9IEwxMG4uZ2V0KCdwcm9maWxlcycpO1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZWwgPSBxdWVyeUVsKHRtcGxSb290KS5jbG9uZU5vZGUodHJ1ZSk7XHJcblxyXG4gICAgICAgIGFkZENsYXNzZXMoZWwsIFsncHJvZmlsZS1jb25maWd1cmVyMi10YWInLCBgJHtgJHt0YWJUeXBlfS10eXBlYH1gXSk7XHJcbiAgICAgICAgcmVtb3ZlQ2xhc3MoZWwsICdwcm9maWxlLWNvbmZpZ3VyZXIyLXRhYi10bXBsJyk7XHJcbiAgICAgICAgYWRkRWwocXVlcnlFbCgnLnRhYi1jb250YWluZXInKSwgZWwpO1xyXG5cclxuICAgICAgICBjb25zdCBjcmVhdGVQcm9maWxlSXRlbURpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKFxyXG4gICAgICAgICAgICBgLnByb2ZpbGUtY29uZmlndXJlcjItdGFiLiR7YCR7dGFiVHlwZX0tdHlwZWB9YCxcclxuICAgICAgICAgICAgY3JlYXRlUHJvZmlsZUl0ZW0sIHtcclxuICAgICAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ2NyZWF0ZS1wcm9maWxlLWl0ZW0tYm9keScsXHJcbiAgICAgICAgICAgICAgICBkaWFsb2dUaXRsZTogJ3Byb2ZpbGVzLWNyZWF0ZS1wcm9maWxlLWl0ZW0nLFxyXG4gICAgICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tY3JlYXRlJyxcclxuICAgICAgICAgICAgICAgIGluaXRCb2R5OiAoYm9keSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlbCA9IGNsZWFyRWwocWVlKGJvZHksICcuY3JlYXRlLWVudGl0eS10eXBlLXNlbGVjdCcpKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWxsTWFpblNlbCA9ICgpID0+IHsgZmlsbEl0ZW1UeXBlc1NlbChjbGVhckVsKHNlbCkpOyB9O1xyXG4gICAgICAgICAgICAgICAgICAgIGZpbGxNYWluU2VsKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgTDEwbi5vbkwxMG5DaGFuZ2UoZmlsbE1haW5TZWwpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgc3RhdGUucmVuYW1lUHJvZmlsZUl0ZW1EaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhcclxuICAgICAgICAgICAgYC5wcm9maWxlLWNvbmZpZ3VyZXIyLXRhYi4ke2Ake3RhYlR5cGV9LXR5cGVgfWAsXHJcbiAgICAgICAgICAgIHJlbmFtZVByb2ZpbGVJdGVtLCB7XHJcbiAgICAgICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdtb2RhbC1wcm9tcHQtYm9keScsXHJcbiAgICAgICAgICAgICAgICBkaWFsb2dUaXRsZTogJ3Byb2ZpbGVzLWVudGVyLW5ldy1wcm9maWxlLWl0ZW0tbmFtZScsXHJcbiAgICAgICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1yZW5hbWUnLFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgc3RhdGUubW92ZVByb2ZpbGVJdGVtRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2coXHJcbiAgICAgICAgICAgIGAucHJvZmlsZS1jb25maWd1cmVyMi10YWIuJHtgJHt0YWJUeXBlfS10eXBlYH1gLFxyXG4gICAgICAgICAgICBtb3ZlUHJvZmlsZUl0ZW0sIHtcclxuICAgICAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ21vdmUtcHJvZmlsZS1pdGVtLWJvZHknLFxyXG4gICAgICAgICAgICAgICAgZGlhbG9nVGl0bGU6ICdwcm9maWxlcy1uZXctcHJvZmlsZS1pdGVtLXBvc2l0aW9uJyxcclxuICAgICAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLW1vdmUnLFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgICAgICBcclxuICAgICAgICBzdGF0ZS5yZW5hbWVFbnVtSXRlbURpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKFxyXG4gICAgICAgICAgICBgLnByb2ZpbGUtY29uZmlndXJlcjItdGFiLiR7YCR7dGFiVHlwZX0tdHlwZWB9YCxcclxuICAgICAgICAgICAgcmVuYW1lRW51bVZhbHVlLCB7XHJcbiAgICAgICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdyZW5hbWUtZW51bS12YWx1ZS10bXBsJyxcclxuICAgICAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAncHJvZmlsZXMtcmVuYW1lLWVudW0taXRlbScsXHJcbiAgICAgICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1yZW5hbWUnLFxyXG4gICAgICAgICAgICAgICAgaW5pdEJvZHk6IChib2R5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVuYW1lU2VsZWN0ID0gY2xlYXJFbChxZWUoYm9keSwgJy5yZW5hbWVkLXZhbHVlLXNlbGVjdCcpKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZW5hbWVJbnB1dCA9IGNsZWFyRWwocWVlKGJvZHksICcuZW51bS12YWx1ZS1uYW1lLWlucHV0JykpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxpc3RlbihyZW5hbWVTZWxlY3QsICdjaGFuZ2UnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmFtZUlucHV0LnZhbHVlID0gcmVuYW1lU2VsZWN0LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgICAgICBcclxuICAgICAgICBzdGF0ZS5lbnVtRWRpdG9yRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2coXHJcbiAgICAgICAgICAgIGAucHJvZmlsZS1jb25maWd1cmVyMi10YWIuJHtgJHt0YWJUeXBlfS10eXBlYH1gLFxyXG4gICAgICAgICAgICB1cGRhdGVFbnVtVmFsdWVzLCB7XHJcbiAgICAgICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdlbnVtLWRpYWxvZy1lZGl0b3ItdG1wbCcsXHJcbiAgICAgICAgICAgICAgICBkaWFsb2dUaXRsZTogJ3Byb2ZpbGVzLWVudW0tZWRpdG9yJyxcclxuICAgICAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLXNhdmUnLFxyXG4gICAgICAgICAgICAgICAgaW5pdEJvZHk6IChib2R5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWRkZWRWYWx1ZXNBcmVhID0gcWVlKGJvZHksICcubmV3LWVudW0tdmFsdWVzJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVtb3ZlZFZhbHVlc0FyZWEgPSBxZWUoYm9keSwgJy5yZW1vdmVkLWVudW0tdmFsdWVzJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5wdXRBcmVhID0gcWVlKGJvZHksICcuZW51bS12YWx1ZS1pbnB1dCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRWYWx1ZVNlbGVjdCA9IHFlZShib2R5LCAnLmRlZmF1bHQtdmFsdWUtc2VsZWN0Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGlzdGVuKGlucHV0QXJlYSwgJ2lucHV0JywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdWYWxzID0gaW5wdXRBcmVhLnZhbHVlLnNwbGl0KCcsJykubWFwKFIudHJpbSkuZmlsdGVyKFIucGlwZShSLmVxdWFscygnJyksIFIubm90KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFkZGVkVmFsdWVzID0gUi5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBLCBSLmRpZmZlcmVuY2UobmV3VmFscywgaW5wdXRBcmVhLnNyY0xpc3QpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWRkRWxzKGNsZWFyRWwoYWRkZWRWYWx1ZXNBcmVhKSwgZW51bUxpc3QyRWxzKGFkZGVkVmFsdWVzKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlbW92ZWRWYWx1ZXMgPSBSLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEsIFIuZGlmZmVyZW5jZShpbnB1dEFyZWEuc3JjTGlzdCwgbmV3VmFscykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhZGRFbHMoY2xlYXJFbChyZW1vdmVkVmFsdWVzQXJlYSksIGVudW1MaXN0MkVscyhyZW1vdmVkVmFsdWVzKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGVmYXVsdFZhbHVlID0gZGVmYXVsdFZhbHVlU2VsZWN0LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhckVsKGRlZmF1bHRWYWx1ZVNlbGVjdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihuZXdWYWxzLmxlbmd0aCA9PT0gMCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFSLmNvbnRhaW5zKGRlZmF1bHRWYWx1ZSwgbmV3VmFscykpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFZhbHVlID0gbmV3VmFsc1swXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWxsU2VsZWN0b3IoZGVmYXVsdFZhbHVlU2VsZWN0LCBhcnIyU2VsZWN0KG5ld1ZhbHMpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcWVlKGRlZmF1bHRWYWx1ZVNlbGVjdCwgYFt2YWx1ZT1cIiR7ZGVmYXVsdFZhbHVlfVwiXWApLnNlbGVjdGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgc3RhdGUubXVsdGlFbnVtRWRpdG9yRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2coXHJcbiAgICAgICAgICAgIGAucHJvZmlsZS1jb25maWd1cmVyMi10YWIuJHtgJHt0YWJUeXBlfS10eXBlYH1gLFxyXG4gICAgICAgICAgICB1cGRhdGVFbnVtVmFsdWVzLCB7XHJcbiAgICAgICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdtdWx0aS1lbnVtLWRpYWxvZy1lZGl0b3ItdG1wbCcsXHJcbiAgICAgICAgICAgICAgICBkaWFsb2dUaXRsZTogJ3Byb2ZpbGVzLW11bHRpLWVudW0tZWRpdG9yJyxcclxuICAgICAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLXNhdmUnLFxyXG4gICAgICAgICAgICAgICAgaW5pdEJvZHk6IChib2R5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWRkZWRWYWx1ZXNBcmVhID0gcWVlKGJvZHksICcubmV3LWVudW0tdmFsdWVzJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVtb3ZlZFZhbHVlc0FyZWEgPSBxZWUoYm9keSwgJy5yZW1vdmVkLWVudW0tdmFsdWVzJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5wdXRBcmVhID0gcWVlKGJvZHksICcuZW51bS12YWx1ZS1pbnB1dCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxpc3RlbihpbnB1dEFyZWEsICdpbnB1dCcsICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3VmFscyA9IGlucHV0QXJlYS52YWx1ZS5zcGxpdCgnLCcpLm1hcChSLnRyaW0pLmZpbHRlcihSLnBpcGUoUi5lcXVhbHMoJycpLCBSLm5vdCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhZGRlZFZhbHVlcyA9IFIuc29ydChDb21tb25VdGlscy5jaGFyT3JkQSwgUi5kaWZmZXJlbmNlKG5ld1ZhbHMsIGlucHV0QXJlYS5zcmNMaXN0KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkZEVscyhjbGVhckVsKGFkZGVkVmFsdWVzQXJlYSksIGVudW1MaXN0MkVscyhhZGRlZFZhbHVlcykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZW1vdmVkVmFsdWVzID0gUi5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBLCBSLmRpZmZlcmVuY2UoaW5wdXRBcmVhLnNyY0xpc3QsIG5ld1ZhbHMpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWRkRWxzKGNsZWFyRWwocmVtb3ZlZFZhbHVlc0FyZWEpLCBlbnVtTGlzdDJFbHMocmVtb3ZlZFZhbHVlcykpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgc2V0QXR0cihxZWUoZWwsICcucGFuZWwgaDMnKSwgJ2wxMG4taWQnLCBgcHJvZmlsZXMtJHtvcHRzLnBhbmVsTmFtZX1gKTtcclxuICAgICAgICBzZXRBdHRyKHFlZShlbCwgJy5hbGVydCcpLCAnbDEwbi1pZCcsIGBhZHZpY2VzLWVtcHR5LSR7dGFiVHlwZX0tcHJvZmlsZS1zdHJ1Y3R1cmVgKTtcclxuICAgICAgICBMMTBuLmxvY2FsaXplU3RhdGljKGVsKTtcclxuXHJcbiAgICAgICAgc2V0QXR0cihxZWUoZWwsICcucGFuZWwgYScpLCAncGFuZWwtdG9nZ2xlcicsIGAke3RhYlJvb3R9LnByb2ZpbGUtcGFuZWxgKTtcclxuICAgICAgICBVSS5pbml0UGFuZWxUb2dnbGVycyhlbCk7XHJcblxyXG4gICAgICAgIGxpc3RlbihxZShgJHt0YWJSb290fS5jcmVhdGVgKSwgJ2NsaWNrJywgKCkgPT4gY3JlYXRlUHJvZmlsZUl0ZW1EaWFsb2cuc2hvd0RsZygpKTtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBlbDtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgICAgIHJlZnJlc2hQYW5lbCh0YWJUeXBlLCBwcm9maWxlUGFuZWwpO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiByZWZyZXNoUGFuZWwodHlwZSwgcm9vdCkge1xyXG4gICAgICAgIERCTVMuZ2V0UHJvZmlsZVN0cnVjdHVyZSh0eXBlLCAoZXJyLCBhbGxQcm9maWxlU2V0dGluZ3MpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGhpZGVFbChxdWVyeUVsKGAke3RhYlJvb3R9IC5hbGVydGApLCBhbGxQcm9maWxlU2V0dGluZ3MubGVuZ3RoICE9PSAwKTtcclxuICAgICAgICAgICAgaGlkZUVsKHF1ZXJ5RWwoYCR7dGFiUm9vdH0gdGFibGVgKSwgYWxsUHJvZmlsZVNldHRpbmdzLmxlbmd0aCA9PT0gMCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBhcnIgPSBhbGxQcm9maWxlU2V0dGluZ3MubWFwKFIuY29tcG9zZShzdHJGb3JtYXQoZ2V0TDEwbignY29tbW9uLXNldC1pdGVtLWJlZm9yZScpKSwgUi5hcHBlbmQoUi5fXywgW10pLCBSLnByb3AoJ25hbWUnKSkpO1xyXG4gICAgICAgICAgICBhcnIucHVzaChnZXRMMTBuKCdjb21tb24tc2V0LWl0ZW0tYXMtbGFzdCcpKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uU2VsZWN0b3JzID0gW3F1ZXJ5RWwoYCR7dGFiUm9vdH0gLmNyZWF0ZS1lbnRpdHktcG9zaXRpb24tc2VsZWN0YCksXHJcbiAgICAgICAgICAgICAgICBxdWVyeUVsKGAke3RhYlJvb3R9IC5tb3ZlLWVudGl0eS1wb3NpdGlvbi1zZWxlY3RgKV07XHJcbiAgICAgICAgICAgIHBvc2l0aW9uU2VsZWN0b3JzLm1hcChjbGVhckVsKS5tYXAoZmlsbFNlbGVjdG9yKFIuX18sIGFycjJTZWxlY3QoYXJyKSkpLm1hcChzZXRQcm9wKFIuX18sICdzZWxlY3RlZEluZGV4JywgYWxsUHJvZmlsZVNldHRpbmdzLmxlbmd0aCkpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgdGFibGUgPSBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0ucHJvZmlsZS1jb25maWctY29udGFpbmVyYCkpO1xyXG5cclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGFkZEVscyh0YWJsZSwgYWxsUHJvZmlsZVNldHRpbmdzLm1hcChnZXRJbnB1dCh0eXBlKSkpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnIxKSB7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5oYW5kbGVFcnJvcihlcnIxKTsgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuaXNBZG1pbigoZXJyMiwgaXNBZG1pbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlKGV4cG9ydHMuY29udGVudCwgJ2FkbWluT25seScsIGlzQWRtaW4pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjcmVhdGVQcm9maWxlSXRlbShkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBpbnB1dCA9IHFlZShkaWFsb2csICcuY3JlYXRlLWVudGl0eS1uYW1lLWlucHV0Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBpbnB1dC52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1UeXBlID0gcWVlKGRpYWxvZywgJy5jcmVhdGUtZW50aXR5LXR5cGUtc2VsZWN0JykudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICBjb25zdCB7IHNlbGVjdGVkSW5kZXggfSA9IHFlZShkaWFsb2csICcuY3JlYXRlLWVudGl0eS1wb3NpdGlvbi1zZWxlY3QnKTtcclxuXHJcbiAgICAgICAgICAgIERCTVMuY3JlYXRlUHJvZmlsZUl0ZW0odGFiVHlwZSwgbmFtZSwgaXRlbVR5cGUsIHNlbGVjdGVkSW5kZXgsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgZmlsbEl0ZW1UeXBlc1NlbCA9IHNlbCA9PiBmaWxsU2VsZWN0b3Ioc2VsLCBjb25zdEFycjJTZWxlY3QoUi5rZXlzKENvbnN0YW50cy5wcm9maWxlRmllbGRUeXBlcykpKTtcclxuICAgIGNvbnN0IGZpbGxQbGF5ZXJBY2Nlc3NTZWwgPSBzZWwgPT4gZmlsbFNlbGVjdG9yKHNlbCwgY29uc3RBcnIyU2VsZWN0KENvbnN0YW50cy5wbGF5ZXJBY2Nlc3NUeXBlcykpO1xyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBnZXRJbnB1dCA9IFIuY3VycnkoKHR5cGUsIHByb2ZpbGVTZXR0aW5ncywgaW5kZXgpID0+IHsgLy8gdGhyb3dzIEludGVybmFsRXJyb3JcclxuICAgICAgICBjb25zdCByb3cgPSBxdGUoYCR7dGFiUm9vdH0gLnByb2ZpbGUtY29uZmlndXJlci1yb3ctdG1wbGApO1xyXG4gICAgICAgIEwxMG4ubG9jYWxpemVTdGF0aWMocm93KTtcclxuICAgICAgICBhZGRFbChxZWUocm93LCAnLml0ZW0tcG9zaXRpb24nKSwgbWFrZVRleHQoaW5kZXggKyAxKSk7XHJcbiAgICAgICAgYWRkRWwocWVlKHJvdywgJy5pdGVtLW5hbWUnKSwgbWFrZVRleHQocHJvZmlsZVNldHRpbmdzLm5hbWUpKTtcclxuXHJcbiAgICAgICAgY29uc3QgaXRlbVR5cGUgPSBxZWUocm93LCAnLml0ZW0tdHlwZScpO1xyXG4gICAgICAgIGZpbGxJdGVtVHlwZXNTZWwoaXRlbVR5cGUpO1xyXG4gICAgICAgIGl0ZW1UeXBlLnZhbHVlID0gcHJvZmlsZVNldHRpbmdzLnR5cGU7XHJcbiAgICAgICAgaXRlbVR5cGUuaW5mbyA9IHByb2ZpbGVTZXR0aW5ncy5uYW1lO1xyXG4gICAgICAgIGl0ZW1UeXBlLm9sZFR5cGUgPSBwcm9maWxlU2V0dGluZ3MudHlwZTtcclxuICAgICAgICBsaXN0ZW4oaXRlbVR5cGUsICdjaGFuZ2UnLCBjaGFuZ2VQcm9maWxlSXRlbVR5cGUodHlwZSkpO1xyXG5cclxuICAgICAgICBsZXQgaW5wdXQsIGFkZERlZmF1bHRMaXN0ZW5lciA9IHRydWU7XHJcbiAgICAgICAgc3dpdGNoIChwcm9maWxlU2V0dGluZ3MudHlwZSkge1xyXG4gICAgICAgIGNhc2UgJ3RleHQnOlxyXG4gICAgICAgICAgICBpbnB1dCA9IG1ha2VFbCgndGV4dGFyZWEnKTtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoaW5wdXQsICdoaWRkZW4nKTtcclxuICAgICAgICAgICAgaW5wdXQudmFsdWUgPSBwcm9maWxlU2V0dGluZ3MudmFsdWU7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgICAgICAgICBpbnB1dCA9IHFtdGUoYCR7dGFiUm9vdH0gLmVudW0tdmFsdWUtZWRpdG9yLXRtcGxgKTtcclxuICAgICAgICAgICAgY29uc3QgbGlzdCA9IHByb2ZpbGVTZXR0aW5ncy52YWx1ZS5zcGxpdCgnLCcpO1xyXG4gICAgICAgICAgICBjb25zdCBkZWZhdWx0VmFsdWUgPSBsaXN0WzBdO1xyXG4gICAgICAgICAgICBsaXN0LnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgYWRkRWxzKHFlZShpbnB1dCwgJy50ZXh0JyksIGVudW1MaXN0MkVscyhsaXN0LCBkZWZhdWx0VmFsdWUpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGxpc3RlbihxZWUoaW5wdXQsICcuYnRuLmFkZCcpLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBhZGRFbHMoY2xlYXJFbChxZWUoc3RhdGUuZW51bUVkaXRvckRpYWxvZywgJy5pbml0aWFsLXZhbHVlJykpLCBlbnVtTGlzdDJFbHMobGlzdCwgZGVmYXVsdFZhbHVlKSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpbnB1dEFyZWEgPSBxZWUoc3RhdGUuZW51bUVkaXRvckRpYWxvZywgJy5lbnVtLXZhbHVlLWlucHV0Jyk7XHJcbiAgICAgICAgICAgICAgICBpbnB1dEFyZWEudmFsdWUgPSBsaXN0LmpvaW4oJywnKTtcclxuICAgICAgICAgICAgICAgIGlucHV0QXJlYS5zcmNMaXN0ID0gbGlzdDtcclxuICAgICAgICAgICAgICAgIGlucHV0QXJlYS5kZWZhdWx0VmFsdWUgPSBkZWZhdWx0VmFsdWU7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRWYWx1ZVNlbGVjdCA9IGNsZWFyRWwocWVlKHN0YXRlLmVudW1FZGl0b3JEaWFsb2csICcuZGVmYXVsdC12YWx1ZS1zZWxlY3QnKSk7XHJcbiAgICAgICAgICAgICAgICBmaWxsU2VsZWN0b3IoZGVmYXVsdFZhbHVlU2VsZWN0LCBhcnIyU2VsZWN0KGxpc3QpKTtcclxuICAgICAgICAgICAgICAgIHFlZShkZWZhdWx0VmFsdWVTZWxlY3QsIGBbdmFsdWU9XCIke2RlZmF1bHRWYWx1ZX1cIl1gKS5zZWxlY3RlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5lbnVtRWRpdG9yRGlhbG9nLml0ZW1OYW1lID0gcHJvZmlsZVNldHRpbmdzLm5hbWU7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5lbnVtRWRpdG9yRGlhbG9nLnNob3dEbGcoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBsaXN0ZW4ocWVlKGlucHV0LCAnLmJ0bi5yZW5hbWUnKSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVuYW1lU2VsZWN0ID0gY2xlYXJFbChxZWUoc3RhdGUucmVuYW1lRW51bUl0ZW1EaWFsb2csICcucmVuYW1lZC12YWx1ZS1zZWxlY3QnKSk7XHJcbiAgICAgICAgICAgICAgICBmaWxsU2VsZWN0b3IocmVuYW1lU2VsZWN0LCBhcnIyU2VsZWN0KGxpc3QpKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgaWYobGlzdC5sZW5ndGggPiAwKXtcclxuICAgICAgICAgICAgICAgICAgICBxZWUoc3RhdGUucmVuYW1lRW51bUl0ZW1EaWFsb2csICcuZW51bS12YWx1ZS1uYW1lLWlucHV0JykudmFsdWUgPSBsaXN0WzBdOyBcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgc3RhdGUucmVuYW1lRW51bUl0ZW1EaWFsb2cuaXRlbU5hbWUgPSBwcm9maWxlU2V0dGluZ3MubmFtZTtcclxuICAgICAgICAgICAgICAgIHN0YXRlLnJlbmFtZUVudW1JdGVtRGlhbG9nLnNob3dEbGcoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBMMTBuLmxvY2FsaXplU3RhdGljKGlucHV0KTtcclxuICAgICAgICAgICAgYWRkRGVmYXVsdExpc3RlbmVyID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ211bHRpRW51bSc6XHJcbiAgICAgICAgICAgIGlucHV0ID0gcW10ZShgJHt0YWJSb290fSAuZW51bS12YWx1ZS1lZGl0b3ItdG1wbGApO1xyXG4gICAgICAgICAgICBjb25zdCBsaXN0MiA9IHByb2ZpbGVTZXR0aW5ncy52YWx1ZS5zcGxpdCgnLCcpO1xyXG4gICAgICAgICAgICBsaXN0Mi5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGFkZEVscyhxZWUoaW5wdXQsICcudGV4dCcpLCBlbnVtTGlzdDJFbHMobGlzdDIpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGxpc3RlbihxZWUoaW5wdXQsICcuYnRuLmFkZCcpLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBhZGRFbHMoY2xlYXJFbChxZWUoc3RhdGUubXVsdGlFbnVtRWRpdG9yRGlhbG9nLCAnLmluaXRpYWwtdmFsdWUnKSksIGVudW1MaXN0MkVscyhsaXN0MikpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaW5wdXRBcmVhID0gcWVlKHN0YXRlLm11bHRpRW51bUVkaXRvckRpYWxvZywgJy5lbnVtLXZhbHVlLWlucHV0Jyk7XHJcbiAgICAgICAgICAgICAgICBpbnB1dEFyZWEudmFsdWUgPSBsaXN0Mi5qb2luKCcsJyk7XHJcbiAgICAgICAgICAgICAgICBpbnB1dEFyZWEuc3JjTGlzdCA9IGxpc3QyO1xyXG4gICAgICAgICAgICAgICAgc3RhdGUubXVsdGlFbnVtRWRpdG9yRGlhbG9nLml0ZW1OYW1lID0gcHJvZmlsZVNldHRpbmdzLm5hbWU7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5tdWx0aUVudW1FZGl0b3JEaWFsb2cuc2hvd0RsZygpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGxpc3RlbihxZWUoaW5wdXQsICcuYnRuLnJlbmFtZScpLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZW5hbWVTZWxlY3QgPSBjbGVhckVsKHFlZShzdGF0ZS5yZW5hbWVFbnVtSXRlbURpYWxvZywgJy5yZW5hbWVkLXZhbHVlLXNlbGVjdCcpKTtcclxuICAgICAgICAgICAgICAgIGZpbGxTZWxlY3RvcihyZW5hbWVTZWxlY3QsIGFycjJTZWxlY3QobGlzdDIpKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgaWYobGlzdDIubGVuZ3RoID4gMCl7XHJcbiAgICAgICAgICAgICAgICAgICAgcWVlKHN0YXRlLnJlbmFtZUVudW1JdGVtRGlhbG9nLCAnLmVudW0tdmFsdWUtbmFtZS1pbnB1dCcpLnZhbHVlID0gbGlzdDJbMF07IFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5yZW5hbWVFbnVtSXRlbURpYWxvZy5pdGVtTmFtZSA9IHByb2ZpbGVTZXR0aW5ncy5uYW1lO1xyXG4gICAgICAgICAgICAgICAgc3RhdGUucmVuYW1lRW51bUl0ZW1EaWFsb2cuc2hvd0RsZygpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIEwxMG4ubG9jYWxpemVTdGF0aWMoaW5wdXQpO1xyXG4gICAgICAgICAgICBhZGREZWZhdWx0TGlzdGVuZXIgPSBmYWxzZTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnc3RyaW5nJzpcclxuICAgICAgICAgICAgaW5wdXQgPSBtYWtlRWwoJ2lucHV0Jyk7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCAnaGlkZGVuJyk7XHJcbiAgICAgICAgICAgIGlucHV0LnZhbHVlID0gcHJvZmlsZVNldHRpbmdzLnZhbHVlO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgICAgICBpbnB1dCA9IG1ha2VFbCgnaW5wdXQnKTtcclxuICAgICAgICAgICAgaW5wdXQudHlwZSA9ICdudW1iZXInO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICBpbnB1dC52YWx1ZSA9IHByb2ZpbGVTZXR0aW5ncy52YWx1ZTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnY2hlY2tib3gnOlxyXG4gICAgICAgICAgICBpbnB1dCA9IG1ha2VFbCgnaW5wdXQnKTtcclxuICAgICAgICAgICAgc2V0QXR0cihpbnB1dCwgJ3RpdGxlJywgbDEwbignZGVmYXVsdC12YWx1ZScpKTtcclxuICAgICAgICAgICAgaW5wdXQudHlwZSA9ICdjaGVja2JveCc7XHJcbiAgICAgICAgICAgIGlucHV0LmNoZWNrZWQgPSBwcm9maWxlU2V0dGluZ3MudmFsdWU7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcnMuSW50ZXJuYWxFcnJvcignZXJyb3JzLXVuZXhwZWN0ZWQtc3dpdGNoLWFyZ3VtZW50JywgW3Byb2ZpbGVTZXR0aW5ncy50eXBlXSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBzZXRQcm9wcyhpbnB1dCwge1xyXG4gICAgICAgICAgICBpbmZvOiBwcm9maWxlU2V0dGluZ3MubmFtZSxcclxuICAgICAgICAgICAgaW5mb1R5cGU6IHByb2ZpbGVTZXR0aW5ncy50eXBlLFxyXG4gICAgICAgICAgICBvbGRWYWx1ZTogcHJvZmlsZVNldHRpbmdzLnZhbHVlXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYoYWRkRGVmYXVsdExpc3RlbmVyKXtcclxuICAgICAgICAgICAgYWRkQ2xhc3NlcyhpbnB1dCwgW2Bwcm9maWxlLWNvbmZpZ3VyZXItJHtwcm9maWxlU2V0dGluZ3MudHlwZX1gLCAnYWRtaW5Pbmx5JywgJ2Zvcm0tY29udHJvbCddKTtcclxuICAgICAgICAgICAgbGlzdGVuKGlucHV0LCAnY2hhbmdlJywgdXBkYXRlRGVmYXVsdFZhbHVlKHR5cGUpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYWRkRWwocWVlKHJvdywgJy5pdGVtLWRlZmF1bHQtdmFsdWUtY29udGFpbmVyJyksIGlucHV0KTtcclxuXHJcbiAgICAgICAgc2V0Q2xhc3NJZihxZWUocm93LCAnLnByaW50JyksICdidG4tcHJpbWFyeScsIHByb2ZpbGVTZXR0aW5ncy5kb0V4cG9ydCk7XHJcbiAgICAgICAgbGlzdGVuKHFlZShyb3csICcucHJpbnQnKSwgJ2NsaWNrJywgKGUpID0+IHtcclxuICAgICAgICAgICAgREJNUy5kb0V4cG9ydFByb2ZpbGVJdGVtQ2hhbmdlKHR5cGUsIHByb2ZpbGVTZXR0aW5ncy5uYW1lLCAhaGFzQ2xhc3MoZS50YXJnZXQsICdidG4tcHJpbWFyeScpLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgdG9nZ2xlQ2xhc3MoZS50YXJnZXQsICdidG4tcHJpbWFyeScpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgcGxheWVyQWNjZXNzID0gcWVlKHJvdywgJy5wbGF5ZXItYWNjZXNzJyk7XHJcbiAgICAgICAgZmlsbFBsYXllckFjY2Vzc1NlbChwbGF5ZXJBY2Nlc3MpO1xyXG4gICAgICAgIHBsYXllckFjY2Vzcy52YWx1ZSA9IHByb2ZpbGVTZXR0aW5ncy5wbGF5ZXJBY2Nlc3M7XHJcbiAgICAgICAgcGxheWVyQWNjZXNzLmluZm8gPSBwcm9maWxlU2V0dGluZ3MubmFtZTtcclxuICAgICAgICBwbGF5ZXJBY2Nlc3Mub2xkVmFsdWUgPSBwcm9maWxlU2V0dGluZ3MucGxheWVyQWNjZXNzO1xyXG4gICAgICAgIGxpc3RlbihwbGF5ZXJBY2Nlc3MsICdjaGFuZ2UnLCBjaGFuZ2VQcm9maWxlSXRlbVBsYXllckFjY2Vzcyh0eXBlKSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHNob3dJblJvbGVHcmlkID0gcWVlKHJvdywgJy5zaG93LWluLXJvbGUtZ3JpZCcpO1xyXG4gICAgICAgIHNob3dJblJvbGVHcmlkLmNoZWNrZWQgPSBwcm9maWxlU2V0dGluZ3Muc2hvd0luUm9sZUdyaWQ7XHJcbiAgICAgICAgc2hvd0luUm9sZUdyaWQuaW5mbyA9IHByb2ZpbGVTZXR0aW5ncy5uYW1lO1xyXG4gICAgICAgIGxpc3RlbihzaG93SW5Sb2xlR3JpZCwgJ2NoYW5nZScsIHNob3dJblJvbGVHcmlkQ2hhbmdlKHR5cGUpKTtcclxuXHJcbiAgICAgICAgbGlzdGVuKHFlZShyb3csICcubW92ZScpLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHN0YXRlLmN1cnJlbnRJbmRleCA9IGluZGV4O1xyXG4gICAgICAgICAgICBzdGF0ZS5tb3ZlUHJvZmlsZUl0ZW1EaWFsb2cuc2hvd0RsZygpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBsaXN0ZW4ocWVlKHJvdywgJy5yZW5hbWUtcHJvZmlsZS1pdGVtJyksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgcWVlKHN0YXRlLnJlbmFtZVByb2ZpbGVJdGVtRGlhbG9nLCAnLmVudGl0eS1pbnB1dCcpLnZhbHVlID0gcHJvZmlsZVNldHRpbmdzLm5hbWU7XHJcbiAgICAgICAgICAgIHN0YXRlLnJlbmFtZVByb2ZpbGVJdGVtRGlhbG9nLmZyb21OYW1lID0gcHJvZmlsZVNldHRpbmdzLm5hbWU7XHJcbiAgICAgICAgICAgIHN0YXRlLnJlbmFtZVByb2ZpbGVJdGVtRGlhbG9nLnNob3dEbGcoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbGlzdGVuKHFlZShyb3csICcucmVtb3ZlJyksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgVXRpbHMuY29uZmlybShMMTBuLmZvcm1hdCgncHJvZmlsZXMnLCAnYXJlLXlvdS1zdXJlLWFib3V0LXJlbW92aW5nLXByb2ZpbGUtaXRlbScsIFtwcm9maWxlU2V0dGluZ3MubmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLnJlbW92ZVByb2ZpbGVJdGVtKHR5cGUsIGluZGV4LCBwcm9maWxlU2V0dGluZ3MubmFtZSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHJvdztcclxuICAgIH0pO1xyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBlbnVtTGlzdDJFbHMobGlzdCwgZGVmYXVsdFZhbHVlKXtcclxuICAgICAgICByZXR1cm4gUi5zcGxpdEV2ZXJ5KDQsIGxpc3QubWFwKHZhbCA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNwYW4gPSBhZGRFbChtYWtlRWwoJ3NwYW4nKSwgbWFrZVRleHQodmFsKSk7XHJcbiAgICAgICAgICAgIGlmKGRlZmF1bHRWYWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbCA9PT0gZGVmYXVsdFZhbHVlKXtcclxuICAgICAgICAgICAgICAgIGFkZENsYXNzKHNwYW4sICdib2xkJyk7XHJcbiAgICAgICAgICAgICAgICBzZXRBdHRyKHNwYW4sICd0aXRsZScsIGwxMG4oJ2RlZmF1bHQtdmFsdWUnKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYWRkQ2xhc3Moc3BhbiwgJ21hcmdpbi1yaWdodC0xNiBlbnVtLWl0ZW0nKTtcclxuICAgICAgICAgICAgcmV0dXJuIHNwYW47XHJcbiAgICAgICAgfSkpLm1hcChhcnIgPT4gYWRkRWxzKG1ha2VFbCgnZGl2JyksIGFycikpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZURlZmF1bHRWYWx1ZSh0eXBlKSB7XHJcbiAgICAgICAgcmV0dXJuIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lID0gZXZlbnQudGFyZ2V0LmluZm87XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1UeXBlID0gZXZlbnQudGFyZ2V0LmluZm9UeXBlO1xyXG4gICAgICAgICAgICBjb25zdCB7IG9sZFZhbHVlIH0gPSBldmVudC50YXJnZXQ7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGl0ZW1UeXBlID09PSAnY2hlY2tib3gnID8gZXZlbnQudGFyZ2V0LmNoZWNrZWQgOiBldmVudC50YXJnZXQudmFsdWU7XHJcblxyXG4gICAgICAgICAgICBsZXQgbmV3T3B0aW9ucywgbWlzc2VkVmFsdWVzLCBuZXdWYWx1ZSwgdXBkYXRlRW51bTtcclxuXHJcbiAgICAgICAgICAgIHN3aXRjaCAoaXRlbVR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgICAgIGNhc2UgJ2NoZWNrYm94JzpcclxuICAgICAgICAgICAgICAgIERCTVMudXBkYXRlRGVmYXVsdFZhbHVlKHR5cGUsIG5hbWUsIHZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzpcclxuICAgICAgICAgICAgICAgIGlmIChOdW1iZXIuaXNOYU4odmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbigncHJvZmlsZXMtbm90LWEtbnVtYmVyJykpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC52YWx1ZSA9IG9sZFZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIERCTVMudXBkYXRlRGVmYXVsdFZhbHVlKHR5cGUsIG5hbWUsIE51bWJlcih2YWx1ZSksIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdtdWx0aUVudW0nOlxyXG4gICAgICAgICAgICBjYXNlICdlbnVtJzpcclxuICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gJycgJiYgaXRlbVR5cGUgPT09ICdlbnVtJykge1xyXG4gICAgICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ3Byb2ZpbGVzLWVudW0taXRlbS1jYW50LWJlLWVtcHR5JykpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC52YWx1ZSA9IG9sZFZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIG5ld09wdGlvbnMgPSB2YWx1ZS5zcGxpdCgnLCcpLm1hcChSLnRyaW0pO1xyXG4gICAgICAgICAgICAgICAgbWlzc2VkVmFsdWVzID0gb2xkVmFsdWUudHJpbSgpID09PSAnJyA/IFtdIDogUi5kaWZmZXJlbmNlKG9sZFZhbHVlLnNwbGl0KCcsJyksIG5ld09wdGlvbnMpO1xyXG5cclxuICAgICAgICAgICAgICAgIHVwZGF0ZUVudW0gPSAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3VmFsdWUgPSBuZXdPcHRpb25zLmpvaW4oJywnKTtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC50YXJnZXQudmFsdWUgPSBuZXdWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC50YXJnZXQub2xkVmFsdWUgPSBuZXdWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBEQk1TLnVwZGF0ZURlZmF1bHRWYWx1ZSh0eXBlLCBuYW1lLCBuZXdWYWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAobWlzc2VkVmFsdWVzLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIFV0aWxzLmNvbmZpcm0oc3RyRm9ybWF0KGdldEwxMG4oJ3Byb2ZpbGVzLW5ldy1lbnVtLXZhbHVlcy1yZW1vdmUtc29tZS1vbGQtdmFsdWVzJyksIFttaXNzZWRWYWx1ZXMuam9pbignLCcpXSksIHVwZGF0ZUVudW0sICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LnZhbHVlID0gb2xkVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZUVudW0oKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgVXRpbHMuaGFuZGxlRXJyb3IobmV3IEVycm9ycy5JbnRlcm5hbEVycm9yKCdlcnJvcnMtdW5leHBlY3RlZC1zd2l0Y2gtYXJndW1lbnQnLCBbaXRlbVR5cGVdKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNob3dJblJvbGVHcmlkQ2hhbmdlKHR5cGUpIHtcclxuICAgICAgICByZXR1cm4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMuc2hvd0luUm9sZUdyaWRQcm9maWxlSXRlbUNoYW5nZSh0eXBlLCBldmVudC50YXJnZXQuaW5mbywgZXZlbnQudGFyZ2V0LmNoZWNrZWQsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlbmFtZVByb2ZpbGVJdGVtKGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRvSW5wdXQgPSBxZWUoZGlhbG9nLCAnLmVudGl0eS1pbnB1dCcpO1xyXG4gICAgICAgICAgICBjb25zdCBvbGROYW1lID0gZGlhbG9nLmZyb21OYW1lO1xyXG4gICAgICAgICAgICBjb25zdCBuZXdOYW1lID0gdG9JbnB1dC52YWx1ZS50cmltKCk7XHJcblxyXG4gICAgICAgICAgICBEQk1TLnJlbmFtZVByb2ZpbGVJdGVtKHRhYlR5cGUsIG5ld05hbWUsIG9sZE5hbWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRvSW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1vdmVQcm9maWxlSXRlbShkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IHN0YXRlLmN1cnJlbnRJbmRleDtcclxuICAgICAgICAgICAgY29uc3QgbmV3SW5kZXggPSBxdWVyeUVsKGAke3RhYlJvb3R9Lm1vdmUtZW50aXR5LXBvc2l0aW9uLXNlbGVjdGApLnNlbGVjdGVkSW5kZXg7XHJcbiAgICAgICAgICAgIERCTVMubW92ZVByb2ZpbGVJdGVtKHRhYlR5cGUsIGluZGV4LCBuZXdJbmRleCwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEVycm9yKGRpYWxvZywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgZnVuY3Rpb24gdXBkYXRlRW51bVZhbHVlcyhkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lID0gZGlhbG9nLml0ZW1OYW1lO1xyXG4gICAgICAgICAgICBjb25zdCBpbnB1dEFyZWEgPSBxZWUoZGlhbG9nLCAnLmVudW0tdmFsdWUtaW5wdXQnKTtcclxuICAgICAgICAgICAgY29uc3QgZGVmYXVsdFZhbHVlU2VsZWN0ID0gcWVlKGRpYWxvZywgJy5kZWZhdWx0LXZhbHVlLXNlbGVjdCcpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKGlucHV0QXJlYS52YWx1ZS50cmltKCkgPT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hbGVydChnZXRMMTBuKCdwcm9maWxlcy1lbnVtLWl0ZW0tY2FudC1iZS1lbXB0eScpKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgbmV3VmFscyA9IGlucHV0QXJlYS52YWx1ZS5zcGxpdCgnLCcpLm1hcChSLnRyaW0pLmZpbHRlcihSLnBpcGUoUi5lcXVhbHMoJycpLCBSLm5vdCkpO1xyXG4gICAgICAgICAgICBpZihkZWZhdWx0VmFsdWVTZWxlY3Qpe1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGVmYXVsdFZhbHVlID0gZGVmYXVsdFZhbHVlU2VsZWN0LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbmV3VmFscyA9IFIud2l0aG91dChbZGVmYXVsdFZhbHVlXSwgbmV3VmFscyk7XHJcbiAgICAgICAgICAgICAgICBuZXdWYWxzID0gUi5wcmVwZW5kKGRlZmF1bHRWYWx1ZSwgbmV3VmFscyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIERCTVMudXBkYXRlRGVmYXVsdFZhbHVlKHRhYlR5cGUsIG5hbWUsIG5ld1ZhbHMuam9pbignLCcpLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiByZW5hbWVFbnVtVmFsdWUoZGlhbG9nKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbmFtZSA9IGRpYWxvZy5pdGVtTmFtZTtcclxuICAgICAgICAgICAgY29uc3QgcmVuYW1lU2VsZWN0ID0gcWVlKGRpYWxvZywgJy5yZW5hbWVkLXZhbHVlLXNlbGVjdCcpO1xyXG4gICAgICAgICAgICBjb25zdCByZW5hbWVJbnB1dCA9IHFlZShkaWFsb2csICcuZW51bS12YWx1ZS1uYW1lLWlucHV0Jyk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBEQk1TLnJlbmFtZUVudW1WYWx1ZSh0YWJUeXBlLCBuYW1lLCByZW5hbWVTZWxlY3QudmFsdWUudHJpbSgpLCByZW5hbWVJbnB1dC52YWx1ZS50cmltKCksIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZy5oaWRlRGxnKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY2hhbmdlUHJvZmlsZUl0ZW1UeXBlKHR5cGUpIHtcclxuICAgICAgICByZXR1cm4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIFV0aWxzLmNvbmZpcm0oc3RyRm9ybWF0KGdldEwxMG4oJ3Byb2ZpbGVzLWFyZS15b3Utc3VyZS1hYm91dC1jaGFuZ2luZy1wcm9maWxlLWl0ZW0tdHlwZScpLCBbZXZlbnQudGFyZ2V0LmluZm9dKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbmV3VHlwZSA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBldmVudC50YXJnZXQuaW5mbztcclxuICAgICAgICAgICAgICAgIERCTVMuY2hhbmdlUHJvZmlsZUl0ZW1UeXBlKHR5cGUsIG5hbWUsIG5ld1R5cGUsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgICAgICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LnZhbHVlID0gZXZlbnQudGFyZ2V0Lm9sZFR5cGU7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY2hhbmdlUHJvZmlsZUl0ZW1QbGF5ZXJBY2Nlc3ModHlwZSkge1xyXG4gICAgICAgIHJldHVybiAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgcGxheWVyQWNjZXNzVHlwZSA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICAgICAgY29uc3QgbmFtZSA9IGV2ZW50LnRhcmdldC5pbmZvO1xyXG4gICAgICAgICAgICBEQk1TLmNoYW5nZVByb2ZpbGVJdGVtUGxheWVyQWNjZXNzKHR5cGUsIG5hbWUsIHBsYXllckFjY2Vzc1R5cGUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC50YXJnZXQudmFsdWUgPSBldmVudC50YXJnZXQub2xkVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbHMucHJvY2Vzc0Vycm9yKCkoZXJyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxufVxyXG5cclxuUHJvZmlsZUNvbmZpZ3VyZXJUbXBsKHRoaXMuQ2hhcmFjdGVyQ29uZmlndXJlciA9IHt9LCB7XHJcbiAgICB0YWJUeXBlOiAnY2hhcmFjdGVyJyxcclxuICAgIHBhbmVsTmFtZTogJ2NoYXJhY3RlcnMtcHJvZmlsZS1zdHJ1Y3R1cmUnLFxyXG59KTtcclxuXHJcblByb2ZpbGVDb25maWd1cmVyVG1wbCh0aGlzLlBsYXllckNvbmZpZ3VyZXIgPSB7fSwge1xyXG4gICAgdGFiVHlwZTogJ3BsYXllcicsXHJcbiAgICBwYW5lbE5hbWU6ICdwbGF5ZXJzLXByb2ZpbGUtc3RydWN0dXJlJyxcclxufSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTggVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG5mdW5jdGlvbiBQcm9maWxlRWRpdG9yVG1wbChleHBvcnRzLCBvcHRzKSB7XHJcbiAgICBjb25zdCB7IGZpcnN0VHlwZSwgc2Vjb25kVHlwZSwgc2V0dGluZ3NQYXRoIH0gPSBvcHRzO1xyXG5cclxuICAgIGNvbnN0IHRtcGxSb290ID0gJy5wcm9maWxlLWVkaXRvcjItdGFiLXRtcGwnO1xyXG4gICAgY29uc3Qgcm9vdCA9IGAucHJvZmlsZS1lZGl0b3IyLXRhYi4ke2Ake2ZpcnN0VHlwZX0tdHlwZWB9IGA7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG4gICAgY29uc3QgbDEwbiA9IEwxMG4uZ2V0KCdwcm9maWxlcycpO1xyXG4gICAgbGV0IHByb2ZpbGVFZGl0b3JDb3JlO1xyXG4gICAgY29uc3QgcHJvZmlsZVBhbmVsID0gYCR7cm9vdH0ucHJvZmlsZS1wYW5lbGA7XHJcbiAgICBjb25zdCByZXBvcnRCeVN0b3JpZXMgPSBgJHtyb290fS5yZXBvcnQtYnktc3Rvcmllc2A7XHJcbiAgICBjb25zdCByZXBvcnRCeVJlbGF0aW9ucyA9IGAke3Jvb3R9LnJlcG9ydC1ieS1yZWxhdGlvbnNgO1xyXG4gICAgY29uc3QgcHJvZmlsZURpdiA9IGAke3Jvb3R9LnByb2ZpbGUtZGl2YDtcclxuICAgIGNvbnN0IHJlcG9ydEJ5U3Rvcmllc0RpdiA9IGAke3Jvb3R9LnJlcG9ydC1ieS1zdG9yaWVzLWRpdiB0Ym9keWA7XHJcbiAgICBjb25zdCByZXBvcnRCeVJlbGF0aW9uc0RpdiA9IGAke3Jvb3R9LnJlcG9ydC1ieS1yZWxhdGlvbnMtZGl2IHRib2R5YDtcclxuICAgIGNvbnN0IGFsZXJ0QmxvY2sgPSBgJHtyb290fS5hbGVydC1ibG9ja2A7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIHByb2ZpbGVFZGl0b3JDb3JlID0gUHJvZmlsZUVkaXRvckNvcmUubWFrZVByb2ZpbGVFZGl0b3JDb3JlKCk7XHJcbiAgICAgICAgY29uc3QgZWwgPSBxdWVyeUVsKHRtcGxSb290KS5jbG9uZU5vZGUodHJ1ZSk7XHJcblxyXG4gICAgICAgIGFkZENsYXNzZXMoZWwsIFsncHJvZmlsZS1lZGl0b3IyLXRhYicsIGAke2Ake2ZpcnN0VHlwZX0tdHlwZWB9YF0pO1xyXG4gICAgICAgIHJlbW92ZUNsYXNzKGVsLCAncHJvZmlsZS1lZGl0b3IyLXRhYi10bXBsJyk7XHJcbiAgICAgICAgYWRkRWwocXVlcnlFbCgnLnRhYi1jb250YWluZXInKSwgZWwpO1xyXG5cclxuICAgICAgICBjb25zdCBjcmVhdGVDaGFyYWN0ZXJEaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhcclxuICAgICAgICAgICAgYC5wcm9maWxlLWVkaXRvcjItdGFiLiR7YCR7Zmlyc3RUeXBlfS10eXBlYH1gLFxyXG4gICAgICAgICAgICBjcmVhdGVQcm9maWxlLCB7XHJcbiAgICAgICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdtb2RhbC1wcm9tcHQtYm9keScsXHJcbiAgICAgICAgICAgICAgICBkaWFsb2dUaXRsZTogYHByb2ZpbGVzLSR7b3B0cy5jcmVhdGVNc2d9YCxcclxuICAgICAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLWNyZWF0ZScsXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9IC5jcmVhdGVgKSwgJ2NsaWNrJywgKCkgPT4gY3JlYXRlQ2hhcmFjdGVyRGlhbG9nLnNob3dEbGcoKSk7XHJcbiAgICAgICAgc3RhdGUucmVuYW1lQ2hhcmFjdGVyRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2coYC4ke2Ake2ZpcnN0VHlwZX0tdHlwZWB9YCwgcmVuYW1lUHJvZmlsZSwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdtb2RhbC1wcm9tcHQtYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiBgcHJvZmlsZXMtJHtvcHRzLnJlbmFtZU1zZ31gLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1yZW5hbWUnLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBoaWRlRWwocWVlKGVsLCAnLnJlcG9ydC1ieS1zdG9yaWVzJyksIGZpcnN0VHlwZSA9PT0gJ3BsYXllcicpO1xyXG4gICAgICAgIGhpZGVFbChxZWUoZWwsICcucmVwb3J0LWJ5LXJlbGF0aW9ucycpLCBmaXJzdFR5cGUgPT09ICdwbGF5ZXInKTtcclxuICAgICAgICBzZXRBdHRyKHFlZShlbCwgJy5lbnRpdHktZmlsdGVyJyksICdsMTBuLXBsYWNlaG9sZGVyLWlkJywgYHByb2ZpbGVzLSR7b3B0cy5maWx0ZXJQbGFjZWhvbGRlcn1gKTtcclxuICAgICAgICBzZXRBdHRyKHFlZShlbCwgJy5wcm9maWxlLXBhbmVsIGgzJyksICdsMTBuLWlkJywgYHByb2ZpbGVzLSR7b3B0cy5wYW5lbE5hbWV9YCk7XHJcbiAgICAgICAgc2V0QXR0cihxZWUoZWwsICcuY3JlYXRlJyksICdsMTBuLXRpdGxlJywgYHByb2ZpbGVzLSR7b3B0cy5jcmVhdGVQcm9maWxlfWApO1xyXG4gICAgICAgIHNldEF0dHIocWVlKGVsLCAnLmFsZXJ0LWJsb2NrJyksICdsMTBuLWlkJywgYGFkdmljZXMtbm8tJHtmaXJzdFR5cGV9YCk7XHJcbiAgICAgICAgTDEwbi5sb2NhbGl6ZVN0YXRpYyhlbCk7XHJcblxyXG4gICAgICAgIHNldEF0dHIocWVlKGVsLCAnLnJlcG9ydC1ieS1zdG9yaWVzIGEnKSwgJ3BhbmVsLXRvZ2dsZXInLCBgJHtyb290fS5yZXBvcnQtYnktc3Rvcmllcy1kaXZgKTtcclxuICAgICAgICBzZXRBdHRyKHFlZShlbCwgJy5yZXBvcnQtYnktcmVsYXRpb25zIGEnKSwgJ3BhbmVsLXRvZ2dsZXInLCBgJHtyb290fS5yZXBvcnQtYnktcmVsYXRpb25zLWRpdmApO1xyXG4gICAgICAgIHNldEF0dHIocWVlKGVsLCAnLnByb2ZpbGUtcGFuZWwgYScpLCAncGFuZWwtdG9nZ2xlcicsIGAke3Jvb3R9LnByb2ZpbGUtZGl2YCk7XHJcbiAgICAgICAgVUkuaW5pdFBhbmVsVG9nZ2xlcnMoZWwpO1xyXG5cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBlbDtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fSAuZW50aXR5LWZpbHRlcmApLCAnaW5wdXQnLCBmaWx0ZXJPcHRpb25zKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KGZpcnN0VHlwZSwgZmFsc2UsIChlcnIsIHByaW1hcnlOYW1lcykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheShzZWNvbmRUeXBlLCBmYWxzZSwgKGVycjIsIHNlY29uZGFyeU5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBEQk1TLmdldFByb2ZpbGVCaW5kaW5ncygoZXJyMywgcHJvZmlsZUJpbmRpbmdzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycjMpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMyk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIHByb2ZpbGVCaW5kaW5ncyA9IG9wdHMucHJvY2Vzc0JpbmRpbmdzKHByb2ZpbGVCaW5kaW5ncyk7XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwocXVlcnlFbChgJHtyb290fS5lbnRpdHktZmlsdGVyYCksIHByaW1hcnlOYW1lcy5sZW5ndGggPiAwKTtcclxuICAgICAgICAgICAgICAgICAgICByZWJ1aWxkSW50ZXJmYWNlKHByaW1hcnlOYW1lcywgc2Vjb25kYXJ5TmFtZXMsIHByb2ZpbGVCaW5kaW5ncyk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIHJlYnVpbGRJbnRlcmZhY2UocHJpbWFyeU5hbWVzLCBzZWNvbmRhcnlOYW1lcywgcHJvZmlsZUJpbmRpbmdzKSB7XHJcbiAgICAgICAgY29uc3Qgc2VjRGljdCA9IFIuaW5kZXhCeShSLnByb3AoJ3ZhbHVlJyksIHNlY29uZGFyeU5hbWVzKTtcclxuICAgICAgICBhZGRFbHMoY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9IC5lbnRpdHktbGlzdGApKSwgcHJpbWFyeU5hbWVzLm1hcCgobmFtZSwgaSwgYXJyKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVsID0gd3JhcEVsKCdkaXYnLCBxdGUoYCR7cm9vdH0gLmVudGl0eS1pdGVtLXRtcGxgKSk7XHJcbiAgICAgICAgICAgIGFkZEVsKHFlZShlbCwgJy5wcmltYXJ5LW5hbWUnKSwgbWFrZVRleHQobmFtZS5kaXNwbGF5TmFtZSkpO1xyXG4gICAgICAgICAgICBzZXRBdHRyKGVsLCAncHJpbWFyeS1uYW1lJywgbmFtZS5kaXNwbGF5TmFtZSk7XHJcbiAgICAgICAgICAgIHNldEF0dHIoZWwsICdwcm9maWxlLW5hbWUnLCBuYW1lLnZhbHVlKTtcclxuICAgICAgICAgICAgaWYgKHByb2ZpbGVCaW5kaW5nc1tuYW1lLnZhbHVlXSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzZWNvbmRhcnlOYW1lID0gc2VjRGljdFtwcm9maWxlQmluZGluZ3NbbmFtZS52YWx1ZV1dLmRpc3BsYXlOYW1lO1xyXG4gICAgICAgICAgICAgICAgYWRkRWwocWVlKGVsLCAnLnNlY29uZGFyeS1uYW1lJyksIG1ha2VUZXh0KHNlY29uZGFyeU5hbWUpKTtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIoZWwsICdzZWNvbmRhcnktbmFtZScsIHNlY29uZGFyeU5hbWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxpc3RlbihxZWUoZWwsICcuc2VsZWN0LWJ1dHRvbicpLCAnY2xpY2snLCAoKSA9PiBzZWxlY3RQcm9maWxlKG5hbWUudmFsdWUpKTtcclxuICAgICAgICAgICAgc2V0QXR0cihxZWUoZWwsICcucmVuYW1lJyksICd0aXRsZScsIGwxMG4ob3B0cy5yZW5hbWVQcm9maWxlKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlbW92ZUJ0biA9IHFlZShlbCwgJy5yZW1vdmUnKTtcclxuICAgICAgICAgICAgc2V0QXR0cihyZW1vdmVCdG4sICd0aXRsZScsIGwxMG4ob3B0cy5yZW1vdmVQcm9maWxlKSk7XHJcbiAgICAgICAgICAgIGlmKGkrMSA8IGFyci5sZW5ndGgpe1xyXG4gICAgICAgICAgICAgICAgcmVtb3ZlQnRuLm5leHROYW1lID0gYXJyW2krMV0udmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYoaSA+IDApe1xyXG4gICAgICAgICAgICAgICAgcmVtb3ZlQnRuLnByZXZOYW1lID0gYXJyW2ktMV0udmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG5hbWUuZWRpdGFibGUpIHtcclxuICAgICAgICAgICAgICAgIGxpc3RlbihxZWUoZWwsICcucmVuYW1lJyksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBxZWUoc3RhdGUucmVuYW1lQ2hhcmFjdGVyRGlhbG9nLCAnLmVudGl0eS1pbnB1dCcpLnZhbHVlID0gbmFtZS52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5yZW5hbWVDaGFyYWN0ZXJEaWFsb2cuZnJvbU5hbWUgPSBuYW1lLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnJlbmFtZUNoYXJhY3RlckRpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGxpc3RlbihyZW1vdmVCdG4sICdjbGljaycsIHJlbW92ZVByb2ZpbGUoZmlyc3RUeXBlLCBuYW1lLnZhbHVlLCByZW1vdmVCdG4pKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIocWVlKGVsLCAnLnJlbmFtZScpLCAnZGlzYWJsZWQnLCAnZGlzYWJsZWQnKTtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIocmVtb3ZlQnRuLCAnZGlzYWJsZWQnLCAnZGlzYWJsZWQnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZWw7XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICBjb25zdCBjYWxsYmFjayA9ICgpID0+IHtcclxuICAgICAgICAgICAgc2VsZWN0UHJvZmlsZShVSS5jaGVja0FuZEdldEVudGl0eVNldHRpbmcoc2V0dGluZ3NQYXRoLCBwcmltYXJ5TmFtZXMpKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIERCTVMuZ2V0UHJvZmlsZVN0cnVjdHVyZShmaXJzdFR5cGUsIChlcnIyLCBhbGxQcm9maWxlU2V0dGluZ3MpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBwcm9maWxlRWRpdG9yQ29yZS5pbml0UHJvZmlsZVN0cnVjdHVyZShwcm9maWxlRGl2LCBmaXJzdFR5cGUsIGFsbFByb2ZpbGVTZXR0aW5ncywgY2FsbGJhY2spO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNlbGVjdFByb2ZpbGUobmFtZSkge1xyXG4gICAgICAgIGhpZGVFbChxdWVyeUVsKHByb2ZpbGVQYW5lbCksIG5hbWUgPT09IG51bGwpO1xyXG4gICAgICAgIGhpZGVFbChxdWVyeUVsKHJlcG9ydEJ5U3RvcmllcyksIG5hbWUgPT09IG51bGwgfHwgZmlyc3RUeXBlID09PSAncGxheWVyJyk7XHJcbiAgICAgICAgaGlkZUVsKHF1ZXJ5RWwocmVwb3J0QnlSZWxhdGlvbnMpLCBuYW1lID09PSBudWxsIHx8IGZpcnN0VHlwZSA9PT0gJ3BsYXllcicpO1xyXG4gICAgICAgIGhpZGVFbChxdWVyeUVsKGFsZXJ0QmxvY2spLCBuYW1lICE9PSBudWxsKTtcclxuICAgICAgICBcclxuICAgICAgICBpZihuYW1lID09PSBudWxsKXtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBVSS51cGRhdGVFbnRpdHlTZXR0aW5nKHNldHRpbmdzUGF0aCwgbmFtZSk7XHJcbiAgICAgICAgcXVlcnlFbHMoYCR7cm9vdH0gW3Byb2ZpbGUtbmFtZV0gLnNlbGVjdC1idXR0b25gKS5tYXAocmVtb3ZlQ2xhc3MoUi5fXywgJ2J0bi1wcmltYXJ5JykpO1xyXG4gICAgICAgIGNvbnN0IGVsID0gcXVlcnlFbChgJHtyb290fSBbcHJvZmlsZS1uYW1lPVwiJHtuYW1lfVwiXSAuc2VsZWN0LWJ1dHRvbmApO1xyXG4gICAgICAgIGFkZENsYXNzKGVsLCAnYnRuLXByaW1hcnknKTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBwYXJlbnRFbCA9IGVsLnBhcmVudEVsZW1lbnQucGFyZW50RWxlbWVudDtcclxuICAgICAgICBjb25zdCBlbnRpdHlMaXN0ID0gcXVlcnlFbChgJHtyb290fSAuZW50aXR5LWxpc3RgKTtcclxuICAgICAgICBVSS5zY3JvbGxUbyhlbnRpdHlMaXN0LCBwYXJlbnRFbCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgREJNUy5nZXRQcm9maWxlKGZpcnN0VHlwZSwgbmFtZSwgKGVyciwgcHJvZmlsZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuaXNFbnRpdHlFZGl0YWJsZShmaXJzdFR5cGUsIG5hbWUsIChlcnIyLCBpc1Byb2ZpbGVFZGl0YWJsZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3MocXVlcnlFbChwcm9maWxlRGl2KSwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgcHJvZmlsZUVkaXRvckNvcmUuZmlsbFByb2ZpbGVJbmZvcm1hdGlvbihwcm9maWxlRGl2LCBmaXJzdFR5cGUsIHByb2ZpbGUsICgpID0+IGlzUHJvZmlsZUVkaXRhYmxlKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoZmlyc3RUeXBlID09PSAnY2hhcmFjdGVyJykge1xyXG4gICAgICAgICAgICAgICAgICAgIERCTVMuZ2V0Q2hhcmFjdGVyUmVwb3J0KG5hbWUsIChlcnIzLCBjaGFyYWN0ZXJSZXBvcnQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjMpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMyk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBEQk1TLmdldFJlbGF0aW9uc1N1bW1hcnkobmFtZSwgKGVycjQsIHJlbGF0aW9uc1N1bW1hcnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnI0KSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjQpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGlkZUVsKHF1ZXJ5RWwoYCR7cmVwb3J0QnlTdG9yaWVzfSAuYWxlcnRgKSwgY2hhcmFjdGVyUmVwb3J0Lmxlbmd0aCAhPT0gMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoaWRlRWwocXVlcnlFbChgJHtyZXBvcnRCeVN0b3JpZXN9IHRhYmxlYCksIGNoYXJhY3RlclJlcG9ydC5sZW5ndGggPT09IDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihjaGFyYWN0ZXJSZXBvcnQubGVuZ3RoICE9PSAwKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhxdWVyeUVsKHJlcG9ydEJ5U3Rvcmllc0RpdiksICdoaWRkZW4nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFbHMoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwocmVwb3J0QnlTdG9yaWVzRGl2KSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFyYWN0ZXJSZXBvcnQubWFwKENoYXJhY3RlclJlcG9ydHMubWFrZVN0b3J5UmVwb3J0Um93KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhpZGVFbChxdWVyeUVsKGAke3JlcG9ydEJ5UmVsYXRpb25zfSAuYWxlcnRgKSwgcmVsYXRpb25zU3VtbWFyeS5yZWxhdGlvbnMubGVuZ3RoICE9PSAwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhpZGVFbChxdWVyeUVsKGAke3JlcG9ydEJ5UmVsYXRpb25zfSB0YWJsZWApLCByZWxhdGlvbnNTdW1tYXJ5LnJlbGF0aW9ucy5sZW5ndGggPT09IDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihyZWxhdGlvbnNTdW1tYXJ5LnJlbGF0aW9ucy5sZW5ndGggIT09IDApe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKHF1ZXJ5RWwocmVwb3J0QnlSZWxhdGlvbnNEaXYpLCAnaGlkZGVuJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRpb25zU3VtbWFyeS5yZWxhdGlvbnMuc29ydChDb21tb25VdGlscy5jaGFyT3JkQUZhY3RvcnkocmVsID0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQcm9qZWN0VXRpbHMuZ2V0Mm5kUmVsQ2hhcihuYW1lLCByZWwpLnRvTG93ZXJDYXNlKCkpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFbHMoY2xlYXJFbChxdWVyeUVsKHJlcG9ydEJ5UmVsYXRpb25zRGl2KSksIHJlbGF0aW9uc1N1bW1hcnkucmVsYXRpb25zXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwKENoYXJhY3RlclJlcG9ydHMubWFrZVJlbGF0aW9uUmVwb3J0Um93KG5hbWUpKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBmaWx0ZXJPcHRpb25zKGV2ZW50KSB7XHJcbiAgICAgICAgY29uc3Qgc3RyID0gZXZlbnQudGFyZ2V0LnZhbHVlLnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGVscyA9IHF1ZXJ5RWxzKGAke3Jvb3R9IFtwcmltYXJ5LW5hbWVdYCk7XHJcbiAgICAgICAgZWxzLmZvckVhY2goKGVsKSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBpc1Zpc2libGUgPSBnZXRBdHRyKGVsLCAncHJpbWFyeS1uYW1lJykudG9Mb3dlckNhc2UoKS5pbmRleE9mKHN0cikgIT09IC0xO1xyXG4gICAgICAgICAgICBpZiAoIWlzVmlzaWJsZSAmJiBnZXRBdHRyKGVsLCAnc2Vjb25kYXJ5LW5hbWUnKSAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgaXNWaXNpYmxlID0gZ2V0QXR0cihlbCwgJ3NlY29uZGFyeS1uYW1lJykudG9Mb3dlckNhc2UoKS5pbmRleE9mKHN0cikgIT09IC0xO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGhpZGVFbChlbCwgIWlzVmlzaWJsZSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGlmIChxdWVyeUVsKGAke3Jvb3R9IC5oaWRkZW5bcHJpbWFyeS1uYW1lXSAuc2VsZWN0LWJ1dHRvbi5idG4tcHJpbWFyeWApICE9PSBudWxsIHx8XHJcbiAgICAgICAgICAgIHF1ZXJ5RWwoYCR7cm9vdH0gW3ByaW1hcnktbmFtZV0gLnNlbGVjdC1idXR0b24uYnRuLXByaW1hcnlgKSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICBjb25zdCBlbHMyID0gcXVlcnlFbHMoYCR7cm9vdH0gW3ByaW1hcnktbmFtZV1gKS5maWx0ZXIoUi5waXBlKGhhc0NsYXNzKFIuX18sICdoaWRkZW4nKSwgUi5ub3QpKTtcclxuICAgICAgICAgICAgc2VsZWN0UHJvZmlsZShlbHMyLmxlbmd0aCA+IDAgPyBnZXRBdHRyKGVsczJbMF0sICdwcm9maWxlLW5hbWUnKSA6IG51bGwpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgcXVlcnlFbChgJHtyb290fSBbcHJpbWFyeS1uYW1lXSAuc2VsZWN0LWJ1dHRvbi5idG4tcHJpbWFyeWApLnNjcm9sbEludG9WaWV3KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZVByb2ZpbGUoZGlhbG9nKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaW5wdXQgPSBxZWUoZGlhbG9nLCAnLmVudGl0eS1pbnB1dCcpO1xyXG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGlucHV0LnZhbHVlLnRyaW0oKTtcclxuXHJcbiAgICAgICAgICAgIERCTVMuY3JlYXRlUHJvZmlsZShmaXJzdFR5cGUsIHZhbHVlLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBVSS51cGRhdGVFbnRpdHlTZXR0aW5nKHNldHRpbmdzUGF0aCwgdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5yZWZyZXNoKChlcnIyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVuYW1lUHJvZmlsZShkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0b0lucHV0ID0gcWVlKGRpYWxvZywgJy5lbnRpdHktaW5wdXQnKTtcclxuICAgICAgICAgICAgY29uc3QgeyBmcm9tTmFtZSB9ID0gZGlhbG9nO1xyXG4gICAgICAgICAgICBjb25zdCB0b05hbWUgPSB0b0lucHV0LnZhbHVlLnRyaW0oKTtcclxuXHJcbiAgICAgICAgICAgIERCTVMucmVuYW1lUHJvZmlsZShmaXJzdFR5cGUsIGZyb21OYW1lLCB0b05hbWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIFVJLnVwZGF0ZUVudGl0eVNldHRpbmcoc2V0dGluZ3NQYXRoLCB0b05hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRvSW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlbW92ZVByb2ZpbGUodHlwZSwgbmFtZSwgYnRuKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQobDEwbihvcHRzLnJlbW92ZU1zZyksIFtuYW1lXSksICgpID0+IHtcclxuICAgICAgICAgICAgICAgIERCTVMucmVtb3ZlUHJvZmlsZSh0eXBlLCBuYW1lLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIucmVmcmVzaCgoZXJyMikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGJ0bi5uZXh0TmFtZSAhPT0gdW5kZWZpbmVkKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVJLnVwZGF0ZUVudGl0eVNldHRpbmcoc2V0dGluZ3NQYXRoLCBidG4ubmV4dE5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoYnRuLnByZXZOYW1lICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVJLnVwZGF0ZUVudGl0eVNldHRpbmcoc2V0dGluZ3NQYXRoLCBidG4ucHJldk5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG59XHJcblxyXG5Qcm9maWxlRWRpdG9yVG1wbCh0aGlzLkNoYXJhY3RlckVkaXRvciA9IHt9LCB7XHJcbiAgICBmaXJzdFR5cGU6ICdjaGFyYWN0ZXInLFxyXG4gICAgc2Vjb25kVHlwZTogJ3BsYXllcicsXHJcbiAgICBzZXR0aW5nc1BhdGg6ICdDaGFyYWN0ZXJzJyxcclxuICAgIHByb2Nlc3NCaW5kaW5nczogUi5pZGVudGl0eSxcclxuICAgIGNyZWF0ZU1zZzogJ2VudGVyLWNoYXJhY3Rlci1uYW1lJyxcclxuICAgIHJlbmFtZU1zZzogJ2VudGVyLW5ldy1jaGFyYWN0ZXItbmFtZScsXHJcbiAgICByZW1vdmVNc2c6ICdhcmUteW91LXN1cmUtYWJvdXQtY2hhcmFjdGVyLXJlbW92aW5nJyxcclxuICAgIGZpbHRlclBsYWNlaG9sZGVyOiAnZmluZC1jaGFyYWN0ZXInLFxyXG4gICAgcGFuZWxOYW1lOiAnY2hhcmFjdGVyLXByb2ZpbGUnLFxyXG4gICAgY3JlYXRlUHJvZmlsZTogJ2NyZWF0ZS1jaGFyYWN0ZXInLFxyXG4gICAgcmVuYW1lUHJvZmlsZTogJ3JlbmFtZS1jaGFyYWN0ZXInLFxyXG4gICAgcmVtb3ZlUHJvZmlsZTogJ3JlbW92ZS1jaGFyYWN0ZXInLFxyXG59KTtcclxuXHJcblByb2ZpbGVFZGl0b3JUbXBsKHRoaXMuUGxheWVyRWRpdG9yID0ge30sIHtcclxuICAgIGZpcnN0VHlwZTogJ3BsYXllcicsXHJcbiAgICBzZWNvbmRUeXBlOiAnY2hhcmFjdGVyJyxcclxuICAgIHNldHRpbmdzUGF0aDogJ1BsYXllcnMnLFxyXG4gICAgcHJvY2Vzc0JpbmRpbmdzOiBSLmludmVydE9iaixcclxuICAgIGNyZWF0ZU1zZzogJ2VudGVyLXBsYXllci1uYW1lJyxcclxuICAgIHJlbmFtZU1zZzogJ2VudGVyLW5ldy1wbGF5ZXItbmFtZScsXHJcbiAgICByZW1vdmVNc2c6ICdhcmUteW91LXN1cmUtYWJvdXQtcGxheWVyLXJlbW92aW5nJyxcclxuICAgIGZpbHRlclBsYWNlaG9sZGVyOiAnZmluZC1wbGF5ZXInLFxyXG4gICAgcGFuZWxOYW1lOiAncGxheWVyLXByb2ZpbGUnLFxyXG4gICAgY3JlYXRlUHJvZmlsZTogJ2NyZWF0ZS1wbGF5ZXInLFxyXG4gICAgcmVuYW1lUHJvZmlsZTogJ3JlbmFtZS1wbGF5ZXInLFxyXG4gICAgcmVtb3ZlUHJvZmlsZTogJ3JlbW92ZS1wbGF5ZXInLFxyXG59KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgcm9vdCA9ICcucm9sZS1ncmlkLXRhYiAnO1xyXG4gICAgbGV0IGdyb3VwaW5nT3JkZXI7XHJcbiAgICBsZXQgcHJvZmlsZXNEYXRhO1xyXG4gICAgbGV0IGJ1dHRvbnM7XHJcbiAgICBjb25zdCBsMTBuID0gTDEwbi5nZXQoJ3JvbGUtZ3JpZCcpO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgREJNUy5nZXRSb2xlR3JpZEluZm8oKGVyciwgZGF0YTIpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgZ3JvdXBpbmdPcmRlciA9IFtdO1xyXG4gICAgICAgICAgICBidXR0b25zID0gW107XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBzaG93RWwocWUoYCR7cm9vdH0gLmFsZXJ0Lm5vLWNoYXJhY3Rlci1wcm9maWxlYCksIGRhdGEyLmNoYXJhY3RlclByb2ZpbGVTdHJ1Y3R1cmUubGVuZ3RoID09PSAwKTtcclxuICAgICAgICAgICAgc2hvd0VsKHFlKGAke3Jvb3R9IC5hbGVydC5uby1jaGFyYWN0ZXJzYCksIGRhdGEyLnByb2ZpbGVEYXRhLmxlbmd0aCA9PT0gMCk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBzaG93RWwocWUoYCR7cm9vdH0gPiAuY29udGFpbmVyLWZsdWlkYCksIGRhdGEyLnByb2ZpbGVEYXRhLmxlbmd0aCAhPT0gMCAmJiBkYXRhMi5jaGFyYWN0ZXJQcm9maWxlU3RydWN0dXJlLmxlbmd0aCAhPT0gMCk7XHJcblxyXG4gICAgICAgICAgICAvLyBoYWNrIC0gZHluYW1pY2FsbHkgcmVwbGFjZSBjaGVja2JveCB3aXRoIGVudW1cclxuICAgICAgICAgICAgY29uc3QgY2hlY2tib3hlcyA9IGRhdGEyLmNoYXJhY3RlclByb2ZpbGVTdHJ1Y3R1cmUuZmlsdGVyKGVsID0+IGVsLnR5cGUgPT09ICdjaGVja2JveCcpLm1hcChSLnByb3AoJ25hbWUnKSk7XHJcbiAgICAgICAgICAgIGRhdGEyLmNoYXJhY3RlclByb2ZpbGVTdHJ1Y3R1cmUgPSBkYXRhMi5jaGFyYWN0ZXJQcm9maWxlU3RydWN0dXJlLm1hcCgoZWwpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlbC50eXBlID09PSAnY2hlY2tib3gnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9FeHBvcnQ6IGVsLmRvRXhwb3J0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBlbC5uYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXJBY2Nlc3M6IGVsLnBsYXllckFjY2VzcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2hvd0luUm9sZUdyaWQ6IGVsLnNob3dJblJvbGVHcmlkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnZW51bScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBbTDEwbi5nZXQoJ2NvbnN0YW50JywgJ3llcycpLCBMMTBuLmdldCgnY29uc3RhbnQnLCAnbm8nKV0uam9pbignLCcpLFxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZWw7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBwcm9maWxlc0RhdGEgPSBkYXRhMjtcclxuICAgICAgICAgICAgZGF0YTIucHJvZmlsZURhdGEuZm9yRWFjaCgoZWwpID0+IHtcclxuICAgICAgICAgICAgICAgIGNoZWNrYm94ZXMuZm9yRWFjaCgobmFtZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGVsLmNoYXJhY3RlcltuYW1lXSA9IEwxMG4uZ2V0KCdjb25zdGFudCcsIGVsLmNoYXJhY3RlcltuYW1lXSA9PT0gdHJ1ZSA/ICd5ZXMnIDogJ25vJyk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBzb3J0ZXIgPSBDb21tb25VdGlscy5jaGFyT3JkQUZhY3RvcnkoYSA9PiBhLnRvTG93ZXJDYXNlKCkpO1xyXG4gICAgICAgICAgICBjb25zdCBmaWx0ZXIgPSBlbCA9PiBlbC50eXBlID09PSAnZW51bSc7XHJcbiAgICAgICAgICAgIGNvbnN0IGdyb3VwaW5nSXRlbXMgPSBwcm9maWxlc0RhdGEuY2hhcmFjdGVyUHJvZmlsZVN0cnVjdHVyZS5maWx0ZXIoZmlsdGVyKS5tYXAoUi5wcm9wKCduYW1lJykpLnNvcnQoc29ydGVyKTtcclxuXHJcbiAgICAgICAgICAgIGFkZEVscyhjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uYnV0dG9uLWNvbnRhaW5lcmApKSwgZ3JvdXBpbmdJdGVtcy5tYXAoKGl0ZW0sIGkpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGJ1dHRvbiA9IGFkZEVsKG1ha2VFbCgnYScpLCBtYWtlVGV4dChpdGVtKSk7XHJcbiAgICAgICAgICAgICAgICBidXR0b24uaXRlbSA9IGl0ZW07XHJcbiAgICAgICAgICAgICAgICBzZXRBdHRyKGJ1dHRvbiwgJ2RyYWdnYWJsZScsICd0cnVlJyk7XHJcbiAgICAgICAgICAgICAgICBzZXRBdHRyKGJ1dHRvbiwgJ3JvbGUnLCAnYnV0dG9uJyk7XHJcbiAgICAgICAgICAgICAgICBzZXRBdHRyKGJ1dHRvbiwgJ2hyZWYnLCAnIycpO1xyXG4gICAgICAgICAgICAgICAgc2V0QXR0cihidXR0b24sICdvcmRlcicsIGkgKyAxKTtcclxuICAgICAgICAgICAgICAgIHNldFN0eWxlKGJ1dHRvbiwgJ29yZGVyJywgaSArIDEpO1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3NlcyhidXR0b24sIFsnYnRuJywgJ2J0bi1kZWZhdWx0J10pO1xyXG4gICAgICAgICAgICAgICAgbGlzdGVuKGJ1dHRvbiwgJ2RyYWdzdGFydCcsIG9uRHJhZ1N0YXJ0KTtcclxuICAgICAgICAgICAgICAgIGxpc3RlbihidXR0b24sICdkcm9wJywgb25Ecm9wKTtcclxuICAgICAgICAgICAgICAgIGxpc3RlbihidXR0b24sICdkcmFnb3ZlcicsIGFsbG93RHJvcCk7XHJcbiAgICAgICAgICAgICAgICBsaXN0ZW4oYnV0dG9uLCAnZHJhZ2VudGVyJywgaGFuZGxlRHJhZ0VudGVyKTtcclxuICAgICAgICAgICAgICAgIGxpc3RlbihidXR0b24sICdkcmFnbGVhdmUnLCBoYW5kbGVEcmFnTGVhdmUpO1xyXG4gICAgICAgICAgICAgICAgbGlzdGVuKGJ1dHRvbiwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRvZ2dsZUNsYXNzKGJ1dHRvbiwgJ2J0bi1wcmltYXJ5Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgZHJhd0xpc3QoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgYnV0dG9ucy5wdXNoKGJ1dHRvbik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYnV0dG9uO1xyXG4gICAgICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgICAgICBkcmF3TGlzdCgpO1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgIGRyYXdQbGFpblBhbmVsTGlzdCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgb25EcmFnU3RhcnQgPSBmdW5jdGlvbiAoZXZlbnQpe1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGBvbkRyYWdTdGFydCAke3RoaXMuaXRlbX1gKTtcclxuICAgICAgICBldmVudC5kYXRhVHJhbnNmZXIuc2V0RGF0YSgnZGF0YScsIEpTT04uc3RyaW5naWZ5KHsgaXRlbTogdGhpcy5pdGVtLCBvcmRlcjogZ2V0QXR0cih0aGlzLCAnb3JkZXInKSB9KSk7XHJcbiAgICAgICAgZXZlbnQuZGF0YVRyYW5zZmVyLmVmZmVjdEFsbG93ZWQgPSAnbW92ZSc7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBvbkRyb3AgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhgb25Ecm9wICR7dGhpcy5pdGVtfSR7ZXZlbnQuZGF0YVRyYW5zZmVyLmdldERhdGEoJ2RhdGEnKX1gKTtcclxuICAgICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSB7XHJcbiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOyAvLyBzdG9wcyB0aGUgYnJvd3NlciBmcm9tIHJlZGlyZWN0aW5nLlxyXG4gICAgICAgIH1cclxuICAgICAgICB1cGRhdGVCdXR0b25zKEpTT04ucGFyc2UoZXZlbnQuZGF0YVRyYW5zZmVyLmdldERhdGEoJ2RhdGEnKSksIHsgaXRlbTogdGhpcy5pdGVtLCBvcmRlcjogZ2V0QXR0cih0aGlzLCAnb3JkZXInKSB9KTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIGFsbG93RHJvcCA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGBhbGxvd0Ryb3AgJHt0aGlzLml0ZW19YCk7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gaGFuZGxlRHJhZ0VudGVyKGV2ZW50KSB7XHJcbiAgICAgICAgYWRkQ2xhc3ModGhpcywgJ292ZXInKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBoYW5kbGVEcmFnTGVhdmUoZXZlbnQpIHtcclxuICAgICAgICByZW1vdmVDbGFzcyh0aGlzLCAnb3ZlcicpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciB1cGRhdGVCdXR0b25zID0gKGRyYWdTdGFydGVyLCBkcmFnUmVjZWl2ZXIpID0+IHtcclxuICAgICAgICBjb25zdCBzdGFydE9yZGVyID0gTnVtYmVyKGRyYWdTdGFydGVyLm9yZGVyKSAtIDE7XHJcbiAgICAgICAgY29uc3QgcmVjZWl2ZU9yZGVyID0gTnVtYmVyKGRyYWdSZWNlaXZlci5vcmRlcikgLSAxO1xyXG4gICAgICAgIGNvbnN0IGJ1dHRvbiA9IGJ1dHRvbnMuc3BsaWNlKHN0YXJ0T3JkZXIsIDEpWzBdO1xyXG4gICAgICAgIGJ1dHRvbnMgPSBSLmluc2VydChyZWNlaXZlT3JkZXIsIGJ1dHRvbiwgYnV0dG9ucyk7XHJcbiAgICAgICAgYnV0dG9ucy5mb3JFYWNoKChidXR0b24yLCBpKSA9PiB7XHJcbiAgICAgICAgICAgIHNldEF0dHIoYnV0dG9uMiwgJ29yZGVyJywgaSArIDEpO1xyXG4gICAgICAgICAgICBzZXRTdHlsZShidXR0b24yLCAnb3JkZXInLCBpICsgMSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgZHJhd0xpc3QoKTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIGRyYXdMaXN0ID0gKCkgPT4ge1xyXG4gICAgICAgIGdyb3VwaW5nT3JkZXIgPSBidXR0b25zLmZpbHRlcihoYXNDbGFzcyhSLl9fLCAnYnRuLXByaW1hcnknKSkubWFwKFIucHJvcCgnaXRlbScpKTtcclxuICAgICAgICBkcmF3R3JvdXBlZExpc3QoKGdyb3VwaW5nT3JkZXIubGVuZ3RoID4gMCkgPyBnZXRUcmVlQnlVc2VyU2VsZWN0KCkgOiBnZXRUcmVlQnlBbHBoYWJldCgpKTtcclxuICAgICAgICAvLyAgICAgICAgKGdyb3VwaW5nT3JkZXIubGVuZ3RoID4gMCkgPyBkcmF3R3JvdXBlZExpc3QoKSA6IGRyYXdQbGFpblBhbmVsTGlzdCgpO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgZ2V0VHJlZUJ5QWxwaGFiZXQgPSAoKSA9PlxyXG4gICAgICAgIC8vICAgICAgICB2YXIgZ3JvdXBzID0gUi5ncm91cEJ5KChwcm9maWxlKSA9PiB7XHJcbiAgICAgICAgLy8gICAgICAgICAgICByZXR1cm4gcHJvZmlsZS5jaGFyYWN0ZXJOYW1lWzBdO1xyXG4gICAgICAgIC8vICAgICAgICB9LCBwcm9maWxlc0RhdGEucHJvZmlsZURhdGEpO1xyXG4gICAgICAgIC8vXHJcbiAgICAgICAgLy8gICAgICAgIHZhciBzdHJ1Y3R1cmVzID0gUi50b1BhaXJzKGdyb3VwcykubWFwKHBhaXIgPT4gKHtcclxuICAgICAgICAvLyAgICAgICAgICAgIGtleTogcGFpclswXSxcclxuICAgICAgICAvLyAgICAgICAgICAgIGxhc3RLZXlQYXJ0OiBwYWlyWzBdLFxyXG4gICAgICAgIC8vICAgICAgICAgICAgZ3JvdXBzOiBwYWlyWzFdXHJcbiAgICAgICAgLy8gICAgICAgIH0pKTtcclxuICAgICAgICAvL1xyXG4gICAgICAgIC8vICAgICAgICBzdHJ1Y3R1cmVzLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEFGYWN0b3J5KFIucHJvcCgna2V5JykpKTtcclxuICAgICAgICAvLyAgICAgICAgcmV0dXJuIHN0cnVjdHVyZXM7XHJcbiAgICAgICAgW3tcclxuICAgICAgICAgICAga2V5OiBsMTBuKCdhbGwtY2hhcmFjdGVycycpLFxyXG4gICAgICAgICAgICBsYXN0S2V5UGFydDogbDEwbignYWxsLWNoYXJhY3RlcnMnKSxcclxuICAgICAgICAgICAgZ3JvdXBzOiBwcm9maWxlc0RhdGEucHJvZmlsZURhdGFcclxuICAgICAgICB9XTtcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgZ2V0VHJlZUJ5VXNlclNlbGVjdCA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBncm91cHMgPSBSLmdyb3VwQnkocHJvZmlsZSA9PiBncm91cGluZ09yZGVyLm1hcChuYW1lID0+IHByb2ZpbGUuY2hhcmFjdGVyW25hbWVdKS5qb2luKCcvJyksIHByb2ZpbGVzRGF0YS5wcm9maWxlRGF0YSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGdyb3VwaW5nSXRlbUluZm8gPSBSLmluZGV4QnkoUi5wcm9wKCduYW1lJyksIHByb2ZpbGVzRGF0YS5jaGFyYWN0ZXJQcm9maWxlU3RydWN0dXJlLmZpbHRlcihlbCA9PiBSLmNvbnRhaW5zKGVsLm5hbWUsIGdyb3VwaW5nT3JkZXIpKSk7XHJcblxyXG4gICAgICAgIHJldHVybiBbe1xyXG4gICAgICAgICAgICBrZXk6IGwxMG4oJ2FsbC1jaGFyYWN0ZXJzJyksXHJcbiAgICAgICAgICAgIGxhc3RLZXlQYXJ0OiBsMTBuKCdhbGwtY2hhcmFjdGVycycpLFxyXG4gICAgICAgICAgICBjaGlsZHJlbjogbWFrZUdyb3VwVHJlZShncm91cHMsIGdyb3VwaW5nSXRlbUluZm8sIDAsIFtdKVxyXG4gICAgICAgIH1dO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyAgICAgICAgICAgIHZhciBmaWx0ZXIgPSBlbCA9PiBlbC50eXBlID09PSAnZW51bScgfHwgZWwudHlwZSA9PT0gJ2NoZWNrYm94JztcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgZHJhd0dyb3VwZWRMaXN0ID0gKHN0cnVjdHVyZXMpID0+IHtcclxuICAgICAgICAvLyAgICAgICAgc3RydWN0dXJlcyA9IFt7XHJcbiAgICAgICAgLy8gICAgICAgICAgICBcImtleVwiOiBsMTBuKCdhbGwtY2hhcmFjdGVycycpLFxyXG4gICAgICAgIC8vICAgICAgICAgICAgXCJsYXN0S2V5UGFydFwiOiBsMTBuKCdhbGwtY2hhcmFjdGVycycpLFxyXG4gICAgICAgIC8vICAgICAgICAgICAgXCJjaGlsZHJlblwiOiBzdHJ1Y3R1cmVzXHJcbiAgICAgICAgLy8gICAgICAgIH1dO1xyXG4gICAgICAgIC8vICAgICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShzdHJ1Y3R1cmVzKSk7XHJcblxyXG4gICAgICAgIHN0cnVjdHVyZXMuZm9yRWFjaChjYWxjU2l6ZSk7XHJcblxyXG4gICAgICAgIC8vIGFkZEVsKHF1ZXJ5RWwocm9vdCArICcuZ3JvdXAtY29udGVudCcpLCBhZGRFbHMoYWRkQ2xhc3NlcyhtYWtlRWwoJ3VsJyksIFsncmVtb3ZlLXVsLWRvdHMnLCAnemVyby1wYWRkaW5nJ10pLFxyXG4gICAgICAgIC8vIG1ha2VHcm91cFRyZWUoZ3JvdXBzLCBncm91cGluZ0l0ZW1JbmZvLCAwLCBbXSkpKTtcclxuICAgICAgICBhZGRFbChjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uZ3JvdXAtY29udGVudGApKSwgYWRkRWxzKGFkZENsYXNzZXMoXHJcbiAgICAgICAgICAgIG1ha2VFbCgndWwnKSxcclxuICAgICAgICAgICAgWydyZW1vdmUtdWwtZG90cycsICd6ZXJvLXBhZGRpbmcnXVxyXG4gICAgICAgICksIFIuZmxhdHRlbihzdHJ1Y3R1cmVzLm1hcChyZW5kZXJHcm91cFN0cnVjdHVyZSkpKSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IG1ha2VIZWFkZXIgPSAodGV4dCwgY2hhcmFjdGVyTnVtLCBwbGF5ZXJOdW0pID0+IHtcclxuICAgICAgICBjb25zdCBjaGFyYWN0ZXJCYWRnZSA9IGFkZEVsKGFkZENsYXNzKG1ha2VFbCgnc3BhbicpLCAnYmFkZ2UnKSwgbWFrZVRleHQoYCR7Y2hhcmFjdGVyTnVtfSAvICR7cGxheWVyTnVtfWApKTtcclxuICAgICAgICBzZXRBdHRyKGNoYXJhY3RlckJhZGdlLCAndGl0bGUnLCBMMTBuLmZvcm1hdCgncm9sZS1ncmlkJywgJ2JhZGdlLXRpdGxlJywgW2NoYXJhY3Rlck51bSwgcGxheWVyTnVtXSkpO1xyXG4gICAgICAgIC8vICAgICAgICBjb25zdCBwbGF5ZXJCYWRnZSA9IGFkZEVsKGFkZENsYXNzKG1ha2VFbCgnc3BhbicpLCAnYmFkZ2UnKSwgbWFrZVRleHQocGxheWVyTnVtKSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGgzID0gYWRkRWxzKGFkZENsYXNzKG1ha2VFbCgnaDMnKSwgJ3BhbmVsLXRpdGxlJyksIFttYWtlVGV4dChgICR7dGV4dH0gYCksIGNoYXJhY3RlckJhZGdlXSk7XHJcbiAgICAgICAgY29uc3QgYSA9IHNldEF0dHIobWFrZUVsKCdhJyksICdocmVmJywgJyMvJyk7XHJcbiAgICAgICAgc2V0QXR0cihhLCAndHJlZS1wYW5lbC10b2dnbGVyJywgJycpO1xyXG4gICAgICAgIGNvbnN0IGhlYWRpbmcgPSBhZGRFbChhZGRDbGFzcyhtYWtlRWwoJ2RpdicpLCAncGFuZWwtaGVhZGluZycpLCBhZGRFbHMoYSwgW2gzXSkpO1xyXG4gICAgICAgIHJldHVybiBhZGRFbChhZGRDbGFzc2VzKG1ha2VFbCgnZGl2JyksIFsncGFuZWwnLCAncGFuZWwtZGVmYXVsdCcsICdpbmxpbmUtcGFuZWwnXSksIGhlYWRpbmcpO1xyXG4gICAgICAgIC8vIHZhciBoZWFkaW5nID0gYWRkRWwoYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ3BhbmVsLWhlYWRpbmcnKSxcclxuICAgICAgICAvLyAgICAgIGFkZEVsKGFkZENsYXNzKG1ha2VFbCgnaDMnKSwgJ3BhbmVsLXRpdGxlJyksIG1ha2VUZXh0KHRleHQpKSk7XHJcbiAgICAgICAgLy8gcmV0dXJuIGFkZEVsKGFkZENsYXNzZXMobWFrZUVsKCdkaXYnKSwgWydwYW5lbCcsICdwYW5lbC1kZWZhdWx0J10pLCBoZWFkaW5nKTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIGNhbGNTaXplID0gKGVsKSA9PiB7XHJcbiAgICAgICAgaWYgKGVsLmNoaWxkcmVuKSB7XHJcbiAgICAgICAgICAgIGVsLmNoaWxkcmVuLmZvckVhY2goY2FsY1NpemUpO1xyXG4gICAgICAgICAgICBlbC5jaGFyYWN0ZXJOdW0gPSBSLnN1bShlbC5jaGlsZHJlbi5tYXAoUi5wcm9wKCdjaGFyYWN0ZXJOdW0nKSkpO1xyXG4gICAgICAgICAgICBlbC5wbGF5ZXJOdW0gPSBSLnN1bShlbC5jaGlsZHJlbi5tYXAoUi5wcm9wKCdwbGF5ZXJOdW0nKSkpO1xyXG4gICAgICAgIH0gZWxzZSB7IC8vIGdyb3Vwc1xyXG4gICAgICAgICAgICBlbC5jaGFyYWN0ZXJOdW0gPSBlbC5ncm91cHMubGVuZ3RoO1xyXG4gICAgICAgICAgICBlbC5wbGF5ZXJOdW0gPSBlbC5ncm91cHMuZmlsdGVyKFIucGlwZShSLnByb3AoJ3BsYXllck5hbWUnKSwgUi5pc05pbCwgUi5ub3QpKS5sZW5ndGg7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgcmVuZGVyR3JvdXBTdHJ1Y3R1cmUgPSAoZWwpID0+IHtcclxuICAgICAgICAvLyAgICAgICAgcmV0dXJuIFIuZmxhdHRlbihzdHJ1Y3R1cmUubWFwKGVsID0+IHtcclxuICAgICAgICBsZXQgZG9tQ2hpbGRyZW4sIGhlYWRlcjtcclxuICAgICAgICBpZiAoZWwuY2hpbGRyZW4pIHtcclxuICAgICAgICAgICAgZG9tQ2hpbGRyZW4gPSBhZGRFbHMoYWRkQ2xhc3MobWFrZUVsKCd1bCcpLCAncmVtb3ZlLXVsLWRvdHMnKSwgUi5mbGF0dGVuKGVsLmNoaWxkcmVuLm1hcChyZW5kZXJHcm91cFN0cnVjdHVyZSkpKTtcclxuICAgICAgICAgICAgaGVhZGVyID0gbWFrZUhlYWRlcihlbC5sYXN0S2V5UGFydCwgZWwuY2hhcmFjdGVyTnVtLCBlbC5wbGF5ZXJOdW0pO1xyXG4gICAgICAgICAgICBVSS5hdHRhY2hQYW5lbFRvZ2dsZXIocXVlcnlFbEVsKGhlYWRlciwgJ2EnKSwgZG9tQ2hpbGRyZW4pO1xyXG4gICAgICAgICAgICByZXR1cm4gUi5jb25jYXQoW2FkZEVsKG1ha2VFbCgnbGknKSwgaGVhZGVyKV0sIFtkb21DaGlsZHJlbl0pO1xyXG4gICAgICAgIH0gLy8gZ3JvdXBzXHJcbiAgICAgICAgLy8gICAgICAgICAgICB2YXIgcGFuZWxMaXN0ID0gbWFrZVBhbmVsTGlzdChlbC5ncm91cHMpLm1hcChhZGRDbGFzc2VzKFIuX18sWydpbmxpbmUtcGFuZWwnXSkpO1xyXG4gICAgICAgIGNvbnN0IHBhbmVsTGlzdCA9IG1ha2VQYW5lbExpc3QoZWwuZ3JvdXBzKS5tYXAoYWRkQ2xhc3NlcyhSLl9fLCBbJ2lubGluZS1wYW5lbCcsICdjb2wteHMtNiddKSk7XHJcbiAgICAgICAgLy8gICAgICAgICAgICB2YXIgcGFuZWxMaXN0ID0gbWFrZVBhbmVsTGlzdChlbC5ncm91cHMpLm1hcChhZGRDbGFzc2VzKFIuX18sWydpbmxpbmUtcGFuZWwnLCAnY29sLXhzLTQnXSkpO1xyXG4gICAgICAgIGNvbnN0IHJvdyA9IGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICdyb3cnKTtcclxuICAgICAgICBjb25zdCBjb250YWluZXIgPSBhZGRFbChhZGRDbGFzcyhtYWtlRWwoJ2RpdicpLCAnbGlzdC1jb250ZW50LXBhZGRpbmcgY29udGFpbmVyLWZsdWlkJyksIHJvdyk7XHJcbiAgICAgICAgZG9tQ2hpbGRyZW4gPSBhZGRFbHMocm93LCBwYW5lbExpc3QpO1xyXG4gICAgICAgIGhlYWRlciA9IG1ha2VIZWFkZXIoZWwua2V5LCBlbC5jaGFyYWN0ZXJOdW0sIGVsLnBsYXllck51bSk7XHJcbiAgICAgICAgVUkuYXR0YWNoUGFuZWxUb2dnbGVyKHF1ZXJ5RWxFbChoZWFkZXIsICdhJyksIGNvbnRhaW5lcik7XHJcbiAgICAgICAgcmV0dXJuIFIuY29uY2F0KFthZGRFbChtYWtlRWwoJ2xpJyksIGhlYWRlcildLCBbY29udGFpbmVyXSk7XHJcbiAgICAgICAgLy8gdmFyIGNvbnRhaW5lciA9IGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICdsaXN0LWNvbnRlbnQtcGFkZGluZyBjb250YWluZXItZmx1aWQnKTtcclxuICAgICAgICAvLyBkb21DaGlsZHJlbiA9IGFkZEVscyhjb250YWluZXIsIHBhbmVsTGlzdCk7XHJcbiAgICAgICAgLy8gcmV0dXJuIFIuY29uY2F0KFthZGRFbChtYWtlRWwoJ2xpJyksIG1ha2VIZWFkZXIoZWwua2V5LCBlbC5jaGFyYWN0ZXJOdW0sIGVsLnBsYXllck51bSkpXSwgW2RvbUNoaWxkcmVuXSk7XHJcblxyXG5cclxuICAgICAgICAvLyAgICAgICAgfSkpO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgbWFrZUdyb3VwVHJlZSA9IChncm91cHMsIGdyb3VwaW5nSXRlbUluZm8sIGluZGV4LCBrZXkpID0+IHtcclxuICAgICAgICBjb25zdCBhcnIgPSBncm91cGluZ0l0ZW1JbmZvW2dyb3VwaW5nT3JkZXJbaW5kZXhdXS52YWx1ZS5zcGxpdCgnLCcpLm1hcCgobmFtZSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBuZXh0S2V5ID0gUi5jb25jYXQoa2V5LCBbbmFtZV0pO1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgIHZhciBuZXh0S2V5ID0gUi5jb25jYXQoa2V5LCBbZ3JvdXBpbmdPcmRlcltpbmRleF0gKyAnOiAnICsgbmFtZV0pO1xyXG4gICAgICAgICAgICBjb25zdCBsYXN0S2V5UGFydCA9IGAke2dyb3VwaW5nT3JkZXJbaW5kZXhdfTogJHtuYW1lfWA7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgdmFyIGRvbUNoaWxkcmVuO1xyXG4gICAgICAgICAgICBpZiAoZ3JvdXBpbmdPcmRlci5sZW5ndGggIT09IGluZGV4ICsgMSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY2hpbGRyZW4gPSBtYWtlR3JvdXBUcmVlKGdyb3VwcywgZ3JvdXBpbmdJdGVtSW5mbywgaW5kZXggKyAxLCBuZXh0S2V5KTtcclxuICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbiA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgZG9tQ2hpbGRyZW4gPSBbYWRkRWxzKGFkZENsYXNzKG1ha2VFbCgndWwnKSwgJ3JlbW92ZS11bC1kb3RzJyksIGNoaWxkcmVuKV07XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGtleTogbmV4dEtleS5qb2luKCcgLyAnKSxcclxuICAgICAgICAgICAgICAgICAgICBsYXN0S2V5UGFydCxcclxuICAgICAgICAgICAgICAgICAgICBjaGlsZHJlblxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBmdWxsS2V5ID0gbmV4dEtleS5qb2luKCcvJyk7XHJcbiAgICAgICAgICAgIGlmIChncm91cHNbZnVsbEtleV0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gZG9tQ2hpbGRyZW4gPSBbYWRkRWxzKGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICdsaXN0LWNvbnRlbnQtcGFkZGluZycpLCBtYWtlUGFuZWxMaXN0KGdyb3Vwc1tmdWxsS2V5XSkpXTtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIGtleTogbmV4dEtleS5qb2luKCcgLyAnKSxcclxuICAgICAgICAgICAgICAgIGxhc3RLZXlQYXJ0LFxyXG4gICAgICAgICAgICAgICAgZ3JvdXBzOiBncm91cHNbZnVsbEtleV1cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgcmV0dXJuIFIuY29uY2F0KFthZGRFbChtYWtlRWwoJ2xpJyksIG1ha2VIZWFkZXIobmFtZSkpXSwgZG9tQ2hpbGRyZW4pO1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgIHJldHVybiBSLmNvbmNhdChbYWRkRWwobWFrZUVsKCdsaScpLCBtYWtlSGVhZGVyKG5leHRLZXkuam9pbignIC8gJykpKV0sIGRvbUNoaWxkcmVuKTtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICAgICBuYW1lOiBuZXh0S2V5LmpvaW4oJyAvICcpLFxyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICAgICBjaGlsZHJlbjpcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkuZmlsdGVyKGVsID0+IGVsICE9PSBudWxsKTtcclxuICAgICAgICByZXR1cm4gYXJyLmxlbmd0aCA9PT0gMCA/IG51bGwgOiBhcnI7XHJcbiAgICAgICAgLy8gICAgICAgIGlmKGFyci5sZW5ndGggPT09IDApe1xyXG4gICAgICAgIC8vICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgLy8gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gICAgICAgICAgICByZXR1cm4gUi5mbGF0dGVuKGFycik7XHJcbiAgICAgICAgLy8gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgZHJhd1BsYWluUGFuZWxMaXN0ID0gKCkgPT4ge1xyXG4gICAgICAgIGFkZEVscyhjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uZ3JvdXAtY29udGVudGApKSwgbWFrZVBhbmVsTGlzdChwcm9maWxlc0RhdGEucHJvZmlsZURhdGEpKTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIG1ha2VQYW5lbExpc3QgPSBwcm9maWxlQXJyYXkgPT5cclxuICAgICAgICBwcm9maWxlQXJyYXkuc29ydChDb21tb25VdGlscy5jaGFyT3JkQUZhY3RvcnkoYSA9PiBhLmNoYXJhY3Rlck5hbWUudG9Mb3dlckNhc2UoKSkpLm1hcCgocHJvZmlsZURhdGEpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdGFibGVzID0gW1VJLm1ha2VQcm9maWxlVGFibGUocHJvZmlsZXNEYXRhLmNoYXJhY3RlclByb2ZpbGVTdHJ1Y3R1cmUsIHByb2ZpbGVEYXRhLmNoYXJhY3RlcildO1xyXG4gICAgICAgICAgICBsZXQgdGl0bGUgPSBwcm9maWxlRGF0YS5jaGFyYWN0ZXJOYW1lO1xyXG4gICAgICAgICAgICBpZiAocHJvZmlsZURhdGEucGxheWVyTmFtZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICB0YWJsZXMucHVzaChVSS5tYWtlUHJvZmlsZVRhYmxlKHByb2ZpbGVzRGF0YS5wbGF5ZXJQcm9maWxlU3RydWN0dXJlLCBwcm9maWxlRGF0YS5wbGF5ZXIpKTtcclxuICAgICAgICAgICAgICAgIHRpdGxlICs9IGAvJHtwcm9maWxlRGF0YS5wbGF5ZXJOYW1lfWA7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHBhbmVsSW5mbyA9IFVJLm1ha2VQYW5lbENvcmUobWFrZVRleHQodGl0bGUpLCBhZGRFbHMobWFrZUVsKCdkaXYnKSwgdGFibGVzKSk7XHJcbiAgICAgICAgICAgIFVJLmF0dGFjaFBhbmVsVG9nZ2xlcihwYW5lbEluZm8uYSwgcGFuZWxJbmZvLmNvbnRlbnREaXYsIChldmVudCwgdG9nZ2xlUGFuZWwpID0+IHtcclxuICAgICAgICAgICAgICAgIHF1ZXJ5RWxzKGAke3Jvb3R9Lmdyb3VwLWNvbnRlbnQgLmV4cGFuZGVkW3BhbmVsLXRvZ2dsZXJdYCkuZmlsdGVyKGVsID0+XHJcbiAgICAgICAgICAgICAgICAgICAgIWVsLmNvbnRhaW5zKGV2ZW50LnRhcmdldCkpLmZvckVhY2goZWwgPT4gZWwuY2xpY2soKSk7XHJcbiAgICAgICAgICAgICAgICB0b2dnbGVQYW5lbCgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcGFuZWxJbmZvLmEuY2xpY2soKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiBwYW5lbEluZm8ucGFuZWw7XHJcbiAgICAgICAgfSk7XHJcbn0pKHRoaXMuUm9sZUdyaWQgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCByb290ID0gJy5lbnRlci10YWIgJztcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgJChkb2N1bWVudC5mb3Jtc1snbG9naW4tZm9ybSddKS5vbignc3VibWl0Jywgc3VibWl0KTtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcblxyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBzdWJtaXQoKSB7XHJcbiAgICAgICAgY29uc3QgZm9ybSA9ICQodGhpcyk7XHJcblxyXG4gICAgICAgICQoJy5lcnJvcicsIGZvcm0pLmh0bWwoJycpO1xyXG4gICAgICAgIC8vICAgICAgICAkKFwiOnN1Ym1pdFwiLCBmb3JtKS5idXR0b24oXCJsb2FkaW5nXCIpO1xyXG5cclxuICAgICAgICBjb25zdCByZXF1ZXN0ID0gJC5hamF4KHtcclxuICAgICAgICAgICAgdXJsOiAnL2xvZ2luJyxcclxuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgICAgICAgIGRhdGE6IGZvcm0uc2VyaWFsaXplKCksXHJcbiAgICAgICAgICAgIGNvbXBsZXRlKCkge1xyXG4gICAgICAgICAgICAgICAgJCgnOnN1Ym1pdCcsIGZvcm0pLmJ1dHRvbigncmVzZXQnKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICAgc3RhdHVzQ29kZSA6IHtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgIDIwMCA6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgIDQwMyA6IGZ1bmN0aW9uKGpxWEhSKSB7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gSlNPTi5wYXJzZShqcVhIUi5yZXNwb25zZVRleHQpO1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICAgICAgICAgICQoJy5lcnJvcicsIGZvcm0pLmh0bWwoZXJyb3IubWVzc2FnZSk7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICByZXF1ZXN0LmRvbmUoKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICAgLy93aW5kb3cubG9jYXRpb24uaHJlZiA9IFwiL2NoYXRcIjtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBcIi9uaW1zLmh0bWxcIjtcclxuICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSAnL3BhZ2UuaHRtbCc7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJlcXVlc3QuZmFpbCgoZXJyb3JJbmZvLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikgPT4ge1xyXG4gICAgICAgICAgICBsZXQgbXNnO1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgbXNnID0gVXRpbHMuaGFuZGxlRXJyb3JNc2coSlNPTi5wYXJzZShlcnJvckluZm8ucmVzcG9uc2VUZXh0KSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgbXNnID0gVXRpbHMuaGFuZGxlRXJyb3JNc2coZXJyb3JJbmZvLnJlc3BvbnNlVGV4dCB8fCB0ZXh0U3RhdHVzIHx8ICdlcnJvcicpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgIHZhciBlcnJvciA9IEpTT04ucGFyc2UoanFYSFIucmVzcG9uc2VUZXh0KTtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICAgJCgnLmVycm9yJywgZm9ybSkuaHRtbChlcnJvci5tZXNzYWdlKTtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICAkKCcuZXJyb3InLCBmb3JtKS5odG1sKHRleHRTdGF0dXMpO1xyXG4gICAgICAgICAgICAkKCcuZXJyb3InLCBmb3JtKS5odG1sKG1zZyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxufSkodGhpcy5FbnRlciA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgcm9vdCA9ICcucGxheWVyLXRhYiAnO1xyXG4gICAgY29uc3QgY2hhcmFjdGVyUHJvZmlsZURpdiA9IGAke3Jvb3R9LmNoYXJhY3Rlci1wcm9maWxlLWRpdmA7XHJcbiAgICBjb25zdCBwbGF5ZXJQcm9maWxlRGl2ID0gYCR7cm9vdH0ucGxheWVyLXByb2ZpbGUtZGl2YDtcclxuICAgIGNvbnN0IHBsYXllckhlYWRlciA9IGAke3Jvb3R9LnBsYXllci1wcm9maWxlLWhlYWRlcmA7XHJcbiAgICBjb25zdCBjaGFyYWN0ZXJIZWFkZXIgPSBgJHtyb290fS5jaGFyYWN0ZXItcHJvZmlsZS1oZWFkZXJgO1xyXG5cclxuICAgIGxldCBwcm9maWxlRWRpdG9yQ29yZTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgcHJvZmlsZUVkaXRvckNvcmUgPSBQcm9maWxlRWRpdG9yQ29yZS5tYWtlUHJvZmlsZUVkaXRvckNvcmUoKTtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgREJNUy5nZXRXZWxjb21lVGV4dCgoZXJyLCB0ZXh0KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIERCTVMuZ2V0UGxheWVyUHJvZmlsZUluZm8oKGVycjIsIHByb2ZpbGVJbmZvKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBEQk1TLmdldFBsYXllcnNPcHRpb25zKChlcnIzLCBwbGF5ZXJzT3B0aW9ucykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIzKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjMpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICBidWlsZEludGVyZmFjZSh0ZXh0LCBwcm9maWxlSW5mbywgcGxheWVyc09wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBpc0VkaXRhYmxlKHByb2ZpbGVOYW1lLCBwcm9maWxlU3RydWN0dXJlKSB7XHJcbiAgICAgICAgcmV0dXJuIFIuZmluZChSLnByb3BFcSgnbmFtZScsIHByb2ZpbGVOYW1lKSwgcHJvZmlsZVN0cnVjdHVyZSkucGxheWVyQWNjZXNzID09PSAnd3JpdGUnO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGJ1aWxkSW50ZXJmYWNlKHRleHQsIHByb2ZpbGVJbmZvLCBwbGF5ZXJzT3B0aW9ucykge1xyXG4gICAgICAgIHByb2ZpbGVFZGl0b3JDb3JlLmluaXRQcm9maWxlU3RydWN0dXJlKHBsYXllclByb2ZpbGVEaXYsICdwbGF5ZXInLCBwcm9maWxlSW5mby5wbGF5ZXIucHJvZmlsZVN0cnVjdHVyZSk7XHJcbiAgICAgICAgcHJvZmlsZUVkaXRvckNvcmUuZmlsbFByb2ZpbGVJbmZvcm1hdGlvbihwbGF5ZXJQcm9maWxlRGl2LCAncGxheWVyJywgcHJvZmlsZUluZm8ucGxheWVyLnByb2ZpbGUsIGlzRWRpdGFibGUpO1xyXG4gICAgICAgIGFkZEVsKGNsZWFyRWwocXVlcnlFbChwbGF5ZXJIZWFkZXIpKSwgbWFrZVRleHQoc3RyRm9ybWF0KGdldEwxMG4oJ2JyaWVmaW5ncy1wbGF5ZXItcHJvZmlsZScpLCBbcHJvZmlsZUluZm8ucGxheWVyLnByb2ZpbGUubmFtZV0pKSk7XHJcblxyXG4gICAgICAgIGlmIChwcm9maWxlSW5mby5jaGFyYWN0ZXIgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBhZGRFbChjbGVhckVsKHF1ZXJ5RWwoY2hhcmFjdGVySGVhZGVyKSksIG1ha2VUZXh0KHN0ckZvcm1hdChnZXRMMTBuKCdicmllZmluZ3MtY2hhcmFjdGVyLXByb2ZpbGUnKSwgWycnXSkpKTtcclxuICAgICAgICAgICAgY29uc3QgZWwgPSBjbGVhckVsKHF1ZXJ5RWwoY2hhcmFjdGVyUHJvZmlsZURpdikpO1xyXG4gICAgICAgICAgICBpZiAocGxheWVyc09wdGlvbnMuYWxsb3dDaGFyYWN0ZXJDcmVhdGlvbikge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbGFiZWwgPSBhZGRFbChtYWtlRWwoJ2RpdicpLCBtYWtlVGV4dChnZXRMMTBuKCdwcm9maWxlcy1wbGF5ZXItaGFzLW5vLWNoYXJhY3Rlci1hbmQtY2FuLWNyZWF0ZS1pdCcpKSk7XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyhsYWJlbCwgJ21hcmdpbi1ib3R0b20tOCcpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaW5wdXQgPSBzZXRBdHRyKG1ha2VFbCgnaW5wdXQnKSwgJ3BsYWNlaG9sZGVyJywgZ2V0TDEwbigncHJvZmlsZXMtY2hhcmFjdGVyLW5hbWUnKSk7XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ2Zvcm0tY29udHJvbCBtYXJnaW4tYm90dG9tLTgnKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGJ1dHRvbiA9IGFkZEVsKG1ha2VFbCgnYnV0dG9uJyksIG1ha2VUZXh0KGdldEwxMG4oJ2NvbW1vbi1jcmVhdGUnKSkpO1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3MoYnV0dG9uLCAnYnRuIGJ0bi1kZWZhdWx0Jyk7XHJcbiAgICAgICAgICAgICAgICBsaXN0ZW4oYnV0dG9uLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgREJNUy5jcmVhdGVDaGFyYWN0ZXJCeVBsYXllcihpbnB1dC52YWx1ZS50cmltKCksIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgYWRkRWxzKGVsLCBbbGFiZWwsIGlucHV0LCBidXR0b25dKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGFkZEVsKGVsLCBhZGRFbChtYWtlRWwoJ3NwYW4nKSwgbWFrZVRleHQoZ2V0TDEwbigncHJvZmlsZXMtcGxheWVyLWhhcy1uby1jaGFyYWN0ZXItYW5kLWNhbnQtY3JlYXRlLWl0JykpKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBwcm9maWxlRWRpdG9yQ29yZS5pbml0UHJvZmlsZVN0cnVjdHVyZShjaGFyYWN0ZXJQcm9maWxlRGl2LCAnY2hhcmFjdGVyJywgcHJvZmlsZUluZm8uY2hhcmFjdGVyLnByb2ZpbGVTdHJ1Y3R1cmUpO1xyXG4gICAgICAgICAgICBwcm9maWxlRWRpdG9yQ29yZS5maWxsUHJvZmlsZUluZm9ybWF0aW9uKGNoYXJhY3RlclByb2ZpbGVEaXYsICdjaGFyYWN0ZXInLCBwcm9maWxlSW5mby5jaGFyYWN0ZXIucHJvZmlsZSwgaXNFZGl0YWJsZSk7XHJcbiAgICAgICAgICAgIGFkZEVsKGNsZWFyRWwocXVlcnlFbChjaGFyYWN0ZXJIZWFkZXIpKSwgbWFrZVRleHQoc3RyRm9ybWF0KGdldEwxMG4oJ2JyaWVmaW5ncy1jaGFyYWN0ZXItcHJvZmlsZScpLCBbcHJvZmlsZUluZm8uY2hhcmFjdGVyLnByb2ZpbGUubmFtZV0pKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBxdWVyeUVsKGAke3Jvb3R9LndlbGNvbWUtdGV4dC1hcmVhYCkudmFsdWUgPSB0ZXh0O1xyXG4gICAgfVxyXG59KSh0aGlzLlBsYXllciA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHJvb3QgPSAnLnNpZ24tdXAtdGFiICc7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgICQoZG9jdW1lbnQuZm9ybXNbJ3NpZ24tdXAtZm9ybSddKS5vbignc3VibWl0Jywgc3VibWl0KTtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIHN1Ym1pdCgpIHtcclxuICAgICAgICBjb25zdCBmb3JtID0gJCh0aGlzKTtcclxuXHJcbiAgICAgICAgJCgnLmVycm9yJywgZm9ybSkuaHRtbCgnJyk7XHJcbiAgICAgICAgJCgnOnN1Ym1pdCcsIGZvcm0pLmJ1dHRvbignbG9hZGluZycpO1xyXG5cclxuICAgICAgICBjb25zdCByZXF1ZXN0ID0gJC5hamF4KHtcclxuICAgICAgICAgICAgdXJsOiAnL3NpZ25VcCcsXHJcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxyXG4gICAgICAgICAgICBkYXRhOiBmb3JtLnNlcmlhbGl6ZSgpLFxyXG4gICAgICAgICAgICBjb21wbGV0ZSgpIHtcclxuICAgICAgICAgICAgICAgICQoJzpzdWJtaXQnLCBmb3JtKS5idXR0b24oJ3Jlc2V0Jyk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmVxdWVzdC5kb25lKChkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgIGZvcm0uaHRtbChnZXRMMTBuKCdlbnRyYW5jZS1zaWduLXVwLXN1Y2Nlc3MnKSkuYWRkQ2xhc3MoJ2FsZXJ0LXN1Y2Nlc3MnKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmVxdWVzdC5mYWlsKChlcnJvckluZm8sIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBtc2c7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBtc2cgPSBVdGlscy5oYW5kbGVFcnJvck1zZyhKU09OLnBhcnNlKGVycm9ySW5mby5yZXNwb25zZVRleHQpKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICBtc2cgPSBVdGlscy5oYW5kbGVFcnJvck1zZyhlcnJvckluZm8ucmVzcG9uc2VUZXh0IHx8IHRleHRTdGF0dXMgfHwgJ2Vycm9yJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgJCgnLmVycm9yJywgZm9ybSkuaHRtbChtc2cpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbn0pKHRoaXMuU2lnblVwID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE4IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCByb290ID0gJy5zbGlkZXJzLXRhYiAnO1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuICAgIHN0YXRlLnNsaWRlcnMgPSBbXTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNyZWF0ZVNsaWRlckRpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHJvb3QsIGNyZWF0ZVNsaWRlciwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdjcmVhdGUtc2xpZGVyLWJvZHknLFxyXG4gICAgICAgICAgICBkaWFsb2dUaXRsZTogJ3NsaWRlcnMtY3JlYXRlLXNsaWRlcicsXHJcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLWNyZWF0ZScsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgc3RhdGUuZWRpdFNsaWRlckRpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHJvb3QsIGVkaXRTbGlkZXIsIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnY3JlYXRlLXNsaWRlci1ib2R5JyxcclxuICAgICAgICAgICAgZGlhbG9nVGl0bGU6ICdzbGlkZXJzLWVkaXQtc2xpZGVyJyxcclxuICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tc2F2ZScsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgc3RhdGUubW92ZVNsaWRlckRpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHJvb3QsIG1vdmVTbGlkZXIsIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnbW92ZS1zbGlkZXItYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnc2xpZGVycy1tb3ZlLXNsaWRlcicsXHJcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLW1vdmUnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxpc3RlbihxZShgJHtyb290fSAuY3JlYXRlYCksICdjbGljaycsICgpID0+IGNyZWF0ZVNsaWRlckRpYWxvZy5zaG93RGxnKCkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBEQk1TLmdldFNsaWRlckRhdGFQbSgpLnRoZW4oY3JlYXRlU2xpZGVycykuY2F0Y2goVXRpbHMuaGFuZGxlRXJyb3IpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZnVuY3Rpb24gY3JlYXRlU2xpZGVycyhtb2RlbCkge1xyXG4gICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG1vZGVsLm1hcCggaW5mbyA9PiB7cmV0dXJuIHtuYW1lOiBzdHJGb3JtYXQoTDEwbi5nZXQoJ2NvbW1vbicsICdzZXQtaXRlbS1iZWZvcmUnKSwgW2luZm8ubmFtZV0pfX0pO1xyXG4gICAgICAgIHBvc2l0aW9ucy5wdXNoKHtuYW1lOiBMMTBuLmdldCgnY29tbW9uJywgJ3NldC1pdGVtLWFzLWxhc3QnKX0pO1xyXG4gICAgICAgIGZpbGxTZWxlY3RvcihjbGVhckVsKHFlKGAke3Jvb3R9IC5tb3ZlLXNsaWRlci1wb3Mtc2VsZWN0YCkpLCBwb3NpdGlvbnMpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGFkZEVscyhjbGVhckVsKHF1ZXJ5RWwoJy5taXhlci1wYW5lbCAucGFuZWwtYm9keScpKSwgbW9kZWwubWFwKCBtYWtlU2xpZGVyQmFja2JvbmUgKSkgO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNsZWFyRWxzKHN0YXRlLnNsaWRlcnMpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHN0YXRlLnNsaWRlcnMgPSBtb2RlbC5tYXAoIChzbCwgaSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBzbGlkZXIgPSBuZXcgU2xpZGVyKCcubWl4ZXItcGFuZWwgLnBhbmVsLWJvZHkgaW5wdXRbcG9zPVwiJyArIGkgKyAnXCJdJywge1xyXG4gICAgICAgICAgICAgICAgbWF4OiAxMCxcclxuICAgICAgICAgICAgICAgIG1pbjogLTEwLFxyXG4gICAgICAgICAgICAgICAgb3JpZW50YXRpb246ICd2ZXJ0aWNhbCcsXHJcbiAgICAgICAgICAgICAgICByZXZlcnNlZDogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIHRvb2x0aXA6ICdhbHdheXMnLFxyXG4gICAgICAgICAgICAgICAgdmFsdWU6IHNsLnZhbHVlLFxyXG4gICAgICAgICAgICAgICAgZm9ybWF0dGVyOiBmdW5jdGlvbih2YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLmFicyh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgc2xpZGVyLm9uKCdjaGFuZ2UnLCAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgIERCTVMudXBkYXRlU2xpZGVyVmFsdWVQbShpLCBldmVudC5uZXdWYWx1ZSkuY2F0Y2goVXRpbHMuaGFuZGxlRXJyb3IpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIHNsaWRlcjtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgdmFyIG1ha2VTbGlkZXJCYWNrYm9uZSA9IChzbCwgaSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGVsID0gcW10ZShgJHtyb290fSAuc2xpZGVyLWNvbnRhaW5lci10bXBsYCk7XHJcbiAgICAgICAgc2V0QXR0cihxZWUoZWwsICdpbnB1dCcpLCAncG9zJywgaSk7XHJcbiAgICAgICAgYWRkRWwocWVlKGVsLCAnLnNsaWRlci1uYW1lJyksIG1ha2VUZXh0KHNsLm5hbWUpKTtcclxuICAgICAgICBhZGRFbChxZWUoZWwsICcuc2xpZGVyLXRvcCcpLCBtYWtlVGV4dChzbC50b3ApKTtcclxuICAgICAgICBhZGRFbChxZWUoZWwsICcuc2xpZGVyLWJvdHRvbScpLCBtYWtlVGV4dChzbC5ib3R0b20pKTtcclxuICAgICAgICBcclxuICAgICAgICBsaXN0ZW4ocWVlKGVsLCAnYnV0dG9uLm1vdmUnKSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBzdGF0ZS5tb3ZlU2xpZGVyRGlhbG9nLmN1cnJlbnRJbmRleCA9IGk7XHJcbiAgICAgICAgICAgIHN0YXRlLm1vdmVTbGlkZXJEaWFsb2cuc2hvd0RsZygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxpc3RlbihxZWUoZWwsICdidXR0b24ucmVuYW1lJyksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgcWVlKHN0YXRlLmVkaXRTbGlkZXJEaWFsb2csICcuc2xpZGVyLW5hbWUnKS52YWx1ZSA9IHNsLm5hbWU7XHJcbiAgICAgICAgICAgIHFlZShzdGF0ZS5lZGl0U2xpZGVyRGlhbG9nLCAnLnNsaWRlci10b3AnKS52YWx1ZSA9IHNsLnRvcDtcclxuICAgICAgICAgICAgcWVlKHN0YXRlLmVkaXRTbGlkZXJEaWFsb2csICcuc2xpZGVyLWJvdHRvbScpLnZhbHVlID0gc2wuYm90dG9tO1xyXG4gICAgICAgICAgICBzdGF0ZS5lZGl0U2xpZGVyRGlhbG9nLnBvcyA9IGk7XHJcbiAgICAgICAgICAgIHN0YXRlLmVkaXRTbGlkZXJEaWFsb2cuc2hvd0RsZygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxpc3RlbihxZWUoZWwsICdidXR0b24ucmVtb3ZlJyksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgVXRpbHMuY29uZmlybShMMTBuLmZvcm1hdCgnc2xpZGVycycsICdhcmUteW91LXN1cmUtYWJvdXQtcmVtb3Zpbmctc2xpZGVyJywgW3NsLm5hbWVdKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgREJNUy5yZW1vdmVTbGlkZXIoaSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIEwxMG4ubG9jYWxpemVTdGF0aWMoZWwpO1xyXG4gICAgICAgIHJldHVybiBlbDtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIGNyZWF0ZVNsaWRlcihkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lID0gcWVlKGRpYWxvZywgJy5zbGlkZXItbmFtZScpLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICAgICAgY29uc3QgdG9wID0gcWVlKGRpYWxvZywgJy5zbGlkZXItdG9wJykudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICBjb25zdCBib3R0b20gPSBxZWUoZGlhbG9nLCAnLnNsaWRlci1ib3R0b20nKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIERCTVMuY3JlYXRlU2xpZGVyKG5hbWUsIHRvcCwgYm90dG9tLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBxZWUoZGlhbG9nLCAnLnNsaWRlci1uYW1lJykudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICBxZWUoZGlhbG9nLCAnLnNsaWRlci10b3AnKS52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIHFlZShkaWFsb2csICcuc2xpZGVyLWJvdHRvbScpLnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgZnVuY3Rpb24gZWRpdFNsaWRlcihkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lID0gcWVlKGRpYWxvZywgJy5zbGlkZXItbmFtZScpLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICAgICAgY29uc3QgdG9wID0gcWVlKGRpYWxvZywgJy5zbGlkZXItdG9wJykudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICBjb25zdCBib3R0b20gPSBxZWUoZGlhbG9nLCAnLnNsaWRlci1ib3R0b20nKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBvcyA9IGRpYWxvZy5wb3M7XHJcbiAgICAgICAgICAgIERCTVMudXBkYXRlU2xpZGVyTmFtaW5nKHBvcywgbmFtZSwgdG9wLCBib3R0b20sIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHFlZShkaWFsb2csICcuc2xpZGVyLW5hbWUnKS52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIHFlZShkaWFsb2csICcuc2xpZGVyLXRvcCcpLnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgcWVlKGRpYWxvZywgJy5zbGlkZXItYm90dG9tJykudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIG1vdmVTbGlkZXIoZGlhbG9nKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgdmFyIGluZGV4ID0gZGlhbG9nLmN1cnJlbnRJbmRleDtcclxuICAgICAgICAgICAgdmFyIHBvcyA9IHFlZShkaWFsb2csICcubW92ZS1zbGlkZXItcG9zLXNlbGVjdCcpLnNlbGVjdGVkSW5kZXg7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBEQk1TLm1vdmVTbGlkZXIoaW5kZXgsIHBvcywgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEVycm9yKGRpYWxvZywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0pKHRoaXMuU2xpZGVycyA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNUywgU3Rvcmllc1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuICAgIGV4cG9ydHMubmFtZSA9ICdFdmVudFByZXNlbmNlJztcclxuICAgIGNvbnN0IHJvb3QgPSAnI2V2ZW50UHJlc2VuY2VEaXYgJztcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCdldmVudFByZXNlbmNlU2VsZWN0b3InKSwgJ2NoYW5nZScsIFVJLnNob3dTZWxlY3RlZEVsczMocm9vdCwgJ2RlcGVuZGVudCcsICdkZXBlbmRlbnQtaW5kZXgnKSk7XHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHRhYmxlSGVhZCA9IGdldEVsKCdldmVudFByZXNlbmNlVGFibGVIZWFkJyk7XHJcbiAgICAgICAgY29uc3QgdGFibGUgPSBnZXRFbCgnZXZlbnRQcmVzZW5jZVRhYmxlJyk7XHJcbiAgICAgICAgY29uc3QgY2hhcmFjdGVyU2VsZWN0b3IgPSBnZXRFbCgnZXZlbnRQcmVzZW5jZVNlbGVjdG9yJyk7XHJcblxyXG4gICAgICAgIGlmIChTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGNsZWFyRWwodGFibGVIZWFkKTtcclxuICAgICAgICAgICAgY2xlYXJFbCh0YWJsZSk7XHJcbiAgICAgICAgICAgIGNsZWFyRWwoY2hhcmFjdGVyU2VsZWN0b3IpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuaXNFbnRpdHlFZGl0YWJsZSgnc3RvcnknLCBTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSwgKGVyciwgaXNTdG9yeUVkaXRhYmxlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdjaGFyYWN0ZXInLCBmYWxzZSwgKGVycjIsIGFsbENoYXJhY3RlcnMpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0U3RvcnlDaGFyYWN0ZXJOYW1lc0FycmF5KFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLCAoZXJyMywgY2hhcmFjdGVyQXJyYXkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWFwID0ge307XHJcbiAgICAgICAgICAgICAgICAgICAgYWxsQ2hhcmFjdGVycy5mb3JFYWNoKChlbGVtKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hcFtlbGVtLnZhbHVlXSA9IGVsZW07XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YUFycmF5ID0gY2hhcmFjdGVyQXJyYXkubWFwKGVsZW0gPT4gbWFwW2VsZW1dKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YUFycmF5LnNvcnQoVXRpbHMuY2hhck9yZEFPYmplY3QpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXNwbGF5QXJyYXkgPSBkYXRhQXJyYXkubWFwKGVsZW0gPT4gZWxlbS5kaXNwbGF5TmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2hhcmFjdGVyQXJyYXkgPSBkYXRhQXJyYXkubWFwKGVsZW0gPT4gZWxlbS52YWx1ZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIERCTVMuZ2V0U3RvcnlFdmVudHMoU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksIChlcnI0LCBldmVudHMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjQpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyNCk7IHJldHVybjsgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJFbCh0YWJsZUhlYWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhckVsKHRhYmxlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dFbChxdWVyeUVsKGAke3Jvb3R9IC5hbGVydC5uby1jaGFyYWN0ZXJzYCksIGNoYXJhY3RlckFycmF5Lmxlbmd0aCA9PT0gMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dFbChxdWVyeUVsKGAke3Jvb3R9IC5hbGVydC5uby1ldmVudHNgKSwgZXZlbnRzLmxlbmd0aCA9PT0gMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dFbChxdWVyeUVsKGAke3Jvb3R9IC5wYW5lbC1ib2R5YCksIGV2ZW50cy5sZW5ndGggIT09IDAgJiYgY2hhcmFjdGVyQXJyYXkubGVuZ3RoICE9PSAwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFVJLmZpbGxTaG93SXRlbVNlbGVjdG9yKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJFbChjaGFyYWN0ZXJTZWxlY3RvciksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5QXJyYXkubWFwKG5hbWUgPT4gKHsgbmFtZSwgaGlkZGVuOiBmYWxzZSB9KSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGVuZFRhYmxlSGVhZGVyKHRhYmxlSGVhZCwgZGlzcGxheUFycmF5KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzLmZvckVhY2goKGV2ZW50LCBpKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBlbmRUYWJsZUlucHV0KHRhYmxlLCBldmVudCwgaSwgY2hhcmFjdGVyQXJyYXkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlKGV4cG9ydHMuY29udGVudCwgJ2lzU3RvcnlFZGl0YWJsZScsIGlzU3RvcnlFZGl0YWJsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBhcHBlbmRUYWJsZUhlYWRlcih0YWJsZSwgY2hhcmFjdGVyQXJyYXkpIHtcclxuICAgICAgICBjb25zdCBldmVudE5hbWUgPSBhZGRFbChtYWtlRWwoJ3RoJyksIG1ha2VUZXh0KGdldEwxMG4oJ3N0b3JpZXMtZXZlbnQnKSkpO1xyXG4gICAgICAgIGNvbnN0IGVscyA9IGNoYXJhY3RlckFycmF5Lm1hcCgoY2hhcmFjdGVyTmFtZSwgaSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0aCA9IGFkZEVsKG1ha2VFbCgndGgnKSwgbWFrZVRleHQoY2hhcmFjdGVyTmFtZSkpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyh0aCwgYGRlcGVuZGVudGApO1xyXG4gICAgICAgICAgICBzZXRBdHRyKHRoLCAnZGVwZW5kZW50LWluZGV4JywgaSk7XHJcbiAgICAgICAgICAgIHJldHVybiB0aDtcclxuICAgICAgICB9KTtcclxuICAgICAgICBhZGRFbCh0YWJsZSwgYWRkRWxzKG1ha2VFbCgndHInKSwgUi5jb25jYXQoW2V2ZW50TmFtZV0sIGVscykpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBhcHBlbmRUYWJsZUlucHV0KHRhYmxlLCBldmVudCwgaSwgY2hhcmFjdGVyQXJyYXkpIHtcclxuICAgICAgICBjb25zdCB0ciA9IG1ha2VFbCgndHInKTtcclxuICAgICAgICBsZXQgdGQgPSBtYWtlRWwoJ3RkJyk7XHJcbiAgICAgICAgdGQuYXBwZW5kQ2hpbGQobWFrZVRleHQoZXZlbnQubmFtZSkpO1xyXG4gICAgICAgIHRyLmFwcGVuZENoaWxkKHRkKTtcclxuXHJcbiAgICAgICAgYWRkRWxzKHRyLCBjaGFyYWN0ZXJBcnJheS5tYXAoKGNoYXJhY3RlciwgaikgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0ZCA9IHFtdGUoYCR7cm9vdH0gLmV2ZW50LXByZXNlbmNlLWNlbGxgKTtcclxuICAgICAgICAgICAgYWRkQ2xhc3ModGQsIGBkZXBlbmRlbnRgKTtcclxuICAgICAgICAgICAgc2V0QXR0cih0ZCwgJ2RlcGVuZGVudC1pbmRleCcsIGopO1xyXG4gICAgICAgICAgICBjb25zdCBpbnB1dCA9IHFlZSh0ZCwgJ2lucHV0Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gcWVlKHRkLCAnbGFiZWwnKTtcclxuICAgICAgICAgICAgaWYgKGV2ZW50LmNoYXJhY3RlcnNbY2hhcmFjdGVyXSkge1xyXG4gICAgICAgICAgICAgICAgaW5wdXQuY2hlY2tlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaW5wdXQuZXZlbnRJbmRleCA9IGk7XHJcbiAgICAgICAgICAgIGlucHV0LmV2ZW50TmFtZSA9IGV2ZW50Lm5hbWU7XHJcbiAgICAgICAgICAgIGlucHV0LmNoYXJhY3Rlck5hbWUgPSBjaGFyYWN0ZXI7XHJcbiAgICAgICAgICAgIGlucHV0Lmhhc1RleHQgPSBldmVudC5jaGFyYWN0ZXJzW2NoYXJhY3Rlcl0gIT09IHVuZGVmaW5lZCAmJiBldmVudC5jaGFyYWN0ZXJzW2NoYXJhY3Rlcl0udGV4dCAhPT0gJyc7XHJcbiAgICAgICAgICAgIGlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIG9uQ2hhbmdlQ2hhcmFjdGVyQ2hlY2tib3gpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc3Qgc3BhbiA9IHFlZSh0ZCwgJ3NwYW4nKTtcclxuICAgICAgICAgICAgaWYoZXZlbnQuY2hhcmFjdGVyc1tjaGFyYWN0ZXJdICE9PSB1bmRlZmluZWQpe1xyXG4gICAgICAgICAgICAgICAgaWYoZXZlbnQuY2hhcmFjdGVyc1tjaGFyYWN0ZXJdLnJlYWR5KXtcclxuICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyhzcGFuLCAnZmluaXNoZWQnKTtcclxuICAgICAgICAgICAgICAgICAgICBzZXRBdHRyKHNwYW4sICd0aXRsZScsIEwxMG4uZ2V0KCdhZGFwdGF0aW9ucycsICdhZGFwdGF0aW9uLWZpbmlzaGVkJykpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlucHV0Lmhhc1RleHQpIHtcclxuICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyhzcGFuLCAnaW4tcHJvZ3Jlc3MnKTtcclxuICAgICAgICAgICAgICAgICAgICBzZXRBdHRyKHNwYW4sICd0aXRsZScsIEwxMG4uZ2V0KCdhZGFwdGF0aW9ucycsICdhZGFwdGF0aW9uLWluLXByb2dyZXNzJykpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zdCBpZCA9IGkgKyBjaGFyYWN0ZXI7XHJcbiAgICAgICAgICAgIHNldEF0dHIoaW5wdXQsICdpZCcsIGlkKTtcclxuICAgICAgICAgICAgc2V0QXR0cihsYWJlbCwgJ2ZvcicsIGlkKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRkO1xyXG4gICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgdGFibGUuYXBwZW5kQ2hpbGQodHIpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG9uQ2hhbmdlQ2hhcmFjdGVyQ2hlY2tib3goZXZlbnQpIHtcclxuICAgICAgICBpZiAoZXZlbnQudGFyZ2V0LmNoZWNrZWQpIHtcclxuICAgICAgICAgICAgREJNUy5hZGRDaGFyYWN0ZXJUb0V2ZW50KFxyXG4gICAgICAgICAgICAgICAgU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksXHJcbiAgICAgICAgICAgICAgICBldmVudC50YXJnZXQuZXZlbnRJbmRleCwgZXZlbnQudGFyZ2V0LmNoYXJhY3Rlck5hbWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIGlmICghZXZlbnQudGFyZ2V0Lmhhc1RleHQpIHtcclxuICAgICAgICAgICAgREJNUy5yZW1vdmVDaGFyYWN0ZXJGcm9tRXZlbnQoXHJcbiAgICAgICAgICAgICAgICBTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSxcclxuICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC5ldmVudEluZGV4LCBldmVudC50YXJnZXQuY2hhcmFjdGVyTmFtZSwgVXRpbHMucHJvY2Vzc0Vycm9yKClcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBVdGlscy5jb25maXJtKHN0ckZvcm1hdChcclxuICAgICAgICAgICAgICAgIGdldEwxMG4oJ3N0b3JpZXMtcmVtb3ZlLWNoYXJhY3Rlci1mcm9tLWV2ZW50LXdhcm5pbmcnKSxcclxuICAgICAgICAgICAgICAgIFtldmVudC50YXJnZXQuY2hhcmFjdGVyTmFtZSwgZXZlbnQudGFyZ2V0LmV2ZW50TmFtZV1cclxuICAgICAgICAgICAgKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgREJNUy5yZW1vdmVDaGFyYWN0ZXJGcm9tRXZlbnQoXHJcbiAgICAgICAgICAgICAgICAgICAgU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksXHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LmV2ZW50SW5kZXgsIGV2ZW50LnRhcmdldC5jaGFyYWN0ZXJOYW1lLCBVdGlscy5wcm9jZXNzRXJyb3IoKVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LmNoZWNrZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0pKHRoaXMuRXZlbnRQcmVzZW5jZSA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNUywgU3RvcnlFdmVudHMsIFN0b3J5Q2hhcmFjdGVycywgRXZlbnRQcmVzZW5jZVxyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuICAgIGNvbnN0IHJvb3QgPSAnLnN0b3JpZXMtdGFiICc7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNyZWF0ZVN0b3J5RGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2cocm9vdCwgY3JlYXRlU3RvcnksIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnbW9kYWwtcHJvbXB0LWJvZHknLFxyXG4gICAgICAgICAgICBkaWFsb2dUaXRsZTogJ3N0b3JpZXMtZW50ZXItc3RvcnktbmFtZScsXHJcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLWNyZWF0ZScsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHJlbmFtZVN0b3J5RGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2cocm9vdCwgcmVuYW1lU3RvcnksIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnbW9kYWwtcHJvbXB0LWJvZHknLFxyXG4gICAgICAgICAgICBkaWFsb2dUaXRsZTogJ3N0b3JpZXMtZW50ZXItbmV3LXN0b3J5LW5hbWUnLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1yZW5hbWUnLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBzdGF0ZS5sZWZ0ID0geyB2aWV3czoge30gfTtcclxuICAgICAgICBzdGF0ZS5yaWdodCA9IHsgdmlld3M6IHt9IH07XHJcbiAgICAgICAgbGV0IGNvbnRhaW5lcnMgPSB7XHJcbiAgICAgICAgICAgIHJvb3Q6IHN0YXRlLmxlZnQsXHJcbiAgICAgICAgICAgIG5hdmlnYXRpb246IHF1ZXJ5RWwoJy5zdG9yaWVzLW5hdmlnYXRpb24tY29udGFpbmVyIC5sZWZ0LXNpZGUnKSxcclxuICAgICAgICAgICAgY29udGVudDogcXVlcnlFbCgnLnN0b3JpZXMtY29udGVudC1jb250YWluZXIgLmxlZnQtc2lkZScpXHJcbiAgICAgICAgfTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsICd3cml0ZXItc3RvcnknLCBXcml0ZXJTdG9yeSwgeyBtYWluUGFnZTogdHJ1ZSwgdG9nZ2xlOiB0cnVlIH0pO1xyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgJ3N0b3J5LWV2ZW50cycsIFN0b3J5RXZlbnRzLCB7IHRvZ2dsZTogdHJ1ZSB9KTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsICdzdG9yeS1jaGFyYWN0ZXJzJywgU3RvcnlDaGFyYWN0ZXJzLCB7IHRvZ2dsZTogdHJ1ZSB9KTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsICdldmVudC1wcmVzZW5jZScsIEV2ZW50UHJlc2VuY2UsIHsgdG9nZ2xlOiB0cnVlIH0pO1xyXG4gICAgICAgIGNvbnRhaW5lcnMgPSB7XHJcbiAgICAgICAgICAgIHJvb3Q6IHN0YXRlLnJpZ2h0LFxyXG4gICAgICAgICAgICBuYXZpZ2F0aW9uOiBxdWVyeUVsKCcuc3Rvcmllcy1uYXZpZ2F0aW9uLWNvbnRhaW5lciAucmlnaHQtc2lkZScpLFxyXG4gICAgICAgICAgICBjb250ZW50OiBxdWVyeUVsKCcuc3Rvcmllcy1jb250ZW50LWNvbnRhaW5lciAucmlnaHQtc2lkZScpXHJcbiAgICAgICAgfTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsICd3cml0ZXItc3RvcnknLCBXcml0ZXJTdG9yeSwgeyB0b2dnbGU6IHRydWUgfSk7XHJcbiAgICAgICAgVXRpbHMuYWRkVmlldyhjb250YWluZXJzLCAnc3RvcnktZXZlbnRzJywgU3RvcnlFdmVudHMsIHsgbWFpblBhZ2U6IHRydWUsIHRvZ2dsZTogdHJ1ZSB9KTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsICdzdG9yeS1jaGFyYWN0ZXJzJywgU3RvcnlDaGFyYWN0ZXJzLCB7IHRvZ2dsZTogdHJ1ZSB9KTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsICdldmVudC1wcmVzZW5jZScsIEV2ZW50UHJlc2VuY2UsIHsgdG9nZ2xlOiB0cnVlIH0pO1xyXG5cclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5yZW1vdmUuc3RvcnlgKSwgJ2NsaWNrJywgcmVtb3ZlU3RvcnkpO1xyXG5cclxuICAgICAgICBsaXN0ZW4ocWUoYCR7cm9vdH0uY3JlYXRlLnN0b3J5YCksICdjbGljaycsICgpID0+IGNyZWF0ZVN0b3J5RGlhbG9nLnNob3dEbGcoKSk7XHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9LnJlbmFtZS5zdG9yeWApLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHFlZShyZW5hbWVTdG9yeURpYWxvZywgJy5lbnRpdHktaW5wdXQnKS52YWx1ZSA9IHF1ZXJ5RWwoYCR7cm9vdH0jc3RvcnlTZWxlY3RvcmApLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICAgICAgcmVuYW1lU3RvcnlEaWFsb2cuc2hvd0RsZygpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBsaXN0ZW4ocWUoYCR7cm9vdH0uY3JlYXRlLmV2ZW50YCksICdjbGljaycsICgpID0+IFN0b3J5RXZlbnRzLmNyZWF0ZUV2ZW50RGlhbG9nLnNob3dEbGcoKSk7XHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9LmFkZC5jaGFyYWN0ZXJgKSwgJ2NsaWNrJywgKCkgPT4gU3RvcnlDaGFyYWN0ZXJzLmFkZENoYXJhY3RlckRpYWxvZy5zaG93RGxnKCkpO1xyXG5cclxuICAgICAgICAkKCcjc3RvcnlTZWxlY3RvcicpLnNlbGVjdDIoKS5vbignY2hhbmdlJywgb25TdG9yeVNlbGVjdG9yQ2hhbmdlRGVsZWdhdGUpO1xyXG5cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLmNoYWluUmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBpZiAoKHN0YXRlLmxlZnQuY3VycmVudFZpZXcgJiYgc3RhdGUubGVmdC5jdXJyZW50Vmlldy5uYW1lID09PSAnRXZlbnRQcmVzZW5jZScpIHx8XHJcbiAgICAgICAgICAgIChzdGF0ZS5yaWdodC5jdXJyZW50VmlldyAmJiBzdGF0ZS5yaWdodC5jdXJyZW50Vmlldy5uYW1lID09PSAnRXZlbnRQcmVzZW5jZScpKSB7XHJcbiAgICAgICAgICAgIEV2ZW50UHJlc2VuY2UucmVmcmVzaCgpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHN0b3J5U2VsZWN0b3IgPSBjbGVhckVsKGdldEVsKCdzdG9yeVNlbGVjdG9yJykpO1xyXG5cclxuICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheSgnc3RvcnknLCBmYWxzZSwgKGVyciwgYWxsU3RvcnlOYW1lcykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBjb25zdCBkYXRhID0gZ2V0U2VsZWN0MkRhdGEoYWxsU3RvcnlOYW1lcyk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBVdGlscy5lbmFibGVFbChxZShgJHtyb290fS5yZW5hbWUuc3RvcnlgKSwgYWxsU3RvcnlOYW1lcy5sZW5ndGggPiAwKTtcclxuICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwocWUoYCR7cm9vdH0ucmVtb3ZlLnN0b3J5YCksIGFsbFN0b3J5TmFtZXMubGVuZ3RoID4gMCk7XHJcbiAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKHFlKGAke3Jvb3R9LmNyZWF0ZS5ldmVudGApLCBhbGxTdG9yeU5hbWVzLmxlbmd0aCA+IDApO1xyXG4gICAgICAgICAgICBVdGlscy5lbmFibGVFbChxZShgJHtyb290fS5hZGQuY2hhcmFjdGVyYCksIGFsbFN0b3J5TmFtZXMubGVuZ3RoID4gMCk7XHJcbiAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKHFlKGAke3Jvb3R9I3N0b3J5U2VsZWN0b3JgKSwgYWxsU3RvcnlOYW1lcy5sZW5ndGggPiAwKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fS5hbGVydGApLCBhbGxTdG9yeU5hbWVzLmxlbmd0aCA9PT0gMCk7XHJcbiAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fS5zdG9yaWVzLW1haW4tY29udGFpbmVyYCksIGFsbFN0b3J5TmFtZXMubGVuZ3RoICE9PSAwKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGlmIChhbGxTdG9yeU5hbWVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHN0b3J5TmFtZSA9IGdldFNlbGVjdGVkU3RvcnlOYW1lKGFsbFN0b3J5TmFtZXMpO1xyXG4gICAgICAgICAgICAgICAgJCgnI3N0b3J5U2VsZWN0b3InKS5zZWxlY3QyKGRhdGEpLnZhbChzdG9yeU5hbWUpLnRyaWdnZXIoJ2NoYW5nZScpO1xyXG4gICAgICAgICAgICAgICAgb25TdG9yeVNlbGVjdG9yQ2hhbmdlKHN0b3J5TmFtZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAkKCcjc3RvcnlTZWxlY3RvcicpLnNlbGVjdDIoZGF0YSk7XHJcbiAgICAgICAgICAgICAgICBvblN0b3J5U2VsZWN0b3JDaGFuZ2UoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgUi52YWx1ZXMoc3RhdGUubGVmdC52aWV3cykuZm9yRWFjaCh2aWV3ID0+IHZpZXcucmVmcmVzaCgpKTtcclxuICAgICAgICAgICAgaWYgKHN0YXRlLmxlZnQuY3VycmVudFZpZXcpc3RhdGUubGVmdC5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgIGlmIChzdGF0ZS5yaWdodC5jdXJyZW50VmlldylzdGF0ZS5yaWdodC5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIGdldFNlbGVjdGVkU3RvcnlOYW1lKHN0b3J5TmFtZXMpIHtcclxuICAgICAgICBjb25zdCBzZXR0aW5ncyA9IERCTVMuZ2V0U2V0dGluZ3MoKTtcclxuICAgICAgICBpZiAoIXNldHRpbmdzLlN0b3JpZXMpIHtcclxuICAgICAgICAgICAgc2V0dGluZ3MuU3RvcmllcyA9IHtcclxuICAgICAgICAgICAgICAgIHN0b3J5TmFtZTogc3RvcnlOYW1lc1swXS52YWx1ZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgeyBzdG9yeU5hbWUgfSA9IHNldHRpbmdzLlN0b3JpZXM7XHJcbiAgICAgICAgaWYgKHN0b3J5TmFtZXMubWFwKG5hbWVJbmZvID0+IG5hbWVJbmZvLnZhbHVlKS5pbmRleE9mKHN0b3J5TmFtZSkgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIHNldHRpbmdzLlN0b3JpZXMuc3RvcnlOYW1lID0gc3RvcnlOYW1lc1swXS52YWx1ZTtcclxuICAgICAgICAgICAgc3RvcnlOYW1lID0gc3RvcnlOYW1lc1swXS52YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHN0b3J5TmFtZTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjcmVhdGVTdG9yeShkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBpbnB1dCA9IHFlZShkaWFsb2csICcuZW50aXR5LWlucHV0Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHN0b3J5TmFtZSA9IGlucHV0LnZhbHVlLnRyaW0oKTtcclxuXHJcbiAgICAgICAgICAgIERCTVMuY3JlYXRlU3Rvcnkoc3RvcnlOYW1lLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB1cGRhdGVTZXR0aW5ncyhzdG9yeU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5yZWZyZXNoKChlcnIyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVuYW1lU3RvcnkoZGlhbG9nKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdG9JbnB1dCA9IHFlZShkaWFsb2csICcuZW50aXR5LWlucHV0Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGZyb21OYW1lID0gcXVlcnlFbChgJHtyb290fSNzdG9yeVNlbGVjdG9yYCkudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICBjb25zdCB0b05hbWUgPSB0b0lucHV0LnZhbHVlLnRyaW0oKTtcclxuXHJcbiAgICAgICAgICAgIERCTVMucmVuYW1lU3RvcnkoZnJvbU5hbWUsIHRvTmFtZSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEVycm9yKGRpYWxvZywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlU2V0dGluZ3ModG9OYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIucmVmcmVzaCgoZXJyMikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvSW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVtb3ZlU3RvcnkoKSB7XHJcbiAgICAgICAgY29uc3QgbmFtZSA9IHF1ZXJ5RWwoYCR7cm9vdH0jc3RvcnlTZWxlY3RvcmApLnZhbHVlLnRyaW0oKTtcclxuXHJcbiAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQoZ2V0TDEwbignc3Rvcmllcy1hcmUteW91LXN1cmUtYWJvdXQtc3RvcnktcmVtb3ZpbmcnKSwgW25hbWVdKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICBEQk1TLnJlbW92ZVN0b3J5KG5hbWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIucmVmcmVzaCgoZXJyMikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBvblN0b3J5U2VsZWN0b3JDaGFuZ2VEZWxlZ2F0ZShldmVudCkge1xyXG4gICAgICAgIGNvbnN0IHN0b3J5TmFtZSA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICBvblN0b3J5U2VsZWN0b3JDaGFuZ2Uoc3RvcnlOYW1lKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBvblN0b3J5U2VsZWN0b3JDaGFuZ2Uoc3RvcnlOYW1lKSB7XHJcbiAgICAgICAgc3RhdGUuQ3VycmVudFN0b3J5TmFtZSA9IHN0b3J5TmFtZTtcclxuXHJcbiAgICAgICAgaWYgKHN0b3J5TmFtZSkge1xyXG4gICAgICAgICAgICB1cGRhdGVTZXR0aW5ncyhzdG9yeU5hbWUpO1xyXG4gICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuaXNFbnRpdHlFZGl0YWJsZSgnc3RvcnknLCBzdG9yeU5hbWUsIChlcnIsIGlzU3RvcnlFZGl0YWJsZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5sZWZ0LmN1cnJlbnRWaWV3KXN0YXRlLmxlZnQuY3VycmVudFZpZXcucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLnJpZ2h0LmN1cnJlbnRWaWV3KXN0YXRlLnJpZ2h0LmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmVuYWJsZShleHBvcnRzLmNvbnRlbnQsICdpc1N0b3J5RWRpdGFibGUnLCBpc1N0b3J5RWRpdGFibGUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2UgeyAvLyB3aGVuIHRoZXJlIGFyZSBubyBzdG9yaWVzIGF0IGFsbFxyXG4gICAgICAgICAgICB1cGRhdGVTZXR0aW5ncyhudWxsKTtcclxuICAgICAgICAgICAgaWYgKHN0YXRlLmxlZnQuY3VycmVudFZpZXcpc3RhdGUubGVmdC5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgIGlmIChzdGF0ZS5yaWdodC5jdXJyZW50VmlldylzdGF0ZS5yaWdodC5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydHMuZ2V0Q3VycmVudFN0b3J5TmFtZSA9ICgpID0+IHN0YXRlLkN1cnJlbnRTdG9yeU5hbWU7XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlU2V0dGluZ3Moc3RvcnlOYW1lKSB7XHJcbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSBEQk1TLmdldFNldHRpbmdzKCk7XHJcbiAgICAgICAgc2V0dGluZ3MuU3Rvcmllcy5zdG9yeU5hbWUgPSBzdG9yeU5hbWU7XHJcbiAgICB9XHJcbn0pKHRoaXMuU3RvcmllcyA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNS0yMDE4IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG4gICAgY29uc3Qgcm9vdCA9ICcuc3RvcnktY2hhcmFjdGVycy10YWIgJztcclxuICAgIGNvbnN0IHN1cGVyUm9vdCA9ICcuc3Rvcmllcy10YWIgJztcclxuICAgIGxldCBpbml0aWFsaXplZCA9IGZhbHNlO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBpZiAoaW5pdGlhbGl6ZWQpIHJldHVybjtcclxuICAgICAgICBleHBvcnRzLmFkZENoYXJhY3RlckRpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHN1cGVyUm9vdCwgYWRkQ2hhcmFjdGVyLCB7XHJcbiAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ21vZGFsLWFkZC1jaGFyYWN0ZXItYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnc3Rvcmllcy1hZGQtY2hhcmFjdGVyLXRpdGxlJyxcclxuICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tYWRkJyxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgc3RhdGUuc3dpdGNoQ2hhcmFjdGVyRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2cocm9vdCwgc3dpdGNoQ2hhcmFjdGVycywge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdtb2RhbC1zd2l0Y2gtZXZlbnQtYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnc3Rvcmllcy1zd2l0Y2gtY2hhcmFjdGVyLXRpdGxlJyxcclxuICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tcmVwbGFjZScsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICAgICAgaW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgY2xlYXJFbChxdWVyeUVsKGAke3N1cGVyUm9vdH0uc3RvcnlDaGFyYWN0ZXJzQWRkU2VsZWN0b3JgKSk7XHJcbiAgICAgICAgY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LnN0b3J5Q2hhcmFjdGVyc1RvU2VsZWN0b3JgKSk7XHJcblxyXG4gICAgICAgIGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5zdG9yeUNoYXJhY3RlcnNUYWJsZWApKTtcclxuXHJcbiAgICAgICAgaWYgKCFTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSkgeyByZXR1cm47IH1cclxuXHJcbiAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmlzRW50aXR5RWRpdGFibGUoJ3N0b3J5JywgU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksIChlcnIsIGlzU3RvcnlFZGl0YWJsZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheSgnY2hhcmFjdGVyJywgZmFsc2UsIChlcnIyLCBhbGxDaGFyYWN0ZXJzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBEQk1TLmdldFN0b3J5Q2hhcmFjdGVycyhTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSwgKGVycjMsIGxvY2FsQ2hhcmFjdGVycykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIzKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjMpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICByZWJ1aWxkSW50ZXJmYWNlKGFsbENoYXJhY3RlcnMsIGxvY2FsQ2hhcmFjdGVycyk7XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlKGV4cG9ydHMuY29udGVudCwgJ2lzU3RvcnlFZGl0YWJsZScsIGlzU3RvcnlFZGl0YWJsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgU3Rvcmllcy5jaGFpblJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gcmVidWlsZEludGVyZmFjZShhbGxDaGFyYWN0ZXJzLCBsb2NhbENoYXJhY3RlcnMpIHtcclxuICAgICAgICBjb25zdCBhZGRBcnJheSA9IFtdO1xyXG4gICAgICAgIGNvbnN0IHJlbW92ZUFycmF5ID0gW107XHJcblxyXG4gICAgICAgIGFsbENoYXJhY3RlcnMuZmlsdGVyKG5hbWVJbmZvID0+ICFsb2NhbENoYXJhY3RlcnNbbmFtZUluZm8udmFsdWVdKS5mb3JFYWNoKChuYW1lSW5mbykgPT4ge1xyXG4gICAgICAgICAgICBhZGRBcnJheS5wdXNoKG5hbWVJbmZvKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgYWxsQ2hhcmFjdGVycy5maWx0ZXIobmFtZUluZm8gPT4gbG9jYWxDaGFyYWN0ZXJzW25hbWVJbmZvLnZhbHVlXSkuZm9yRWFjaCgobmFtZUluZm8pID0+IHtcclxuICAgICAgICAgICAgcmVtb3ZlQXJyYXkucHVzaChuYW1lSW5mbyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGFkZEFycmF5LnNvcnQoVXRpbHMuY2hhck9yZEFPYmplY3QpO1xyXG4gICAgICAgIHJlbW92ZUFycmF5LnNvcnQoVXRpbHMuY2hhck9yZEFPYmplY3QpO1xyXG5cclxuICAgICAgICBjb25zdCBhZGREYXRhID0gZ2V0U2VsZWN0MkRhdGEoYWRkQXJyYXkpO1xyXG4gICAgICAgIGNvbnN0IHJlbW92ZURhdGEgPSBnZXRTZWxlY3QyRGF0YShyZW1vdmVBcnJheSk7XHJcblxyXG4gICAgICAgICQocXVlcnlFbChgJHtzdXBlclJvb3R9LnN0b3J5Q2hhcmFjdGVyc0FkZFNlbGVjdG9yYCkpLnNlbGVjdDIoe1xyXG4gICAgICAgICAgICBkYXRhOiBhZGREYXRhLmRhdGEsXHJcbiAgICAgICAgICAgIGRyb3Bkb3duUGFyZW50OiAkKGV4cG9ydHMuYWRkQ2hhcmFjdGVyRGlhbG9nKVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgICQocXVlcnlFbChgJHtyb290fS5zdG9yeUNoYXJhY3RlcnNUb1NlbGVjdG9yYCkpLnNlbGVjdDIoe1xyXG4gICAgICAgICAgICBkYXRhOiBhZGREYXRhLmRhdGEsXHJcbiAgICAgICAgICAgIGRyb3Bkb3duUGFyZW50OiAkKHN0YXRlLnN3aXRjaENoYXJhY3RlckRpYWxvZylcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgdGFibGUgPSBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uc3RvcnlDaGFyYWN0ZXJzVGFibGVgKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgc2hvd0VsKHFlKGAke3Jvb3R9IHRhYmxlYCksIFIua2V5cyhsb2NhbENoYXJhY3RlcnMpLmxlbmd0aCAhPT0gMCApO1xyXG4gICAgICAgIHNob3dFbChxZShgJHtyb290fSAuYWxlcnRgKSwgUi5rZXlzKGxvY2FsQ2hhcmFjdGVycykubGVuZ3RoID09PSAwICk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmVtb3ZlQXJyYXkuZm9yRWFjaCgocmVtb3ZlVmFsdWUpID0+IHtcclxuICAgICAgICAgICAgYWRkRWwodGFibGUsIGdldENoYXJhY3RlcklucHV0KHJlbW92ZVZhbHVlLCBsb2NhbENoYXJhY3RlcnNbcmVtb3ZlVmFsdWUudmFsdWVdKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gYWRkQ2hhcmFjdGVyKGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNoYXJhY3Rlck5hbWUgPSBxdWVyeUVsKGAke3N1cGVyUm9vdH0uc3RvcnlDaGFyYWN0ZXJzQWRkU2VsZWN0b3JgKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIERCTVMuYWRkU3RvcnlDaGFyYWN0ZXIoU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksIGNoYXJhY3Rlck5hbWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZy5oaWRlRGxnKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc3dpdGNoQ2hhcmFjdGVycyhkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0b05hbWUgPSBxdWVyeUVsKGAke3Jvb3R9LnN0b3J5Q2hhcmFjdGVyc1RvU2VsZWN0b3JgKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIERCTVMuc3dpdGNoU3RvcnlDaGFyYWN0ZXJzKFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLCBkaWFsb2cuY2hhcmFjdGVyTmFtZSwgdG9OYW1lLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlbW92ZUNoYXJhY3RlcihjaGFyYWN0ZXJOYW1lKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQoZ2V0TDEwbignc3Rvcmllcy1yZW1vdmUtY2hhcmFjdGVyLWZyb20tc3Rvcnktd2FybmluZycpLCBbY2hhcmFjdGVyTmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLnJlbW92ZVN0b3J5Q2hhcmFjdGVyKFxyXG4gICAgICAgICAgICAgICAgICAgIFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLFxyXG4gICAgICAgICAgICAgICAgICAgIGNoYXJhY3Rlck5hbWUsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldENoYXJhY3RlcklucHV0KGNoYXJhY3Rlck1ldGEsIGNoYXJhY3Rlcikge1xyXG4gICAgICAgIGNvbnN0IGVsID0gd3JhcEVsKCd0cicsIHF0ZShgJHtyb290fSAuc3RvcnktY2hhcmFjdGVyLXJvdy10bXBsYCkpO1xyXG4gICAgICAgIEwxMG4ubG9jYWxpemVTdGF0aWMoZWwpO1xyXG4gICAgICAgIGNvbnN0IHFlID0gcWVlKGVsKTtcclxuXHJcbiAgICAgICAgYWRkRWwocWUoJy5jaGFyYWN0ZXItbmFtZScpLCBtYWtlVGV4dChjaGFyYWN0ZXJNZXRhLmRpc3BsYXlOYW1lKSk7XHJcblxyXG4gICAgICAgIGxldCBpbnB1dCA9IHFlKCcuaW52ZW50b3J5SW5wdXQnKTtcclxuICAgICAgICBpbnB1dC52YWx1ZSA9IGNoYXJhY3Rlci5pbnZlbnRvcnk7XHJcbiAgICAgICAgaW5wdXQuY2hhcmFjdGVyTmFtZSA9IGNoYXJhY3Rlci5uYW1lO1xyXG4gICAgICAgIGxpc3RlbihpbnB1dCwgJ2NoYW5nZScsIHVwZGF0ZUNoYXJhY3RlckludmVudG9yeSk7XHJcblxyXG4gICAgICAgIENvbnN0YW50cy5jaGFyYWN0ZXJBY3Rpdml0eVR5cGVzLmZvckVhY2goKGFjdGl2aXR5VHlwZSkgPT4ge1xyXG4gICAgICAgICAgICBpbnB1dCA9IHFlKGAuJHthY3Rpdml0eVR5cGV9IGlucHV0YCk7XHJcbiAgICAgICAgICAgIGlmIChjaGFyYWN0ZXIuYWN0aXZpdHlbYWN0aXZpdHlUeXBlXSkge1xyXG4gICAgICAgICAgICAgICAgaW5wdXQuY2hlY2tlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaW5wdXQuY2hhcmFjdGVyTmFtZSA9IGNoYXJhY3Rlci5uYW1lO1xyXG4gICAgICAgICAgICBpbnB1dC5hY3Rpdml0eVR5cGUgPSBhY3Rpdml0eVR5cGU7XHJcbiAgICAgICAgICAgIGxpc3RlbihpbnB1dCwgJ2NoYW5nZScsIG9uQ2hhbmdlQ2hhcmFjdGVyQWN0aXZpdHkpO1xyXG4gICAgICAgICAgICBzZXRBdHRyKGlucHV0LCAnaWQnLCBjaGFyYWN0ZXIubmFtZSArIGFjdGl2aXR5VHlwZSk7XHJcbiAgICAgICAgICAgIHNldEF0dHIocWUoYC4ke2FjdGl2aXR5VHlwZX0gbGFiZWxgKSwgJ2ZvcicsIGNoYXJhY3Rlci5uYW1lICsgYWN0aXZpdHlUeXBlKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbGlzdGVuKHFlKCcucmVwbGFjZS5jaGFyYWN0ZXInKSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBzdGF0ZS5zd2l0Y2hDaGFyYWN0ZXJEaWFsb2cuY2hhcmFjdGVyTmFtZSA9IGNoYXJhY3Rlci5uYW1lO1xyXG4gICAgICAgICAgICBzdGF0ZS5zd2l0Y2hDaGFyYWN0ZXJEaWFsb2cuc2hvd0RsZygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxpc3RlbihxZSgnLnJlbW92ZS5jaGFyYWN0ZXInKSwgJ2NsaWNrJywgcmVtb3ZlQ2hhcmFjdGVyKGNoYXJhY3Rlci5uYW1lKSk7XHJcbiAgICAgICAgcmV0dXJuIGVsO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZUNoYXJhY3RlckludmVudG9yeShldmVudCkge1xyXG4gICAgICAgIERCTVMudXBkYXRlQ2hhcmFjdGVySW52ZW50b3J5KFxyXG4gICAgICAgICAgICBTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSxcclxuICAgICAgICAgICAgZXZlbnQudGFyZ2V0LmNoYXJhY3Rlck5hbWUsIGV2ZW50LnRhcmdldC52YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKClcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG9uQ2hhbmdlQ2hhcmFjdGVyQWN0aXZpdHkoZXZlbnQpIHtcclxuICAgICAgICBEQk1TLm9uQ2hhbmdlQ2hhcmFjdGVyQWN0aXZpdHkoXHJcbiAgICAgICAgICAgIFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLCBldmVudC50YXJnZXQuY2hhcmFjdGVyTmFtZSxcclxuICAgICAgICAgICAgZXZlbnQudGFyZ2V0LmFjdGl2aXR5VHlwZSwgZXZlbnQudGFyZ2V0LmNoZWNrZWQsIFV0aWxzLnByb2Nlc3NFcnJvcigpXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxufSkodGhpcy5TdG9yeUNoYXJhY3RlcnMgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcbiAgICBjb25zdCByb290ID0gJy5zdG9yeS1ldmVudHMtdGFiICc7XHJcbiAgICBsZXQgaW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgaWYgKGluaXRpYWxpemVkKSByZXR1cm47XHJcbiAgICAgICAgZXhwb3J0cy5jcmVhdGVFdmVudERpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKCcuc3Rvcmllcy10YWIgJywgY3JlYXRlRXZlbnQsIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnY3JlYXRlLWV2ZW50LWJvZHknLFxyXG4gICAgICAgICAgICBkaWFsb2dUaXRsZTogJ3N0b3JpZXMtZXZlbnQtY3JlYXRpb24nLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1jcmVhdGUnLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9LmNyZWF0ZS5ldmVudGApLCAnY2xpY2snLCAoKSA9PiBjcmVhdGVFdmVudERpYWxvZy5zaG93RGxnKCkpO1xyXG5cclxuICAgICAgICBzdGF0ZS5tb3ZlRXZlbnREaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhyb290LCBtb3ZlRXZlbnQsIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnbW92ZS1ldmVudC1ib2R5JyxcclxuICAgICAgICAgICAgZGlhbG9nVGl0bGU6ICdzdG9yaWVzLW1vdmUtZXZlbnQnLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1tb3ZlJyxcclxuICAgICAgICB9KTtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxZShyb290KTtcclxuICAgICAgICBpbml0aWFsaXplZCA9IHRydWU7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBjbGVhckludGVyZmFjZSgpO1xyXG4gICAgICAgIGlmIChTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5pc0VudGl0eUVkaXRhYmxlKCdzdG9yeScsIFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLCAoZXJyLCBpc1N0b3J5RWRpdGFibGUpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgREJNUy5nZXRNZXRhSW5mbygoZXJyMiwgbWV0YUluZm8pID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0U3RvcnlFdmVudHMoU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksIChlcnIzLCBldmVudHMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmVidWlsZEludGVyZmFjZShldmVudHMsIG1ldGFJbmZvKTtcclxuICAgICAgICAgICAgICAgICAgICBVdGlscy5lbmFibGUoZXhwb3J0cy5jb250ZW50LCAnaXNTdG9yeUVkaXRhYmxlJywgaXNTdG9yeUVkaXRhYmxlKTtcclxuICAgICAgICAgICAgICAgICAgICBTdG9yaWVzLmNoYWluUmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBjbGVhckludGVyZmFjZSgpIHtcclxuICAgICAgICBjbGVhckVsKGdldEVsKCdldmVudEJsb2NrJykpO1xyXG4gICAgICAgIGNvbnN0IHBvc2l0aW9uU2VsZWN0b3JzID0gbmwyYXJyYXkoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmV2ZW50UG9zaXRpb25TZWxlY3RvcicpKTtcclxuICAgICAgICBSLmFwKFtjbGVhckVsXSwgcG9zaXRpb25TZWxlY3RvcnMpO1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdG9yQXJyID0gbmwyYXJyYXkoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmV2ZW50RWRpdFNlbGVjdG9yJykpO1xyXG4gICAgICAgIFIuYXAoW2NsZWFyRWxdLCBzZWxlY3RvckFycik7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVidWlsZEludGVyZmFjZShldmVudHMsIG1ldGFJbmZvKSB7XHJcbiAgICAgICAgLy8gZXZlbnQgcGFydFxyXG4gICAgICAgIGNvbnN0IHRhYmxlID0gY2xlYXJFbChnZXRFbCgnZXZlbnRCbG9jaycpKTtcclxuICAgICAgICBcclxuICAgICAgICBzaG93RWwodGFibGUsIGV2ZW50cy5sZW5ndGggIT09IDAgKTtcclxuICAgICAgICBzaG93RWwocWUoYCR7cm9vdH0gLmFsZXJ0YCksIGV2ZW50cy5sZW5ndGggPT09IDAgKTtcclxuXHJcbiAgICAgICAgLy8gcmVmcmVzaCBwb3NpdGlvbiBzZWxlY3RvclxyXG4gICAgICAgIGNvbnN0IGFkZE9wdCA9IFIuY3VycnkoKHNlbCwgdGV4dCkgPT4ge1xyXG4gICAgICAgICAgICBhZGRFbChzZWwsIGFkZEVsKG1ha2VFbCgnb3B0aW9uJyksIG1ha2VUZXh0KHRleHQpKSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxldCBvcHRpb24sIGFkZE9wdExvYztcclxuICAgICAgICBjb25zdCBwb3NpdGlvblNlbGVjdG9ycyA9IG5sMmFycmF5KGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5ldmVudFBvc2l0aW9uU2VsZWN0b3InKSk7XHJcbiAgICAgICAgUi5hcChbY2xlYXJFbF0sIHBvc2l0aW9uU2VsZWN0b3JzKTtcclxuICAgICAgICBwb3NpdGlvblNlbGVjdG9ycy5mb3JFYWNoKChwb3NpdGlvblNlbGVjdG9yKSA9PiB7XHJcbiAgICAgICAgICAgIGFkZE9wdExvYyA9IGFkZE9wdChwb3NpdGlvblNlbGVjdG9yKTtcclxuXHJcbiAgICAgICAgICAgIGV2ZW50cy5mb3JFYWNoKChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgYWRkT3B0TG9jKHN0ckZvcm1hdChnZXRMMTBuKCdjb21tb24tc2V0LWl0ZW0tYmVmb3JlJyksIFtldmVudC5uYW1lXSkpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGFkZE9wdExvYyhnZXRMMTBuKCdjb21tb24tc2V0LWl0ZW0tYXMtbGFzdCcpKTtcclxuXHJcbiAgICAgICAgICAgIHBvc2l0aW9uU2VsZWN0b3Iuc2VsZWN0ZWRJbmRleCA9IGV2ZW50cy5sZW5ndGg7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHN0YXRlLmV2ZW50c0xlbmd0aCA9IGV2ZW50cy5sZW5ndGg7XHJcblxyXG4gICAgICAgIFIuYXAoW2FkZEVsKHRhYmxlKV0sIGV2ZW50cy5tYXAoKGV2ZW50LCBpLCBldmVudHMyKSA9PlxyXG4gICAgICAgICAgICBhcHBlbmRFdmVudElucHV0KGV2ZW50LCBpLCBldmVudHMyLCBtZXRhSW5mby5kYXRlLCBtZXRhSW5mby5wcmVHYW1lRGF0ZSkpKTtcclxuXHJcbiAgICAgICAgLy8gcmVmcmVzaCBzd2FwIHNlbGVjdG9yXHJcbiAgICAgICAgY29uc3Qgc2VsZWN0b3JBcnIgPSBubDJhcnJheShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuZXZlbnRFZGl0U2VsZWN0b3InKSk7XHJcbiAgICAgICAgUi5hcChbY2xlYXJFbF0sIHNlbGVjdG9yQXJyKTtcclxuXHJcbiAgICAgICAgZXZlbnRzLmZvckVhY2goKGV2ZW50LCBpKSA9PiB7XHJcbiAgICAgICAgICAgIHNlbGVjdG9yQXJyLmZvckVhY2goKHNlbGVjdG9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBvcHRpb24gPSBtYWtlRWwoJ29wdGlvbicpO1xyXG4gICAgICAgICAgICAgICAgb3B0aW9uLmFwcGVuZENoaWxkKG1ha2VUZXh0KGV2ZW50Lm5hbWUpKTtcclxuICAgICAgICAgICAgICAgIG9wdGlvbi5ldmVudEluZGV4ID0gaTtcclxuICAgICAgICAgICAgICAgIHNlbGVjdG9yLmFwcGVuZENoaWxkKG9wdGlvbik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50KGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGV2ZW50TmFtZUlucHV0ID0gcWVlKGRpYWxvZywgJy5ldmVudE5hbWVJbnB1dCcpO1xyXG4gICAgICAgICAgICBjb25zdCBldmVudE5hbWUgPSBldmVudE5hbWVJbnB1dC52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uU2VsZWN0b3IgPSBxZWUoZGlhbG9nLCAnLnBvc2l0aW9uU2VsZWN0b3InKTtcclxuXHJcbiAgICAgICAgICAgIERCTVMuY3JlYXRlRXZlbnQoXHJcbiAgICAgICAgICAgICAgICBTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSwgZXZlbnROYW1lLCBwb3NpdGlvblNlbGVjdG9yLnNlbGVjdGVkSW5kZXgsXHJcbiAgICAgICAgICAgICAgICAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnROYW1lSW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gYXBwZW5kRXZlbnRJbnB1dChldmVudCwgaW5kZXgsIGV2ZW50cywgZGF0ZSwgcHJlR2FtZURhdGUpIHtcclxuICAgICAgICBjb25zdCBlbCA9IHdyYXBFbCgndHInLCBxdGUoYCR7cm9vdH0gLmV2ZW50LXRtcGxgKSk7XHJcbiAgICAgICAgTDEwbi5sb2NhbGl6ZVN0YXRpYyhlbCk7XHJcbiAgICAgICAgY29uc3QgcWUgPSBxZWUoZWwpO1xyXG4gICAgICAgIGFkZEVsKHFlKCcuZXZlbnQtbnVtYmVyJyksIG1ha2VUZXh0KGluZGV4ICsgMSkpO1xyXG4gICAgICAgIGNvbnN0IG5hbWVJbnB1dCA9IHFlKCcuZXZlbnQtbmFtZS1pbnB1dCcpO1xyXG4gICAgICAgIG5hbWVJbnB1dC52YWx1ZSA9IGV2ZW50Lm5hbWU7XHJcbiAgICAgICAgbmFtZUlucHV0LmV2ZW50SW5kZXggPSBpbmRleDtcclxuICAgICAgICBsaXN0ZW4obmFtZUlucHV0LCAnY2hhbmdlJywgdXBkYXRlRXZlbnROYW1lKTtcclxuXHJcbiAgICAgICAgY29uc3QgdGV4dElucHV0ID0gcWUoJy5ldmVudC10ZXh0Jyk7XHJcbiAgICAgICAgdGV4dElucHV0LnZhbHVlID0gZXZlbnQudGV4dDtcclxuICAgICAgICB0ZXh0SW5wdXQuZXZlbnRJbmRleCA9IGluZGV4O1xyXG4gICAgICAgIGxpc3Rlbih0ZXh0SW5wdXQsICdjaGFuZ2UnLCB1cGRhdGVFdmVudFRleHQpO1xyXG5cclxuICAgICAgICBVSS5tYWtlRXZlbnRUaW1lUGlja2VyMihxZSgnLmV2ZW50LXRpbWUnKSwge1xyXG4gICAgICAgICAgICBldmVudFRpbWU6IGV2ZW50LnRpbWUsXHJcbiAgICAgICAgICAgIGluZGV4LFxyXG4gICAgICAgICAgICBwcmVHYW1lRGF0ZSxcclxuICAgICAgICAgICAgZGF0ZSxcclxuICAgICAgICAgICAgb25DaGFuZ2VEYXRlVGltZUNyZWF0b3JcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbGlzdGVuKHFlZShlbCwgJy5tb3ZlJyksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgc3RhdGUubW92ZUV2ZW50RGlhbG9nLmluZGV4ID0gaW5kZXg7XHJcbiAgICAgICAgICAgIHN0YXRlLm1vdmVFdmVudERpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihxZWUoZWwsICcuY2xvbmUnKSwgJ2NsaWNrJywgY2xvbmVFdmVudChpbmRleCkpO1xyXG4gICAgICAgIGlmIChzdGF0ZS5ldmVudHNMZW5ndGggPT09IGluZGV4ICsgMSkge1xyXG4gICAgICAgICAgICBzZXRBdHRyKHFlZShlbCwgJy5tZXJnZScpLCAnZGlzYWJsZWQnLCAnZGlzYWJsZWQnKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsaXN0ZW4ocWVlKGVsLCAnLm1lcmdlJyksICdjbGljaycsIG1lcmdlRXZlbnRzKGluZGV4LCBldmVudC5uYW1lLCBldmVudHNbaW5kZXggKyAxXS5uYW1lKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxpc3RlbihxZWUoZWwsICcucmVtb3ZlJyksICdjbGljaycsIHJlbW92ZUV2ZW50KGV2ZW50Lm5hbWUsIGluZGV4KSk7XHJcblxyXG4gICAgICAgIHJldHVybiBlbDtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtb3ZlRXZlbnQoZGlhbG9nKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbmV3SW5kZXggPSBxdWVyeUVsKCcubW92ZVBvc2l0aW9uU2VsZWN0b3InKS5zZWxlY3RlZEluZGV4O1xyXG5cclxuICAgICAgICAgICAgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCk7XHJcbiAgICAgICAgICAgIERCTVMubW92ZUV2ZW50KFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLCBkaWFsb2cuaW5kZXgsIG5ld0luZGV4LCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNsb25lRXZlbnQoaW5kZXgpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBEQk1TLmNsb25lRXZlbnQoU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksIGluZGV4LCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtZXJnZUV2ZW50cyhpbmRleCwgZmlyc3ROYW1lLCBzZWNvbmROYW1lKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgaWYgKHN0YXRlLmV2ZW50c0xlbmd0aCA9PT0gaW5kZXggKyAxKSB7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hbGVydChnZXRMMTBuKCdzdG9yaWVzLWNhbnQtbWVyZ2UtbGFzdC1ldmVudCcpKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgVXRpbHMuY29uZmlybShMMTBuLmZvcm1hdCgnc3RvcmllcycsICdjb25maXJtLWV2ZW50LW1lcmdlJywgW2ZpcnN0TmFtZSwgc2Vjb25kTmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLm1lcmdlRXZlbnRzKFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLCBpbmRleCwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlbW92ZUV2ZW50KG5hbWUsIGluZGV4KSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQoZ2V0TDEwbignc3Rvcmllcy1yZW1vdmUtZXZlbnQtd2FybmluZycpLCBbbmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLnJlbW92ZUV2ZW50KFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLCBpbmRleCwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldEV2ZW50SGVhZGVyKCkge1xyXG4gICAgICAgIGNvbnN0IHRyID0gbWFrZUVsKCd0cicpO1xyXG4gICAgICAgIGFkZEVsKHRyLCBhZGRFbChtYWtlRWwoJ3RoJyksIG1ha2VUZXh0KCfihJYnKSkpO1xyXG4gICAgICAgIGFkZEVsKHRyLCBhZGRFbChtYWtlRWwoJ3RoJyksIG1ha2VUZXh0KGdldEwxMG4oJ3N0b3JpZXMtZXZlbnQnKSkpKTtcclxuICAgICAgICByZXR1cm4gdHI7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25DaGFuZ2VEYXRlVGltZUNyZWF0b3IobXlJbnB1dCkge1xyXG4gICAgICAgIHJldHVybiAoZHAsIGlucHV0KSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMuc2V0RXZlbnRPcmlnaW5Qcm9wZXJ0eShTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSwgbXlJbnB1dC5ldmVudEluZGV4LCAndGltZScsIGlucHV0LnZhbCgpLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgU3RvcnlFdmVudHMubGFzdERhdGUgPSBpbnB1dC52YWwoKTtcclxuICAgICAgICAgICAgcmVtb3ZlQ2xhc3MobXlJbnB1dCwgJ2RlZmF1bHREYXRlJyk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVFdmVudE5hbWUoZXZlbnQpIHtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IGV2ZW50LnRhcmdldDtcclxuICAgICAgICBEQk1TLnNldEV2ZW50T3JpZ2luUHJvcGVydHkoU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksIGlucHV0LmV2ZW50SW5kZXgsICduYW1lJywgaW5wdXQudmFsdWUsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVFdmVudFRleHQoZXZlbnQpIHtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IGV2ZW50LnRhcmdldDtcclxuICAgICAgICBEQk1TLnNldEV2ZW50T3JpZ2luUHJvcGVydHkoU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksIGlucHV0LmV2ZW50SW5kZXgsICd0ZXh0JywgaW5wdXQudmFsdWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgIH1cclxufSkodGhpcy5TdG9yeUV2ZW50cyA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCd3cml0ZXJTdG9yeUFyZWEnKSwgJ2NoYW5nZScsIHVwZGF0ZVdyaXRlclN0b3J5KTtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBnZXRFbCgnd3JpdGVyU3RvcnlEaXYyJyk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBzdG9yeUFyZWEgPSBnZXRFbCgnd3JpdGVyU3RvcnlBcmVhJyk7XHJcbiAgICAgICAgY29uc3Qgc3RvcnlOYW1lID0gU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCk7XHJcblxyXG4gICAgICAgIGlmIChzdG9yeU5hbWUpIHtcclxuICAgICAgICAgICAgREJNUy5nZXRXcml0ZXJTdG9yeShzdG9yeU5hbWUsIChlcnIsIHN0b3J5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgc3RvcnlBcmVhLnZhbHVlID0gc3Rvcnk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHN0b3J5QXJlYS52YWx1ZSA9ICcnO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlV3JpdGVyU3RvcnkoKSB7XHJcbiAgICAgICAgY29uc3Qgc3RvcnlBcmVhID0gZ2V0RWwoJ3dyaXRlclN0b3J5QXJlYScpO1xyXG4gICAgICAgIERCTVMuc2V0V3JpdGVyU3RvcnkoU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksIHN0b3J5QXJlYS52YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgfVxyXG59KSh0aGlzLldyaXRlclN0b3J5ID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE4IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBCcmllZmluZ1ByZXZpZXcsIEJyaWVmaW5nRXhwb3J0XHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuZnVuY3Rpb24gUm91dGluZ1RhYlRtcGwoZXhwb3J0cywgb3B0cykge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuICAgIGNvbnN0IHRtcGxSb290ID0gJy50YWItcm91dGluZy10bXBsJztcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZWwgPSBxdWVyeUVsKHRtcGxSb290KS5jbG9uZU5vZGUodHJ1ZSk7XHJcbiAgICAgICAgcmVtb3ZlQ2xhc3MoZWwsICd0YWItcm91dGluZy10bXBsJyk7XHJcbiAgICAgICAgYWRkRWwocXVlcnlFbCgnLnRhYi1jb250YWluZXInKSwgZWwpO1xyXG4gICAgICAgIHN0YXRlLnZpZXdzID0ge307XHJcbiAgICAgICAgY29uc3QgY29udGFpbmVycyA9IHtcclxuICAgICAgICAgICAgcm9vdDogc3RhdGUsXHJcbiAgICAgICAgICAgIG5hdmlnYXRpb246IHFlZShlbCwgJy5zdWItdGFiLW5hdmlnYXRpb24nKSxcclxuICAgICAgICAgICAgY29udGVudDogcWVlKGVsLCAnLnN1Yi10YWItY29udGVudCcpXHJcbiAgICAgICAgfTtcclxuICAgICAgICBjb25zdCB0YWJzID0gUi5pbmRleEJ5KFIucHJvcCgndmlld05hbWUnKSwgb3B0cy50YWJzLm1hcCh0YWIgPT4gKHtcclxuICAgICAgICAgICAgdmlld05hbWU6IHRhYi52aWV3TmFtZSxcclxuICAgICAgICAgICAgdmlld1JlczogVXRpbHMuYWRkVmlldyhjb250YWluZXJzLCB0YWIuYnRuTmFtZSwgd2luZG93W3RhYi52aWV3TmFtZV0pXHJcbiAgICAgICAgfSkpKTtcclxuXHJcbiAgICAgICAgVXRpbHMuc2V0Rmlyc3RUYWIoY29udGFpbmVycywgdGFic1tvcHRzLmZpcnN0VGFiXS52aWV3UmVzKTtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBlbDtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgICAgIHN0YXRlLmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuICAgIH07XHJcbn1cclxuXHJcblJvdXRpbmdUYWJUbXBsKHRoaXMuQnJpZWZpbmdzID0ge30sIHtcclxuICAgIGZpcnN0VGFiOiAnQnJpZWZpbmdQcmV2aWV3JyxcclxuICAgIHRhYnM6IFt7XHJcbiAgICAgICAgYnRuTmFtZTogJ2JyaWVmaW5nLXByZXZpZXcnLFxyXG4gICAgICAgIHZpZXdOYW1lOiAnQnJpZWZpbmdQcmV2aWV3J1xyXG4gICAgfSwge1xyXG4gICAgICAgIGJ0bk5hbWU6ICdicmllZmluZy1leHBvcnQnLFxyXG4gICAgICAgIHZpZXdOYW1lOiAnQnJpZWZpbmdFeHBvcnQnXHJcbiAgICB9XVxyXG59KTtcclxuXHJcblJvdXRpbmdUYWJUbXBsKHRoaXMuQ2hhcmFjdGVycyA9IHt9LCB7XHJcbiAgICBmaXJzdFRhYjogJ0NoYXJhY3RlckVkaXRvcicsXHJcbiAgICB0YWJzOiBbe1xyXG4gICAgICAgIGJ0bk5hbWU6ICdmaWxsaW5nLXByb2ZpbGUnLFxyXG4gICAgICAgIHZpZXdOYW1lOiAnQ2hhcmFjdGVyRWRpdG9yJ1xyXG4gICAgfSwge1xyXG4gICAgICAgIGJ0bk5hbWU6ICdjaGFuZ2luZy1wcm9maWxlLXN0cnVjdHVyZScsXHJcbiAgICAgICAgdmlld05hbWU6ICdDaGFyYWN0ZXJDb25maWd1cmVyJ1xyXG4gICAgfSwge1xyXG4gICAgICAgIGJ0bk5hbWU6ICdiaW5kaW5nLWNoYXJhY3RlcnMtYW5kLXBsYXllcnMnLFxyXG4gICAgICAgIHZpZXdOYW1lOiAnUHJvZmlsZUJpbmRpbmcyJ1xyXG4gICAgfV1cclxufSk7XHJcblxyXG5Sb3V0aW5nVGFiVG1wbCh0aGlzLlBsYXllcnMgPSB7fSwge1xyXG4gICAgZmlyc3RUYWI6ICdQbGF5ZXJFZGl0b3InLFxyXG4gICAgdGFiczogW3tcclxuICAgICAgICBidG5OYW1lOiAnZmlsbGluZy1wcm9maWxlJyxcclxuICAgICAgICB2aWV3TmFtZTogJ1BsYXllckVkaXRvcidcclxuICAgIH0sIHtcclxuICAgICAgICBidG5OYW1lOiAnY2hhbmdpbmctcHJvZmlsZS1zdHJ1Y3R1cmUnLFxyXG4gICAgICAgIHZpZXdOYW1lOiAnUGxheWVyQ29uZmlndXJlcidcclxuICAgIH0sIHtcclxuICAgICAgICBidG5OYW1lOiAnYmluZGluZy1jaGFyYWN0ZXJzLWFuZC1wbGF5ZXJzJyxcclxuICAgICAgICB2aWV3TmFtZTogJ1Byb2ZpbGVCaW5kaW5nMidcclxuICAgIH1dXHJcbn0pO1xyXG5cclxuUm91dGluZ1RhYlRtcGwodGhpcy5Mb2dWaWV3ZXIyID0ge30sIHtcclxuICAgIGZpcnN0VGFiOiAnTG9nVmlld2VyJyxcclxuICAgIHRhYnM6IFt7XHJcbiAgICAgICAgYnRuTmFtZTogJ2xvZ1ZpZXdlcicsXHJcbiAgICAgICAgdmlld05hbWU6ICdMb2dWaWV3ZXInXHJcbiAgICB9LCB7XHJcbiAgICAgICAgYnRuTmFtZTogJ2dyb3VwLXNjaGVtYScsXHJcbiAgICAgICAgdmlld05hbWU6ICdHcm91cFNjaGVtYSdcclxuICAgIH0sIHtcclxuICAgICAgICBidG5OYW1lOiAnYWJvdXQnLFxyXG4gICAgICAgIHZpZXdOYW1lOiAnQWJvdXQnXHJcbiAgICB9XVxyXG59KTtcclxuXHJcblJvdXRpbmdUYWJUbXBsKHRoaXMuQWNjZXNzTWFuYWdlciA9IHt9LCB7XHJcbiAgICBmaXJzdFRhYjogJ09yZ2FuaXplck1hbmFnZW1lbnQnLFxyXG4gICAgdGFiczogW3tcclxuICAgICAgICBidG5OYW1lOiAnb3JnYW5pemVyTWFuYWdlbWVudCcsXHJcbiAgICAgICAgdmlld05hbWU6ICdPcmdhbml6ZXJNYW5hZ2VtZW50J1xyXG4gICAgfSwge1xyXG4gICAgICAgIGJ0bk5hbWU6ICdwbGF5ZXJNYW5hZ2VtZW50JyxcclxuICAgICAgICB2aWV3TmFtZTogJ1BsYXllck1hbmFnZW1lbnQnXHJcbiAgICB9XVxyXG59KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgcm9vdCA9ICcudGV4dC1zZWFyY2gtdGFiICc7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LnRleHQtc2VhcmNoLWJ1dHRvbmApLCAnY2xpY2snLCBmaW5kVGV4dHMpO1xyXG4gICAgICAgIGxpc3Rlbk9uRW50ZXIocXVlcnlFbChgJHtyb290fS50ZXh0LXNlYXJjaC1pbnB1dGApLCBmaW5kVGV4dHMpO1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gZmluZFRleHRzKCkge1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdGVkVGV4dFR5cGVzID0gcXVlcnlFbEVscyhxdWVyeUVsKHJvb3QpLCBgJHtyb290fS50ZXh0U2VhcmNoVHlwZVJhZGlvYClcclxuICAgICAgICAgICAgLmZpbHRlcihlbCA9PiBlbC5jaGVja2VkKS5tYXAoZWwgPT4gZWwudmFsdWUpO1xyXG4gICAgICAgIGNvbnN0IHNlYXJjaFN0ciA9IHF1ZXJ5RWwoYCR7cm9vdH0udGV4dC1zZWFyY2gtaW5wdXRgKS52YWx1ZTtcclxuICAgICAgICBjb25zdCBjYXNlU2Vuc2l0aXZlID0gZ2V0RWwoJ2Nhc2VTZW5zaXRpdmVUZXh0U2VhcmNoJykuY2hlY2tlZDtcclxuICAgICAgICBEQk1TLmdldFRleHRzKHNlYXJjaFN0ciwgc2VsZWN0ZWRUZXh0VHlwZXMsIGNhc2VTZW5zaXRpdmUsIChlcnIsIHRleHRzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIGNvbnN0IHRleHQycGFuZWwgPSB0ZXh0ID0+XHJcbiAgICAgICAgICAgICAgICBtYWtlUGFuZWwoXHJcbiAgICAgICAgICAgICAgICAgICAgbWFrZVRleHQoYCR7Z2V0TDEwbihgdGV4dC1zZWFyY2gtJHt0ZXh0LnRleHRUeXBlfWApfSAoJHt0ZXh0LnJlc3VsdC5sZW5ndGh9KWApLFxyXG4gICAgICAgICAgICAgICAgICAgIG1ha2VQYW5lbENvbnRlbnQodGV4dCwgc2VhcmNoU3RyLCBjYXNlU2Vuc2l0aXZlKVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgYWRkRWxzKGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5yZXN1bHQtcGFuZWxgKSksIHRleHRzLm1hcCh0ZXh0MnBhbmVsKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZVBhbmVsQ29udGVudCh0ZXh0c0luZm8sIHNlYXJjaFN0ciwgY2FzZVNlbnNpdGl2ZSkge1xyXG4gICAgICAgIHRleHRzSW5mby5yZXN1bHQuc29ydChDb21tb25VdGlscy5jaGFyT3JkQUZhY3RvcnkoUi5wcm9wKCduYW1lJykpKTtcclxuICAgICAgICByZXR1cm4gYWRkRWxzKG1ha2VFbCgnZGl2JyksIHRleHRzSW5mby5yZXN1bHQubWFwKCh0ZXh0SW5mbykgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBoZWFkID0gYWRkRWwobWFrZUVsKCdkaXYnKSwgbWFrZVRleHQodGV4dEluZm8ubmFtZSkpO1xyXG4gICAgICAgICAgICBjb25zdCBib2R5ID0gYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgdGV4dEluZm8udHlwZSA9PT0gJ3RleHQnID8gJ3RleHQtYm9keScgOiAnc3RyaW5nLWJvZHknKTtcclxuICAgICAgICAgICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKENvbW1vblV0aWxzLmVzY2FwZVJlZ0V4cChzZWFyY2hTdHIpLCBjYXNlU2Vuc2l0aXZlID8gJ2cnIDogJ2dpJyk7XHJcbiAgICAgICAgICAgIGJvZHkuaW5uZXJIVE1MID0gdGV4dEluZm8udGV4dC5yZXBsYWNlKHJlZ2V4LCAnPHNwYW4+JCY8L3NwYW4+Jyk7XHJcbiAgICAgICAgICAgIHJldHVybiBhZGRFbHMoYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ3RleHQtY2FyZCcpLCBbaGVhZCwgYm9keV0pO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlUGFuZWwodGl0bGUsIGNvbnRlbnQpIHtcclxuICAgICAgICBjb25zdCBwYW5lbEluZm8gPSBVSS5tYWtlUGFuZWxDb3JlKHRpdGxlLCBjb250ZW50KTtcclxuICAgICAgICBVSS5hdHRhY2hQYW5lbFRvZ2dsZXIocGFuZWxJbmZvLmEsIHBhbmVsSW5mby5jb250ZW50RGl2KTtcclxuICAgICAgICBwYW5lbEluZm8uYS5jbGljaygpO1xyXG4gICAgICAgIHJldHVybiBwYW5lbEluZm8ucGFuZWw7XHJcbiAgICB9XHJcbn0pKHRoaXMuVGV4dFNlYXJjaCA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuICAgIGNvbnN0IHJvb3QgPSAnLnRpbWVsaW5lLXRhYic7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGxpc3RlbihnZXRFbCgndGltZWxpbmVTdG9yeVNlbGVjdG9yJyksICdjaGFuZ2UnLCBvblN0b3J5U2VsZWN0b3JDaGFuZ2VEZWxlZ2F0ZSk7XHJcblxyXG4gICAgICAgIHN0YXRlLlRpbWVsaW5lRGF0YXNldCA9IG5ldyB2aXMuRGF0YVNldCgpO1xyXG4gICAgICAgIHN0YXRlLlRhZ0RhdGFzZXQgPSBuZXcgdmlzLkRhdGFTZXQoKTtcclxuXHJcbiAgICAgICAgcXVlcnlFbHMoYCR7cm9vdH0gaW5wdXRbbmFtZT10aW1lbGluZUZpbHRlcl1gKS5tYXAobGlzdGVuKFIuX18sICdjaGFuZ2UnLCByZWZyZXNoVGltZWxpbmUpKTtcclxuICAgICAgICBnZXRFbCgndGltZWxpbmVGaWx0ZXJCeVN0b3J5JykuY2hlY2tlZCA9IHRydWU7XHJcblxyXG4gICAgICAgIC8vIHNwZWNpZnkgb3B0aW9uc1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIG9yaWVudGF0aW9uOiAndG9wJyxcclxuICAgICAgICAgICAgc2hvd0N1cnJlbnRUaW1lOiBmYWxzZSxcclxuICAgICAgICAgICAgLy8gICAgICAgIGVkaXRhYmxlIDoge1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgIHVwZGF0ZVRpbWUgOiB0cnVlXHJcbiAgICAgICAgICAgIC8vICAgICAgICB9LFxyXG4gICAgICAgICAgICAvLyAgICAgICAgb25Nb3ZlIDogZnVuY3Rpb24gKGl0ZW0sIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgaWYgKGl0ZW0uc3RvcnlOYW1lKSB7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgIERCTVMuc2V0RXZlbnRUaW1lKGl0ZW0uc3RvcnlOYW1lLCBpdGVtLmV2ZW50SW5kZXgsIGl0ZW0uc3RhcnQsIGZ1bmN0aW9uKGVycil7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soaXRlbSk7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gICAgICAgIH0sXHJcbiAgICAgICAgICAgIC8vICAgICAgICBtdWx0aXNlbGVjdCA6IHRydWVcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBjb25zdCB0aW1lbGluZSA9IG5ldyB2aXMuVGltZWxpbmUoZ2V0RWwoJ3RpbWVsaW5lQ29udGFpbmVyJyksIG51bGwsIG9wdGlvbnMpO1xyXG4gICAgICAgIHRpbWVsaW5lLnNldEdyb3VwcyhzdGF0ZS5UYWdEYXRhc2V0KTtcclxuICAgICAgICB0aW1lbGluZS5zZXRJdGVtcyhzdGF0ZS5UaW1lbGluZURhdGFzZXQpO1xyXG4gICAgICAgIHN0YXRlLnRpbWVsaW5lQ29tcG9uZW50ID0gdGltZWxpbmU7XHJcblxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBEQk1TLmdldE1ldGFJbmZvKChlcnIsIG1ldGFJbmZvKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcblxyXG4gICAgICAgICAgICBzdGF0ZS5wb3N0RGF0ZSA9IG1ldGFJbmZvLmRhdGU7XHJcbiAgICAgICAgICAgIHN0YXRlLnByZURhdGUgPSBtZXRhSW5mby5wcmVHYW1lRGF0ZTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGVuZERhdGUgPSBuZXcgRGF0ZShzdGF0ZS5wb3N0RGF0ZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHN0YXJ0RGF0ZSA9IG5ldyBEYXRlKHN0YXRlLnByZURhdGUpO1xyXG4gICAgICAgICAgICBlbmREYXRlLnNldEZ1bGxZZWFyKGVuZERhdGUuZ2V0RnVsbFllYXIoKSArIDEpO1xyXG4gICAgICAgICAgICBzdGFydERhdGUuc2V0RnVsbFllYXIoc3RhcnREYXRlLmdldEZ1bGxZZWFyKCkgLSAxKTtcclxuXHJcbiAgICAgICAgICAgIHN0YXRlLnRpbWVsaW5lQ29tcG9uZW50LnNldE9wdGlvbnMoe1xyXG4gICAgICAgICAgICAgICAgZW5kOiBlbmREYXRlLFxyXG4gICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0RGF0ZSxcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBEQk1TLmdldEV2ZW50c1RpbWVJbmZvKChlcnIxLCBldmVudHNUaW1lSW5mbykgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjEpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMSk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgc3RhdGUuZXZlbnRzVGltZUluZm8gPSBldmVudHNUaW1lSW5mbztcclxuICAgICAgICAgICAgICAgIHN0YXRlLmV2ZW50c0J5U3RvcmllcyA9IFIuZ3JvdXBCeShSLnByb3AoJ3N0b3J5TmFtZScpLCBldmVudHNUaW1lSW5mbyk7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5ldmVudHNCeUNoYXJhY3RlcnMgPSBSLnVuaXEoUi5mbGF0dGVuKGV2ZW50c1RpbWVJbmZvLm1hcChldmVudCA9PiBldmVudC5jaGFyYWN0ZXJzKSkpO1xyXG4gICAgICAgICAgICAgICAgc3RhdGUuZXZlbnRzQnlDaGFyYWN0ZXJzID0gUi56aXBPYmooXHJcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUuZXZlbnRzQnlDaGFyYWN0ZXJzLFxyXG4gICAgICAgICAgICAgICAgICAgIFIuYXAoW1IuY2xvbmVdLCBSLnJlcGVhdChbXSwgc3RhdGUuZXZlbnRzQnlDaGFyYWN0ZXJzLmxlbmd0aCkpXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgZXZlbnRzVGltZUluZm8uZm9yRWFjaChldmVudCA9PiBldmVudC5jaGFyYWN0ZXJzLmZvckVhY2goY2hhcmFjdGVyID0+XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUuZXZlbnRzQnlDaGFyYWN0ZXJzW2NoYXJhY3Rlcl0ucHVzaChldmVudCkpKTtcclxuXHJcbiAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheSgnc3RvcnknLCBmYWxzZSwgKGVycjIsIGFsbFN0b3J5TmFtZXMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2NoYXJhY3RlcicsIGZhbHNlLCAoZXJyMywgYWxsQ2hhcmFjdGVyTmFtZXMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjMpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMyk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdWZmaXh5KGFsbFN0b3J5TmFtZXMsIHN0YXRlLmV2ZW50c0J5U3Rvcmllcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmFsbFN0b3J5TmFtZXMgPSBhbGxTdG9yeU5hbWVzO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdWZmaXh5KGFsbENoYXJhY3Rlck5hbWVzLCBzdGF0ZS5ldmVudHNCeUNoYXJhY3RlcnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5hbGxDaGFyYWN0ZXJOYW1lcyA9IGFsbENoYXJhY3Rlck5hbWVzO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWZyZXNoVGltZWxpbmUoKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gc3VmZml4eShlbnRpdHlOYW1lcywgZGF0YSkge1xyXG4gICAgICAgIGVudGl0eU5hbWVzLmZvckVhY2goKG5hbWVJbmZvKSA9PiB7XHJcbiAgICAgICAgICAgIG5hbWVJbmZvLmhhc0V2ZW50cyA9IGRhdGFbbmFtZUluZm8udmFsdWVdICE9PSB1bmRlZmluZWQ7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVmcmVzaFRpbWVsaW5lKCkge1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdG9yVmFsdWVzID0gZ2V0RWwoJ3RpbWVsaW5lRmlsdGVyQnlTdG9yeScpLmNoZWNrZWQgPyBzdGF0ZS5hbGxTdG9yeU5hbWVzIDogc3RhdGUuYWxsQ2hhcmFjdGVyTmFtZXM7XHJcblxyXG4gICAgICAgIGNvbnN0IHNlbGVjdG9yID0gY2xlYXJFbChnZXRFbCgndGltZWxpbmVTdG9yeVNlbGVjdG9yJykpO1xyXG4gICAgICAgIGZpbGxTZWxlY3RvcihzZWxlY3Rvciwgc2VsZWN0b3JWYWx1ZXMubWFwKG9iaiA9PiAoe1xyXG4gICAgICAgICAgICBuYW1lOiBvYmouZGlzcGxheU5hbWUsXHJcbiAgICAgICAgICAgIHZhbHVlOiBvYmoudmFsdWUsXHJcbiAgICAgICAgICAgIGNsYXNzTmFtZTogb2JqLmhhc0V2ZW50cyA/XHJcbiAgICAgICAgICAgICAgICAnZmEtaWNvbiBmaW5pc2hlZCB0cmFuc3BhcmVudC1pY29uIHNlbGVjdC1pY29uLXBhZGRpbmcnIDpcclxuICAgICAgICAgICAgICAgICdmYS1pY29uIGVtcHR5IGljb24tcGFkZGluZyBzZWxlY3QtaWNvbi1wYWRkaW5nJ1xyXG4gICAgICAgIH0pKSk7XHJcbiAgICAgICAgc2V0QXR0cihzZWxlY3RvciwgJ3NpemUnLCBzZWxlY3RvclZhbHVlcy5sZW5ndGggPiAxNSA/IDE1IDogc2VsZWN0b3JWYWx1ZXMubGVuZ3RoKTtcclxuXHJcbiAgICAgICAgaWYgKHNlbGVjdG9yVmFsdWVzLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgICAgICBzZWxlY3Rvci5vcHRpb25zWzBdLnNlbGVjdGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgb25TdG9yeVNlbGVjdG9yQ2hhbmdlKFtzZWxlY3RvclZhbHVlc1swXS52YWx1ZV0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBvblN0b3J5U2VsZWN0b3JDaGFuZ2VEZWxlZ2F0ZShldmVudCkge1xyXG4gICAgICAgIG9uU3RvcnlTZWxlY3RvckNoYW5nZShubDJhcnJheShldmVudC50YXJnZXQuc2VsZWN0ZWRPcHRpb25zKS5tYXAob3B0ID0+IG9wdC52YWx1ZSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHByZXBhcmVMYWJlbCA9IGxhYmVsID0+IGA8c3BhbiBjbGFzcz1cInRpbWVsaW5lLWxhYmVsXCI+JHtsYWJlbH08L3NwYW4+YDtcclxuXHJcbiAgICBmdW5jdGlvbiBvblN0b3J5U2VsZWN0b3JDaGFuZ2UoZW50aXR5TmFtZXMpIHtcclxuICAgICAgICBzdGF0ZS5UYWdEYXRhc2V0LmNsZWFyKCk7XHJcbiAgICAgICAgc3RhdGUuVGltZWxpbmVEYXRhc2V0LmNsZWFyKCk7XHJcblxyXG4gICAgICAgIHN0YXRlLlRhZ0RhdGFzZXQuYWRkKGVudGl0eU5hbWVzLm1hcChlbnRpdHlOYW1lID0+IFIuYWx3YXlzKHsgaWQ6IGVudGl0eU5hbWUsIGNvbnRlbnQ6IGVudGl0eU5hbWUgfSkoKSkpO1xyXG5cclxuICAgICAgICBjb25zdCBieVN0b3J5ID0gZ2V0RWwoJ3RpbWVsaW5lRmlsdGVyQnlTdG9yeScpLmNoZWNrZWQ7XHJcbiAgICAgICAgY29uc3QgZGF0YSA9IGJ5U3RvcnkgPyBzdGF0ZS5ldmVudHNCeVN0b3JpZXMgOiBzdGF0ZS5ldmVudHNCeUNoYXJhY3RlcnM7XHJcbiAgICAgICAgZW50aXR5TmFtZXMgPSBSLmludGVyc2VjdGlvbihlbnRpdHlOYW1lcywgUi5rZXlzKGRhdGEpKTtcclxuICAgICAgICBjb25zdCB1c2VkRGF0YSA9IFIucGljayhlbnRpdHlOYW1lcywgZGF0YSk7XHJcbiAgICAgICAgZmlsbFRpbWVsaW5lcyh1c2VkRGF0YSk7XHJcbiAgICAgICAgY29uc3QgZXZlbnRzID0gUi51bmlxKFIuZmxhdHRlbihSLnZhbHVlcyh1c2VkRGF0YSkpXHJcbiAgICAgICAgICAgICAgICAubWFwKGV2ZW50ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC50aW1lID0gbmV3IERhdGUoZXZlbnQudGltZSAhPT0gJycgPyBldmVudC50aW1lIDogc3RhdGUucG9zdERhdGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LmNoYXJhY3RlcnMuc29ydChDb21tb25VdGlscy5jaGFyT3JkQSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50O1xyXG4gICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGV2ZW50cy5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBRmFjdG9yeShSLnByb3AoJ3RpbWUnKSkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGFkZEVscyhjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0gLnRpbWVsaW5lLWxpc3RgKSksIGV2ZW50cy5tYXAoZXZlbnQgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCByb3cgPSBxbXRlKGAke3Jvb3R9IC50aW1lbGluZS1ldmVudC10bXBsYCk7XHJcbiAgICAgICAgICAgIGFkZEVsKHFlZShyb3csICcudGltZScpLCBtYWtlVGV4dChldmVudC50aW1lLmZvcm1hdCgneXl5eS9tbS9kZCBoOk1NJykpKTtcclxuICAgICAgICAgICAgYWRkRWwocWVlKHJvdywgJy5zdG9yeS1uYW1lJyksIG1ha2VUZXh0KGV2ZW50LnN0b3J5TmFtZSkpO1xyXG4gICAgICAgICAgICBhZGRFbChxZWUocm93LCAnLmV2ZW50LW5hbWUnKSwgbWFrZVRleHQoZXZlbnQubmFtZSkpO1xyXG4gICAgICAgICAgICBhZGRFbChxZWUocm93LCAnLmNoYXJhY3RlcnMnKSwgbWFrZVRleHQoZXZlbnQuY2hhcmFjdGVycy5qb2luKCcsICcpKSk7XHJcbiAgICAgICAgICAgIHJldHVybiByb3c7XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICBpZiAoZW50aXR5TmFtZXNbMF0pIHtcclxuICAgICAgICAgICAgc3RhdGUuVGltZWxpbmVEYXRhc2V0LmFkZCh7XHJcbiAgICAgICAgICAgICAgICBjb250ZW50OiBwcmVwYXJlTGFiZWwoTDEwbi5nZXRWYWx1ZSgnb3ZlcnZpZXctcHJlLWdhbWUtZW5kLWRhdGUnKSksXHJcbiAgICAgICAgICAgICAgICBzdGFydDogbmV3IERhdGUoc3RhdGUucG9zdERhdGUpLFxyXG4gICAgICAgICAgICAgICAgZ3JvdXA6IGVudGl0eU5hbWVzWzBdLFxyXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lOiAnaW1wb3J0YW50SXRlbScsXHJcbiAgICAgICAgICAgICAgICBlZGl0YWJsZTogZmFsc2VcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHN0YXRlLlRpbWVsaW5lRGF0YXNldC5hZGQoe1xyXG4gICAgICAgICAgICAgICAgY29udGVudDogcHJlcGFyZUxhYmVsKEwxMG4uZ2V0VmFsdWUoJ292ZXJ2aWV3LXByZS1nYW1lLXN0YXJ0LWRhdGUnKSksXHJcbiAgICAgICAgICAgICAgICBzdGFydDogbmV3IERhdGUoc3RhdGUucHJlRGF0ZSksXHJcbiAgICAgICAgICAgICAgICBncm91cDogZW50aXR5TmFtZXNbMF0sXHJcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU6ICdpbXBvcnRhbnRJdGVtJyxcclxuICAgICAgICAgICAgICAgIGVkaXRhYmxlOiBmYWxzZVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIGZpbGxUaW1lbGluZXModXNlZERhdGEpIHtcclxuICAgICAgICBzdGF0ZS5UaW1lbGluZURhdGFzZXQuYWRkKFIuZmxhdHRlbihSLnRvUGFpcnModXNlZERhdGEpLm1hcCgocGFpcikgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBlbnRpdHlOYW1lID0gcGFpclswXTtcclxuICAgICAgICAgICAgcmV0dXJuIHBhaXJbMV0ubWFwKGV2ZW50ID0+ICh7XHJcbiAgICAgICAgICAgICAgICBjb250ZW50OiBwcmVwYXJlTGFiZWwoZXZlbnQubmFtZSksXHJcbiAgICAgICAgICAgICAgICBzdGFydDogZXZlbnQudGltZSAhPT0gJycgPyBldmVudC50aW1lIDogc3RhdGUucG9zdERhdGUsXHJcbiAgICAgICAgICAgICAgICBncm91cDogZW50aXR5TmFtZVxyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgfSkpKTtcclxuICAgIH1cclxufSkodGhpcy5UaW1lbGluZSA9IHt9KTtcclxuIl19
